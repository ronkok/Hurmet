function OrderedMap(e){this.content=e}OrderedMap.prototype={constructor:OrderedMap,find:function(e){for(var t=0;t<this.content.length;t+=2)if(this.content[t]===e)return t;return-1},get:function(e){var t=this.find(e);return t==-1?undefined:this.content[t+1]},update:function(e,t,n){var r=n&&n!=e?this.remove(n):this;var o=r.find(e),i=r.content.slice();if(o==-1){i.push(n||e,t)}else{i[o+1]=t;if(n)i[o]=n}return new OrderedMap(i)},remove:function(e){var t=this.find(e);if(t==-1)return this;var n=this.content.slice();n.splice(t,2);return new OrderedMap(n)},addToStart:function(e,t){return new OrderedMap([e,t].concat(this.remove(e).content))},addToEnd:function(e,t){var n=this.remove(e).content.slice();n.push(e,t);return new OrderedMap(n)},addBefore:function(e,t,n){var r=this.remove(t),o=r.content.slice();var i=r.find(e);o.splice(i==-1?o.length:i,0,t,n);return new OrderedMap(o)},forEach:function(e){for(var t=0;t<this.content.length;t+=2)e(this.content[t],this.content[t+1])},prepend:function(e){e=OrderedMap.from(e);if(!e.size)return this;return new OrderedMap(e.content.concat(this.subtract(e).content))},append:function(e){e=OrderedMap.from(e);if(!e.size)return this;return new OrderedMap(this.subtract(e).content.concat(e.content))},subtract:function(e){var t=this;e=OrderedMap.from(e);for(var n=0;n<e.content.length;n+=2)t=t.remove(e.content[n]);return t},toObject:function(){var e={};this.forEach((function(t,n){e[t]=n}));return e},get size(){return this.content.length>>1}};OrderedMap.from=function(e){if(e instanceof OrderedMap)return e;var t=[];if(e)for(var n in e)t.push(n,e[n]);return new OrderedMap(t)};function findDiffStart(e,t,n){for(let r=0;;r++){if(r==e.childCount||r==t.childCount)return e.childCount==t.childCount?null:n;let o=e.child(r),i=t.child(r);if(o==i){n+=o.nodeSize;continue}if(!o.sameMarkup(i))return n;if(o.isText&&o.text!=i.text){for(let e=0;o.text[e]==i.text[e];e++)n++;return n}if(o.content.size||i.content.size){let e=findDiffStart(o.content,i.content,n+1);if(e!=null)return e}n+=o.nodeSize}}function findDiffEnd(e,t,n,r){for(let o=e.childCount,i=t.childCount;;){if(o==0||i==0)return o==i?null:{a:n,b:r};let s=e.child(--o),a=t.child(--i),l=s.nodeSize;if(s==a){n-=l;r-=l;continue}if(!s.sameMarkup(a))return{a:n,b:r};if(s.isText&&s.text!=a.text){let e=0,t=Math.min(s.text.length,a.text.length);while(e<t&&s.text[s.text.length-e-1]==a.text[a.text.length-e-1]){e++;n--;r--}return{a:n,b:r}}if(s.content.size||a.content.size){let e=findDiffEnd(s.content,a.content,n-1,r-1);if(e)return e}n-=l;r-=l}}class Fragment{constructor(e,t){this.content=e;this.size=t||0;if(t==null)for(let t=0;t<e.length;t++)this.size+=e[t].nodeSize}nodesBetween(e,t,n,r=0,o){for(let i=0,s=0;s<t;i++){let a=this.content[i],l=s+a.nodeSize;if(l>e&&n(a,r+s,o||null,i)!==false&&a.content.size){let o=s+1;a.nodesBetween(Math.max(0,e-o),Math.min(a.content.size,t-o),n,r+o)}s=l}}descendants(e){this.nodesBetween(0,this.size,e)}textBetween(e,t,n,r){let o="",i=true;this.nodesBetween(e,t,((s,a)=>{let l=s.isText?s.text.slice(Math.max(e,a)-a,t-a):!s.isLeaf?"":r?typeof r==="function"?r(s):r:s.type.spec.leafText?s.type.spec.leafText(s):"";if(s.isBlock&&(s.isLeaf&&l||s.isTextblock)&&n){if(i)i=false;else o+=n}o+=l}),0);return o}append(e){if(!e.size)return this;if(!this.size)return e;let t=this.lastChild,n=e.firstChild,r=this.content.slice(),o=0;if(t.isText&&t.sameMarkup(n)){r[r.length-1]=t.withText(t.text+n.text);o=1}for(;o<e.content.length;o++)r.push(e.content[o]);return new Fragment(r,this.size+e.size)}cut(e,t=this.size){if(e==0&&t==this.size)return this;let n=[],r=0;if(t>e)for(let o=0,i=0;i<t;o++){let s=this.content[o],a=i+s.nodeSize;if(a>e){if(i<e||a>t){if(s.isText)s=s.cut(Math.max(0,e-i),Math.min(s.text.length,t-i));else s=s.cut(Math.max(0,e-i-1),Math.min(s.content.size,t-i-1))}n.push(s);r+=s.nodeSize}i=a}return new Fragment(n,r)}cutByIndex(e,t){if(e==t)return Fragment.empty;if(e==0&&t==this.content.length)return this;return new Fragment(this.content.slice(e,t))}replaceChild(e,t){let n=this.content[e];if(n==t)return this;let r=this.content.slice();let o=this.size+t.nodeSize-n.nodeSize;r[e]=t;return new Fragment(r,o)}addToStart(e){return new Fragment([e].concat(this.content),this.size+e.nodeSize)}addToEnd(e){return new Fragment(this.content.concat(e),this.size+e.nodeSize)}eq(e){if(this.content.length!=e.content.length)return false;for(let t=0;t<this.content.length;t++)if(!this.content[t].eq(e.content[t]))return false;return true}get firstChild(){return this.content.length?this.content[0]:null}get lastChild(){return this.content.length?this.content[this.content.length-1]:null}get childCount(){return this.content.length}child(e){let t=this.content[e];if(!t)throw new RangeError("Index "+e+" out of range for "+this);return t}maybeChild(e){return this.content[e]||null}forEach(e){for(let t=0,n=0;t<this.content.length;t++){let r=this.content[t];e(r,n,t);n+=r.nodeSize}}findDiffStart(e,t=0){return findDiffStart(this,e,t)}findDiffEnd(e,t=this.size,n=e.size){return findDiffEnd(this,e,t,n)}findIndex(e,t=-1){if(e==0)return retIndex(0,e);if(e==this.size)return retIndex(this.content.length,e);if(e>this.size||e<0)throw new RangeError(`Position ${e} outside of fragment (${this})`);for(let n=0,r=0;;n++){let o=this.child(n),i=r+o.nodeSize;if(i>=e){if(i==e||t>0)return retIndex(n+1,i);return retIndex(n,r)}r=i}}toString(){return"<"+this.toStringInner()+">"}toStringInner(){return this.content.join(", ")}toJSON(){return this.content.length?this.content.map((e=>e.toJSON())):null}static fromJSON(e,t){if(!t)return Fragment.empty;if(!Array.isArray(t))throw new RangeError("Invalid input for Fragment.fromJSON");return new Fragment(t.map(e.nodeFromJSON))}static fromArray(e){if(!e.length)return Fragment.empty;let t,n=0;for(let r=0;r<e.length;r++){let o=e[r];n+=o.nodeSize;if(r&&o.isText&&e[r-1].sameMarkup(o)){if(!t)t=e.slice(0,r);t[t.length-1]=o.withText(t[t.length-1].text+o.text)}else if(t){t.push(o)}}return new Fragment(t||e,n)}static from(e){if(!e)return Fragment.empty;if(e instanceof Fragment)return e;if(Array.isArray(e))return this.fromArray(e);if(e.attrs)return new Fragment([e],e.nodeSize);throw new RangeError("Can not convert "+e+" to a Fragment"+(e.nodesBetween?" (looks like multiple versions of prosemirror-model were loaded)":""))}}Fragment.empty=new Fragment([],0);const found={index:0,offset:0};function retIndex(e,t){found.index=e;found.offset=t;return found}function compareDeep(e,t){if(e===t)return true;if(!(e&&typeof e=="object")||!(t&&typeof t=="object"))return false;let n=Array.isArray(e);if(Array.isArray(t)!=n)return false;if(n){if(e.length!=t.length)return false;for(let n=0;n<e.length;n++)if(!compareDeep(e[n],t[n]))return false}else{for(let n in e)if(!(n in t)||!compareDeep(e[n],t[n]))return false;for(let n in t)if(!(n in e))return false}return true}class Mark{constructor(e,t){this.type=e;this.attrs=t}addToSet(e){let t,n=false;for(let r=0;r<e.length;r++){let o=e[r];if(this.eq(o))return e;if(this.type.excludes(o.type)){if(!t)t=e.slice(0,r)}else if(o.type.excludes(this.type)){return e}else{if(!n&&o.type.rank>this.type.rank){if(!t)t=e.slice(0,r);t.push(this);n=true}if(t)t.push(o)}}if(!t)t=e.slice();if(!n)t.push(this);return t}removeFromSet(e){for(let t=0;t<e.length;t++)if(this.eq(e[t]))return e.slice(0,t).concat(e.slice(t+1));return e}isInSet(e){for(let t=0;t<e.length;t++)if(this.eq(e[t]))return true;return false}eq(e){return this==e||this.type==e.type&&compareDeep(this.attrs,e.attrs)}toJSON(){let e={type:this.type.name};for(let t in this.attrs){e.attrs=this.attrs;break}return e}static fromJSON(e,t){if(!t)throw new RangeError("Invalid input for Mark.fromJSON");let n=e.marks[t.type];if(!n)throw new RangeError(`There is no mark type ${t.type} in this schema`);let r=n.create(t.attrs);n.checkAttrs(r.attrs);return r}static sameSet(e,t){if(e==t)return true;if(e.length!=t.length)return false;for(let n=0;n<e.length;n++)if(!e[n].eq(t[n]))return false;return true}static setFrom(e){if(!e||Array.isArray(e)&&e.length==0)return Mark.none;if(e instanceof Mark)return[e];let t=e.slice();t.sort(((e,t)=>e.type.rank-t.type.rank));return t}}Mark.none=[];class ReplaceError extends Error{}class Slice{constructor(e,t,n){this.content=e;this.openStart=t;this.openEnd=n}get size(){return this.content.size-this.openStart-this.openEnd}insertAt(e,t){let n=insertInto(this.content,e+this.openStart,t);return n&&new Slice(n,this.openStart,this.openEnd)}removeBetween(e,t){return new Slice(removeRange(this.content,e+this.openStart,t+this.openStart),this.openStart,this.openEnd)}eq(e){return this.content.eq(e.content)&&this.openStart==e.openStart&&this.openEnd==e.openEnd}toString(){return this.content+"("+this.openStart+","+this.openEnd+")"}toJSON(){if(!this.content.size)return null;let e={content:this.content.toJSON()};if(this.openStart>0)e.openStart=this.openStart;if(this.openEnd>0)e.openEnd=this.openEnd;return e}static fromJSON(e,t){if(!t)return Slice.empty;let n=t.openStart||0,r=t.openEnd||0;if(typeof n!="number"||typeof r!="number")throw new RangeError("Invalid input for Slice.fromJSON");return new Slice(Fragment.fromJSON(e,t.content),n,r)}static maxOpen(e,t=true){let n=0,r=0;for(let r=e.firstChild;r&&!r.isLeaf&&(t||!r.type.spec.isolating);r=r.firstChild)n++;for(let n=e.lastChild;n&&!n.isLeaf&&(t||!n.type.spec.isolating);n=n.lastChild)r++;return new Slice(e,n,r)}}Slice.empty=new Slice(Fragment.empty,0,0);function removeRange(e,t,n){let{index:r,offset:o}=e.findIndex(t),i=e.maybeChild(r);let{index:s,offset:a}=e.findIndex(n);if(o==t||i.isText){if(a!=n&&!e.child(s).isText)throw new RangeError("Removing non-flat range");return e.cut(0,t).append(e.cut(n))}if(r!=s)throw new RangeError("Removing non-flat range");return e.replaceChild(r,i.copy(removeRange(i.content,t-o-1,n-o-1)))}function insertInto(e,t,n,r){let{index:o,offset:i}=e.findIndex(t),s=e.maybeChild(o);if(i==t||s.isText){return e.cut(0,t).append(n).append(e.cut(t))}let a=insertInto(s.content,t-i-1,n);return a&&e.replaceChild(o,s.copy(a))}function replace(e,t,n){if(n.openStart>e.depth)throw new ReplaceError("Inserted content deeper than insertion position");if(e.depth-n.openStart!=t.depth-n.openEnd)throw new ReplaceError("Inconsistent open depths");return replaceOuter(e,t,n,0)}function replaceOuter(e,t,n,r){let o=e.index(r),i=e.node(r);if(o==t.index(r)&&r<e.depth-n.openStart){let s=replaceOuter(e,t,n,r+1);return i.copy(i.content.replaceChild(o,s))}else if(!n.content.size){return close$1(i,replaceTwoWay(e,t,r))}else if(!n.openStart&&!n.openEnd&&e.depth==r&&t.depth==r){let r=e.parent,o=r.content;return close$1(r,o.cut(0,e.parentOffset).append(n.content).append(o.cut(t.parentOffset)))}else{let{start:o,end:s}=prepareSliceForReplace(n,e);return close$1(i,replaceThreeWay(e,o,s,t,r))}}function checkJoin(e,t){if(!t.type.compatibleContent(e.type))throw new ReplaceError("Cannot join "+t.type.name+" onto "+e.type.name)}function joinable$1(e,t,n){let r=e.node(n);checkJoin(r,t.node(n));return r}function addNode(e,t){let n=t.length-1;if(n>=0&&e.isText&&e.sameMarkup(t[n]))t[n]=e.withText(t[n].text+e.text);else t.push(e)}function addRange(e,t,n,r){let o=(t||e).node(n);let i=0,s=t?t.index(n):o.childCount;if(e){i=e.index(n);if(e.depth>n){i++}else if(e.textOffset){addNode(e.nodeAfter,r);i++}}for(let e=i;e<s;e++)addNode(o.child(e),r);if(t&&t.depth==n&&t.textOffset)addNode(t.nodeBefore,r)}function close$1(e,t){e.type.checkContent(t);return e.copy(t)}function replaceThreeWay(e,t,n,r,o){let i=e.depth>o&&joinable$1(e,t,o+1);let s=r.depth>o&&joinable$1(n,r,o+1);let a=[];addRange(null,e,o,a);if(i&&s&&t.index(o)==n.index(o)){checkJoin(i,s);addNode(close$1(i,replaceThreeWay(e,t,n,r,o+1)),a)}else{if(i)addNode(close$1(i,replaceTwoWay(e,t,o+1)),a);addRange(t,n,o,a);if(s)addNode(close$1(s,replaceTwoWay(n,r,o+1)),a)}addRange(r,null,o,a);return new Fragment(a)}function replaceTwoWay(e,t,n){let r=[];addRange(null,e,n,r);if(e.depth>n){let o=joinable$1(e,t,n+1);addNode(close$1(o,replaceTwoWay(e,t,n+1)),r)}addRange(t,null,n,r);return new Fragment(r)}function prepareSliceForReplace(e,t){let n=t.depth-e.openStart,r=t.node(n);let o=r.copy(e.content);for(let e=n-1;e>=0;e--)o=t.node(e).copy(Fragment.from(o));return{start:o.resolveNoCache(e.openStart+n),end:o.resolveNoCache(o.content.size-e.openEnd-n)}}class ResolvedPos{constructor(e,t,n){this.pos=e;this.path=t;this.parentOffset=n;this.depth=t.length/3-1}resolveDepth(e){if(e==null)return this.depth;if(e<0)return this.depth+e;return e}get parent(){return this.node(this.depth)}get doc(){return this.node(0)}node(e){return this.path[this.resolveDepth(e)*3]}index(e){return this.path[this.resolveDepth(e)*3+1]}indexAfter(e){e=this.resolveDepth(e);return this.index(e)+(e==this.depth&&!this.textOffset?0:1)}start(e){e=this.resolveDepth(e);return e==0?0:this.path[e*3-1]+1}end(e){e=this.resolveDepth(e);return this.start(e)+this.node(e).content.size}before(e){e=this.resolveDepth(e);if(!e)throw new RangeError("There is no position before the top-level node");return e==this.depth+1?this.pos:this.path[e*3-1]}after(e){e=this.resolveDepth(e);if(!e)throw new RangeError("There is no position after the top-level node");return e==this.depth+1?this.pos:this.path[e*3-1]+this.path[e*3].nodeSize}get textOffset(){return this.pos-this.path[this.path.length-1]}get nodeAfter(){let e=this.parent,t=this.index(this.depth);if(t==e.childCount)return null;let n=this.pos-this.path[this.path.length-1],r=e.child(t);return n?e.child(t).cut(n):r}get nodeBefore(){let e=this.index(this.depth);let t=this.pos-this.path[this.path.length-1];if(t)return this.parent.child(e).cut(0,t);return e==0?null:this.parent.child(e-1)}posAtIndex(e,t){t=this.resolveDepth(t);let n=this.path[t*3],r=t==0?0:this.path[t*3-1]+1;for(let t=0;t<e;t++)r+=n.child(t).nodeSize;return r}marks(){let e=this.parent,t=this.index();if(e.content.size==0)return Mark.none;if(this.textOffset)return e.child(t).marks;let n=e.maybeChild(t-1),r=e.maybeChild(t);if(!n){let e=n;n=r;r=e}let o=n.marks;for(var i=0;i<o.length;i++)if(o[i].type.spec.inclusive===false&&(!r||!o[i].isInSet(r.marks)))o=o[i--].removeFromSet(o);return o}marksAcross(e){let t=this.parent.maybeChild(this.index());if(!t||!t.isInline)return null;let n=t.marks,r=e.parent.maybeChild(e.index());for(var o=0;o<n.length;o++)if(n[o].type.spec.inclusive===false&&(!r||!n[o].isInSet(r.marks)))n=n[o--].removeFromSet(n);return n}sharedDepth(e){for(let t=this.depth;t>0;t--)if(this.start(t)<=e&&this.end(t)>=e)return t;return 0}blockRange(e=this,t){if(e.pos<this.pos)return e.blockRange(this);for(let n=this.depth-(this.parent.inlineContent||this.pos==e.pos?1:0);n>=0;n--)if(e.pos<=this.end(n)&&(!t||t(this.node(n))))return new NodeRange(this,e,n);return null}sameParent(e){return this.pos-this.parentOffset==e.pos-e.parentOffset}max(e){return e.pos>this.pos?e:this}min(e){return e.pos<this.pos?e:this}toString(){let e="";for(let t=1;t<=this.depth;t++)e+=(e?"/":"")+this.node(t).type.name+"_"+this.index(t-1);return e+":"+this.parentOffset}static resolve(e,t){if(!(t>=0&&t<=e.content.size))throw new RangeError("Position "+t+" out of range");let n=[];let r=0,o=t;for(let t=e;;){let{index:e,offset:i}=t.content.findIndex(o);let s=o-i;n.push(t,e,r+i);if(!s)break;t=t.child(e);if(t.isText)break;o=s-1;r+=i+1}return new ResolvedPos(t,n,o)}static resolveCached(e,t){let n=resolveCache.get(e);if(n){for(let e=0;e<n.elts.length;e++){let r=n.elts[e];if(r.pos==t)return r}}else{resolveCache.set(e,n=new ResolveCache)}let r=n.elts[n.i]=ResolvedPos.resolve(e,t);n.i=(n.i+1)%resolveCacheSize;return r}}class ResolveCache{constructor(){this.elts=[];this.i=0}}const resolveCacheSize=12,resolveCache=new WeakMap;class NodeRange{constructor(e,t,n){this.$from=e;this.$to=t;this.depth=n}get start(){return this.$from.before(this.depth+1)}get end(){return this.$to.after(this.depth+1)}get parent(){return this.$from.node(this.depth)}get startIndex(){return this.$from.index(this.depth)}get endIndex(){return this.$to.indexAfter(this.depth)}}const emptyAttrs=Object.create(null);let Node$1=class e{constructor(e,t,n,r=Mark.none){this.type=e;this.attrs=t;this.marks=r;this.content=n||Fragment.empty}get nodeSize(){return this.isLeaf?1:2+this.content.size}get childCount(){return this.content.childCount}child(e){return this.content.child(e)}maybeChild(e){return this.content.maybeChild(e)}forEach(e){this.content.forEach(e)}nodesBetween(e,t,n,r=0){this.content.nodesBetween(e,t,n,r,this)}descendants(e){this.nodesBetween(0,this.content.size,e)}get textContent(){return this.isLeaf&&this.type.spec.leafText?this.type.spec.leafText(this):this.textBetween(0,this.content.size,"")}textBetween(e,t,n,r){return this.content.textBetween(e,t,n,r)}get firstChild(){return this.content.firstChild}get lastChild(){return this.content.lastChild}eq(e){return this==e||this.sameMarkup(e)&&this.content.eq(e.content)}sameMarkup(e){return this.hasMarkup(e.type,e.attrs,e.marks)}hasMarkup(e,t,n){return this.type==e&&compareDeep(this.attrs,t||e.defaultAttrs||emptyAttrs)&&Mark.sameSet(this.marks,n||Mark.none)}copy(t=null){if(t==this.content)return this;return new e(this.type,this.attrs,t,this.marks)}mark(t){return t==this.marks?this:new e(this.type,this.attrs,this.content,t)}cut(e,t=this.content.size){if(e==0&&t==this.content.size)return this;return this.copy(this.content.cut(e,t))}slice(e,t=this.content.size,n=false){if(e==t)return Slice.empty;let r=this.resolve(e),o=this.resolve(t);let i=n?0:r.sharedDepth(t);let s=r.start(i),a=r.node(i);let l=a.content.cut(r.pos-s,o.pos-s);return new Slice(l,r.depth-i,o.depth-i)}replace(e,t,n){return replace(this.resolve(e),this.resolve(t),n)}nodeAt(e){for(let t=this;;){let{index:n,offset:r}=t.content.findIndex(e);t=t.maybeChild(n);if(!t)return null;if(r==e||t.isText)return t;e-=r+1}}childAfter(e){let{index:t,offset:n}=this.content.findIndex(e);return{node:this.content.maybeChild(t),index:t,offset:n}}childBefore(e){if(e==0)return{node:null,index:0,offset:0};let{index:t,offset:n}=this.content.findIndex(e);if(n<e)return{node:this.content.child(t),index:t,offset:n};let r=this.content.child(t-1);return{node:r,index:t-1,offset:n-r.nodeSize}}resolve(e){return ResolvedPos.resolveCached(this,e)}resolveNoCache(e){return ResolvedPos.resolve(this,e)}rangeHasMark(e,t,n){let r=false;if(t>e)this.nodesBetween(e,t,(e=>{if(n.isInSet(e.marks))r=true;return!r}));return r}get isBlock(){return this.type.isBlock}get isTextblock(){return this.type.isTextblock}get inlineContent(){return this.type.inlineContent}get isInline(){return this.type.isInline}get isText(){return this.type.isText}get isLeaf(){return this.type.isLeaf}get isAtom(){return this.type.isAtom}toString(){if(this.type.spec.toDebugString)return this.type.spec.toDebugString(this);let e=this.type.name;if(this.content.size)e+="("+this.content.toStringInner()+")";return wrapMarks(this.marks,e)}contentMatchAt(e){let t=this.type.contentMatch.matchFragment(this.content,0,e);if(!t)throw new Error("Called contentMatchAt on a node with invalid content");return t}canReplace(e,t,n=Fragment.empty,r=0,o=n.childCount){let i=this.contentMatchAt(e).matchFragment(n,r,o);let s=i&&i.matchFragment(this.content,t);if(!s||!s.validEnd)return false;for(let e=r;e<o;e++)if(!this.type.allowsMarks(n.child(e).marks))return false;return true}canReplaceWith(e,t,n,r){if(r&&!this.type.allowsMarks(r))return false;let o=this.contentMatchAt(e).matchType(n);let i=o&&o.matchFragment(this.content,t);return i?i.validEnd:false}canAppend(e){if(e.content.size)return this.canReplace(this.childCount,this.childCount,e.content);else return this.type.compatibleContent(e.type)}check(){this.type.checkContent(this.content);this.type.checkAttrs(this.attrs);let e=Mark.none;for(let t=0;t<this.marks.length;t++){let n=this.marks[t];n.type.checkAttrs(n.attrs);e=n.addToSet(e)}if(!Mark.sameSet(e,this.marks))throw new RangeError(`Invalid collection of marks for node ${this.type.name}: ${this.marks.map((e=>e.type.name))}`);this.content.forEach((e=>e.check()))}toJSON(){let e={type:this.type.name};for(let t in this.attrs){e.attrs=this.attrs;break}if(this.content.size)e.content=this.content.toJSON();if(this.marks.length)e.marks=this.marks.map((e=>e.toJSON()));return e}static fromJSON(e,t){if(!t)throw new RangeError("Invalid input for Node.fromJSON");let n=undefined;if(t.marks){if(!Array.isArray(t.marks))throw new RangeError("Invalid mark data for Node.fromJSON");n=t.marks.map(e.markFromJSON)}if(t.type=="text"){if(typeof t.text!="string")throw new RangeError("Invalid text node in JSON");return e.text(t.text,n)}let r=Fragment.fromJSON(e,t.content);let o=e.nodeType(t.type).create(t.attrs,r,n);o.type.checkAttrs(o.attrs);return o}};Node$1.prototype.text=undefined;let TextNode$2=class e extends Node$1{constructor(e,t,n,r){super(e,t,null,r);if(!n)throw new RangeError("Empty text nodes are not allowed");this.text=n}toString(){if(this.type.spec.toDebugString)return this.type.spec.toDebugString(this);return wrapMarks(this.marks,JSON.stringify(this.text))}get textContent(){return this.text}textBetween(e,t){return this.text.slice(e,t)}get nodeSize(){return this.text.length}mark(t){return t==this.marks?this:new e(this.type,this.attrs,this.text,t)}withText(t){if(t==this.text)return this;return new e(this.type,this.attrs,t,this.marks)}cut(e=0,t=this.text.length){if(e==0&&t==this.text.length)return this;return this.withText(this.text.slice(e,t))}eq(e){return this.sameMarkup(e)&&this.text==e.text}toJSON(){let e=super.toJSON();e.text=this.text;return e}};function wrapMarks(e,t){for(let n=e.length-1;n>=0;n--)t=e[n].type.name+"("+t+")";return t}class ContentMatch{constructor(e){this.validEnd=e;this.next=[];this.wrapCache=[]}static parse(e,t){let n=new TokenStream(e,t);if(n.next==null)return ContentMatch.empty;let r=parseExpr(n);if(n.next)n.err("Unexpected trailing text");let o=dfa(nfa(r));checkForDeadEnds(o,n);return o}matchType(e){for(let t=0;t<this.next.length;t++)if(this.next[t].type==e)return this.next[t].next;return null}matchFragment(e,t=0,n=e.childCount){let r=this;for(let o=t;r&&o<n;o++)r=r.matchType(e.child(o).type);return r}get inlineContent(){return this.next.length!=0&&this.next[0].type.isInline}get defaultType(){for(let e=0;e<this.next.length;e++){let{type:t}=this.next[e];if(!(t.isText||t.hasRequiredAttrs()))return t}return null}compatible(e){for(let t=0;t<this.next.length;t++)for(let n=0;n<e.next.length;n++)if(this.next[t].type==e.next[n].type)return true;return false}fillBefore(e,t=false,n=0){let r=[this];function o(i,s){let a=i.matchFragment(e,n);if(a&&(!t||a.validEnd))return Fragment.from(s.map((e=>e.createAndFill())));for(let e=0;e<i.next.length;e++){let{type:t,next:n}=i.next[e];if(!(t.isText||t.hasRequiredAttrs())&&r.indexOf(n)==-1){r.push(n);let e=o(n,s.concat(t));if(e)return e}}return null}return o(this,[])}findWrapping(e){for(let t=0;t<this.wrapCache.length;t+=2)if(this.wrapCache[t]==e)return this.wrapCache[t+1];let t=this.computeWrapping(e);this.wrapCache.push(e,t);return t}computeWrapping(e){let t=Object.create(null),n=[{match:this,type:null,via:null}];while(n.length){let r=n.shift(),o=r.match;if(o.matchType(e)){let e=[];for(let t=r;t.type;t=t.via)e.push(t.type);return e.reverse()}for(let e=0;e<o.next.length;e++){let{type:i,next:s}=o.next[e];if(!i.isLeaf&&!i.hasRequiredAttrs()&&!(i.name in t)&&(!r.type||s.validEnd)){n.push({match:i.contentMatch,type:i,via:r});t[i.name]=true}}}return null}get edgeCount(){return this.next.length}edge(e){if(e>=this.next.length)throw new RangeError(`There's no ${e}th edge in this content match`);return this.next[e]}toString(){let e=[];function t(n){e.push(n);for(let r=0;r<n.next.length;r++)if(e.indexOf(n.next[r].next)==-1)t(n.next[r].next)}t(this);return e.map(((t,n)=>{let r=n+(t.validEnd?"*":" ")+" ";for(let n=0;n<t.next.length;n++)r+=(n?", ":"")+t.next[n].type.name+"->"+e.indexOf(t.next[n].next);return r})).join("\n")}}ContentMatch.empty=new ContentMatch(true);class TokenStream{constructor(e,t){this.string=e;this.nodeTypes=t;this.inline=null;this.pos=0;this.tokens=e.split(/\s*(?=\b|\W|$)/);if(this.tokens[this.tokens.length-1]=="")this.tokens.pop();if(this.tokens[0]=="")this.tokens.shift()}get next(){return this.tokens[this.pos]}eat(e){return this.next==e&&(this.pos++||true)}err(e){throw new SyntaxError(e+" (in content expression '"+this.string+"')")}}function parseExpr(e){let t=[];do{t.push(parseExprSeq(e))}while(e.eat("|"));return t.length==1?t[0]:{type:"choice",exprs:t}}function parseExprSeq(e){let t=[];do{t.push(parseExprSubscript(e))}while(e.next&&e.next!=")"&&e.next!="|");return t.length==1?t[0]:{type:"seq",exprs:t}}function parseExprSubscript(e){let t=parseExprAtom(e);for(;;){if(e.eat("+"))t={type:"plus",expr:t};else if(e.eat("*"))t={type:"star",expr:t};else if(e.eat("?"))t={type:"opt",expr:t};else if(e.eat("{"))t=parseExprRange(e,t);else break}return t}function parseNum(e){if(/\D/.test(e.next))e.err("Expected number, got '"+e.next+"'");let t=Number(e.next);e.pos++;return t}function parseExprRange(e,t){let n=parseNum(e),r=n;if(e.eat(",")){if(e.next!="}")r=parseNum(e);else r=-1}if(!e.eat("}"))e.err("Unclosed braced range");return{type:"range",min:n,max:r,expr:t}}function resolveName(e,t){let n=e.nodeTypes,r=n[t];if(r)return[r];let o=[];for(let e in n){let r=n[e];if(r.groups.indexOf(t)>-1)o.push(r)}if(o.length==0)e.err("No node type or group '"+t+"' found");return o}function parseExprAtom(e){if(e.eat("(")){let t=parseExpr(e);if(!e.eat(")"))e.err("Missing closing paren");return t}else if(!/\W/.test(e.next)){let t=resolveName(e,e.next).map((t=>{if(e.inline==null)e.inline=t.isInline;else if(e.inline!=t.isInline)e.err("Mixing inline and block content");return{type:"name",value:t}}));e.pos++;return t.length==1?t[0]:{type:"choice",exprs:t}}else{e.err("Unexpected token '"+e.next+"'")}}function nfa(e){let t=[[]];o(i(e,0),n());return t;function n(){return t.push([])-1}function r(e,n,r){let o={term:r,to:n};t[e].push(o);return o}function o(e,t){e.forEach((e=>e.to=t))}function i(e,t){if(e.type=="choice"){return e.exprs.reduce(((e,n)=>e.concat(i(n,t))),[])}else if(e.type=="seq"){for(let r=0;;r++){let s=i(e.exprs[r],t);if(r==e.exprs.length-1)return s;o(s,t=n())}}else if(e.type=="star"){let s=n();r(t,s);o(i(e.expr,s),s);return[r(s)]}else if(e.type=="plus"){let s=n();o(i(e.expr,t),s);o(i(e.expr,s),s);return[r(s)]}else if(e.type=="opt"){return[r(t)].concat(i(e.expr,t))}else if(e.type=="range"){let s=t;for(let t=0;t<e.min;t++){let t=n();o(i(e.expr,s),t);s=t}if(e.max==-1){o(i(e.expr,s),s)}else{for(let t=e.min;t<e.max;t++){let t=n();r(s,t);o(i(e.expr,s),t);s=t}}return[r(s)]}else if(e.type=="name"){return[r(t,undefined,e.value)]}else{throw new Error("Unknown expr type")}}}function cmp(e,t){return t-e}function nullFrom(e,t){let n=[];r(t);return n.sort(cmp);function r(t){let o=e[t];if(o.length==1&&!o[0].term)return r(o[0].to);n.push(t);for(let e=0;e<o.length;e++){let{term:t,to:i}=o[e];if(!t&&n.indexOf(i)==-1)r(i)}}}function dfa(e){let t=Object.create(null);return n(nullFrom(e,0));function n(r){let o=[];r.forEach((t=>{e[t].forEach((({term:t,to:n})=>{if(!t)return;let r;for(let e=0;e<o.length;e++)if(o[e][0]==t)r=o[e][1];nullFrom(e,n).forEach((e=>{if(!r)o.push([t,r=[]]);if(r.indexOf(e)==-1)r.push(e)}))}))}));let i=t[r.join(",")]=new ContentMatch(r.indexOf(e.length-1)>-1);for(let e=0;e<o.length;e++){let r=o[e][1].sort(cmp);i.next.push({type:o[e][0],next:t[r.join(",")]||n(r)})}return i}}function checkForDeadEnds(e,t){for(let n=0,r=[e];n<r.length;n++){let e=r[n],o=!e.validEnd,i=[];for(let t=0;t<e.next.length;t++){let{type:n,next:s}=e.next[t];i.push(n.name);if(o&&!(n.isText||n.hasRequiredAttrs()))o=false;if(r.indexOf(s)==-1)r.push(s)}if(o)t.err("Only non-generatable nodes ("+i.join(", ")+") in a required position (see https://prosemirror.net/docs/guide/#generatable)")}}function defaultAttrs(e){let t=Object.create(null);for(let n in e){let r=e[n];if(!r.hasDefault)return null;t[n]=r.default}return t}function computeAttrs(e,t){let n=Object.create(null);for(let r in e){let o=t&&t[r];if(o===undefined){let t=e[r];if(t.hasDefault)o=t.default;else throw new RangeError("No value supplied for attribute "+r)}n[r]=o}return n}function checkAttrs(e,t,n,r){for(let r in t)if(!(r in e))throw new RangeError(`Unsupported attribute ${r} for ${n} of type ${r}`);for(let n in e){let r=e[n];if(r.validate)r.validate(t[n])}}function initAttrs(e,t){let n=Object.create(null);if(t)for(let r in t)n[r]=new Attribute(e,r,t[r]);return n}let NodeType$1=class e{constructor(e,t,n){this.name=e;this.schema=t;this.spec=n;this.markSet=null;this.groups=n.group?n.group.split(" "):[];this.attrs=initAttrs(e,n.attrs);this.defaultAttrs=defaultAttrs(this.attrs);this.contentMatch=null;this.inlineContent=null;this.isBlock=!(n.inline||e=="text");this.isText=e=="text"}get isInline(){return!this.isBlock}get isTextblock(){return this.isBlock&&this.inlineContent}get isLeaf(){return this.contentMatch==ContentMatch.empty}get isAtom(){return this.isLeaf||!!this.spec.atom}get whitespace(){return this.spec.whitespace||(this.spec.code?"pre":"normal")}hasRequiredAttrs(){for(let e in this.attrs)if(this.attrs[e].isRequired)return true;return false}compatibleContent(e){return this==e||this.contentMatch.compatible(e.contentMatch)}computeAttrs(e){if(!e&&this.defaultAttrs)return this.defaultAttrs;else return computeAttrs(this.attrs,e)}create(e=null,t,n){if(this.isText)throw new Error("NodeType.create can't construct text nodes");return new Node$1(this,this.computeAttrs(e),Fragment.from(t),Mark.setFrom(n))}createChecked(e=null,t,n){t=Fragment.from(t);this.checkContent(t);return new Node$1(this,this.computeAttrs(e),t,Mark.setFrom(n))}createAndFill(e=null,t,n){e=this.computeAttrs(e);t=Fragment.from(t);if(t.size){let e=this.contentMatch.fillBefore(t);if(!e)return null;t=e.append(t)}let r=this.contentMatch.matchFragment(t);let o=r&&r.fillBefore(Fragment.empty,true);if(!o)return null;return new Node$1(this,e,t.append(o),Mark.setFrom(n))}validContent(e){let t=this.contentMatch.matchFragment(e);if(!t||!t.validEnd)return false;for(let t=0;t<e.childCount;t++)if(!this.allowsMarks(e.child(t).marks))return false;return true}checkContent(e){if(!this.validContent(e))throw new RangeError(`Invalid content for node ${this.name}: ${e.toString().slice(0,50)}`)}checkAttrs(e){checkAttrs(this.attrs,e,"node",this.name)}allowsMarkType(e){return this.markSet==null||this.markSet.indexOf(e)>-1}allowsMarks(e){if(this.markSet==null)return true;for(let t=0;t<e.length;t++)if(!this.allowsMarkType(e[t].type))return false;return true}allowedMarks(e){if(this.markSet==null)return e;let t;for(let n=0;n<e.length;n++){if(!this.allowsMarkType(e[n].type)){if(!t)t=e.slice(0,n)}else if(t){t.push(e[n])}}return!t?e:t.length?t:Mark.none}static compile(t,n){let r=Object.create(null);t.forEach(((t,o)=>r[t]=new e(t,n,o)));let o=n.spec.topNode||"doc";if(!r[o])throw new RangeError("Schema is missing its top node type ('"+o+"')");if(!r.text)throw new RangeError("Every schema needs a 'text' type");for(let e in r.text.attrs)throw new RangeError("The text node type should not have attributes");return r}};function validateType(e,t,n){let r=n.split("|");return n=>{let o=n===null?"null":typeof n;if(r.indexOf(o)<0)throw new RangeError(`Expected value of type ${r} for attribute ${t} on type ${e}, got ${o}`)}}class Attribute{constructor(e,t,n){this.hasDefault=Object.prototype.hasOwnProperty.call(n,"default");this.default=n.default;this.validate=typeof n.validate=="string"?validateType(e,t,n.validate):n.validate}get isRequired(){return!this.hasDefault}}class MarkType{constructor(e,t,n,r){this.name=e;this.rank=t;this.schema=n;this.spec=r;this.attrs=initAttrs(e,r.attrs);this.excluded=null;let o=defaultAttrs(this.attrs);this.instance=o?new Mark(this,o):null}create(e=null){if(!e&&this.instance)return this.instance;return new Mark(this,computeAttrs(this.attrs,e))}static compile(e,t){let n=Object.create(null),r=0;e.forEach(((e,o)=>n[e]=new MarkType(e,r++,t,o)));return n}removeFromSet(e){for(var t=0;t<e.length;t++)if(e[t].type==this){e=e.slice(0,t).concat(e.slice(t+1));t--}return e}isInSet(e){for(let t=0;t<e.length;t++)if(e[t].type==this)return e[t]}checkAttrs(e){checkAttrs(this.attrs,e,"mark",this.name)}excludes(e){return this.excluded.indexOf(e)>-1}}class Schema{constructor(e){this.linebreakReplacement=null;this.cached=Object.create(null);let t=this.spec={};for(let n in e)t[n]=e[n];t.nodes=OrderedMap.from(e.nodes),t.marks=OrderedMap.from(e.marks||{}),this.nodes=NodeType$1.compile(this.spec.nodes,this);this.marks=MarkType.compile(this.spec.marks,this);let n=Object.create(null);for(let e in this.nodes){if(e in this.marks)throw new RangeError(e+" can not be both a node and a mark");let t=this.nodes[e],r=t.spec.content||"",o=t.spec.marks;t.contentMatch=n[r]||(n[r]=ContentMatch.parse(r,this.nodes));t.inlineContent=t.contentMatch.inlineContent;if(t.spec.linebreakReplacement){if(this.linebreakReplacement)throw new RangeError("Multiple linebreak nodes defined");if(!t.isInline||!t.isLeaf)throw new RangeError("Linebreak replacement nodes must be inline leaf nodes");this.linebreakReplacement=t}t.markSet=o=="_"?null:o?gatherMarks(this,o.split(" ")):o==""||!t.inlineContent?[]:null}for(let e in this.marks){let t=this.marks[e],n=t.spec.excludes;t.excluded=n==null?[t]:n==""?[]:gatherMarks(this,n.split(" "))}this.nodeFromJSON=this.nodeFromJSON.bind(this);this.markFromJSON=this.markFromJSON.bind(this);this.topNodeType=this.nodes[this.spec.topNode||"doc"];this.cached.wrappings=Object.create(null)}node(e,t=null,n,r){if(typeof e=="string")e=this.nodeType(e);else if(!(e instanceof NodeType$1))throw new RangeError("Invalid node type: "+e);else if(e.schema!=this)throw new RangeError("Node type from different schema used ("+e.name+")");return e.createChecked(t,n,r)}text(e,t){let n=this.nodes.text;return new TextNode$2(n,n.defaultAttrs,e,Mark.setFrom(t))}mark(e,t){if(typeof e=="string")e=this.marks[e];return e.create(t)}nodeFromJSON(e){return Node$1.fromJSON(this,e)}markFromJSON(e){return Mark.fromJSON(this,e)}nodeType(e){let t=this.nodes[e];if(!t)throw new RangeError("Unknown node type: "+e);return t}}function gatherMarks(e,t){let n=[];for(let r=0;r<t.length;r++){let o=t[r],i=e.marks[o],s=i;if(i){n.push(i)}else{for(let t in e.marks){let r=e.marks[t];if(o=="_"||r.spec.group&&r.spec.group.split(" ").indexOf(o)>-1)n.push(s=r)}}if(!s)throw new SyntaxError("Unknown mark type: '"+t[r]+"'")}return n}function isTagRule(e){return e.tag!=null}function isStyleRule(e){return e.style!=null}class DOMParser{constructor(e,t){this.schema=e;this.rules=t;this.tags=[];this.styles=[];let n=this.matchedStyles=[];t.forEach((e=>{if(isTagRule(e)){this.tags.push(e)}else if(isStyleRule(e)){let t=/[^=]*/.exec(e.style)[0];if(n.indexOf(t)<0)n.push(t);this.styles.push(e)}}));this.normalizeLists=!this.tags.some((t=>{if(!/^(ul|ol)\b/.test(t.tag)||!t.node)return false;let n=e.nodes[t.node];return n.contentMatch.matchType(n)}))}parse(e,t={}){let n=new ParseContext(this,t,false);n.addAll(e,Mark.none,t.from,t.to);return n.finish()}parseSlice(e,t={}){let n=new ParseContext(this,t,true);n.addAll(e,Mark.none,t.from,t.to);return Slice.maxOpen(n.finish())}matchTag(e,t,n){for(let r=n?this.tags.indexOf(n)+1:0;r<this.tags.length;r++){let n=this.tags[r];if(matches(e,n.tag)&&(n.namespace===undefined||e.namespaceURI==n.namespace)&&(!n.context||t.matchesContext(n.context))){if(n.getAttrs){let t=n.getAttrs(e);if(t===false)continue;n.attrs=t||undefined}return n}}}matchStyle(e,t,n,r){for(let o=r?this.styles.indexOf(r)+1:0;o<this.styles.length;o++){let r=this.styles[o],i=r.style;if(i.indexOf(e)!=0||r.context&&!n.matchesContext(r.context)||i.length>e.length&&(i.charCodeAt(e.length)!=61||i.slice(e.length+1)!=t))continue;if(r.getAttrs){let e=r.getAttrs(t);if(e===false)continue;r.attrs=e||undefined}return r}}static schemaRules(e){let t=[];function n(e){let n=e.priority==null?50:e.priority,r=0;for(;r<t.length;r++){let e=t[r],o=e.priority==null?50:e.priority;if(o<n)break}t.splice(r,0,e)}for(let t in e.marks){let r=e.marks[t].spec.parseDOM;if(r)r.forEach((e=>{n(e=copy(e));if(!(e.mark||e.ignore||e.clearMark))e.mark=t}))}for(let t in e.nodes){let r=e.nodes[t].spec.parseDOM;if(r)r.forEach((e=>{n(e=copy(e));if(!(e.node||e.ignore||e.mark))e.node=t}))}return t}static fromSchema(e){return e.cached.domParser||(e.cached.domParser=new DOMParser(e,DOMParser.schemaRules(e)))}}const blockTags={address:true,article:true,aside:true,blockquote:true,canvas:true,dd:true,div:true,dl:true,fieldset:true,figcaption:true,figure:true,footer:true,form:true,h1:true,h2:true,h3:true,h4:true,h5:true,h6:true,header:true,hgroup:true,hr:true,li:true,noscript:true,ol:true,output:true,p:true,pre:true,section:true,table:true,tfoot:true,ul:true};const ignoreTags={head:true,noscript:true,object:true,script:true,style:true,title:true};const listTags={ol:true,ul:true};const OPT_PRESERVE_WS=1,OPT_PRESERVE_WS_FULL=2,OPT_OPEN_LEFT=4;function wsOptionsFor(e,t,n){if(t!=null)return(t?OPT_PRESERVE_WS:0)|(t==="full"?OPT_PRESERVE_WS_FULL:0);return e&&e.whitespace=="pre"?OPT_PRESERVE_WS|OPT_PRESERVE_WS_FULL:n&~OPT_OPEN_LEFT}class NodeContext{constructor(e,t,n,r,o,i){this.type=e;this.attrs=t;this.marks=n;this.solid=r;this.options=i;this.content=[];this.activeMarks=Mark.none;this.match=o||(i&OPT_OPEN_LEFT?null:e.contentMatch)}findWrapping(e){if(!this.match){if(!this.type)return[];let t=this.type.contentMatch.fillBefore(Fragment.from(e));if(t){this.match=this.type.contentMatch.matchFragment(t)}else{let t=this.type.contentMatch,n;if(n=t.findWrapping(e.type)){this.match=t;return n}else{return null}}}return this.match.findWrapping(e.type)}finish(e){if(!(this.options&OPT_PRESERVE_WS)){let e=this.content[this.content.length-1],t;if(e&&e.isText&&(t=/[ \t\r\n\u000c]+$/.exec(e.text))){let n=e;if(e.text.length==t[0].length)this.content.pop();else this.content[this.content.length-1]=n.withText(n.text.slice(0,n.text.length-t[0].length))}}let t=Fragment.from(this.content);if(!e&&this.match)t=t.append(this.match.fillBefore(Fragment.empty,true));return this.type?this.type.create(this.attrs,t,this.marks):t}inlineContext(e){if(this.type)return this.type.inlineContent;if(this.content.length)return this.content[0].isInline;return e.parentNode&&!blockTags.hasOwnProperty(e.parentNode.nodeName.toLowerCase())}}class ParseContext{constructor(e,t,n){this.parser=e;this.options=t;this.isOpen=n;this.open=0;let r=t.topNode,o;let i=wsOptionsFor(null,t.preserveWhitespace,0)|(n?OPT_OPEN_LEFT:0);if(r)o=new NodeContext(r.type,r.attrs,Mark.none,true,t.topMatch||r.type.contentMatch,i);else if(n)o=new NodeContext(null,null,Mark.none,true,null,i);else o=new NodeContext(e.schema.topNodeType,null,Mark.none,true,null,i);this.nodes=[o];this.find=t.findPositions;this.needsBlock=false}get top(){return this.nodes[this.open]}addDOM(e,t){if(e.nodeType==3)this.addTextNode(e,t);else if(e.nodeType==1)this.addElement(e,t)}addTextNode(e,t){let n=e.nodeValue;let r=this.top;if(r.options&OPT_PRESERVE_WS_FULL||r.inlineContext(e)||/[^ \t\r\n\u000c]/.test(n)){if(!(r.options&OPT_PRESERVE_WS)){n=n.replace(/[ \t\r\n\u000c]+/g," ");if(/^[ \t\r\n\u000c]/.test(n)&&this.open==this.nodes.length-1){let t=r.content[r.content.length-1];let o=e.previousSibling;if(!t||o&&o.nodeName=="BR"||t.isText&&/[ \t\r\n\u000c]$/.test(t.text))n=n.slice(1)}}else if(!(r.options&OPT_PRESERVE_WS_FULL)){n=n.replace(/\r?\n|\r/g," ")}else{n=n.replace(/\r\n?/g,"\n")}if(n)this.insertNode(this.parser.schema.text(n),t);this.findInText(e)}else{this.findInside(e)}}addElement(e,t,n){let r=e.nodeName.toLowerCase(),o;if(listTags.hasOwnProperty(r)&&this.parser.normalizeLists)normalizeList(e);let i=this.options.ruleFromNode&&this.options.ruleFromNode(e)||(o=this.parser.matchTag(e,this,n));if(i?i.ignore:ignoreTags.hasOwnProperty(r)){this.findInside(e);this.ignoreFallback(e,t)}else if(!i||i.skip||i.closeParent){if(i&&i.closeParent)this.open=Math.max(0,this.open-1);else if(i&&i.skip.nodeType)e=i.skip;let n,o=this.top,s=this.needsBlock;if(blockTags.hasOwnProperty(r)){if(o.content.length&&o.content[0].isInline&&this.open){this.open--;o=this.top}n=true;if(!o.type)this.needsBlock=true}else if(!e.firstChild){this.leafFallback(e,t);return}let a=i&&i.skip?t:this.readStyles(e,t);if(a)this.addAll(e,a);if(n)this.sync(o);this.needsBlock=s}else{let n=this.readStyles(e,t);if(n)this.addElementByRule(e,i,n,i.consuming===false?o:undefined)}}leafFallback(e,t){if(e.nodeName=="BR"&&this.top.type&&this.top.type.inlineContent)this.addTextNode(e.ownerDocument.createTextNode("\n"),t)}ignoreFallback(e,t){if(e.nodeName=="BR"&&(!this.top.type||!this.top.type.inlineContent))this.findPlace(this.parser.schema.text("-"),t)}readStyles(e,t){let n=e.style;if(n&&n.length)for(let e=0;e<this.parser.matchedStyles.length;e++){let r=this.parser.matchedStyles[e],o=n.getPropertyValue(r);if(o)for(let e=undefined;;){let n=this.parser.matchStyle(r,o,this,e);if(!n)break;if(n.ignore)return null;if(n.clearMark)t=t.filter((e=>!n.clearMark(e)));else t=t.concat(this.parser.schema.marks[n.mark].create(n.attrs));if(n.consuming===false)e=n;else break}}return t}addElementByRule(e,t,n,r){let o,i;if(t.node){i=this.parser.schema.nodes[t.node];if(!i.isLeaf){let e=this.enter(i,t.attrs||null,n,t.preserveWhitespace);if(e){o=true;n=e}}else if(!this.insertNode(i.create(t.attrs),n)){this.leafFallback(e,n)}}else{let e=this.parser.schema.marks[t.mark];n=n.concat(e.create(t.attrs))}let s=this.top;if(i&&i.isLeaf){this.findInside(e)}else if(r){this.addElement(e,n,r)}else if(t.getContent){this.findInside(e);t.getContent(e,this.parser.schema).forEach((e=>this.insertNode(e,n)))}else{let r=e;if(typeof t.contentElement=="string")r=e.querySelector(t.contentElement);else if(typeof t.contentElement=="function")r=t.contentElement(e);else if(t.contentElement)r=t.contentElement;this.findAround(e,r,true);this.addAll(r,n)}if(o&&this.sync(s))this.open--}addAll(e,t,n,r){let o=n||0;for(let i=n?e.childNodes[n]:e.firstChild,s=r==null?null:e.childNodes[r];i!=s;i=i.nextSibling,++o){this.findAtPoint(e,o);this.addDOM(i,t)}this.findAtPoint(e,o)}findPlace(e,t){let n,r;for(let t=this.open;t>=0;t--){let o=this.nodes[t];let i=o.findWrapping(e);if(i&&(!n||n.length>i.length)){n=i;r=o;if(!i.length)break}if(o.solid)break}if(!n)return null;this.sync(r);for(let e=0;e<n.length;e++)t=this.enterInner(n[e],null,t,false);return t}insertNode(e,t){if(e.isInline&&this.needsBlock&&!this.top.type){let e=this.textblockFromContext();if(e)t=this.enterInner(e,null,t)}let n=this.findPlace(e,t);if(n){this.closeExtra();let t=this.top;if(t.match)t.match=t.match.matchType(e.type);let r=Mark.none;for(let o of n.concat(e.marks))if(t.type?t.type.allowsMarkType(o.type):markMayApply(o.type,e.type))r=o.addToSet(r);t.content.push(e.mark(r));return true}return false}enter(e,t,n,r){let o=this.findPlace(e.create(t),n);if(o)o=this.enterInner(e,t,n,true,r);return o}enterInner(e,t,n,r=false,o){this.closeExtra();let i=this.top;i.match=i.match&&i.match.matchType(e);let s=wsOptionsFor(e,o,i.options);if(i.options&OPT_OPEN_LEFT&&i.content.length==0)s|=OPT_OPEN_LEFT;let a=Mark.none;n=n.filter((t=>{if(i.type?i.type.allowsMarkType(t.type):markMayApply(t.type,e)){a=t.addToSet(a);return false}return true}));this.nodes.push(new NodeContext(e,t,a,r,null,s));this.open++;return n}closeExtra(e=false){let t=this.nodes.length-1;if(t>this.open){for(;t>this.open;t--)this.nodes[t-1].content.push(this.nodes[t].finish(e));this.nodes.length=this.open+1}}finish(){this.open=0;this.closeExtra(this.isOpen);return this.nodes[0].finish(this.isOpen||this.options.topOpen)}sync(e){for(let t=this.open;t>=0;t--)if(this.nodes[t]==e){this.open=t;return true}return false}get currentPos(){this.closeExtra();let e=0;for(let t=this.open;t>=0;t--){let n=this.nodes[t].content;for(let t=n.length-1;t>=0;t--)e+=n[t].nodeSize;if(t)e++}return e}findAtPoint(e,t){if(this.find)for(let n=0;n<this.find.length;n++){if(this.find[n].node==e&&this.find[n].offset==t)this.find[n].pos=this.currentPos}}findInside(e){if(this.find)for(let t=0;t<this.find.length;t++){if(this.find[t].pos==null&&e.nodeType==1&&e.contains(this.find[t].node))this.find[t].pos=this.currentPos}}findAround(e,t,n){if(e!=t&&this.find)for(let r=0;r<this.find.length;r++){if(this.find[r].pos==null&&e.nodeType==1&&e.contains(this.find[r].node)){let e=t.compareDocumentPosition(this.find[r].node);if(e&(n?2:4))this.find[r].pos=this.currentPos}}}findInText(e){if(this.find)for(let t=0;t<this.find.length;t++){if(this.find[t].node==e)this.find[t].pos=this.currentPos-(e.nodeValue.length-this.find[t].offset)}}matchesContext(e){if(e.indexOf("|")>-1)return e.split(/\s*\|\s*/).some(this.matchesContext,this);let t=e.split("/");let n=this.options.context;let r=!this.isOpen&&(!n||n.parent.type==this.nodes[0].type);let o=-(n?n.depth+1:0)+(r?0:1);let i=(e,s)=>{for(;e>=0;e--){let a=t[e];if(a==""){if(e==t.length-1||e==0)continue;for(;s>=o;s--)if(i(e-1,s))return true;return false}else{let e=s>0||s==0&&r?this.nodes[s].type:n&&s>=o?n.node(s-o).type:null;if(!e||e.name!=a&&e.groups.indexOf(a)==-1)return false;s--}}return true};return i(t.length-1,this.open)}textblockFromContext(){let e=this.options.context;if(e)for(let t=e.depth;t>=0;t--){let n=e.node(t).contentMatchAt(e.indexAfter(t)).defaultType;if(n&&n.isTextblock&&n.defaultAttrs)return n}for(let e in this.parser.schema.nodes){let t=this.parser.schema.nodes[e];if(t.isTextblock&&t.defaultAttrs)return t}}}function normalizeList(e){for(let t=e.firstChild,n=null;t;t=t.nextSibling){let e=t.nodeType==1?t.nodeName.toLowerCase():null;if(e&&listTags.hasOwnProperty(e)&&n){n.appendChild(t);t=n}else if(e=="li"){n=t}else if(e){n=null}}}function matches(e,t){return(e.matches||e.msMatchesSelector||e.webkitMatchesSelector||e.mozMatchesSelector).call(e,t)}function copy(e){let t={};for(let n in e)t[n]=e[n];return t}function markMayApply(e,t){let n=t.schema.nodes;for(let r in n){let o=n[r];if(!o.allowsMarkType(e))continue;let i=[],s=e=>{i.push(e);for(let n=0;n<e.edgeCount;n++){let{type:r,next:o}=e.edge(n);if(r==t)return true;if(i.indexOf(o)<0&&s(o))return true}};if(s(o.contentMatch))return true}}class DOMSerializer{constructor(e,t){this.nodes=e;this.marks=t}serializeFragment(e,t={},n){if(!n)n=doc$1(t).createDocumentFragment();let r=n,o=[];e.forEach((e=>{if(o.length||e.marks.length){let n=0,i=0;while(n<o.length&&i<e.marks.length){let t=e.marks[i];if(!this.marks[t.type.name]){i++;continue}if(!t.eq(o[n][0])||t.type.spec.spanning===false)break;n++;i++}while(n<o.length)r=o.pop()[1];while(i<e.marks.length){let n=e.marks[i++];let s=this.serializeMark(n,e.isInline,t);if(s){o.push([n,r]);r.appendChild(s.dom);r=s.contentDOM||s.dom}}}r.appendChild(this.serializeNodeInner(e,t))}));return n}serializeNodeInner(e,t){let{dom:n,contentDOM:r}=renderSpec(doc$1(t),this.nodes[e.type.name](e),null,e.attrs);if(r){if(e.isLeaf)throw new RangeError("Content hole not allowed in a leaf node spec");this.serializeFragment(e.content,t,r)}return n}serializeNode(e,t={}){let n=this.serializeNodeInner(e,t);for(let r=e.marks.length-1;r>=0;r--){let o=this.serializeMark(e.marks[r],e.isInline,t);if(o){(o.contentDOM||o.dom).appendChild(n);n=o.dom}}return n}serializeMark(e,t,n={}){let r=this.marks[e.type.name];return r&&renderSpec(doc$1(n),r(e,t),null,e.attrs)}static renderSpec(e,t,n=null,r){return renderSpec(e,t,n,r)}static fromSchema(e){return e.cached.domSerializer||(e.cached.domSerializer=new DOMSerializer(this.nodesFromSchema(e),this.marksFromSchema(e)))}static nodesFromSchema(e){let t=gatherToDOM(e.nodes);if(!t.text)t.text=e=>e.text;return t}static marksFromSchema(e){return gatherToDOM(e.marks)}}function gatherToDOM(e){let t={};for(let n in e){let r=e[n].spec.toDOM;if(r)t[n]=r}return t}function doc$1(e){return e.document||window.document}const suspiciousAttributeCache=new WeakMap;function suspiciousAttributes(e){let t=suspiciousAttributeCache.get(e);if(t===undefined)suspiciousAttributeCache.set(e,t=suspiciousAttributesInner(e));return t}function suspiciousAttributesInner(e){let t=null;function n(e){if(e&&typeof e=="object"){if(Array.isArray(e)){if(typeof e[0]=="string"){if(!t)t=[];t.push(e)}else{for(let t=0;t<e.length;t++)n(e[t])}}else{for(let t in e)n(e[t])}}}n(e);return t}function renderSpec(e,t,n,r){if(typeof t=="string")return{dom:e.createTextNode(t)};if(t.nodeType!=null)return{dom:t};if(t.dom&&t.dom.nodeType!=null)return t;let o=t[0],i;if(typeof o!="string")throw new RangeError("Invalid array passed to renderSpec");if(r&&(i=suspiciousAttributes(r))&&i.indexOf(t)>-1)throw new RangeError("Using an array from an attribute object as a DOM spec. This may be an attempted cross site scripting attack.");let s=o.indexOf(" ");if(s>0){n=o.slice(0,s);o=o.slice(s+1)}let a;let l=n?e.createElementNS(n,o):e.createElement(o);let c=t[1],d=1;if(c&&typeof c=="object"&&c.nodeType==null&&!Array.isArray(c)){d=2;for(let e in c)if(c[e]!=null){let t=e.indexOf(" ");if(t>0)l.setAttributeNS(e.slice(0,t),e.slice(t+1),c[e]);else l.setAttribute(e,c[e])}}for(let o=d;o<t.length;o++){let i=t[o];if(i===0){if(o<t.length-1||o>d)throw new RangeError("Content hole must be the only child of its parent node");return{dom:l,contentDOM:l}}else{let{dom:t,contentDOM:o}=renderSpec(e,i,n,r);l.appendChild(t);if(o){if(a)throw new RangeError("Multiple content holes");a=o}}}return{dom:l,contentDOM:a}}const lower16=65535;const factor16=Math.pow(2,16);function makeRecover(e,t){return e+t*factor16}function recoverIndex(e){return e&lower16}function recoverOffset(e){return(e-(e&lower16))/factor16}const DEL_BEFORE=1,DEL_AFTER=2,DEL_ACROSS=4,DEL_SIDE=8;class MapResult{constructor(e,t,n){this.pos=e;this.delInfo=t;this.recover=n}get deleted(){return(this.delInfo&DEL_SIDE)>0}get deletedBefore(){return(this.delInfo&(DEL_BEFORE|DEL_ACROSS))>0}get deletedAfter(){return(this.delInfo&(DEL_AFTER|DEL_ACROSS))>0}get deletedAcross(){return(this.delInfo&DEL_ACROSS)>0}}class StepMap{constructor(e,t=false){this.ranges=e;this.inverted=t;if(!e.length&&StepMap.empty)return StepMap.empty}recover(e){let t=0,n=recoverIndex(e);if(!this.inverted)for(let e=0;e<n;e++)t+=this.ranges[e*3+2]-this.ranges[e*3+1];return this.ranges[n*3]+t+recoverOffset(e)}mapResult(e,t=1){return this._map(e,t,false)}map(e,t=1){return this._map(e,t,true)}_map(e,t,n){let r=0,o=this.inverted?2:1,i=this.inverted?1:2;for(let s=0;s<this.ranges.length;s+=3){let a=this.ranges[s]-(this.inverted?r:0);if(a>e)break;let l=this.ranges[s+o],c=this.ranges[s+i],d=a+l;if(e<=d){let o=!l?t:e==a?-1:e==d?1:t;let i=a+r+(o<0?0:c);if(n)return i;let u=e==(t<0?a:d)?null:makeRecover(s/3,e-a);let p=e==a?DEL_AFTER:e==d?DEL_BEFORE:DEL_ACROSS;if(t<0?e!=a:e!=d)p|=DEL_SIDE;return new MapResult(i,p,u)}r+=c-l}return n?e+r:new MapResult(e+r,0,null)}touches(e,t){let n=0,r=recoverIndex(t);let o=this.inverted?2:1,i=this.inverted?1:2;for(let t=0;t<this.ranges.length;t+=3){let s=this.ranges[t]-(this.inverted?n:0);if(s>e)break;let a=this.ranges[t+o],l=s+a;if(e<=l&&t==r*3)return true;n+=this.ranges[t+i]-a}return false}forEach(e){let t=this.inverted?2:1,n=this.inverted?1:2;for(let r=0,o=0;r<this.ranges.length;r+=3){let i=this.ranges[r],s=i-(this.inverted?o:0),a=i+(this.inverted?0:o);let l=this.ranges[r+t],c=this.ranges[r+n];e(s,s+l,a,a+c);o+=c-l}}invert(){return new StepMap(this.ranges,!this.inverted)}toString(){return(this.inverted?"-":"")+JSON.stringify(this.ranges)}static offset(e){return e==0?StepMap.empty:new StepMap(e<0?[0,-e,0]:[0,0,e])}}StepMap.empty=new StepMap([]);class Mapping{constructor(e=[],t,n=0,r=e.length){this.maps=e;this.mirror=t;this.from=n;this.to=r}slice(e=0,t=this.maps.length){return new Mapping(this.maps,this.mirror,e,t)}copy(){return new Mapping(this.maps.slice(),this.mirror&&this.mirror.slice(),this.from,this.to)}appendMap(e,t){this.to=this.maps.push(e);if(t!=null)this.setMirror(this.maps.length-1,t)}appendMapping(e){for(let t=0,n=this.maps.length;t<e.maps.length;t++){let r=e.getMirror(t);this.appendMap(e.maps[t],r!=null&&r<t?n+r:undefined)}}getMirror(e){if(this.mirror)for(let t=0;t<this.mirror.length;t++)if(this.mirror[t]==e)return this.mirror[t+(t%2?-1:1)]}setMirror(e,t){if(!this.mirror)this.mirror=[];this.mirror.push(e,t)}appendMappingInverted(e){for(let t=e.maps.length-1,n=this.maps.length+e.maps.length;t>=0;t--){let r=e.getMirror(t);this.appendMap(e.maps[t].invert(),r!=null&&r>t?n-r-1:undefined)}}invert(){let e=new Mapping;e.appendMappingInverted(this);return e}map(e,t=1){if(this.mirror)return this._map(e,t,true);for(let n=this.from;n<this.to;n++)e=this.maps[n].map(e,t);return e}mapResult(e,t=1){return this._map(e,t,false)}_map(e,t,n){let r=0;for(let n=this.from;n<this.to;n++){let o=this.maps[n],i=o.mapResult(e,t);if(i.recover!=null){let t=this.getMirror(n);if(t!=null&&t>n&&t<this.to){n=t;e=this.maps[t].recover(i.recover);continue}}r|=i.delInfo;e=i.pos}return n?e:new MapResult(e,r,null)}}const stepsByID=Object.create(null);class Step{getMap(){return StepMap.empty}merge(e){return null}static fromJSON(e,t){if(!t||!t.stepType)throw new RangeError("Invalid input for Step.fromJSON");let n=stepsByID[t.stepType];if(!n)throw new RangeError(`No step type ${t.stepType} defined`);return n.fromJSON(e,t)}static jsonID(e,t){if(e in stepsByID)throw new RangeError("Duplicate use of step JSON ID "+e);stepsByID[e]=t;t.prototype.jsonID=e;return t}}class StepResult{constructor(e,t){this.doc=e;this.failed=t}static ok(e){return new StepResult(e,null)}static fail(e){return new StepResult(null,e)}static fromReplace(e,t,n,r){try{return StepResult.ok(e.replace(t,n,r))}catch(e){if(e instanceof ReplaceError)return StepResult.fail(e.message);throw e}}}function mapFragment(e,t,n){let r=[];for(let o=0;o<e.childCount;o++){let i=e.child(o);if(i.content.size)i=i.copy(mapFragment(i.content,t,i));if(i.isInline)i=t(i,n,o);r.push(i)}return Fragment.fromArray(r)}class AddMarkStep extends Step{constructor(e,t,n){super();this.from=e;this.to=t;this.mark=n}apply(e){let t=e.slice(this.from,this.to),n=e.resolve(this.from);let r=n.node(n.sharedDepth(this.to));let o=new Slice(mapFragment(t.content,((e,t)=>{if(!e.isAtom||!t.type.allowsMarkType(this.mark.type))return e;return e.mark(this.mark.addToSet(e.marks))}),r),t.openStart,t.openEnd);return StepResult.fromReplace(e,this.from,this.to,o)}invert(){return new RemoveMarkStep(this.from,this.to,this.mark)}map(e){let t=e.mapResult(this.from,1),n=e.mapResult(this.to,-1);if(t.deleted&&n.deleted||t.pos>=n.pos)return null;return new AddMarkStep(t.pos,n.pos,this.mark)}merge(e){if(e instanceof AddMarkStep&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from)return new AddMarkStep(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark);return null}toJSON(){return{stepType:"addMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for AddMarkStep.fromJSON");return new AddMarkStep(t.from,t.to,e.markFromJSON(t.mark))}}Step.jsonID("addMark",AddMarkStep);class RemoveMarkStep extends Step{constructor(e,t,n){super();this.from=e;this.to=t;this.mark=n}apply(e){let t=e.slice(this.from,this.to);let n=new Slice(mapFragment(t.content,(e=>e.mark(this.mark.removeFromSet(e.marks))),e),t.openStart,t.openEnd);return StepResult.fromReplace(e,this.from,this.to,n)}invert(){return new AddMarkStep(this.from,this.to,this.mark)}map(e){let t=e.mapResult(this.from,1),n=e.mapResult(this.to,-1);if(t.deleted&&n.deleted||t.pos>=n.pos)return null;return new RemoveMarkStep(t.pos,n.pos,this.mark)}merge(e){if(e instanceof RemoveMarkStep&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from)return new RemoveMarkStep(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark);return null}toJSON(){return{stepType:"removeMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for RemoveMarkStep.fromJSON");return new RemoveMarkStep(t.from,t.to,e.markFromJSON(t.mark))}}Step.jsonID("removeMark",RemoveMarkStep);class AddNodeMarkStep extends Step{constructor(e,t){super();this.pos=e;this.mark=t}apply(e){let t=e.nodeAt(this.pos);if(!t)return StepResult.fail("No node at mark step's position");let n=t.type.create(t.attrs,null,this.mark.addToSet(t.marks));return StepResult.fromReplace(e,this.pos,this.pos+1,new Slice(Fragment.from(n),0,t.isLeaf?0:1))}invert(e){let t=e.nodeAt(this.pos);if(t){let e=this.mark.addToSet(t.marks);if(e.length==t.marks.length){for(let n=0;n<t.marks.length;n++)if(!t.marks[n].isInSet(e))return new AddNodeMarkStep(this.pos,t.marks[n]);return new AddNodeMarkStep(this.pos,this.mark)}}return new RemoveNodeMarkStep(this.pos,this.mark)}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new AddNodeMarkStep(t.pos,this.mark)}toJSON(){return{stepType:"addNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for AddNodeMarkStep.fromJSON");return new AddNodeMarkStep(t.pos,e.markFromJSON(t.mark))}}Step.jsonID("addNodeMark",AddNodeMarkStep);class RemoveNodeMarkStep extends Step{constructor(e,t){super();this.pos=e;this.mark=t}apply(e){let t=e.nodeAt(this.pos);if(!t)return StepResult.fail("No node at mark step's position");let n=t.type.create(t.attrs,null,this.mark.removeFromSet(t.marks));return StepResult.fromReplace(e,this.pos,this.pos+1,new Slice(Fragment.from(n),0,t.isLeaf?0:1))}invert(e){let t=e.nodeAt(this.pos);if(!t||!this.mark.isInSet(t.marks))return this;return new AddNodeMarkStep(this.pos,this.mark)}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new RemoveNodeMarkStep(t.pos,this.mark)}toJSON(){return{stepType:"removeNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for RemoveNodeMarkStep.fromJSON");return new RemoveNodeMarkStep(t.pos,e.markFromJSON(t.mark))}}Step.jsonID("removeNodeMark",RemoveNodeMarkStep);class ReplaceStep extends Step{constructor(e,t,n,r=false){super();this.from=e;this.to=t;this.slice=n;this.structure=r}apply(e){if(this.structure&&contentBetween(e,this.from,this.to))return StepResult.fail("Structure replace would overwrite content");return StepResult.fromReplace(e,this.from,this.to,this.slice)}getMap(){return new StepMap([this.from,this.to-this.from,this.slice.size])}invert(e){return new ReplaceStep(this.from,this.from+this.slice.size,e.slice(this.from,this.to))}map(e){let t=e.mapResult(this.from,1),n=e.mapResult(this.to,-1);if(t.deletedAcross&&n.deletedAcross)return null;return new ReplaceStep(t.pos,Math.max(t.pos,n.pos),this.slice)}merge(e){if(!(e instanceof ReplaceStep)||e.structure||this.structure)return null;if(this.from+this.slice.size==e.from&&!this.slice.openEnd&&!e.slice.openStart){let t=this.slice.size+e.slice.size==0?Slice.empty:new Slice(this.slice.content.append(e.slice.content),this.slice.openStart,e.slice.openEnd);return new ReplaceStep(this.from,this.to+(e.to-e.from),t,this.structure)}else if(e.to==this.from&&!this.slice.openStart&&!e.slice.openEnd){let t=this.slice.size+e.slice.size==0?Slice.empty:new Slice(e.slice.content.append(this.slice.content),e.slice.openStart,this.slice.openEnd);return new ReplaceStep(e.from,this.to,t,this.structure)}else{return null}}toJSON(){let e={stepType:"replace",from:this.from,to:this.to};if(this.slice.size)e.slice=this.slice.toJSON();if(this.structure)e.structure=true;return e}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for ReplaceStep.fromJSON");return new ReplaceStep(t.from,t.to,Slice.fromJSON(e,t.slice),!!t.structure)}}Step.jsonID("replace",ReplaceStep);class ReplaceAroundStep extends Step{constructor(e,t,n,r,o,i,s=false){super();this.from=e;this.to=t;this.gapFrom=n;this.gapTo=r;this.slice=o;this.insert=i;this.structure=s}apply(e){if(this.structure&&(contentBetween(e,this.from,this.gapFrom)||contentBetween(e,this.gapTo,this.to)))return StepResult.fail("Structure gap-replace would overwrite content");let t=e.slice(this.gapFrom,this.gapTo);if(t.openStart||t.openEnd)return StepResult.fail("Gap is not a flat range");let n=this.slice.insertAt(this.insert,t.content);if(!n)return StepResult.fail("Content does not fit in gap");return StepResult.fromReplace(e,this.from,this.to,n)}getMap(){return new StepMap([this.from,this.gapFrom-this.from,this.insert,this.gapTo,this.to-this.gapTo,this.slice.size-this.insert])}invert(e){let t=this.gapTo-this.gapFrom;return new ReplaceAroundStep(this.from,this.from+this.slice.size+t,this.from+this.insert,this.from+this.insert+t,e.slice(this.from,this.to).removeBetween(this.gapFrom-this.from,this.gapTo-this.from),this.gapFrom-this.from,this.structure)}map(e){let t=e.mapResult(this.from,1),n=e.mapResult(this.to,-1);let r=this.from==this.gapFrom?t.pos:e.map(this.gapFrom,-1);let o=this.to==this.gapTo?n.pos:e.map(this.gapTo,1);if(t.deletedAcross&&n.deletedAcross||r<t.pos||o>n.pos)return null;return new ReplaceAroundStep(t.pos,n.pos,r,o,this.slice,this.insert,this.structure)}toJSON(){let e={stepType:"replaceAround",from:this.from,to:this.to,gapFrom:this.gapFrom,gapTo:this.gapTo,insert:this.insert};if(this.slice.size)e.slice=this.slice.toJSON();if(this.structure)e.structure=true;return e}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number"||typeof t.gapFrom!="number"||typeof t.gapTo!="number"||typeof t.insert!="number")throw new RangeError("Invalid input for ReplaceAroundStep.fromJSON");return new ReplaceAroundStep(t.from,t.to,t.gapFrom,t.gapTo,Slice.fromJSON(e,t.slice),t.insert,!!t.structure)}}Step.jsonID("replaceAround",ReplaceAroundStep);function contentBetween(e,t,n){let r=e.resolve(t),o=n-t,i=r.depth;while(o>0&&i>0&&r.indexAfter(i)==r.node(i).childCount){i--;o--}if(o>0){let e=r.node(i).maybeChild(r.indexAfter(i));while(o>0){if(!e||e.isLeaf)return true;e=e.firstChild;o--}}return false}function addMark(e,t,n,r){let o=[],i=[];let s,a;e.doc.nodesBetween(t,n,((e,l,c)=>{if(!e.isInline)return;let d=e.marks;if(!r.isInSet(d)&&c.type.allowsMarkType(r.type)){let c=Math.max(l,t),u=Math.min(l+e.nodeSize,n);let p=r.addToSet(d);for(let e=0;e<d.length;e++){if(!d[e].isInSet(p)){if(s&&s.to==c&&s.mark.eq(d[e]))s.to=u;else o.push(s=new RemoveMarkStep(c,u,d[e]))}}if(a&&a.to==c)a.to=u;else i.push(a=new AddMarkStep(c,u,r))}}));o.forEach((t=>e.step(t)));i.forEach((t=>e.step(t)))}function removeMark(e,t,n,r){let o=[],i=0;e.doc.nodesBetween(t,n,((e,s)=>{if(!e.isInline)return;i++;let a=null;if(r instanceof MarkType){let t=e.marks,n;while(n=r.isInSet(t)){(a||(a=[])).push(n);t=n.removeFromSet(t)}}else if(r){if(r.isInSet(e.marks))a=[r]}else{a=e.marks}if(a&&a.length){let r=Math.min(s+e.nodeSize,n);for(let e=0;e<a.length;e++){let n=a[e],l;for(let e=0;e<o.length;e++){let t=o[e];if(t.step==i-1&&n.eq(o[e].style))l=t}if(l){l.to=r;l.step=i}else{o.push({style:n,from:Math.max(s,t),to:r,step:i})}}}}));o.forEach((t=>e.step(new RemoveMarkStep(t.from,t.to,t.style))))}function clearIncompatible(e,t,n,r=n.contentMatch,o=true){let i=e.doc.nodeAt(t);let s=[],a=t+1;for(let t=0;t<i.childCount;t++){let l=i.child(t),c=a+l.nodeSize;let d=r.matchType(l.type);if(!d){s.push(new ReplaceStep(a,c,Slice.empty))}else{r=d;for(let t=0;t<l.marks.length;t++)if(!n.allowsMarkType(l.marks[t].type))e.step(new RemoveMarkStep(a,c,l.marks[t]));if(o&&l.isText&&n.whitespace!="pre"){let e,t=/\r?\n|\r/g,r;while(e=t.exec(l.text)){if(!r)r=new Slice(Fragment.from(n.schema.text(" ",n.allowedMarks(l.marks))),0,0);s.push(new ReplaceStep(a+e.index,a+e.index+e[0].length,r))}}}a=c}if(!r.validEnd){let t=r.fillBefore(Fragment.empty,true);e.replace(a,a,new Slice(t,0,0))}for(let t=s.length-1;t>=0;t--)e.step(s[t])}function canCut(e,t,n){return(t==0||e.canReplace(t,e.childCount))&&(n==e.childCount||e.canReplace(0,n))}function liftTarget(e){let t=e.parent;let n=t.content.cutByIndex(e.startIndex,e.endIndex);for(let t=e.depth;;--t){let r=e.$from.node(t);let o=e.$from.index(t),i=e.$to.indexAfter(t);if(t<e.depth&&r.canReplace(o,i,n))return t;if(t==0||r.type.spec.isolating||!canCut(r,o,i))break}return null}function lift$1(e,t,n){let{$from:r,$to:o,depth:i}=t;let s=r.before(i+1),a=o.after(i+1);let l=s,c=a;let d=Fragment.empty,u=0;for(let e=i,t=false;e>n;e--)if(t||r.index(e)>0){t=true;d=Fragment.from(r.node(e).copy(d));u++}else{l--}let p=Fragment.empty,f=0;for(let e=i,t=false;e>n;e--)if(t||o.after(e+1)<o.end(e)){t=true;p=Fragment.from(o.node(e).copy(p));f++}else{c++}e.step(new ReplaceAroundStep(l,c,s,a,new Slice(d.append(p),u,f),d.size-u,true))}function findWrapping(e,t,n=null,r=e){let o=findWrappingOutside(e,t);let i=o&&findWrappingInside(r,t);if(!i)return null;return o.map(withAttrs).concat({type:t,attrs:n}).concat(i.map(withAttrs))}function withAttrs(e){return{type:e,attrs:null}}function findWrappingOutside(e,t){let{parent:n,startIndex:r,endIndex:o}=e;let i=n.contentMatchAt(r).findWrapping(t);if(!i)return null;let s=i.length?i[0]:t;return n.canReplaceWith(r,o,s)?i:null}function findWrappingInside(e,t){let{parent:n,startIndex:r,endIndex:o}=e;let i=n.child(r);let s=t.contentMatch.findWrapping(i.type);if(!s)return null;let a=s.length?s[s.length-1]:t;let l=a.contentMatch;for(let e=r;l&&e<o;e++)l=l.matchType(n.child(e).type);if(!l||!l.validEnd)return null;return s}function wrap(e,t,n){let r=Fragment.empty;for(let e=n.length-1;e>=0;e--){if(r.size){let t=n[e].type.contentMatch.matchFragment(r);if(!t||!t.validEnd)throw new RangeError("Wrapper type given to Transform.wrap does not form valid content of its parent wrapper")}r=Fragment.from(n[e].type.create(n[e].attrs,r))}let o=t.start,i=t.end;e.step(new ReplaceAroundStep(o,i,o,i,new Slice(r,0,0),n.length,true))}function setBlockType$1(e,t,n,r,o){if(!r.isTextblock)throw new RangeError("Type given to setBlockType should be a textblock");let i=e.steps.length;e.doc.nodesBetween(t,n,((t,n)=>{let s=typeof o=="function"?o(t):o;if(t.isTextblock&&!t.hasMarkup(r,s)&&canChangeType(e.doc,e.mapping.slice(i).map(n),r)){let o=null;if(r.schema.linebreakReplacement){let e=r.whitespace=="pre",t=!!r.contentMatch.matchType(r.schema.linebreakReplacement);if(e&&!t)o=false;else if(!e&&t)o=true}if(o===false)replaceLinebreaks(e,t,n,i);clearIncompatible(e,e.mapping.slice(i).map(n,1),r,undefined,o===null);let a=e.mapping.slice(i);let l=a.map(n,1),c=a.map(n+t.nodeSize,1);e.step(new ReplaceAroundStep(l,c,l+1,c-1,new Slice(Fragment.from(r.create(s,null,t.marks)),0,0),1,true));if(o===true)replaceNewlines(e,t,n,i);return false}}))}function replaceNewlines(e,t,n,r){t.forEach(((o,i)=>{if(o.isText){let s,a=/\r?\n|\r/g;while(s=a.exec(o.text)){let o=e.mapping.slice(r).map(n+1+i+s.index);e.replaceWith(o,o+1,t.type.schema.linebreakReplacement.create())}}}))}function replaceLinebreaks(e,t,n,r){t.forEach(((o,i)=>{if(o.type==o.type.schema.linebreakReplacement){let o=e.mapping.slice(r).map(n+1+i);e.replaceWith(o,o+1,t.type.schema.text("\n"))}}))}function canChangeType(e,t,n){let r=e.resolve(t),o=r.index();return r.parent.canReplaceWith(o,o+1,n)}function setNodeMarkup(e,t,n,r,o){let i=e.doc.nodeAt(t);if(!i)throw new RangeError("No node at given position");if(!n)n=i.type;let s=n.create(r,null,o||i.marks);if(i.isLeaf)return e.replaceWith(t,t+i.nodeSize,s);if(!n.validContent(i.content))throw new RangeError("Invalid content for node type "+n.name);e.step(new ReplaceAroundStep(t,t+i.nodeSize,t+1,t+i.nodeSize-1,new Slice(Fragment.from(s),0,0),1,true))}function canSplit(e,t,n=1,r){let o=e.resolve(t),i=o.depth-n;let s=r&&r[r.length-1]||o.parent;if(i<0||o.parent.type.spec.isolating||!o.parent.canReplace(o.index(),o.parent.childCount)||!s.type.validContent(o.parent.content.cutByIndex(o.index(),o.parent.childCount)))return false;for(let e=o.depth-1,t=n-2;e>i;e--,t--){let n=o.node(e),i=o.index(e);if(n.type.spec.isolating)return false;let s=n.content.cutByIndex(i,n.childCount);let a=r&&r[t+1];if(a)s=s.replaceChild(0,a.type.create(a.attrs));let l=r&&r[t]||n;if(!n.canReplace(i+1,n.childCount)||!l.type.validContent(s))return false}let a=o.indexAfter(i);let l=r&&r[0];return o.node(i).canReplaceWith(a,a,l?l.type:o.node(i+1).type)}function split(e,t,n=1,r){let o=e.doc.resolve(t),i=Fragment.empty,s=Fragment.empty;for(let e=o.depth,t=o.depth-n,a=n-1;e>t;e--,a--){i=Fragment.from(o.node(e).copy(i));let t=r&&r[a];s=Fragment.from(t?t.type.create(t.attrs,s):o.node(e).copy(s))}e.step(new ReplaceStep(t,t,new Slice(i.append(s),n,n),true))}function canJoin(e,t){let n=e.resolve(t),r=n.index();return joinable(n.nodeBefore,n.nodeAfter)&&n.parent.canReplace(r,r+1)}function joinable(e,t){return!!(e&&t&&!e.isLeaf&&e.canAppend(t))}function joinPoint(e,t,n=-1){let r=e.resolve(t);for(let e=r.depth;;e--){let o,i,s=r.index(e);if(e==r.depth){o=r.nodeBefore;i=r.nodeAfter}else if(n>0){o=r.node(e+1);s++;i=r.node(e).maybeChild(s)}else{o=r.node(e).maybeChild(s-1);i=r.node(e+1)}if(o&&!o.isTextblock&&joinable(o,i)&&r.node(e).canReplace(s,s+1))return t;if(e==0)break;t=n<0?r.before(e):r.after(e)}}function join(e,t,n){let r=new ReplaceStep(t-n,t+n,Slice.empty,true);e.step(r)}function insertPoint(e,t,n){let r=e.resolve(t);if(r.parent.canReplaceWith(r.index(),r.index(),n))return t;if(r.parentOffset==0)for(let e=r.depth-1;e>=0;e--){let t=r.index(e);if(r.node(e).canReplaceWith(t,t,n))return r.before(e+1);if(t>0)return null}if(r.parentOffset==r.parent.content.size)for(let e=r.depth-1;e>=0;e--){let t=r.indexAfter(e);if(r.node(e).canReplaceWith(t,t,n))return r.after(e+1);if(t<r.node(e).childCount)return null}return null}function dropPoint(e,t,n){let r=e.resolve(t);if(!n.content.size)return t;let o=n.content;for(let e=0;e<n.openStart;e++)o=o.firstChild.content;for(let e=1;e<=(n.openStart==0&&n.size?2:1);e++){for(let t=r.depth;t>=0;t--){let n=t==r.depth?0:r.pos<=(r.start(t+1)+r.end(t+1))/2?-1:1;let i=r.index(t)+(n>0?1:0);let s=r.node(t),a=false;if(e==1){a=s.canReplace(i,i,o)}else{let e=s.contentMatchAt(i).findWrapping(o.firstChild.type);a=e&&s.canReplaceWith(i,i,e[0])}if(a)return n==0?r.pos:n<0?r.before(t+1):r.after(t+1)}}return null}function replaceStep(e,t,n=t,r=Slice.empty){if(t==n&&!r.size)return null;let o=e.resolve(t),i=e.resolve(n);if(fitsTrivially(o,i,r))return new ReplaceStep(t,n,r);return new Fitter(o,i,r).fit()}function fitsTrivially(e,t,n){return!n.openStart&&!n.openEnd&&e.start()==t.start()&&e.parent.canReplace(e.index(),t.index(),n.content)}class Fitter{constructor(e,t,n){this.$from=e;this.$to=t;this.unplaced=n;this.frontier=[];this.placed=Fragment.empty;for(let t=0;t<=e.depth;t++){let n=e.node(t);this.frontier.push({type:n.type,match:n.contentMatchAt(e.indexAfter(t))})}for(let t=e.depth;t>0;t--)this.placed=Fragment.from(e.node(t).copy(this.placed))}get depth(){return this.frontier.length-1}fit(){while(this.unplaced.size){let e=this.findFittable();if(e)this.placeNodes(e);else this.openMore()||this.dropNode()}let e=this.mustMoveInline(),t=this.placed.size-this.depth-this.$from.depth;let n=this.$from,r=this.close(e<0?this.$to:n.doc.resolve(e));if(!r)return null;let o=this.placed,i=n.depth,s=r.depth;while(i&&s&&o.childCount==1){o=o.firstChild.content;i--;s--}let a=new Slice(o,i,s);if(e>-1)return new ReplaceAroundStep(n.pos,e,this.$to.pos,this.$to.end(),a,t);if(a.size||n.pos!=this.$to.pos)return new ReplaceStep(n.pos,r.pos,a);return null}findFittable(){let e=this.unplaced.openStart;for(let t=this.unplaced.content,n=0,r=this.unplaced.openEnd;n<e;n++){let o=t.firstChild;if(t.childCount>1)r=0;if(o.type.spec.isolating&&r<=n){e=n;break}t=o.content}for(let t=1;t<=2;t++){for(let n=t==1?e:this.unplaced.openStart;n>=0;n--){let e,r=null;if(n){r=contentAt(this.unplaced.content,n-1).firstChild;e=r.content}else{e=this.unplaced.content}let o=e.firstChild;for(let e=this.depth;e>=0;e--){let{type:i,match:s}=this.frontier[e],a,l=null;if(t==1&&(o?s.matchType(o.type)||(l=s.fillBefore(Fragment.from(o),false)):r&&i.compatibleContent(r.type)))return{sliceDepth:n,frontierDepth:e,parent:r,inject:l};else if(t==2&&o&&(a=s.findWrapping(o.type)))return{sliceDepth:n,frontierDepth:e,parent:r,wrap:a};if(r&&s.matchType(r.type))break}}}}openMore(){let{content:e,openStart:t,openEnd:n}=this.unplaced;let r=contentAt(e,t);if(!r.childCount||r.firstChild.isLeaf)return false;this.unplaced=new Slice(e,t+1,Math.max(n,r.size+t>=e.size-n?t+1:0));return true}dropNode(){let{content:e,openStart:t,openEnd:n}=this.unplaced;let r=contentAt(e,t);if(r.childCount<=1&&t>0){let o=e.size-t<=t+r.size;this.unplaced=new Slice(dropFromFragment(e,t-1,1),t-1,o?t-1:n)}else{this.unplaced=new Slice(dropFromFragment(e,t,1),t,n)}}placeNodes({sliceDepth:e,frontierDepth:t,parent:n,inject:r,wrap:o}){while(this.depth>t)this.closeFrontierNode();if(o)for(let e=0;e<o.length;e++)this.openFrontierNode(o[e]);let i=this.unplaced,s=n?n.content:i.content;let a=i.openStart-e;let l=0,c=[];let{match:d,type:u}=this.frontier[t];if(r){for(let e=0;e<r.childCount;e++)c.push(r.child(e));d=d.matchFragment(r)}let p=s.size+e-(i.content.size-i.openEnd);while(l<s.childCount){let e=s.child(l),t=d.matchType(e.type);if(!t)break;l++;if(l>1||a==0||e.content.size){d=t;c.push(closeNodeStart(e.mark(u.allowedMarks(e.marks)),l==1?a:0,l==s.childCount?p:-1))}}let f=l==s.childCount;if(!f)p=-1;this.placed=addToFragment(this.placed,t,Fragment.from(c));this.frontier[t].match=d;if(f&&p<0&&n&&n.type==this.frontier[this.depth].type&&this.frontier.length>1)this.closeFrontierNode();for(let e=0,t=s;e<p;e++){let e=t.lastChild;this.frontier.push({type:e.type,match:e.contentMatchAt(e.childCount)});t=e.content}this.unplaced=!f?new Slice(dropFromFragment(i.content,e,l),i.openStart,i.openEnd):e==0?Slice.empty:new Slice(dropFromFragment(i.content,e-1,1),e-1,p<0?i.openEnd:e-1)}mustMoveInline(){if(!this.$to.parent.isTextblock)return-1;let e=this.frontier[this.depth],t;if(!e.type.isTextblock||!contentAfterFits(this.$to,this.$to.depth,e.type,e.match,false)||this.$to.depth==this.depth&&(t=this.findCloseLevel(this.$to))&&t.depth==this.depth)return-1;let{depth:n}=this.$to,r=this.$to.after(n);while(n>1&&r==this.$to.end(--n))++r;return r}findCloseLevel(e){e:for(let t=Math.min(this.depth,e.depth);t>=0;t--){let{match:n,type:r}=this.frontier[t];let o=t<e.depth&&e.end(t+1)==e.pos+(e.depth-(t+1));let i=contentAfterFits(e,t,r,n,o);if(!i)continue;for(let n=t-1;n>=0;n--){let{match:t,type:r}=this.frontier[n];let o=contentAfterFits(e,n,r,t,true);if(!o||o.childCount)continue e}return{depth:t,fit:i,move:o?e.doc.resolve(e.after(t+1)):e}}}close(e){let t=this.findCloseLevel(e);if(!t)return null;while(this.depth>t.depth)this.closeFrontierNode();if(t.fit.childCount)this.placed=addToFragment(this.placed,t.depth,t.fit);e=t.move;for(let n=t.depth+1;n<=e.depth;n++){let t=e.node(n),r=t.type.contentMatch.fillBefore(t.content,true,e.index(n));this.openFrontierNode(t.type,t.attrs,r)}return e}openFrontierNode(e,t=null,n){let r=this.frontier[this.depth];r.match=r.match.matchType(e);this.placed=addToFragment(this.placed,this.depth,Fragment.from(e.create(t,n)));this.frontier.push({type:e,match:e.contentMatch})}closeFrontierNode(){let e=this.frontier.pop();let t=e.match.fillBefore(Fragment.empty,true);if(t.childCount)this.placed=addToFragment(this.placed,this.frontier.length,t)}}function dropFromFragment(e,t,n){if(t==0)return e.cutByIndex(n,e.childCount);return e.replaceChild(0,e.firstChild.copy(dropFromFragment(e.firstChild.content,t-1,n)))}function addToFragment(e,t,n){if(t==0)return e.append(n);return e.replaceChild(e.childCount-1,e.lastChild.copy(addToFragment(e.lastChild.content,t-1,n)))}function contentAt(e,t){for(let n=0;n<t;n++)e=e.firstChild.content;return e}function closeNodeStart(e,t,n){if(t<=0)return e;let r=e.content;if(t>1)r=r.replaceChild(0,closeNodeStart(r.firstChild,t-1,r.childCount==1?n-1:0));if(t>0){r=e.type.contentMatch.fillBefore(r).append(r);if(n<=0)r=r.append(e.type.contentMatch.matchFragment(r).fillBefore(Fragment.empty,true))}return e.copy(r)}function contentAfterFits(e,t,n,r,o){let i=e.node(t),s=o?e.indexAfter(t):e.index(t);if(s==i.childCount&&!n.compatibleContent(i.type))return null;let a=r.fillBefore(i.content,true,s);return a&&!invalidMarks(n,i.content,s)?a:null}function invalidMarks(e,t,n){for(let r=n;r<t.childCount;r++)if(!e.allowsMarks(t.child(r).marks))return true;return false}function definesContent(e){return e.spec.defining||e.spec.definingForContent}function replaceRange(e,t,n,r){if(!r.size)return e.deleteRange(t,n);let o=e.doc.resolve(t),i=e.doc.resolve(n);if(fitsTrivially(o,i,r))return e.step(new ReplaceStep(t,n,r));let s=coveredDepths(o,e.doc.resolve(n));if(s[s.length-1]==0)s.pop();let a=-(o.depth+1);s.unshift(a);for(let e=o.depth,t=o.pos-1;e>0;e--,t--){let n=o.node(e).type.spec;if(n.defining||n.definingAsContext||n.isolating)break;if(s.indexOf(e)>-1)a=e;else if(o.before(e)==t)s.splice(1,0,-e)}let l=s.indexOf(a);let c=[],d=r.openStart;for(let e=r.content,t=0;;t++){let n=e.firstChild;c.push(n);if(t==r.openStart)break;e=n.content}for(let e=d-1;e>=0;e--){let t=c[e],n=definesContent(t.type);if(n&&!t.sameMarkup(o.node(Math.abs(a)-1)))d=e;else if(n||!t.type.isTextblock)break}for(let t=r.openStart;t>=0;t--){let a=(t+d+1)%(r.openStart+1);let u=c[a];if(!u)continue;for(let t=0;t<s.length;t++){let c=s[(t+l)%s.length],d=true;if(c<0){d=false;c=-c}let p=o.node(c-1),f=o.index(c-1);if(p.canReplaceWith(f,f,u.type,u.marks))return e.replace(o.before(c),d?i.after(c):n,new Slice(closeFragment(r.content,0,r.openStart,a),a,r.openEnd))}}let u=e.steps.length;for(let a=s.length-1;a>=0;a--){e.replace(t,n,r);if(e.steps.length>u)break;let l=s[a];if(l<0)continue;t=o.before(l);n=i.after(l)}}function closeFragment(e,t,n,r,o){if(t<n){let o=e.firstChild;e=e.replaceChild(0,o.copy(closeFragment(o.content,t+1,n,r,o)))}if(t>r){let t=o.contentMatchAt(0);let n=t.fillBefore(e).append(e);e=n.append(t.matchFragment(n).fillBefore(Fragment.empty,true))}return e}function replaceRangeWith(e,t,n,r){if(!r.isInline&&t==n&&e.doc.resolve(t).parent.content.size){let o=insertPoint(e.doc,t,r.type);if(o!=null)t=n=o}e.replaceRange(t,n,new Slice(Fragment.from(r),0,0))}function deleteRange(e,t,n){let r=e.doc.resolve(t),o=e.doc.resolve(n);let i=coveredDepths(r,o);for(let t=0;t<i.length;t++){let n=i[t],s=t==i.length-1;if(s&&n==0||r.node(n).type.contentMatch.validEnd)return e.delete(r.start(n),o.end(n));if(n>0&&(s||r.node(n-1).canReplace(r.index(n-1),o.indexAfter(n-1))))return e.delete(r.before(n),o.after(n))}for(let i=1;i<=r.depth&&i<=o.depth;i++){if(t-r.start(i)==r.depth-i&&n>r.end(i)&&o.end(i)-n!=o.depth-i)return e.delete(r.before(i),n)}e.delete(t,n)}function coveredDepths(e,t){let n=[],r=Math.min(e.depth,t.depth);for(let o=r;o>=0;o--){let r=e.start(o);if(r<e.pos-(e.depth-o)||t.end(o)>t.pos+(t.depth-o)||e.node(o).type.spec.isolating||t.node(o).type.spec.isolating)break;if(r==t.start(o)||o==e.depth&&o==t.depth&&e.parent.inlineContent&&t.parent.inlineContent&&o&&t.start(o-1)==r-1)n.push(o)}return n}class AttrStep extends Step{constructor(e,t,n){super();this.pos=e;this.attr=t;this.value=n}apply(e){let t=e.nodeAt(this.pos);if(!t)return StepResult.fail("No node at attribute step's position");let n=Object.create(null);for(let e in t.attrs)n[e]=t.attrs[e];n[this.attr]=this.value;let r=t.type.create(n,null,t.marks);return StepResult.fromReplace(e,this.pos,this.pos+1,new Slice(Fragment.from(r),0,t.isLeaf?0:1))}getMap(){return StepMap.empty}invert(e){return new AttrStep(this.pos,this.attr,e.nodeAt(this.pos).attrs[this.attr])}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new AttrStep(t.pos,this.attr,this.value)}toJSON(){return{stepType:"attr",pos:this.pos,attr:this.attr,value:this.value}}static fromJSON(e,t){if(typeof t.pos!="number"||typeof t.attr!="string")throw new RangeError("Invalid input for AttrStep.fromJSON");return new AttrStep(t.pos,t.attr,t.value)}}Step.jsonID("attr",AttrStep);class DocAttrStep extends Step{constructor(e,t){super();this.attr=e;this.value=t}apply(e){let t=Object.create(null);for(let n in e.attrs)t[n]=e.attrs[n];t[this.attr]=this.value;let n=e.type.create(t,e.content,e.marks);return StepResult.ok(n)}getMap(){return StepMap.empty}invert(e){return new DocAttrStep(this.attr,e.attrs[this.attr])}map(e){return this}toJSON(){return{stepType:"docAttr",attr:this.attr,value:this.value}}static fromJSON(e,t){if(typeof t.attr!="string")throw new RangeError("Invalid input for DocAttrStep.fromJSON");return new DocAttrStep(t.attr,t.value)}}Step.jsonID("docAttr",DocAttrStep);let TransformError=class extends Error{};TransformError=function e(t){let n=Error.call(this,t);n.__proto__=e.prototype;return n};TransformError.prototype=Object.create(Error.prototype);TransformError.prototype.constructor=TransformError;TransformError.prototype.name="TransformError";class Transform{constructor(e){this.doc=e;this.steps=[];this.docs=[];this.mapping=new Mapping}get before(){return this.docs.length?this.docs[0]:this.doc}step(e){let t=this.maybeStep(e);if(t.failed)throw new TransformError(t.failed);return this}maybeStep(e){let t=e.apply(this.doc);if(!t.failed)this.addStep(e,t.doc);return t}get docChanged(){return this.steps.length>0}addStep(e,t){this.docs.push(this.doc);this.steps.push(e);this.mapping.appendMap(e.getMap());this.doc=t}replace(e,t=e,n=Slice.empty){let r=replaceStep(this.doc,e,t,n);if(r)this.step(r);return this}replaceWith(e,t,n){return this.replace(e,t,new Slice(Fragment.from(n),0,0))}delete(e,t){return this.replace(e,t,Slice.empty)}insert(e,t){return this.replaceWith(e,e,t)}replaceRange(e,t,n){replaceRange(this,e,t,n);return this}replaceRangeWith(e,t,n){replaceRangeWith(this,e,t,n);return this}deleteRange(e,t){deleteRange(this,e,t);return this}lift(e,t){lift$1(this,e,t);return this}join(e,t=1){join(this,e,t);return this}wrap(e,t){wrap(this,e,t);return this}setBlockType(e,t=e,n,r=null){setBlockType$1(this,e,t,n,r);return this}setNodeMarkup(e,t,n=null,r){setNodeMarkup(this,e,t,n,r);return this}setNodeAttribute(e,t,n){this.step(new AttrStep(e,t,n));return this}setDocAttribute(e,t){this.step(new DocAttrStep(e,t));return this}addNodeMark(e,t){this.step(new AddNodeMarkStep(e,t));return this}removeNodeMark(e,t){if(!(t instanceof Mark)){let n=this.doc.nodeAt(e);if(!n)throw new RangeError("No node at position "+e);t=t.isInSet(n.marks);if(!t)return this}this.step(new RemoveNodeMarkStep(e,t));return this}split(e,t=1,n){split(this,e,t,n);return this}addMark(e,t,n){addMark(this,e,t,n);return this}removeMark(e,t,n){removeMark(this,e,t,n);return this}clearIncompatible(e,t,n){clearIncompatible(this,e,t,n);return this}}const classesById=Object.create(null);class Selection{constructor(e,t,n){this.$anchor=e;this.$head=t;this.ranges=n||[new SelectionRange(e.min(t),e.max(t))]}get anchor(){return this.$anchor.pos}get head(){return this.$head.pos}get from(){return this.$from.pos}get to(){return this.$to.pos}get $from(){return this.ranges[0].$from}get $to(){return this.ranges[0].$to}get empty(){let e=this.ranges;for(let t=0;t<e.length;t++)if(e[t].$from.pos!=e[t].$to.pos)return false;return true}content(){return this.$from.doc.slice(this.from,this.to,true)}replace(e,t=Slice.empty){let n=t.content.lastChild,r=null;for(let e=0;e<t.openEnd;e++){r=n;n=n.lastChild}let o=e.steps.length,i=this.ranges;for(let s=0;s<i.length;s++){let{$from:a,$to:l}=i[s],c=e.mapping.slice(o);e.replaceRange(c.map(a.pos),c.map(l.pos),s?Slice.empty:t);if(s==0)selectionToInsertionEnd(e,o,(n?n.isInline:r&&r.isTextblock)?-1:1)}}replaceWith(e,t){let n=e.steps.length,r=this.ranges;for(let o=0;o<r.length;o++){let{$from:i,$to:s}=r[o],a=e.mapping.slice(n);let l=a.map(i.pos),c=a.map(s.pos);if(o){e.deleteRange(l,c)}else{e.replaceRangeWith(l,c,t);selectionToInsertionEnd(e,n,t.isInline?-1:1)}}}static findFrom(e,t,n=false){let r=e.parent.inlineContent?new TextSelection(e):findSelectionIn(e.node(0),e.parent,e.pos,e.index(),t,n);if(r)return r;for(let r=e.depth-1;r>=0;r--){let o=t<0?findSelectionIn(e.node(0),e.node(r),e.before(r+1),e.index(r),t,n):findSelectionIn(e.node(0),e.node(r),e.after(r+1),e.index(r)+1,t,n);if(o)return o}return null}static near(e,t=1){return this.findFrom(e,t)||this.findFrom(e,-t)||new AllSelection(e.node(0))}static atStart(e){return findSelectionIn(e,e,0,0,1)||new AllSelection(e)}static atEnd(e){return findSelectionIn(e,e,e.content.size,e.childCount,-1)||new AllSelection(e)}static fromJSON(e,t){if(!t||!t.type)throw new RangeError("Invalid input for Selection.fromJSON");let n=classesById[t.type];if(!n)throw new RangeError(`No selection type ${t.type} defined`);return n.fromJSON(e,t)}static jsonID(e,t){if(e in classesById)throw new RangeError("Duplicate use of selection JSON ID "+e);classesById[e]=t;t.prototype.jsonID=e;return t}getBookmark(){return TextSelection.between(this.$anchor,this.$head).getBookmark()}}Selection.prototype.visible=true;class SelectionRange{constructor(e,t){this.$from=e;this.$to=t}}let warnedAboutTextSelection=false;function checkTextSelection(e){if(!warnedAboutTextSelection&&!e.parent.inlineContent){warnedAboutTextSelection=true;console["warn"]("TextSelection endpoint not pointing into a node with inline content ("+e.parent.type.name+")")}}class TextSelection extends Selection{constructor(e,t=e){checkTextSelection(e);checkTextSelection(t);super(e,t)}get $cursor(){return this.$anchor.pos==this.$head.pos?this.$head:null}map(e,t){let n=e.resolve(t.map(this.head));if(!n.parent.inlineContent)return Selection.near(n);let r=e.resolve(t.map(this.anchor));return new TextSelection(r.parent.inlineContent?r:n,n)}replace(e,t=Slice.empty){super.replace(e,t);if(t==Slice.empty){let t=this.$from.marksAcross(this.$to);if(t)e.ensureMarks(t)}}eq(e){return e instanceof TextSelection&&e.anchor==this.anchor&&e.head==this.head}getBookmark(){return new TextBookmark(this.anchor,this.head)}toJSON(){return{type:"text",anchor:this.anchor,head:this.head}}static fromJSON(e,t){if(typeof t.anchor!="number"||typeof t.head!="number")throw new RangeError("Invalid input for TextSelection.fromJSON");return new TextSelection(e.resolve(t.anchor),e.resolve(t.head))}static create(e,t,n=t){let r=e.resolve(t);return new this(r,n==t?r:e.resolve(n))}static between(e,t,n){let r=e.pos-t.pos;if(!n||r)n=r>=0?1:-1;if(!t.parent.inlineContent){let e=Selection.findFrom(t,n,true)||Selection.findFrom(t,-n,true);if(e)t=e.$head;else return Selection.near(t,n)}if(!e.parent.inlineContent){if(r==0){e=t}else{e=(Selection.findFrom(e,-n,true)||Selection.findFrom(e,n,true)).$anchor;if(e.pos<t.pos!=r<0)e=t}}return new TextSelection(e,t)}}Selection.jsonID("text",TextSelection);class TextBookmark{constructor(e,t){this.anchor=e;this.head=t}map(e){return new TextBookmark(e.map(this.anchor),e.map(this.head))}resolve(e){return TextSelection.between(e.resolve(this.anchor),e.resolve(this.head))}}class NodeSelection extends Selection{constructor(e){let t=e.nodeAfter;let n=e.node(0).resolve(e.pos+t.nodeSize);super(e,n);this.node=t}map(e,t){let{deleted:n,pos:r}=t.mapResult(this.anchor);let o=e.resolve(r);if(n)return Selection.near(o);return new NodeSelection(o)}content(){return new Slice(Fragment.from(this.node),0,0)}eq(e){return e instanceof NodeSelection&&e.anchor==this.anchor}toJSON(){return{type:"node",anchor:this.anchor}}getBookmark(){return new NodeBookmark(this.anchor)}static fromJSON(e,t){if(typeof t.anchor!="number")throw new RangeError("Invalid input for NodeSelection.fromJSON");return new NodeSelection(e.resolve(t.anchor))}static create(e,t){return new NodeSelection(e.resolve(t))}static isSelectable(e){return!e.isText&&e.type.spec.selectable!==false}}NodeSelection.prototype.visible=false;Selection.jsonID("node",NodeSelection);class NodeBookmark{constructor(e){this.anchor=e}map(e){let{deleted:t,pos:n}=e.mapResult(this.anchor);return t?new TextBookmark(n,n):new NodeBookmark(n)}resolve(e){let t=e.resolve(this.anchor),n=t.nodeAfter;if(n&&NodeSelection.isSelectable(n))return new NodeSelection(t);return Selection.near(t)}}class AllSelection extends Selection{constructor(e){super(e.resolve(0),e.resolve(e.content.size))}replace(e,t=Slice.empty){if(t==Slice.empty){e.delete(0,e.doc.content.size);let t=Selection.atStart(e.doc);if(!t.eq(e.selection))e.setSelection(t)}else{super.replace(e,t)}}toJSON(){return{type:"all"}}static fromJSON(e){return new AllSelection(e)}map(e){return new AllSelection(e)}eq(e){return e instanceof AllSelection}getBookmark(){return AllBookmark}}Selection.jsonID("all",AllSelection);const AllBookmark={map(){return this},resolve(e){return new AllSelection(e)}};function findSelectionIn(e,t,n,r,o,i=false){if(t.inlineContent)return TextSelection.create(e,n);for(let s=r-(o>0?0:1);o>0?s<t.childCount:s>=0;s+=o){let r=t.child(s);if(!r.isAtom){let t=findSelectionIn(e,r,n+o,o<0?r.childCount:0,o,i);if(t)return t}else if(!i&&NodeSelection.isSelectable(r)){return NodeSelection.create(e,n-(o<0?r.nodeSize:0))}n+=r.nodeSize*o}return null}function selectionToInsertionEnd(e,t,n){let r=e.steps.length-1;if(r<t)return;let o=e.steps[r];if(!(o instanceof ReplaceStep||o instanceof ReplaceAroundStep))return;let i=e.mapping.maps[r],s;i.forEach(((e,t,n,r)=>{if(s==null)s=r}));e.setSelection(Selection.near(e.doc.resolve(s),n))}const UPDATED_SEL=1,UPDATED_MARKS=2,UPDATED_SCROLL=4;class Transaction extends Transform{constructor(e){super(e.doc);this.curSelectionFor=0;this.updated=0;this.meta=Object.create(null);this.time=Date.now();this.curSelection=e.selection;this.storedMarks=e.storedMarks}get selection(){if(this.curSelectionFor<this.steps.length){this.curSelection=this.curSelection.map(this.doc,this.mapping.slice(this.curSelectionFor));this.curSelectionFor=this.steps.length}return this.curSelection}setSelection(e){if(e.$from.doc!=this.doc)throw new RangeError("Selection passed to setSelection must point at the current document");this.curSelection=e;this.curSelectionFor=this.steps.length;this.updated=(this.updated|UPDATED_SEL)&~UPDATED_MARKS;this.storedMarks=null;return this}get selectionSet(){return(this.updated&UPDATED_SEL)>0}setStoredMarks(e){this.storedMarks=e;this.updated|=UPDATED_MARKS;return this}ensureMarks(e){if(!Mark.sameSet(this.storedMarks||this.selection.$from.marks(),e))this.setStoredMarks(e);return this}addStoredMark(e){return this.ensureMarks(e.addToSet(this.storedMarks||this.selection.$head.marks()))}removeStoredMark(e){return this.ensureMarks(e.removeFromSet(this.storedMarks||this.selection.$head.marks()))}get storedMarksSet(){return(this.updated&UPDATED_MARKS)>0}addStep(e,t){super.addStep(e,t);this.updated=this.updated&~UPDATED_MARKS;this.storedMarks=null}setTime(e){this.time=e;return this}replaceSelection(e){this.selection.replace(this,e);return this}replaceSelectionWith(e,t=true){let n=this.selection;if(t)e=e.mark(this.storedMarks||(n.empty?n.$from.marks():n.$from.marksAcross(n.$to)||Mark.none));n.replaceWith(this,e);return this}deleteSelection(){this.selection.replace(this);return this}insertText(e,t,n){let r=this.doc.type.schema;if(t==null){if(!e)return this.deleteSelection();return this.replaceSelectionWith(r.text(e),true)}else{if(n==null)n=t;n=n==null?t:n;if(!e)return this.deleteRange(t,n);let o=this.storedMarks;if(!o){let e=this.doc.resolve(t);o=n==t?e.marks():e.marksAcross(this.doc.resolve(n))}this.replaceRangeWith(t,n,r.text(e,o));if(!this.selection.empty)this.setSelection(Selection.near(this.selection.$to));return this}}setMeta(e,t){this.meta[typeof e=="string"?e:e.key]=t;return this}getMeta(e){return this.meta[typeof e=="string"?e:e.key]}get isGeneric(){for(let e in this.meta)return false;return true}scrollIntoView(){this.updated|=UPDATED_SCROLL;return this}get scrolledIntoView(){return(this.updated&UPDATED_SCROLL)>0}}function bind(e,t){return!t||!e?e:e.bind(t)}class FieldDesc{constructor(e,t,n){this.name=e;this.init=bind(t.init,n);this.apply=bind(t.apply,n)}}const baseFields=[new FieldDesc("doc",{init(e){return e.doc||e.schema.topNodeType.createAndFill()},apply(e){return e.doc}}),new FieldDesc("selection",{init(e,t){return e.selection||Selection.atStart(t.doc)},apply(e){return e.selection}}),new FieldDesc("storedMarks",{init(e){return e.storedMarks||null},apply(e,t,n,r){return r.selection.$cursor?e.storedMarks:null}}),new FieldDesc("scrollToSelection",{init(){return 0},apply(e,t){return e.scrolledIntoView?t+1:t}})];class Configuration{constructor(e,t){this.schema=e;this.plugins=[];this.pluginsByKey=Object.create(null);this.fields=baseFields.slice();if(t)t.forEach((e=>{if(this.pluginsByKey[e.key])throw new RangeError("Adding different instances of a keyed plugin ("+e.key+")");this.plugins.push(e);this.pluginsByKey[e.key]=e;if(e.spec.state)this.fields.push(new FieldDesc(e.key,e.spec.state,e))}))}}class EditorState{constructor(e){this.config=e}get schema(){return this.config.schema}get plugins(){return this.config.plugins}apply(e){return this.applyTransaction(e).state}filterTransaction(e,t=-1){for(let n=0;n<this.config.plugins.length;n++)if(n!=t){let t=this.config.plugins[n];if(t.spec.filterTransaction&&!t.spec.filterTransaction.call(t,e,this))return false}return true}applyTransaction(e){if(!this.filterTransaction(e))return{state:this,transactions:[]};let t=[e],n=this.applyInner(e),r=null;for(;;){let o=false;for(let i=0;i<this.config.plugins.length;i++){let s=this.config.plugins[i];if(s.spec.appendTransaction){let a=r?r[i].n:0,l=r?r[i].state:this;let c=a<t.length&&s.spec.appendTransaction.call(s,a?t.slice(a):t,l,n);if(c&&n.filterTransaction(c,i)){c.setMeta("appendedTransaction",e);if(!r){r=[];for(let e=0;e<this.config.plugins.length;e++)r.push(e<i?{state:n,n:t.length}:{state:this,n:0})}t.push(c);n=n.applyInner(c);o=true}if(r)r[i]={state:n,n:t.length}}}if(!o)return{state:n,transactions:t}}}applyInner(e){if(!e.before.eq(this.doc))throw new RangeError("Applying a mismatched transaction");let t=new EditorState(this.config),n=this.config.fields;for(let r=0;r<n.length;r++){let o=n[r];t[o.name]=o.apply(e,this[o.name],this,t)}return t}get tr(){return new Transaction(this)}static create(e){let t=new Configuration(e.doc?e.doc.type.schema:e.schema,e.plugins);let n=new EditorState(t);for(let r=0;r<t.fields.length;r++)n[t.fields[r].name]=t.fields[r].init(e,n);return n}reconfigure(e){let t=new Configuration(this.schema,e.plugins);let n=t.fields,r=new EditorState(t);for(let t=0;t<n.length;t++){let o=n[t].name;r[o]=this.hasOwnProperty(o)?this[o]:n[t].init(e,r)}return r}toJSON(e){let t={doc:this.doc.toJSON(),selection:this.selection.toJSON()};if(this.storedMarks)t.storedMarks=this.storedMarks.map((e=>e.toJSON()));if(e&&typeof e=="object")for(let n in e){if(n=="doc"||n=="selection")throw new RangeError("The JSON fields `doc` and `selection` are reserved");let r=e[n],o=r.spec.state;if(o&&o.toJSON)t[n]=o.toJSON.call(r,this[r.key])}return t}static fromJSON(e,t,n){if(!t)throw new RangeError("Invalid input for EditorState.fromJSON");if(!e.schema)throw new RangeError("Required config field 'schema' missing");let r=new Configuration(e.schema,e.plugins);let o=new EditorState(r);r.fields.forEach((r=>{if(r.name=="doc"){o.doc=Node$1.fromJSON(e.schema,t.doc)}else if(r.name=="selection"){o.selection=Selection.fromJSON(o.doc,t.selection)}else if(r.name=="storedMarks"){if(t.storedMarks)o.storedMarks=t.storedMarks.map(e.schema.markFromJSON)}else{if(n)for(let i in n){let s=n[i],a=s.spec.state;if(s.key==r.name&&a&&a.fromJSON&&Object.prototype.hasOwnProperty.call(t,i)){o[r.name]=a.fromJSON.call(s,e,t[i],o);return}}o[r.name]=r.init(e,o)}}));return o}}function bindProps(e,t,n){for(let r in e){let o=e[r];if(o instanceof Function)o=o.bind(t);else if(r=="handleDOMEvents")o=bindProps(o,t,{});n[r]=o}return n}class Plugin{constructor(e){this.spec=e;this.props={};if(e.props)bindProps(e.props,this,this.props);this.key=e.key?e.key.key:createKey("plugin")}getState(e){return e[this.key]}}const keys=Object.create(null);function createKey(e){if(e in keys)return e+"$"+ ++keys[e];keys[e]=0;return e+"$"}class PluginKey{constructor(e="key"){this.key=createKey(e)}get(e){return e.config.pluginsByKey[this.key]}getState(e){return e[this.key]}}const domIndex=function(e){for(var t=0;;t++){e=e.previousSibling;if(!e)return t}};const parentNode=function(e){let t=e.assignedSlot||e.parentNode;return t&&t.nodeType==11?t.host:t};let reusedRange=null;const textRange$1=function(e,t,n){let r=reusedRange||(reusedRange=document.createRange());r.setEnd(e,n==null?e.nodeValue.length:n);r.setStart(e,t||0);return r};const clearReusedRange=function(){reusedRange=null};const isEquivalentPosition=function(e,t,n,r){return n&&(scanFor(e,t,n,r,-1)||scanFor(e,t,n,r,1))};const atomElements=/^(img|br|input|textarea|hr)$/i;function scanFor(e,t,n,r,o){for(;;){if(e==n&&t==r)return true;if(t==(o<0?0:nodeSize(e))){let n=e.parentNode;if(!n||n.nodeType!=1||hasBlockDesc(e)||atomElements.test(e.nodeName)||e.contentEditable=="false")return false;t=domIndex(e)+(o<0?0:1);e=n}else if(e.nodeType==1){e=e.childNodes[t+(o<0?-1:0)];if(e.contentEditable=="false")return false;t=o<0?nodeSize(e):0}else{return false}}}function nodeSize(e){return e.nodeType==3?e.nodeValue.length:e.childNodes.length}function textNodeBefore$1(e,t){for(;;){if(e.nodeType==3&&t)return e;if(e.nodeType==1&&t>0){if(e.contentEditable=="false")return null;e=e.childNodes[t-1];t=nodeSize(e)}else if(e.parentNode&&!hasBlockDesc(e)){t=domIndex(e);e=e.parentNode}else{return null}}}function textNodeAfter$1(e,t){for(;;){if(e.nodeType==3&&t<e.nodeValue.length)return e;if(e.nodeType==1&&t<e.childNodes.length){if(e.contentEditable=="false")return null;e=e.childNodes[t];t=0}else if(e.parentNode&&!hasBlockDesc(e)){t=domIndex(e)+1;e=e.parentNode}else{return null}}}function isOnEdge(e,t,n){for(let r=t==0,o=t==nodeSize(e);r||o;){if(e==n)return true;let t=domIndex(e);e=e.parentNode;if(!e)return false;r=r&&t==0;o=o&&t==nodeSize(e)}}function hasBlockDesc(e){let t;for(let n=e;n;n=n.parentNode)if(t=n.pmViewDesc)break;return t&&t.node&&t.node.isBlock&&(t.dom==e||t.contentDOM==e)}const selectionCollapsed=function(e){return e.focusNode&&isEquivalentPosition(e.focusNode,e.focusOffset,e.anchorNode,e.anchorOffset)};function keyEvent(e,t){let n=document.createEvent("Event");n.initEvent("keydown",true,true);n.keyCode=e;n.key=n.code=t;return n}function deepActiveElement(e){let t=e.activeElement;while(t&&t.shadowRoot)t=t.shadowRoot.activeElement;return t}function caretFromPoint(e,t,n){if(e.caretPositionFromPoint){try{let r=e.caretPositionFromPoint(t,n);if(r)return{node:r.offsetNode,offset:r.offset}}catch(e){}}if(e.caretRangeFromPoint){let r=e.caretRangeFromPoint(t,n);if(r)return{node:r.startContainer,offset:r.startOffset}}}const nav=typeof navigator!="undefined"?navigator:null;const doc=typeof document!="undefined"?document:null;const agent=nav&&nav.userAgent||"";const ie_edge=/Edge\/(\d+)/.exec(agent);const ie_upto10=/MSIE \d/.exec(agent);const ie_11up=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(agent);const ie$1=!!(ie_upto10||ie_11up||ie_edge);const ie_version=ie_upto10?document.documentMode:ie_11up?+ie_11up[1]:ie_edge?+ie_edge[1]:0;const gecko=!ie$1&&/gecko\/(\d+)/i.test(agent);gecko&&+(/Firefox\/(\d+)/.exec(agent)||[0,0])[1];const _chrome=!ie$1&&/Chrome\/(\d+)/.exec(agent);const chrome=!!_chrome;const chrome_version=_chrome?+_chrome[1]:0;const safari=!ie$1&&!!nav&&/Apple Computer/.test(nav.vendor);const ios=safari&&(/Mobile\/\w+/.test(agent)||!!nav&&nav.maxTouchPoints>2);const mac$4=ios||(nav?/Mac/.test(nav.platform):false);const windows=nav?/Win/.test(nav.platform):false;const android=/Android \d/.test(agent);const webkit=!!doc&&"webkitFontSmoothing"in doc.documentElement.style;const webkit_version=webkit?+(/\bAppleWebKit\/(\d+)/.exec(navigator.userAgent)||[0,0])[1]:0;function windowRect(e){let t=e.defaultView&&e.defaultView.visualViewport;if(t)return{left:0,right:t.width,top:0,bottom:t.height};return{left:0,right:e.documentElement.clientWidth,top:0,bottom:e.documentElement.clientHeight}}function getSide(e,t){return typeof e=="number"?e:e[t]}function clientRect(e){let t=e.getBoundingClientRect();let n=t.width/e.offsetWidth||1;let r=t.height/e.offsetHeight||1;return{left:t.left,right:t.left+e.clientWidth*n,top:t.top,bottom:t.top+e.clientHeight*r}}function scrollRectIntoView(e,t,n){let r=e.someProp("scrollThreshold")||0,o=e.someProp("scrollMargin")||5;let i=e.dom.ownerDocument;for(let s=n||e.dom;;s=parentNode(s)){if(!s)break;if(s.nodeType!=1)continue;let e=s;let n=e==i.body;let a=n?windowRect(i):clientRect(e);let l=0,c=0;if(t.top<a.top+getSide(r,"top"))c=-(a.top-t.top+getSide(o,"top"));else if(t.bottom>a.bottom-getSide(r,"bottom"))c=t.bottom-t.top>a.bottom-a.top?t.top+getSide(o,"top")-a.top:t.bottom-a.bottom+getSide(o,"bottom");if(t.left<a.left+getSide(r,"left"))l=-(a.left-t.left+getSide(o,"left"));else if(t.right>a.right-getSide(r,"right"))l=t.right-a.right+getSide(o,"right");if(l||c){if(n){i.defaultView.scrollBy(l,c)}else{let n=e.scrollLeft,r=e.scrollTop;if(c)e.scrollTop+=c;if(l)e.scrollLeft+=l;let o=e.scrollLeft-n,i=e.scrollTop-r;t={left:t.left-o,top:t.top-i,right:t.right-o,bottom:t.bottom-i}}}if(n||/^(fixed|sticky)$/.test(getComputedStyle(s).position))break}}function storeScrollPos(e){let t=e.dom.getBoundingClientRect(),n=Math.max(0,t.top);let r,o;for(let i=(t.left+t.right)/2,s=n+1;s<Math.min(innerHeight,t.bottom);s+=5){let t=e.root.elementFromPoint(i,s);if(!t||t==e.dom||!e.dom.contains(t))continue;let a=t.getBoundingClientRect();if(a.top>=n-20){r=t;o=a.top;break}}return{refDOM:r,refTop:o,stack:scrollStack(e.dom)}}function scrollStack(e){let t=[],n=e.ownerDocument;for(let r=e;r;r=parentNode(r)){t.push({dom:r,top:r.scrollTop,left:r.scrollLeft});if(e==n)break}return t}function resetScrollPos({refDOM:e,refTop:t,stack:n}){let r=e?e.getBoundingClientRect().top:0;restoreScrollStack(n,r==0?0:r-t)}function restoreScrollStack(e,t){for(let n=0;n<e.length;n++){let{dom:r,top:o,left:i}=e[n];if(r.scrollTop!=o+t)r.scrollTop=o+t;if(r.scrollLeft!=i)r.scrollLeft=i}}let preventScrollSupported=null;function focusPreventScroll(e){if(e.setActive)return e.setActive();if(preventScrollSupported)return e.focus(preventScrollSupported);let t=scrollStack(e);e.focus(preventScrollSupported==null?{get preventScroll(){preventScrollSupported={preventScroll:true};return true}}:undefined);if(!preventScrollSupported){preventScrollSupported=false;restoreScrollStack(t,0)}}function findOffsetInNode(e,t){let n,r=2e8,o,i=0;let s=t.top,a=t.top;let l,c;for(let d=e.firstChild,u=0;d;d=d.nextSibling,u++){let e;if(d.nodeType==1)e=d.getClientRects();else if(d.nodeType==3)e=textRange$1(d).getClientRects();else continue;for(let p=0;p<e.length;p++){let f=e[p];if(f.top<=s&&f.bottom>=a){s=Math.max(f.bottom,s);a=Math.min(f.top,a);let e=f.left>t.left?f.left-t.left:f.right<t.left?t.left-f.right:0;if(e<r){n=d;r=e;o=e&&n.nodeType==3?{left:f.right<t.left?f.right:f.left,top:t.top}:t;if(d.nodeType==1&&e)i=u+(t.left>=(f.left+f.right)/2?1:0);continue}}else if(f.top>t.top&&!l&&f.left<=t.left&&f.right>=t.left){l=d;c={left:Math.max(f.left,Math.min(f.right,t.left)),top:f.top}}if(!n&&(t.left>=f.right&&t.top>=f.top||t.left>=f.left&&t.top>=f.bottom))i=u+1}}if(!n&&l){n=l;o=c;r=0}if(n&&n.nodeType==3)return findOffsetInText(n,o);if(!n||r&&n.nodeType==1)return{node:e,offset:i};return findOffsetInNode(n,o)}function findOffsetInText(e,t){let n=e.nodeValue.length;let r=document.createRange();for(let o=0;o<n;o++){r.setEnd(e,o+1);r.setStart(e,o);let n=singleRect(r,1);if(n.top==n.bottom)continue;if(inRect(t,n))return{node:e,offset:o+(t.left>=(n.left+n.right)/2?1:0)}}return{node:e,offset:0}}function inRect(e,t){return e.left>=t.left-1&&e.left<=t.right+1&&e.top>=t.top-1&&e.top<=t.bottom+1}function targetKludge(e,t){let n=e.parentNode;if(n&&/^li$/i.test(n.nodeName)&&t.left<e.getBoundingClientRect().left)return n;return e}function posFromElement(e,t,n){let{node:r,offset:o}=findOffsetInNode(t,n),i=-1;if(r.nodeType==1&&!r.firstChild){let e=r.getBoundingClientRect();i=e.left!=e.right&&n.left>(e.left+e.right)/2?1:-1}return e.docView.posFromDOM(r,o,i)}function posFromCaret(e,t,n,r){let o=-1;for(let n=t,i=false;;){if(n==e.dom)break;let t=e.docView.nearestDesc(n,true);if(!t)return null;if(t.dom.nodeType==1&&(t.node.isBlock&&t.parent||!t.contentDOM)){let e=t.dom.getBoundingClientRect();if(t.node.isBlock&&t.parent){if(!i&&e.left>r.left||e.top>r.top)o=t.posBefore;else if(!i&&e.right<r.left||e.bottom<r.top)o=t.posAfter;i=true}if(!t.contentDOM&&o<0&&!t.node.isText){let n=t.node.isBlock?r.top<(e.top+e.bottom)/2:r.left<(e.left+e.right)/2;return n?t.posBefore:t.posAfter}}n=t.dom.parentNode}return o>-1?o:e.docView.posFromDOM(t,n,-1)}function elementFromPoint(e,t,n){let r=e.childNodes.length;if(r&&n.top<n.bottom){for(let o=Math.max(0,Math.min(r-1,Math.floor(r*(t.top-n.top)/(n.bottom-n.top))-2)),i=o;;){let n=e.childNodes[i];if(n.nodeType==1){let e=n.getClientRects();for(let r=0;r<e.length;r++){let o=e[r];if(inRect(t,o))return elementFromPoint(n,t,o)}}if((i=(i+1)%r)==o)break}}return e}function posAtCoords(e,t){let n=e.dom.ownerDocument,r,o=0;let i=caretFromPoint(n,t.left,t.top);if(i)({node:r,offset:o}=i);let s=(e.root.elementFromPoint?e.root:n).elementFromPoint(t.left,t.top);let a;if(!s||!e.dom.contains(s.nodeType!=1?s.parentNode:s)){let n=e.dom.getBoundingClientRect();if(!inRect(t,n))return null;s=elementFromPoint(e.dom,t,n);if(!s)return null}if(safari){for(let e=s;r&&e;e=parentNode(e))if(e.draggable)r=undefined}s=targetKludge(s,t);if(r){if(gecko&&r.nodeType==1){o=Math.min(o,r.childNodes.length);if(o<r.childNodes.length){let e=r.childNodes[o],n;if(e.nodeName=="IMG"&&(n=e.getBoundingClientRect()).right<=t.left&&n.bottom>t.top)o++}}let n;if(webkit&&o&&r.nodeType==1&&(n=r.childNodes[o-1]).nodeType==1&&n.contentEditable=="false"&&n.getBoundingClientRect().top>=t.top)o--;if(r==e.dom&&o==r.childNodes.length-1&&r.lastChild.nodeType==1&&t.top>r.lastChild.getBoundingClientRect().bottom)a=e.state.doc.content.size;else if(o==0||r.nodeType!=1||r.childNodes[o-1].nodeName!="BR")a=posFromCaret(e,r,o,t)}if(a==null)a=posFromElement(e,s,t);let l=e.docView.nearestDesc(s,true);return{pos:a,inside:l?l.posAtStart-l.border:-1}}function nonZero(e){return e.top<e.bottom||e.left<e.right}function singleRect(e,t){let n=e.getClientRects();if(n.length){let e=n[t<0?0:n.length-1];if(nonZero(e))return e}return Array.prototype.find.call(n,nonZero)||e.getBoundingClientRect()}const BIDI=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/;function coordsAtPos(e,t,n){let{node:r,offset:o,atom:i}=e.docView.domFromPos(t,n<0?-1:1);let s=webkit||gecko;if(r.nodeType==3){if(s&&(BIDI.test(r.nodeValue)||(n<0?!o:o==r.nodeValue.length))){let e=singleRect(textRange$1(r,o,o),n);if(gecko&&o&&/\s/.test(r.nodeValue[o-1])&&o<r.nodeValue.length){let t=singleRect(textRange$1(r,o-1,o-1),-1);if(t.top==e.top){let n=singleRect(textRange$1(r,o,o+1),-1);if(n.top!=e.top)return flattenV(n,n.left<t.left)}}return e}else{let e=o,t=o,i=n<0?1:-1;if(n<0&&!o){t++;i=-1}else if(n>=0&&o==r.nodeValue.length){e--;i=1}else if(n<0){e--}else{t++}return flattenV(singleRect(textRange$1(r,e,t),i),i<0)}}let a=e.state.doc.resolve(t-(i||0));if(!a.parent.inlineContent){if(i==null&&o&&(n<0||o==nodeSize(r))){let e=r.childNodes[o-1];if(e.nodeType==1)return flattenH(e.getBoundingClientRect(),false)}if(i==null&&o<nodeSize(r)){let e=r.childNodes[o];if(e.nodeType==1)return flattenH(e.getBoundingClientRect(),true)}return flattenH(r.getBoundingClientRect(),n>=0)}if(i==null&&o&&(n<0||o==nodeSize(r))){let e=r.childNodes[o-1];let t=e.nodeType==3?textRange$1(e,nodeSize(e)-(s?0:1)):e.nodeType==1&&(e.nodeName!="BR"||!e.nextSibling)?e:null;if(t)return flattenV(singleRect(t,1),false)}if(i==null&&o<nodeSize(r)){let e=r.childNodes[o];while(e.pmViewDesc&&e.pmViewDesc.ignoreForCoords)e=e.nextSibling;let t=!e?null:e.nodeType==3?textRange$1(e,0,s?0:1):e.nodeType==1?e:null;if(t)return flattenV(singleRect(t,-1),true)}return flattenV(singleRect(r.nodeType==3?textRange$1(r):r,-n),n>=0)}function flattenV(e,t){if(e.width==0)return e;let n=t?e.left:e.right;return{top:e.top,bottom:e.bottom,left:n,right:n}}function flattenH(e,t){if(e.height==0)return e;let n=t?e.top:e.bottom;return{top:n,bottom:n,left:e.left,right:e.right}}function withFlushedState(e,t,n){let r=e.state,o=e.root.activeElement;if(r!=t)e.updateState(t);if(o!=e.dom)e.focus();try{return n()}finally{if(r!=t)e.updateState(r);if(o!=e.dom&&o)o.focus()}}function endOfTextblockVertical(e,t,n){let r=t.selection;let o=n=="up"?r.$from:r.$to;return withFlushedState(e,t,(()=>{let{node:t}=e.docView.domFromPos(o.pos,n=="up"?-1:1);for(;;){let n=e.docView.nearestDesc(t,true);if(!n)break;if(n.node.isBlock){t=n.contentDOM||n.dom;break}t=n.dom.parentNode}let r=coordsAtPos(e,o.pos,1);for(let e=t.firstChild;e;e=e.nextSibling){let t;if(e.nodeType==1)t=e.getClientRects();else if(e.nodeType==3)t=textRange$1(e,0,e.nodeValue.length).getClientRects();else continue;for(let e=0;e<t.length;e++){let o=t[e];if(o.bottom>o.top+1&&(n=="up"?r.top-o.top>(o.bottom-r.top)*2:o.bottom-r.bottom>(r.bottom-o.top)*2))return false}}return true}))}const maybeRTL=/[\u0590-\u08ac]/;function endOfTextblockHorizontal(e,t,n){let{$head:r}=t.selection;if(!r.parent.isTextblock)return false;let o=r.parentOffset,i=!o,s=o==r.parent.content.size;let a=e.domSelection();if(!a)return r.pos==r.start()||r.pos==r.end();if(!maybeRTL.test(r.parent.textContent)||!a.modify)return n=="left"||n=="backward"?i:s;return withFlushedState(e,t,(()=>{let{focusNode:t,focusOffset:o,anchorNode:i,anchorOffset:s}=e.domSelectionRange();let l=a.caretBidiLevel;a.modify("move",n,"character");let c=r.depth?e.docView.domAfterPos(r.before()):e.dom;let{focusNode:d,focusOffset:u}=e.domSelectionRange();let p=d&&!c.contains(d.nodeType==1?d:d.parentNode)||t==d&&o==u;try{a.collapse(i,s);if(t&&(t!=i||o!=s)&&a.extend)a.extend(t,o)}catch(e){}if(l!=null)a.caretBidiLevel=l;return p}))}let cachedState=null;let cachedDir=null;let cachedResult=false;function endOfTextblock(e,t,n){if(cachedState==t&&cachedDir==n)return cachedResult;cachedState=t;cachedDir=n;return cachedResult=n=="up"||n=="down"?endOfTextblockVertical(e,t,n):endOfTextblockHorizontal(e,t,n)}const NOT_DIRTY=0,CHILD_DIRTY=1,CONTENT_DIRTY=2,NODE_DIRTY=3;class ViewDesc{constructor(e,t,n,r){this.parent=e;this.children=t;this.dom=n;this.contentDOM=r;this.dirty=NOT_DIRTY;n.pmViewDesc=this}matchesWidget(e){return false}matchesMark(e){return false}matchesNode(e,t,n){return false}matchesHack(e){return false}parseRule(){return null}stopEvent(e){return false}get size(){let e=0;for(let t=0;t<this.children.length;t++)e+=this.children[t].size;return e}get border(){return 0}destroy(){this.parent=undefined;if(this.dom.pmViewDesc==this)this.dom.pmViewDesc=undefined;for(let e=0;e<this.children.length;e++)this.children[e].destroy()}posBeforeChild(e){for(let t=0,n=this.posAtStart;;t++){let r=this.children[t];if(r==e)return n;n+=r.size}}get posBefore(){return this.parent.posBeforeChild(this)}get posAtStart(){return this.parent?this.parent.posBeforeChild(this)+this.border:0}get posAfter(){return this.posBefore+this.size}get posAtEnd(){return this.posAtStart+this.size-2*this.border}localPosFromDOM(e,t,n){if(this.contentDOM&&this.contentDOM.contains(e.nodeType==1?e:e.parentNode)){if(n<0){let n,r;if(e==this.contentDOM){n=e.childNodes[t-1]}else{while(e.parentNode!=this.contentDOM)e=e.parentNode;n=e.previousSibling}while(n&&!((r=n.pmViewDesc)&&r.parent==this))n=n.previousSibling;return n?this.posBeforeChild(r)+r.size:this.posAtStart}else{let n,r;if(e==this.contentDOM){n=e.childNodes[t]}else{while(e.parentNode!=this.contentDOM)e=e.parentNode;n=e.nextSibling}while(n&&!((r=n.pmViewDesc)&&r.parent==this))n=n.nextSibling;return n?this.posBeforeChild(r):this.posAtEnd}}let r;if(e==this.dom&&this.contentDOM){r=t>domIndex(this.contentDOM)}else if(this.contentDOM&&this.contentDOM!=this.dom&&this.dom.contains(this.contentDOM)){r=e.compareDocumentPosition(this.contentDOM)&2}else if(this.dom.firstChild){if(t==0)for(let t=e;;t=t.parentNode){if(t==this.dom){r=false;break}if(t.previousSibling)break}if(r==null&&t==e.childNodes.length)for(let t=e;;t=t.parentNode){if(t==this.dom){r=true;break}if(t.nextSibling)break}}return(r==null?n>0:r)?this.posAtEnd:this.posAtStart}nearestDesc(e,t=false){for(let n=true,r=e;r;r=r.parentNode){let o=this.getDesc(r),i;if(o&&(!t||o.node)){if(n&&(i=o.nodeDOM)&&!(i.nodeType==1?i.contains(e.nodeType==1?e:e.parentNode):i==e))n=false;else return o}}}getDesc(e){let t=e.pmViewDesc;for(let e=t;e;e=e.parent)if(e==this)return t}posFromDOM(e,t,n){for(let r=e;r;r=r.parentNode){let o=this.getDesc(r);if(o)return o.localPosFromDOM(e,t,n)}return-1}descAt(e){for(let t=0,n=0;t<this.children.length;t++){let r=this.children[t],o=n+r.size;if(n==e&&o!=n){while(!r.border&&r.children.length)r=r.children[0];return r}if(e<o)return r.descAt(e-n-r.border);n=o}}domFromPos(e,t){if(!this.contentDOM)return{node:this.dom,offset:0,atom:e+1};let n=0,r=0;for(let t=0;n<this.children.length;n++){let o=this.children[n],i=t+o.size;if(i>e||o instanceof TrailingHackViewDesc){r=e-t;break}t=i}if(r)return this.children[n].domFromPos(r-this.children[n].border,t);for(let e;n&&!(e=this.children[n-1]).size&&e instanceof WidgetViewDesc&&e.side>=0;n--){}if(t<=0){let e,r=true;for(;;n--,r=false){e=n?this.children[n-1]:null;if(!e||e.dom.parentNode==this.contentDOM)break}if(e&&t&&r&&!e.border&&!e.domAtom)return e.domFromPos(e.size,t);return{node:this.contentDOM,offset:e?domIndex(e.dom)+1:0}}else{let e,r=true;for(;;n++,r=false){e=n<this.children.length?this.children[n]:null;if(!e||e.dom.parentNode==this.contentDOM)break}if(e&&r&&!e.border&&!e.domAtom)return e.domFromPos(0,t);return{node:this.contentDOM,offset:e?domIndex(e.dom):this.contentDOM.childNodes.length}}}parseRange(e,t,n=0){if(this.children.length==0)return{node:this.contentDOM,from:e,to:t,fromOffset:0,toOffset:this.contentDOM.childNodes.length};let r=-1,o=-1;for(let i=n,s=0;;s++){let n=this.children[s],a=i+n.size;if(r==-1&&e<=a){let o=i+n.border;if(e>=o&&t<=a-n.border&&n.node&&n.contentDOM&&this.contentDOM.contains(n.contentDOM))return n.parseRange(e,t,o);e=i;for(let t=s;t>0;t--){let n=this.children[t-1];if(n.size&&n.dom.parentNode==this.contentDOM&&!n.emptyChildAt(1)){r=domIndex(n.dom)+1;break}e-=n.size}if(r==-1)r=0}if(r>-1&&(a>t||s==this.children.length-1)){t=a;for(let e=s+1;e<this.children.length;e++){let n=this.children[e];if(n.size&&n.dom.parentNode==this.contentDOM&&!n.emptyChildAt(-1)){o=domIndex(n.dom);break}t+=n.size}if(o==-1)o=this.contentDOM.childNodes.length;break}i=a}return{node:this.contentDOM,from:e,to:t,fromOffset:r,toOffset:o}}emptyChildAt(e){if(this.border||!this.contentDOM||!this.children.length)return false;let t=this.children[e<0?0:this.children.length-1];return t.size==0||t.emptyChildAt(e)}domAfterPos(e){let{node:t,offset:n}=this.domFromPos(e,0);if(t.nodeType!=1||n==t.childNodes.length)throw new RangeError("No node after pos "+e);return t.childNodes[n]}setSelection(e,t,n,r=false){let o=Math.min(e,t),i=Math.max(e,t);for(let s=0,a=0;s<this.children.length;s++){let l=this.children[s],c=a+l.size;if(o>a&&i<c)return l.setSelection(e-a-l.border,t-a-l.border,n,r);a=c}let s=this.domFromPos(e,e?-1:1);let a=t==e?s:this.domFromPos(t,t?-1:1);let l=n.getSelection();let c=false;if((gecko||safari)&&e==t){let{node:e,offset:t}=s;if(e.nodeType==3){c=!!(t&&e.nodeValue[t-1]=="\n");if(c&&t==e.nodeValue.length){for(let t=e,n;t;t=t.parentNode){if(n=t.nextSibling){if(n.nodeName=="BR")s=a={node:n.parentNode,offset:domIndex(n)+1};break}let e=t.pmViewDesc;if(e&&e.node&&e.node.isBlock)break}}}else{let n=e.childNodes[t-1];c=n&&(n.nodeName=="BR"||n.contentEditable=="false")}}if(gecko&&l.focusNode&&l.focusNode!=a.node&&l.focusNode.nodeType==1){let e=l.focusNode.childNodes[l.focusOffset];if(e&&e.contentEditable=="false")r=true}if(!(r||c&&safari)&&isEquivalentPosition(s.node,s.offset,l.anchorNode,l.anchorOffset)&&isEquivalentPosition(a.node,a.offset,l.focusNode,l.focusOffset))return;let d=false;if((l.extend||e==t)&&!c){l.collapse(s.node,s.offset);try{if(e!=t)l.extend(a.node,a.offset);d=true}catch(e){}}if(!d){if(e>t){let e=s;s=a;a=e}let n=document.createRange();n.setEnd(a.node,a.offset);n.setStart(s.node,s.offset);l.removeAllRanges();l.addRange(n)}}ignoreMutation(e){return!this.contentDOM&&e.type!="selection"}get contentLost(){return this.contentDOM&&this.contentDOM!=this.dom&&!this.dom.contains(this.contentDOM)}markDirty(e,t){for(let n=0,r=0;r<this.children.length;r++){let o=this.children[r],i=n+o.size;if(n==i?e<=i&&t>=n:e<i&&t>n){let r=n+o.border,s=i-o.border;if(e>=r&&t<=s){this.dirty=e==n||t==i?CONTENT_DIRTY:CHILD_DIRTY;if(e==r&&t==s&&(o.contentLost||o.dom.parentNode!=this.contentDOM))o.dirty=NODE_DIRTY;else o.markDirty(e-r,t-r);return}else{o.dirty=o.dom==o.contentDOM&&o.dom.parentNode==this.contentDOM&&!o.children.length?CONTENT_DIRTY:NODE_DIRTY}}n=i}this.dirty=CONTENT_DIRTY}markParentsDirty(){let e=1;for(let t=this.parent;t;t=t.parent,e++){let n=e==1?CONTENT_DIRTY:CHILD_DIRTY;if(t.dirty<n)t.dirty=n}}get domAtom(){return false}get ignoreForCoords(){return false}isText(e){return false}}class WidgetViewDesc extends ViewDesc{constructor(e,t,n,r){let o,i=t.type.toDOM;if(typeof i=="function")i=i(n,(()=>{if(!o)return r;if(o.parent)return o.parent.posBeforeChild(o)}));if(!t.type.spec.raw){if(i.nodeType!=1){let e=document.createElement("span");e.appendChild(i);i=e}i.contentEditable="false";i.classList.add("ProseMirror-widget")}super(e,[],i,null);this.widget=t;this.widget=t;o=this}matchesWidget(e){return this.dirty==NOT_DIRTY&&e.type.eq(this.widget.type)}parseRule(){return{ignore:true}}stopEvent(e){let t=this.widget.spec.stopEvent;return t?t(e):false}ignoreMutation(e){return e.type!="selection"||this.widget.spec.ignoreSelection}destroy(){this.widget.type.destroy(this.dom);super.destroy()}get domAtom(){return true}get side(){return this.widget.type.side}}class CompositionViewDesc extends ViewDesc{constructor(e,t,n,r){super(e,[],t,null);this.textDOM=n;this.text=r}get size(){return this.text.length}localPosFromDOM(e,t){if(e!=this.textDOM)return this.posAtStart+(t?this.size:0);return this.posAtStart+t}domFromPos(e){return{node:this.textDOM,offset:e}}ignoreMutation(e){return e.type==="characterData"&&e.target.nodeValue==e.oldValue}}class MarkViewDesc extends ViewDesc{constructor(e,t,n,r){super(e,[],n,r);this.mark=t}static create(e,t,n,r){let o=r.nodeViews[t.type.name];let i=o&&o(t,r,n);if(!i||!i.dom)i=DOMSerializer.renderSpec(document,t.type.spec.toDOM(t,n),null,t.attrs);return new MarkViewDesc(e,t,i.dom,i.contentDOM||i.dom)}parseRule(){if(this.dirty&NODE_DIRTY||this.mark.type.spec.reparseInView)return null;return{mark:this.mark.type.name,attrs:this.mark.attrs,contentElement:this.contentDOM}}matchesMark(e){return this.dirty!=NODE_DIRTY&&this.mark.eq(e)}markDirty(e,t){super.markDirty(e,t);if(this.dirty!=NOT_DIRTY){let e=this.parent;while(!e.node)e=e.parent;if(e.dirty<this.dirty)e.dirty=this.dirty;this.dirty=NOT_DIRTY}}slice(e,t,n){let r=MarkViewDesc.create(this.parent,this.mark,true,n);let o=this.children,i=this.size;if(t<i)o=replaceNodes(o,t,i,n);if(e>0)o=replaceNodes(o,0,e,n);for(let e=0;e<o.length;e++)o[e].parent=r;r.children=o;return r}}class NodeViewDesc extends ViewDesc{constructor(e,t,n,r,o,i,s,a,l){super(e,[],o,i);this.node=t;this.outerDeco=n;this.innerDeco=r;this.nodeDOM=s}static create(e,t,n,r,o,i){let s=o.nodeViews[t.type.name],a;let l=s&&s(t,o,(()=>{if(!a)return i;if(a.parent)return a.parent.posBeforeChild(a)}),n,r);let c=l&&l.dom,d=l&&l.contentDOM;if(t.isText){if(!c)c=document.createTextNode(t.text);else if(c.nodeType!=3)throw new RangeError("Text must be rendered as a DOM text node")}else if(!c){let e=DOMSerializer.renderSpec(document,t.type.spec.toDOM(t),null,t.attrs);({dom:c,contentDOM:d}=e)}if(!d&&!t.isText&&c.nodeName!="BR"){if(!c.hasAttribute("contenteditable"))c.contentEditable="false";if(t.type.spec.draggable)c.draggable=true}let u=c;c=applyOuterDeco(c,n,t);if(l)return a=new CustomNodeViewDesc(e,t,n,r,c,d||null,u,l,o,i+1);else if(t.isText)return new TextViewDesc(e,t,n,r,c,u,o);else return new NodeViewDesc(e,t,n,r,c,d||null,u,o,i+1)}parseRule(){if(this.node.type.spec.reparseInView)return null;let e={node:this.node.type.name,attrs:this.node.attrs};if(this.node.type.whitespace=="pre")e.preserveWhitespace="full";if(!this.contentDOM){e.getContent=()=>this.node.content}else if(!this.contentLost){e.contentElement=this.contentDOM}else{for(let t=this.children.length-1;t>=0;t--){let n=this.children[t];if(this.dom.contains(n.dom.parentNode)){e.contentElement=n.dom.parentNode;break}}if(!e.contentElement)e.getContent=()=>Fragment.empty}return e}matchesNode(e,t,n){return this.dirty==NOT_DIRTY&&e.eq(this.node)&&sameOuterDeco(t,this.outerDeco)&&n.eq(this.innerDeco)}get size(){return this.node.nodeSize}get border(){return this.node.isLeaf?0:1}updateChildren(e,t){let n=this.node.inlineContent,r=t;let o=e.composing?this.localCompositionInfo(e,t):null;let i=o&&o.pos>-1?o:null;let s=o&&o.pos<0;let a=new ViewTreeUpdater(this,i&&i.node,e);iterDeco(this.node,this.innerDeco,((t,o,i)=>{if(t.spec.marks)a.syncToMarks(t.spec.marks,n,e);else if(t.type.side>=0&&!i)a.syncToMarks(o==this.node.childCount?Mark.none:this.node.child(o).marks,n,e);a.placeWidget(t,e,r)}),((t,i,l,c)=>{a.syncToMarks(t.marks,n,e);let d;if(a.findNodeMatch(t,i,l,c));else if(s&&e.state.selection.from>r&&e.state.selection.to<r+t.nodeSize&&(d=a.findIndexWithChild(o.node))>-1&&a.updateNodeAt(t,i,l,d,e));else if(a.updateNextNode(t,i,l,e,c,r));else{a.addNode(t,i,l,e,r)}r+=t.nodeSize}));a.syncToMarks([],n,e);if(this.node.isTextblock)a.addTextblockHacks();a.destroyRest();if(a.changed||this.dirty==CONTENT_DIRTY){if(i)this.protectLocalComposition(e,i);renderDescs(this.contentDOM,this.children,e);if(ios)iosHacks(this.dom)}}localCompositionInfo(e,t){let{from:n,to:r}=e.state.selection;if(!(e.state.selection instanceof TextSelection)||n<t||r>t+this.node.content.size)return null;let o=e.input.compositionNode;if(!o||!this.dom.contains(o.parentNode))return null;if(this.node.inlineContent){let e=o.nodeValue;let i=findTextInFragment(this.node.content,e,n-t,r-t);return i<0?null:{node:o,pos:i,text:e}}else{return{node:o,pos:-1,text:""}}}protectLocalComposition(e,{node:t,pos:n,text:r}){if(this.getDesc(t))return;let o=t;for(;;o=o.parentNode){if(o.parentNode==this.contentDOM)break;while(o.previousSibling)o.parentNode.removeChild(o.previousSibling);while(o.nextSibling)o.parentNode.removeChild(o.nextSibling);if(o.pmViewDesc)o.pmViewDesc=undefined}let i=new CompositionViewDesc(this,o,t,r);e.input.compositionNodes.push(i);this.children=replaceNodes(this.children,n,n+r.length,e,i)}update(e,t,n,r){if(this.dirty==NODE_DIRTY||!e.sameMarkup(this.node))return false;this.updateInner(e,t,n,r);return true}updateInner(e,t,n,r){this.updateOuterDeco(t);this.node=e;this.innerDeco=n;if(this.contentDOM)this.updateChildren(r,this.posAtStart);this.dirty=NOT_DIRTY}updateOuterDeco(e){if(sameOuterDeco(e,this.outerDeco))return;let t=this.nodeDOM.nodeType!=1;let n=this.dom;this.dom=patchOuterDeco(this.dom,this.nodeDOM,computeOuterDeco(this.outerDeco,this.node,t),computeOuterDeco(e,this.node,t));if(this.dom!=n){n.pmViewDesc=undefined;this.dom.pmViewDesc=this}this.outerDeco=e}selectNode(){if(this.nodeDOM.nodeType==1)this.nodeDOM.classList.add("ProseMirror-selectednode");if(this.contentDOM||!this.node.type.spec.draggable)this.dom.draggable=true}deselectNode(){if(this.nodeDOM.nodeType==1){this.nodeDOM.classList.remove("ProseMirror-selectednode");if(this.contentDOM||!this.node.type.spec.draggable)this.dom.removeAttribute("draggable")}}get domAtom(){return this.node.isAtom}}function docViewDesc(e,t,n,r,o){applyOuterDeco(r,t,e);let i=new NodeViewDesc(undefined,e,t,n,r,r,r,o,0);if(i.contentDOM)i.updateChildren(o,0);return i}class TextViewDesc extends NodeViewDesc{constructor(e,t,n,r,o,i,s){super(e,t,n,r,o,null,i,s,0)}parseRule(){let e=this.nodeDOM.parentNode;while(e&&e!=this.dom&&!e.pmIsDeco)e=e.parentNode;return{skip:e||true}}update(e,t,n,r){if(this.dirty==NODE_DIRTY||this.dirty!=NOT_DIRTY&&!this.inParent()||!e.sameMarkup(this.node))return false;this.updateOuterDeco(t);if((this.dirty!=NOT_DIRTY||e.text!=this.node.text)&&e.text!=this.nodeDOM.nodeValue){this.nodeDOM.nodeValue=e.text;if(r.trackWrites==this.nodeDOM)r.trackWrites=null}this.node=e;this.dirty=NOT_DIRTY;return true}inParent(){let e=this.parent.contentDOM;for(let t=this.nodeDOM;t;t=t.parentNode)if(t==e)return true;return false}domFromPos(e){return{node:this.nodeDOM,offset:e}}localPosFromDOM(e,t,n){if(e==this.nodeDOM)return this.posAtStart+Math.min(t,this.node.text.length);return super.localPosFromDOM(e,t,n)}ignoreMutation(e){return e.type!="characterData"&&e.type!="selection"}slice(e,t,n){let r=this.node.cut(e,t),o=document.createTextNode(r.text);return new TextViewDesc(this.parent,r,this.outerDeco,this.innerDeco,o,o,n)}markDirty(e,t){super.markDirty(e,t);if(this.dom!=this.nodeDOM&&(e==0||t==this.nodeDOM.nodeValue.length))this.dirty=NODE_DIRTY}get domAtom(){return false}isText(e){return this.node.text==e}}class TrailingHackViewDesc extends ViewDesc{parseRule(){return{ignore:true}}matchesHack(e){return this.dirty==NOT_DIRTY&&this.dom.nodeName==e}get domAtom(){return true}get ignoreForCoords(){return this.dom.nodeName=="IMG"}}class CustomNodeViewDesc extends NodeViewDesc{constructor(e,t,n,r,o,i,s,a,l,c){super(e,t,n,r,o,i,s,l,c);this.spec=a}update(e,t,n,r){if(this.dirty==NODE_DIRTY)return false;if(this.spec.update){let o=this.spec.update(e,t,n);if(o)this.updateInner(e,t,n,r);return o}else if(!this.contentDOM&&!e.isLeaf){return false}else{return super.update(e,t,n,r)}}selectNode(){this.spec.selectNode?this.spec.selectNode():super.selectNode()}deselectNode(){this.spec.deselectNode?this.spec.deselectNode():super.deselectNode()}setSelection(e,t,n,r){this.spec.setSelection?this.spec.setSelection(e,t,n):super.setSelection(e,t,n,r)}destroy(){if(this.spec.destroy)this.spec.destroy();super.destroy()}stopEvent(e){return this.spec.stopEvent?this.spec.stopEvent(e):false}ignoreMutation(e){return this.spec.ignoreMutation?this.spec.ignoreMutation(e):super.ignoreMutation(e)}}function renderDescs(e,t,n){let r=e.firstChild,o=false;for(let i=0;i<t.length;i++){let s=t[i],a=s.dom;if(a.parentNode==e){while(a!=r){r=rm(r);o=true}r=r.nextSibling}else{o=true;e.insertBefore(a,r)}if(s instanceof MarkViewDesc){let t=r?r.previousSibling:e.lastChild;renderDescs(s.contentDOM,s.children,n);r=t?t.nextSibling:e.firstChild}}while(r){r=rm(r);o=true}if(o&&n.trackWrites==e)n.trackWrites=null}const OuterDecoLevel=function(e){if(e)this.nodeName=e};OuterDecoLevel.prototype=Object.create(null);const noDeco=[new OuterDecoLevel];function computeOuterDeco(e,t,n){if(e.length==0)return noDeco;let r=n?noDeco[0]:new OuterDecoLevel,o=[r];for(let i=0;i<e.length;i++){let s=e[i].type.attrs;if(!s)continue;if(s.nodeName)o.push(r=new OuterDecoLevel(s.nodeName));for(let e in s){let i=s[e];if(i==null)continue;if(n&&o.length==1)o.push(r=new OuterDecoLevel(t.isInline?"span":"div"));if(e=="class")r.class=(r.class?r.class+" ":"")+i;else if(e=="style")r.style=(r.style?r.style+";":"")+i;else if(e!="nodeName")r[e]=i}}return o}function patchOuterDeco(e,t,n,r){if(n==noDeco&&r==noDeco)return t;let o=t;for(let t=0;t<r.length;t++){let i=r[t],s=n[t];if(t){let t;if(s&&s.nodeName==i.nodeName&&o!=e&&(t=o.parentNode)&&t.nodeName.toLowerCase()==i.nodeName){o=t}else{t=document.createElement(i.nodeName);t.pmIsDeco=true;t.appendChild(o);s=noDeco[0];o=t}}patchAttributes(o,s||noDeco[0],i)}return o}function patchAttributes(e,t,n){for(let r in t)if(r!="class"&&r!="style"&&r!="nodeName"&&!(r in n))e.removeAttribute(r);for(let r in n)if(r!="class"&&r!="style"&&r!="nodeName"&&n[r]!=t[r])e.setAttribute(r,n[r]);if(t.class!=n.class){let r=t.class?t.class.split(" ").filter(Boolean):[];let o=n.class?n.class.split(" ").filter(Boolean):[];for(let t=0;t<r.length;t++)if(o.indexOf(r[t])==-1)e.classList.remove(r[t]);for(let t=0;t<o.length;t++)if(r.indexOf(o[t])==-1)e.classList.add(o[t]);if(e.classList.length==0)e.removeAttribute("class")}if(t.style!=n.style){if(t.style){let n=/\s*([\w\-\xa1-\uffff]+)\s*:(?:"(?:\\.|[^"])*"|'(?:\\.|[^'])*'|\(.*?\)|[^;])*/g,r;while(r=n.exec(t.style))e.style.removeProperty(r[1])}if(n.style)e.style.cssText+=n.style}}function applyOuterDeco(e,t,n){return patchOuterDeco(e,e,noDeco,computeOuterDeco(t,n,e.nodeType!=1))}function sameOuterDeco(e,t){if(e.length!=t.length)return false;for(let n=0;n<e.length;n++)if(!e[n].type.eq(t[n].type))return false;return true}function rm(e){let t=e.nextSibling;e.parentNode.removeChild(e);return t}class ViewTreeUpdater{constructor(e,t,n){this.lock=t;this.view=n;this.index=0;this.stack=[];this.changed=false;this.top=e;this.preMatch=preMatch(e.node.content,e)}destroyBetween(e,t){if(e==t)return;for(let n=e;n<t;n++)this.top.children[n].destroy();this.top.children.splice(e,t-e);this.changed=true}destroyRest(){this.destroyBetween(this.index,this.top.children.length)}syncToMarks(e,t,n){let r=0,o=this.stack.length>>1;let i=Math.min(o,e.length);while(r<i&&(r==o-1?this.top:this.stack[r+1<<1]).matchesMark(e[r])&&e[r].type.spec.spanning!==false)r++;while(r<o){this.destroyRest();this.top.dirty=NOT_DIRTY;this.index=this.stack.pop();this.top=this.stack.pop();o--}while(o<e.length){this.stack.push(this.top,this.index+1);let r=-1;for(let t=this.index;t<Math.min(this.index+3,this.top.children.length);t++){let n=this.top.children[t];if(n.matchesMark(e[o])&&!this.isLocked(n.dom)){r=t;break}}if(r>-1){if(r>this.index){this.changed=true;this.destroyBetween(this.index,r)}this.top=this.top.children[this.index]}else{let r=MarkViewDesc.create(this.top,e[o],t,n);this.top.children.splice(this.index,0,r);this.top=r;this.changed=true}this.index=0;o++}}findNodeMatch(e,t,n,r){let o=-1,i;if(r>=this.preMatch.index&&(i=this.preMatch.matches[r-this.preMatch.index]).parent==this.top&&i.matchesNode(e,t,n)){o=this.top.children.indexOf(i,this.index)}else{for(let r=this.index,i=Math.min(this.top.children.length,r+5);r<i;r++){let i=this.top.children[r];if(i.matchesNode(e,t,n)&&!this.preMatch.matched.has(i)){o=r;break}}}if(o<0)return false;this.destroyBetween(this.index,o);this.index++;return true}updateNodeAt(e,t,n,r,o){let i=this.top.children[r];if(i.dirty==NODE_DIRTY&&i.dom==i.contentDOM)i.dirty=CONTENT_DIRTY;if(!i.update(e,t,n,o))return false;this.destroyBetween(this.index,r);this.index++;return true}findIndexWithChild(e){for(;;){let t=e.parentNode;if(!t)return-1;if(t==this.top.contentDOM){let t=e.pmViewDesc;if(t)for(let e=this.index;e<this.top.children.length;e++){if(this.top.children[e]==t)return e}return-1}e=t}}updateNextNode(e,t,n,r,o,i){for(let s=this.index;s<this.top.children.length;s++){let a=this.top.children[s];if(a instanceof NodeViewDesc){let l=this.preMatch.matched.get(a);if(l!=null&&l!=o)return false;let c=a.dom,d;let u=this.isLocked(c)&&!(e.isText&&a.node&&a.node.isText&&a.nodeDOM.nodeValue==e.text&&a.dirty!=NODE_DIRTY&&sameOuterDeco(t,a.outerDeco));if(!u&&a.update(e,t,n,r)){this.destroyBetween(this.index,s);if(a.dom!=c)this.changed=true;this.index++;return true}else if(!u&&(d=this.recreateWrapper(a,e,t,n,r,i))){this.top.children[this.index]=d;if(d.contentDOM){d.dirty=CONTENT_DIRTY;d.updateChildren(r,i+1);d.dirty=NOT_DIRTY}this.changed=true;this.index++;return true}break}}return false}recreateWrapper(e,t,n,r,o,i){if(e.dirty||t.isAtom||!e.children.length||!e.node.content.eq(t.content))return null;let s=NodeViewDesc.create(this.top,t,n,r,o,i);if(s.contentDOM){s.children=e.children;e.children=[];for(let e of s.children)e.parent=s}e.destroy();return s}addNode(e,t,n,r,o){let i=NodeViewDesc.create(this.top,e,t,n,r,o);if(i.contentDOM)i.updateChildren(r,o+1);this.top.children.splice(this.index++,0,i);this.changed=true}placeWidget(e,t,n){let r=this.index<this.top.children.length?this.top.children[this.index]:null;if(r&&r.matchesWidget(e)&&(e==r.widget||!r.widget.type.toDOM.parentNode)){this.index++}else{let r=new WidgetViewDesc(this.top,e,t,n);this.top.children.splice(this.index++,0,r);this.changed=true}}addTextblockHacks(){let e=this.top.children[this.index-1],t=this.top;while(e instanceof MarkViewDesc){t=e;e=t.children[t.children.length-1]}if(!e||!(e instanceof TextViewDesc)||/\n$/.test(e.node.text)||this.view.requiresGeckoHackNode&&/\s$/.test(e.node.text)){if((safari||chrome)&&e&&e.dom.contentEditable=="false")this.addHackNode("IMG",t);this.addHackNode("BR",this.top)}}addHackNode(e,t){if(t==this.top&&this.index<t.children.length&&t.children[this.index].matchesHack(e)){this.index++}else{let n=document.createElement(e);if(e=="IMG"){n.className="ProseMirror-separator";n.alt=""}if(e=="BR")n.className="ProseMirror-trailingBreak";let r=new TrailingHackViewDesc(this.top,[],n,null);if(t!=this.top)t.children.push(r);else t.children.splice(this.index++,0,r);this.changed=true}}isLocked(e){return this.lock&&(e==this.lock||e.nodeType==1&&e.contains(this.lock.parentNode))}}function preMatch(e,t){let n=t,r=n.children.length;let o=e.childCount,i=new Map,s=[];e:while(o>0){let a;for(;;){if(r){let e=n.children[r-1];if(e instanceof MarkViewDesc){n=e;r=e.children.length}else{a=e;r--;break}}else if(n==t){break e}else{r=n.parent.children.indexOf(n);n=n.parent}}let l=a.node;if(!l)continue;if(l!=e.child(o-1))break;--o;i.set(a,o);s.push(a)}return{index:o,matched:i,matches:s.reverse()}}function compareSide(e,t){return e.type.side-t.type.side}function iterDeco(e,t,n,r){let o=t.locals(e),i=0;if(o.length==0){for(let n=0;n<e.childCount;n++){let s=e.child(n);r(s,o,t.forChild(i,s),n);i+=s.nodeSize}return}let s=0,a=[],l=null;for(let c=0;;){let d,u;while(s<o.length&&o[s].to==i){let e=o[s++];if(e.widget){if(!d)d=e;else(u||(u=[d])).push(e)}}if(d){if(u){u.sort(compareSide);for(let e=0;e<u.length;e++)n(u[e],c,!!l)}else{n(d,c,!!l)}}let p,f;if(l){f=-1;p=l;l=null}else if(c<e.childCount){f=c;p=e.child(c++)}else{break}for(let e=0;e<a.length;e++)if(a[e].to<=i)a.splice(e--,1);while(s<o.length&&o[s].from<=i&&o[s].to>i)a.push(o[s++]);let h=i+p.nodeSize;if(p.isText){let e=h;if(s<o.length&&o[s].from<e)e=o[s].from;for(let t=0;t<a.length;t++)if(a[t].to<e)e=a[t].to;if(e<h){l=p.cut(e-i);p=p.cut(0,e-i);h=e;f=-1}}else{while(s<o.length&&o[s].to<h)s++}let m=p.isInline&&!p.isLeaf?a.filter((e=>!e.inline)):a.slice();r(p,m,t.forChild(i,p),f);i=h}}function iosHacks(e){if(e.nodeName=="UL"||e.nodeName=="OL"){let t=e.style.cssText;e.style.cssText=t+"; list-style: square !important";window.getComputedStyle(e).listStyle;e.style.cssText=t}}function findTextInFragment(e,t,n,r){for(let o=0,i=0;o<e.childCount&&i<=r;){let s=e.child(o++),a=i;i+=s.nodeSize;if(!s.isText)continue;let l=s.text;while(o<e.childCount){let t=e.child(o++);i+=t.nodeSize;if(!t.isText)break;l+=t.text}if(i>=n){if(i>=r&&l.slice(r-t.length-a,r-a)==t)return r-t.length;let e=a<r?l.lastIndexOf(t,r-a-1):-1;if(e>=0&&e+t.length+a>=n)return a+e;if(n==r&&l.length>=r+t.length-a&&l.slice(r-a,r-a+t.length)==t)return r}}return-1}function replaceNodes(e,t,n,r,o){let i=[];for(let s=0,a=0;s<e.length;s++){let l=e[s],c=a,d=a+=l.size;if(c>=n||d<=t){i.push(l)}else{if(c<t)i.push(l.slice(0,t-c,r));if(o){i.push(o);o=undefined}if(d>n)i.push(l.slice(n-c,l.size,r))}}return i}function selectionFromDOM(e,t=null){let n=e.domSelectionRange(),r=e.state.doc;if(!n.focusNode)return null;let o=e.docView.nearestDesc(n.focusNode),i=o&&o.size==0;let s=e.docView.posFromDOM(n.focusNode,n.focusOffset,1);if(s<0)return null;let a=r.resolve(s),l,c;if(selectionCollapsed(n)){l=a;while(o&&!o.node)o=o.parent;let e=o.node;if(o&&e.isAtom&&NodeSelection.isSelectable(e)&&o.parent&&!(e.isInline&&isOnEdge(n.focusNode,n.focusOffset,o.dom))){let e=o.posBefore;c=new NodeSelection(s==e?a:r.resolve(e))}}else{let t=e.docView.posFromDOM(n.anchorNode,n.anchorOffset,1);if(t<0)return null;l=r.resolve(t)}if(!c){let n=t=="pointer"||e.state.selection.head<a.pos&&!i?1:-1;c=selectionBetween(e,l,a,n)}return c}function editorOwnsSelection(e){return e.editable?e.hasFocus():hasSelection(e)&&document.activeElement&&document.activeElement.contains(e.dom)}function selectionToDOM(e,t=false){let n=e.state.selection;syncNodeSelection(e,n);if(!editorOwnsSelection(e))return;if(!t&&e.input.mouseDown&&e.input.mouseDown.allowDefault&&chrome){let t=e.domSelectionRange(),n=e.domObserver.currentSelection;if(t.anchorNode&&n.anchorNode&&isEquivalentPosition(t.anchorNode,t.anchorOffset,n.anchorNode,n.anchorOffset)){e.input.mouseDown.delayedSelectionSync=true;e.domObserver.setCurSelection();return}}e.domObserver.disconnectSelection();if(e.cursorWrapper){selectCursorWrapper(e)}else{let{anchor:r,head:o}=n,i,s;if(brokenSelectBetweenUneditable&&!(n instanceof TextSelection)){if(!n.$from.parent.inlineContent)i=temporarilyEditableNear(e,n.from);if(!n.empty&&!n.$from.parent.inlineContent)s=temporarilyEditableNear(e,n.to)}e.docView.setSelection(r,o,e.root,t);if(brokenSelectBetweenUneditable){if(i)resetEditable(i);if(s)resetEditable(s)}if(n.visible){e.dom.classList.remove("ProseMirror-hideselection")}else{e.dom.classList.add("ProseMirror-hideselection");if("onselectionchange"in document)removeClassOnSelectionChange(e)}}e.domObserver.setCurSelection();e.domObserver.connectSelection()}const brokenSelectBetweenUneditable=safari||chrome&&chrome_version<63;function temporarilyEditableNear(e,t){let{node:n,offset:r}=e.docView.domFromPos(t,0);let o=r<n.childNodes.length?n.childNodes[r]:null;let i=r?n.childNodes[r-1]:null;if(safari&&o&&o.contentEditable=="false")return setEditable(o);if((!o||o.contentEditable=="false")&&(!i||i.contentEditable=="false")){if(o)return setEditable(o);else if(i)return setEditable(i)}}function setEditable(e){e.contentEditable="true";if(safari&&e.draggable){e.draggable=false;e.wasDraggable=true}return e}function resetEditable(e){e.contentEditable="false";if(e.wasDraggable){e.draggable=true;e.wasDraggable=null}}function removeClassOnSelectionChange(e){let t=e.dom.ownerDocument;t.removeEventListener("selectionchange",e.input.hideSelectionGuard);let n=e.domSelectionRange();let r=n.anchorNode,o=n.anchorOffset;t.addEventListener("selectionchange",e.input.hideSelectionGuard=()=>{if(n.anchorNode!=r||n.anchorOffset!=o){t.removeEventListener("selectionchange",e.input.hideSelectionGuard);setTimeout((()=>{if(!editorOwnsSelection(e)||e.state.selection.visible)e.dom.classList.remove("ProseMirror-hideselection")}),20)}})}function selectCursorWrapper(e){let t=e.domSelection(),n=document.createRange();if(!t)return;let r=e.cursorWrapper.dom,o=r.nodeName=="IMG";if(o)n.setStart(r.parentNode,domIndex(r)+1);else n.setStart(r,0);let i=e.state.selection;if(i.empty){n.collapse(true)}else{let t=e.domAtPos(i.to);n.setEnd(t.node,t.offset)}t.removeAllRanges();t.addRange(n);if(!o&&!e.state.selection.visible&&ie$1&&ie_version<=11){r.disabled=true;r.disabled=false}}function syncNodeSelection(e,t){if(t instanceof NodeSelection){let n=e.docView.descAt(t.from);if(n!=e.lastSelectedViewDesc){clearNodeSelection(e);if(n)n.selectNode();e.lastSelectedViewDesc=n}}else{clearNodeSelection(e)}}function clearNodeSelection(e){if(e.lastSelectedViewDesc){if(e.lastSelectedViewDesc.parent)e.lastSelectedViewDesc.deselectNode();e.lastSelectedViewDesc=undefined}}function selectionBetween(e,t,n,r){return e.someProp("createSelectionBetween",(r=>r(e,t,n)))||TextSelection.between(t,n,r)}function hasFocusAndSelection(e){if(e.editable&&!e.hasFocus())return false;return hasSelection(e)}function hasSelection(e){let t=e.domSelectionRange();if(!t.anchorNode)return false;try{return e.dom.contains(t.anchorNode.nodeType==3?t.anchorNode.parentNode:t.anchorNode)&&(e.editable||e.dom.contains(t.focusNode.nodeType==3?t.focusNode.parentNode:t.focusNode))}catch(e){return false}}function anchorInRightPlace(e){let t=e.docView.domFromPos(e.state.selection.anchor,0);let n=e.domSelectionRange();return isEquivalentPosition(t.node,t.offset,n.anchorNode,n.anchorOffset)}function moveSelectionBlock(e,t){let{$anchor:n,$head:r}=e.selection;let o=t>0?n.max(r):n.min(r);let i=!o.parent.inlineContent?o:o.depth?e.doc.resolve(t>0?o.after():o.before()):null;return i&&Selection.findFrom(i,t)}function apply(e,t){e.dispatch(e.state.tr.setSelection(t).scrollIntoView());return true}function selectHorizontally(e,t,n){let r=e.state.selection;if(r instanceof TextSelection){if(n.indexOf("s")>-1){let{$head:n}=r,o=n.textOffset?null:t<0?n.nodeBefore:n.nodeAfter;if(!o||o.isText||!o.isLeaf)return false;let i=e.state.doc.resolve(n.pos+o.nodeSize*(t<0?-1:1));return apply(e,new TextSelection(r.$anchor,i))}else if(!r.empty){return false}else if(e.endOfTextblock(t>0?"forward":"backward")){let n=moveSelectionBlock(e.state,t);if(n&&n instanceof NodeSelection)return apply(e,n);return false}else if(!(mac$4&&n.indexOf("m")>-1)){let n=r.$head,o=n.textOffset?null:t<0?n.nodeBefore:n.nodeAfter,i;if(!o||o.isText)return false;let s=t<0?n.pos-o.nodeSize:n.pos;if(!(o.isAtom||(i=e.docView.descAt(s))&&!i.contentDOM))return false;if(NodeSelection.isSelectable(o)){return apply(e,new NodeSelection(t<0?e.state.doc.resolve(n.pos-o.nodeSize):n))}else if(webkit){return apply(e,new TextSelection(e.state.doc.resolve(t<0?s:s+o.nodeSize)))}else{return false}}}else if(r instanceof NodeSelection&&r.node.isInline){return apply(e,new TextSelection(t>0?r.$to:r.$from))}else{let n=moveSelectionBlock(e.state,t);if(n)return apply(e,n);return false}}function nodeLen(e){return e.nodeType==3?e.nodeValue.length:e.childNodes.length}function isIgnorable(e,t){let n=e.pmViewDesc;return n&&n.size==0&&(t<0||e.nextSibling||e.nodeName!="BR")}function skipIgnoredNodes(e,t){return t<0?skipIgnoredNodesBefore(e):skipIgnoredNodesAfter(e)}function skipIgnoredNodesBefore(e){let t=e.domSelectionRange();let n=t.focusNode,r=t.focusOffset;if(!n)return;let o,i,s=false;if(gecko&&n.nodeType==1&&r<nodeLen(n)&&isIgnorable(n.childNodes[r],-1))s=true;for(;;){if(r>0){if(n.nodeType!=1){break}else{let e=n.childNodes[r-1];if(isIgnorable(e,-1)){o=n;i=--r}else if(e.nodeType==3){n=e;r=n.nodeValue.length}else break}}else if(isBlockNode(n)){break}else{let t=n.previousSibling;while(t&&isIgnorable(t,-1)){o=n.parentNode;i=domIndex(t);t=t.previousSibling}if(!t){n=n.parentNode;if(n==e.dom)break;r=0}else{n=t;r=nodeLen(n)}}}if(s)setSelFocus(e,n,r);else if(o)setSelFocus(e,o,i)}function skipIgnoredNodesAfter(e){let t=e.domSelectionRange();let n=t.focusNode,r=t.focusOffset;if(!n)return;let o=nodeLen(n);let i,s;for(;;){if(r<o){if(n.nodeType!=1)break;let e=n.childNodes[r];if(isIgnorable(e,1)){i=n;s=++r}else break}else if(isBlockNode(n)){break}else{let t=n.nextSibling;while(t&&isIgnorable(t,1)){i=t.parentNode;s=domIndex(t)+1;t=t.nextSibling}if(!t){n=n.parentNode;if(n==e.dom)break;r=o=0}else{n=t;r=0;o=nodeLen(n)}}}if(i)setSelFocus(e,i,s)}function isBlockNode(e){let t=e.pmViewDesc;return t&&t.node&&t.node.isBlock}function textNodeAfter(e,t){while(e&&t==e.childNodes.length&&!hasBlockDesc(e)){t=domIndex(e)+1;e=e.parentNode}while(e&&t<e.childNodes.length){let n=e.childNodes[t];if(n.nodeType==3)return n;if(n.nodeType==1&&n.contentEditable=="false")break;e=n;t=0}}function textNodeBefore(e,t){while(e&&!t&&!hasBlockDesc(e)){t=domIndex(e);e=e.parentNode}while(e&&t){let n=e.childNodes[t-1];if(n.nodeType==3)return n;if(n.nodeType==1&&n.contentEditable=="false")break;e=n;t=e.childNodes.length}}function setSelFocus(e,t,n){if(t.nodeType!=3){let e,r;if(r=textNodeAfter(t,n)){t=r;n=0}else if(e=textNodeBefore(t,n)){t=e;n=e.nodeValue.length}}let r=e.domSelection();if(!r)return;if(selectionCollapsed(r)){let e=document.createRange();e.setEnd(t,n);e.setStart(t,n);r.removeAllRanges();r.addRange(e)}else if(r.extend){r.extend(t,n)}e.domObserver.setCurSelection();let{state:o}=e;setTimeout((()=>{if(e.state==o)selectionToDOM(e)}),50)}function findDirection(e,t){let n=e.state.doc.resolve(t);if(!(chrome||windows)&&n.parent.inlineContent){let r=e.coordsAtPos(t);if(t>n.start()){let n=e.coordsAtPos(t-1);let o=(n.top+n.bottom)/2;if(o>r.top&&o<r.bottom&&Math.abs(n.left-r.left)>1)return n.left<r.left?"ltr":"rtl"}if(t<n.end()){let n=e.coordsAtPos(t+1);let o=(n.top+n.bottom)/2;if(o>r.top&&o<r.bottom&&Math.abs(n.left-r.left)>1)return n.left>r.left?"ltr":"rtl"}}let r=getComputedStyle(e.dom).direction;return r=="rtl"?"rtl":"ltr"}function selectVertically(e,t,n){let r=e.state.selection;if(r instanceof TextSelection&&!r.empty||n.indexOf("s")>-1)return false;if(mac$4&&n.indexOf("m")>-1)return false;let{$from:o,$to:i}=r;if(!o.parent.inlineContent||e.endOfTextblock(t<0?"up":"down")){let n=moveSelectionBlock(e.state,t);if(n&&n instanceof NodeSelection)return apply(e,n)}if(!o.parent.inlineContent){let n=t<0?o:i;let s=r instanceof AllSelection?Selection.near(n,t):Selection.findFrom(n,t);return s?apply(e,s):false}return false}function stopNativeHorizontalDelete(e,t){if(!(e.state.selection instanceof TextSelection))return true;let{$head:n,$anchor:r,empty:o}=e.state.selection;if(!n.sameParent(r))return true;if(!o)return false;if(e.endOfTextblock(t>0?"forward":"backward"))return true;let i=!n.textOffset&&(t<0?n.nodeBefore:n.nodeAfter);if(i&&!i.isText){let r=e.state.tr;if(t<0)r.delete(n.pos-i.nodeSize,n.pos);else r.delete(n.pos,n.pos+i.nodeSize);e.dispatch(r);return true}return false}function switchEditable(e,t,n){e.domObserver.stop();t.contentEditable=n;e.domObserver.start()}function safariDownArrowBug(e){if(!safari||e.state.selection.$head.parentOffset>0)return false;let{focusNode:t,focusOffset:n}=e.domSelectionRange();if(t&&t.nodeType==1&&n==0&&t.firstChild&&t.firstChild.contentEditable=="false"){let n=t.firstChild;switchEditable(e,n,"true");setTimeout((()=>switchEditable(e,n,"false")),20)}return false}function getMods(e){let t="";if(e.ctrlKey)t+="c";if(e.metaKey)t+="m";if(e.altKey)t+="a";if(e.shiftKey)t+="s";return t}function captureKeyDown(e,t){let n=t.keyCode,r=getMods(t);if(n==8||mac$4&&n==72&&r=="c"){return stopNativeHorizontalDelete(e,-1)||skipIgnoredNodes(e,-1)}else if(n==46&&!t.shiftKey||mac$4&&n==68&&r=="c"){return stopNativeHorizontalDelete(e,1)||skipIgnoredNodes(e,1)}else if(n==13||n==27){return true}else if(n==37||mac$4&&n==66&&r=="c"){let t=n==37?findDirection(e,e.state.selection.from)=="ltr"?-1:1:-1;return selectHorizontally(e,t,r)||skipIgnoredNodes(e,t)}else if(n==39||mac$4&&n==70&&r=="c"){let t=n==39?findDirection(e,e.state.selection.from)=="ltr"?1:-1:1;return selectHorizontally(e,t,r)||skipIgnoredNodes(e,t)}else if(n==38||mac$4&&n==80&&r=="c"){return selectVertically(e,-1,r)||skipIgnoredNodes(e,-1)}else if(n==40||mac$4&&n==78&&r=="c"){return safariDownArrowBug(e)||selectVertically(e,1,r)||skipIgnoredNodes(e,1)}else if(r==(mac$4?"m":"c")&&(n==66||n==73||n==89||n==90)){return true}return false}function serializeForClipboard(e,t){e.someProp("transformCopied",(n=>{t=n(t,e)}));let n=[],{content:r,openStart:o,openEnd:i}=t;while(o>1&&i>1&&r.childCount==1&&r.firstChild.childCount==1){o--;i--;let e=r.firstChild;n.push(e.type.name,e.attrs!=e.type.defaultAttrs?e.attrs:null);r=e.content}let s=e.someProp("clipboardSerializer")||DOMSerializer.fromSchema(e.state.schema);let a=detachedDoc(),l=a.createElement("div");l.appendChild(s.serializeFragment(r,{document:a}));let c=l.firstChild,d,u=0;while(c&&c.nodeType==1&&(d=wrapMap[c.nodeName.toLowerCase()])){for(let e=d.length-1;e>=0;e--){let t=a.createElement(d[e]);while(l.firstChild)t.appendChild(l.firstChild);l.appendChild(t);u++}c=l.firstChild}if(c&&c.nodeType==1)c.setAttribute("data-pm-slice",`${o} ${i}${u?` -${u}`:""} ${JSON.stringify(n)}`);let p=e.someProp("clipboardTextSerializer",(n=>n(t,e)))||t.content.textBetween(0,t.content.size,"\n\n");return{dom:l,text:p,slice:t}}function parseFromClipboard(e,t,n,r,o){let i=o.parent.type.spec.code;let s,a;if(!n&&!t)return null;let l=t&&(r||i||!n);if(l){e.someProp("transformPastedText",(n=>{t=n(t,i||r,e)}));if(i)return t?new Slice(Fragment.from(e.state.schema.text(t.replace(/\r\n?/g,"\n"))),0,0):Slice.empty;let n=e.someProp("clipboardTextParser",(n=>n(t,o,r,e)));if(n){a=n}else{let n=o.marks();let{schema:r}=e.state,i=DOMSerializer.fromSchema(r);s=document.createElement("div");t.split(/(?:\r\n?|\n)+/).forEach((e=>{let t=s.appendChild(document.createElement("p"));if(e)t.appendChild(i.serializeNode(r.text(e,n)))}))}}else{e.someProp("transformPastedHTML",(t=>{n=t(n,e)}));s=readHTML(n);if(webkit)restoreReplacedSpaces(s)}let c=s&&s.querySelector("[data-pm-slice]");let d=c&&/^(\d+) (\d+)(?: -(\d+))? (.*)/.exec(c.getAttribute("data-pm-slice")||"");if(d&&d[3])for(let e=+d[3];e>0;e--){let e=s.firstChild;while(e&&e.nodeType!=1)e=e.nextSibling;if(!e)break;s=e}if(!a){let t=e.someProp("clipboardParser")||e.someProp("domParser")||DOMParser.fromSchema(e.state.schema);a=t.parseSlice(s,{preserveWhitespace:!!(l||d),context:o,ruleFromNode(e){if(e.nodeName=="BR"&&!e.nextSibling&&e.parentNode&&!inlineParents.test(e.parentNode.nodeName))return{ignore:true};return null}})}if(d){a=addContext(closeSlice(a,+d[1],+d[2]),d[4])}else{a=Slice.maxOpen(normalizeSiblings(a.content,o),true);if(a.openStart||a.openEnd){let e=0,t=0;for(let t=a.content.firstChild;e<a.openStart&&!t.type.spec.isolating;e++,t=t.firstChild){}for(let e=a.content.lastChild;t<a.openEnd&&!e.type.spec.isolating;t++,e=e.lastChild){}a=closeSlice(a,e,t)}}e.someProp("transformPasted",(t=>{a=t(a,e)}));return a}const inlineParents=/^(a|abbr|acronym|b|cite|code|del|em|i|ins|kbd|label|output|q|ruby|s|samp|span|strong|sub|sup|time|u|tt|var)$/i;function normalizeSiblings(e,t){if(e.childCount<2)return e;for(let n=t.depth;n>=0;n--){let r=t.node(n);let o=r.contentMatchAt(t.index(n));let i,s=[];e.forEach((e=>{if(!s)return;let t=o.findWrapping(e.type),n;if(!t)return s=null;if(n=s.length&&i.length&&addToSibling(t,i,e,s[s.length-1],0)){s[s.length-1]=n}else{if(s.length)s[s.length-1]=closeRight(s[s.length-1],i.length);let n=withWrappers(e,t);s.push(n);o=o.matchType(n.type);i=t}}));if(s)return Fragment.from(s)}return e}function withWrappers(e,t,n=0){for(let r=t.length-1;r>=n;r--)e=t[r].create(null,Fragment.from(e));return e}function addToSibling(e,t,n,r,o){if(o<e.length&&o<t.length&&e[o]==t[o]){let i=addToSibling(e,t,n,r.lastChild,o+1);if(i)return r.copy(r.content.replaceChild(r.childCount-1,i));let s=r.contentMatchAt(r.childCount);if(s.matchType(o==e.length-1?n.type:e[o+1]))return r.copy(r.content.append(Fragment.from(withWrappers(n,e,o+1))))}}function closeRight(e,t){if(t==0)return e;let n=e.content.replaceChild(e.childCount-1,closeRight(e.lastChild,t-1));let r=e.contentMatchAt(e.childCount).fillBefore(Fragment.empty,true);return e.copy(n.append(r))}function closeRange(e,t,n,r,o,i){let s=t<0?e.firstChild:e.lastChild,a=s.content;if(e.childCount>1)i=0;if(o<r-1)a=closeRange(a,t,n,r,o+1,i);if(o>=n)a=t<0?s.contentMatchAt(0).fillBefore(a,i<=o).append(a):a.append(s.contentMatchAt(s.childCount).fillBefore(Fragment.empty,true));return e.replaceChild(t<0?0:e.childCount-1,s.copy(a))}function closeSlice(e,t,n){if(t<e.openStart)e=new Slice(closeRange(e.content,-1,t,e.openStart,0,e.openEnd),t,e.openEnd);if(n<e.openEnd)e=new Slice(closeRange(e.content,1,n,e.openEnd,0,0),e.openStart,n);return e}const wrapMap={thead:["table"],tbody:["table"],tfoot:["table"],caption:["table"],colgroup:["table"],col:["table","colgroup"],tr:["table","tbody"],td:["table","tbody","tr"],th:["table","tbody","tr"]};let _detachedDoc=null;function detachedDoc(){return _detachedDoc||(_detachedDoc=document.implementation.createHTMLDocument("title"))}function readHTML(e){let t=/^(\s*<meta [^>]*>)*/.exec(e);if(t)e=e.slice(t[0].length);let n=detachedDoc().createElement("div");let r=/<([a-z][^>\s]+)/i.exec(e),o;if(o=r&&wrapMap[r[1].toLowerCase()])e=o.map((e=>"<"+e+">")).join("")+e+o.map((e=>"</"+e+">")).reverse().join("");n.innerHTML=e;if(o)for(let e=0;e<o.length;e++)n=n.querySelector(o[e])||n;return n}function restoreReplacedSpaces(e){let t=e.querySelectorAll(chrome?"span:not([class]):not([style])":"span.Apple-converted-space");for(let n=0;n<t.length;n++){let r=t[n];if(r.childNodes.length==1&&r.textContent==""&&r.parentNode)r.parentNode.replaceChild(e.ownerDocument.createTextNode(" "),r)}}function addContext(e,t){if(!e.size)return e;let n=e.content.firstChild.type.schema,r;try{r=JSON.parse(t)}catch(t){return e}let{content:o,openStart:i,openEnd:s}=e;for(let e=r.length-2;e>=0;e-=2){let t=n.nodes[r[e]];if(!t||t.hasRequiredAttrs())break;o=Fragment.from(t.create(r[e+1],o));i++;s++}return new Slice(o,i,s)}const handlers={};const editHandlers={};const passiveHandlers={touchstart:true,touchmove:true};class InputState{constructor(){this.shiftKey=false;this.mouseDown=null;this.lastKeyCode=null;this.lastKeyCodeTime=0;this.lastClick={time:0,x:0,y:0,type:""};this.lastSelectionOrigin=null;this.lastSelectionTime=0;this.lastIOSEnter=0;this.lastIOSEnterFallbackTimeout=-1;this.lastFocus=0;this.lastTouch=0;this.lastAndroidDelete=0;this.composing=false;this.compositionNode=null;this.composingTimeout=-1;this.compositionNodes=[];this.compositionEndedAt=-2e8;this.compositionID=1;this.compositionPendingChanges=0;this.domChangeCount=0;this.eventHandlers=Object.create(null);this.hideSelectionGuard=null}}function initInput(e){for(let t in handlers){let n=handlers[t];e.dom.addEventListener(t,e.input.eventHandlers[t]=t=>{if(eventBelongsToView(e,t)&&!runCustomHandler(e,t)&&(e.editable||!(t.type in editHandlers)))n(e,t)},passiveHandlers[t]?{passive:true}:undefined)}if(safari)e.dom.addEventListener("input",(()=>null));ensureListeners(e)}function setSelectionOrigin(e,t){e.input.lastSelectionOrigin=t;e.input.lastSelectionTime=Date.now()}function destroyInput(e){e.domObserver.stop();for(let t in e.input.eventHandlers)e.dom.removeEventListener(t,e.input.eventHandlers[t]);clearTimeout(e.input.composingTimeout);clearTimeout(e.input.lastIOSEnterFallbackTimeout)}function ensureListeners(e){e.someProp("handleDOMEvents",(t=>{for(let n in t)if(!e.input.eventHandlers[n])e.dom.addEventListener(n,e.input.eventHandlers[n]=t=>runCustomHandler(e,t))}))}function runCustomHandler(e,t){return e.someProp("handleDOMEvents",(n=>{let r=n[t.type];return r?r(e,t)||t.defaultPrevented:false}))}function eventBelongsToView(e,t){if(!t.bubbles)return true;if(t.defaultPrevented)return false;for(let n=t.target;n!=e.dom;n=n.parentNode)if(!n||n.nodeType==11||n.pmViewDesc&&n.pmViewDesc.stopEvent(t))return false;return true}function dispatchEvent(e,t){if(!runCustomHandler(e,t)&&handlers[t.type]&&(e.editable||!(t.type in editHandlers)))handlers[t.type](e,t)}editHandlers.keydown=(e,t)=>{let n=t;e.input.shiftKey=n.keyCode==16||n.shiftKey;if(inOrNearComposition(e,n))return;e.input.lastKeyCode=n.keyCode;e.input.lastKeyCodeTime=Date.now();if(android&&chrome&&n.keyCode==13)return;if(n.keyCode!=229)e.domObserver.forceFlush();if(ios&&n.keyCode==13&&!n.ctrlKey&&!n.altKey&&!n.metaKey){let t=Date.now();e.input.lastIOSEnter=t;e.input.lastIOSEnterFallbackTimeout=setTimeout((()=>{if(e.input.lastIOSEnter==t){e.someProp("handleKeyDown",(t=>t(e,keyEvent(13,"Enter"))));e.input.lastIOSEnter=0}}),200)}else if(e.someProp("handleKeyDown",(t=>t(e,n)))||captureKeyDown(e,n)){n.preventDefault()}else{setSelectionOrigin(e,"key")}};editHandlers.keyup=(e,t)=>{if(t.keyCode==16)e.input.shiftKey=false};editHandlers.keypress=(e,t)=>{let n=t;if(inOrNearComposition(e,n)||!n.charCode||n.ctrlKey&&!n.altKey||mac$4&&n.metaKey)return;if(e.someProp("handleKeyPress",(t=>t(e,n)))){n.preventDefault();return}let r=e.state.selection;if(!(r instanceof TextSelection)||!r.$from.sameParent(r.$to)){let t=String.fromCharCode(n.charCode);if(!/[\r\n]/.test(t)&&!e.someProp("handleTextInput",(n=>n(e,r.$from.pos,r.$to.pos,t))))e.dispatch(e.state.tr.insertText(t).scrollIntoView());n.preventDefault()}};function eventCoords(e){return{left:e.clientX,top:e.clientY}}function isNear(e,t){let n=t.x-e.clientX,r=t.y-e.clientY;return n*n+r*r<100}function runHandlerOnContext(e,t,n,r,o){if(r==-1)return false;let i=e.state.doc.resolve(r);for(let r=i.depth+1;r>0;r--){if(e.someProp(t,(t=>r>i.depth?t(e,n,i.nodeAfter,i.before(r),o,true):t(e,n,i.node(r),i.before(r),o,false))))return true}return false}function updateSelection(e,t,n){if(!e.focused)e.focus();if(e.state.selection.eq(t))return;let r=e.state.tr.setSelection(t);r.setMeta("pointer",true);e.dispatch(r)}function selectClickedLeaf(e,t){if(t==-1)return false;let n=e.state.doc.resolve(t),r=n.nodeAfter;if(r&&r.isAtom&&NodeSelection.isSelectable(r)){updateSelection(e,new NodeSelection(n));return true}return false}function selectClickedNode(e,t){if(t==-1)return false;let n=e.state.selection,r,o;if(n instanceof NodeSelection)r=n.node;let i=e.state.doc.resolve(t);for(let e=i.depth+1;e>0;e--){let t=e>i.depth?i.nodeAfter:i.node(e);if(NodeSelection.isSelectable(t)){if(r&&n.$from.depth>0&&e>=n.$from.depth&&i.before(n.$from.depth+1)==n.$from.pos)o=i.before(n.$from.depth);else o=i.before(e);break}}if(o!=null){updateSelection(e,NodeSelection.create(e.state.doc,o));return true}else{return false}}function handleSingleClick(e,t,n,r,o){return runHandlerOnContext(e,"handleClickOn",t,n,r)||e.someProp("handleClick",(n=>n(e,t,r)))||(o?selectClickedNode(e,n):selectClickedLeaf(e,n))}function handleDoubleClick(e,t,n,r){return runHandlerOnContext(e,"handleDoubleClickOn",t,n,r)||e.someProp("handleDoubleClick",(n=>n(e,t,r)))}function handleTripleClick$1(e,t,n,r){return runHandlerOnContext(e,"handleTripleClickOn",t,n,r)||e.someProp("handleTripleClick",(n=>n(e,t,r)))||defaultTripleClick(e,n,r)}function defaultTripleClick(e,t,n){if(n.button!=0)return false;let r=e.state.doc;if(t==-1){if(r.inlineContent){updateSelection(e,TextSelection.create(r,0,r.content.size));return true}return false}let o=r.resolve(t);for(let t=o.depth+1;t>0;t--){let n=t>o.depth?o.nodeAfter:o.node(t);let i=o.before(t);if(n.inlineContent)updateSelection(e,TextSelection.create(r,i+1,i+1+n.content.size));else if(NodeSelection.isSelectable(n))updateSelection(e,NodeSelection.create(r,i));else continue;return true}}function forceDOMFlush(e){return endComposition(e)}const selectNodeModifier=mac$4?"metaKey":"ctrlKey";handlers.mousedown=(e,t)=>{let n=t;e.input.shiftKey=n.shiftKey;let r=forceDOMFlush(e);let o=Date.now(),i="singleClick";if(o-e.input.lastClick.time<500&&isNear(n,e.input.lastClick)&&!n[selectNodeModifier]){if(e.input.lastClick.type=="singleClick")i="doubleClick";else if(e.input.lastClick.type=="doubleClick")i="tripleClick"}e.input.lastClick={time:o,x:n.clientX,y:n.clientY,type:i};let s=e.posAtCoords(eventCoords(n));if(!s)return;if(i=="singleClick"){if(e.input.mouseDown)e.input.mouseDown.done();e.input.mouseDown=new MouseDown(e,s,n,!!r)}else if((i=="doubleClick"?handleDoubleClick:handleTripleClick$1)(e,s.pos,s.inside,n)){n.preventDefault()}else{setSelectionOrigin(e,"pointer")}};class MouseDown{constructor(e,t,n,r){this.view=e;this.pos=t;this.event=n;this.flushed=r;this.delayedSelectionSync=false;this.mightDrag=null;this.startDoc=e.state.doc;this.selectNode=!!n[selectNodeModifier];this.allowDefault=n.shiftKey;let o,i;if(t.inside>-1){o=e.state.doc.nodeAt(t.inside);i=t.inside}else{let n=e.state.doc.resolve(t.pos);o=n.parent;i=n.depth?n.before():0}const s=r?null:n.target;const a=s?e.docView.nearestDesc(s,true):null;this.target=a&&a.dom.nodeType==1?a.dom:null;let{selection:l}=e.state;if(n.button==0&&o.type.spec.draggable&&o.type.spec.selectable!==false||l instanceof NodeSelection&&l.from<=i&&l.to>i)this.mightDrag={node:o,pos:i,addAttr:!!(this.target&&!this.target.draggable),setUneditable:!!(this.target&&gecko&&!this.target.hasAttribute("contentEditable"))};if(this.target&&this.mightDrag&&(this.mightDrag.addAttr||this.mightDrag.setUneditable)){this.view.domObserver.stop();if(this.mightDrag.addAttr)this.target.draggable=true;if(this.mightDrag.setUneditable)setTimeout((()=>{if(this.view.input.mouseDown==this)this.target.setAttribute("contentEditable","false")}),20);this.view.domObserver.start()}e.root.addEventListener("mouseup",this.up=this.up.bind(this));e.root.addEventListener("mousemove",this.move=this.move.bind(this));setSelectionOrigin(e,"pointer")}done(){this.view.root.removeEventListener("mouseup",this.up);this.view.root.removeEventListener("mousemove",this.move);if(this.mightDrag&&this.target){this.view.domObserver.stop();if(this.mightDrag.addAttr)this.target.removeAttribute("draggable");if(this.mightDrag.setUneditable)this.target.removeAttribute("contentEditable");this.view.domObserver.start()}if(this.delayedSelectionSync)setTimeout((()=>selectionToDOM(this.view)));this.view.input.mouseDown=null}up(e){this.done();if(!this.view.dom.contains(e.target))return;let t=this.pos;if(this.view.state.doc!=this.startDoc)t=this.view.posAtCoords(eventCoords(e));this.updateAllowDefault(e);if(this.allowDefault||!t){setSelectionOrigin(this.view,"pointer")}else if(handleSingleClick(this.view,t.pos,t.inside,e,this.selectNode)){e.preventDefault()}else if(e.button==0&&(this.flushed||safari&&this.mightDrag&&!this.mightDrag.node.isAtom||chrome&&!this.view.state.selection.visible&&Math.min(Math.abs(t.pos-this.view.state.selection.from),Math.abs(t.pos-this.view.state.selection.to))<=2)){updateSelection(this.view,Selection.near(this.view.state.doc.resolve(t.pos)));e.preventDefault()}else{setSelectionOrigin(this.view,"pointer")}}move(e){this.updateAllowDefault(e);setSelectionOrigin(this.view,"pointer");if(e.buttons==0)this.done()}updateAllowDefault(e){if(!this.allowDefault&&(Math.abs(this.event.x-e.clientX)>4||Math.abs(this.event.y-e.clientY)>4))this.allowDefault=true}}handlers.touchstart=e=>{e.input.lastTouch=Date.now();forceDOMFlush(e);setSelectionOrigin(e,"pointer")};handlers.touchmove=e=>{e.input.lastTouch=Date.now();setSelectionOrigin(e,"pointer")};handlers.contextmenu=e=>forceDOMFlush(e);function inOrNearComposition(e,t){if(e.composing)return true;if(safari&&Math.abs(t.timeStamp-e.input.compositionEndedAt)<500){e.input.compositionEndedAt=-2e8;return true}return false}const timeoutComposition=android?5e3:-1;editHandlers.compositionstart=editHandlers.compositionupdate=e=>{if(!e.composing){e.domObserver.flush();let{state:t}=e,n=t.selection.$to;if(t.selection instanceof TextSelection&&(t.storedMarks||!n.textOffset&&n.parentOffset&&n.nodeBefore.marks.some((e=>e.type.spec.inclusive===false)))){e.markCursor=e.state.storedMarks||n.marks();endComposition(e,true);e.markCursor=null}else{endComposition(e);if(gecko&&t.selection.empty&&n.parentOffset&&!n.textOffset&&n.nodeBefore.marks.length){let t=e.domSelectionRange();for(let n=t.focusNode,r=t.focusOffset;n&&n.nodeType==1&&r!=0;){let t=r<0?n.lastChild:n.childNodes[r-1];if(!t)break;if(t.nodeType==3){let n=e.domSelection();if(n)n.collapse(t,t.nodeValue.length);break}else{n=t;r=-1}}}}e.input.composing=true}scheduleComposeEnd(e,timeoutComposition)};editHandlers.compositionend=(e,t)=>{if(e.composing){e.input.composing=false;e.input.compositionEndedAt=t.timeStamp;e.input.compositionPendingChanges=e.domObserver.pendingRecords().length?e.input.compositionID:0;e.input.compositionNode=null;if(e.input.compositionPendingChanges)Promise.resolve().then((()=>e.domObserver.flush()));e.input.compositionID++;scheduleComposeEnd(e,20)}};function scheduleComposeEnd(e,t){clearTimeout(e.input.composingTimeout);if(t>-1)e.input.composingTimeout=setTimeout((()=>endComposition(e)),t)}function clearComposition(e){if(e.composing){e.input.composing=false;e.input.compositionEndedAt=timestampFromCustomEvent()}while(e.input.compositionNodes.length>0)e.input.compositionNodes.pop().markParentsDirty()}function findCompositionNode(e){let t=e.domSelectionRange();if(!t.focusNode)return null;let n=textNodeBefore$1(t.focusNode,t.focusOffset);let r=textNodeAfter$1(t.focusNode,t.focusOffset);if(n&&r&&n!=r){let t=r.pmViewDesc,o=e.domObserver.lastChangedTextNode;if(n==o||r==o)return o;if(!t||!t.isText(r.nodeValue)){return r}else if(e.input.compositionNode==r){let e=n.pmViewDesc;if(!(!e||!e.isText(n.nodeValue)))return r}}return n||r}function timestampFromCustomEvent(){let e=document.createEvent("Event");e.initEvent("event",true,true);return e.timeStamp}function endComposition(e,t=false){if(android&&e.domObserver.flushingSoon>=0)return;e.domObserver.forceFlush();clearComposition(e);if(t||e.docView&&e.docView.dirty){let t=selectionFromDOM(e);if(t&&!t.eq(e.state.selection))e.dispatch(e.state.tr.setSelection(t));else e.updateState(e.state);return true}return false}function captureCopy(e,t){if(!e.dom.parentNode)return;let n=e.dom.parentNode.appendChild(document.createElement("div"));n.appendChild(t);n.style.cssText="position: fixed; left: -10000px; top: 10px";let r=getSelection(),o=document.createRange();o.selectNodeContents(t);e.dom.blur();r.removeAllRanges();r.addRange(o);setTimeout((()=>{if(n.parentNode)n.parentNode.removeChild(n);e.focus()}),50)}const brokenClipboardAPI=ie$1&&ie_version<15||ios&&webkit_version<604;handlers.copy=editHandlers.cut=(e,t)=>{let n=t;let r=e.state.selection,o=n.type=="cut";if(r.empty)return;let i=brokenClipboardAPI?null:n.clipboardData;let s=r.content(),{dom:a,text:l}=serializeForClipboard(e,s);if(i){n.preventDefault();i.clearData();i.setData("text/html",a.innerHTML);i.setData("text/plain",l)}else{captureCopy(e,a)}if(o)e.dispatch(e.state.tr.deleteSelection().scrollIntoView().setMeta("uiEvent","cut"))};function sliceSingleNode(e){return e.openStart==0&&e.openEnd==0&&e.content.childCount==1?e.content.firstChild:null}function capturePaste(e,t){if(!e.dom.parentNode)return;let n=e.input.shiftKey||e.state.selection.$from.parent.type.spec.code;let r=e.dom.parentNode.appendChild(document.createElement(n?"textarea":"div"));if(!n)r.contentEditable="true";r.style.cssText="position: fixed; left: -10000px; top: 10px";r.focus();let o=e.input.shiftKey&&e.input.lastKeyCode!=45;setTimeout((()=>{e.focus();if(r.parentNode)r.parentNode.removeChild(r);if(n)doPaste(e,r.value,null,o,t);else doPaste(e,r.textContent,r.innerHTML,o,t)}),50)}function doPaste(e,t,n,r,o){let i=parseFromClipboard(e,t,n,r,e.state.selection.$from);if(e.someProp("handlePaste",(t=>t(e,o,i||Slice.empty))))return true;if(!i)return false;let s=sliceSingleNode(i);let a=s?e.state.tr.replaceSelectionWith(s,r):e.state.tr.replaceSelection(i);e.dispatch(a.scrollIntoView().setMeta("paste",true).setMeta("uiEvent","paste"));hurmet.updateCalculations(e,e.state.schema.nodes.calculation,true);return true}function getText(e){let t=e.getData("text/plain")||e.getData("Text");if(t)return t;let n=e.getData("text/uri-list");return n?n.replace(/\r?\n/g," "):""}editHandlers.paste=(e,t)=>{let n=t;if(e.composing&&!android)return;let r=brokenClipboardAPI?null:n.clipboardData;let o=e.input.shiftKey&&e.input.lastKeyCode!=45;if(r&&doPaste(e,getText(r),r.getData("text/html"),o,n))n.preventDefault();else capturePaste(e,n)};class Dragging{constructor(e,t,n){this.slice=e;this.move=t;this.node=n}}const dragCopyModifier=mac$4?"altKey":"ctrlKey";handlers.dragstart=(e,t)=>{let n=t;let r=e.input.mouseDown;if(r)r.done();if(!n.dataTransfer)return;let o=e.state.selection;let i=o.empty?null:e.posAtCoords(eventCoords(n));let s;if(i&&i.pos>=o.from&&i.pos<=(o instanceof NodeSelection?o.to-1:o.to));else if(r&&r.mightDrag){s=NodeSelection.create(e.state.doc,r.mightDrag.pos)}else if(n.target&&n.target.nodeType==1){let t=e.docView.nearestDesc(n.target,true);if(t&&t.node.type.spec.draggable&&t!=e.docView)s=NodeSelection.create(e.state.doc,t.posBefore)}let a=(s||e.state.selection).content();let{dom:l,text:c,slice:d}=serializeForClipboard(e,a);if(!n.dataTransfer.files.length||!chrome||chrome_version>120)n.dataTransfer.clearData();n.dataTransfer.setData(brokenClipboardAPI?"Text":"text/html",l.innerHTML);n.dataTransfer.effectAllowed="copyMove";if(!brokenClipboardAPI)n.dataTransfer.setData("text/plain",c);e.dragging=new Dragging(d,!n[dragCopyModifier],s)};handlers.dragend=e=>{let t=e.dragging;window.setTimeout((()=>{if(e.dragging==t)e.dragging=null}),50)};editHandlers.dragover=editHandlers.dragenter=(e,t)=>t.preventDefault();editHandlers.drop=(e,t)=>{let n=t;let r=e.dragging;e.dragging=null;if(!n.dataTransfer)return;let o=e.posAtCoords(eventCoords(n));if(!o)return;let i=e.state.doc.resolve(o.pos);let s=r&&r.slice;if(s){e.someProp("transformPasted",(t=>{s=t(s,e)}))}else{s=parseFromClipboard(e,getText(n.dataTransfer),brokenClipboardAPI?null:n.dataTransfer.getData("text/html"),false,i)}let a=!!(r&&!n[dragCopyModifier]);if(e.someProp("handleDrop",(t=>t(e,n,s||Slice.empty,a)))){n.preventDefault();return}if(!s)return;n.preventDefault();let l=s?dropPoint(e.state.doc,i.pos,s):i.pos;if(l==null)l=i.pos;let c=e.state.tr;if(a){let{node:e}=r;if(e)e.replace(c);else c.deleteSelection()}let d=c.mapping.map(l);let u=s.openStart==0&&s.openEnd==0&&s.content.childCount==1;let p=c.doc;if(u)c.replaceRangeWith(d,d,s.content.firstChild);else c.replaceRange(d,d,s);if(c.doc.eq(p))return;let f=c.doc.resolve(d);if(u&&NodeSelection.isSelectable(s.content.firstChild)&&f.nodeAfter&&f.nodeAfter.sameMarkup(s.content.firstChild)){c.setSelection(new NodeSelection(f))}else{let t=c.mapping.map(l);c.mapping.maps[c.mapping.maps.length-1].forEach(((e,n,r,o)=>t=o));c.setSelection(selectionBetween(e,f,c.doc.resolve(t)))}e.focus();e.dispatch(c.setMeta("uiEvent","drop"))};handlers.focus=e=>{e.input.lastFocus=Date.now();if(!e.focused){e.domObserver.stop();e.dom.classList.add("ProseMirror-focused");e.domObserver.start();e.focused=true;setTimeout((()=>{if(e.docView&&e.hasFocus()&&!e.domObserver.currentSelection.eq(e.domSelectionRange()))selectionToDOM(e)}),20)}};handlers.blur=(e,t)=>{let n=t;if(e.focused){e.domObserver.stop();e.dom.classList.remove("ProseMirror-focused");e.domObserver.start();if(n.relatedTarget&&e.dom.contains(n.relatedTarget))e.domObserver.currentSelection.clear();e.focused=false}};handlers.beforeinput=(e,t)=>{let n=t;if(chrome&&android&&n.inputType=="deleteContentBackward"){e.domObserver.flushSoon();let{domChangeCount:t}=e.input;setTimeout((()=>{if(e.input.domChangeCount!=t)return;e.dom.blur();e.focus();if(e.someProp("handleKeyDown",(t=>t(e,keyEvent(8,"Backspace")))))return;let{$cursor:n}=e.state.selection;if(n&&n.pos>0)e.dispatch(e.state.tr.delete(n.pos-1,n.pos).scrollIntoView())}),50)}};for(let e in editHandlers)handlers[e]=editHandlers[e];function compareObjs(e,t){if(e==t)return true;for(let n in e)if(e[n]!==t[n])return false;for(let n in t)if(!(n in e))return false;return true}class WidgetType{constructor(e,t){this.toDOM=e;this.spec=t||noSpec;this.side=this.spec.side||0}map(e,t,n,r){let{pos:o,deleted:i}=e.mapResult(t.from+r,this.side<0?-1:1);return i?null:new Decoration(o-n,o-n,this)}valid(){return true}eq(e){return this==e||e instanceof WidgetType&&(this.spec.key&&this.spec.key==e.spec.key||this.toDOM==e.toDOM&&compareObjs(this.spec,e.spec))}destroy(e){if(this.spec.destroy)this.spec.destroy(e)}}class InlineType{constructor(e,t){this.attrs=e;this.spec=t||noSpec}map(e,t,n,r){let o=e.map(t.from+r,this.spec.inclusiveStart?-1:1)-n;let i=e.map(t.to+r,this.spec.inclusiveEnd?1:-1)-n;return o>=i?null:new Decoration(o,i,this)}valid(e,t){return t.from<t.to}eq(e){return this==e||e instanceof InlineType&&compareObjs(this.attrs,e.attrs)&&compareObjs(this.spec,e.spec)}static is(e){return e.type instanceof InlineType}destroy(){}}class NodeType{constructor(e,t){this.attrs=e;this.spec=t||noSpec}map(e,t,n,r){let o=e.mapResult(t.from+r,1);if(o.deleted)return null;let i=e.mapResult(t.to+r,-1);if(i.deleted||i.pos<=o.pos)return null;return new Decoration(o.pos-n,i.pos-n,this)}valid(e,t){let{index:n,offset:r}=e.content.findIndex(t.from),o;return r==t.from&&!(o=e.child(n)).isText&&r+o.nodeSize==t.to}eq(e){return this==e||e instanceof NodeType&&compareObjs(this.attrs,e.attrs)&&compareObjs(this.spec,e.spec)}destroy(){}}class Decoration{constructor(e,t,n){this.from=e;this.to=t;this.type=n}copy(e,t){return new Decoration(e,t,this.type)}eq(e,t=0){return this.type.eq(e.type)&&this.from+t==e.from&&this.to+t==e.to}map(e,t,n){return this.type.map(e,this,t,n)}static widget(e,t,n){return new Decoration(e,e,new WidgetType(t,n))}static inline(e,t,n,r){return new Decoration(e,t,new InlineType(n,r))}static node(e,t,n,r){return new Decoration(e,t,new NodeType(n,r))}get spec(){return this.type.spec}get inline(){return this.type instanceof InlineType}get widget(){return this.type instanceof WidgetType}}const none=[],noSpec={};class DecorationSet{constructor(e,t){this.local=e.length?e:none;this.children=t.length?t:none}static create(e,t){return t.length?buildTree(t,e,0,noSpec):empty}find(e,t,n){let r=[];this.findInner(e==null?0:e,t==null?1e9:t,r,0,n);return r}findInner(e,t,n,r,o){for(let i=0;i<this.local.length;i++){let s=this.local[i];if(s.from<=t&&s.to>=e&&(!o||o(s.spec)))n.push(s.copy(s.from+r,s.to+r))}for(let i=0;i<this.children.length;i+=3){if(this.children[i]<t&&this.children[i+1]>e){let s=this.children[i]+1;this.children[i+2].findInner(e-s,t-s,n,r+s,o)}}}map(e,t,n){if(this==empty||e.maps.length==0)return this;return this.mapInner(e,t,0,0,n||noSpec)}mapInner(e,t,n,r,o){let i;for(let s=0;s<this.local.length;s++){let a=this.local[s].map(e,n,r);if(a&&a.type.valid(t,a))(i||(i=[])).push(a);else if(o.onRemove)o.onRemove(this.local[s].spec)}if(this.children.length)return mapChildren(this.children,i||[],e,t,n,r,o);else return i?new DecorationSet(i.sort(byPos),none):empty}add(e,t){if(!t.length)return this;if(this==empty)return DecorationSet.create(e,t);return this.addInner(e,t,0)}addInner(e,t,n){let r,o=0;e.forEach(((e,i)=>{let s=i+n,a;if(!(a=takeSpansForNode(t,e,s)))return;if(!r)r=this.children.slice();while(o<r.length&&r[o]<i)o+=3;if(r[o]==i)r[o+2]=r[o+2].addInner(e,a,s+1);else r.splice(o,0,i,i+e.nodeSize,buildTree(a,e,s+1,noSpec));o+=3}));let i=moveSpans(o?withoutNulls(t):t,-n);for(let t=0;t<i.length;t++)if(!i[t].type.valid(e,i[t]))i.splice(t--,1);return new DecorationSet(i.length?this.local.concat(i).sort(byPos):this.local,r||this.children)}remove(e){if(e.length==0||this==empty)return this;return this.removeInner(e,0)}removeInner(e,t){let n=this.children,r=this.local;for(let r=0;r<n.length;r+=3){let o;let i=n[r]+t,s=n[r+1]+t;for(let t=0,n;t<e.length;t++)if(n=e[t]){if(n.from>i&&n.to<s){e[t]=null;(o||(o=[])).push(n)}}if(!o)continue;if(n==this.children)n=this.children.slice();let a=n[r+2].removeInner(o,i+1);if(a!=empty){n[r+2]=a}else{n.splice(r,3);r-=3}}if(r.length)for(let n=0,o;n<e.length;n++)if(o=e[n]){for(let e=0;e<r.length;e++)if(r[e].eq(o,t)){if(r==this.local)r=this.local.slice();r.splice(e--,1)}}if(n==this.children&&r==this.local)return this;return r.length||n.length?new DecorationSet(r,n):empty}forChild(e,t){if(this==empty)return this;if(t.isLeaf)return DecorationSet.empty;let n,r;for(let t=0;t<this.children.length;t+=3)if(this.children[t]>=e){if(this.children[t]==e)n=this.children[t+2];break}let o=e+1,i=o+t.content.size;for(let e=0;e<this.local.length;e++){let t=this.local[e];if(t.from<i&&t.to>o&&t.type instanceof InlineType){let e=Math.max(o,t.from)-o,n=Math.min(i,t.to)-o;if(e<n)(r||(r=[])).push(t.copy(e,n))}}if(r){let e=new DecorationSet(r.sort(byPos),none);return n?new DecorationGroup([e,n]):e}return n||empty}eq(e){if(this==e)return true;if(!(e instanceof DecorationSet)||this.local.length!=e.local.length||this.children.length!=e.children.length)return false;for(let t=0;t<this.local.length;t++)if(!this.local[t].eq(e.local[t]))return false;for(let t=0;t<this.children.length;t+=3)if(this.children[t]!=e.children[t]||this.children[t+1]!=e.children[t+1]||!this.children[t+2].eq(e.children[t+2]))return false;return true}locals(e){return removeOverlap(this.localsInner(e))}localsInner(e){if(this==empty)return none;if(e.inlineContent||!this.local.some(InlineType.is))return this.local;let t=[];for(let e=0;e<this.local.length;e++){if(!(this.local[e].type instanceof InlineType))t.push(this.local[e])}return t}}DecorationSet.empty=new DecorationSet([],[]);DecorationSet.removeOverlap=removeOverlap;const empty=DecorationSet.empty;class DecorationGroup{constructor(e){this.members=e}map(e,t){const n=this.members.map((n=>n.map(e,t,noSpec)));return DecorationGroup.from(n)}forChild(e,t){if(t.isLeaf)return DecorationSet.empty;let n=[];for(let r=0;r<this.members.length;r++){let o=this.members[r].forChild(e,t);if(o==empty)continue;if(o instanceof DecorationGroup)n=n.concat(o.members);else n.push(o)}return DecorationGroup.from(n)}eq(e){if(!(e instanceof DecorationGroup)||e.members.length!=this.members.length)return false;for(let t=0;t<this.members.length;t++)if(!this.members[t].eq(e.members[t]))return false;return true}locals(e){let t,n=true;for(let r=0;r<this.members.length;r++){let o=this.members[r].localsInner(e);if(!o.length)continue;if(!t){t=o}else{if(n){t=t.slice();n=false}for(let e=0;e<o.length;e++)t.push(o[e])}}return t?removeOverlap(n?t:t.sort(byPos)):none}static from(e){switch(e.length){case 0:return empty;case 1:return e[0];default:return new DecorationGroup(e.every((e=>e instanceof DecorationSet))?e:e.reduce(((e,t)=>e.concat(t instanceof DecorationSet?t:t.members)),[]))}}}function mapChildren(e,t,n,r,o,i,s){let a=e.slice();for(let e=0,t=i;e<n.maps.length;e++){let r=0;n.maps[e].forEach(((e,n,o,i)=>{let s=i-o-(n-e);for(let o=0;o<a.length;o+=3){let i=a[o+1];if(i<0||e>i+t-r)continue;let l=a[o]+t-r;if(n>=l){a[o+1]=e<=l?-2:-1}else if(e>=t&&s){a[o]+=s;a[o+1]+=s}}r+=s}));t=n.maps[e].map(t,-1)}let l=false;for(let t=0;t<a.length;t+=3)if(a[t+1]<0){if(a[t+1]==-2){l=true;a[t+1]=-1;continue}let c=n.map(e[t]+i),d=c-o;if(d<0||d>=r.content.size){l=true;continue}let u=n.map(e[t+1]+i,-1),p=u-o;let{index:f,offset:h}=r.content.findIndex(d);let m=r.maybeChild(f);if(m&&h==d&&h+m.nodeSize==p){let r=a[t+2].mapInner(n,m,c+1,e[t]+i+1,s);if(r!=empty){a[t]=d;a[t+1]=p;a[t+2]=r}else{a[t+1]=-2;l=true}}else{l=true}}if(l){let l=mapAndGatherRemainingDecorations(a,e,t,n,o,i,s);let c=buildTree(l,r,0,s);t=c.local;for(let e=0;e<a.length;e+=3)if(a[e+1]<0){a.splice(e,3);e-=3}for(let e=0,t=0;e<c.children.length;e+=3){let n=c.children[e];while(t<a.length&&a[t]<n)t+=3;a.splice(t,0,c.children[e],c.children[e+1],c.children[e+2])}}return new DecorationSet(t.sort(byPos),a)}function moveSpans(e,t){if(!t||!e.length)return e;let n=[];for(let r=0;r<e.length;r++){let o=e[r];n.push(new Decoration(o.from+t,o.to+t,o.type))}return n}function mapAndGatherRemainingDecorations(e,t,n,r,o,i,s){function a(e,t){for(let i=0;i<e.local.length;i++){let a=e.local[i].map(r,o,t);if(a)n.push(a);else if(s.onRemove)s.onRemove(e.local[i].spec)}for(let n=0;n<e.children.length;n+=3)a(e.children[n+2],e.children[n]+t+1)}for(let n=0;n<e.length;n+=3)if(e[n+1]==-1)a(e[n+2],t[n]+i+1);return n}function takeSpansForNode(e,t,n){if(t.isLeaf)return null;let r=n+t.nodeSize,o=null;for(let t=0,i;t<e.length;t++){if((i=e[t])&&i.from>n&&i.to<r){(o||(o=[])).push(i);e[t]=null}}return o}function withoutNulls(e){let t=[];for(let n=0;n<e.length;n++)if(e[n]!=null)t.push(e[n]);return t}function buildTree(e,t,n,r){let o=[],i=false;t.forEach(((t,s)=>{let a=takeSpansForNode(e,t,s+n);if(a){i=true;let e=buildTree(a,t,n+s+1,r);if(e!=empty)o.push(s,s+t.nodeSize,e)}}));let s=moveSpans(i?withoutNulls(e):e,-n).sort(byPos);for(let e=0;e<s.length;e++)if(!s[e].type.valid(t,s[e])){if(r.onRemove)r.onRemove(s[e].spec);s.splice(e--,1)}return s.length||o.length?new DecorationSet(s,o):empty}function byPos(e,t){return e.from-t.from||e.to-t.to}function removeOverlap(e){let t=e;for(let n=0;n<t.length-1;n++){let r=t[n];if(r.from!=r.to)for(let o=n+1;o<t.length;o++){let i=t[o];if(i.from==r.from){if(i.to!=r.to){if(t==e)t=e.slice();t[o]=i.copy(i.from,r.to);insertAhead(t,o+1,i.copy(r.to,i.to))}continue}else{if(i.from<r.to){if(t==e)t=e.slice();t[n]=r.copy(r.from,i.from);insertAhead(t,o,r.copy(i.from,r.to))}break}}}return t}function insertAhead(e,t,n){while(t<e.length&&byPos(n,e[t])>0)t++;e.splice(t,0,n)}function viewDecorations(e){let t=[];e.someProp("decorations",(n=>{let r=n(e.state);if(r&&r!=empty)t.push(r)}));if(e.cursorWrapper)t.push(DecorationSet.create(e.state.doc,[e.cursorWrapper.deco]));return DecorationGroup.from(t)}const observeOptions={childList:true,characterData:true,characterDataOldValue:true,attributes:true,attributeOldValue:true,subtree:true};const useCharData=ie$1&&ie_version<=11;class SelectionState{constructor(){this.anchorNode=null;this.anchorOffset=0;this.focusNode=null;this.focusOffset=0}set(e){this.anchorNode=e.anchorNode;this.anchorOffset=e.anchorOffset;this.focusNode=e.focusNode;this.focusOffset=e.focusOffset}clear(){this.anchorNode=this.focusNode=null}eq(e){return e.anchorNode==this.anchorNode&&e.anchorOffset==this.anchorOffset&&e.focusNode==this.focusNode&&e.focusOffset==this.focusOffset}}class DOMObserver{constructor(e,t){this.view=e;this.handleDOMChange=t;this.queue=[];this.flushingSoon=-1;this.observer=null;this.currentSelection=new SelectionState;this.onCharData=null;this.suppressingSelectionUpdates=false;this.lastChangedTextNode=null;this.observer=window.MutationObserver&&new window.MutationObserver((e=>{for(let t=0;t<e.length;t++)this.queue.push(e[t]);if(ie$1&&ie_version<=11&&e.some((e=>e.type=="childList"&&e.removedNodes.length||e.type=="characterData"&&e.oldValue.length>e.target.nodeValue.length)))this.flushSoon();else this.flush()}));if(useCharData){this.onCharData=e=>{this.queue.push({target:e.target,type:"characterData",oldValue:e.prevValue});this.flushSoon()}}this.onSelectionChange=this.onSelectionChange.bind(this)}flushSoon(){if(this.flushingSoon<0)this.flushingSoon=window.setTimeout((()=>{this.flushingSoon=-1;this.flush()}),20)}forceFlush(){if(this.flushingSoon>-1){window.clearTimeout(this.flushingSoon);this.flushingSoon=-1;this.flush()}}start(){if(this.observer){this.observer.takeRecords();this.observer.observe(this.view.dom,observeOptions)}if(this.onCharData)this.view.dom.addEventListener("DOMCharacterDataModified",this.onCharData);this.connectSelection()}stop(){if(this.observer){let e=this.observer.takeRecords();if(e.length){for(let t=0;t<e.length;t++)this.queue.push(e[t]);window.setTimeout((()=>this.flush()),20)}this.observer.disconnect()}if(this.onCharData)this.view.dom.removeEventListener("DOMCharacterDataModified",this.onCharData);this.disconnectSelection()}connectSelection(){this.view.dom.ownerDocument.addEventListener("selectionchange",this.onSelectionChange)}disconnectSelection(){this.view.dom.ownerDocument.removeEventListener("selectionchange",this.onSelectionChange)}suppressSelectionUpdates(){this.suppressingSelectionUpdates=true;setTimeout((()=>this.suppressingSelectionUpdates=false),50)}onSelectionChange(){if(!hasFocusAndSelection(this.view))return;if(this.suppressingSelectionUpdates)return selectionToDOM(this.view);if(ie$1&&ie_version<=11&&!this.view.state.selection.empty){let e=this.view.domSelectionRange();if(e.focusNode&&isEquivalentPosition(e.focusNode,e.focusOffset,e.anchorNode,e.anchorOffset))return this.flushSoon()}this.flush()}setCurSelection(){this.currentSelection.set(this.view.domSelectionRange())}ignoreSelectionChange(e){if(!e.focusNode)return true;let t=new Set,n;for(let n=e.focusNode;n;n=parentNode(n))t.add(n);for(let r=e.anchorNode;r;r=parentNode(r))if(t.has(r)){n=r;break}let r=n&&this.view.docView.nearestDesc(n);if(r&&r.ignoreMutation({type:"selection",target:n.nodeType==3?n.parentNode:n})){this.setCurSelection();return true}}pendingRecords(){if(this.observer)for(let e of this.observer.takeRecords())this.queue.push(e);return this.queue}flush(){let{view:e}=this;if(!e.docView||this.flushingSoon>-1)return;let t=this.pendingRecords();if(t.length)this.queue=[];let n=e.domSelectionRange();let r=!this.suppressingSelectionUpdates&&!this.currentSelection.eq(n)&&hasFocusAndSelection(e)&&!this.ignoreSelectionChange(n);let o=-1,i=-1,s=false,a=[];if(e.editable){for(let e=0;e<t.length;e++){let n=this.registerMutation(t[e],a);if(n){o=o<0?n.from:Math.min(n.from,o);i=i<0?n.to:Math.max(n.to,i);if(n.typeOver)s=true}}}if(gecko&&a.length){let t=a.filter((e=>e.nodeName=="BR"));if(t.length==2){let[e,n]=t;if(e.parentNode&&e.parentNode.parentNode==n.parentNode)n.remove();else e.remove()}else{let{focusNode:n}=this.currentSelection;for(let r of t){let t=r.parentNode;if(t&&t.nodeName=="LI"&&(!n||blockParent(e,n)!=t))r.remove()}}}let l=null;if(o<0&&r&&e.input.lastFocus>Date.now()-200&&Math.max(e.input.lastTouch,e.input.lastClick.time)<Date.now()-300&&selectionCollapsed(n)&&(l=selectionFromDOM(e))&&l.eq(Selection.near(e.state.doc.resolve(0),1))){e.input.lastFocus=0;selectionToDOM(e);this.currentSelection.set(n);e.scrollToSelection()}else if(o>-1||r){if(o>-1){e.docView.markDirty(o,i);checkCSS(e)}this.handleDOMChange(o,i,s,a);if(e.docView&&e.docView.dirty)e.updateState(e.state);else if(!this.currentSelection.eq(n))selectionToDOM(e);this.currentSelection.set(n)}}registerMutation(e,t){if(t.indexOf(e.target)>-1)return null;let n=this.view.docView.nearestDesc(e.target);if(e.type=="attributes"&&(n==this.view.docView||e.attributeName=="contenteditable"||e.attributeName=="style"&&!e.oldValue&&!e.target.getAttribute("style")))return null;if(!n||n.ignoreMutation(e))return null;if(e.type=="childList"){for(let n=0;n<e.addedNodes.length;n++){let r=e.addedNodes[n];t.push(r);if(r.nodeType==3)this.lastChangedTextNode=r}if(n.contentDOM&&n.contentDOM!=n.dom&&!n.contentDOM.contains(e.target))return{from:n.posBefore,to:n.posAfter};let r=e.previousSibling,o=e.nextSibling;if(ie$1&&ie_version<=11&&e.addedNodes.length){for(let t=0;t<e.addedNodes.length;t++){let{previousSibling:n,nextSibling:i}=e.addedNodes[t];if(!n||Array.prototype.indexOf.call(e.addedNodes,n)<0)r=n;if(!i||Array.prototype.indexOf.call(e.addedNodes,i)<0)o=i}}let i=r&&r.parentNode==e.target?domIndex(r)+1:0;let s=n.localPosFromDOM(e.target,i,-1);let a=o&&o.parentNode==e.target?domIndex(o):e.target.childNodes.length;let l=n.localPosFromDOM(e.target,a,1);return{from:s,to:l}}else if(e.type=="attributes"){return{from:n.posAtStart-n.border,to:n.posAtEnd+n.border}}else{this.lastChangedTextNode=e.target;return{from:n.posAtStart,to:n.posAtEnd,typeOver:e.target.nodeValue==e.oldValue}}}}let cssChecked=new WeakMap;let cssCheckWarned=false;function checkCSS(e){if(cssChecked.has(e))return;cssChecked.set(e,null);if(["normal","nowrap","pre-line"].indexOf(getComputedStyle(e.dom).whiteSpace)!==-1){e.requiresGeckoHackNode=gecko;if(cssCheckWarned)return;console["warn"]("ProseMirror expects the CSS white-space property to be set, preferably to 'pre-wrap'. It is recommended to load style/prosemirror.css from the prosemirror-view package.");cssCheckWarned=true}}function rangeToSelectionRange(e,t){let n=t.startContainer,r=t.startOffset;let o=t.endContainer,i=t.endOffset;let s=e.domAtPos(e.state.selection.anchor);if(isEquivalentPosition(s.node,s.offset,o,i))[n,r,o,i]=[o,i,n,r];return{anchorNode:n,anchorOffset:r,focusNode:o,focusOffset:i}}function safariShadowSelectionRange(e,t){if(t.getComposedRanges){let n=t.getComposedRanges(e.root)[0];if(n)return rangeToSelectionRange(e,n)}let n;function r(e){e.preventDefault();e.stopImmediatePropagation();n=e.getTargetRanges()[0]}e.dom.addEventListener("beforeinput",r,true);document.execCommand("indent");e.dom.removeEventListener("beforeinput",r,true);return n?rangeToSelectionRange(e,n):null}function blockParent(e,t){for(let n=t.parentNode;n&&n!=e.dom;n=n.parentNode){let t=e.docView.nearestDesc(n,true);if(t&&t.node.isBlock)return n}return null}function parseBetween(e,t,n){let{node:r,fromOffset:o,toOffset:i,from:s,to:a}=e.docView.parseRange(t,n);let l=e.domSelectionRange();let c;let d=l.anchorNode;if(d&&e.dom.contains(d.nodeType==1?d:d.parentNode)){c=[{node:d,offset:l.anchorOffset}];if(!selectionCollapsed(l))c.push({node:l.focusNode,offset:l.focusOffset})}if(chrome&&e.input.lastKeyCode===8){for(let e=i;e>o;e--){let t=r.childNodes[e-1],n=t.pmViewDesc;if(t.nodeName=="BR"&&!n){i=e;break}if(!n||n.size)break}}let u=e.state.doc;let p=e.someProp("domParser")||DOMParser.fromSchema(e.state.schema);let f=u.resolve(s);let h=null,m=p.parse(r,{topNode:f.parent,topMatch:f.parent.contentMatchAt(f.index()),topOpen:true,from:o,to:i,preserveWhitespace:f.parent.type.whitespace=="pre"?"full":true,findPositions:c,ruleFromNode:ruleFromNode,context:f});if(c&&c[0].pos!=null){let e=c[0].pos,t=c[1]&&c[1].pos;if(t==null)t=e;h={anchor:e+s,head:t+s}}return{doc:m,sel:h,from:s,to:a}}function ruleFromNode(e){let t=e.pmViewDesc;if(t){return t.parseRule()}else if(e.nodeName=="BR"&&e.parentNode){if(safari&&/^(ul|ol)$/i.test(e.parentNode.nodeName)){let e=document.createElement("div");e.appendChild(document.createElement("li"));return{skip:e}}else if(e.parentNode.lastChild==e||safari&&/^(tr|table)$/i.test(e.parentNode.nodeName)){return{ignore:true}}}else if(e.nodeName=="IMG"&&e.getAttribute("mark-placeholder")){return{ignore:true}}return null}const isInline=/^(a|abbr|acronym|b|bd[io]|big|br|button|cite|code|data(list)?|del|dfn|em|i|ins|kbd|label|map|mark|meter|output|q|ruby|s|samp|small|span|strong|su[bp]|time|u|tt|var)$/i;function readDOMChange(e,t,n,r,o){let i=e.input.compositionPendingChanges||(e.composing?e.input.compositionID:0);e.input.compositionPendingChanges=0;if(t<0){let t=e.input.lastSelectionTime>Date.now()-50?e.input.lastSelectionOrigin:null;let n=selectionFromDOM(e,t);if(n&&!e.state.selection.eq(n)){if(chrome&&android&&e.input.lastKeyCode===13&&Date.now()-100<e.input.lastKeyCodeTime&&e.someProp("handleKeyDown",(t=>t(e,keyEvent(13,"Enter")))))return;let r=e.state.tr.setSelection(n);if(t=="pointer")r.setMeta("pointer",true);else if(t=="key")r.scrollIntoView();if(i)r.setMeta("composition",i);e.dispatch(r)}return}let s=e.state.doc.resolve(t);let a=s.sharedDepth(n);t=s.before(a+1);n=e.state.doc.resolve(n).after(a+1);let l=e.state.selection;let c=parseBetween(e,t,n);let d=e.state.doc,u=d.slice(c.from,c.to);let p,f;if(e.input.lastKeyCode===8&&Date.now()-100<e.input.lastKeyCodeTime){p=e.state.selection.to;f="end"}else{p=e.state.selection.from;f="start"}e.input.lastKeyCode=null;let h=findDiff(u.content,c.doc.content,c.from,p,f);if((ios&&e.input.lastIOSEnter>Date.now()-225||android)&&o.some((e=>e.nodeType==1&&!isInline.test(e.nodeName)))&&(!h||h.endA>=h.endB)&&e.someProp("handleKeyDown",(t=>t(e,keyEvent(13,"Enter"))))){e.input.lastIOSEnter=0;return}if(!h){if(r&&l instanceof TextSelection&&!l.empty&&l.$head.sameParent(l.$anchor)&&!e.composing&&!(c.sel&&c.sel.anchor!=c.sel.head)){h={start:l.from,endA:l.to,endB:l.to}}else{if(c.sel){let t=resolveSelection(e,e.state.doc,c.sel);if(t&&!t.eq(e.state.selection)){let n=e.state.tr.setSelection(t);if(i)n.setMeta("composition",i);e.dispatch(n)}}return}}e.input.domChangeCount++;if(e.state.selection.from<e.state.selection.to&&h.start==h.endB&&e.state.selection instanceof TextSelection){if(h.start>e.state.selection.from&&h.start<=e.state.selection.from+2&&e.state.selection.from>=c.from){h.start=e.state.selection.from}else if(h.endA<e.state.selection.to&&h.endA>=e.state.selection.to-2&&e.state.selection.to<=c.to){h.endB+=e.state.selection.to-h.endA;h.endA=e.state.selection.to}}if(ie$1&&ie_version<=11&&h.endB==h.start+1&&h.endA==h.start&&h.start>c.from&&c.doc.textBetween(h.start-c.from-1,h.start-c.from+1)==" "){h.start--;h.endA--;h.endB--}let m=c.doc.resolveNoCache(h.start-c.from);let g=c.doc.resolveNoCache(h.endB-c.from);let y=d.resolve(h.start);let b=m.sameParent(g)&&m.parent.inlineContent&&y.end()>=h.endA;let x;if((ios&&e.input.lastIOSEnter>Date.now()-225&&(!b||o.some((e=>e.nodeName=="DIV"||e.nodeName=="P")))||!b&&m.pos<c.doc.content.size&&!m.sameParent(g)&&(x=Selection.findFrom(c.doc.resolve(m.pos+1),1,true))&&x.head==g.pos)&&e.someProp("handleKeyDown",(t=>t(e,keyEvent(13,"Enter"))))){e.input.lastIOSEnter=0;return}if(e.state.selection.anchor>h.start&&looksLikeBackspace(d,h.start,h.endA,m,g)&&e.someProp("handleKeyDown",(t=>t(e,keyEvent(8,"Backspace"))))){if(android&&chrome)e.domObserver.suppressSelectionUpdates();return}if(chrome&&android&&h.endB==h.start)e.input.lastAndroidDelete=Date.now();if(android&&!b&&m.start()!=g.start()&&g.parentOffset==0&&m.depth==g.depth&&c.sel&&c.sel.anchor==c.sel.head&&c.sel.head==h.endA){h.endB-=2;g=c.doc.resolveNoCache(h.endB-c.from);setTimeout((()=>{e.someProp("handleKeyDown",(function(t){return t(e,keyEvent(13,"Enter"))}))}),20)}let w=h.start,S=h.endA;let R,v,M;if(b){if(m.pos==g.pos){if(ie$1&&ie_version<=11&&m.parentOffset==0){e.domObserver.suppressSelectionUpdates();setTimeout((()=>selectionToDOM(e)),20)}R=e.state.tr.delete(w,S);v=d.resolve(h.start).marksAcross(d.resolve(h.endA))}else if(h.endA==h.endB&&(M=isMarkChange(m.parent.content.cut(m.parentOffset,g.parentOffset),y.parent.content.cut(y.parentOffset,h.endA-y.start())))){R=e.state.tr;if(M.type=="add")R.addMark(w,S,M.mark);else R.removeMark(w,S,M.mark)}else if(m.parent.child(m.index()).isText&&m.index()==g.index()-(g.textOffset?0:1)){let t=m.parent.textBetween(m.parentOffset,g.parentOffset);if(e.someProp("handleTextInput",(n=>n(e,w,S,t))))return;R=e.state.tr.insertText(t,w,S)}}if(!R)R=e.state.tr.replace(w,S,c.doc.slice(h.start-c.from,h.endB-c.from));if(c.sel){let t=resolveSelection(e,R.doc,c.sel);if(t&&!(chrome&&android&&e.composing&&t.empty&&(h.start!=h.endB||e.input.lastAndroidDelete<Date.now()-100)&&(t.head==w||t.head==R.mapping.map(S)-1)||ie$1&&t.empty&&t.head==w))R.setSelection(t)}if(v)R.ensureMarks(v);if(i)R.setMeta("composition",i);e.dispatch(R.scrollIntoView())}function resolveSelection(e,t,n){if(Math.max(n.anchor,n.head)>t.content.size)return null;return selectionBetween(e,t.resolve(n.anchor),t.resolve(n.head))}function isMarkChange(e,t){let n=e.firstChild.marks,r=t.firstChild.marks;let o=n,i=r,s,a,l;for(let e=0;e<r.length;e++)o=r[e].removeFromSet(o);for(let e=0;e<n.length;e++)i=n[e].removeFromSet(i);if(o.length==1&&i.length==0){a=o[0];s="add";l=e=>e.mark(a.addToSet(e.marks))}else if(o.length==0&&i.length==1){a=i[0];s="remove";l=e=>e.mark(a.removeFromSet(e.marks))}else{return null}let c=[];for(let e=0;e<t.childCount;e++)c.push(l(t.child(e)));if(Fragment.from(c).eq(e))return{mark:a,type:s}}function looksLikeBackspace(e,t,n,r,o){if(n-t<=o.pos-r.pos||skipClosingAndOpening(r,true,false)<o.pos)return false;let i=e.resolve(t);if(!r.parent.isTextblock){let e=i.nodeAfter;return e!=null&&n==t+e.nodeSize}if(i.parentOffset<i.parent.content.size||!i.parent.isTextblock)return false;let s=e.resolve(skipClosingAndOpening(i,true,true));if(!s.parent.isTextblock||s.pos>n||skipClosingAndOpening(s,true,false)<n)return false;return r.parent.content.cut(r.parentOffset).eq(s.parent.content)}function skipClosingAndOpening(e,t,n){let r=e.depth,o=t?e.end():e.pos;while(r>0&&(t||e.indexAfter(r)==e.node(r).childCount)){r--;o++;t=false}if(n){let t=e.node(r).maybeChild(e.indexAfter(r));while(t&&!t.isLeaf){t=t.firstChild;o++}}return o}function findDiff(e,t,n,r,o){let i=e.findDiffStart(t,n);if(i==null)return null;let{a:s,b:a}=e.findDiffEnd(t,n+e.size,n+t.size);if(o=="end"){let e=Math.max(0,i-Math.min(s,a));r-=s+e-i}if(s<i&&e.size<t.size){let e=r<=i&&r>=s?i-r:0;i-=e;if(i&&i<t.size&&isSurrogatePair(t.textBetween(i-1,i+1)))i+=e?1:-1;a=i+(a-s);s=i}else if(a<i){let t=r<=i&&r>=a?i-r:0;i-=t;if(i&&i<e.size&&isSurrogatePair(e.textBetween(i-1,i+1)))i+=t?1:-1;s=i+(s-a);a=i}return{start:i,endA:s,endB:a}}function isSurrogatePair(e){if(e.length!=2)return false;let t=e.charCodeAt(0),n=e.charCodeAt(1);return t>=56320&&t<=57343&&n>=55296&&n<=56319}class EditorView{constructor(e,t){this._root=null;this.focused=false;this.trackWrites=null;this.mounted=false;this.markCursor=null;this.cursorWrapper=null;this.lastSelectedViewDesc=undefined;this.input=new InputState;this.prevDirectPlugins=[];this.pluginViews=[];this.requiresGeckoHackNode=false;this.dragging=null;this._props=t;this.state=t.state;this.directPlugins=t.plugins||[];this.directPlugins.forEach(checkStateComponent);this.dispatch=this.dispatch.bind(this);this.dom=e&&e.mount||document.createElement("div");if(e){if(e.appendChild)e.appendChild(this.dom);else if(typeof e=="function")e(this.dom);else if(e.mount)this.mounted=true}this.editable=getEditable(this);updateCursorWrapper(this);this.nodeViews=buildNodeViews(this);this.docView=docViewDesc(this.state.doc,computeDocDeco(this),viewDecorations(this),this.dom,this);this.domObserver=new DOMObserver(this,((e,t,n,r)=>readDOMChange(this,e,t,n,r)));this.domObserver.start();initInput(this);this.updatePluginViews()}get composing(){return this.input.composing}get props(){if(this._props.state!=this.state){let e=this._props;this._props={};for(let t in e)this._props[t]=e[t];this._props.state=this.state}return this._props}update(e){if(e.handleDOMEvents!=this._props.handleDOMEvents)ensureListeners(this);let t=this._props;this._props=e;if(e.plugins){e.plugins.forEach(checkStateComponent);this.directPlugins=e.plugins}this.updateStateInner(e.state,t)}setProps(e){let t={};for(let e in this._props)t[e]=this._props[e];t.state=this.state;for(let n in e)t[n]=e[n];this.update(t)}updateState(e){this.updateStateInner(e,this._props)}updateStateInner(e,t){var n;let r=this.state,o=false,i=false;if(e.storedMarks&&this.composing){clearComposition(this);i=true}this.state=e;let s=r.plugins!=e.plugins||this._props.plugins!=t.plugins;if(s||this._props.plugins!=t.plugins||this._props.nodeViews!=t.nodeViews){let e=buildNodeViews(this);if(changedNodeViews(e,this.nodeViews)){this.nodeViews=e;o=true}}if(s||t.handleDOMEvents!=this._props.handleDOMEvents){ensureListeners(this)}this.editable=getEditable(this);updateCursorWrapper(this);let a=viewDecorations(this),l=computeDocDeco(this);let c=r.plugins!=e.plugins&&!r.doc.eq(e.doc)?"reset":e.scrollToSelection>r.scrollToSelection?"to selection":"preserve";let d=o||!this.docView.matchesNode(e.doc,l,a);if(d||!e.selection.eq(r.selection))i=true;let u=c=="preserve"&&i&&this.dom.style.overflowAnchor==null&&storeScrollPos(this);if(i){this.domObserver.stop();let t=d&&(ie$1||chrome)&&!this.composing&&!r.selection.empty&&!e.selection.empty&&selectionContextChanged(r.selection,e.selection);if(d){let n=chrome?this.trackWrites=this.domSelectionRange().focusNode:null;if(this.composing)this.input.compositionNode=findCompositionNode(this);if(o||!this.docView.update(e.doc,l,a,this)){this.docView.updateOuterDeco(l);this.docView.destroy();this.docView=docViewDesc(e.doc,l,a,this.dom,this)}if(n&&!this.trackWrites)t=true}if(t||!(this.input.mouseDown&&this.domObserver.currentSelection.eq(this.domSelectionRange())&&anchorInRightPlace(this))){selectionToDOM(this,t)}else{syncNodeSelection(this,e.selection);this.domObserver.setCurSelection()}this.domObserver.start()}this.updatePluginViews(r);if(((n=this.dragging)===null||n===void 0?void 0:n.node)&&!r.doc.eq(e.doc))this.updateDraggedNode(this.dragging,r);if(c=="reset"){this.dom.scrollTop=0}else if(c=="to selection"){this.scrollToSelection()}else if(u){resetScrollPos(u)}}scrollToSelection(){let e=this.domSelectionRange().focusNode;if(this.someProp("handleScrollToSelection",(e=>e(this))));else if(this.state.selection instanceof NodeSelection){let t=this.docView.domAfterPos(this.state.selection.from);if(t.nodeType==1)scrollRectIntoView(this,t.getBoundingClientRect(),e)}else{scrollRectIntoView(this,this.coordsAtPos(this.state.selection.head,1),e)}}destroyPluginViews(){let e;while(e=this.pluginViews.pop())if(e.destroy)e.destroy()}updatePluginViews(e){if(!e||e.plugins!=this.state.plugins||this.directPlugins!=this.prevDirectPlugins){this.prevDirectPlugins=this.directPlugins;this.destroyPluginViews();for(let e=0;e<this.directPlugins.length;e++){let t=this.directPlugins[e];if(t.spec.view)this.pluginViews.push(t.spec.view(this))}for(let e=0;e<this.state.plugins.length;e++){let t=this.state.plugins[e];if(t.spec.view)this.pluginViews.push(t.spec.view(this))}}else{for(let t=0;t<this.pluginViews.length;t++){let n=this.pluginViews[t];if(n.update)n.update(this,e)}}}updateDraggedNode(e,t){let n=e.node,r=-1;if(this.state.doc.nodeAt(n.from)==n.node){r=n.from}else{let e=n.from+(this.state.doc.content.size-t.doc.content.size);let o=e>0&&this.state.doc.nodeAt(e);if(o==n.node)r=e}this.dragging=new Dragging(e.slice,e.move,r<0?undefined:NodeSelection.create(this.state.doc,r))}someProp(e,t){let n=this._props&&this._props[e],r;if(n!=null&&(r=t?t(n):n))return r;for(let n=0;n<this.directPlugins.length;n++){let o=this.directPlugins[n].props[e];if(o!=null&&(r=t?t(o):o))return r}let o=this.state.plugins;if(o)for(let n=0;n<o.length;n++){let i=o[n].props[e];if(i!=null&&(r=t?t(i):i))return r}}hasFocus(){if(ie$1){let e=this.root.activeElement;if(e==this.dom)return true;if(!e||!this.dom.contains(e))return false;while(e&&this.dom!=e&&this.dom.contains(e)){if(e.contentEditable=="false")return false;e=e.parentElement}return true}return this.root.activeElement==this.dom}focus(){this.domObserver.stop();if(this.editable)focusPreventScroll(this.dom);selectionToDOM(this);this.domObserver.start()}get root(){let e=this._root;if(e==null)for(let e=this.dom.parentNode;e;e=e.parentNode){if(e.nodeType==9||e.nodeType==11&&e.host){if(!e.getSelection)Object.getPrototypeOf(e).getSelection=()=>e.ownerDocument.getSelection();return this._root=e}}return e||document}updateRoot(){this._root=null}posAtCoords(e){return posAtCoords(this,e)}coordsAtPos(e,t=1){return coordsAtPos(this,e,t)}domAtPos(e,t=0){return this.docView.domFromPos(e,t)}nodeDOM(e){let t=this.docView.descAt(e);return t?t.nodeDOM:null}posAtDOM(e,t,n=-1){let r=this.docView.posFromDOM(e,t,n);if(r==null)throw new RangeError("DOM position not inside the editor");return r}endOfTextblock(e,t){return endOfTextblock(this,t||this.state,e)}pasteHTML(e,t){return doPaste(this,"",e,false,t||new ClipboardEvent("paste"))}pasteText(e,t){return doPaste(this,e,null,true,t||new ClipboardEvent("paste"))}destroy(){if(!this.docView)return;destroyInput(this);this.destroyPluginViews();if(this.mounted){this.docView.update(this.state.doc,[],viewDecorations(this),this);this.dom.textContent=""}else if(this.dom.parentNode){this.dom.parentNode.removeChild(this.dom)}this.docView.destroy();this.docView=null;clearReusedRange()}get isDestroyed(){return this.docView==null}dispatchEvent(e){return dispatchEvent(this,e)}dispatch(e){let t=this._props.dispatchTransaction;if(t)t.call(this,e);else this.updateState(this.state.apply(e))}domSelectionRange(){let e=this.domSelection();if(!e)return{focusNode:null,focusOffset:0,anchorNode:null,anchorOffset:0};return safari&&this.root.nodeType===11&&deepActiveElement(this.dom.ownerDocument)==this.dom&&safariShadowSelectionRange(this,e)||e}domSelection(){return this.root.getSelection()}}function computeDocDeco(e){let t=Object.create(null);t.class="ProseMirror";t.contenteditable=String(e.editable);e.someProp("attributes",(n=>{if(typeof n=="function")n=n(e.state);if(n)for(let e in n){if(e=="class")t.class+=" "+n[e];else if(e=="style")t.style=(t.style?t.style+";":"")+n[e];else if(!t[e]&&e!="contenteditable"&&e!="nodeName")t[e]=String(n[e])}}));if(!t.translate)t.translate="no";return[Decoration.node(0,e.state.doc.content.size,t)]}function updateCursorWrapper(e){if(e.markCursor){let t=document.createElement("img");t.className="ProseMirror-separator";t.setAttribute("mark-placeholder","true");t.setAttribute("alt","");e.cursorWrapper={dom:t,deco:Decoration.widget(e.state.selection.from,t,{raw:true,marks:e.markCursor})}}else{e.cursorWrapper=null}}function getEditable(e){return!e.someProp("editable",(t=>t(e.state)===false))}function selectionContextChanged(e,t){let n=Math.min(e.$anchor.sharedDepth(e.head),t.$anchor.sharedDepth(t.head));return e.$anchor.start(n)!=t.$anchor.start(n)}function buildNodeViews(e){let t=Object.create(null);function n(e){for(let n in e)if(!Object.prototype.hasOwnProperty.call(t,n))t[n]=e[n]}e.someProp("nodeViews",n);e.someProp("markViews",n);return t}function changedNodeViews(e,t){let n=0,r=0;for(let r in e){if(e[r]!=t[r])return true;n++}for(let e in t)r++;return n!=r}function checkStateComponent(e){if(e.spec.state||e.spec.filterTransaction||e.spec.appendTransaction)throw new RangeError("Plugins passed directly to the view must not have a state component")}var GOOD_LEAF_SIZE=200;var RopeSequence=function e(){};RopeSequence.prototype.append=function e(t){if(!t.length){return this}t=RopeSequence.from(t);return!this.length&&t||t.length<GOOD_LEAF_SIZE&&this.leafAppend(t)||this.length<GOOD_LEAF_SIZE&&t.leafPrepend(this)||this.appendInner(t)};RopeSequence.prototype.prepend=function e(t){if(!t.length){return this}return RopeSequence.from(t).append(this)};RopeSequence.prototype.appendInner=function e(t){return new Append(this,t)};RopeSequence.prototype.slice=function e(t,n){if(t===void 0)t=0;if(n===void 0)n=this.length;if(t>=n){return RopeSequence.empty}return this.sliceInner(Math.max(0,t),Math.min(this.length,n))};RopeSequence.prototype.get=function e(t){if(t<0||t>=this.length){return undefined}return this.getInner(t)};RopeSequence.prototype.forEach=function e(t,n,r){if(n===void 0)n=0;if(r===void 0)r=this.length;if(n<=r){this.forEachInner(t,n,r,0)}else{this.forEachInvertedInner(t,n,r,0)}};RopeSequence.prototype.map=function e(t,n,r){if(n===void 0)n=0;if(r===void 0)r=this.length;var o=[];this.forEach((function(e,n){return o.push(t(e,n))}),n,r);return o};RopeSequence.from=function e(t){if(t instanceof RopeSequence){return t}return t&&t.length?new Leaf(t):RopeSequence.empty};var Leaf=function(e){function t(t){e.call(this);this.values=t}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;var n={length:{configurable:true},depth:{configurable:true}};t.prototype.flatten=function e(){return this.values};t.prototype.sliceInner=function e(n,r){if(n==0&&r==this.length){return this}return new t(this.values.slice(n,r))};t.prototype.getInner=function e(t){return this.values[t]};t.prototype.forEachInner=function e(t,n,r,o){for(var i=n;i<r;i++){if(t(this.values[i],o+i)===false){return false}}};t.prototype.forEachInvertedInner=function e(t,n,r,o){for(var i=n-1;i>=r;i--){if(t(this.values[i],o+i)===false){return false}}};t.prototype.leafAppend=function e(n){if(this.length+n.length<=GOOD_LEAF_SIZE){return new t(this.values.concat(n.flatten()))}};t.prototype.leafPrepend=function e(n){if(this.length+n.length<=GOOD_LEAF_SIZE){return new t(n.flatten().concat(this.values))}};n.length.get=function(){return this.values.length};n.depth.get=function(){return 0};Object.defineProperties(t.prototype,n);return t}(RopeSequence);RopeSequence.empty=new Leaf([]);var Append=function(e){function t(t,n){e.call(this);this.left=t;this.right=n;this.length=t.length+n.length;this.depth=Math.max(t.depth,n.depth)+1}if(e)t.__proto__=e;t.prototype=Object.create(e&&e.prototype);t.prototype.constructor=t;t.prototype.flatten=function e(){return this.left.flatten().concat(this.right.flatten())};t.prototype.getInner=function e(t){return t<this.left.length?this.left.get(t):this.right.get(t-this.left.length)};t.prototype.forEachInner=function e(t,n,r,o){var i=this.left.length;if(n<i&&this.left.forEachInner(t,n,Math.min(r,i),o)===false){return false}if(r>i&&this.right.forEachInner(t,Math.max(n-i,0),Math.min(this.length,r)-i,o+i)===false){return false}};t.prototype.forEachInvertedInner=function e(t,n,r,o){var i=this.left.length;if(n>i&&this.right.forEachInvertedInner(t,n-i,Math.max(r,i)-i,o+i)===false){return false}if(r<i&&this.left.forEachInvertedInner(t,Math.min(n,i),r,o)===false){return false}};t.prototype.sliceInner=function e(t,n){if(t==0&&n==this.length){return this}var r=this.left.length;if(n<=r){return this.left.slice(t,n)}if(t>=r){return this.right.slice(t-r,n-r)}return this.left.slice(t,r).append(this.right.slice(0,n-r))};t.prototype.leafAppend=function e(n){var r=this.right.leafAppend(n);if(r){return new t(this.left,r)}};t.prototype.leafPrepend=function e(n){var r=this.left.leafPrepend(n);if(r){return new t(r,this.right)}};t.prototype.appendInner=function e(n){if(this.left.depth>=Math.max(this.right.depth,n.depth)+1){return new t(this.left,new t(this.right,n))}return new t(this,n)};return t}(RopeSequence);const max_empty_items=500;class Branch{constructor(e,t){this.items=e;this.eventCount=t}popEvent(e,t){if(this.eventCount==0)return null;let n=this.items.length;for(;;n--){let e=this.items.get(n-1);if(e.selection){--n;break}}let r,o;if(t){r=this.remapping(n,this.items.length);o=r.maps.length}let i=e.tr;let s,a;let l=[],c=[];this.items.forEach(((e,t)=>{if(!e.step){if(!r){r=this.remapping(n,t+1);o=r.maps.length}o--;c.push(e);return}if(r){c.push(new Item(e.map));let t=e.step.map(r.slice(o)),n;if(t&&i.maybeStep(t).doc){n=i.mapping.maps[i.mapping.maps.length-1];l.push(new Item(n,undefined,undefined,l.length+c.length))}o--;if(n)r.appendMap(n,o)}else{i.maybeStep(e.step)}if(e.selection){s=r?e.selection.map(r.slice(o)):e.selection;a=new Branch(this.items.slice(0,n).append(c.reverse().concat(l)),this.eventCount-1);return false}}),this.items.length,0);return{remaining:a,transform:i,selection:s}}addTransform(e,t,n,r){let o=[],i=this.eventCount;let s=this.items,a=!r&&s.length?s.get(s.length-1):null;for(let n=0;n<e.steps.length;n++){let l=e.steps[n].invert(e.docs[n]);let c=new Item(e.mapping.maps[n],l,t),d;if(d=a&&a.merge(c)){c=d;if(n)o.pop();else s=s.slice(0,s.length-1)}o.push(c);if(t){i++;t=undefined}if(!r)a=c}let l=i-n.depth;if(l>DEPTH_OVERFLOW){s=cutOffEvents(s,l);i-=l}return new Branch(s.append(o),i)}remapping(e,t){let n=new Mapping;this.items.forEach(((t,r)=>{let o=t.mirrorOffset!=null&&r-t.mirrorOffset>=e?n.maps.length-t.mirrorOffset:undefined;n.appendMap(t.map,o)}),e,t);return n}addMaps(e){if(this.eventCount==0)return this;return new Branch(this.items.append(e.map((e=>new Item(e)))),this.eventCount)}rebased(e,t){if(!this.eventCount)return this;let n=[],r=Math.max(0,this.items.length-t);let o=e.mapping;let i=e.steps.length;let s=this.eventCount;this.items.forEach((e=>{if(e.selection)s--}),r);let a=t;this.items.forEach((t=>{let r=o.getMirror(--a);if(r==null)return;i=Math.min(i,r);let l=o.maps[r];if(t.step){let i=e.steps[r].invert(e.docs[r]);let c=t.selection&&t.selection.map(o.slice(a+1,r));if(c)s++;n.push(new Item(l,i,c))}else{n.push(new Item(l))}}),r);let l=[];for(let e=t;e<i;e++)l.push(new Item(o.maps[e]));let c=this.items.slice(0,r).append(l).append(n);let d=new Branch(c,s);if(d.emptyItemCount()>max_empty_items)d=d.compress(this.items.length-n.length);return d}emptyItemCount(){let e=0;this.items.forEach((t=>{if(!t.step)e++}));return e}compress(e=this.items.length){let t=this.remapping(0,e),n=t.maps.length;let r=[],o=0;this.items.forEach(((i,s)=>{if(s>=e){r.push(i);if(i.selection)o++}else if(i.step){let e=i.step.map(t.slice(n)),s=e&&e.getMap();n--;if(s)t.appendMap(s,n);if(e){let a=i.selection&&i.selection.map(t.slice(n));if(a)o++;let l=new Item(s.invert(),e,a),c,d=r.length-1;if(c=r.length&&r[d].merge(l))r[d]=c;else r.push(l)}}else if(i.map){n--}}),this.items.length,0);return new Branch(RopeSequence.from(r.reverse()),o)}}Branch.empty=new Branch(RopeSequence.empty,0);function cutOffEvents(e,t){let n;e.forEach(((e,r)=>{if(e.selection&&t--==0){n=r;return false}}));return e.slice(n)}class Item{constructor(e,t,n,r){this.map=e;this.step=t;this.selection=n;this.mirrorOffset=r}merge(e){if(this.step&&e.step&&!e.selection){let t=e.step.merge(this.step);if(t)return new Item(t.getMap().invert(),t,this.selection)}}}class HistoryState{constructor(e,t,n,r,o){this.done=e;this.undone=t;this.prevRanges=n;this.prevTime=r;this.prevComposition=o}}const DEPTH_OVERFLOW=20;function applyTransaction(e,t,n,r){let o=n.getMeta(historyKey),i;if(o)return o.historyState;if(n.getMeta(closeHistoryKey))e=new HistoryState(e.done,e.undone,null,0,-1);let s=n.getMeta("appendedTransaction");if(n.steps.length==0){return e}else if(s&&s.getMeta(historyKey)){if(s.getMeta(historyKey).redo)return new HistoryState(e.done.addTransform(n,undefined,r,mustPreserveItems(t)),e.undone,rangesFor(n.mapping.maps),e.prevTime,e.prevComposition);else return new HistoryState(e.done,e.undone.addTransform(n,undefined,r,mustPreserveItems(t)),null,e.prevTime,e.prevComposition)}else if(n.getMeta("addToHistory")!==false&&!(s&&s.getMeta("addToHistory")===false)){let o=n.getMeta("composition");let i=e.prevTime==0||!s&&e.prevComposition!=o&&(e.prevTime<(n.time||0)-r.newGroupDelay||!isAdjacentTo(n,e.prevRanges));let a=s?mapRanges(e.prevRanges,n.mapping):rangesFor(n.mapping.maps);return new HistoryState(e.done.addTransform(n,i?t.selection.getBookmark():undefined,r,mustPreserveItems(t)),Branch.empty,a,n.time,o==null?e.prevComposition:o)}else if(i=n.getMeta("rebased")){return new HistoryState(e.done.rebased(n,i),e.undone.rebased(n,i),mapRanges(e.prevRanges,n.mapping),e.prevTime,e.prevComposition)}else{return new HistoryState(e.done.addMaps(n.mapping.maps),e.undone.addMaps(n.mapping.maps),mapRanges(e.prevRanges,n.mapping),e.prevTime,e.prevComposition)}}function isAdjacentTo(e,t){if(!t)return false;if(!e.docChanged)return true;let n=false;e.mapping.maps[0].forEach(((e,r)=>{for(let o=0;o<t.length;o+=2)if(e<=t[o+1]&&r>=t[o])n=true}));return n}function rangesFor(e){let t=[];for(let n=e.length-1;n>=0&&t.length==0;n--)e[n].forEach(((e,n,r,o)=>t.push(r,o)));return t}function mapRanges(e,t){if(!e)return null;let n=[];for(let r=0;r<e.length;r+=2){let o=t.map(e[r],1),i=t.map(e[r+1],-1);if(o<=i)n.push(o,i)}return n}function histTransaction(e,t,n){let r=mustPreserveItems(t);let o=historyKey.get(t).spec.config;let i=(n?e.undone:e.done).popEvent(t,r);if(!i)return null;let s=i.selection.resolve(i.transform.doc);let a=(n?e.done:e.undone).addTransform(i.transform,t.selection.getBookmark(),o,r);let l=new HistoryState(n?a:i.remaining,n?i.remaining:a,null,0,-1);return i.transform.setSelection(s).setMeta(historyKey,{redo:n,historyState:l})}let cachedPreserveItems=false,cachedPreserveItemsPlugins=null;function mustPreserveItems(e){let t=e.plugins;if(cachedPreserveItemsPlugins!=t){cachedPreserveItems=false;cachedPreserveItemsPlugins=t;for(let e=0;e<t.length;e++)if(t[e].spec.historyPreserveItems){cachedPreserveItems=true;break}}return cachedPreserveItems}const historyKey=new PluginKey("history");const closeHistoryKey=new PluginKey("closeHistory");function history(e={}){e={depth:e.depth||100,newGroupDelay:e.newGroupDelay||500};return new Plugin({key:historyKey,state:{init(){return new HistoryState(Branch.empty,Branch.empty,null,0,-1)},apply(t,n,r){return applyTransaction(n,r,t,e)}},config:e,props:{handleDOMEvents:{beforeinput(e,t){let n=t.inputType;let r=n=="historyUndo"?undo:n=="historyRedo"?redo:null;if(!r)return false;t.preventDefault();return r(e.state,e.dispatch)}}}})}function buildCommand(e,t){return(n,r)=>{let o=historyKey.getState(n);if(!o||(e?o.undone:o.done).eventCount==0)return false;if(r){let i=histTransaction(o,n,e);if(i)r(t?i.scrollIntoView():i)}return true}}const undo=buildCommand(false,true);const redo=buildCommand(true,true);var base={8:"Backspace",9:"Tab",10:"Enter",12:"NumLock",13:"Enter",16:"Shift",17:"Control",18:"Alt",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",44:"PrintScreen",45:"Insert",46:"Delete",59:";",61:"=",91:"Meta",92:"Meta",106:"*",107:"+",108:",",109:"-",110:".",111:"/",144:"NumLock",145:"ScrollLock",160:"Shift",161:"Shift",162:"Control",163:"Control",164:"Alt",165:"Alt",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"};var shift={48:")",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",61:"+",173:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",192:"~",219:"{",220:"|",221:"}",222:'"'};var mac$3=typeof navigator!="undefined"&&/Mac/.test(navigator.platform);var ie=typeof navigator!="undefined"&&/MSIE \d|Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(navigator.userAgent);for(var i=0;i<10;i++)base[48+i]=base[96+i]=String(i);for(var i=1;i<=24;i++)base[i+111]="F"+i;for(var i=65;i<=90;i++){base[i]=String.fromCharCode(i+32);shift[i]=String.fromCharCode(i)}for(var code in base)if(!shift.hasOwnProperty(code))shift[code]=base[code];function keyName(e){var t=mac$3&&e.metaKey&&e.shiftKey&&!e.ctrlKey&&!e.altKey||ie&&e.shiftKey&&e.key&&e.key.length==1||e.key=="Unidentified";var n=!t&&e.key||(e.shiftKey?shift:base)[e.keyCode]||e.key||"Unidentified";if(n=="Esc")n="Escape";if(n=="Del")n="Delete";if(n=="Left")n="ArrowLeft";if(n=="Up")n="ArrowUp";if(n=="Right")n="ArrowRight";if(n=="Down")n="ArrowDown";return n}const mac$2=typeof navigator!="undefined"?/Mac|iP(hone|[oa]d)/.test(navigator.platform):false;function normalizeKeyName(e){let t=e.split(/-(?!$)/),n=t[t.length-1];if(n=="Space")n=" ";let r,o,i,s;for(let e=0;e<t.length-1;e++){let n=t[e];if(/^(cmd|meta|m)$/i.test(n))s=true;else if(/^a(lt)?$/i.test(n))r=true;else if(/^(c|ctrl|control)$/i.test(n))o=true;else if(/^s(hift)?$/i.test(n))i=true;else if(/^mod$/i.test(n)){if(mac$2)s=true;else o=true}else throw new Error("Unrecognized modifier name: "+n)}if(r)n="Alt-"+n;if(o)n="Ctrl-"+n;if(s)n="Meta-"+n;if(i)n="Shift-"+n;return n}function normalize$1(e){let t=Object.create(null);for(let n in e)t[normalizeKeyName(n)]=e[n];return t}function modifiers(e,t,n=true){if(t.altKey)e="Alt-"+e;if(t.ctrlKey)e="Ctrl-"+e;if(t.metaKey)e="Meta-"+e;if(n&&t.shiftKey)e="Shift-"+e;return e}function keymap(e){return new Plugin({props:{handleKeyDown:keydownHandler(e)}})}function keydownHandler(e){let t=normalize$1(e);return function(e,n){let r=keyName(n),o,i=t[modifiers(r,n)];if(i&&i(e.state,e.dispatch,e))return true;if(r.length==1&&r!=" "){if(n.shiftKey){let o=t[modifiers(r,n,false)];if(o&&o(e.state,e.dispatch,e))return true}if((n.shiftKey||n.altKey||n.metaKey||r.charCodeAt(0)>127)&&(o=base[n.keyCode])&&o!=r){let r=t[modifiers(o,n)];if(r&&r(e.state,e.dispatch,e))return true}}return false}}class GapCursor extends Selection{constructor(e){super(e,e)}map(e,t){let n=e.resolve(t.map(this.head));return GapCursor.valid(n)?new GapCursor(n):Selection.near(n)}content(){return Slice.empty}eq(e){return e instanceof GapCursor&&e.head==this.head}toJSON(){return{type:"gapcursor",pos:this.head}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for GapCursor.fromJSON");return new GapCursor(e.resolve(t.pos))}getBookmark(){return new GapBookmark(this.anchor)}static valid(e){let t=e.parent;if(t.isTextblock||!closedBefore(e)||!closedAfter(e))return false;let n=t.type.spec.allowGapCursor;if(n!=null)return n;let r=t.contentMatchAt(e.index()).defaultType;return r&&r.isTextblock}static findGapCursorFrom(e,t,n=false){e:for(;;){if(!n&&GapCursor.valid(e))return e;let r=e.pos,o=null;for(let n=e.depth;;n--){let i=e.node(n);if(t>0?e.indexAfter(n)<i.childCount:e.index(n)>0){o=i.child(t>0?e.indexAfter(n):e.index(n)-1);break}else if(n==0){return null}r+=t;let s=e.doc.resolve(r);if(GapCursor.valid(s))return s}for(;;){let i=t>0?o.firstChild:o.lastChild;if(!i){if(o.isAtom&&!o.isText&&!NodeSelection.isSelectable(o)){e=e.doc.resolve(r+o.nodeSize*t);n=false;continue e}break}o=i;r+=t;let s=e.doc.resolve(r);if(GapCursor.valid(s))return s}return null}}}GapCursor.prototype.visible=false;GapCursor.findFrom=GapCursor.findGapCursorFrom;Selection.jsonID("gapcursor",GapCursor);class GapBookmark{constructor(e){this.pos=e}map(e){return new GapBookmark(e.map(this.pos))}resolve(e){let t=e.resolve(this.pos);return GapCursor.valid(t)?new GapCursor(t):Selection.near(t)}}function closedBefore(e){for(let t=e.depth;t>=0;t--){let n=e.index(t),r=e.node(t);if(n==0){if(r.type.spec.isolating)return true;continue}for(let e=r.child(n-1);;e=e.lastChild){if(e.childCount==0&&!e.inlineContent||e.isAtom||e.type.spec.isolating)return true;if(e.inlineContent)return false}}return true}function closedAfter(e){for(let t=e.depth;t>=0;t--){let n=e.indexAfter(t),r=e.node(t);if(n==r.childCount){if(r.type.spec.isolating)return true;continue}for(let e=r.child(n);;e=e.firstChild){if(e.childCount==0&&!e.inlineContent||e.isAtom||e.type.spec.isolating)return true;if(e.inlineContent)return false}}return true}function gapCursor(){return new Plugin({props:{decorations:drawGapCursor,createSelectionBetween(e,t,n){return t.pos==n.pos&&GapCursor.valid(n)?new GapCursor(n):null},handleClick:handleClick,handleKeyDown:handleKeyDown$1,handleDOMEvents:{beforeinput:beforeinput}}})}const handleKeyDown$1=keydownHandler({ArrowLeft:arrow$1("horiz",-1),ArrowRight:arrow$1("horiz",1),ArrowUp:arrow$1("vert",-1),ArrowDown:arrow$1("vert",1)});function arrow$1(e,t){const n=e=="vert"?t>0?"down":"up":t>0?"right":"left";return function(e,r,o){let i=e.selection;let s=t>0?i.$to:i.$from,a=i.empty;if(i instanceof TextSelection){if(!o.endOfTextblock(n)||s.depth==0)return false;a=false;s=e.doc.resolve(t>0?s.after():s.before())}let l=GapCursor.findGapCursorFrom(s,t,a);if(!l)return false;if(r)r(e.tr.setSelection(new GapCursor(l)));return true}}function handleClick(e,t,n){if(!e||!e.editable)return false;let r=e.state.doc.resolve(t);if(!GapCursor.valid(r))return false;let o=e.posAtCoords({left:n.clientX,top:n.clientY});if(o&&o.inside>-1&&NodeSelection.isSelectable(e.state.doc.nodeAt(o.inside)))return false;e.dispatch(e.state.tr.setSelection(new GapCursor(r)));return true}function beforeinput(e,t){if(t.inputType!="insertCompositionText"||!(e.state.selection instanceof GapCursor))return false;let{$from:n}=e.state.selection;let r=n.parent.contentMatchAt(n.index()).findWrapping(e.state.schema.nodes.text);if(!r)return false;let o=Fragment.empty;for(let e=r.length-1;e>=0;e--)o=Fragment.from(r[e].createAndFill(null,o));let i=e.state.tr.replace(n.pos,n.pos,new Slice(o,0,0));i.setSelection(TextSelection.near(i.doc.resolve(n.pos+1)));e.dispatch(i);return false}function drawGapCursor(e){if(!(e.selection instanceof GapCursor))return null;let t=document.createElement("div");t.className="ProseMirror-gapcursor";return DecorationSet.create(e.doc,[Decoration.widget(e.selection.head,t,{key:"gapcursor"})])}const deleteSelection=(e,t)=>{if(e.selection.empty)return false;if(t)t(e.tr.deleteSelection().scrollIntoView());return true};function atBlockStart(e,t){let{$cursor:n}=e.selection;if(!n||(t?!t.endOfTextblock("backward",e):n.parentOffset>0))return null;return n}const joinBackward=(e,t,n)=>{let r=atBlockStart(e,n);if(!r)return false;let o=findCutBefore(r);if(!o){let n=r.blockRange(),o=n&&liftTarget(n);if(o==null)return false;if(t)t(e.tr.lift(n,o).scrollIntoView());return true}let i=o.nodeBefore;if(deleteBarrier(e,o,t,-1))return true;if(r.parent.content.size==0&&(textblockAt(i,"end")||NodeSelection.isSelectable(i))){for(let n=r.depth;;n--){let s=replaceStep(e.doc,r.before(n),r.after(n),Slice.empty);if(s&&s.slice.size<s.to-s.from){if(t){let n=e.tr.step(s);n.setSelection(textblockAt(i,"end")?Selection.findFrom(n.doc.resolve(n.mapping.map(o.pos,-1)),-1):NodeSelection.create(n.doc,o.pos-i.nodeSize));t(n.scrollIntoView())}return true}if(n==1||r.node(n-1).childCount>1)break}}if(i.isAtom&&o.depth==r.depth-1){if(t)t(e.tr.delete(o.pos-i.nodeSize,o.pos).scrollIntoView());return true}return false};function textblockAt(e,t,n=false){for(let r=e;r;r=t=="start"?r.firstChild:r.lastChild){if(r.isTextblock)return true;if(n&&r.childCount!=1)return false}return false}const selectNodeBackward=(e,t,n)=>{let{$head:r,empty:o}=e.selection,i=r;if(!o)return false;if(r.parent.isTextblock){if(n?!n.endOfTextblock("backward",e):r.parentOffset>0)return false;i=findCutBefore(r)}let s=i&&i.nodeBefore;if(!s||!NodeSelection.isSelectable(s))return false;if(t)t(e.tr.setSelection(NodeSelection.create(e.doc,i.pos-s.nodeSize)).scrollIntoView());return true};function findCutBefore(e){if(!e.parent.type.spec.isolating)for(let t=e.depth-1;t>=0;t--){if(e.index(t)>0)return e.doc.resolve(e.before(t+1));if(e.node(t).type.spec.isolating)break}return null}function atBlockEnd(e,t){let{$cursor:n}=e.selection;if(!n||(t?!t.endOfTextblock("forward",e):n.parentOffset<n.parent.content.size))return null;return n}const joinForward=(e,t,n)=>{let r=atBlockEnd(e,n);if(!r)return false;let o=findCutAfter(r);if(!o)return false;let i=o.nodeAfter;if(deleteBarrier(e,o,t,1))return true;if(r.parent.content.size==0&&(textblockAt(i,"start")||NodeSelection.isSelectable(i))){let n=replaceStep(e.doc,r.before(),r.after(),Slice.empty);if(n&&n.slice.size<n.to-n.from){if(t){let r=e.tr.step(n);r.setSelection(textblockAt(i,"start")?Selection.findFrom(r.doc.resolve(r.mapping.map(o.pos)),1):NodeSelection.create(r.doc,r.mapping.map(o.pos)));t(r.scrollIntoView())}return true}}if(i.isAtom&&o.depth==r.depth-1){if(t)t(e.tr.delete(o.pos,o.pos+i.nodeSize).scrollIntoView());return true}return false};const selectNodeForward=(e,t,n)=>{let{$head:r,empty:o}=e.selection,i=r;if(!o)return false;if(r.parent.isTextblock){if(n?!n.endOfTextblock("forward",e):r.parentOffset<r.parent.content.size)return false;i=findCutAfter(r)}let s=i&&i.nodeAfter;if(!s||!NodeSelection.isSelectable(s))return false;if(t)t(e.tr.setSelection(NodeSelection.create(e.doc,i.pos)).scrollIntoView());return true};function findCutAfter(e){if(!e.parent.type.spec.isolating)for(let t=e.depth-1;t>=0;t--){let n=e.node(t);if(e.index(t)+1<n.childCount)return e.doc.resolve(e.after(t+1));if(n.type.spec.isolating)break}return null}const joinUp=(e,t)=>{let n=e.selection,r=n instanceof NodeSelection,o;if(r){if(n.node.isTextblock||!canJoin(e.doc,n.from))return false;o=n.from}else{o=joinPoint(e.doc,n.from,-1);if(o==null)return false}if(t){let n=e.tr.join(o);if(r)n.setSelection(NodeSelection.create(n.doc,o-e.doc.resolve(o).nodeBefore.nodeSize));t(n.scrollIntoView())}return true};const joinDown=(e,t)=>{let n=e.selection,r;if(n instanceof NodeSelection){if(n.node.isTextblock||!canJoin(e.doc,n.to))return false;r=n.to}else{r=joinPoint(e.doc,n.to,1);if(r==null)return false}if(t)t(e.tr.join(r).scrollIntoView());return true};const lift=(e,t)=>{let{$from:n,$to:r}=e.selection;let o=n.blockRange(r),i=o&&liftTarget(o);if(i==null)return false;if(t)t(e.tr.lift(o,i).scrollIntoView());return true};const newlineInCode=(e,t)=>{let{$head:n,$anchor:r}=e.selection;if(!n.parent.type.spec.code||!n.sameParent(r))return false;if(t)t(e.tr.insertText("\n").scrollIntoView());return true};function defaultBlockAt(e){for(let t=0;t<e.edgeCount;t++){let{type:n}=e.edge(t);if(n.isTextblock&&!n.hasRequiredAttrs())return n}return null}const exitCode=(e,t)=>{let{$head:n,$anchor:r}=e.selection;if(!n.parent.type.spec.code||!n.sameParent(r))return false;let o=n.node(-1),i=n.indexAfter(-1),s=defaultBlockAt(o.contentMatchAt(i));if(!s||!o.canReplaceWith(i,i,s))return false;if(t){let r=n.after(),o=e.tr.replaceWith(r,r,s.createAndFill());o.setSelection(Selection.near(o.doc.resolve(r),1));t(o.scrollIntoView())}return true};const createParagraphNear=(e,t)=>{let n=e.selection,{$from:r,$to:o}=n;if(n instanceof AllSelection||r.parent.inlineContent||o.parent.inlineContent)return false;let i=defaultBlockAt(o.parent.contentMatchAt(o.indexAfter()));if(!i||!i.isTextblock)return false;if(t){let n=(!r.parentOffset&&o.index()<o.parent.childCount?r:o).pos;let s=e.tr.insert(n,i.createAndFill());s.setSelection(TextSelection.create(s.doc,n+1));t(s.scrollIntoView())}return true};const liftEmptyBlock=(e,t)=>{let{$cursor:n}=e.selection;if(!n||n.parent.content.size)return false;if(n.depth>1&&n.after()!=n.end(-1)){let r=n.before();if(canSplit(e.doc,r)){if(t)t(e.tr.split(r).scrollIntoView());return true}}let r=n.blockRange(),o=r&&liftTarget(r);if(o==null)return false;if(t)t(e.tr.lift(r,o).scrollIntoView());return true};function splitBlockAs(e){return(e,t)=>{let{$from:n,$to:r}=e.selection;if(e.selection instanceof NodeSelection&&e.selection.node.isBlock){if(!n.parentOffset||!canSplit(e.doc,n.pos))return false;if(t)t(e.tr.split(n.pos).scrollIntoView());return true}if(!n.parent.isBlock)return false;if(t){let o=r.parentOffset==r.parent.content.size;let i=e.tr;if(e.selection instanceof TextSelection||e.selection instanceof AllSelection)i.deleteSelection();let s=n.depth==0?null:defaultBlockAt(n.node(-1).contentMatchAt(n.indexAfter(-1)));let a=o&&s?[{type:s}]:undefined;let l=canSplit(i.doc,i.mapping.map(n.pos),1,a);if(!a&&!l&&canSplit(i.doc,i.mapping.map(n.pos),1,s?[{type:s}]:undefined)){if(s)a=[{type:s}];l=true}if(l){i.split(i.mapping.map(n.pos),1,a);if(!o&&!n.parentOffset&&n.parent.type!=s){let e=i.mapping.map(n.before()),t=i.doc.resolve(e);if(s&&n.node(-1).canReplaceWith(t.index(),t.index()+1,s))i.setNodeMarkup(i.mapping.map(n.before()),s)}}t(i.scrollIntoView())}return true}}const splitBlock=splitBlockAs();const selectParentNode=(e,t)=>{let{$from:n,to:r}=e.selection,o;let i=n.sharedDepth(r);if(i==0)return false;o=n.before(i);if(t)t(e.tr.setSelection(NodeSelection.create(e.doc,o)));return true};const selectAll=(e,t)=>{if(t)t(e.tr.setSelection(new AllSelection(e.doc)));return true};function joinMaybeClear(e,t,n){let r=t.nodeBefore,o=t.nodeAfter,i=t.index();if(!r||!o||!r.type.compatibleContent(o.type))return false;if(!r.content.size&&t.parent.canReplace(i-1,i)){if(n)n(e.tr.delete(t.pos-r.nodeSize,t.pos).scrollIntoView());return true}if(!t.parent.canReplace(i,i+1)||!(o.isTextblock||canJoin(e.doc,t.pos)))return false;if(n)n(e.tr.clearIncompatible(t.pos,r.type,r.contentMatchAt(r.childCount)).join(t.pos).scrollIntoView());return true}function deleteBarrier(e,t,n,r){let o=t.nodeBefore,i=t.nodeAfter,s,a;let l=o.type.spec.isolating||i.type.spec.isolating;if(!l&&joinMaybeClear(e,t,n))return true;let c=!l&&t.parent.canReplace(t.index(),t.index()+1);if(c&&(s=(a=o.contentMatchAt(o.childCount)).findWrapping(i.type))&&a.matchType(s[0]||i.type).validEnd){if(n){let r=t.pos+i.nodeSize,a=Fragment.empty;for(let e=s.length-1;e>=0;e--)a=Fragment.from(s[e].create(null,a));a=Fragment.from(o.copy(a));let l=e.tr.step(new ReplaceAroundStep(t.pos-1,r,t.pos,r,new Slice(a,1,0),s.length,true));let c=r+2*s.length;if(canJoin(l.doc,c))l.join(c);n(l.scrollIntoView())}return true}let d=i.type.spec.isolating||r>0&&l?null:Selection.findFrom(t,1);let u=d&&d.$from.blockRange(d.$to),p=u&&liftTarget(u);if(p!=null&&p>=t.depth){if(n)n(e.tr.lift(u,p).scrollIntoView());return true}if(c&&textblockAt(i,"start",true)&&textblockAt(o,"end")){let r=o,s=[];for(;;){s.push(r);if(r.isTextblock)break;r=r.lastChild}let a=i,l=1;for(;!a.isTextblock;a=a.firstChild)l++;if(r.canReplace(r.childCount,r.childCount,a.content)){if(n){let r=Fragment.empty;for(let e=s.length-1;e>=0;e--)r=Fragment.from(s[e].copy(r));let o=e.tr.step(new ReplaceAroundStep(t.pos-s.length,t.pos+i.nodeSize,t.pos+l,t.pos+i.nodeSize-l,new Slice(r,s.length,0),0,true));n(o.scrollIntoView())}return true}}return false}function selectTextblockSide(e){return function(t,n){let r=t.selection,o=e<0?r.$from:r.$to;let i=o.depth;while(o.node(i).isInline){if(!i)return false;i--}if(!o.node(i).isTextblock)return false;if(n)n(t.tr.setSelection(TextSelection.create(t.doc,e<0?o.start(i):o.end(i))));return true}}const selectTextblockStart=selectTextblockSide(-1);const selectTextblockEnd=selectTextblockSide(1);function wrapIn(e,t=null){return function(n,r){let{$from:o,$to:i}=n.selection;let s=o.blockRange(i),a=s&&findWrapping(s,e,t);if(!a)return false;if(r)r(n.tr.wrap(s,a).scrollIntoView());return true}}function setBlockType(e,t=null){return function(n,r){let o=false;for(let r=0;r<n.selection.ranges.length&&!o;r++){let{$from:{pos:i},$to:{pos:s}}=n.selection.ranges[r];n.doc.nodesBetween(i,s,((r,i)=>{if(o)return false;if(!r.isTextblock||r.hasMarkup(e,t))return;if(r.type==e){o=true}else{let t=n.doc.resolve(i),r=t.index();o=t.parent.canReplaceWith(r,r+1,e)}}))}if(!o)return false;if(r){let o=n.tr;for(let r=0;r<n.selection.ranges.length;r++){let{$from:{pos:i},$to:{pos:s}}=n.selection.ranges[r];o.setBlockType(i,s,e,t)}r(o.scrollIntoView())}return true}}function markApplies(e,t,n,r){for(let o=0;o<t.length;o++){let{$from:i,$to:s}=t[o];let a=i.depth==0?e.inlineContent&&e.type.allowsMarkType(n):false;e.nodesBetween(i.pos,s.pos,((e,t)=>{if(a||!r)return false;a=e.inlineContent&&e.type.allowsMarkType(n)}));if(a)return true}return false}function toggleMark(e,t=null,n){let r=n!==false;return function(n,o){let{empty:i,$cursor:s,ranges:a}=n.selection;if(i&&!s||!markApplies(n.doc,a,e,r))return false;if(o){if(s){if(e.isInSet(n.storedMarks||s.marks()))o(n.tr.removeStoredMark(e));else o(n.tr.addStoredMark(e.create(t)))}else{let r,i=n.tr;{r=!a.some((t=>n.doc.rangeHasMark(t.$from.pos,t.$to.pos,e)))}for(let n=0;n<a.length;n++){let{$from:o,$to:s}=a[n];if(!r){i.removeMark(o.pos,s.pos,e)}else{let n=o.pos,r=s.pos,a=o.nodeAfter,l=s.nodeBefore;let c=a&&a.isText?/^\s*/.exec(a.text)[0].length:0;let d=l&&l.isText?/\s*$/.exec(l.text)[0].length:0;if(n+c<r){n+=c;r-=d}i.addMark(n,r,e.create(t))}}o(i.scrollIntoView())}}return true}}function chainCommands(...e){return function(t,n,r){for(let o=0;o<e.length;o++)if(e[o](t,n,r))return true;return false}}let backspace=chainCommands(deleteSelection,joinBackward,selectNodeBackward);let del=chainCommands(deleteSelection,joinForward,selectNodeForward);const pcBaseKeymap={Enter:chainCommands(newlineInCode,createParagraphNear,liftEmptyBlock,splitBlock),"Mod-Enter":exitCode,Backspace:backspace,"Mod-Backspace":backspace,"Shift-Backspace":backspace,Delete:del,"Mod-Delete":del,"Mod-a":selectAll};const macBaseKeymap={"Ctrl-h":pcBaseKeymap["Backspace"],"Alt-Backspace":pcBaseKeymap["Mod-Backspace"],"Ctrl-d":pcBaseKeymap["Delete"],"Ctrl-Alt-Backspace":pcBaseKeymap["Mod-Delete"],"Alt-Delete":pcBaseKeymap["Mod-Delete"],"Alt-d":pcBaseKeymap["Mod-Delete"],"Ctrl-a":selectTextblockStart,"Ctrl-e":selectTextblockEnd};for(let e in pcBaseKeymap)macBaseKeymap[e]=pcBaseKeymap[e];const mac$1=typeof navigator!="undefined"?/Mac|iP(hone|[oa]d)/.test(navigator.platform):typeof os!="undefined"&&os.platform?os.platform()=="darwin":false;const baseKeymap=mac$1?macBaseKeymap:pcBaseKeymap;var readFromCache;var addToCache;if(typeof WeakMap!="undefined"){let e=new WeakMap;readFromCache=t=>e.get(t);addToCache=(t,n)=>{e.set(t,n);return n}}else{const e=[];const t=10;let n=0;readFromCache=t=>{for(let n=0;n<e.length;n+=2)if(e[n]==t)return e[n+1]};addToCache=(r,o)=>{if(n==t)n=0;e[n++]=r;return e[n++]=o}}var TableMap=class{constructor(e,t,n,r){this.width=e;this.height=t;this.map=n;this.problems=r}findCell(e){for(let t=0;t<this.map.length;t++){const n=this.map[t];if(n!=e)continue;const r=t%this.width;const o=t/this.width|0;let i=r+1;let s=o+1;for(let e=1;i<this.width&&this.map[t+e]==n;e++){i++}for(let e=1;s<this.height&&this.map[t+this.width*e]==n;e++){s++}return{left:r,top:o,right:i,bottom:s}}throw new RangeError(`No cell with offset ${e} found`)}colCount(e){for(let t=0;t<this.map.length;t++){if(this.map[t]==e){return t%this.width}}throw new RangeError(`No cell with offset ${e} found`)}nextCell(e,t,n){const{left:r,right:o,top:i,bottom:s}=this.findCell(e);if(t=="horiz"){if(n<0?r==0:o==this.width)return null;return this.map[i*this.width+(n<0?r-1:o)]}else{if(n<0?i==0:s==this.height)return null;return this.map[r+this.width*(n<0?i-1:s)]}}rectBetween(e,t){const{left:n,right:r,top:o,bottom:i}=this.findCell(e);const{left:s,right:a,top:l,bottom:c}=this.findCell(t);return{left:Math.min(n,s),top:Math.min(o,l),right:Math.max(r,a),bottom:Math.max(i,c)}}cellsInRect(e){const t=[];const n={};for(let r=e.top;r<e.bottom;r++){for(let o=e.left;o<e.right;o++){const i=r*this.width+o;const s=this.map[i];if(n[s])continue;n[s]=true;if(o==e.left&&o&&this.map[i-1]==s||r==e.top&&r&&this.map[i-this.width]==s){continue}t.push(s)}}return t}positionAt(e,t,n){for(let r=0,o=0;;r++){const i=o+n.child(r).nodeSize;if(r==e){let n=t+e*this.width;const r=(e+1)*this.width;while(n<r&&this.map[n]<o)n++;return n==r?i-1:this.map[n]}o=i}}static get(e){return readFromCache(e)||addToCache(e,computeMap(e))}};function computeMap(e){if(e.type.spec.tableRole!="table")throw new RangeError("Not a table node: "+e.type.name);const t=findWidth(e),n=e.childCount;const r=[];let o=0;let i=null;const s=[];for(let e=0,o=t*n;e<o;e++)r[e]=0;for(let a=0,l=0;a<n;a++){const c=e.child(a);l++;for(let e=0;;e++){while(o<r.length&&r[o]!=0)o++;if(e==c.childCount)break;const d=c.child(e);const{colspan:u,rowspan:p,colwidth:f}=d.attrs;for(let e=0;e<p;e++){if(e+a>=n){(i||(i=[])).push({type:"overlong_rowspan",pos:l,n:p-e});break}const c=o+e*t;for(let e=0;e<u;e++){if(r[c+e]==0)r[c+e]=l;else(i||(i=[])).push({type:"collision",row:a,pos:l,n:u-e});const n=f&&f[e];if(n){const r=(c+e)%t*2,o=s[r];if(o==null||o!=n&&s[r+1]==1){s[r]=n;s[r+1]=1}else if(o==n){s[r+1]++}}}}o+=u;l+=d.nodeSize}const d=(a+1)*t;let u=0;while(o<d)if(r[o++]==0)u++;if(u)(i||(i=[])).push({type:"missing",row:a,n:u});l++}const a=new TableMap(t,n,r,i);let l=false;for(let e=0;!l&&e<s.length;e+=2)if(s[e]!=null&&s[e+1]<n)l=true;if(l)findBadColWidths(a,s,e);return a}function findWidth(e){let t=-1;let n=false;for(let r=0;r<e.childCount;r++){const o=e.child(r);let i=0;if(n)for(let t=0;t<r;t++){const n=e.child(t);for(let e=0;e<n.childCount;e++){const o=n.child(e);if(t+o.attrs.rowspan>r)i+=o.attrs.colspan}}for(let e=0;e<o.childCount;e++){const t=o.child(e);i+=t.attrs.colspan;if(t.attrs.rowspan>1)n=true}if(t==-1)t=i;else if(t!=i)t=Math.max(t,i)}return t}function findBadColWidths(e,t,n){if(!e.problems)e.problems=[];const r={};for(let o=0;o<e.map.length;o++){const i=e.map[o];if(r[i])continue;r[i]=true;const s=n.nodeAt(i);if(!s){throw new RangeError(`No cell with offset ${i} found`)}let a=null;const l=s.attrs;for(let n=0;n<l.colspan;n++){const r=(o+n)%e.width;const i=t[r*2];if(i!=null&&(!l.colwidth||l.colwidth[n]!=i))(a||(a=freshColWidth(l)))[n]=i}if(a)e.problems.unshift({type:"colwidth mismatch",pos:i,colwidth:a})}}function freshColWidth(e){if(e.colwidth)return e.colwidth.slice();const t=[];for(let n=0;n<e.colspan;n++)t.push(0);return t}function tableNodeTypes(e){let t=e.cached.tableNodeTypes;if(!t){t=e.cached.tableNodeTypes={};for(const n in e.nodes){const r=e.nodes[n],o=r.spec.tableRole;if(o)t[o]=r}}return t}var tableEditingKey=new PluginKey("selectingCells");function cellAround(e){for(let t=e.depth-1;t>0;t--)if(e.node(t).type.spec.tableRole=="row")return e.node(0).resolve(e.before(t+1));return null}function cellWrapping(e){for(let t=e.depth;t>0;t--){const n=e.node(t).type.spec.tableRole;if(n==="cell"||n==="header_cell")return e.node(t)}return null}function isInTable(e){const t=e.selection.$head;for(let e=t.depth;e>0;e--)if(t.node(e).type.spec.tableRole=="row")return true;return false}function selectionCell(e){const t=e.selection;if("$anchorCell"in t&&t.$anchorCell){return t.$anchorCell.pos>t.$headCell.pos?t.$anchorCell:t.$headCell}else if("node"in t&&t.node&&t.node.type.spec.tableRole=="cell"){return t.$anchor}const n=cellAround(t.$head)||cellNear(t.$head);if(n){return n}throw new RangeError(`No cell found around position ${t.head}`)}function cellNear(e){for(let t=e.nodeAfter,n=e.pos;t;t=t.firstChild,n++){const r=t.type.spec.tableRole;if(r=="cell"||r=="header_cell")return e.doc.resolve(n)}for(let t=e.nodeBefore,n=e.pos;t;t=t.lastChild,n--){const r=t.type.spec.tableRole;if(r=="cell"||r=="header_cell")return e.doc.resolve(n-t.nodeSize)}}function pointsAtCell(e){return e.parent.type.spec.tableRole=="row"&&!!e.nodeAfter}function moveCellForward(e){return e.node(0).resolve(e.pos+e.nodeAfter.nodeSize)}function inSameTable(e,t){return e.depth==t.depth&&e.pos>=t.start(-1)&&e.pos<=t.end(-1)}function nextCell(e,t,n){const r=e.node(-1);const o=TableMap.get(r);const i=e.start(-1);const s=o.nextCell(e.pos-i,t,n);return s==null?null:e.node(0).resolve(i+s)}function removeColSpan(e,t,n=1){const r={...e,colspan:e.colspan-n};if(r.colwidth){r.colwidth=r.colwidth.slice();r.colwidth.splice(t,n);if(!r.colwidth.some((e=>e>0)))r.colwidth=null}return r}function addColSpan(e,t,n=1){const r={...e,colspan:e.colspan+n};if(r.colwidth){r.colwidth=r.colwidth.slice();for(let e=0;e<n;e++)r.colwidth.splice(t,0,0)}return r}function columnIsHeader(e,t,n){const r=tableNodeTypes(t.type.schema).header_cell;for(let o=0;o<e.height;o++)if(t.nodeAt(e.map[n+o*e.width]).type!=r)return false;return true}var CellSelection=class e extends Selection{constructor(e,t=e){const n=e.node(-1);const r=TableMap.get(n);const o=e.start(-1);const i=r.rectBetween(e.pos-o,t.pos-o);const s=e.node(0);const a=r.cellsInRect(i).filter((e=>e!=t.pos-o));a.unshift(t.pos-o);const l=a.map((e=>{const t=n.nodeAt(e);if(!t){throw RangeError(`No cell with offset ${e} found`)}const r=o+e+1;return new SelectionRange(s.resolve(r),s.resolve(r+t.content.size))}));super(l[0].$from,l[0].$to,l);this.$anchorCell=e;this.$headCell=t}map(t,n){const r=t.resolve(n.map(this.$anchorCell.pos));const o=t.resolve(n.map(this.$headCell.pos));if(pointsAtCell(r)&&pointsAtCell(o)&&inSameTable(r,o)){const t=this.$anchorCell.node(-1)!=r.node(-1);if(t&&this.isRowSelection())return e.rowSelection(r,o);else if(t&&this.isColSelection())return e.colSelection(r,o);else return new e(r,o)}return TextSelection.between(r,o)}content(){const e=this.$anchorCell.node(-1);const t=TableMap.get(e);const n=this.$anchorCell.start(-1);const r=t.rectBetween(this.$anchorCell.pos-n,this.$headCell.pos-n);const o={};const i=[];for(let n=r.top;n<r.bottom;n++){const s=[];for(let i=n*t.width+r.left,a=r.left;a<r.right;a++,i++){const n=t.map[i];if(o[n])continue;o[n]=true;const a=t.findCell(n);let l=e.nodeAt(n);if(!l){throw RangeError(`No cell with offset ${n} found`)}const c=r.left-a.left;const d=a.right-r.right;if(c>0||d>0){let e=l.attrs;if(c>0){e=removeColSpan(e,0,c)}if(d>0){e=removeColSpan(e,e.colspan-d,d)}if(a.left<r.left){l=l.type.createAndFill(e);if(!l){throw RangeError(`Could not create cell with attrs ${JSON.stringify(e)}`)}}else{l=l.type.create(e,l.content)}}if(a.top<r.top||a.bottom>r.bottom){const e={...l.attrs,rowspan:Math.min(a.bottom,r.bottom)-Math.max(a.top,r.top)};if(a.top<r.top){l=l.type.createAndFill(e)}else{l=l.type.create(e,l.content)}}s.push(l)}i.push(e.child(n).copy(Fragment.from(s)))}const s=this.isColSelection()&&this.isRowSelection()?e:i;return new Slice(Fragment.from(s),1,1)}replace(e,t=Slice.empty){const n=e.steps.length,r=this.ranges;for(let o=0;o<r.length;o++){const{$from:i,$to:s}=r[o],a=e.mapping.slice(n);e.replace(a.map(i.pos),a.map(s.pos),o?Slice.empty:t)}const o=Selection.findFrom(e.doc.resolve(e.mapping.slice(n).map(this.to)),-1);if(o)e.setSelection(o)}replaceWith(e,t){this.replace(e,new Slice(Fragment.from(t),0,0))}forEachCell(e){const t=this.$anchorCell.node(-1);const n=TableMap.get(t);const r=this.$anchorCell.start(-1);const o=n.cellsInRect(n.rectBetween(this.$anchorCell.pos-r,this.$headCell.pos-r));for(let n=0;n<o.length;n++){e(t.nodeAt(o[n]),r+o[n])}}isColSelection(){const e=this.$anchorCell.index(-1);const t=this.$headCell.index(-1);if(Math.min(e,t)>0)return false;const n=e+this.$anchorCell.nodeAfter.attrs.rowspan;const r=t+this.$headCell.nodeAfter.attrs.rowspan;return Math.max(n,r)==this.$headCell.node(-1).childCount}static colSelection(t,n=t){const r=t.node(-1);const o=TableMap.get(r);const i=t.start(-1);const s=o.findCell(t.pos-i);const a=o.findCell(n.pos-i);const l=t.node(0);if(s.top<=a.top){if(s.top>0)t=l.resolve(i+o.map[s.left]);if(a.bottom<o.height)n=l.resolve(i+o.map[o.width*(o.height-1)+a.right-1])}else{if(a.top>0)n=l.resolve(i+o.map[a.left]);if(s.bottom<o.height)t=l.resolve(i+o.map[o.width*(o.height-1)+s.right-1])}return new e(t,n)}isRowSelection(){const e=this.$anchorCell.node(-1);const t=TableMap.get(e);const n=this.$anchorCell.start(-1);const r=t.colCount(this.$anchorCell.pos-n);const o=t.colCount(this.$headCell.pos-n);if(Math.min(r,o)>0)return false;const i=r+this.$anchorCell.nodeAfter.attrs.colspan;const s=o+this.$headCell.nodeAfter.attrs.colspan;return Math.max(i,s)==t.width}eq(t){return t instanceof e&&t.$anchorCell.pos==this.$anchorCell.pos&&t.$headCell.pos==this.$headCell.pos}static rowSelection(t,n=t){const r=t.node(-1);const o=TableMap.get(r);const i=t.start(-1);const s=o.findCell(t.pos-i);const a=o.findCell(n.pos-i);const l=t.node(0);if(s.left<=a.left){if(s.left>0)t=l.resolve(i+o.map[s.top*o.width]);if(a.right<o.width)n=l.resolve(i+o.map[o.width*(a.top+1)-1])}else{if(a.left>0)n=l.resolve(i+o.map[a.top*o.width]);if(s.right<o.width)t=l.resolve(i+o.map[o.width*(s.top+1)-1])}return new e(t,n)}toJSON(){return{type:"cell",anchor:this.$anchorCell.pos,head:this.$headCell.pos}}static fromJSON(t,n){return new e(t.resolve(n.anchor),t.resolve(n.head))}static create(t,n,r=n){return new e(t.resolve(n),t.resolve(r))}getBookmark(){return new CellBookmark(this.$anchorCell.pos,this.$headCell.pos)}};CellSelection.prototype.visible=false;Selection.jsonID("cell",CellSelection);var CellBookmark=class e{constructor(e,t){this.anchor=e;this.head=t}map(t){return new e(t.map(this.anchor),t.map(this.head))}resolve(e){const t=e.resolve(this.anchor),n=e.resolve(this.head);if(t.parent.type.spec.tableRole=="row"&&n.parent.type.spec.tableRole=="row"&&t.index()<t.parent.childCount&&n.index()<n.parent.childCount&&inSameTable(t,n))return new CellSelection(t,n);else return Selection.near(n,1)}};function drawCellSelection(e){if(!(e.selection instanceof CellSelection))return null;const t=[];e.selection.forEachCell(((e,n)=>{t.push(Decoration.node(n,n+e.nodeSize,{class:"selectedCell"}))}));return DecorationSet.create(e.doc,t)}function isCellBoundarySelection({$from:e,$to:t}){if(e.pos==t.pos||e.pos<e.pos-6)return false;let n=e.pos;let r=t.pos;let o=e.depth;for(;o>=0;o--,n++)if(e.after(o+1)<e.end(o))break;for(let e=t.depth;e>=0;e--,r--)if(t.before(e+1)>t.start(e))break;return n==r&&/row|table/.test(e.node(o).type.spec.tableRole)}function isTextSelectionAcrossCells({$from:e,$to:t}){let n;let r;for(let t=e.depth;t>0;t--){const r=e.node(t);if(r.type.spec.tableRole==="cell"||r.type.spec.tableRole==="header_cell"){n=r;break}}for(let e=t.depth;e>0;e--){const n=t.node(e);if(n.type.spec.tableRole==="cell"||n.type.spec.tableRole==="header_cell"){r=n;break}}return n!==r&&t.parentOffset===0}function normalizeSelection(e,t,n){const r=(t||e).selection;const o=(t||e).doc;let i;let s;if(r instanceof NodeSelection&&(s=r.node.type.spec.tableRole)){if(s=="cell"||s=="header_cell"){i=CellSelection.create(o,r.from)}else if(s=="row"){const e=o.resolve(r.from+1);i=CellSelection.rowSelection(e,e)}else if(!n){const e=TableMap.get(r.node);const t=r.from+1;const n=t+e.map[e.width*e.height-1];i=CellSelection.create(o,t+1,n)}}else if(r instanceof TextSelection&&isCellBoundarySelection(r)){i=TextSelection.create(o,r.from)}else if(r instanceof TextSelection&&isTextSelectionAcrossCells(r)){i=TextSelection.create(o,r.$from.start(),r.$from.end())}if(i)(t||(t=e.tr)).setSelection(i);return t}var fixTablesKey=new PluginKey("fix-tables");function changedDescendants(e,t,n,r){const o=e.childCount,i=t.childCount;e:for(let s=0,a=0;s<i;s++){const i=t.child(s);for(let t=a,r=Math.min(o,s+3);t<r;t++){if(e.child(t)==i){a=t+1;n+=i.nodeSize;continue e}}r(i,n);if(a<o&&e.child(a).sameMarkup(i))changedDescendants(e.child(a),i,n+1,r);else i.nodesBetween(0,i.content.size,r,n+1);n+=i.nodeSize}}function fixTables(e,t){let n;const r=(t,r)=>{if(t.type.spec.tableRole=="table")n=fixTable(e,t,r,n)};if(!t)e.doc.descendants(r);else if(t.doc!=e.doc)changedDescendants(t.doc,e.doc,0,r);return n}function fixTable(e,t,n,r){const o=TableMap.get(t);if(!o.problems)return r;if(!r)r=e.tr;const i=[];for(let e=0;e<o.height;e++)i.push(0);for(let e=0;e<o.problems.length;e++){const s=o.problems[e];if(s.type=="collision"){const e=t.nodeAt(s.pos);if(!e)continue;const o=e.attrs;for(let e=0;e<o.rowspan;e++)i[s.row+e]+=s.n;r.setNodeMarkup(r.mapping.map(n+1+s.pos),null,removeColSpan(o,o.colspan-s.n,s.n))}else if(s.type=="missing"){i[s.row]+=s.n}else if(s.type=="overlong_rowspan"){const e=t.nodeAt(s.pos);if(!e)continue;r.setNodeMarkup(r.mapping.map(n+1+s.pos),null,{...e.attrs,rowspan:e.attrs.rowspan-s.n})}else if(s.type=="colwidth mismatch"){const e=t.nodeAt(s.pos);if(!e)continue;r.setNodeMarkup(r.mapping.map(n+1+s.pos),null,{...e.attrs,colwidth:s.colwidth})}}let s,a;for(let e=0;e<i.length;e++)if(i[e]){if(s==null)s=e;a=e}for(let l=0,c=n+1;l<o.height;l++){const n=t.child(l);const o=c+n.nodeSize;const d=i[l];if(d>0){let t="cell";if(n.firstChild){t=n.firstChild.type.spec.tableRole}const i=[];for(let n=0;n<d;n++){const n=tableNodeTypes(e.schema)[t].createAndFill();if(n)i.push(n)}const u=(l==0||s==l-1)&&a==l?c+1:o-1;r.insert(r.mapping.map(u),i)}c=o}return r.setMeta(fixTablesKey,{fixTables:true})}function pastedCells(e){if(!e.size)return null;let{content:t,openStart:n,openEnd:r}=e;while(t.childCount==1&&(n>0&&r>0||t.child(0).type.spec.tableRole=="table")){n--;r--;t=t.child(0).content}const o=t.child(0);const i=o.type.spec.tableRole;const s=o.type.schema,a=[];if(i=="row"){for(let e=0;e<t.childCount;e++){let o=t.child(e).content;const i=e?0:Math.max(0,n-1);const l=e<t.childCount-1?0:Math.max(0,r-1);if(i||l)o=fitSlice(tableNodeTypes(s).row,new Slice(o,i,l)).content;a.push(o)}}else if(i=="cell"||i=="header_cell"){a.push(n||r?fitSlice(tableNodeTypes(s).row,new Slice(t,n,r)).content:t)}else{return null}return ensureRectangular(s,a)}function ensureRectangular(e,t){const n=[];for(let e=0;e<t.length;e++){const r=t[e];for(let t=r.childCount-1;t>=0;t--){const{rowspan:o,colspan:i}=r.child(t).attrs;for(let t=e;t<e+o;t++)n[t]=(n[t]||0)+i}}let r=0;for(let e=0;e<n.length;e++)r=Math.max(r,n[e]);for(let o=0;o<n.length;o++){if(o>=t.length)t.push(Fragment.empty);if(n[o]<r){const i=tableNodeTypes(e).cell.createAndFill();const s=[];for(let e=n[o];e<r;e++){s.push(i)}t[o]=t[o].append(Fragment.from(s))}}return{height:t.length,width:r,rows:t}}function fitSlice(e,t){const n=e.createAndFill();const r=new Transform(n).replace(0,n.content.size,t);return r.doc}function clipCells({width:e,height:t,rows:n},r,o){if(e!=r){const t=[];const o=[];for(let e=0;e<n.length;e++){const i=n[e],s=[];for(let n=t[e]||0,o=0;n<r;o++){let a=i.child(o%i.childCount);if(n+a.attrs.colspan>r)a=a.type.createChecked(removeColSpan(a.attrs,a.attrs.colspan,n+a.attrs.colspan-r),a.content);s.push(a);n+=a.attrs.colspan;for(let n=1;n<a.attrs.rowspan;n++)t[e+n]=(t[e+n]||0)+a.attrs.colspan}o.push(Fragment.from(s))}n=o;e=r}if(t!=o){const e=[];for(let r=0,i=0;r<o;r++,i++){const s=[],a=n[i%t];for(let e=0;e<a.childCount;e++){let t=a.child(e);if(r+t.attrs.rowspan>o)t=t.type.create({...t.attrs,rowspan:Math.max(1,o-t.attrs.rowspan)},t.content);s.push(t)}e.push(Fragment.from(s))}n=e;t=o}return{width:e,height:t,rows:n}}function growTable(e,t,n,r,o,i,s){const a=e.doc.type.schema;const l=tableNodeTypes(a);let c;let d;if(o>t.width){for(let i=0,a=0;i<t.height;i++){const u=n.child(i);a+=u.nodeSize;const p=[];let f;if(u.lastChild==null||u.lastChild.type==l.cell)f=c||(c=l.cell.createAndFill());else f=d||(d=l.header_cell.createAndFill());for(let e=t.width;e<o;e++)p.push(f);e.insert(e.mapping.slice(s).map(a-1+r),p)}}if(i>t.height){const a=[];for(let e=0,r=(t.height-1)*t.width;e<Math.max(t.width,o);e++){const o=e>=t.width?false:n.nodeAt(t.map[r+e]).type==l.header_cell;a.push(o?d||(d=l.header_cell.createAndFill()):c||(c=l.cell.createAndFill()))}const u=l.row.create(null,Fragment.from(a)),p=[];for(let e=t.height;e<i;e++)p.push(u);e.insert(e.mapping.slice(s).map(r+n.nodeSize-2),p)}return!!(c||d)}function isolateHorizontal(e,t,n,r,o,i,s,a){if(s==0||s==t.height)return false;let l=false;for(let c=o;c<i;c++){const o=s*t.width+c,i=t.map[o];if(t.map[o-t.width]==i){l=true;const o=n.nodeAt(i);const{top:d,left:u}=t.findCell(i);e.setNodeMarkup(e.mapping.slice(a).map(i+r),null,{...o.attrs,rowspan:s-d});e.insert(e.mapping.slice(a).map(t.positionAt(s,u,n)),o.type.createAndFill({...o.attrs,rowspan:d+o.attrs.rowspan-s}));c+=o.attrs.colspan-1}}return l}function isolateVertical(e,t,n,r,o,i,s,a){if(s==0||s==t.width)return false;let l=false;for(let c=o;c<i;c++){const o=c*t.width+s,i=t.map[o];if(t.map[o-1]==i){l=true;const o=n.nodeAt(i);const d=t.colCount(i);const u=e.mapping.slice(a).map(i+r);e.setNodeMarkup(u,null,removeColSpan(o.attrs,s-d,o.attrs.colspan-(s-d)));e.insert(u+o.nodeSize,o.type.createAndFill(removeColSpan(o.attrs,0,s-d)));c+=o.attrs.rowspan-1}}return l}function insertCells(e,t,n,r,o){let i=n?e.doc.nodeAt(n-1):e.doc;if(!i){throw new Error("No table found")}let s=TableMap.get(i);const{top:a,left:l}=r;const c=l+o.width,d=a+o.height;const u=e.tr;let p=0;function f(){i=n?u.doc.nodeAt(n-1):u.doc;if(!i){throw new Error("No table found")}s=TableMap.get(i);p=u.mapping.maps.length}if(growTable(u,s,i,n,c,d,p))f();if(isolateHorizontal(u,s,i,n,l,c,a,p))f();if(isolateHorizontal(u,s,i,n,l,c,d,p))f();if(isolateVertical(u,s,i,n,a,d,l,p))f();if(isolateVertical(u,s,i,n,a,d,c,p))f();for(let e=a;e<d;e++){const t=s.positionAt(e,l,i),r=s.positionAt(e,c,i);u.replace(u.mapping.slice(p).map(t+n),u.mapping.slice(p).map(r+n),new Slice(o.rows[e-a],0,0))}f();u.setSelection(new CellSelection(u.doc.resolve(n+s.positionAt(a,l,i)),u.doc.resolve(n+s.positionAt(d-1,c-1,i))));t(u)}var handleKeyDown=keydownHandler({ArrowLeft:arrow("horiz",-1),ArrowRight:arrow("horiz",1),ArrowUp:arrow("vert",-1),ArrowDown:arrow("vert",1),"Shift-ArrowLeft":shiftArrow("horiz",-1),"Shift-ArrowRight":shiftArrow("horiz",1),"Shift-ArrowUp":shiftArrow("vert",-1),"Shift-ArrowDown":shiftArrow("vert",1),Backspace:deleteCellSelection,"Mod-Backspace":deleteCellSelection,Delete:deleteCellSelection,"Mod-Delete":deleteCellSelection});function maybeSetSelection(e,t,n){if(n.eq(e.selection))return false;if(t)t(e.tr.setSelection(n).scrollIntoView());return true}function arrow(e,t){return(n,r,o)=>{if(!o)return false;const i=n.selection;if(i instanceof CellSelection){return maybeSetSelection(n,r,Selection.near(i.$headCell,t))}if(e!="horiz"&&!i.empty)return false;const s=atEndOfCell(o,e,t);if(s==null)return false;if(e=="horiz"){return maybeSetSelection(n,r,Selection.near(n.doc.resolve(i.head+t),t))}else{const o=n.doc.resolve(s);const i=nextCell(o,e,t);let a;if(i)a=Selection.near(i,1);else if(t<0)a=Selection.near(n.doc.resolve(o.before(-1)),-1);else a=Selection.near(n.doc.resolve(o.after(-1)),1);return maybeSetSelection(n,r,a)}}}function shiftArrow(e,t){return(n,r,o)=>{if(!o)return false;const i=n.selection;let s;if(i instanceof CellSelection){s=i}else{const r=atEndOfCell(o,e,t);if(r==null)return false;s=new CellSelection(n.doc.resolve(r))}const a=nextCell(s.$headCell,e,t);if(!a)return false;return maybeSetSelection(n,r,new CellSelection(s.$anchorCell,a))}}function deleteCellSelection(e,t){const n=e.selection;if(!(n instanceof CellSelection))return false;if(t){const r=e.tr;const o=tableNodeTypes(e.schema).cell.createAndFill().content;n.forEachCell(((e,t)=>{if(!e.content.eq(o))r.replace(r.mapping.map(t+1),r.mapping.map(t+e.nodeSize-1),new Slice(o,0,0))}));if(r.docChanged)t(r)}return true}function handleTripleClick(e,t){const n=e.state.doc,r=cellAround(n.resolve(t));if(!r)return false;e.dispatch(e.state.tr.setSelection(new CellSelection(r)));return true}function handlePaste(e,t,n){if(!isInTable(e.state))return false;let r=pastedCells(n);const o=e.state.selection;if(o instanceof CellSelection){if(!r)r={width:1,height:1,rows:[Fragment.from(fitSlice(tableNodeTypes(e.state.schema).cell,n))]};const t=o.$anchorCell.node(-1);const i=o.$anchorCell.start(-1);const s=TableMap.get(t).rectBetween(o.$anchorCell.pos-i,o.$headCell.pos-i);r=clipCells(r,s.right-s.left,s.bottom-s.top);insertCells(e.state,e.dispatch,i,s,r);return true}else if(r){const t=selectionCell(e.state);const n=t.start(-1);insertCells(e.state,e.dispatch,n,TableMap.get(t.node(-1)).findCell(t.pos-n),r);return true}else{return false}}function handleMouseDown(e,t){var n;if(t.ctrlKey||t.metaKey)return;const r=domInCell(e,t.target);let o;if(t.shiftKey&&e.state.selection instanceof CellSelection){i(e.state.selection.$anchorCell,t);t.preventDefault()}else if(t.shiftKey&&r&&(o=cellAround(e.state.selection.$anchor))!=null&&((n=cellUnderMouse(e,t))==null?void 0:n.pos)!=o.pos){i(o,t);t.preventDefault()}else if(!r){return}function i(t,n){let r=cellUnderMouse(e,n);const o=tableEditingKey.getState(e.state)==null;if(!r||!inSameTable(t,r)){if(o)r=t;else return}const i=new CellSelection(t,r);if(o||!e.state.selection.eq(i)){const n=e.state.tr.setSelection(i);if(o)n.setMeta(tableEditingKey,t.pos);e.dispatch(n)}}function s(){e.root.removeEventListener("mouseup",s);e.root.removeEventListener("dragstart",s);e.root.removeEventListener("mousemove",a);if(tableEditingKey.getState(e.state)!=null)e.dispatch(e.state.tr.setMeta(tableEditingKey,-1))}function a(n){const o=n;const a=tableEditingKey.getState(e.state);let l;if(a!=null){l=e.state.doc.resolve(a)}else if(domInCell(e,o.target)!=r){l=cellUnderMouse(e,t);if(!l)return s()}if(l)i(l,o)}e.root.addEventListener("mouseup",s);e.root.addEventListener("dragstart",s);e.root.addEventListener("mousemove",a)}function atEndOfCell(e,t,n){if(!(e.state.selection instanceof TextSelection))return null;const{$head:r}=e.state.selection;for(let o=r.depth-1;o>=0;o--){const i=r.node(o),s=n<0?r.index(o):r.indexAfter(o);if(s!=(n<0?0:i.childCount))return null;if(i.type.spec.tableRole=="cell"||i.type.spec.tableRole=="header_cell"){const i=r.before(o);const s=t=="vert"?n>0?"down":"up":n>0?"right":"left";return e.endOfTextblock(s)?i:null}}return null}function domInCell(e,t){for(;t&&t!=e.dom;t=t.parentNode){if(t.nodeName=="TD"||t.nodeName=="TH"){return t}}return null}function cellUnderMouse(e,t){const n=e.posAtCoords({left:t.clientX,top:t.clientY});if(!n)return null;return n?cellAround(e.state.doc.resolve(n.pos)):null}var TableView=class{constructor(e,t){this.node=e;this.cellMinWidth=t;this.dom=document.createElement("div");this.dom.className="tableWrapper";this.table=this.dom.appendChild(document.createElement("table"));this.table.className=e.attrs.class;this.table.id=e.attrs.name;this.colgroup=this.table.appendChild(document.createElement("colgroup"));updateColumnsOnResize(e,this.colgroup,this.table,t);this.contentDOM=this.table.appendChild(document.createElement("tbody"))}update(e){if(e.type!=this.node.type)return false;this.node=e;updateColumnsOnResize(e,this.colgroup,this.table,this.cellMinWidth);return true}ignoreMutation(e){return e.type=="attributes"&&(e.target==this.table||this.colgroup.contains(e.target))}};function updateColumnsOnResize(e,t,n,r,o,i){var s;let a=0;let l=true;let c=t.firstChild;const d=e.firstChild;if(!d)return;for(let e=0,n=0;e<d.childCount;e++){const{colspan:s,colwidth:u}=d.child(e).attrs;for(let e=0;e<s;e++,n++){const s=o==n?i:u&&u[e];const d=s?s+"px":"";a+=s||r;if(!s)l=false;if(!c){t.appendChild(document.createElement("col")).style.width=d}else{if(c.style.width!=d)c.style.width=d;c=c.nextSibling}}}while(c){const e=c.nextSibling;(s=c.parentNode)==null?void 0:s.removeChild(c);c=e}if(l){n.style.width=a+"px";n.style.minWidth=""}else{n.style.width="";n.style.minWidth=a+"px"}n.className=e.attrs.class;n.id=e.attrs.name}var columnResizingPluginKey=new PluginKey("tableColumnResizing");function columnResizing({handleWidth:e=5,cellMinWidth:t=25,View:n=TableView,lastColumnResizable:r=true}={}){const o=new Plugin({key:columnResizingPluginKey,state:{init(e,r){var i,s;const a=(s=(i=o.spec)==null?void 0:i.props)==null?void 0:s.nodeViews;const l=tableNodeTypes(r.schema).table.name;if(n&&a){a[l]=(e,r)=>new n(e,t,r)}return new ResizeState(-1,false)},apply(e,t){return t.apply(e)}},props:{attributes:e=>{const t=columnResizingPluginKey.getState(e);return t&&t.activeHandle>-1?{class:"resize-cursor"}:{}},handleDOMEvents:{mousemove:(n,o)=>{handleMouseMove(n,o,e,t,r)},mouseleave:e=>{handleMouseLeave(e)},mousedown:(e,n)=>{handleMouseDown2(e,n,t)}},decorations:e=>{const t=columnResizingPluginKey.getState(e);if(t&&t.activeHandle>-1){return handleDecorations(e,t.activeHandle)}},nodeViews:{}}});return o}var ResizeState=class e{constructor(e,t){this.activeHandle=e;this.dragging=t}apply(t){const n=this;const r=t.getMeta(columnResizingPluginKey);if(r&&r.setHandle!=null)return new e(r.setHandle,false);if(r&&r.setDragging!==void 0)return new e(n.activeHandle,r.setDragging);if(n.activeHandle>-1&&t.docChanged){let r=t.mapping.map(n.activeHandle,-1);if(!pointsAtCell(t.doc.resolve(r))){r=-1}return new e(r,n.dragging)}return n}};function handleMouseMove(e,t,n,r,o){const i=columnResizingPluginKey.getState(e.state);if(!i)return;if(!i.dragging){const r=domCellAround(t.target);let s=-1;if(r){const{left:o,right:i}=r.getBoundingClientRect();if(t.clientX-o<=n)s=edgeCell(e,t,"left",n);else if(i-t.clientX<=n)s=edgeCell(e,t,"right",n)}if(s!=i.activeHandle){if(!o&&s!==-1){const t=e.state.doc.resolve(s);const n=t.node(-1);const r=TableMap.get(n);const o=t.start(-1);const i=r.colCount(t.pos-o)+t.nodeAfter.attrs.colspan-1;if(i==r.width-1){return}}updateHandle(e,s)}}}function handleMouseLeave(e){const t=columnResizingPluginKey.getState(e.state);if(t&&t.activeHandle>-1&&!t.dragging)updateHandle(e,-1)}function handleMouseDown2(e,t,n){var r;const o=(r=e.dom.ownerDocument.defaultView)!=null?r:window;const i=columnResizingPluginKey.getState(e.state);if(!i||i.activeHandle==-1||i.dragging)return false;const s=e.state.doc.nodeAt(i.activeHandle);const a=currentColWidth(e,i.activeHandle,s.attrs);e.dispatch(e.state.tr.setMeta(columnResizingPluginKey,{setDragging:{startX:t.clientX,startWidth:a}}));function l(t){o.removeEventListener("mouseup",l);o.removeEventListener("mousemove",c);const r=columnResizingPluginKey.getState(e.state);if(r==null?void 0:r.dragging){updateColumnWidth(e,r.activeHandle,draggedWidth(r.dragging,t,n));e.dispatch(e.state.tr.setMeta(columnResizingPluginKey,{setDragging:null}))}}function c(t){if(!t.which)return l(t);const r=columnResizingPluginKey.getState(e.state);if(!r)return;if(r.dragging){const o=draggedWidth(r.dragging,t,n);displayColumnWidth(e,r.activeHandle,o,n)}}o.addEventListener("mouseup",l);o.addEventListener("mousemove",c);t.preventDefault();return true}function currentColWidth(e,t,{colspan:n,colwidth:r}){const o=r&&r[r.length-1];if(o)return o;const i=e.domAtPos(t);const s=i.node.childNodes[i.offset];let a=s.offsetWidth,l=n;if(r){for(let e=0;e<n;e++)if(r[e]){a-=r[e];l--}}return a/l}function domCellAround(e){while(e&&e.nodeName!="TD"&&e.nodeName!="TH")e=e.classList&&e.classList.contains("ProseMirror")?null:e.parentNode;return e}function edgeCell(e,t,n,r){const o=n=="right"?-r:r;const i=e.posAtCoords({left:t.clientX+o,top:t.clientY});if(!i)return-1;const{pos:s}=i;const a=cellAround(e.state.doc.resolve(s));if(!a)return-1;if(n=="right")return a.pos;const l=TableMap.get(a.node(-1)),c=a.start(-1);const d=l.map.indexOf(a.pos-c);return d%l.width==0?-1:c+l.map[d-1]}function draggedWidth(e,t,n){const r=t.clientX-e.startX;return Math.max(n,e.startWidth+r)}function updateHandle(e,t){e.dispatch(e.state.tr.setMeta(columnResizingPluginKey,{setHandle:t}))}function updateColumnWidth(e,t,n){const r=e.state.doc.resolve(t);const o=r.node(-1),i=TableMap.get(o),s=r.start(-1);const a=i.colCount(r.pos-s)+r.nodeAfter.attrs.colspan-1;const l=e.state.tr;for(let e=0;e<i.height;e++){const t=e*i.width+a;if(e&&i.map[t]==i.map[t-i.width])continue;const r=i.map[t];const c=o.nodeAt(r).attrs;const d=c.colspan==1?0:a-i.colCount(r);if(c.colwidth&&c.colwidth[d]==n)continue;const u=c.colwidth?c.colwidth.slice():zeroes(c.colspan);u[d]=n;l.setNodeMarkup(s+r,null,{...c,colwidth:u})}if(l.docChanged)e.dispatch(l)}function displayColumnWidth(e,t,n,r){const o=e.state.doc.resolve(t);const i=o.node(-1),s=o.start(-1);const a=TableMap.get(i).colCount(o.pos-s)+o.nodeAfter.attrs.colspan-1;let l=e.domAtPos(o.start(-1)).node;while(l&&l.nodeName!="TABLE"){l=l.parentNode}if(!l)return;updateColumnsOnResize(i,l.firstChild,l,r,a,n)}function zeroes(e){return Array(e).fill(0)}function handleDecorations(e,t){const n=[];const r=e.doc.resolve(t);const o=r.node(-1);if(!o){return DecorationSet.empty}const i=TableMap.get(o);const s=r.start(-1);const a=i.colCount(r.pos-s)+r.nodeAfter.attrs.colspan-1;for(let e=0;e<i.height;e++){const t=a+e*i.width;if((a==i.width-1||i.map[t]!=i.map[t+1])&&(e==0||i.map[t]!=i.map[t-i.width])){const e=i.map[t];const r=s+e+o.nodeAt(e).nodeSize-1;const a=document.createElement("div");a.className="column-resize-handle";n.push(Decoration.widget(r,a))}}return DecorationSet.create(e.doc,n)}function selectedRect(e){const t=e.selection;const n=selectionCell(e);const r=n.node(-1);const o=n.start(-1);const i=TableMap.get(r);const s=t instanceof CellSelection?i.rectBetween(t.$anchorCell.pos-o,t.$headCell.pos-o):i.findCell(n.pos-o);return{...s,tableStart:o,map:i,table:r}}function addColumn(e,{map:t,tableStart:n,table:r},o){let i=o>0?-1:0;if(columnIsHeader(t,r,o+i)){i=o==0||o==t.width?null:0}for(let s=0;s<t.height;s++){const a=s*t.width+o;if(o>0&&o<t.width&&t.map[a-1]==t.map[a]){const i=t.map[a];const l=r.nodeAt(i);e.setNodeMarkup(e.mapping.map(n+i),null,addColSpan(l.attrs,o-t.colCount(i)));s+=l.attrs.rowspan-1}else{const l=i==null?tableNodeTypes(r.type.schema).cell:r.nodeAt(t.map[a+i]).type;const c=t.positionAt(s,o,r);e.insert(e.mapping.map(n+c),l.createAndFill())}}return e}function addColumnBefore(e,t){if(!isInTable(e))return false;if(t){const n=selectedRect(e);t(addColumn(e.tr,n,n.left))}return true}function removeColumn(e,{map:t,table:n,tableStart:r},o){const i=e.mapping.maps.length;for(let s=0;s<t.height;){const a=s*t.width+o;const l=t.map[a];const c=n.nodeAt(l);const d=c.attrs;if(o>0&&t.map[a-1]==l||o<t.width-1&&t.map[a+1]==l){e.setNodeMarkup(e.mapping.slice(i).map(r+l),null,removeColSpan(d,o-t.colCount(l)))}else{const t=e.mapping.slice(i).map(r+l);e.delete(t,t+c.nodeSize)}s+=d.rowspan}}function deleteColumn(e,t){if(!isInTable(e))return false;if(t){const n=selectedRect(e);const r=e.tr;if(n.left==0&&n.right==n.map.width)return false;for(let e=n.right-1;;e--){removeColumn(r,n,e);if(e==n.left)break;const t=n.tableStart?r.doc.nodeAt(n.tableStart-1):r.doc;if(!t){throw RangeError("No table found")}n.table=t;n.map=TableMap.get(t)}t(r)}return true}function rowIsHeader(e,t,n){var r;const o=tableNodeTypes(t.type.schema).header_cell;for(let i=0;i<e.width;i++)if(((r=t.nodeAt(e.map[i+n*e.width]))==null?void 0:r.type)!=o)return false;return true}function addRow(e,{map:t,tableStart:n,table:r},o){var i;let s=n;for(let e=0;e<o;e++)s+=r.child(e).nodeSize;const a=[];let l=o>0?-1:0;if(rowIsHeader(t,r,o+l))l=0;for(let s=0,c=t.width*o;s<t.width;s++,c++){if(o>0&&o<t.height&&t.map[c]==t.map[c-t.width]){const o=t.map[c];const i=r.nodeAt(o).attrs;e.setNodeMarkup(n+o,null,{...i,rowspan:i.rowspan+1});s+=i.colspan-1}else{const e=l==null?tableNodeTypes(r.type.schema).cell:(i=r.nodeAt(t.map[c+l*t.width]))==null?void 0:i.type;const n=e==null?void 0:e.createAndFill();if(n)a.push(n)}}e.insert(s,tableNodeTypes(r.type.schema).row.create(null,a));return e}function addRowBefore(e,t){if(!isInTable(e))return false;if(t){const n=selectedRect(e);t(addRow(e.tr,n,n.top))}return true}function removeRow(e,{map:t,table:n,tableStart:r},o){let i=0;for(let e=0;e<o;e++)i+=n.child(e).nodeSize;const s=i+n.child(o).nodeSize;const a=e.mapping.maps.length;e.delete(i+r,s+r);const l=new Set;for(let i=0,s=o*t.width;i<t.width;i++,s++){const c=t.map[s];if(l.has(c))continue;l.add(c);if(o>0&&c==t.map[s-t.width]){const t=n.nodeAt(c).attrs;e.setNodeMarkup(e.mapping.slice(a).map(c+r),null,{...t,rowspan:t.rowspan-1});i+=t.colspan-1}else if(o<t.height&&c==t.map[s+t.width]){const s=n.nodeAt(c);const l=s.attrs;const d=s.type.create({...l,rowspan:s.attrs.rowspan-1},s.content);const u=t.positionAt(o+1,i,n);e.insert(e.mapping.slice(a).map(r+u),d);i+=l.colspan-1}}}function deleteRow(e,t){if(!isInTable(e))return false;if(t){const n=selectedRect(e),r=e.tr;if(n.top==0&&n.bottom==n.map.height)return false;for(let e=n.bottom-1;;e--){removeRow(r,n,e);if(e==n.top)break;const t=n.tableStart?r.doc.nodeAt(n.tableStart-1):r.doc;if(!t){throw RangeError("No table found")}n.table=t;n.map=TableMap.get(n.table)}t(r)}return true}function isEmpty(e){const t=e.content;return t.childCount==1&&t.child(0).isTextblock&&t.child(0).childCount==0}function cellsOverlapRectangle({width:e,height:t,map:n},r){let o=r.top*e+r.left,i=o;let s=(r.bottom-1)*e+r.left,a=o+(r.right-r.left-1);for(let t=r.top;t<r.bottom;t++){if(r.left>0&&n[i]==n[i-1]||r.right<e&&n[a]==n[a+1])return true;i+=e;a+=e}for(let i=r.left;i<r.right;i++){if(r.top>0&&n[o]==n[o-e]||r.bottom<t&&n[s]==n[s+e])return true;o++;s++}return false}function mergeCells(e,t){const n=e.selection;if(!(n instanceof CellSelection)||n.$anchorCell.pos==n.$headCell.pos)return false;const r=selectedRect(e),{map:o}=r;if(cellsOverlapRectangle(o,r))return false;if(t){const n=e.tr;const i={};let s=Fragment.empty;let a;let l;for(let e=r.top;e<r.bottom;e++){for(let t=r.left;t<r.right;t++){const c=o.map[e*o.width+t];const d=r.table.nodeAt(c);if(i[c]||!d)continue;i[c]=true;if(a==null){a=c;l=d}else{if(!isEmpty(d))s=s.append(d.content);const e=n.mapping.map(c+r.tableStart);n.delete(e,e+d.nodeSize)}}}if(a==null||l==null){return true}n.setNodeMarkup(a+r.tableStart,null,{...addColSpan(l.attrs,l.attrs.colspan,r.right-r.left-l.attrs.colspan),rowspan:r.bottom-r.top});if(s.size){const e=a+1+l.content.size;const t=isEmpty(l)?a+1:e;n.replaceWith(t+r.tableStart,e+r.tableStart,s)}n.setSelection(new CellSelection(n.doc.resolve(a+r.tableStart)));t(n)}return true}function splitCell(e,t){const n=tableNodeTypes(e.schema);return splitCellWithType((({node:e})=>n[e.type.spec.tableRole]))(e,t)}function splitCellWithType(e){return(t,n)=>{var r;const o=t.selection;let i;let s;if(!(o instanceof CellSelection)){i=cellWrapping(o.$from);if(!i)return false;s=(r=cellAround(o.$from))==null?void 0:r.pos}else{if(o.$anchorCell.pos!=o.$headCell.pos)return false;i=o.$anchorCell.nodeAfter;s=o.$anchorCell.pos}if(i==null||s==null){return false}if(i.attrs.colspan==1&&i.attrs.rowspan==1){return false}if(n){let r=i.attrs;const a=[];const l=r.colwidth;if(r.rowspan>1)r={...r,rowspan:1};if(r.colspan>1)r={...r,colspan:1};const c=selectedRect(t),d=t.tr;for(let e=0;e<c.right-c.left;e++)a.push(l?{...r,colwidth:l&&l[e]?[l[e]]:null}:r);let u;for(let t=c.top;t<c.bottom;t++){let n=c.map.positionAt(t,c.left,c.table);if(t==c.top)n+=i.nodeSize;for(let r=c.left,o=0;r<c.right;r++,o++){if(r==c.left&&t==c.top)continue;d.insert(u=d.mapping.map(n+c.tableStart,1),e({node:i,row:t,col:r}).createAndFill(a[o]))}}d.setNodeMarkup(s,e({node:i,row:c.top,col:c.left}),a[0]);if(o instanceof CellSelection)d.setSelection(new CellSelection(d.doc.resolve(o.$anchorCell.pos),u?d.doc.resolve(u):void 0));n(d)}return true}}function deprecated_toggleHeader(e){return function(t,n){if(!isInTable(t))return false;if(n){const r=tableNodeTypes(t.schema);const o=selectedRect(t),i=t.tr;const s=o.map.cellsInRect(e=="column"?{left:o.left,top:0,right:o.right,bottom:o.map.height}:e=="row"?{left:0,top:o.top,right:o.map.width,bottom:o.bottom}:o);const a=s.map((e=>o.table.nodeAt(e)));for(let e=0;e<s.length;e++)if(a[e].type==r.header_cell)i.setNodeMarkup(o.tableStart+s[e],r.cell,a[e].attrs);if(i.steps.length==0)for(let e=0;e<s.length;e++)i.setNodeMarkup(o.tableStart+s[e],r.header_cell,a[e].attrs);n(i)}return true}}function isHeaderEnabledByType(e,t,n){const r=t.map.cellsInRect({left:0,top:0,right:e=="row"?t.map.width:1,bottom:e=="column"?t.map.height:1});for(let e=0;e<r.length;e++){const o=t.table.nodeAt(r[e]);if(o&&o.type!==n.header_cell){return false}}return true}function toggleHeader(e,t){t=t||{useDeprecatedLogic:false};if(t.useDeprecatedLogic)return deprecated_toggleHeader(e);return function(t,n){if(!isInTable(t))return false;if(n){const r=tableNodeTypes(t.schema);const o=selectedRect(t),i=t.tr;const s=isHeaderEnabledByType("row",o,r);const a=isHeaderEnabledByType("column",o,r);const l=e==="column"?s:e==="row"?a:false;const c=l?1:0;const d=e=="column"?{left:0,top:c,right:1,bottom:o.map.height}:e=="row"?{left:c,top:0,right:o.map.width,bottom:1}:o;const u=e=="column"?a?r.cell:r.header_cell:e=="row"?s?r.cell:r.header_cell:r.cell;o.map.cellsInRect(d).forEach((e=>{const t=e+o.tableStart;const n=i.doc.nodeAt(t);if(n){i.setNodeMarkup(t,u,n.attrs)}}));n(i)}return true}}toggleHeader("row",{useDeprecatedLogic:true});toggleHeader("column",{useDeprecatedLogic:true});toggleHeader("cell",{useDeprecatedLogic:true});function findNextCell(e,t){if(t<0){const t=e.nodeBefore;if(t)return e.pos-t.nodeSize;for(let t=e.index(-1)-1,n=e.before();t>=0;t--){const r=e.node(-1).child(t);const o=r.lastChild;if(o){return n-1-o.nodeSize}n-=r.nodeSize}}else{if(e.index()<e.parent.childCount-1){return e.pos+e.nodeAfter.nodeSize}const t=e.node(-1);for(let n=e.indexAfter(-1),r=e.after();n<t.childCount;n++){const e=t.child(n);if(e.childCount)return r+1;r+=e.nodeSize}}return null}function goToNextCell(e){return function(t,n){if(!isInTable(t))return false;const r=findNextCell(selectionCell(t),e);if(r==null)return false;if(n){const e=t.doc.resolve(r);n(t.tr.setSelection(TextSelection.between(e,moveCellForward(e))).scrollIntoView())}return true}}function tableEditing({allowTableNodeSelection:e=false}={}){return new Plugin({key:tableEditingKey,state:{init(){return null},apply(e,t){const n=e.getMeta(tableEditingKey);if(n!=null)return n==-1?null:n;if(t==null||!e.docChanged)return t;const{deleted:r,pos:o}=e.mapping.mapResult(t);return r?null:o}},props:{decorations:drawCellSelection,handleDOMEvents:{mousedown:handleMouseDown},createSelectionBetween(e){return tableEditingKey.getState(e.state)!=null?e.state.selection:null},handleTripleClick:handleTripleClick,handleKeyDown:handleKeyDown,handlePaste:handlePaste},appendTransaction(t,n,r){return normalizeSelection(r,fixTables(r,n),e)}})}function crelt(){var e=arguments[0];if(typeof e=="string")e=document.createElement(e);var t=1,n=arguments[1];if(n&&typeof n=="object"&&n.nodeType==null&&!Array.isArray(n)){for(var r in n)if(Object.prototype.hasOwnProperty.call(n,r)){var o=n[r];if(typeof o=="string")e.setAttribute(r,o);else if(o!=null)e[r]=o}t++}for(;t<arguments.length;t++)add$2(e,arguments[t]);return e}function add$2(e,t){if(typeof t=="string"){e.appendChild(document.createTextNode(t))}else if(t==null);else if(t.nodeType!=null){e.appendChild(t)}else if(Array.isArray(t)){for(var n=0;n<t.length;n++)add$2(e,t[n])}else{throw new RangeError("Unsupported child node: "+t)}}const SVG="http://www.w3.org/2000/svg";const XLINK="http://www.w3.org/1999/xlink";const prefix$2="ProseMirror-icon";function hashPath(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n)|0;return t}function getIcon(e,t){let n=(e.nodeType==9?e:e.ownerDocument)||document;let r=n.createElement("div");r.className=prefix$2;if(t.path){let{path:o,width:i,height:s}=t;let a="pm-icon-"+hashPath(o).toString(16);if(!n.getElementById(a))buildSVG(e,a,t);let l=r.appendChild(n.createElementNS(SVG,"svg"));l.style.width=i/s+"em";let c=l.appendChild(n.createElementNS(SVG,"use"));c.setAttributeNS(XLINK,"href",/([^#]*)/.exec(n.location.toString())[1]+"#"+a)}else if(t.dom){r.appendChild(t.dom.cloneNode(true))}else{let{text:e,css:o}=t;r.appendChild(n.createElement("span")).textContent=e||"";if(o)r.firstChild.style.cssText=o}return r}function buildSVG(e,t,n){let[r,o]=e.nodeType==9?[e,e.body]:[e.ownerDocument||document,e];let i=r.getElementById(prefix$2+"-collection");if(!i){i=r.createElementNS(SVG,"svg");i.id=prefix$2+"-collection";i.style.display="none";o.insertBefore(i,o.firstChild)}let s=r.createElementNS(SVG,"symbol");s.id=t;s.setAttribute("viewBox","0 0 "+n.width+" "+n.height);let a=s.appendChild(r.createElementNS(SVG,"path"));a.setAttribute("d",n.path);i.appendChild(s)}const prefix$1$1="ProseMirror-menu";class MenuItem{constructor(e){this.spec=e}render(e){let t=this.spec;let n=t.render?t.render(e):t.icon?getIcon(e.root,t.icon):t.label?crelt("div",null,translate(e,t.label)):null;if(!n)throw new RangeError("MenuItem without icon or label property");if(t.title){const r=typeof t.title==="function"?t.title(e.state):t.title;n.setAttribute("title",translate(e,r))}if(t.class)n.classList.add(t.class);if(t.css)n.style.cssText+=t.css;n.addEventListener("mousedown",(r=>{r.preventDefault();if(!n.classList.contains(prefix$1$1+"-disabled"))t.run(e.state,e.dispatch,e,r)}));function r(e){if(t.select){let r=t.select(e);n.style.display=r?"":"none";if(!r)return false}let r=true;if(t.enable){r=t.enable(e)||false;setClass(n,prefix$1$1+"-disabled",!r)}if(t.active){let o=r&&t.active(e)||false;setClass(n,prefix$1$1+"-active",o)}return true}return{dom:n,update:r}}}function translate(e,t){return e._props.translate?e._props.translate(t):t}let lastMenuEvent={time:0,node:null};function markMenuEvent(e){lastMenuEvent.time=Date.now();lastMenuEvent.node=e.target}function isMenuEvent(e){return Date.now()-100<lastMenuEvent.time&&lastMenuEvent.node&&e.contains(lastMenuEvent.node)}class Dropdown{constructor(e,t={}){this.options=t;this.options=t||{};this.content=Array.isArray(e)?e:[e]}render(e){let t=renderDropdownItems(this.content,e);let n=e.dom.ownerDocument.defaultView||window;let r=crelt("div",{class:prefix$1$1+"-dropdown "+(this.options.class||""),style:this.options.css},translate(e,this.options.label||""));if(this.options.title)r.setAttribute("title",translate(e,this.options.title));let o=crelt("div",{class:prefix$1$1+"-dropdown-wrap"},r);let i=null;let s=null;let a=()=>{if(i&&i.close()){i=null;n.removeEventListener("mousedown",s)}};r.addEventListener("mousedown",(e=>{e.preventDefault();markMenuEvent(e);if(i){a()}else{i=this.expand(o,t.dom);n.addEventListener("mousedown",s=()=>{if(!isMenuEvent(o))a()})}}));function l(e){let n=t.update(e);o.style.display=n?"":"none";return n}return{dom:o,update:l}}expand(e,t){let n=crelt("div",{class:prefix$1$1+"-dropdown-menu "+(this.options.class||"")},t);let r=false;function o(){if(r)return false;r=true;e.removeChild(n);return true}e.appendChild(n);return{close:o,node:n}}}function renderDropdownItems(e,t){let n=[],r=[];for(let o=0;o<e.length;o++){let{dom:i,update:s}=e[o].render(t);n.push(crelt("div",{class:prefix$1$1+"-dropdown-item"},i));r.push(s)}return{dom:n,update:combineUpdates(r,n)}}function combineUpdates(e,t){return n=>{let r=false;for(let o=0;o<e.length;o++){let i=e[o](n);t[o].style.display=i?"":"none";if(i)r=true}return r}}class DropdownSubmenu{constructor(e,t={}){this.options=t;this.content=Array.isArray(e)?e:[e]}render(e){let t=renderDropdownItems(this.content,e);let n=e.dom.ownerDocument.defaultView||window;let r=crelt("div",{class:prefix$1$1+"-submenu-label"},translate(e,this.options.label||""));let o=crelt("div",{class:prefix$1$1+"-submenu-wrap"},r,crelt("div",{class:prefix$1$1+"-submenu"},t.dom));let i=null;r.addEventListener("mousedown",(e=>{e.preventDefault();markMenuEvent(e);setClass(o,prefix$1$1+"-submenu-wrap-active",false);if(!i)n.addEventListener("mousedown",i=()=>{if(!isMenuEvent(o)){o.classList.remove(prefix$1$1+"-submenu-wrap-active");n.removeEventListener("mousedown",i);i=null}})}));function s(e){let n=t.update(e);o.style.display=n?"":"none";return n}return{dom:o,update:s}}}function renderGrouped(e,t){let n=document.createDocumentFragment();let r=[],o=[];for(let i=0;i<t.length;i++){let s=t[i],a=[],l=[];for(let t=0;t<s.length;t++){let{dom:r,update:o}=s[t].render(e);let i=crelt("span",{class:prefix$1$1+"item"},r);n.appendChild(i);l.push(i);a.push(o)}if(a.length){r.push(combineUpdates(a,l));if(i<t.length-1)o.push(n.appendChild(separator()))}}function i(e){let t=false,n=false;for(let i=0;i<r.length;i++){let s=r[i](e);if(i)o[i-1].style.display=n&&s?"":"none";n=s;if(s)t=true}return t}return{dom:n,update:i}}function separator(){return crelt("span",{class:prefix$1$1+"separator"})}const icons={join:{width:800,height:900,path:"M0 75h800v125h-800z M0 825h800v-125h-800z M250 400h100v-100h100v100h100v100h-100v100h-100v-100h-100z"},lift:{width:1024,height:1024,path:"M219 310v329q0 7-5 12t-12 5q-8 0-13-5l-164-164q-5-5-5-13t5-13l164-164q5-5 13-5 7 0 12 5t5 12zM1024 749v109q0 7-5 12t-12 5h-987q-7 0-12-5t-5-12v-109q0-7 5-12t12-5h987q7 0 12 5t5 12zM1024 530v109q0 7-5 12t-12 5h-621q-7 0-12-5t-5-12v-109q0-7 5-12t12-5h621q7 0 12 5t5 12zM1024 310v109q0 7-5 12t-12 5h-621q-7 0-12-5t-5-12v-109q0-7 5-12t12-5h621q7 0 12 5t5 12zM1024 91v109q0 7-5 12t-12 5h-987q-7 0-12-5t-5-12v-109q0-7 5-12t12-5h987q7 0 12 5t5 12z"},selectParentNode:{text:"",css:"font-weight: bold"},undo:{width:1024,height:1024,path:"M761 1024c113-206 132-520-313-509v253l-384-384 384-384v248c534-13 594 472 313 775z"},redo:{width:1024,height:1024,path:"M576 248v-248l384 384-384 384v-253c-446-10-427 303-313 509-280-303-221-789 313-775z"},strong:{width:805,height:1024,path:"M317 869q42 18 80 18 214 0 214-191 0-65-23-102-15-25-35-42t-38-26-46-14-48-6-54-1q-41 0-57 5 0 30-0 90t-0 90q0 4-0 38t-0 55 2 47 6 38zM309 442q24 4 62 4 46 0 81-7t62-25 42-51 14-81q0-40-16-70t-45-46-61-24-70-8q-28 0-74 7 0 28 2 86t2 86q0 15-0 45t-0 45q0 26 0 39zM0 950l1-53q8-2 48-9t60-15q4-6 7-15t4-19 3-18 1-21 0-19v-37q0-561-12-585-2-4-12-8t-25-6-28-4-27-2-17-1l-2-47q56-1 194-6t213-5q13 0 39 0t38 0q40 0 78 7t73 24 61 40 42 59 16 78q0 29-9 54t-22 41-36 32-41 25-48 22q88 20 146 76t58 141q0 57-20 102t-53 74-78 48-93 27-100 8q-25 0-75-1t-75-1q-60 0-175 6t-132 6z"},em:{width:585,height:1024,path:"M0 949l9-48q3-1 46-12t63-21q16-20 23-57 0-4 35-165t65-310 29-169v-14q-13-7-31-10t-39-4-33-3l10-58q18 1 68 3t85 4 68 1q27 0 56-1t69-4 56-3q-2 22-10 50-17 5-58 16t-62 19q-4 10-8 24t-5 22-4 26-3 24q-15 84-50 239t-44 203q-1 5-7 33t-11 51-9 47-3 32l0 10q9 2 105 17-1 25-9 56-6 0-18 0t-18 0q-16 0-49-5t-49-5q-78-1-117-1-29 0-81 5t-69 6z"},code:{width:896,height:1024,path:"M608 192l-96 96 224 224-224 224 96 96 288-320-288-320zM288 192l-288 320 288 320 96-96-224-224 224-224-96-96z"},link:{width:951,height:1024,path:"M832 694q0-22-16-38l-118-118q-16-16-38-16-24 0-41 18 1 1 10 10t12 12 8 10 7 14 2 15q0 22-16 38t-38 16q-8 0-15-2t-14-7-10-8-12-12-10-10q-18 17-18 41 0 22 16 38l117 118q15 15 38 15 22 0 38-14l84-83q16-16 16-38zM430 292q0-22-16-38l-117-118q-16-16-38-16-22 0-38 15l-84 83q-16 16-16 38 0 22 16 38l118 118q15 15 38 15 24 0 41-17-1-1-10-10t-12-12-8-10-7-14-2-15q0-22 16-38t38-16q8 0 15 2t14 7 10 8 12 12 10 10q18-17 18-41zM941 694q0 68-48 116l-84 83q-47 47-116 47-69 0-116-48l-117-118q-47-47-47-116 0-70 50-119l-50-50q-49 50-118 50-68 0-116-48l-118-118q-48-48-48-116t48-116l84-83q47-47 116-47 69 0 116 48l117 118q47 47 47 116 0 70-50 119l50 50q49-50 118-50 68 0 116 48l118 118q48 48 48 116z"},bulletList:{width:768,height:896,path:"M0 512h128v-128h-128v128zM0 256h128v-128h-128v128zM0 768h128v-128h-128v128zM256 512h512v-128h-512v128zM256 256h512v-128h-512v128zM256 768h512v-128h-512v128z"},orderedList:{width:768,height:896,path:"M320 512h448v-128h-448v128zM320 768h448v-128h-448v128zM320 128v128h448v-128h-448zM79 384h78v-256h-36l-85 23v50l43-2v185zM189 590c0-36-12-78-96-78-33 0-64 6-83 16l1 66c21-10 42-15 67-15s32 11 32 28c0 26-30 58-110 112v50h192v-67l-91 2c49-30 87-66 87-113l1-1z"},blockquote:{width:640,height:896,path:"M0 448v256h256v-256h-128c0 0 0-128 128-128v-128c0 0-256 0-256 256zM640 320v-128c0 0-256 0-256 256v256h256v-256h-128c0 0 0-128 128-128z"}};const joinUpItem=new MenuItem({title:"Join with above block",run:joinUp,select:e=>joinUp(e),icon:icons.join});let undoItem=new MenuItem({title:"Undo last change",run:undo,enable:e=>undo(e),icon:icons.undo});let redoItem=new MenuItem({title:"Redo last undone change",run:redo,enable:e=>redo(e),icon:icons.redo});function wrapItem(e,t){let n={run(n,r){return wrapIn(e,t.attrs)(n,r)},select(n){return wrapIn(e,t.attrs)(n)}};for(let e in t)n[e]=t[e];return new MenuItem(n)}function blockTypeItem(e,t){let n=setBlockType(e,t.attrs);let r={run:n,enable(e){return n(e)},active(n){let{$from:r,to:o,node:i}=n.selection;if(i)return i.hasMarkup(e,t.attrs);return o<=r.end()&&r.parent.hasMarkup(e,t.attrs)}};for(let e in t)r[e]=t[e];return new MenuItem(r)}function setClass(e,t,n){if(n)e.classList.add(t);else e.classList.remove(t)}const prefix$3="ProseMirror-menubar";function isIOS(){if(typeof navigator=="undefined")return false;let e=navigator.userAgent;return!/Edge\/\d/.test(e)&&/AppleWebKit/.test(e)&&/Mobile\/\w+/.test(e)}function menuBar(e){return new Plugin({view(t){return new MenuBarView(t,e)}})}class MenuBarView{constructor(e,t){this.editorView=e;this.options=t;this.spacer=null;this.maxHeight=0;this.widthForMaxHeight=0;this.floating=false;this.scrollHandler=null;this.wrapper=crelt("div",{class:prefix$3+"-wrapper"});this.menu=this.wrapper.appendChild(crelt("div",{class:prefix$3}));this.menu.className=prefix$3;if(e.dom.parentNode)e.dom.parentNode.replaceChild(this.wrapper,e.dom);this.wrapper.appendChild(e.dom);let{dom:n,update:r}=renderGrouped(this.editorView,this.options.content);this.contentUpdate=r;this.menu.appendChild(n);this.update();if(t.floating&&!isIOS()){this.updateFloat();let e=getAllWrapping(this.wrapper);this.scrollHandler=t=>{let n=this.editorView.root;if(!(n.body||n).contains(this.wrapper))e.forEach((e=>e.removeEventListener("scroll",this.scrollHandler)));else this.updateFloat(t.target.getBoundingClientRect?t.target:undefined)};e.forEach((e=>e.addEventListener("scroll",this.scrollHandler)))}}update(){this.contentUpdate(this.editorView.state);if(this.floating){this.updateScrollCursor()}else{if(this.menu.offsetWidth!=this.widthForMaxHeight){this.widthForMaxHeight=this.menu.offsetWidth;this.maxHeight=0}if(this.menu.offsetHeight>this.maxHeight){this.maxHeight=this.menu.offsetHeight;this.menu.style.minHeight=this.maxHeight+"px"}}}updateScrollCursor(){let e=this.editorView.root.getSelection();if(!e.focusNode)return;let t=e.getRangeAt(0).getClientRects();let n=t[selectionIsInverted(e)?0:t.length-1];if(!n)return;let r=this.menu.getBoundingClientRect();if(n.top<r.bottom&&n.bottom>r.top){let e=findWrappingScrollable(this.wrapper);if(e)e.scrollTop-=r.bottom-n.top}}updateFloat(e){let t=this.wrapper,n=t.getBoundingClientRect(),r=e?Math.max(0,e.getBoundingClientRect().top):0;if(this.floating){if(n.top>=r||n.bottom<this.menu.offsetHeight+10){this.floating=false;this.menu.style.position=this.menu.style.left=this.menu.style.top=this.menu.style.width="";this.menu.style.display="";this.spacer.parentNode.removeChild(this.spacer);this.spacer=null}else{let o=(t.offsetWidth-t.clientWidth)/2;this.menu.style.left=n.left+o+"px";this.menu.style.display=n.top>(this.editorView.dom.ownerDocument.defaultView||window).innerHeight?"none":"";if(e)this.menu.style.top=r+"px"}}else{if(n.top<r&&n.bottom>=this.menu.offsetHeight+10){this.floating=true;let n=this.menu.getBoundingClientRect();this.menu.style.left=n.left+"px";this.menu.style.width=n.width+"px";if(e)this.menu.style.top=r+"px";this.menu.style.position="fixed";this.spacer=crelt("div",{class:prefix$3+"-spacer",style:`height: ${n.height}px`});t.insertBefore(this.spacer,this.menu)}}}destroy(){if(this.wrapper.parentNode)this.wrapper.parentNode.replaceChild(this.editorView.dom,this.wrapper)}}function selectionIsInverted(e){if(e.anchorNode==e.focusNode)return e.anchorOffset>e.focusOffset;return e.anchorNode.compareDocumentPosition(e.focusNode)==Node.DOCUMENT_POSITION_FOLLOWING}function findWrappingScrollable(e){for(let t=e.parentNode;t;t=t.parentNode)if(t.scrollHeight>t.clientHeight)return t}function getAllWrapping(e){let t=[e.ownerDocument.defaultView||window];for(let n=e.parentNode;n;n=n.parentNode)t.push(n);return t}const isValidIdentifier$1=/^(?:[A-Za-z\u0391-\u03C9\u03D5\u210B\u210F\u2110\u2112\u2113\u211B\u212C\u2130\u2131\u2133]|(?:\uD835[\uDC00-\udc33\udc9c-\udcb5]))[A-Za-z0-9_\u0391-\u03C9\u03D5\u0300-\u0308\u030A\u030C\u0332\u20d0\u20d1\u20d6\u20d7\u20e1]**$/;const interpolateRegEx=/\$\{[^}\s]+\}/g;const clone=e=>{if(null==e||"object"!=typeof e){return e}if(e instanceof Date){return(new Date).setTime(e.valueOf())}if(Array.isArray(e)){const t=[];for(let n=0,r=e.length;n<r;n++){t[n]=clone(e[n])}return t}if(e instanceof Map){const t=new Map;for(const[n,r]of e.entries()){t.set(n,clone(r))}return t}if(e instanceof Set){return new Set([...e])}if(typeof e==="object"){const t=Object.create(null);Object.entries(e).forEach((([e,n])=>{t[e]=clone(n)}));return t}throw new Error("Unable to clone obj! Its type isn't supported.")};const arrayOfRegExMatches=(e,t)=>{if(e.constructor!==RegExp){throw new Error("not RegExp")}const n=[];let r=null;if(e.global){while(r=e.exec(t)){n.push({value:r[0],index:r.index,length:r[0].length})}}else if(r=e.exec(t)){n.push({value:r[0],index:r.index,length:r[0].length})}return n};const textAccent={"":"`","":"'","":"^","":"~","":"=","":"=","":"u","":".","":'"',"":"r","":"v"};const escapeRegEx=/[#$&%_~^]/g;const accentRegEx$2=/[\u0300-\u0308\u030A\u030c]/g;const addTextEscapes=e=>{if(e.length>1){let t=arrayOfRegExMatches(escapeRegEx,e);let n=t.length;if(n>0){for(let r=n-1;r>=0;r--){const n=t[r];const o=n.index;if(n.value==="~"){e=e.slice(0,o)+"\\textasciitilde "+e.slice(o+1)}else if(n.value==="^"){e=e.slice(0,o)+"\\textasciicircum "+e.slice(o+1)}else if(o===0){e="\\"+e}else{const t=e.substr(o-1,1);if(t!=="\\"){e=e.slice(0,o)+"\\"+e.slice(o)}}}}t=arrayOfRegExMatches(accentRegEx$2,e);n=t.length;if(n>0){for(let r=n-1;r>=0;r--){const n=t[r];const o=n.index;if(o>0){e=e.slice(0,o-1)+"\\"+textAccent[n.value]+e.slice(o-1,o)+e.slice(o+1)}}}}return e};const numeralFromSuperScript=e=>{switch(e){case"":return"2";case"":return"3";case"":return"-";case"":return"1";case"":return"0";default:return String.fromCharCode(e.charCodeAt(0)-8256)}};const leadingSpaceRegEx$4=/^[ \r\n\f]+/;const trailingSpaceRegEx$2=/[ \r\n\f]+$/;const tablessTrim=e=>e.replace(leadingSpaceRegEx$4,"").replace(trailingSpaceRegEx$2,"");const midDotRegEx=/^(\*||\.|-[A-Za-z])/;const exponentRegEx=/[\u2074-\u2079]/;const unitTeXFromString=e=>{let t=" {\\text{";let n=false;for(let r=0;r<e.length;r++){let o=e.charAt(r);if(exponentRegEx.test(o)){o=numeralFromSuperScript(o)}if(midDotRegEx.test(e.slice(r))){t+="}\\mkern1mu{\\cdot}\\mkern1mu\\text{"}else if(/[0-9-]/.test(o)){o=o==="-"?"\\text{-}":o;if(n){t+=o}else{t+="}^{"+o;n=true}}else if(o==="^"){t+="}^{";n=true}else if(n){t+="}\\text{"+o;n=false}else if(o==="$"){t+="\\$"}else{t+=o}}return t+"}}"};const allZeros=Object.freeze([0,0,0,0,0,0,0,0]);const dt=Object.freeze({NULL:0,RATIONAL:1,COMPLEX:2,BOOLEAN:4,FROMCOMPARISON:8,BOOLEANFROMCOMPARISON:12,STRING:16,QUANTITY:32,DATE:64,RANGE:128,TUPLE:256,MAP:512,ROWVECTOR:1024,COLUMNVECTOR:2048,MATRIX:4096,DATAFRAME:8192,MODULE:16384,ERROR:32768,UNIT:65536,DRAWING:131072,RICHTEXT:262144,DICTIONARY:524288,MACRO:1048576,SPREADSHEET:2097152});const errorMessages=Object.freeze({EN:{ERROR:"Error. Hurmet does not understand the expression.",ERR_FUNC:"@",BAD_FUN_NM:'Error. Unrecognized function name "@".',DIV:"Error. Divide by zero.",NAN:"Error. Value of $@$ is not numeric.",NANARG:"Error. Argument to function $@$ must be numeric.",NANEL:"Error. A numeric vector must have numeric elements. The value of $@$ is not numeric.",NULL:"Error. Missing value for $@$.",BAD_EQ:'Error. Use "==" instead of "=" to check for equality.',V_NAME:"Error. Variable $@$ not found.",F_NAME:"Error. Function @ not found.",NAN_OP:"Error. Arithmetic operation on a non-numeric value.",UNIT_ADD:"Error. Adding incompatible units.",UNIT_COMP:"Error. Comparing incompatible units.",UNIT_APEND:"Error. Apppending incompatible units.",UNIT_RES:"Error. Calculated units are not compatible with the desired result unit:",UNIT_MISS:"Error. No units specified for the result.",UNIT_IN:"Error. Incorrect unit for input to function @.",UNIT_ARG:"Error. Unit mis-match between arguments to function @.",UNIT_COL:"Error. Data frame column @ has no units. Do not make a unit-aware call to it.",UNIT_AWARE:"Error. Calculation must be unit-aware in order to apply unit @",UNIT_UN:"Error. Hurmet does not do unit aware calculations involving @",DATE:"Error. Date required.",LOGIC:"Error. Logic operation @ on a non-boolean value.",FACT:"Error. Factorial may be applied only to a unit-less non-negative integer.",PER:"Error. Percentage may be applied only to a unit-less number.",BINOM:"Error. Binomial may be applied only to unit-less numbers.",LOGF:"Error. Argument to log!() must be a non-negative integer.","0":"Error. (0) is infinite.","POLE":"Error. () of a negative integer is infinite.","LOG":"Error. Argument to Hurmet lgamma() must be a positive number.",TAN90:"Error. tan($@$) is infinite.",ATRIG:"Error. Input to @ must be between -1 and 1.",COT:"Error. Input to @ must not be zero.",ASEC:"Error. Absolute value of input to @ must be  1",STRING:"Error. Text operand required.",NUMARGS:"Error. Wrong number of arguments passed to function @.",NONSQUARE:"Error. Only a square matrix can be inverted.",SINGULAR:"Error. Matrix is singular and cannot be inverted.",BAD_ROW_NAME:"Error. Data frame does not have a row named @.",BAD_COLUMN_NAME:"Error. Data frame does not have a column named @.",BAD_COLUMN_TYPE:"Error. A map must have only one data type and one unit.",SINGLE_ARG:"Error. A call to a data frame must have two arguments in the brackets.",BAD_TYPE:"Error. Unrecognized data type for $@$.",CONCAT:'Error. Cannot add strings. Use "&" if concatenation is desired.',MATRIX_DIV:"Error. Cannot divide one matrix by another.",MATRIX_MOD:"Error. Cannot take the modulo of one matrix by another.",BAD_INDEX:"Error. Index to a matrix must be numeric.",FUNC_LINE:"Error in function @",BAD_BREAK:"Error in function @. break called outside of a loop",FETCH:"Error. A fetch() function must be the only item in its expression.",STR_INDEX:"Error. The index to text may be only a real number or a range.",UNIT_NAME:"Error. Unrecognized unit name: @",INT_NUM:'Error. Number display type "@" must be an integer.',TWO_MAPS:"Error. Both operands are maps. Hurmet accepts only one.",BAD_FORMAT:"Error. Invalid format @.",BAD_PREC:"Error. Significant digit specification must be between 1 and 15.",ZERO_ROOT:"Error. Zeroth root.",BAD_ROOT:"Error while taking root.",UNREAL:'Error. Argument to function "@" must be a real number.',BIGINDEX:"Error. Index too large.",MIS_ELNUM:"Error. Mis-matched number of elements",CROSS:"Error. Cross product can be performed only on three-vectors. Use * if you want element-wise multiplication.",QUANT_NUM:"Error. A Quantity must include a numeric magnitude.",CURRENCY:"Error. Currency exchange rates must be defined before using a monetary unit.",DF_UNIT:'Invalid unit "&" in data frame.',FORM_FRAC:"Error. Hurmet can do binary or hexadecimal format only on integers.",PRIVATE:"Error. Function @ is not private.",INT_ARG:"Error. The @ function can take only integers as arguments.",BAD_KEY:'Error. Data structure does not contain key "@".',BAD_SHT_KEY:'Error. Spreadsheet does not contain key "@".',NUM_KEY:"Error. A key must be a string, not a number.",IMMUT_UDF:`Error. Variable @ already contains a user-defined function.\n                Hurmet cannot assign a different value to @.`,NO_PROP:`Error. Cannot call a property from variable "@" because it has no properties.`,NOT_ARRAY:`Error. Cannot The second operand is not an array.`,MULT_MIS:"Error. Mismatch in number of multiple assignment.",COUNT:"Error. The count() function works only on strings.",NOT_VECTOR:"Error. Arguments to @() must be vectors.",BAD_DISPLAY:"Error. Result may not be suppressed. Use '?' display selector.",NA_COMPL_OP:'Error. "@" cannot be performed on a complex number.',NA_REAL:'Error. "@" can be performed only a complex number.',ORIGIN:'Error. Function "@" is undefined at the origin.',LOG_ZERO:"Error. Logarithm of zero is negative infinity.",END_MISS:"Error. Too few END statments in function @.",BAD_CONCAT:"Error. Unmatched dimensions.",BAD_KEYSTR:"Error. The key in a key:value pair must be a string.",BAD_APPEND:"Error. Can not append a @",MAP_APPEND:"Error. Can not append. Wrong data type.",BAD_TRANS:"Error. Only a matrix can be transposed.",BAD_ARGS:"Error. Wrong number of arguments to function @",BAD_SUM:"Error. Second argument to sum function must be 1 or 2.",ZERO_STEP:"Error. Step value must be > zero.",SHEET_INDEX:"Error. Bad column or row index.",UNSAVED:"Error. The current document has not been saved."}});const errorOprnd=(e,t)=>{if(e===""){return{value:"Error",unit:null,dtype:dt.ERROR}}let n=errorMessages["EN"][e];if(n===undefined){return{value:"Error",unit:null,dtype:dt.ERROR}}if(t){t=addTextEscapes(t);n=n.replace(/@/g,t)}else{n=n.replace(/@ ?/,"")}return{value:n,unit:null,dtype:dt.ERROR}};const iZero=BigInt(0);const iOne=BigInt(1);const iTwo=BigInt(2);const iTen=BigInt(10);const zero=[iZero,iOne];const one=[iOne,iOne];const two=[iTwo,iOne];const pi$1=[BigInt("31415926535897932384626433832795028841971693993751"),BigInt("10000000000000000000000000000000000000000000000000")];const e$1=[BigInt("2718281828459045235360287471352662497757247093699959574966"),BigInt("1000000000000000000000000000000000000000000000000000000000")];const hbar=[BigInt(1054571817),BigInt("10000000000000000000000000000000000000000000")];const intAbs$1=e=>e>=iZero?e:BigInt(-1)*e;const numberPattern="^(-?)(?:(0x[0-9A-Fa-f]+)|([0-9]+)(?: ([0-9]+)\\/([0-9]+)|(?:\\.([0-9]+))?(?:e([+-]?[0-9]+)|(%))?))";const numberRegEx$7=new RegExp(numberPattern);const fromNumber=e=>{if(Number.isInteger(e)){return[BigInt(e),iOne]}else{const t=e.toExponential().match(numberRegEx$7);const n=t[6]||"";const r=BigInt(t[7])-BigInt(n.length);if(r<0){return[BigInt(t[1]+t[3]+n),iTen**-r]}else if(t[5]){const e=BigInt(t[5]);return normalize([BigInt(t[1]+t[3])*e+BigInt(t[4])])}else{return normalize([BigInt(t[1]+t[3]+n)*iTen**r,iOne])}}};const fromString=e=>{const t=e.match(numberRegEx$7);let n;if(t[5]){const e=BigInt(t[5]);const r=BigInt(t[1]+t[3])*e+BigInt(t[4]);n=normalize([r,e])}else if(t[2]){n=[BigInt(t[2]),iOne]}else{const e=t[6]||"";const r=BigInt(t[3]+e);const o=t[7]?BigInt(t[7])-BigInt(e.length):t[8]?BigInt(-2)-BigInt(e.length):BigInt(0)-BigInt(e.length);n=o<0?[r,iTen**-o]:normalize([r*iTen**o,iOne])}if(t[1]){n=negate$1(n)}return n};const gcdi=(e,t)=>{e=intAbs$1(e);t=intAbs$1(t);while(t!==iZero){const n=e%t;e=t;t=n}return e};const gcd=(e,t)=>{if(!Rnl.isInteger(e)||!Rnl.isInteger(t)){return errorOprnd("INT_ARG","gcd")}return[gcdi(e[0]/e[1],t[0]/t[1]),iOne]};const normalize=e=>{const[t,n]=e;if(n===iOne){return e}const r=gcdi(t,n);return r===iOne?e:[t/r,n/r]};const isRational=e=>Array.isArray(e)&&e.length===2&&typeof e[0]==="bigint"&&typeof e[1]==="bigint";const isInteger=e=>e[1]===iOne||e[0]%e[1]===iZero;const isZero=e=>e[0]===iZero;const isNegative=e=>e[0]<iZero;const isPositive=e=>e[0]>iZero;const intSign=e=>e>=iZero?iOne:BigInt(-1);const sign=e=>isPositive(e)?one:isZero(e)?zero:negate$1(one);const negate$1=e=>[BigInt(-1)*e[0],e[1]];const abs$1=e=>{const t=e[0]<iZero?BigInt(-1)*e[0]:e[0];return[t,e[1]]};const increment$1=e=>[e[0]+e[1],e[1]];const decrement$1=e=>[e[0]-e[1],e[1]];const floor=e=>{if(e[0]%e[1]===iZero){return[e[0]/e[1],iOne]}return e[0]>=iZero?[e[0]/e[1],iOne]:[e[0]/e[1]-iOne,iOne]};const ceil=e=>{if(e[0]%e[1]===iZero){return[e[0]/e[1],iOne]}return e[0]>=iZero?[e[0]/e[1]+iOne,iOne]:[e[0]/e[1],iOne]};const add$1=(e,t)=>e[1]===t[1]?[e[0]+t[0],e[1]]:normalize([e[0]*t[1]+t[0]*e[1],e[1]*t[1]]);const subtract$1=(e,t)=>e[1]===t[1]?[e[0]-t[0],e[1]]:normalize([e[0]*t[1]-t[0]*e[1],e[1]*t[1]]);const multiply$1=(e,t)=>[e[0]*t[0],e[1]*t[1]];const divide$1=(e,t)=>{let n=e[0]*t[1];let r=e[1]*t[0];if(r<0){n*=BigInt(-1);r*=BigInt(-1)}return[n,r]};const power$1=(e,t)=>{if(t[0]===iZero){return[iOne,iOne]}else{t=normalize(t);let n;try{n=isInteger(t)&&isNegative(t)?[e[1]**(BigInt(-1)*t[0]),e[0]**(BigInt(-1)*t[0])]:isInteger(t)?[e[0]**t[0],e[1]**t[0]]:isPositive(e)||greaterThan(t,one)||lessThan(t,negate$1(one))?fromNumber(toNumber(e)**toNumber(t)):areEqual(mod(t,two),one)?fromNumber(-1*(-1*toNumber(e))**toNumber(t)):errorOprnd("BAD_ROOT")}catch(r){n=fromNumber(toNumber(e)**toNumber(t))}return n}};const sqrt$1=e=>fromNumber(Math.sqrt(toNumber(e)));const exp$1=e=>fromNumber(Math.exp(toNumber(e)));const reciprocal=e=>{let t=e[1];let n=e[0];if(n<0){t*=BigInt(-1);n*=BigInt(-1)}return[t,n]};const hypot=(e,t)=>{const n=abs$1(e);const r=abs$1(t);const o=max(n,r);const i=min(n,r);const s=Rnl.divide(i,o);return Rnl.multiply(o,sqrt$1(Rnl.increment(Rnl.multiply(s,s))))};const mod=(e,t)=>{const n=divide$1(normalize(e),normalize(t));return[intAbs$1(n[0]%n[1]),iOne]};const rem=(e,t)=>{const n=divide$1(normalize(e),normalize(t));return[n[0]%n[1],iOne]};const areEqual=(e,t)=>e[1]===t[1]?e[0]===t[0]:e[0]*t[1]===e[1]*t[0];const lessThan=(e,t)=>isNegative(e)!==isNegative(t)?isNegative(e):isNegative(subtract$1(e,t));const greaterThan=(e,t)=>isPositive(e)!==isPositive(t)?isPositive(e):isPositive(subtract$1(e,t));const lessThanOrEqualTo=(e,t)=>lessThan(e,t)||areEqual(e,t);const greaterThanOrEqualTo=(e,t)=>greaterThan(e,t)||areEqual(e,t);const max=(e,t)=>greaterThan(e,t)?[e[0],e[1]]:[t[0],t[1]];const min=(e,t)=>lessThan(e,t)?[e[0],e[1]]:[t[0],t[1]];const cos$1=e=>areEqual(e,divide$1(pi$1,two))?zero:fromNumber(Math.cos(toNumber(e)));const sin$1=e=>fromNumber(Math.sin(toNumber(e)));const tan=e=>{if(areEqual(e,divide$1(pi$1,two))){return errorOprnd("TAN90","/2")}return fromNumber(Math.tan(toNumber(e)))};const cosh=e=>{const t=toNumber(e);return fromNumber((Math.exp(t)+Math.exp(-t))/2)};const sinh=e=>{const t=toNumber(e);return fromNumber((Math.exp(t)-Math.exp(-t))/2)};const tanh=e=>{const t=toNumber(e);return fromNumber((Math.exp(t)-Math.exp(-t))/(Math.exp(t)+Math.exp(-t)))};const toNumber=e=>{const t=Number(e[0])/Number(e[1]);if(!isNaN(t)&&t!==Infinity){return t}const n=toStringSignificant(e,20);return Number(n)};const toStringSignificant=(e,t)=>{if(isZero(e)){return"0"}else{const n=intAbs$1(e[0]/e[1]);if(n>0){return toString(e,t-String(n).length)}else{const n=String(intAbs$1(e[1]/e[0])).length;return toString(e,n+t-1)}}};const toString=(e,t)=>{if(isZero(e)){return"0"}else if(t<0){const n=-t;const r=toString(divide$1(e,[iTen**BigInt(n),iOne]),0);return r+"0".repeat(n)}else{const[n,r]=normalize(e);const o=n/r;let i=n%r;let s=String(o);if(i===iZero&&t>0){s+="."+"0".repeat(t)}else if(i!==iZero){i=intAbs$1(i);const e=iTen**BigInt(t);const n=i*e;let a=n/r;const l=n%r;if(t===0){return intAbs$1(iTwo*l)>=intAbs$1(r)?String((intAbs$1(o)+iOne)*intSign(o)):s}if(intAbs$1(iTwo*l)>=intAbs$1(r)){a=a+iOne;if(a===e){return String((intAbs$1(o)+iOne)*intSign(o))+"."+"0".repeat(t)}}s+="."+String(a).padStart(t,"0")}return s}};const preComputedFactorials=["1","1","2","6","24","120","720","5040","40320","362880","3628800","39916800","479001600","6227020800","87178291200","1307674368000","20922789888000","355687428096000","6402373705728000","121645100408832000","2432902008176640000","51090942171709440000","1124000727777607680000","25852016738884976640000","620448401733239439360000","15511210043330985984000000","403291461126605635584000000","10888869450418352160768000000","304888344611713860501504000000","8841761993739701954543616000000","265252859812191058636308480000000","8222838654177922817725562880000000","263130836933693530167218012160000000","8683317618811886495518194401280000000","295232799039604140847618609643520000000","10333147966386144929666651337523200000000","371993326789901217467999448150835200000000","13763753091226345046315979581580902400000000","523022617466601111760007224100074291200000000","20397882081197443358640281739902897356800000000","815915283247897734345611269596115894272000000000","33452526613163807108170062053440751665152000000000","1405006117752879898543142606244511569936384000000000","60415263063373835637355132068513997507264512000000000","2658271574788448768043625811014615890319638528000000000","119622220865480194561963161495657715064383733760000000000","5502622159812088949850305428800254892961651752960000000000","258623241511168180642964355153611979969197632389120000000000","12413915592536072670862289047373375038521486354677760000000000","608281864034267560872252163321295376887552831379210240000000000","30414093201713378043612608166064768844377641568960512000000000000","1551118753287382280224243016469303211063259720016986112000000000000","80658175170943878571660636856403766975289505440883277824000000000000","4274883284060025564298013753389399649690343788366813724672000000000000","230843697339241380472092742683027581083278564571807941132288000000000000","12696403353658275925965100847566516959580321051449436762275840000000000000","710998587804863451854045647463724949736497978881168458687447040000000000000","40526919504877216755680601905432322134980384796226602145184481280000000000000","2350561331282878571829474910515074683828862318181142924420699914240000000000000","138683118545689835737939019720389406345902876772687432540821294940160000000000000","8320987112741390144276341183223364380754172606361245952449277696409600000000000000","507580213877224798800856812176625227226004528988036003099405939480985600000000000000","31469973260387937525653122354950764088012280797258232192163168247821107200000000000000","1982608315404440064116146708361898137544773690227268628106279599612729753600000000000000","126886932185884164103433389335161480802865516174545192198801894375214704230400000000000000","8247650592082470666723170306785496252186258551345437492922123134388955774976000000000000000","544344939077443064003729240247842752644293064388798874532860126869671081148416000000000000000","36471110918188685288249859096605464427167635314049524593701628500267962436943872000000000000000","2480035542436830599600990418569171581047399201355367672371710738018221445712183296000000000000000","171122452428141311372468338881272839092270544893520369393648040923257279754140647424000000000000000","11978571669969891796072783721689098736458938142546425857555362864628009582789845319680000000000000000","850478588567862317521167644239926010288584608120796235886430763388588680378079017697280000000000000000","61234458376886086861524070385274672740778091784697328983823014963978384987221689274204160000000000000000","4470115461512684340891257138125051110076800700282905015819080092370422104067183317016903680000000000000000","330788544151938641225953028221253782145683251820934971170611926835411235700971565459250872320000000000000000","24809140811395398091946477116594033660926243886570122837795894512655842677572867409443815424000000000000000000","1885494701666050254987932260861146558230394535379329335672487982961844043495537923117729972224000000000000000000","145183092028285869634070784086308284983740379224208358846781574688061991349156420080065207861248000000000000000000","11324281178206297831457521158732046228731749579488251990048962825668835325234200766245086213177344000000000000000000","894618213078297528685144171539831652069808216779571907213868063227837990693501860533361810841010176000000000000000000","71569457046263802294811533723186532165584657342365752577109445058227039255480148842668944867280814080000000000000000000","5797126020747367985879734231578109105412357244731625958745865049716390179693892056256184534249745940480000000000000000000","475364333701284174842138206989404946643813294067993328617160934076743994734899148613007131808479167119360000000000000000000","39455239697206586511897471180120610571436503407643446275224357528369751562996629334879591940103770870906880000000000000000000","3314240134565353266999387579130131288000666286242049487118846032383059131291716864129885722968716753156177920000000000000000000","281710411438055027694947944226061159480056634330574206405101912752560026159795933451040286452340924018275123200000000000000000000","24227095383672732381765523203441259715284870552429381750838764496720162249742450276789464634901319465571660595200000000000000000000","2107757298379527717213600518699389595229783738061356212322972511214654115727593174080683423236414793504734471782400000000000000000000","185482642257398439114796845645546284380220968949399346684421580986889562184028199319100141244804501828416633516851200000000000000000000","16507955160908461081216919262453619309839666236496541854913520707833171034378509739399912570787600662729080382999756800000000000000000000","1485715964481761497309522733620825737885569961284688766942216863704985393094065876545992131370884059645617234469978112000000000000000000000","135200152767840296255166568759495142147586866476906677791741734597153670771559994765685283954750449427751168336768008192000000000000000000000","12438414054641307255475324325873553077577991715875414356840239582938137710983519518443046123837041347353107486982656753664000000000000000000000","1156772507081641574759205162306240436214753229576413535186142281213246807121467315215203289516844845303838996289387078090752000000000000000000000","108736615665674308027365285256786601004186803580182872307497374434045199869417927630229109214583415458560865651202385340530688000000000000000000000","10329978488239059262599702099394727095397746340117372869212250571234293987594703124871765375385424468563282236864226607350415360000000000000000000000","991677934870949689209571401541893801158183648651267795444376054838492222809091499987689476037000748982075094738965754305639874560000000000000000000000","96192759682482119853328425949563698712343813919172976158104477319333745612481875498805879175589072651261284189679678167647067832320000000000000000000000","9426890448883247745626185743057242473809693764078951663494238777294707070023223798882976159207729119823605850588608460429412647567360000000000000000000000","933262154439441526816992388562667004907159682643816214685929638952175999932299156089414639761565182862536979208272237582511852109168640000000000000000000000","93326215443944152681699238856266700490715968264381621468592963895217599993229915608941463976156518286253697920827223758251185210916864000000000000000000000000"];const preComputedDoubleFactorials=["1","1","2","3","8","15","48","105","384","945","3840","10395","46080","135135","645120","2027025","10321920","34459425","185794560","654729075","3715891200","13749310575","81749606400","316234143225","1961990553600","7905853580625","51011754393600","213458046676875","1428329123020800"];const factorial=e=>{if(lessThan(e,[BigInt(101),iOne])){return fromString(preComputedFactorials[toNumber(e)])}else{return lanczos$1(increment$1(e))}};const doubleFactorial=e=>{if(lessThan(e,[BigInt(29),iOne])){return fromString(preComputedDoubleFactorials[toNumber(e)])}else{let t=e;for(let n=Rnl.toNumber(e)-2;n>0;n-=2){t=multiply$1(t,fromNumber(n))}return t}};const lanczos$1=e=>{const t=subtract$1(e,one);const n=multiply$1(two,sqrt$1(divide$1(e$1,pi$1)));const r=power$1(divide$1(add$1(t,fromNumber(11.400511)),e$1),add$1(t,[iOne,iTwo]));const o=["2.48574089138753565546e-5","1.05142378581721974210","-3.45687097222016235469","4.51227709466894823700","-2.98285225323576655721","1.05639711577126713077","-0.195428773191645869583","0.0170970543404441224307","-0.000571926117404305781283","0.00000463399473359905636708","-0.00000000271994908488607703910"];let i=fromString(o[0]);for(let e=1;e<=10;e++){i=add$1(i,divide$1(fromString(o[e]),add$1(t,fromNumber(e))))}return multiply$1(multiply$1(n,r),i)};const Rnl=Object.freeze({fromNumber:fromNumber,fromString:fromString,normalize:normalize,isRational:isRational,isInteger:isInteger,isZero:isZero,isNegative:isNegative,isPositive:isPositive,sign:sign,negate:negate$1,abs:abs$1,increment:increment$1,decrement:decrement$1,exp:exp$1,floor:floor,ceil:ceil,add:add$1,subtract:subtract$1,multiply:multiply$1,divide:divide$1,reciprocal:reciprocal,gcd:gcd,hbar:hbar,mod:mod,rem:rem,hypot:hypot,one:one,pi:pi$1,power:power$1,sqrt:sqrt$1,two:two,cos:cos$1,sin:sin$1,tan:tan,cosh:cosh,sinh:sinh,tanh:tanh,areEqual:areEqual,lessThan:lessThan,greaterThan:greaterThan,lessThanOrEqualTo:lessThanOrEqualTo,greaterThanOrEqualTo:greaterThanOrEqualTo,factorial:factorial,doubleFactorial:doubleFactorial,lanczos:lanczos$1,max:max,min:min,numberPattern:numberPattern,toNumber:toNumber,toString:toString,toStringSignificant:toStringSignificant,zero:zero});const siPrefixes=["y","z","a","f","p","n","","m","","k","M","G","T","P","E","Z","Y"];const groupByThreeRegEx=/\B(?=(\d{3})+$)/g;const groupByFourRegEx=/\B(?=(\d{4})+$)/g;const groupByLakhCroreRegEx=/(\d)(?=(\d\d)+\d$)/g;const formatRegEx=/^([beEfhkmprsStx%])?(-?[\d]+)?([]{0,2})?$/;const superscript$1=e=>{let t="";for(let n=0;n<e.length;n++){const r=e.charCodeAt(n);t+=r===49?"":r===50?"":r===51?"":String.fromCharCode(r+8256)}return t};const subscript=e=>{let t="";for(let n=0;n<e.length;n++){t+=String.fromCharCode(e.charCodeAt(n)+8272)}return t};const texFromMixedFraction=e=>(e[1]?"-":"")+e[3]+"\\,\\class{special-fraction}{\\text{"+superscript$1(e[4])+""+subscript(e[5])+"}}";const intAbs=e=>e>=BigInt(0)?e:BigInt(-1)*e;const roundedString=(e,t)=>{const n=t.numDigits;switch(t.ftype){case"h":{const t=String(Rnl.toString(e,0));if(t.replace("-","").length>=n){return t}if(n<1||n>15){return errorOprnd("BAD_PREC")}return Rnl.toNumber(e).toPrecision(n)}case"f":case"%":return Rnl.toString(e,n);case"r":case"p":{if(n<1||n>15){return errorOprnd("BAD_PREC")}const t=Rnl.toNumber(e).toPrecision(n);return t.indexOf("e")>-1?Number(t).toPrecision():t}case"s":case"S":case"e":case"E":case"n":case"N":case"k":if(n<1||n>15){return errorOprnd("BAD_PREC")}return Rnl.toNumber(e).toExponential(n-1).replace("+","");default:{e=Rnl.normalize(e);const n=Rnl.isNegative(e)?"-":"";const r=intAbs(e[0]);const o=e[1];switch(t.ftype){case"m":{const e=String(r/o);const t=r%o;return n+e+""+superscript$1(t)+""+subscript(o)}case"t":return n+String(r/o);case"b":case"x":case"X":if(o!==BigInt(1)){return errorOprnd("INT_NUM",t.ftype)}if(r<=Number.MAX_SAFE_INTEGER){return t.ftype==="b"?n+"0b"+Number(r).toString(2):t.ftype==="x"?n+"0x"+Number(r).toString(16):n+"0x"+Number(r).toString(16).toUpperCase()}else{return""}}}}};const formattedInteger=(e,t)=>{const n=t.charAt(1);if(n==="0"){return e}else if(t==="1,00,000."){return e.replace(groupByLakhCroreRegEx,"$1{,}")}else if(t==="1,0000,0000."){return e.replace(groupByFourRegEx,"$1{,}")}else{return e.replace(groupByThreeRegEx,n===","?"{,}":n===" "?"\\:":n===""?"":".")}};const formattedDecimal=(e,t,n)=>{const r=e.indexOf(".");if(r===-1){return formattedInteger(e,t)}else{const o=e.slice(0,r);const i=t.slice(-1);let s=(i==="."?".":"{,}")+e.slice(r+1);if(n){s=s.replace(/(\.|{,})?0+$/,"")}return formattedInteger(o,t)+s}};const validateFormatSpec=e=>{const t=formatRegEx.exec(e);if(!t){const t=errorOprnd("BAD_FORMAT",e).value;return[e,undefined,dt.ERROR,"\\text{"+t+"}"]}let n=t[1]||"h";let r=Number(t[2]||"15");const o=t[3]||"";switch(n){case"b":case"x":case"X":return[e,undefined,dt.STRING,"\\text{"+n+o+"}"];case"t":r=0;break;case"f":case"%":break;default:if(r<1||r>15){const t="\\text{"+errorOprnd("BAD_PREC").value+"}";return[e,undefined,dt.ERROR,t]}}if(n==="%"){n="\\%"}return[e,undefined,dt.STRING,"\\text{"+n+String(r)+o+"}"]};const angleRegEx=/[]+$/;const format=(e,t="h3",n="1,000,000.")=>{if(Rnl.isZero(e)){return"0"}const r={ftype:t.charAt(0)};t=t.replace(angleRegEx,"");if(t.length>1){r.numDigits=Number(t.slice(1))}if(r.ftype==="%"||r.ftype==="p"){e[0]=e[0]*BigInt(100)}if((r.ftype==="b"||r.ftype==="x")&&!Rnl.isInteger(e)){return errorOprnd("FORM_FRAC")}const o=roundedString(e,r);switch(r.ftype){case"f":case"r":case"h":return formattedDecimal(o,n,r.ftype==="h");case"t":return formattedInteger(o,n);case"%":case"p":return formattedDecimal(o,n)+"\\%";case"m":case"b":case"x":case"X":return o;default:{const e=o.indexOf("e");let t=o.slice(0,e);if(n.slice(-1)===","){t=t.replace(".","{,}")}switch(r.ftype){case"e":case"E":{const n=t+"\\text{"+r.ftype;if(o.charAt(e+1)==="-"){return n+"-}"+o.slice(e+2)}else{return n+"}"+o.slice(e+1)}}case"s":case"S":case"n":case"N":{const n=r.ftype==="S"?"":"\\mkern2mu{\\cdot}\\mkern1mu";return t+n+"10^{"+o.slice(e+1)+"}"}case"k":{const n=Number(o.slice(e+1));const r=n/3;const i=r>=0?Math.floor(r):Math.ceil(r);const s=n%3;if(s!==0){t=String(Number(t)*Math.pow(10,s))}return t+siPrefixes[8+i]}}}}};const fromAssignment=(e,t)=>{if(e.value===null){const t=e.name?e.name:"?";return errorOprnd("NULL",t)}const n=Object.create(null);n.dtype=e.dtype;n.name=e.name;const r=e.dtype;if(r===dt.STRING||r===dt.BOOLEAN||r===dt.DRAWING||r===dt.MODULE||r===dt.NULL){n.unit=null}else if(e.unit){n.unit=clone(e.unit)}else{n.unit=null}if(e.dtype&dt.QUANTITY){if(e.dtype&dt.MAP){n.value=clone(e.value);n.value.data=t?n.value.data.inBaseUnits:n.value.data.plain}else{n.value=Object.freeze(t?clone(e.value.inBaseUnits):clone(e.value.plain))}n.dtype=e.dtype-dt.QUANTITY}else if(e.dtype===dt.STRING){const t=e.value;const r=t.charAt(0);const o=t.charAt(t.length-1);n.value=r==='"'&&o==='"'?t.slice(1,-1).trim():t.trim()}else if(e.dtype===dt.DATAFRAME){n.value=e.value}else if(e.dtype===dt.SPREADSHEET){return e}else{n.value=clone(e.value)}return Object.freeze(n)};const unitsAreCompatible=(e,t)=>{if(e==null&&t==null){return true}if(e==null||t==null){return false}if(!Array.isArray(e)||!Array.isArray(t)){return false}if(e.length!==t.length){return false}for(let n=0;n<e.length;++n){if(e[n]!==t[n]){return false}}return true};const prefixFactor=JSON.parse('{"Y":1e24,"yotta":1e24,"Z":1e21,"zetta":1e21,"E":1e18,"exa":1e18,"P":1e15,"peta":1e15,"T":1e12,"tera":1e12,"G":1e9,"giga":1e9,"M":1e6,"mega":1e6,"k":1000,"kilo":1000,"h":100,"hecto":100,"deka":10,"d":0.1,"deci":0.1,"c":0.01,"centi":0.01,"m":0.001,"milli":0.001,"":1e-6,"":1e-6,"":1e-6,"micro":1e-6,"n":1e-9,"nano":1e-9,"p":1e-12,"pico":1e-12,"f":1e-15,"femto":1e-15,"a":1e-18,"atto":1e-18,"z":1e-21,"zepto":1e-21,"y":1e-24,"yocto":1e-24,"Ki":1024,"kibi":1024,"Mi":1048576,"mebi":1048576,"Gi":1073741824,"gibi":1073741824,"Ti":1099511627776,"tebi":1099511627776}');const unitTable=Object.freeze(JSON.parse(`{\n"#":["0.45359237", "1","0","0",[0,1,0,0,0,0,0,0]],\n"$":["1","1","0","USD",[0,0,0,0,0,0,0,1]],\n"":["1","1","0","GBP",[0,0,0,0,0,0,0,1]],\n"'":["0.3048","1","0","0",[1,0,0,0,0,0,0,0]],\n"A":["1","1","0","siSymbol",[0,0,0,1,0,0,0,0]],\n"AUD":["1.6646","1","0","AUD",[0,0,0,0,0,0,0,1]],\n"Adobe point":["0.0254","72","0","0",[1,0,0,0,0,0,0,0]],\n"At":["1","1","0","siSymbol",[0,0,0,0,1,0,1,0]],\n"Australian dollar":["1","1","0","AUD",[0,0,0,0,0,0,0,1]],\n"BRL":["6.2518","1","0","BRL",[0,0,0,0,0,0,0,1]],\n"BTU":["1055.056","1","0","0",[2,1,-2,0,0,0,0,0]],\n"BThU":["1055.056","1","0","0",[2,1,-2,0,0,0,0,0]],\n"Bq":["1","1","0","siSymbol",[0,0,-1,0,0,0,0,0]],\n"Brazilian Real":["1","1","0","BRL",[0,0,0,0,0,0,0,1]],\n"British Pound":["1","1","0","GBP",[0,0,0,0,0,0,0,1]],\n"Btu":["1055.056","1","0","0",[2,1,-2,0,0,0,0,0]],\n"C":["1","1","0","siSymbol",[0,0,1,1,0,0,0,0]],\n"C$":["1","1","0","CAD",[0,0,0,0,0,0,0,1]],\n"CAD":["1.4864","1","0","CAD",[0,0,0,0,0,0,0,1]],\n"CCF":["1","1","0","0",[3,0,0,0,0,0,0,0]],\n"CHF":["0.9394","1","0","CHF",[0,0,0,0,0,0,0,1]],\n"CNY":["7.5474","1","0","CNY",[0,0,0,0,0,0,0,1]],\n"CY":["0.764554857984","1","0","0",[3,0,0,0,0,0,0,0]],\n"Calorie":["4186.8","1","0","0",[2,1,-2,0,0,0,0,0]],\n"Canadian dollar":["1","1","0","CAD",[0,0,0,0,0,0,0,1]],\n"Celsius":["1","1","273.15","0",[0,0,0,0,1,0,0,0]],\n"Chinese Yuan":["1","1","0","CNY",[0,0,0,0,0,0,0,1]],\n"Ci":["37000000000","1","0","siSymbol",[0,0,-1,0,0,0,0,0]],\n"Ckm":["100000","1","0","siSymbol",[1,0,0,0,0,0,0,0]],\n"Da":["1.66053872e-24","1","0","siSymbol",[0,1,0,0,0,0,0,0]],\n"Dalton":["1.66053872e-24","1","0","0",[0,1,0,0,0,0,0,0]],\n"Didot point":["15.625","41559","0","0",[1,0,0,0,0,0,0,0]],\n"EB":["9223372036854770000","1","0","0",[0,0,0,0,0,1,0,0]],\n"EMU":["0.01","360000","0","0",[1,0,0,0,0,0,0,0]],\n"EUR":["1","1","0","EUR",[0,0,0,0,0,0,0,1]],\n"EiB":["9223372036854770000","1","0","0",[0,0,0,0,0,1,0,0]],\n"Euro":["1","1","0","EUR",[0,0,0,0,0,0,0,1]],\n"F":["1","1","0","siSymbol",[-2,-1,4,2,0,0,0,0]],\n"Fahrenheit":["5","9","459","0",[0,0,0,0,1,0,0,0]],\n"G":["0.0001","1","0","siSymbol",[-2,-2,-2,-1,0,0,0,0]],\n"GB":["8589934592","1","0","0",[0,0,0,0,0,1,0,0]],\n"GBP":["0.84453","1","0","GBP",[0,0,0,0,0,0,0,1]],\n"Gal":["0.01","1","0","siSymbol",[1,0,-2,0,0,0,0,0]],\n"Gi":["10","12.5663706143592","0","siWord",[0,0,0,0,1,0,1,0]],\n"GiB":["8589934592","1","0","0",[0,0,0,0,0,1,0,0]],\n"Gregorian year":["31556952","1","0","0",[0,0,1,0,0,0,0,0]],\n"Gy":["1","1","0","siSymbol",[2,0,-2,0,0,0,0,0]],\n"H":["1","1","0","siSymbol",[2,1,-2,-2,0,0,0,0]],\n"HK$":["1","1","0","HKD",[0,0,0,0,0,0,0,1]],\n"HKD":["8.0194","1","0","HKD",[0,0,0,0,0,0,0,1]],\n"HP":["745.69987158227","1","0","0",[2,1,-3,0,0,0,0,0]],\n"Hong Kong dollar":["1","1","0","HKD",[0,0,0,0,0,0,0,1]],\n"Hz":["1","1","0","siSymbol",[0,0,-1,0,0,0,0,0]],\n"ILS":["3.6971","1","0","ILS",[0,0,0,0,0,0,0,1]],\n"INR":["89.1980","1","0","INR",[0,0,0,0,0,0,0,1]],\n"Indian Rupee":["1","1","0","INR",[0,0,0,0,0,0,0,1]],\n"Israeli New Shekel":["1","1","0","ILS",[0,0,0,0,0,0,0,1]],\n"J":["1","1","0","siSymbol",[2,1,-2,0,0,0,0,0]],\n"JPY":["160.23","1","0","JPY",[0,0,0,0,0,0,0,1]],\n"Japanese Yen":["1","1","0","JPY",[0,0,0,0,0,0,0,1]],\n"Joule":["1","1","0","0",[2,1,-2,0,0,0,0,0]],\n"Julian year":["31557600","1","0","0",[0,0,1,0,0,0,0,0]],\n"Jy":["1e-26","1","0","siSymbol",[0,1,-2,0,0,0,0,0]],\n"K":["1","1","0","0",[0,0,0,0,1,0,0,0]],\n"KiB":["8192","1","0","0",[0,0,0,0,0,1,0,0]],\n"KRW":["1502.05","1","0","KRW",[0,0,0,0,0,0,0,1]],\n"L":["0.001","1","0","siSymbol",[3,0,0,0,0,0,0,0]],\n"Lego stud":["0.008","1","0","siSymbol",[1,0,0,0,0,0,0,0]],\n"MB":["8388608","1","0","0",[0,0,0,0,0,1,0,0]],\n"MCM":["5.06707479097497e-07","1","0","0",[2,0,0,0,0,0,0,0]],\n"MMBtu":["1055056000","1","0","0",[2,1,-2,0,0,0,0,0]],\n"MMbbl":["158987.294928","1","0","0",[3,0,0,0,0,0,0,0]],\n"MMbblpd":["158987.294928","86400","0","0",[3,0,-1,0,0,0,0,0]],\n"MMscf":["28316.846592","1","0","0",[3,0,0,0,0,0,0,0]],\n"MMscfd":["0.32774128","1","0","0",[3,0,0,0,0,0,0,0]],\n"MT":["1000","1","0","0",[0,1,0,0,0,0,0,0]],\n"MXN":["21.4193","1","0","MXN",[0,0,0,0,0,0,0,1]],\n"Mach":["331.6","1","0","0",[1,0,-1,0,0,0,0,0]],\n"Mbbl":["158.987294928","1","0","0",[3,0,0,0,0,0,0,0]],\n"Mexican Peso":["1","1","0","MXN",[0,0,0,0,0,0,0,1]],\n"MiB":["8388608","1","0","0",[0,0,0,0,0,1,0,0]],\n"Mscfd":["0.00032774128","1","0","0",[3,0,0,0,0,0,0,0]],\n"Mscfh":["0.00786579072","1","0","0",[3,0,0,0,0,0,0,0]],\n"N":["1","1","0","siSymbol",[1,1,-2,0,0,0,0,0]],\n"NM":["1852","1","0","0",[1,0,0,0,0,0,0,0]],\n"PB":["9007199254740990","1","0","0",[0,0,0,0,0,1,0,0]],\n"PS":["735.49875","1","0","0",[2,1,-3,0,0,0,0,0]],\n"Pa":["1","1","0","siSymbol",[-1,1,-2,0,0,0,0,0]],\n"Pascal":["1","1","0","siWord",[-1,1,-2,0,0,0,0,0]],\n"Pferdestrke":["735.49875","1","0","0",[2,1,-3,0,0,0,0,0]],\n"PiB":["9007199254740990","1","0","0",[0,0,0,0,0,1,0,0]],\n"R":["0.000258","1","0","siSymbol",[0,-1,1,1,0,0,0,0]],\n"R$":["1","1","0","BRL",[0,0,0,0,0,0,0,1]],\n"RT":["3516.8532","1","0","0",[2,1,-3,0,0,0,0,0]],\n"RUB":["1","1","0","RUB",[0,0,0,0,0,0,0,1]],\n"S":["1","1","0","siSymbol",[-2,-1,3,2,0,0,0,0]],\n"SF":["0.09290304","1","0","0",[2,0,0,0,0,0,0,0]],\n"SY":["0.83612736","1","0","0",[2,0,0,0,0,0,0,0]],\n"Sv":["1","1","0","siSymbol",[2,0,-2,0,0,0,0,0]],\n"Swiss Franc":["1","1","0","CHF",[0,0,0,0,0,0,0,1]],\n"T":["1","1","0","siSymbol",[-2,-2,-2,-1,0,0,0,0]],\n"TB":["8796093022208","1","0","0",[0,0,0,0,0,1,0,0]],\n"TWD":["1","1","0","TWD",[0,0,0,0,0,0,0,1]],\n"TeX point":["0.0003515","1","0","0",[1,0,0,0,0,0,0,0]],\n"TiB":["8796093022208","1","0","0",[0,0,0,0,0,1,0,0]],\n"US$":["1","1","0","USD",[0,0,0,0,0,0,0,1]],\n"USD":["1.0298","1","0","USD",[0,0,0,0,0,0,0,1]],\n"V":["1","1","0","siSymbol",[2,1,-3,-1,0,0,0,0]],\n"VA":["1","1","0","siSymbol",[2,1,-3,0,0,0,0,0]],\n"W":["1","1","0","siSymbol",[2,1,-3,0,0,0,0,0]],\n"Wb":["1","1","0","siSymbol",[2,1,-2,-1,0,0,0,0]],\n"Wh":["3600","1","0","siSymbol",[2,1,-2,0,0,0,0,0]],\n"Won":["1","1","0","KRW",[0,0,0,0,0,0,0,1]],\n"Yen":["1","1","0","JPY",[0,0,0,0,0,0,0,1]],\n"a":["31556925.9747","1","0","siSymbol",[0,0,1,0,0,0,0,0]],\n"ac":["4046.8564224","1","0","0",[2,0,0,0,0,0,0,0]],\n"acre":["4046.8564224","1","0","0",[2,0,0,0,0,0,0,0]],\n"admiralty mile":["1853.188","1","0","0",[1,0,0,0,0,0,0,0]],\n"af":["1233.48183754752","1","0","0",[3,0,0,0,0,0,0,0]],\n"amp":["1","1","0","0",[0,0,0,1,0,0,0,0]],\n"ampere":["1","1","0","siWord",[0,0,0,1,0,0,0,0]],\n"ampere turn":["1","1","0","siWord",[0,0,0,0,1,0,1,0]],\n"amu":["1.66053872e-24","1","0","0",[0,1,0,0,0,0,0,0]],\n"angstrom":["0.0000000001","1","0","0",[1,0,0,0,0,0,0,0]],\n"angstrom star":["0.00000000010000015","1","0","0",[1,0,0,0,0,0,0,0]],\n"apostilb":["1","3.14159265358979","0","0",[-2,0,0,0,0,0,1,0]],\n"arcminute":["3.14159265358979","10800","0","0",[0,0,0,0,0,0,0,0]],\n"arcsecond":["3.14159265358979","648000","0","0",[0,0,0,0,0,0,0,0]],\n"are":["100","1","0","0",[2,0,0,0,0,0,0,0]],\n"as":["4.3.14159265358979","648000","0","0",[0,0,0,0,0,0,0,0]],\n"asb":["1","3.14159265358979","0","0",[-2,0,0,0,0,0,1,0]],\n"assay ton":["0.0875","3","0","0",[0,1,0,0,0,0,0,0]],\n"astronomical unit":["149597870691","1","0","0",[1,0,0,0,0,0,0,0]],\n"atmosphere":["101325","1","0","siSymbol",[-1,1,-2,0,0,0,0,0]],\n"au":["149597870691","1","0","0",[1,0,0,0,0,0,0,0]],\n"bar":["100000","1","0","siWord",[-1,1,-2,0,0,0,0,0]],\n"barg":["100000","1","0","0",[-1,1,-2,0,0,0,0,0]],\n"barleycorn":["0.0254","3","0","0",[1,0,0,0,0,0,0,0]],\n"barrel":["0.158987294928","1","0","0",[3,0,0,0,0,0,0,0]],\n"barrel bulk":["0.14158423296","1","0","0",[3,0,0,0,0,0,0,0]],\n"basis point":["0.0001","1","0","0",[0,0,0,0,0,0,0,0]],\n"baud":["1","1","0","siSymbol",[0,0,-1,0,0,1,0,0]],\n"bbl":["0.158987294928","1","0","0",[3,0,0,0,0,0,0,0]],\n"becquerel":["1","1","0","siWord",[0,0,-1,0,0,0,0,0]],\n"beer barrel":["0.119240471196","1","0","0",[3,0,0,0,0,0,0,0]],\n"bit":["1","1","0","0",[0,0,0,0,0,1,0,0]],\n"blink":["0.864","1","0","0",[0,0,1,0,0,0,0,0]],\n"bo":["0.158987294928","1","0","0",[3,0,0,0,0,0,0,0]],\n"boe":["6119000000","1","0","0",[2,1,-2,0,0,0,0,0]],\n"boiler horsepower":["9812.5","1","0","0",[2,1,-3,0,0,0,0,0]],\n"bpd":["0.158987294928","86400","0","0",[3,0,-1,0,0,0,0,0]],\n"bph":["0.158987294928","3600","0","0",[3,0,-1,0,0,0,0,0]],\n"breadth":["0.2286","1","0","0",[1,0,0,0,0,0,0,0]],\n"bushel":["0.03523907016688","1","0","0",[3,0,0,0,0,0,0,0]],\n"byte":["8","1","0","0",[0,0,0,0,0,1,0,0]],\n"caballo de vapor":["735.49875","1","0","0",[2,1,-3,0,0,0,0,0]],\n"cal":["4.1868","1","0","0",[2,1,-2,0,0,0,0,0]],\n"calorie":["4.1868","1","0","siWord",[2,1,-2,0,0,0,0,0]],\n"candela":["1","1","0","siWord",[0,0,0,0,0,0,1,0]],\n"candlepower":["1","1","0","siWord",[0,0,0,0,0,0,1,0]],\n"carat":["0.00002","1","0","0",[0,1,0,0,0,0,0,0]],\n"cc":["0.000001","1","0","0",[3,0,0,0,0,0,0,0]],\n"cd":["1","1","0","siSymbol",[0,0,0,0,0,0,1,0]],\n"centipoise":["0.001","1","0","0",[-1,1,-1,0,0,0,0,0]],\n"centistoke":["0.000001","1","0","0",[2,0,-1,0,0,0,0,0]],\n"cfm":["0.0004719474432","1","0","0",[3,0,-1,0,0,0,0,0]],\n"cfs":["0.028316846592","1","0","0",[3,0,-1,0,0,0,0,0]],\n"ch":["735.49875","1","0","0",[2,1,-3,0,0,0,0,0]],\n"chain":["20.116","1","0","0",[1,0,0,0,0,0,0,0]],\n"cheval vapeur":["735.49875","1","0","0",[2,1,-3,0,0,0,0,0]],\n"cmil":["5.06707479097497e-10","1","0","0",[2,0,0,0,0,0,0,0]],\n"cmm":["0.00001","1","0","0",[1,0,0,0,0,0,0,0]],\n"constant":["1","1","0","0",[0,0,0,0,0,0,0,0]],\n"coulomb":["1","1","0","siWord",[0,0,1,1,0,0,0,0]],\n"cp":["1","1","0","siWord",[0,0,0,0,0,0,1,0]],\n"cps":["1","1","0","0",[0,0,-1,0,0,0,0,0]],\n"cu ft":["0.028316846592","1","0","0",[3,0,0,0,0,0,0,0]],\n"cu in":["0.000016387064","1","0","0",[3,0,0,0,0,0,0,0]],\n"cu yd":["0.764554857984","1","0","0",[3,0,0,0,0,0,0,0]],\n"cubic meter":["1","1","0","0",[3,0,0,0,0,0,0,0]],\n"cubic metre":["1","1","0","0",[3,0,0,0,0,0,0,0]],\n"cup":["0.0002365882365","1","0","0",[3,0,0,0,0,0,0,0]],\n"curie":["37000000000","1","0","siWord",[0,0,-1,0,0,0,0,0]],\n"cv":["735.49875","1","0","0",[2,1,-3,0,0,0,0,0]],\n"cy":["0.764554857984","1","0","0",[3,0,0,0,0,0,0,0]],\n"d":["86400","1","0","0",[0,0,1,0,0,0,0,0]],\n"daN":["10","1","0","0",[1,1,-2,0,0,0,0,0]],\n"darcy":["0.0000000000009869233","1","0","0",[2,0,0,0,0,0,0,0]],\n"day":["86400","1","0","0",[0,0,1,0,0,0,0,0]],\n"deg":["3.14159265358979","180","0","0",[0,0,0,0,0,0,0,0]],\n"degree":["3.14159265358979","180","0","0",[0,0,0,0,0,0,0,0]],\n"dekan":["31.4159265358979","180","0","0",[0,0,0,0,0,0,0,0]],\n"diopter":["1","1","0","0",[-1,0,0,0,0,0,0,0]],\n"dioptre":["1","1","0","0",[-1,0,0,0,0,0,0,0]],\n"dollar":["1","1","0","USD",[0,0,0,0,0,0,0,1]],\n"drum":["0.20819764812","1","0","0",[3,0,0,0,0,0,0,0]],\n"dscf":["0.028316846592","1","0","0",[3,0,0,0,0,0,0,0]],\n"dyn":["0.00001","1","0","0",[1,1,-2,0,0,0,0,0]],\n"dyne":["0.00001","1","0","0",[1,1,-2,0,0,0,0,0]],\n"eV":["1.602176462e-19","1","0","siSymbol",[2,1,-2,0,0,0,0,0]],\n"electric horsepower":["746","1","0","0",[2,1,-3,0,0,0,0,0]],\n"electrical horsepower":["746","1","0","0",[2,1,-3,0,0,0,0,0]],\n"electron volt":["1.602176462e-19","1","0","0",[2,1,-2,0,0,0,0,0]],\n"erg":["0.0000001","1","0","0",[2,1,-2,0,0,0,0,0]],\n"euro":["1","1","0","EUR",[0,0,0,0,0,0,0,1]],\n"exabyte":["9223372036854770000","1","0","0",[0,0,0,0,0,1,0,0]],\n"exbibyte":["9223372036854770000","1","0","0",[0,0,0,0,0,1,0,0]],\n"farad":["1","1","0","siWord",[-2,-1,4,2,0,0,0,0]],\n"faraday":["96485.339924","1","0","0",[0,0,1,1,0,0,0,0]],\n"fathom":["1.8288","1","0","0",[1,0,0,0,0,0,0,0]],\n"fc":["10.7639104167097","1","0","0",[-2,0,0,0,0,0,1,0]],\n"feet":["0.3048","1","0","0",[1,0,0,0,0,0,0,0]],\n"fermi":["0.000000000000001","1","0","siWord",[1,0,0,0,0,0,0,0]],\n"fl oz":["0.003785411784","128","0","0",[3,0,0,0,0,0,0,0]],\n"flop":["1","1","0","0",[0,0,-1,0,0,0,0,0]],\n"fluid ounce":["0.003785411784","128","0","0",[3,0,0,0,0,0,0,0]],\n"food calorie":["4186.8","1","0","0",[2,1,-2,0,0,0,0,0]],\n"foot":["0.3048","1","0","0",[1,0,0,0,0,0,0,0]],\n"footcandle":["10.7639104167097","1","0","0",[-2,0,0,0,0,0,1,0]],\n"footlambert":["1","3.14159265358979","0","0",[-2,0,0,0,0,0,1,0]],\n"fortnight":["1209600","1","0","0",[0,0,1,0,0,0,0,0]],\n"fps":["0.3048","1","0","0",[1,0,-1,0,0,0,0,0]],\n"franklin":["0.00000000033356","1","0","siWord",[0,0,1,1,0,0,0,0]],\n"ft":["0.3048","1","0","0",[1,0,0,0,0,0,0,0]],\n"ft water":["2988.874","1","0","0",[-1,1,-2,0,0,0,0,0]],\n"ftc":["10.7639104167097","1","0","0",[-2,0,0,0,0,0,1,0]],\n"ftl":["3.426259","1","0","0",[-2,0,0,0,0,0,1,0]],\n"furlong":["201.168","1","0","0",[1,0,0,0,0,0,0,0]],\n"g":["0.001","1","0","siSymbol",[0,1,0,0,0,0,0,0]],\n"gal":["0.003785411784","1","0","0",[3,0,0,0,0,0,0,0]],\n"galileo":["0.01","1","0","siWord",[1,0,-2,0,0,0,0,0]],\n"gallon":["0.003785411784","1","0","0",[3,0,0,0,0,0,0,0]],\n"gauss":["0.0001","1","0","siSymbol",[-2,-2,-2,-1,0,0,0,0]],\n"gigabyte":["8589934592","1","0","0",[0,0,0,0,0,1,0,0]],\n"gilbert":["10","12.5663706143592","0","siWord",[0,0,0,0,1,0,1,0]],\n"gill":["0.003785411784","32","0","0",[3,0,0,0,0,0,0,0]],\n"gon":["3.14159265358979","200","0","0",[0,0,0,0,0,0,0,0]],\n"gongjin":["1","1","0","siSymbol",[0,1,0,0,0,0,0,0]],\n"gongli":["1000","1","0","siSymbol",[1,0,0,0,0,0,0,0]],\n"gpd":["0.003785411784","86400","0","0",[3,0,-1,0,0,0,0,0]],\n"gph":["0.003785411784","3600","0","0",[3,0,-1,0,0,0,0,0]],\n"gpm":["0.003785411784","60","0","0",[3,0,-1,0,0,0,0,0]],\n"gps":["0.003785411784","1","0","0",[3,0,-1,0,0,0,0,0]],\n"gr":["0.00006479891","1","0","0",[0,1,0,0,0,0,0,0]],\n"grad":["3.14159265358979","200","0","0",[0,0,0,0,0,0,0,0]],\n"grain":["0.00006479891","1","0","0",[0,1,0,0,0,0,0,0]],\n"gram":["0.001","1","0","0",[0,1,0,0,0,0,0,0]],\n"gramme":["0.001","1","0","0",[0,1,0,0,0,0,0,0]],\n"gray":["1","1","0","0",[2,0,-2,0,0,0,0,0]],\n"great year":["814000000000","1","0","0",[0,0,1,0,0,0,0,0]],\n"gsm":["0.001","1","0","0",[-2,1,0,0,0,0,0,0]],\n"gutenberg":["0.0254","7200","0","0",[1,0,0,0,0,0,0,0]],\n"gngjin":["1","1","0","siSymbol",[0,1,0,0,0,0,0,0]],\n"gngli":["1000","1","0","siSymbol",[1,0,0,0,0,0,0,0]],\n"h":["3600","1","0","0",[0,0,1,0,0,0,0,0]],\n"ha":["10000","1","0","siSymbol",[2,0,0,0,0,0,0,0]],\n"hand":["0.1016","1","0","0",[1,0,0,0,0,0,0,0]],\n"hectare":["10000","1","0","siWord",[2,0,0,0,0,0,0,0]],\n"helek":["10","3","0","0",[0,0,1,0,0,0,0,0]],\n"hemisphere":["6.28318530717959","1","0","0",[0,0,0,0,0,0,0,0]],\n"henrie":["1","1","0","siWord",[2,1,-2,-2,0,0,0,0]],\n"henry":["1","1","0","siWord",[2,1,-2,-2,0,0,0,0]],\n"hertz":["1","1","0","siWord",[0,0,-1,0,0,0,0,0]],\n"hk":["735.49875","1","0","0",[2,1,-3,0,0,0,0,0]],\n"horsepower":["745.69987158227","1","0","0",[2,1,-3,0,0,0,0,0]],\n"hour":["3600","1","0","0",[0,0,1,0,0,0,0,0]],\n"hp":["745.69987158227","1","0","0",[2,1,-3,0,0,0,0,0]],\n"hpE":["746","1","0","0",[2,1,-3,0,0,0,0,0]],\n"hpI":["745.69987158227","1","0","0",[2,1,-3,0,0,0,0,0]],\n"hpM":["735.49875","1","0","0",[2,1,-3,0,0,0,0,0]],\n"hpS":["9812.5","1","0","0",[2,1,-3,0,0,0,0,0]],\n"hr":["3600","1","0","0",[0,0,1,0,0,0,0,0]],\n"in":["0.0254","1","0","0",[1,0,0,0,0,0,0,0]],\n"in Hg":["3863.8","1","0","0",[-1,1,-2,0,0,0,0,0]],\n"inch":["0.0254","1","0","0",[1,0,0,0,0,0,0,0]],\n"inche":["0.0254","1","0","0",[1,0,0,0,0,0,0,0]],\n"jansky":["1e-26","1","0","0",[0,1,-2,0,0,0,0,0]],\n"jar":["1","900000000","0","0",[-2,-1,4,2,0,0,0,0]],\n"joule":["1","1","0","0",[2,1,-2,0,0,0,0,0]],\n"k":["4448.2216152605","1","0","0",[1,1,-2,0,0,0,0,0]],\n"kB":["8192","1","0","0",[0,0,0,0,0,1,0,0]],\n"kB":["8192","1","0","0",[0,0,0,0,0,1,0,0]],\n"kairi":["1852","1","0","0",[1,0,0,0,0,0,0,0]],\n"kanal":["505.8570528","1","0","0",[2,0,0,0,0,0,0,0]],\n"katal":["6.02214179e+23","1","0","siWord",[0,0,-1,0,0,1,0,0]],\n"kcal":["4186.8","1","0","0",[2,1,-2,0,0,0,0,0]],\n"kcmil":["5.06707479097497e-07","1","0","0",[2,0,0,0,0,0,0,0]],\n"keg":["0.058673882652","1","0","0",[3,0,0,0,0,0,0,0]],\n"kelvin":["1","1","0","0",[0,0,0,0,1,0,0,0]],\n"kgf":["9.80665","1","0","0",[1,1,-2,0,0,0,0,0]],\n"kilo":["1","1","0","0",[0,1,0,0,0,0,0,0]],\n"kilobyte":["8192","1","0","0",[0,0,0,0,0,1,0,0]],\n"kilogram":["1","1","0","0",[0,1,0,0,0,0,0,0]],\n"kilogramme":["1","1","0","0",[0,1,0,0,0,0,0,0]],\n"kilopond":["9.80665","1","0","0",[1,1,-2,0,0,0,0,0]],\n"kip":["4448.2216152605","1","0","0",[1,1,-2,0,0,0,0,0]],\n"klf":["4448.2216152605","0.3048","0","0",[0,1,-2,0,0,0,0,0]],\n"kn":["1852","3600","0","0",[1,0,-1,0,0,0,0,0]],\n"knot":["1852","3600","0","0",[1,0,-1,0,0,0,0,0]],\n"kp":["9.80665","1","0","0",[1,1,-2,0,0,0,0,0]],\n"kpf":["4448.2216152605","0.3048","0","0",[0,1,-2,0,0,0,0,0]],\n"kph":["1000/3600","1","0","0",[1,0,-1,0,0,0,0,0]],\n"kpph":["1000/3600","1","0","0",[-1,1,-3,0,0,0,0,0]],\n"ks":["735.49875","1","0","0",[2,1,-3,0,0,0,0,0]],\n"ksf":["47880.2589803358","1","0","0",[-1,1,-2,0,0,0,0,0]],\n"ksi":["6894757.29316836","1","0","0",[-1,1,-2,0,0,0,0,0]],\n"kwh":["3600000","1","0","0",[2,1,-2,0,0,0,0,0]],\n"l":["0.001","1","0","siSymbol",[3,0,0,0,0,0,0,0]],\n"lambert":["10000","3.14159265358979","0","0",[-2,0,0,0,0,0,1,0]],\n"lb":["0.45359237","1","0","0",[0,1,0,0,0,0,0,0]],\n"lbf":["4.4482216152605","1","0","0",[1,1,-2,0,0,0,0,0]],\n"lbm":["0.45359237","1","0","0",[0,1,0,0,0,0,0,0]],\n"league":["5556","1","0","0",[1,0,0,0,0,0,0,0]],\n"lf":["0.3048","1","0","0",[1,0,0,0,0,0,0,0]],\n"li":["500","1","0","0",[1,0,0,0,0,0,0,0]],\n"light year":["9460730472580800","1","0","0",[1,0,0,0,0,0,0,0]],\n"link":["0.201168","1","0","0",[1,0,0,0,0,0,0,0]],\n"liter":["0.001","1","0","siWord",[3,0,0,0,0,0,0,0]],\n"litre":["0.001","1","0","siWord",[3,0,0,0,0,0,0,0]],\n"lm":["1","1","0","siSymbol",[0,0,0,0,0,0,1,0]],\n"long ton":["1016.0469088","1","0","0",[0,1,0,0,0,0,0,0]],\n"lt":["1016.0469088","1","0","0",[0,1,0,0,0,0,0,0]],\n"ltpd":["0.0117598021851852","1","0","0",[0,1,-1,0,0,0,0,0]],\n"lumen":["1","1","0","siWord",[0,0,0,0,0,0,1,0]],\n"lunar day":["89416.32","1","0","0",[0,0,1,0,0,0,0,0]],\n"lunar month":["2551442.976","1","0","0",[0,0,1,0,0,0,0,0]],\n"lux":["1","1","0","siWord",[-2,0,0,0,0,0,1,0]],\n"lx":["1","1","0","siSymbol",[-2,0,0,0,0,0,1,0]],\n"m":["1","1","0","siSymbol",[1,0,0,0,0,0,0,0]],\n"mD":["9.869233e-16","1","0","0",[2,0,0,0,0,0,0,0]],\n"marathon":["42195","1","0","0",[1,0,0,0,0,0,0,0]],\n"marla":["25.29285264","1","0","0",[2,0,0,0,0,0,0,0]],\n"mas":["3.14159265358979","648000000","0","0",[0,0,0,0,0,0,0,0]],\n"maxwell":["0.00000001","1","0","siSymbol",[2,1,-2,-1,0,0,0,0]],\n"mb":["100","1","0","0",[-1,1,-2,0,0,0,0,0]],\n"megabyte":["8388608","1","0","0",[0,0,0,0,0,1,0,0]],\n"megaton TNT":["4184000000000000","1","0","0",[2,1,-2,0,0,0,0,0]],\n"megatons TNT":["4184000000000000","1","0","0",[2,1,-2,0,0,0,0,0]],\n"megohm":["1000000","1","0","0",[2,1,-3,-2,0,0,0,0]],\n"meter":["1","1","0","siWord",[1,0,0,0,0,0,0,0]],\n"metre":["1","1","0","siWord",[1,0,0,0,0,0,0,0]],\n"metric horsepower":["735.49875","1","0","0",[2,1,-3,0,0,0,0,0]],\n"metric ton":["1000","1","0","0",[0,1,0,0,0,0,0,0]],\n"mgd":["3785.411784","86400","0","0",[3,0,-1,0,0,0,0,0]],\n"mho":["1","1","0","0",[-2,-1,3,2,0,0,0,0]],\n"mi":["1609.344","1","0","0",[1,0,0,0,0,0,0,0]],\n"micron":["0.000001","1","0","0",[1,0,0,0,0,0,0,0]],\n"mil":["0.0000254","1","0","0",[1,0,0,0,0,0,0,0]],\n"mile":["1609.344","1","0","0",[1,0,0,0,0,0,0,0]],\n"min":["60","1","0","0",[0,0,1,0,0,0,0,0]],\n"minute":["60","1","0","0",[0,0,1,0,0,0,0,0]],\n"moa":["3.14159265358979","10800","0","0",[0,0,0,0,0,0,0,0]],\n"mol":["6.02214179e+23","1","0","0",[0,0,0,0,0,1,0,0]],\n"mole":["6.02214179e+23","1","0","0",[0,0,0,0,0,1,0,0]],\n"mpg":["1609.344","0.003785411784","0","0",[-2,0,0,0,0,0,0,0]],\n"mph":["0.44704","1","0","0",[1,0,-1,0,0,0,0,0]],\n"mt":["1000","1","0","0",[0,1,0,0,0,0,0,0]],\n"nautical mile":["1852","1","0","0",[1,0,0,0,0,0,0,0]],\n"newton":["1","1","0","0",[1,1,-2,0,0,0,0,0]],\n"nit":["1","1","0","0",[-2,0,0,0,0,0,1,0]],\n"ohm":["1","1","0","siWord",[2,1,-3,-2,0,0,0,0]],\n"ounce":["0.45359237","16","0","0",[0,1,0,0,0,0,0,0]],\n"oz":["0.45359237","16","0","0",[0,1,0,0,0,0,0,0]],\n"oz t":["0.0311034768","1","0","0",[0,1,0,0,0,0,0,0]],\n"parsec":["30856780000000000","1","0","0",[1,0,0,0,0,0,0,0]],\n"pc":["0.0254","6","0","0",[1,0,0,0,0,0,0,0]],\n"pcf":["4.4482216152605","0.028316846592","0","0",[-2,1,-2,0,0,0,0,0]],\n"pci":["4.4482216152605","0.000016387064","0","0",[-2,1,-2,0,0,0,0,0]],\n"pebibyte":["9007199254740990","1","0","0",[0,0,0,0,0,1,0,0]],\n"peck":["0.00880976754172","1","0","0",[3,0,0,0,0,0,0,0]],\n"perfect ream":["516","1","0","0",[0,0,0,0,0,1,0,0]],\n"person":["1","1","0","0",[0,0,0,0,0,1,0,0]],\n"petabyte":["9007199254740990","1","0","0",[0,0,0,0,0,1,0,0]],\n"pfd":["0.5","1","0","0",[0,1,0,0,0,0,0,0]],\n"pferdestrke":["735.49875","1","0","0",[2,1,-3,0,0,0,0,0]],\n"pfund":["0.5","1","0","0",[0,1,0,0,0,0,0,0]],\n"phot":["10000","1","0","0",[-2,0,0,0,0,0,1,0]],\n"pica":["0.0254","6","0","0",[1,0,0,0,0,0,0,0]],\n"pied du roi":["9000","27706","0","0",[1,0,0,0,0,0,0,0]],\n"pieze":["1000","1","0","0",[-1,1,-2,0,0,0,0,0]],\n"pint":["0.000473176473","1","0","0",[3,0,0,0,0,0,0,0]],\n"pk":["735.49875","1","0","0",[2,1,-3,0,0,0,0,0]],\n"platonic year":["814000000000","1","0","0",[0,0,1,0,0,0,0,0]],\n"plf":["4.4482216152605","0.3048","0","0",[0,1,-2,0,0,0,0,0]],\n"point":["0.0254","72","0","0",[1,0,0,0,0,0,0,0]],\n"poise":["0.1","1","0","siWord",[-1,1,-1,0,0,0,0,0]],\n"pound":["0.45359237","1","0","0",[0,1,0,0,0,0,0,0]],\n"poundal":["4.4482216152605","32.174","0","0",[1,1,-2,0,0,0,0,0]],\n"ppm":["0.000001","1","0","0",[0,0,0,0,0,0,0,0]],\n"ppmdv":["0.000001","1","0","0",[0,0,0,0,0,0,0,0]],\n"ppmv":["0.000001","1","0","0",[0,0,0,0,0,0,0,0]],\n"ppmw":["0.000001","1","0","0",[0,0,0,0,0,0,0,0]],\n"printer's point":["0.0003515","1","0","0",[1,0,0,0,0,0,0,0]],\n"printer's ream":["516","1","0","0",[0,0,0,0,0,1,0,0]],\n"ps":["735.49875","1","0","0",[2,1,-3,0,0,0,0,0]],\n"psf":["4.4482216152605","0.09290304","0","0",[-1,1,-2,0,0,0,0,0]],\n"psi":["4.4482216152605","0.00064516","0","0",[-1,1,-2,0,0,0,0,0]],\n"psia":["6894.75729316836","1","0","0",[-1,1,-2,0,0,0,0,0]],\n"psig":["6894.75729316836","1","14.6959","0",[-1,1,-2,0,0,0,0,0]],\n"px":["0.0254","96","0","0",[1,0,0,0,0,0,0,0]],\n"pz":["1000","1","0","0",[-1,1,-2,0,0,0,0,0]],\n"quart":["0.003785411784","4","0","0",[3,0,0,0,0,0,0,0]],\n"quire":["25","1","0","0",[0,0,0,0,0,1,0,0]],\n"rad":["1","1","0","0",[0,0,0,0,0,0,0,0]],\n"radian":["1","1","0","0",[0,0,0,0,0,0,0,0]],\n"rankin":["5","9","0","0",[0,0,0,0,1,0,0,0]],\n"rd":["0.01","1","0","siSymbol",[2,0,-2,0,0,0,0,0]],\n"real":["1","1","0","BRL",[0,0,0,0,0,0,0,1]],\n"ream":["500","1","0","0",[0,0,0,0,0,1,0,0]],\n"rem":["0.01","1","0","siSymbol",[2,0,-2,0,0,0,0,0]],\n"rev":["6.28318530717959","1","0","0",[0,0,0,0,0,0,0,0]],\n"rod":["5.0292","1","0","0",[1,0,0,0,0,0,0,0]],\n"roentgen":["0.000258","1","0","siWord",[0,-1,1,1,0,0,0,0]],\n"rpm":["6.28318530717959","3600","0","0",[0,0,-1,0,0,0,0,0]],\n"ruble":["1","1","0","RUB",[0,0,0,0,0,0,0,1]],\n"rntgen":["0.000258","1","0","siWord",[0,-1,1,1,0,0,0,0]],\n"s":["1","1","0","siSymbol",[0,0,1,0,0,0,0,0]],\n"saltspoon":["0.003785411784","3072","0","0",[3,0,0,0,0,0,0,0]],\n"scf":["0.028316846592","1","0","0",[3,0,0,0,0,0,0,0]],\n"scfd":["0.028316846592","86400","0","0",[3,0,-1,0,0,0,0,0]],\n"scfh":["0.028316846592","3600","0","0",[3,0,-1,0,0,0,0,0]],\n"scfm":["0.028316846592","60","0","0",[3,0,-1,0,0,0,0,0]],\n"sea mile":["1852","1","0","0",[1,0,0,0,0,0,0,0]],\n"sec":["1","1","0","0",[0,0,1,0,0,0,0,0]],\n"second":["1","1","0","0",[0,0,1,0,0,0,0,0]],\n"section":["2589988.110336","1","0","0",[2,0,0,0,0,0,0,0]],\n"sennight":["604800","1","0","0",[0,0,1,0,0,0,0,0]],\n"sheet":["1","1","0","0",[0,0,0,0,0,1,0,0]],\n"short ream":["480","1","0","0",[0,0,0,0,0,1,0,0]],\n"short ton":["907.18474","1","0","0",[0,1,0,0,0,0,0,0]],\n"siemen":["1","1","0","siWord",[-2,-1,3,2,0,0,0,0]],\n"sievert":["1","1","0","siWord",[2,0,-2,0,0,0,0,0]],\n"slinch":["175.126835246477","1","0","0",[0,1,0,0,0,0,0,0]],\n"slug":["14.5939029372064","1","0","0",[0,1,0,0,0,0,0,0]],\n"smoot":["1.7018","1","0","0",[0,1,0,0,0,0,0,0]],\n"span":["0.2286","1","0","0",[1,0,0,0,0,0,0,0]],\n"sphere":["12.5663706143592","1","0","0",[0,0,0,0,0,0,0,0]],\n"sq ft":["0.09290304","1","0","0",[2,0,0,0,0,0,0,0]],\n"sq in":["0.00064516","1","0","0",[2,0,0,0,0,0,0,0]],\n"sq km":["1000000","1","0","0",[2,0,0,0,0,0,0,0]],\n"sq mi":["2589988.110336","1","0","0",[2,0,0,0,0,0,0,0]],\n"sq yd":["0.83612736","1","0","0",[2,0,0,0,0,0,0,0]],\n"square degree":["0.000304617419786709","1","0","0",[0,0,0,0,0,0,0,0]],\n"square meter":["1","1","0","0",[2,0,0,0,0,0,0,0]],\n"square metre":["1","1","0","0",[2,0,0,0,0,0,0,0]],\n"square mi":["2589988.110336","1","0","0",[2,0,0,0,0,0,0,0]],\n"sr":["1","1","0","siSymbol",[0,0,0,0,0,0,0,0]],\n"ssp":["0.003785411784","3072","0","0",[3,0,0,0,0,0,0,0]],\n"standard volume":["22.414","1","0","0",[3,0,0,0,0,0,0,0]],\n"statampere":["0.00000000033356","1","0","0",[0,0,0,1,0,0,0,0]],\n"statcoulomb":["0.00000000033356","1","0","0",[0,0,1,1,0,0,0,0]],\n"statfarad":["0.0000000000011126","1","0","0",[-2,-1,4,2,0,0,0,0]],\n"stathenrie":["898760000000","1","0","0",[2,1,-2,-2,0,0,0,0]],\n"stathenry":["898760000000","1","0","0",[2,1,-2,-2,0,0,0,0]],\n"statohm":["898760000000","1","0","0",[2,1,-3,-2,0,0,0,0]],\n"statvolt":["299.79","1","0","0",[2,1,-3,-1,0,0,0,0]],\n"statwatt":["0.0000001","1","0","0",[2,1,-3,0,0,0,0,0]],\n"steam horsepower":["9812.5","1","0","0",[2,1,-3,0,0,0,0,0]],\n"steradian":["1","1","0","0",[0,0,0,0,0,0,0,0]],\n"stere":["1","1","0","0",[3,0,0,0,0,0,0,0]],\n"stoke":["0.0001","1","0","0",[2,0,-1,0,0,0,0,0]],\n"stone":["6.35029318","1","0","0",[0,1,0,0,0,0,0,0]],\n"stpd":["0.0104998233796296","1","0","0",[0,1,-1,0,0,0,0,0]],\n"stunde":["3600","1","0","0",[0,0,1,0,0,0,0,0]],\n"survey feet":["1200","3937","0","0",[1,0,0,0,0,0,0,0]],\n"survey foot":["1200","3937","0","0",[1,0,0,0,0,0,0,0]],\n"Sv":["1","1","0","siSymbol",[2,0,-2,0,0,0,0,0]],\n"sverdrup":["1000000","1","0","0",[3,0,-1,0,0,0,0,0]],\n"sym":["1","1","0","siSymbol",[0,0,0,0,0,1,0,0]],\n"tablespoon":["0.003785411784","256","0","0",[3,0,0,0,0,0,0,0]],\n"tbsp":["0.003785411784","256","0","0",[3,0,0,0,0,0,0,0]],\n"teaspoon":["0.003785411784","768","0","0",[3,0,0,0,0,0,0,0]],\n"tebibyte":["8796093022208","1","0","0",[0,0,0,0,0,1,0,0]],\n"terabyte":["8796093022208","1","0","0",[0,0,0,0,0,1,0,0]],\n"tesla":["1","1","0","siSymbol",[-2,-2,-2,-1,0,0,0,0]],\n"therm":["105480400","1","0","0",[2,1,-2,0,0,0,0,0]],\n"tidal day":["89416.32","1","0","0",[0,0,1,0,0,0,0,0]],\n"ton":["907.18474","1","0","0",[0,1,0,0,0,0,0,0]],\n"tonf":["8896.443230521","1","0","0",[1,1,-2,0,0,0,0,0]],\n"ton TNT":["4184000000","1","0","0",[2,1,-2,0,0,0,0,0]],\n"ton refrigeration":["3516.8532","1","0","0",[2,1,-3,0,0,0,0,0]],\n"tonne":["1000","1","0","0",[0,1,0,0,0,0,0,0]],\n"tons TNT":["4184000000","1","0","0",[2,1,-2,0,0,0,0,0]],\n"tons refrigeration":["3516.8532","1","0","0",[2,1,-3,0,0,0,0,0]],\n"township":["93239571.972096","1","0","0",[2,0,0,0,0,0,0,0]],\n"toz":["0.0311034768","1","0","0",[0,1,0,0,0,0,0,0]],\n"tpy":["0.0000287475400032297","1","0","0",[0,1,-1,0,0,0,0,0]],\n"tropical year":["31556925.9747","1","0","0",[0,0,1,0,0,0,0,0]],\n"troy ounce":["0.0311034768","1","0","0",[0,1,0,0,0,0,0,0]],\n"tsp":["0.003785411784","768","0","0",[3,0,0,0,0,0,0,0]],\n"turn":["6.28318530717958","1","0","0",[0,0,0,0,0,0,0,0]],\n"twip":["0.0254","1440","0","0",[1,0,0,0,0,0,0,0]],\n"unit":["1","1","0","0",[0,0,0,0,0,1,0,0]],\n"vapeur":["735.49875","1","0","0",[2,1,-3,0,0,0,0,0]],\n"var":["1","1","0","siSymbol",[2,1,-3,0,0,0,0,0]],\n"varistor":["1","1","0","siWord",[2,1,-3,0,0,0,0,0]],\n"volt":["1","1","0","siWord",[2,1,-3,-1,0,0,0,0]],\n"watt":["1","1","0","siWord",[2,1,-3,0,0,0,0,0]],\n"weber":["1","1","0","siSymbol",[2,1,-2,-1,0,0,0,0]],\n"week":["604800","1","0","0",[0,0,1,0,0,0,0,0]],\n"won":["1","1","0","KRW",[0,0,0,0,0,0,0,1]],\n"wppm":["0.000001","1","0","0",[0,0,0,0,0,0,0,0]],\n"yard":["0.9144","1","0","0",[1,0,0,0,0,0,0,0]],\n"yd":["0.9144","1","0","0",[1,0,0,0,0,0,0,0]],\n"year":["31556952","1","0","0",[0,0,1,0,0,0,0,0]],\n"yen":["1","1","0","JPY",[0,0,0,0,0,0,0,1]],\n"":["1","1","0","GBP",[0,0,0,0,0,0,0,1]],\n"":["1","1","0","JPY",[0,0,0,0,0,0,0,1]],\n"":["3.14159265358979","180","0","0",[0,0,0,0,0,0,0,0]],\n"C":["1","1","273.15","0",[0,0,0,0,1,0,0,0]],\n"F":["5","9","459","0",[0,0,0,0,1,0,0,0]],\n"K":["1","1","0","0",[0,0,0,0,1,0,0,0]],\n"R":["5","9","0","0",[0,0,0,0,1,0,0,0]],\n"R":["5","9","0","0",[0,0,0,0,1,0,0,0]],\n"":["0.0000000001","1","0","0",[1,0,0,0,0,0,0,0]],\n"":["1","1","0","siSymbol",[2,1,-3,-2,0,0,0,0]],\n"":["0.0254","1","0","0",[1,0,0,0,0,0,0,0]],\n"":["1","1","0","INR",[0,0,0,0,0,0,0,1]],\n"":["1","1","0","ILS",[0,0,0,0,0,0,0,1]],\n"":["1","1","0","EUR",[0,0,0,0,0,0,0,1]],\n"":["1","1","273.15","0",[0,0,0,0,1,0,0,0]],\n"":["5","9","459","0",[0,0,0,0,1,0,0,0]],\n"":["1","1","0","siSymbol",[2,1,-3,-2,0,0,0,0]],\n"":["1","1","0","0",[0,0,0,0,1,0,0,0]],\n"":["0.0000000001","1","0","0",[1,0,0,0,0,0,0,0,0]]\n}`));const synonyms=Object.freeze({$:"USD",US$:"USD",dollar:"USD",A$:"AUD","Australian dollar":"AUD","Brazilian Real":"BRL",real:"BRL",R$:"BRL","British Pound":"GBP","":"GBP",C$:"CAD","Canadian dollar":"CAD","Chinese Yuan":"CNY","":"EUR",Euro:"EUR",euro:"EUR",HK$:"HKD","Hong Kong dollar":"HKD","Indian Rupee":"IDR","":"IDR","Israeli New Shekel":"ILS","":"ILS","Mexican Peso":"MXN","Swiss Franc":"CHF",Won:"KRW",won:"KRW",yen:"JPY",Yen:"JPY","Japanese Yen":"JPY","":"JPY"});const siPrefixRegEx=/^(yotta|zetta|exa|peta|tera|giga|mega|kilo|hecto|deka|deci|centi|milli|micro|nano|pico|femto|atto|zepto|yocto)/;const unitFromWord=e=>{const t=e.trim();const n=t.length;const r={name:t,factor:Rnl.one,gauge:Rnl.zero,log:"",expos:[0,0,0,0,0,0,0,0]};if(e===""){return r}let o="";let i;let s=false;let a="";let l=false;let c=false;for(let e=1;e<3;e++){if(e===1){s=true;o=t;if(n>2){if(o.charAt(o.length-1)==="s"){if(!(o==="cfs"||n===3&o.charAt(1)==="p")){o=o.slice(0,-1)}}}a="";if(n>3){const e=siPrefixRegEx.exec(o);if(e&&o!=="micron"){a=e[0];s=true;o=o.slice(a.length)}}}else{s=false;a=o.charAt(0);if("YZEPTGMkhdcmnpfazy".indexOf(a)>-1){s=true;o=o.substring(1)}}if(s){i=unitTable[o];if(i){c=true}if(e===1&&c&&a===""){break}else if(c){if(e===1){c=i[3]==="siWord";l=true;break}else{c=i[3]==="siSymbol";l=true}}}}if(c){r.gauge=Rnl.fromString(i[2]);r.expos=Object.freeze(i[4]);if(r.expos[7]===1){const e=synonyms[o]?synonyms[o]:o;i=unitTable[e];if(i[0]==="0"){return errorOprnd("CURRENCY")}else{r.factor=Rnl.reciprocal(Rnl.fromString(i[0]))}}else{r.factor=Rnl.divide(Rnl.fromString(i[0]),Rnl.fromString(i[1]))}if(l){r.factor=Rnl.multiply(r.factor,Rnl.fromNumber(prefixFactor[a]))}}else{return errorOprnd("UNIT_NAME",t)}return Object.freeze(r)};const opOrNumRegEx=/[0-9\-\u2074-\u2079/^()]/;const numeralRegEx=/[0-9-]/;const opRegEx=/^[/\-^]$/;const unitFromUnitName=e=>{if(!e){return{name:null,factor:null,gauge:null,log:"",expos:null}}let t=e.trim();t=t.replace(/[*.\-](?![0-9.])/g,"");const n={name:t,factor:Rnl.one,gauge:Rnl.zero,log:"",expos:allZeros};if(t===""){return n}else if(t===""||t===""||t==="degMinSec"){n.factor=Rnl.fromString("0.0174532925199433");return n}else if(t==="feetInch"){n.unitExpos=[1,0,0,0,0,0,0,0];n.factor=Rnl.fromString("0.3048");return n}else if(t===""||t===""){n.unitExpos=[1,0,0,0,0,0,0,0];n.factor=Rnl.fromString("0.0254");return n}const r=";";let o=false;let i="";let s="";let a="";let l="";const c=[];let d=0;const u=[{symbol:"",prec:-1}];let p="";for(let e=0;e<t.length;e++){i=t.charAt(e);if(numeralRegEx.test(i)){if(!o){a+=r;l+=r;u.push({symbol:"^",prec:3});o=true}a+=i;l+=i}else if(exponentRegEx.test(i)){if(!o){a+=r;l+=r;u.push({symbol:"^",prec:3});o=true}const e=numeralFromSuperScript(i);a+=e;l+=e}else if(i==="^"){a+=r;l+=r;u.push({symbol:"^",prec:3});o=true}else if(i===""||i==="/"){o=false;a+=r;l+=r;while(u[u.length-1].prec>=1){const e=u.pop().symbol;a+=e+r;l+=e+r}u.push({symbol:i,prec:1})}else if(i==="("){u.push({symbol:"(",prec:0})}else if(i===")"){while(u[u.length-1].prec>0){const e=u.pop().symbol;a+=e+r;l+=e+r}u.pop();o=false}else if(i==="-"){o=true;u.push({symbol:"^",prec:3});u.push({symbol:"-",prec:2});a+=r;l+=r}else{o=false;let r;for(r=e+1;r<t.length;r++){if(opOrNumRegEx.test(t.charAt(r))){break}}s=t.substring(e,r);p=unitFromWord(s);if(p.dtype&&p.dtype===dt.ERROR){return p}if(p.factor===0){n.name="";return n}a+=String(p.factor[0])+","+String(p.factor[1]);l+=""+d;c.push(p.expos);d+=1;e=r-1}}if(s===n.name){return Object.freeze(p)}while(u.length>1){const e=u.pop().symbol;a+=r+e;l+=r+e}const f=[];const h=[];const m=a.split(r);const g=l.split(r);let y=1;let b;d=0;for(let e=0;e<m.length;e++){if(opRegEx.test(m[e])){y=f.pop();b=h.pop()}switch(m[e]){case"":f[f.length-1]=Rnl.multiply(f[f.length-1],y);h[h.length-1]=h[h.length-1].map(((e,t)=>e+b[t]));break;case"/":if(Rnl.isZero(y)){return errorOprnd("DIV")}f[f.length-1]=Rnl.divide(f[f.length-1],y);h[h.length-1]=h[h.length-1].map(((e,t)=>e-b[t]));break;case"^":f[f.length-1]=Rnl.power(f[f.length-1],y);h[h.length-1]=h[h.length-1].map((e=>e*b));break;case"-":f[f.length-1]=Rnl.negate(f[f.length-1]);break;default:if(m[e].indexOf(",")>-1){const t=m[e].split(",");f.push([BigInt(t[0]),BigInt(t[1])])}else{f.push([BigInt(m[e]),BigInt(1)])}if(g[e].charAt(0)===""){h.push(c[d]);d+=1}else{h.push(g[e])}}}n.factor=Object.freeze(f.pop());n.expos=Object.freeze(h.pop());return Object.freeze(n)};const j=[Rnl.zero,Rnl.one];const isComplex=e=>Array.isArray(e)&&e.length===2&&Rnl.isRational(e[0])&&Rnl.isRational(e[1]);const real=e=>e[0];const imag=e=>e[1];const abs=e=>Rnl.hypot(e[0],e[1]);const negate=e=>[Rnl.negate(e[0]),Rnl.negate(e[1])];const conjugate=e=>[e[0],Rnl.negate(e[1])];const angle=e=>{if(Rnl.isZero(e[0])&&Rnl.isZero(e[1])){return errorOprnd("ORIGIN","angle")}else if(Rnl.isZero(e[1])){return Rnl.isPositive(e[0])?Rnl.zero:Rnl.pi}else if(Rnl.isZero(e[0])){return Rnl.isPositive(e[1])?Rnl.divide(Rnl.pi,Rnl.two):Rnl.negate(Rnl.divide(Rnl.pi,Rnl.two))}else{return Rnl.fromNumber(Math.atan2(Rnl.toNumber(e[1]),Rnl.toNumber(e[0])))}};const add=(e,t)=>[Rnl.add(e[0],t[0]),Rnl.add(e[1],t[1])];const subtract=(e,t)=>[Rnl.subtract(e[0],t[0]),Rnl.subtract(e[1],t[1])];const multiply=(e,t)=>[Rnl.subtract(Rnl.multiply(e[0],t[0]),Rnl.multiply(e[1],t[1])),Rnl.add(Rnl.multiply(e[0],t[1]),Rnl.multiply(e[1],t[0]))];const divide=(e,t)=>{if(!Rnl.isZero(e[1])&&!Rnl.isZero(t[1])){if(Rnl.lessThan(Rnl.abs(t[1]),Rnl.abs(t[0]))){const n=Rnl.divide(t[1],t[0]);const r=Rnl.add(t[0],Rnl.multiply(t[1],n));return[Rnl.divide(Rnl.add(e[0],Rnl.multiply(e[1],n)),r),Rnl.divide(Rnl.subtract(e[1],Rnl.multiply(e[0],n)),r)]}else{const n=Rnl.divide(t[0],t[1]);const r=Rnl.add(t[1],Rnl.multiply(t[0],n));return[Rnl.divide(Rnl.add(e[1],Rnl.multiply(e[0],n)),r),Rnl.divide(Rnl.add(Rnl.negate(e[0]),Rnl.multiply(e[1],n)),r)]}}else if(Rnl.isZero(e[1])){if(Rnl.lessThan(Rnl.abs(t[1]),Rnl.abs(t[0]))){const n=Rnl.divide(t[1],t[0]);const r=Rnl.add(t[0],Rnl.multiply(t[1],n));return[Rnl.divide(e[0],r),Rnl.negate(Rnl.multiply(e[0],Rnl.divide(n,r)))]}else{const n=Rnl.divide(t[0],t[1]);const r=Rnl.add(t[1],Rnl.multiply(t[0],n));return[Rnl.divide(Rnl.multiply(e[0],n),r),Rnl.negate(Rnl.divide(e[0],r))]}}else if(Rnl.isZero(t[1])){if(Rnl.isZero(t[0]));else{return[Rnl.divide(e[0],t[0]),Rnl.divide(e[1],t[0])]}}else{if(Rnl.isZero(t[0])){return errorOprnd("DIV")}else{return[Rnl.divide(e[0],t[0]),Rnl.zero]}}};const increment=e=>[Rnl.increment(e[0]),e[1]];const decrement=e=>[Rnl.decrement(e[0]),e[1]];const inverse=e=>{if(Rnl.isZero(e[1])){if(Rnl.isZero(e[0])){return errorOprnd("DIV")}return[Rnl.inverse(e[0]),0]}else{return divide([Rnl.one,Rnl.zero],e)}};const cos=e=>{const t=Rnl.multiply(Rnl.cos(e[0]),Rnl.cosh(e[1]));const n=Rnl.multiply(Rnl.negate(Rnl.sin(e[0])),Rnl.sinh(e[1]));return[t,n]};const sin=e=>{const t=Rnl.multiply(Rnl.sin(e[0]),Rnl.cosh(e[1]));const n=Rnl.multiply(Rnl.cos(e[0]),Rnl.sinh(e[1]));return[t,n]};const log=e=>{let t=[Rnl.zero,Rnl.zero];if(Rnl.isZero(e[0])&&Rnl.isZero(e[1])){return errorOprnd("ORIGIN","log")}else{t[0]=Rnl.fromNumber(Math.log(Rnl.toNumber(Rnl.hypot(e[0],e[1]))));t[1]=angle(e)}return t};const isSmall=e=>Rnl.lessThan(Rnl.abs(e),[BigInt(1),BigInt(1e14)]);const exp=e=>{let t=[Rnl.zero,Rnl.zero];if(isSmall(e[1])){t[1]=Rnl.zero;t[0]=Rnl.exp(e[0])}else{if(Rnl.isZero(e[0])){t[0]=Rnl.cos(e[1]);if(isSmall(t[0])){t[0]=Rnl.zero}t[1]=Rnl.sin(e[1]);if(isSmall(t[1])){t[1]=Rnl.zero}}else{const n=Rnl.exp(e[0]);t[0]=Rnl.multiply(n,Rnl.cos(e[1]));t[1]=Rnl.multiply(n,Rnl.sin(e[1]))}}return t};const power=(e,t)=>{let n=[Rnl.zero,Rnl.zero];if(!isComplex(t)){n=log(e);n[0]=Rnl.multiply(n[0],t);n[1]=Rnl.multiply(n[1],t)}else if(Rnl.isZero(t[1])){n=log(e);n[0]=Rnl.multiply(n[0],t[0]);n[1]=Rnl.multiply(n[1],t[0])}else if(Rnl.isZero(e[1])&&!Rnl.isNegative(e[0])){e[0]=Rnl.fromNumber(Math.log(Rnl.toNumber(e[0])));n[0]=Rnl.multiply(e[0],t[0]);n[1]=Rnl.multiply(e[0],t[1])}else{e=log(e);n[0]=Rnl.subtract(Rnl.multiply(e[0],t[0]),Rnl.multiply(e[1],t[1]));n[1]=Rnl.add(Rnl.multiply(e[1],t[0]),Rnl.multiply(e[0],t[1]))}n=exp(n);if(isSmall(n[1])){n[1]=Rnl.zero}if(isSmall(n[0])){n[0]=Rnl.zero}return n};const acosh=e=>log(add(e,multiply(sqrt(decrement(e)),sqrt(increment(e)))));const asinh=e=>{const t=sqrt(add(multiply(e,e),[Rnl.one,Rnl.zero]));return log(add(e,t))};const atanh=e=>divide(subtract(log(increment(e)),log(subtract([Rnl.one,Rnl.zero],e))),[Rnl.two,Rnl.zero]);const asin=e=>divide(asinh(multiply(j,e)),j);const atan=e=>{const t=log(increment(multiply(j,e)));const n=log(subtract([Rnl.one,Rnl.zero],multiply(j,e)));return divide(subtract(t,n),[Rnl.zero,Rnl.two])};const sqrt=e=>{const t=log(e);t[0]=Rnl.divide(t[0],Rnl.two);t[1]=Rnl.divide(t[1],Rnl.two);return exp(t)};const lanczos=t=>{const n=subtract(t,[Rnl.one,Rnl.zero]);const r=Rnl.sqrt(Rnl.divide(e,pi));const o=multiply([Rnl.two,Rnl.zero],[r,Rnl.zero]);const i=Rnl.fromNumber(11.400511);const s=[[BigInt(1),BigInt(2)],Rnl.zero];const a=power(divide(add(n,[i,Rnl.zero]),[e,Rnl.zero]),add(n,s));const l=["2.48574089138753565546e-5","1.05142378581721974210","-3.45687097222016235469","4.51227709466894823700","-2.98285225323576655721","1.05639711577126713077","-0.195428773191645869583","0.0170970543404441224307","-0.000571926117404305781283","0.00000463399473359905636708","-0.00000000271994908488607703910"];let c=[Rnl.fromString(l[0]),Rnl.zero];for(let e=1;e<=10;e++){const t=[Rnl.fromString(t[e]),Rnl.zero];const r=[Rnl.fromNumber(e),Rnl.zero];c=add(c,divide(t,add(n,r)))}return multiply(multiply(o,a),c)};const display$3=(e,t,n)=>{const r=/[]/.test(t)?t.slice(-1):"j";let o="";let i="";if(r==="j"){const r=format(e[0],t,n);let s=format(e[1],t,n);if(s.charAt(0)==="-"){o=r+" - j\\,"+-s;i=r+" - j "+-s}else{o=r+" + j\\, "+s;i=r+" + j "+s}}else{const s=Rnl.hypot(e[0],e[1]);let a=Cpx.angle(e);const l=r.indexOf("")>-1;if(l){a=Rnl.divide(Rnl.multiply(a,Rnl.fromNumber(180)),Rnl.pi)}o=format(s,t,n)+""+format(a,t,n)+(l?"":"");i=o}return[o,i]};const Cpx=Object.freeze({j:j,real:real,imag:imag,abs:abs,conjugate:conjugate,angle:angle,inverse:inverse,increment:increment,decrement:decrement,isComplex:isComplex,add:add,subtract:subtract,divide:divide,multiply:multiply,negate:negate,power:power,exp:exp,log:log,sqrt:sqrt,sin:sin,cos:cos,asin:asin,atan:atan,acosh:acosh,asinh:asinh,atanh:atanh,lanczos:lanczos,display:display$3});const isMatrix=e=>e.dtype&dt.ROWVECTOR||e.dtype&dt.COLUMNVECTOR||e.dtype&dt.MATRIX;const isVector=e=>(e.dtype&dt.ROWVECTOR||e.dtype&dt.COLUMNVECTOR)>0;const transpose=e=>{const t={unit:e.unit};if(isVector(e)){t.value=e.value;const n=(e.dtype&dt.ROWVECTOR?1:-1)*(dt.COLUMNVECTOR-dt.ROWVECTOR);t.dtype=e.dtype+n}else if(e.dtype&dt.MATRIX){t.value=e.value[0].map(((t,n)=>e.value.map((e=>e[n]))));t.dtype=e.dtype}else{return errorOprnd("BAD_TRANS")}return t};const convertFromBaseUnits$1=(e,t,n)=>{let r=isVector(e)?e.value.map((e=>Rnl.divide(e,n))):e.value.map((e=>e.map((e=>Rnl.divide(e,n)))));if(!Rnl.isZero(t)){r=isVector(e)?e.value.map((e=>Rnl.subtract(e,t))):e.value.map((e=>e.map((e=>Rnl.subtract(e,t)))))}return Object.freeze(r)};const convertToBaseUnits$1=(e,t,n)=>{let r=clone(e.value);if(!Rnl.isZero(t)){r=isVector(e)?e.value.map((e=>Rnl.add(e,t))):e.value.map((e=>e.map((e=>Rnl.add(e,t)))))}r=isVector(e)?r.map((e=>Rnl.multiply(e,n))):r.map((e=>e.map((e=>Rnl.multiply(e,n)))));return Object.freeze(r)};const elementDisplay=(e,t,n,r,o=false)=>{let i=e===undefined?"":t&dt.RATIONAL?format(e,n,r):t&dt.COMPLEX?Cpx.display(e,n,r)[0]:t&dt.BOOLEAN||t&dt.STRING?o?e:"\\text{"+e+"}":e;if(o&&(t&dt.RATIONAL||t&dt.COMPLEX)){i=i.replace(/{,}/g,",")}return i};const display$2=(e,t,n)=>{let r="";if(e.dtype&dt.MATRIX){r+="\\begin{pmatrix}";const o=e.value.length;const i=e.value[0].length;for(let s=0;s<o;s++){for(let o=0;o<i;o++){r+=elementDisplay(e.value[s][o],e.dtype,t,n)+" &"}r=r.slice(0,-1)+" \\\\ "}r=r.slice(0,-3).trim();r+="\\end{pmatrix}"}else{const o=e.value.plain?e.value.plain.length:e.value.length;if(o===0){r+="[\\,]"}else{r+="\\begin{bmatrix}";const i=e.dtype&dt.ROWVECTOR?" & ":" \\\\ ";if(e.value.plain){for(let s=0;s<o;s++){r+=elementDisplay(e.value.plain[s],e.dtype,t,n)+(s<o-1?i:"")}}else{for(let s=0;s<o;s++){r+=elementDisplay(e.value[s],e.dtype,t,n)+(s<o-1?i:"")}}r+="\\end{bmatrix}"}}return r};const displayAlt$2=(e,t,n)=>{let r="";if(e.dtype&dt.MATRIX){r+="(";const o=e.value.length;const i=e.value[0].length;for(let s=0;s<o;s++){for(let o=0;o<i;o++){r+=elementDisplay(e.value[s][o],e.dtype,t,n,true)+", "}r=r.slice(0,-2)+"; "}r=r.slice(0,-2).trim();r+=")"}else{r+="[";const o=e.dtype&dt.ROWVECTOR?", ":"; ";if(e.value.plain){const i=e.value.plain.length;for(let s=0;s<i;s++){r+=elementDisplay(e.value.plain[s],e.dtype,t,n,true)+(s<i-1?o:"")}}else{const i=e.value.length;for(let s=0;s<i;s++){r+=elementDisplay(e.value[s],e.dtype,t,n,true)+(s<i-1?o:"")}}r+="]"}return r};const findfirst$1=(e,t)=>{if(!isVector(t)){return errorOprnd("NOT_VECTOR","findfirst")}const n=Rnl.isRational(e);for(let r=0;r<t.value.length;r++){const o=t.value[r];if(n&Rnl.areEqual(o,e)||o===e){return Rnl.fromNumber(r+1)}}return Rnl.zero};const identity=(e,t)=>{const n=Rnl.isRational(e)?Rnl.toNumber(e):e;if(n===1){return[Rnl.one]}else{const e=[];for(let t=0;t<n;t++){e.push(new Array(n).fill(Rnl.zero));e[t][t]=Rnl.one}return t?e:Object.freeze(e)}};const invert=(e,t)=>{if(e.length!==e[0].length){return errorOprnd("NONSQUARE")}const n=e.length;let r=0;let o=0;let i=0;let s=Rnl.zero;let a=Rnl.one;const l=clone(e);const c=identity(n,true);for(r=0;r<n;r+=1){s=l[r][r];if(Rnl.isZero(s)){for(o=r+1;o<n;o++){if(!Rnl.isZero(l[o][r])){for(i=0;i<n;i++){s=l[r][i];l[r][i]=l[o][i];l[o][i]=s;s=c[r][i];c[r][i]=c[o][i];c[o][i]=s}break}}s=l[r][r];if(Rnl.isZero(s)){return errorOprnd("SINGULAR")}}if(t){a=Rnl.divide(a,s);if(r===n-1){return a}}for(i=0;i<n;i++){l[r][i]=Rnl.divide(l[r][i],s);c[r][i]=Rnl.divide(c[r][i],s)}for(o=0;o<n;o++){if(o===r){continue}s=l[o][r];for(i=0;i<n;i++){l[o][i]=Rnl.subtract(l[o][i],Rnl.multiply(s,l[r][i]));c[o][i]=Rnl.subtract(c[o][i],Rnl.multiply(s,c[r][i]))}}}return Object.freeze(c)};const submatrix=(e,t,n)=>{if(!(t.dtype&dt.RATIONAL||t.dtype&dt.RANGE)){return errorOprnd("BAD_INDEX")}let r=[];let o=e.dtype;let i=0;let s=1;let a=0;if(t.dtype&dt.RANGE){i=Rnl.toNumber(t.value[0]);s=Rnl.toNumber(t.value[1]);a=t.value[2]===""?e.value.length:Rnl.toNumber(t.value[2])}else if(Rnl.areEqual(t.value,Rnl.zero)){i=1;a=e.value.length}else{i=Rnl.toNumber(t.value);a=i}if(isVector(e)){if(i===a){r=e.value[i-1];o=e.dtype-(e.dtype&dt.ROWVECTOR)-(e.dtype&dt.COLUMNVECTOR)}else if(s===1){r=e.value.slice(i-1,a)}else{for(let t=i-1;t<a;t+=s){r.push(e.value[t])}}Object.freeze(r);return Object.freeze({value:r,unit:e.unit,dtype:o})}let l=0;let c=1;let d=0;if(n){if(n.dtype&dt.RANGE){l=Rnl.toNumber(n.value[0]);c=Rnl.toNumber(n.value[1]);d=n.value[2]===""?e.value[0].length:Rnl.toNumber(n.value[2])}else if(Rnl.areEqual(n.value,Rnl.zero)){l=1;d=e.value[0].length}else{l=Rnl.toNumber(n.value);d=l}}if(i===a&&l===d){r=e.value[i-1][l-1];o-=dt.MATRIX}else if(i===a){if(c===1){r=e.value[i-1].slice(l-1,d)}else{for(let t=l-1;t<d;t+=c){r.push(e.value[i-1][t])}}o=o-dt.MATRIX+dt.ROWVECTOR}else if(l===d){for(let t=i-1;t<a;t+=s){r.push(e.value[t][l-1])}o=o-dt.MATRIX+dt.COLUMNVECTOR}else if(c===1){for(let t=i-1;t<a;t+=s){r.push([]);r[r.length-1]=e.value[t].slice(l-1,d)}}else{for(let t=i-1;t<a;t+=s){r.push([]);for(let n=l-1;n<d;n+=c){r[r.length-1].push(e[t][n])}}}Object.freeze(r);return Object.freeze({value:r,unit:e.unit,dtype:o})};const multResultType=(e,t)=>{if(e.dtype&dt.ROWVECTOR&&t.dtype&dt.COLUMNVECTOR){return dt.RATIONAL}else if(e.dtype&dt.MATRIX&&t.dtype&dt.COLUMNVECTOR){return t.dtype}else if(e.dtype&dt.ROWVECTOR&&t.dtype&dt.MATRIX){return e.dtype}else{return dt.MATRIX+dt.RATIONAL}};const operandFromRange=e=>{if(Rnl.isZero(e[1])){return errorOprnd("ZERO_STEP")}if(!Rnl.areEqual(Rnl.sign(Rnl.subtract(e[2],e[0])),Rnl.sign(e[1]))){e[1]=Rnl.negate(e[1])}const t=[];if(Rnl.greaterThan(e[2],e[0])){for(let n=e[0];Rnl.lessThan(n,e[2]);n=Rnl.add(n,e[1])){t.push(n)}}else{for(let n=e[0];Rnl.greaterThanOrEqualTo(n,e[2]);n=Rnl.add(n,e[1])){t.push(n)}}if(!Rnl.areEqual(t[t.length-1],e[2])){t.push(e[2])}Object.freeze(t);return Object.freeze({value:t,unit:{expos:allZeros},dtype:dt.RATIONAL+dt.COLUMNVECTOR})};const operandFromTokenStack=(e,t,n)=>{if(t===0&&n===0){return Object.freeze({value:new Array(0),unit:null,dtype:dt.COLUMNVECTOR})}else if(t===1&&n===1){return e.pop()}else if(t===1||n===1){const r=Math.max(t,n);let o;let i=e[e.length-1].dtype;if(t===1&&i&dt.COLUMNVECTOR){i=i-dt.COLUMNVECTOR+dt.MATRIX;o=new Array(e[0].value.length);for(let t=0;t<e[0].value.length;t++){o[t]=[];for(let n=0;n<r;n++){o[t][n]=e[n].value[t]}}for(let t=0;t<r;t++){e.pop()}}else{o=new Array(r);i+=t===1?dt.ROWVECTOR:dt.COLUMNVECTOR;for(let t=r-1;t>=0;t--){o[t]=e.pop().value}}Object.freeze(o);return Object.freeze({value:o,unit:i&dt.RATIONAL?{expos:allZeros}:null,dtype:i})}else{const r=new Array(t);const o=e[e.length-1].dtype+dt.MATRIX;for(let e=0;e<t;e++){r[e]=new Array(n)}for(let o=t-1;o>=0;o--){for(let t=n-1;t>=0;t--){r[o][t]=e.pop().value}}Object.freeze(r);return Object.freeze({value:r,unit:o&dt.RATIONAL?{expos:allZeros}:null,dtype:o})}};const ones=(e,t)=>{if(e===1||t===1){return{value:new Array(t).fill(Rnl.one),unit:allZeros,dtype:dt.RATIONAL+(e===1?dt.ROWVECTOR:dt.COLUMNVECTOR)}}else{const n=[];for(let r=0;r<e;r++){n.push(new Array(t).fill(Rnl.one))}Object.freeze(n);return Object.freeze({value:n,unit:{expos:allZeros},dtype:dt.RATIONAL+dt.MATRIX})}};const zeros=(e,t)=>{if(e===1||t===1){return{value:new Array(t).fill(Rnl.zero),unit:allZeros,dtype:dt.RATIONAL+(e===1?dt.ROWVECTOR:dt.COLUMNVECTOR)}}else{const n=[];for(let r=0;r<e;r++){n.push(new Array(t).fill(Rnl.zero))}Object.freeze(n);return Object.freeze({value:n,unit:{expos:allZeros},dtype:dt.RATIONAL+dt.MATRIX})}};const Matrix=Object.freeze({convertFromBaseUnits:convertFromBaseUnits$1,convertToBaseUnits:convertToBaseUnits$1,display:display$2,displayAlt:displayAlt$2,elementDisplay:elementDisplay,findfirst:findfirst$1,identity:identity,invert:invert,multResultType:multResultType,ones:ones,operandFromRange:operandFromRange,operandFromTokenStack:operandFromTokenStack,submatrix:submatrix,transpose:transpose,zeros:zeros});const columnListFromRange=(e,t)=>{const n=[];for(let r=e;r<=t;r++){n.push(r)}return n};const valueFromDatum=e=>e==="true"?true:e==="false"?false:numberRegEx$6.test(e)?Rnl.fromString(e):e===""?undefined:e;const datumFromValue=(e,t,n)=>e===true?"true":e===false?"false":e===undefined?"":t===dt.RATIONAL?format(e,n,"1000000."):e;const identifyRange=(e,t)=>{let n;let r;let o=[];let i=[];if(e.value.data[0].length===1){n=0;r=0;if(e.dtype===dt.DATAFRAME){e.value.usedRows.add(0)}for(let n=0;n<t.length;n++){if(t[n].dtype===dt.STRING){i.push(e.value.columnMap[t[n].value])}else if(t[n].dtype===dt.RATIONAL){i.push(Rnl.toNumber(t[n].value))}else if(t[n].dtype===dt.RANGE){const e=Rnl.toNumber(t[n].value[0])-1;const r=Rnl.toNumber(t[n].value[2])-1;for(let t=e;t<=r;t++){i.push(t)}}}}else if(t.length===1&&t[0].dtype===dt.RATIONAL){n=0;r=e.value.data[0].length-1;i.push(Rnl.toNumber(t[0].value)-1)}else if(t.length===1&&t[0].dtype===dt.RANGE){i=columnListFromRange(Rnl.toNumber(t[0].value[0])-1,Rnl.toNumber(t[0].value[2])-1);n=0;r=e.value.data[0].length-1;if(e.dtype===dt.DATAFRAME){for(let t=n;t<=r;t++){e.value.usedRows.add(t)}}}else if(t.length===1&&t[0].dtype===dt.STRING){if(e.value.rowMap&&t[0].value in e.value.rowMap){n=e.value.rowMap[t[0].value];r=n;if(e.dtype===dt.DATAFRAME){e.value.usedRows.add(n)}i=columnListFromRange(0,e.value.data.length-1)}else if(e.value.columnMap&&t[0].value in e.value.columnMap){n=0;r=e.value.data[0].length-1;i.push(e.value.columnMap[t[0].value])}else{return[errorOprnd("BAD_ROW_NAME",t[0].value),null,null,null]}}else if(t.length===1&&t[0].dtype===dt.STRING+dt.COLUMNVECTOR){for(const n of t[0].value){o.push(n);if(e.dtype===dt.DATAFRAME){e.value.usedRows.add(e.value.rowMap[n])}}i=columnListFromRange(0,e.value.data.length-1)}else if(t.length===1&&t[0].dtype===dt.STRING+dt.ROWVECTOR){n=0;r=e.value.data[0].length;for(const n of t[0].value){i.push(e.columnIndicator[n])}}else if(t.length===2){if(t[0].dtype===dt.STRING){if(e.value.rowMap&&t[0].value in e.value.rowMap){n=e.value.rowMap[t[0].value];r=n}else if(t[0].value==="end"){n=e.value.data[0].length-1;r=n}else{n=0;r=e.value.data.length-1}}else if(t[0].dtype===dt.RATIONAL){n=Rnl.toNumber(t[0].value)-1;r=n}else if(t[0].dtype===dt.RANGE){n=Rnl.toNumber(t[0].value[0])-1;r=Rnl.toNumber(t[0].value[2])-1}else;if(e.dtype===dt.DATAFRAME){for(let t=n;t<=r;t++){e.value.usedRows.add(t)}}if(t[0].dtype===dt.STRING&&e.value.columnMap&&t[0].value in e.value.columnMap){i.push(e.value.columnMap[t[0].value])}if(t[1].dtype===dt.STRING&&e.value.columnMap&&t[1].value in e.value.columnMap){i.push(e.value.columnMap[t[1].value])}else if(t[1].dtype===dt.STRING&&t[1].value==="end"){i.push(e.value.headings.length-1)}else if(t[1].dtype===dt.RATIONAL){i.push(Rnl.toNumber(t[1].value)-1)}else if(t[1].dtype===dt.RANGE){const n=Rnl.toNumber(t[1].value[0])-1;const r=Rnl.toNumber(t[1].value[2])-1;for(let o=n;o<=r;o++){i.push(e.value.columnMap[Rnl.toNumber(t[1].value)-1])}}else;}else{n=0;r=t.length;if(e.value.rowMap&&e.value.rowMap[t[r-1].value]){o=t.map((e=>e.value));i=columnListFromRange(0,e.value.data.length-1)}else{i=t.map((t=>e.value.columnMap[t.value]))}}return[o,i,n,r]};const range$1=(e,t,n)=>{const[r,o,i,s]=identifyRange(e,t);let a=Object.create(null);if(r.dtype&&r.dtype===dt.ERROR){return r}if(r.length===0&&i===s&&o.length===1){let t=e.value.dtype[o[0]];if(t&dt.QUANTITY){t-=dt.QUANTITY}const r=o[0];let s=valueFromDatum(e.value.data[r][i]);a.expos=t&dt.RATIONAL?allZeros:null;if(n&&e.value.units[r]){const t=e.value.units[r]?e.value.units[r]:undefined;const n=unitFromUnitName(t);s=Rnl.multiply(Rnl.add(s,n.gauge),n.factor);a.expos=n.expos}return{value:s,unit:a,dtype:t}}else if(o.length===1){const t=o[0];const r=e.value.units[t]?e.value.units[t]:{};a=e.unit&&e.unit[r]?e.unit[r]:{expos:null};let l=e.value.data[t].slice(i,s+1).map((e=>valueFromDatum(e)));let c=e.value.dtype[t]+dt.COLUMNVECTOR;if(c&dt.QUANTITY){c-=dt.QUANTITY}if(c&dt.RATIONAL&&n&&a.gauge){l=l.map((e=>Rnl.multiply(Rnl.add(e,a.gauge),a.factor)))}return{value:l,name:e.value.headings[t],unit:a,dtype:c}}else{const t=[];const n=[];const a=[];const l=[];const c=Object.create(null);const d=Object.create(null);const u=r.length===0?false:Object.create(null);for(let p=0;p<o.length;p++){t.push(e.value.headings[o[p]]);const f=e.value.units[o[p]];n.push(f);if(f&&!d[f]){d[f]=e.unit[f]}a.push(e.value.dtype[o[p]]);c[e.value.headings[p]]=p;if(r.length>0){const t=[];for(let n=0;n<r.length;n++){const i=r[n];t.push(e.value.data[o[p]][e.value.rowMap[i]]);u[i]=n}l.push(t)}else{l.push(e.value.data[o[p]].slice(i,s+1))}}return{value:{data:l,headings:t,columnMap:c,rowMap:u,units:n,usedRows:new Set,dtype:a},unit:clone(d),dtype:dt.DATAFRAME}}};const numberRegEx$6=new RegExp("^(?:=|"+Rnl.numberPattern.slice(1)+"$)");const mixedFractionRegEx=/^-?(?:[0-9]+(?: [0-9]+\/[0-9]+))$/;const escRegEx=/^\\#/;const hasUnitRow=e=>{if(e.length<3){return false}const t=e[1].split("\t").map((e=>e.trim()));for(const e of t){if(numberRegEx$6.test(e)){return false}}const n=e[2].split("\t").map((e=>e.trim()));for(const e of n){if(numberRegEx$6.test(e)){return true}}return false};const dataFrameFromTSV=(e,t)=>{let n=[];const r=[];const o=Object.create(null);let i=false;const s=[];const a=[];const l=Object.create(null);const c=new Set;if(e.charAt(0)==="`"){e=e.slice(1)}if(t){const n=arrayOfRegExMatches(interpolateRegEx,e);for(let r=n.length-1;r>=0;r--){const o=n[r];const i=o.value.slice(2,-1);let s="";if(i==="undefined"){s=""}else if(i==="j"&&!t.j){s="j"}else{const e=t[i];if(!e){return errorOprnd("V_NAME",i)}const n=fromAssignment(e,false);if(n.dtype===dt.ERROR){return n}s=Rnl.isRational(n.value)?String(Rnl.toNumber(n.value)):n.value}e=e.slice(0,o.index)+s+e.slice(o.index+o.length)}}const d=e.split(/\r?\n/g);const u=hasUnitRow(d);const p=d[0].split("\t");if(p[0].length>0&&p[0].charAt(0)==="#"){i=Object.create(null);p[0]=p[0].slice(1)}else if(escRegEx.test(p[0])){p[0]=p[0].slice(1)}p.forEach(((e,t)=>{e=e.trim();r.push(e);o[e]=t;n.push([])}));if(u){const e=d[1].split("\t");e.forEach((e=>{e=e.trim();s.push(e);if(e.length>0&&!l[e]){const t=unitFromUnitName(e);if(t){l[e]=t}else{return errorOprnd("DF_UNIT",e)}}}))}let f=-1;for(let e=u?2:1;e<d.length;e++){const t=d[e];f+=1;t.split("\t").forEach(((e,t)=>{e=e.trim();if(e==="=sum(up)"){let r=Rnl.zero;for(const e of n[t]){if(!isNaN(e)){r=Rnl.add(r,Rnl.fromString(e))}}e=String(Rnl.toNumber(r))}n[t].push(e);if(i&&t===0){i[e]=f}}))}for(let e=0;e<n.length;e++){for(let t=0;t<n[0].length;t++){const r=n[e][t];if(r===""){continue}a.push(numberRegEx$6.test(r)?dt.RATIONAL+(s.length>0&&s[e].length>0?dt.QUANTITY:0):r==="true"||r==="false"?dt.BOOLEAN:dt.STRING);break}}let h=false;let m=0;if(Object.keys(l).length===0){h=true;m=i?1:0;for(let e=m+1;e<a.length;e++){if(a[e]!==a[m]){h=false;break}}}if(h){if(a[m]===dt.RATIONAL){n=n.map(((e,t)=>a[t]===dt.RATIONAL?e.map((e=>Rnl.fromString(e))):e))}return{value:{data:n,headings:r,columnMap:o,rowMap:i,usedRows:c},unit:a[0]===dt.RATIONAL?{expos:allZeros}:null,dtype:dt.MAP+a[m]}}else{return{value:{data:n,headings:r,columnMap:o,rowMap:i,units:s,usedRows:c,dtype:a},unit:l,dtype:dt.DATAFRAME}}};const dataFrameFromVectors=(e,t)=>{const n=[];const r=[];const o=Object.create(null);const i=[];const s=[];const a=Object.create(null);const l=e[0].name&&e[0].name==="name"?Object.create(null):false;for(let c=0;c<e.length;c++){const d=e[c];const u=d.dtype&dt.ROWVECTOR?dt.ROWVECTOR:d.dtype&dt.COLUMNVECTOR?dt.COLUMNVECTOR:dt.ERROR;if(u===dt.ERROR){return errorOprnd("NOT_VECTOR","dataframe")}r.push(d.name);o[d.name]=c;const p=d.dtype-u;n.push(d.value.map((e=>datumFromValue(e,p,t))));s.push(p);if(d.unit&&d.unit.name){i.push(d.unit.name);if(!a[d.unit.name]){const e=unitFromUnitName(d.unit.name);a[d.unit.name]=e}}else{i.push(null)}if(l){const t=e[0].value;for(let e=0;e<t.length;e++){l[t[e]]=e}}}return{value:{data:n,headings:r,columnMap:o,rowMap:l,units:i,usedRows:new Set,dtype:s},unit:a,dtype:dt.DATAFRAME}};const matrix2table=(e,t,n)=>{if(n.length>0){t=[""].concat(t)}const r=Object.create(null);for(let e=0;e<t.length;e++){r[t[e]]=e}let o=false;if(n.length>0){o=Object.create(null);for(let e=0;e<n.length;e++){o[n[e]]=e}}const i=new Array(t.length);let s=0;if(n.length>0){i[0]=n;s=1}for(let t=0;t<e.value[0].length;t++){const n=t+s;i[n]=[];for(let r=0;r<e.value.length;r++){i[n].push(e.value[r][t])}}return{value:{data:i,headings:t,columnMap:r,rowMap:o},unit:e.unit,dtype:e.dtype-dt.MATRIX+dt.MAP}};const append$1=(e,t,n,r)=>{const o=e.dtype===dt.DATAFRAME?clone(e):clone(t);const i=e.dtype===dt.DATAFRAME?t:e;if(e.dtype===dt.DATAFRAME){o.value.columnMap[i.name]=o.value.headings.length;o.value.headings.push(i.name)}else{for(const[e,t]of Object.entries(o.value.columnMap)){o.value.columnMap[e]=t+1}o.value.columnMap[i.name]=0;o.value.headings.unshift(i.name)}let s;if(i.unit&&i.unit.name&&i.unit.name.length>0){if(e.dtype===dt.DATAFRAME){o.value.units.push(i.unit.name)}else{o.value.units.unshift(i.unit.name)}s=unitFromUnitName(i.unit.name);if(!o.unit[i.unit.name]){o.unit[i.unit.name]=s}}const a=i.dype===dt.RATIONAL&&s?dt.RATIONAL+dt.QUANTITY:!isMatrix(i)?i.dtype:i.dtype&dt.COLUMNVECTOR?i.dtype-dt.COLUMNVECTOR:i.dtype-dt.ROWVECTOR;const l=o.value.data[0].length;if(l===1&&!isMatrix(i)){const t=r&&a===dt.RATIONAL&&s?Rnl.subtract(Rnl.divide(i.value,s.factor),s.gauge):i.value;if(e.dtype===dt.DATAFRAME){o.value.data.push([datumFromValue(t,a,n)])}else{o.value.data.unshift([datumFromValue(t,a,n)])}}else{if(r&&a===dt.RATIONAL&&s){const t=Matrix.convertFromBaseUnits(i,s.gauge,s.factor);if(e.dtype===dt.DATAFRAME){o.value.data.push(t.map((e=>datumFromValue(e,a,n))))}else{o.value.data.unshift(t.map((e=>datumFromValue(e,a,n))))}}else{if(e.dtype===dt.DATAFRAME){o.value.data.push(i.value.map((e=>datumFromValue(e,a,n))))}else{o.value.data.unshift(i.value.map((e=>datumFromValue(e,a,n))))}}}if(e.dtype===dt.DATAFRAME){o.value.dtype.push(a)}else{o.value.dtype.unshift(a)}return o};const quickDisplay=e=>{if(e===""){return""}e=e.trim();let t="";if(e.charAt(0)==="#"){e=e.slice(1).trim();t="l|cccccccccccccccccccccccc"}else{t="c"}e=addTextEscapes(e);const n=/ *\t */g;const r=e.split(/\r?\n/g);let o="";if(r.length<3){o="\\begin{matrix}\\text{";for(let e=0;e<r.length;e++){o+=tablessTrim(r[e]).replace(n,"} & \\text{")+"} \\\\ \\text{"}o=o.slice(0,-10)+"\\end{matrix}"}else{o=`\\begin{array}{${t}}\\text{`;const e=new Array(r.length);for(let t=0;t<r.length;t++){e[t]=tablessTrim(r[t]).split(n)}let i=false;let s=false;for(let t=0;t<e[1].length;t++){if(numberRegEx$6.test(e[1][t])){s=true;break}}if(!s){for(let t=0;t<e[2].length;t++){if(numberRegEx$6.test(e[2][t])){i=true;break}}}for(let e=0;e<r.length;e++){o+=tablessTrim(r[e]).replace(n,"} & \\text{");o+=i&&e===1||!i&&e===0?"} \\\\ \\hline \\text{":"} \\\\ \\text{"}o=o.slice(0,-10)+"\\end{array}"}o=o.replace(//g,"$$");return o};const accentRegEx$1=/^([^\u0300-\u0308\u030A\u030C\u0332\u20d0\u20d1\u20d6\u20d7\u20e1]+)([\u0300-\u0308\u030A\u030C\u0332\u20d0\u20d1\u20d6\u20d7\u20e1])(.+)?/;const subscriptRegEx=/([^_]+)(_[^']+)?(.*)?/;const accentFromChar$1=Object.freeze({"":"\\grave","":"\\acute","":"\\hat","":"\\tilde","":"\\bar","":"\\bar","":"\\dot","":"\\ddot","":"\\mathring","":"\\check","":"\\underline","":"\\overleftharpoon","":"\\overrightharpoon","":"\\overleftarrow","":"\\vec","":"\\overleftrightarrow"});const formatColumnName=e=>{if(!isValidIdentifier$1.test(e)){return"\\text{"+addTextEscapes(e)+"}"}else{e=e.replace(//g,"'");let t=e.match(accentRegEx$1);if(t){e=accentFromChar$1[t[2]]+"{"+t[1]+"}";return e+(t[3]?t[3]:"")}else{t=e.match(subscriptRegEx);let n=t[1].length>1?`\\text{${t[1]}}`:t[1];if(t[2]){n+="_"+`\\text{${t[2].slice(1)}}`}return n+(t[3]?t[3]:"")}}};const isNotEmpty=e=>{if(!e){return false}for(let t=0;t<e.length;t++){if(e[t]!==""&&e[t]!==null){return true}}return false};const getNumInfo=e=>{const t=e.data.plain?e.data.plain:e.data;const n=t.length;const r=new Array(n);const o=new Array(n);const i=!e.dtype&&Rnl.isRational(t[0][0]);for(let s=0;s<n;s++){if(i||e.dtype&&e.dtype[s]&dt.RATIONAL){r[s]={hasAlignChar:false,maxLenAfterAlignChar:0};o[s]=[];for(let e=0;e<t[0].length;e++){const n=t[s][e];const i=n.indexOf(".");const a=i>-1;const l=a?n.length-i-1:0;o[s].push({hasAlignChar:a,lenAfterAlignChar:l});if(a){r[s].hasAlignChar=true;if(l>r[s].maxLenAfterAlignChar){r[s].maxLenAfterAlignChar=l}}}}}return[r,o]};const displayNum=(e,t,n,r)=>{let o=formattedDecimal(e,r);const i=t.maxLenAfterAlignChar-n.lenAfterAlignChar;if(t.hasAlignChar&&(i>0||!n.hasAlignChar)){o+="\\phantom{";if(t.hasAlignChar&&!n.hasAlignChar){o+=r.slice(-1)==="."?".":"{,}"}if(i>0){o+="0".repeat(i)}o+="}"}return o};const totalRegEx=/^(?:total|sum)/i;const display$1=(e,t="h3",n="1,000,000.",r=false)=>{const o=e.data.plain?e.data.plain:e.data;if(o.length===0){return""}const i=o[0].length;const s=o.length;const a=i>5&&!e.rowMap;const l=!e.dtype;let c="\\renewcommand{\\arraycolsep}{8pt}\\renewcommand{\\arraystretch}{1.15}";c+="\\begin{array}{";c+=e.rowMap?"l|":a?"r|":"";for(let t=0;t<s;t++){c+=l?"c ":i===1?"c ":e.dtype[t]&dt.RATIONAL?"r ":"l "}c=c.slice(0,-1)+"}";if(!r){if(a){c+="&"}for(let t=0;t<s;t++){c+="{"+formatColumnName(e.headings[t])+"}&"}c=c.slice(0,-1)+" \\\\ "}if(isNotEmpty(e.units)){if(a){c+="&"}for(let t=0;t<s;t++){let n="";if(e.units[t]&&e.units[t].length>0){const r=unitTeXFromString(e.units[t]);n=r.replace("\\;\\, ","")}else{n=""}c+=n+"&"}c=c.slice(0,-1)+" \\\\ "}c+="\\hline ";const[d,u]=getNumInfo(e);for(let e=0;e<i;e++){if(e===i-1&&totalRegEx.test(o[0][e])){c+="\\hline "}if(a){c+=String(e+1)+" & "}for(let r=0;r<s;r++){const i=o[r][e];if(l){c+=i===undefined?" & ":Rnl.isRational(i)?format(i,t,n)+"&":Cpx.isComplex(i)?Cpx.display(i,t,n)[0]+"&":"\\text{"+addTextEscapes(i)+"} &"}else{c+=mixedFractionRegEx.test(i)?format(Rnl.fromString(i),t,n)+"&":numberRegEx$6.test(i)?displayNum(i,d[r],u[r][e],n)+"&":i===""?"&":"\\text{"+addTextEscapes(i)+"}&"}}c=c.slice(0,-1)+" \\\\ "}c=c.slice(0,-3).trim();c+="\\end{array}";return c};const displayAlt$1=(e,t="h3",n="1,000,000.",r=false)=>{const o=e.data.plain?e.data.plain:e.data;if(o.length===0){return""}const i=o[0].length;const s=o.length;const a=i>5&&!e.rowMap;let l="``";if(!r){if(a){l+="\t"}l+=(e.headings[0]==="name"||e.headings[0]==="item"?"":e.headings[0])+"\t";for(let t=1;t<s;t++){l+=e.headings[t]+"\t"}l=l.slice(0,-1)+"\n"}if(isNotEmpty(e.units)){if(a){l+="\t"}for(let t=0;t<s;t++){l+=e.units[t]+"\t"}l=l.slice(0,-1)+"\n"}const c=!e.dtype;for(let e=0;e<i;e++){if(a){l+=String(e+1)+"\t"}for(let r=0;r<s;r++){const i=o[r][e];if(c){l+=i===undefined?"\t":Rnl.isRational(i)?format(i,t,n).replace(/{,}/g,",")+"\t":Cpx.isComplex(i)?Cpx.display(i,t,n)[1].replace(/{,}/g,",")+"\t":i+"\t"}else{if(mixedFractionRegEx.test(i)){l+=format(Rnl.fromString(i),t,"100000.")+"\t"}else{l+=i+"\t"}}}l=l.slice(0,-1)+"\n"}l=l.slice(0,-1).trim();l+="``";return l};const DataFrame=Object.freeze({append:append$1,dataFrameFromTSV:dataFrameFromTSV,dataFrameFromVectors:dataFrameFromVectors,matrix2table:matrix2table,display:display$1,displayAlt:displayAlt$1,quickDisplay:quickDisplay,range:range$1});const dateFormatRegEx=/^(?:(w{3,4}), )?(y{1,4}|m{3,4}|d{1,2})([- .]| de )(m{2,4}|d{1,2})([- .]|, | de )(y{4}|d{2})(?: ([a-z]{2,3}))?$/;const dateRegEx$1=/^'(\d{4})-(\d{1,2})-(\d{1,2})'$/;const dateInSecondsFromIsoString=e=>{const t=e.match(dateRegEx$1);const n=(new Date).getTimezoneOffset()/60;const r=new Date(t[1],t[2]-1,t[3],-n);return Math.floor(r.getTime()/1e3)};const dateInSecondsFromToday=e=>{const t=new Date;const n=t.getFullYear();const r=String(t.getMonth()+1).padStart(2,"0");const o=String(t.getDate()).padStart(2,"0");const i=`'${n}-${r}-${o}'`;return dateInSecondsFromIsoString(i)};const dateRPN=e=>""+String(dateInSecondsFromIsoString(e));const dateDisplayFromIsoString=(e,t,n=false)=>{const r=[BigInt(dateInSecondsFromIsoString(e)),BigInt(1)];return formatDate(r,t,n)};const processDMY=(e,t,n,r)=>e==="d"?String(t.getUTCDate()):e==="dd"?String(t.getUTCDate()).padStart(2,"0"):e==="mm"?String(t.getUTCMonth()+1).padStart(2,"0"):e==="mmm"||r&&e==="mmmm"?new Intl.DateTimeFormat(n,{month:"short",timeZone:"GMT"}).format(t):e==="mmmm"?new Intl.DateTimeFormat(n,{month:"long",timeZone:"GMT"}).format(t):String(t.getUTCFullYear());const formatDate=(e,t,n=false)=>{const r=new Date(Rnl.toNumber(e)*1e3);const o=n?"":"\\class{date-result}{";if(!t||t==="yyyy-mm-dd"||n&&t.indexOf("de")>-1){let e=`${o}\\text{${r.toISOString().split("T")[0]}}`;if(!n){e+="}"}return e}const i=dateFormatRegEx.exec(t);const s=i[7]?i[7]:"en";let a="";if(i[1]&&!n){const e=i[1].length==="3"?"short":"long";a+=new Intl.DateTimeFormat(s,{weekday:e,timeZone:"GMT"}).format(r);a+=", "}a+=processDMY(i[2],r,s,n);a+=i[3];a+=processDMY(i[4],r,s,n);a+=i[5];a+=processDMY(i[6],r,s,n);let l=`${o}\\text{${a}}`;if(!n){l+="}"}return l};const tt=Object.freeze({UNARY:0,BINARY:1,SUB:2,SUP:3,ACCENT:4,UNARYMINUS:5,DIV:6,PRIME:7,CURRENCY:8,ORD:9,VAR:10,NUM:11,SPACE:12,LONGVAR:13,LEFTBRACKET:14,RIGHTBRACKET:15,BIG_OPERATOR:16,LEFTRIGHT:17,STRING:18,UNIT:19,BIN:20,ADD:21,MULT:22,REL:23,LOGIC:24,SEP:25,FUNCTION:26,ACCESSOR:28,ENVIRONMENT:29,FACTORIAL:30,SUPCHAR:31,ANGLE:32,RANGE:33,KEYWORD:34,PROPERTY:36,COMMENT:37,RETURN:38,TO:39,DATAFRAME:40,RICHTEXT:41,BOOLEAN:42,MACRO:43,DATE:44});const minusRegEx=/^-(?![-=<>:])/;const numberRegEx$5=new RegExp(Rnl.numberPattern);const unitRegEx=/^(?:'[^']+'|[])/;const dateRegEx=/^'\d{4}-\d{1,2}-\d{1,2}'/;const texFromNumStr=(e,t)=>{let n="";if(e[2]){n="\\mathrm{"+e[2]+"}"}else if(e[5]){return texFromMixedFraction(e)}else{n=e[3];if(e[6]){n+="."+e[6]}n=formattedDecimal(n,t);if(e[8]){n+="\\%"}else if(e[7]){if(e[7].charAt(0)==="-"){n+="\\text{e-}"+e[7].slice(1)}else{n+="\\text{e}"+e[7]}}}if(e[1]){n="\\text{-}"+n}return n};const isUnary=e=>{switch(e.ttype){case tt.NUM:case tt.ORD:case tt.VAR:case tt.DATE:case tt.RIGHTBRACKET:case tt.LONGVAR:case tt.UNIT:case tt.CURRENCY:case tt.SUPCHAR:case tt.PRIME:case tt.FACTORIAL:return false;default:return true}};const wordRegEx=/^(?:(?:[A-Za-z\u0391-\u03C9\u03D5\u212C\u2130\u2131\u210B\u2110\u2112\u2133\u211B\u212F\u210A\u2113\u2134]|(?:\uD835[\uDC00-\udc33\udc9c-\udccf\udd38-\udd50]))[A-Za-z0-9_\u0391-\u03C9\u03D5\u0300-\u0308\u030A\u030C\u0332\u20d0\u20d1\u20d6\u20d7\u20e1]*|!in|-->|->|left\.|right\.|log10|log2)/;const words=Object.freeze({true:["true","\\mathord{\\text{true}}","true",tt.BOOLEAN,""],false:["false","\\mathord{\\text{false}}","false",tt.BOOLEAN,""],cos:["cos","\\cos","cos",tt.FUNCTION,""],cosd:["cosd","\\operatorname{\\cos_d}","cosd",tt.FUNCTION,""],if:["if","\\mathrel{\\mathrm{if}}","if",tt.LOGIC,""],else:["else","\\mathrel{\\mathrm{else}}","else",tt.LOGIC,""],elseif:["elseif","\\mathrel{\\mathrm{elseif}}","elseif",tt.LOGIC,""],and:["and","\\mathrel{\\mathrm{and}}","and",tt.LOGIC,""],or:["or","\\mathrel{\\mathrm{or}}","or",tt.LOGIC,""],for:["for","\\mathrel{\\mathrm{for}}","for",tt.KEYWORD,""],while:["while","\\mathrel{\\mathrm{while}}","while",tt.KEYWORD,""],in:["in","\\mathrel{\\mathrm{in}}","in",tt.REL,""],"!in":["!in","\\mathrel{\\mathrm{!in}}","",tt.REL,""],break:["break","\\mathrel{\\mathrm{break}}","break",tt.KEYWORD,""],to:["to","\\mathbin{\\mathrm{to}}","to",tt.TO,""],throw:["throw","\\mathrel{\\mathrm{throw}}","throw",tt.UNARY,""],print:["print","\\mathrel{\\mathrm{print}}","print",tt.UNARY,""],return:["return","\\mathrel{\\mathrm{return}}","print",tt.RETURN,""],sqrt:["sqrt","\\sqrt","",tt.UNARY,""],otherwise:["otherwise","\\mathrel{\\mathrm{otherwise}}","otherwise",tt.LOGIC,""],root:["root","\\sqrt","root",tt.BINARY,""],modulo:["modulo","\\mathbin{modulo}","modulo",tt.MULT],sin:["sin","\\sin","sin",tt.FUNCTION,""],sind:["sind","\\operatorname{\\sin_d}","sind",tt.FUNCTION,""],tan:["tan","\\tan","tan",tt.FUNCTION,""],tand:["tand","\\operatorname{\\tan_d}","tand",tt.FUNCTION,""],cotd:["cotd","\\operatorname{\\cot_d}","cotd",tt.FUNCTION,""],secd:["secd","\\operatorname{\\sec_d}","secd",tt.FUNCTION,""],cscd:["cscd","\\operatorname{\\csc_d}","cscd",tt.FUNCTION,""],log:["log","\\log","log",tt.FUNCTION,""],ln:["ln","\\ln","ln",tt.FUNCTION,""],log10:["log10","\\log_{10}","log10",tt.FUNCTION,""],log2:["log2","\\log_{2}","log2",tt.FUNCTION,""],"log!":["log!","\\operatorname{log!}","log!",tt.FUNCTION,""],pi:["pi","\\mathrm{pi}","",tt.ORD,""],"":["","","",tt.ORD,""],"":["","","",tt.VAR,""],"->":["->","","",tt.REL,""],"--\x3e":["--\x3e","\\xrightarrow","--\x3e",tt.UNARY,""],"<--\x3e":["<--\x3e","\\xrightleftarrows","<--\x3e",tt.UNARY,""]});const miscRegEx=/^([/\u2215_:,;\t^+\\\-*.%|><=!~#?&@([{}\])\u00A0\u20D7$]+)/;const miscSymbols=Object.freeze({"#":["#","#","#",tt.COMMENT,""],"/":["/","\\dfrac{","///",tt.DIV,""],"//":["//","\\tfrac{","//",tt.DIV,""],"///":["///","/","",tt.MULT,""],"":["","","",tt.MULT,""],"":["","","",tt.MULT,""],"./":["./","\\mathbin{.'}","./",tt.MULT,""],_:["_","_","_",tt.SUB,""],"^":["^","^","^",tt.SUP,""],".^":[".^","\\mathbin{.^}",".^",tt.SUP,""],"+":["+","+","+",tt.ADD,""],"-":["-","-","-",tt.ADD,""],"":["-","-","-",tt.ADD,""],"":["-","-","-",tt.ADD,""],".+":[".+","\\mathbin{.+}",".+",tt.ADD,""],".-":[".-","\\mathbin{.-}",".-",tt.ADD,""],"*":["*","*","*",tt.MULT,""],"":["","","",tt.MULT,""],"":["","","",tt.MULT,""],"":["","","",tt.MULT,""],"":["","","",tt.MULT,""],".*":[".*","\\mathbin{.*}",".*",tt.MULT,""],"":["","\\sqrt","",tt.UNARY,""],"":["","\\sqrt[3]","",tt.UNARY,""],"":["","\\sqrt[4]","",tt.UNARY,""],"+-":["+-","","",tt.BIN,""],"**":["**","\\star","**",tt.BIN,""],"":["","","",tt.MULT,""],"...":["...","\\dots","...",tt.RANGE,""],"\\dots":["\\dots","\\dots","...",tt.RANGE,""],"%":["%","\\%","%",tt.FACTORIAL,""],"-:":["-:","","",tt.MULT,""],"=":["=","=","=",tt.REL,""],"":["","","",tt.REL,""],"==":["==","","==",tt.REL,""],"":["","","",tt.REL,""],">":[">","\\gt",">",tt.REL,""],"":["","\\ngtr","",tt.REL,""],"<":["<","\\lt","<",tt.REL,""],"":["","\\nless","",tt.REL,""],"?=":["?=","","",tt.REL,""],"":["","","",tt.REL,""],"":["","","",tt.REL,""],"!=":["!=","","",tt.REL,""],"<>":["<>","","",tt.REL,""],":=":[":=","","",tt.REL,""],"<=":["<=","","",tt.REL,""],"":["","","",tt.REL,""],">=":[">=","","",tt.REL,""],"":["","","",tt.REL,""],"-=":["-=","","",tt.REL,""],"~=":["~=","","",tt.REL,""],"":["","","",tt.REL,""],"~~":["~~","","",tt.REL,""],"~":["~","\\sim","",tt.REL,""],"=>":["=>","","",tt.REL,""],"":["","",tt.REL,""],"":["","\\xrightarrow","",tt.UNARY,""],"":["","\\xleftarrow","",tt.UNARY,""],"<=>":["<=>","","",tt.REL,""],"-<":["-<","","",tt.REL,""],">-":[">-","","",tt.REL,""],"-<=":["-<=","","",tt.REL,""],">-=":[">-=","","",tt.REL,""],"_|_":["_|_","\\bot","_|_",tt.REL,""],"|--":["|--","","",tt.REL,""],"|==":["|==","\\models","",tt.REL,""],"":["","","",tt.REL,""],"":["","","",tt.REL,""],"":["","","",tt.REL,""],"":["","","",tt.REL,""],"":["","","",tt.REL,""],"":["","","",tt.REL,""],"":["","","",tt.REL,""],"":["","","",tt.REL,""],"":["","","",tt.REL,""],"":["","","",tt.REL,""],"":["","","",tt.REL,""],"":["","","",tt.REL,""],"":["","\\mathrel{}","",tt.REL,""],"!":["!","!","!",tt.FACTORIAL,""],"":["","!!","",tt.FACTORIAL,""],"!!":["!!","!!","",tt.FACTORIAL,""],"":["","","",tt.FACTORIAL,""],"&":["&","\\mathbin{\\&}","&",tt.ADD,""],"&_":["&_","\\mathbin{\\underline{\\&}}","&_",tt.ADD,""],"":["","'","",tt.PRIME,""],"":["","''","",tt.PRIME,""],"":["","''","",tt.PRIME,""],"":["","'''","",tt.PRIME,""],"":["","","",tt.LOGIC,""],"":["","","",tt.LOGIC,""],"":["","","",tt.LOGIC,""],"":["","","",tt.LOGIC,""],"":["","","",tt.LOGIC,""],"":["","","",tt.UNARY,""],"&&":["&&","{\\;\\&\\&\\;}","&&",tt.LOGIC,""],"":["","\\displaystyle","",tt.BIG_OPERATOR,""],"":["","\\displaystyle","",tt.BIG_OPERATOR,""],"":["","\\displaystyle","",tt.BIG_OPERATOR,""],"":["","\\displaystyle","",tt.BIG_OPERATOR,""],"(":["(","(","(",tt.LEFTBRACKET,")"],"[":["[","[","[",tt.LEFTBRACKET,"]"],"{":["{","\\{","{",tt.LEFTBRACKET,"\\}"],"{:":["{:","{","{:",tt.LEFTBRACKET,"}"],"":["","","",tt.LEFTBRACKET,""],")":[")",")",")",tt.RIGHTBRACKET,""],"]":["]","]","]",tt.RIGHTBRACKET,""],"}":["}","\\}","}",tt.RIGHTBRACKET,""],"":["","","",tt.RIGHTBRACKET,""],":}":[":}","}",":}",tt.RIGHTBRACKET,""],"|":["|","|","|",tt.LEFTRIGHT,""],"||":["||","\\mathbin{||}","||",tt.BIN,""],"\\|":["\\|","","",tt.LEFTRIGHT,""],"":["","","",tt.LEFTRIGHT,""],"<<":["<<","","",tt.LEFTBRACKET,""],">>":[">>","","",tt.RIGHTBRACKET,""],"":["","\\lfloor ","",tt.LEFTBRACKET,""],"":["","\\lfloor ","",tt.LEFTBRACKET,""],"":["","\\rfloor ","",tt.RIGHTBRACKET,""],"":["","\\rfloor ","",tt.RIGHTBRACKET,""],"":["","\\lceil ","",tt.LEFTBRACKET,""],"":["","\\lceil ","",tt.LEFTBRACKET,""],"":["","\\rceil ","",tt.RIGHTBRACKET,""],"":["","\\rceil ","",tt.RIGHTBRACKET,""],"":["","{","",tt.LEFTBRACKET,""],"":["","}","",tt.RIGHTBRACKET,""],"":["","\\mid ","",tt.REL,""],"":["","","",tt.ORD,""],"":["","","",tt.ORD,""],"":["","","",tt.ORD,""],"":["","","",tt.ORD,""],"":["","","",tt.ORD,""],"":["","","",tt.ORD,""],"":["","","",tt.REL,""],"":["","","",tt.REL,""],">->":[">->","","",tt.REL,""],"->>":["->>","","",tt.REL,""],"|->":["|->","","",tt.REL,""],"<--":["<--","\\xleftarrow","",tt.UNARY,""],"==>":["==>","\\xRightarrow","==>",tt.UNARY,""],"<==":["<==","\\xLeftarrow","<==",tt.UNARY,""],"<--\x3e":["<--\x3e","\\xleftrightarrow","<--\x3e",tt.UNARY,""],"<==>":["<==>","\\xLeftrightarrow","<==>",tt.UNARY,""],"":["","","",tt.ANGLE,""],"":["","","",tt.ORD,""],"":["","~","",tt.SPACE,""],"\\;":["\\;",";\\:","\\;",tt.SEP,""],"":["","","",tt.ORD,""],":":[":","{:}",":",tt.RANGE,""],",":[",",",\\:",",",tt.SEP,""],"\t":["\t"," & ","\t",tt.SEP,""],";":[";"," \\\\ ",";",tt.SEP,""],"\\\\":["\\\\"," \\\\ ",";",tt.SEP,""],$:["$","\\$","$",tt.CURRENCY,""],"":["","","",tt.CURRENCY,""],"":["","","",tt.CURRENCY,""],"":["","","",tt.CURRENCY,""],"":["","","",tt.CURRENCY,""],"":["","","",tt.CURRENCY,""],"":["","","",tt.CURRENCY,""]});const texFunctionRegEx=/^(\\[A-Za-z]+\.?|\\([:.!\u0020]|'+))/;const texFunctions=Object.freeze({"\\aleph":["\\aleph","","",tt.VAR,""],"\\beth":["\\beth","","",tt.VAR,""],"\\gimel":["\\gimel","","",tt.VAR,""],"\\daleth":["\\daleth","","",tt.VAR,""],"\\ast":["\\ast","","",tt.MULT,""],"\\div":["\\div","","",tt.MULT,""],"\\times":["\\times","","",tt.MULT,""],"\\bmod":["\\bmod","\\bmod","modulo",tt.MULT],"\\circ":["\\circ","","",tt.MULT,""],"\\nabla":["\\nabla","","",tt.ORD,""],"\\otimes":["\\otimes","","",tt.MULT,""],"\\ne":["\\ne","","",tt.REL,""],"\\cdot":["\\cdot","","",tt.MULT,""],"\\le":["\\le","","",tt.REL,""],"\\leq":["\\leq","","",tt.REL,""],"\\ge":["\\ge","","",tt.REL,""],"\\geq":["\\geq","","",tt.REL,""],"\\equiv":["\\equiv","","",tt.REL,""],"\\cong":["\\cong","","",tt.REL,""],"\\approx":["\\approx","","",tt.REL,""],"\\Rightarrow":["\\Rightarrow","","",tt.REL,""],"\\forall":["\\forall","","",tt.LOGIC,""],"\\exists":["\\exists","","",tt.LOGIC,""],"\\infty":["\\infty","","",tt.ORD,""],"\\sqrt":["\\sqrt","\\sqrt","",tt.UNARY,""],"\\atop":["\\atop","\\atop{","\\atop",tt.DIV,""],"\\cdots":["\\cdots","","",tt.BIN,""],"\\vdots":["\\vdots","","",tt.BIN,""],"\\ddots":["\\ddots","","",tt.BIN,""],"\\iff":["\\iff","\\iff","\\iff",tt.LOGIC,""],"\\land":["\\land","\\land","\\land",tt.BIN,""],"\\lor":["\\lor","\\lor","\\lor",tt.BIN,""],"\\ngtr":["\\ngtr","\\ngtr","",tt.REL,""],"\\nless":["\\nless","\\nless","",tt.REL,""],"\\nleq":["\\nleq","\\nleq","",tt.REL,""],"\\ngeq":["\\ngeq","\\ngeq","",tt.REL,""],"\\in":["\\in","","",tt.REL,""],"\\notin":["\\notin","","",tt.REL,""],"\\subset":["\\subset","","",tt.REL,""],"\\subseteq":["\\subseteq","","",tt.REL,""],"\\nsubset":["\\nsubset","","",tt.REL,""],"\\nsubseteq":["\\nsubseteq","","",tt.REL,""],"\\supset":["\\supset","","",tt.REL,""],"\\left.":["\\left.","\\left.","{:",tt.LEFTBRACKET,"\\right."],"\\right.":["\\right.","\\right.",":}",tt.RIGHTBRACKET,""],"\\mod":["\\mod","\\mod","\\mod",tt.BIN,""],"\\lim":["\\lim","\\lim","\\lim",tt.ORD,""],"\\diamond":["\\diamond","\\diamond","\\diamond",tt.ORD,""],"\\square":["\\square","\\square","\\square",tt.ORD,""],"\\int":["\\int","\\displaystyle\\int","",tt.BIG_OPERATOR,""],"\\iint":["\\iint","\\displaystyle\\iint","",tt.BIG_OPERATOR,""],"\\iiint":["\\iiint","\\displaystyle\\iiint","\\iiint",tt.BIG_OPERATOR,""],"\\oint":["\\oint","\\displaystyle\\oint","",tt.BIG_OPERATOR,""],"\\oiint":["\\oiint","\\displaystyle\\oiint","\\oiint",tt.BIG_OPERATOR,""],"\\oiiint":["\\oiiint","\\displaystyle\\oiiint","\\oiiint",tt.BIG_OPERATOR,""],"\\over":["\\over","\\dfrac{","\\over",tt.DIV],"\\sum":["\\sum","\\displaystyle\\sum","",tt.BIG_OPERATOR,""],"\\prod":["\\prod","\\displaystyle\\prod","\\prod",tt.BIG_OPERATOR,""],"\\quad":["\\quad","\\quad","\\quad",tt.SPACE,""],"\\qquad":["\\qquad","\\qquad","\\qquad",tt.SPACE,""]});const accents$1=new Set(["Bbb","Overrightarrow","acute","bar","bm","bold","boldsymbol","breve","check","ddot","dot","frak","grave","hat","mathbb","mathbf","mathcal","mathfrak","mathit","mathnormal","mathring","mathrm","mathscr","mathsf","mathtt","overbrace","overgroup","overleftarrow","overleftharpoon","overleftrightarrow","overline","overrightarrow","overrightharpoon","tilde","underbrace","undergroup","underleftarrow","underleftrightarrow","underline","underrightarrow","utilde","vec","widecheck","widehat","widetilde"]);const mathOperators=new Set(["arccos","arcsin","arctan","arctg","arcctg","cos","cosec","cosh","cot","cotg","coth","csc","ctg","cth","det","dim","exp","gcd","lg","ln","log","max","min","sec","sin","sinh","sh","sqrt","sup","tan","tanh","tg","th"]);const colors=new Set(["blue","firebrick","gray","green","orange","pink","purple","red"]);const unaries=new Set(["bcancel","boxed","cancel","clap","color","llap","longdiv","mathclap","not","operatorname","phantom","phase","pu","rlap","sout","tag","text","textbf","textcircled","textit","textmd","textnormal","textrm","textsc","textsf","texttt","textup","xLeftarrow","xLeftrightarrow","xRightarrow","xcancel","xleftarrow","xleftrightarrow","xleftharpoondown","xleftharpoons","xleftharpoonup","xlongequal","xmapsto","xrightarrow","xrightharpoondown","xrightharpoonup","xrightleftarrows","xrightleftharpoons","xtofrom","xtwoheadleftarrow","xtwoheadrightarrow"]);const greek={alpha:"",beta:"",chi:"",delta:"",Delta:"",epsilon:"",varepsilon:"",eta:"",gamma:"",Gamma:"",iota:"",kappa:"",lambda:"",Lambda:"",mu:"",nu:"",omega:"",Omega:"",phi:"",varphi:"",Phi:"",pi:"",Pi:"",psi:"",Psi:"",rho:"",sigma:"",Sigma:"",tau:"",theta:"",vartheta:"",Theta:"",upsilon:"",xi:"",Xi:"",zeta:""};const binaries=new Set(["dfrac","frac","lower","overset","raisebox","stackrel","tag","tfrac","underset"]);const texREL=new Set(["Bumpeq","Colonapprox","Coloneq","Coloneqq","Colonsim","Darr","Doteq","Downarrow","Eqcolon","Eqqcolon","Harr","Larr","Leftarrow","Leftrightarrow","Lleftarrow","Longleftarrow","Longleftrightarrow","Longrightarrow","Lrarr","Lsh","Rarr","Rrightarrow","Rsh","Supset","Subset","Uarr","Uparrow","Updownarrow","Vdash","Vvdash","approxeq","asymp","backepsilon","backsim","backsimeq","between","bowtie","bumpeq","circeq","circlearrowleft","circlearrowright","colonapprox","coloneq","coloneqq","colonsim","curlyeqprec","curlyeqsucc","curvearrowleft","curvearrowright","dArr","darr","dashleftarrow","dashrightarrow","dashv","dblcolon","doteq","doteqdot","downarrow","downdownarrows","downharpoonleft","downharpoonright","eqcirc","eqcolon","eqqcolon","eqsim","eqslantgtr","eqslantless","fallingdotseq","frown","geqq","geqslant","gets","gg","ggg","gggtr","gnapprox","gneq","gneqq","gnsim","gt","gtrapprox","gtreqless","gtreqqless","gtrless","gtrsim","gvertneqq","hArr","harr","hookleftarrow","hookrightarrow","impliedby","implies","isin","Join","gets","impliedby","implies","lArr","larr","leadsto","leftarrow","leftarrowtail","leftharpoondown","leftharpoonup","leftleftarrows","leftrightarrow","leftrightarrows","leftrightharpoons","leftrightsquigarrow","leqq","leqslant","lessapprox","lesseqgtr","lesseqqgtr","lessgtr","lesssim","ll","lll","llless","lnapprox","lneq","lneqq","lnsim","longleftarrow","longleftrightarrow","longmapsto","longrightarrow","looparrowleft","looparrowright","lrArr","lrarr","lt","lvertneqq","mapsto","mid","models","multimap","nLeftarrow","nLeftrightarrow","nRightarrow","nVDash","nVdash","ncong","nearrow","neq","nexists","ngeq","ngeqq","ngeqslant","ngtr","ni","nleftarrow","nleftrightarrow","nleq","nleqq","nleqslant","nless","nmid","notni","nparallel","nprec","npreceq","nrightarrow","nshortmid","nshortparallel","nsim","nsubseteq","nsubseteqq","nsucc","nsucceq","nsupseteq","nsupseteqq","ntriangleleft","ntrianglelefteq","ntriangleright","ntrianglerighteq","nvDash","nvdash","nwarrow","owns","parallel","perp","pitchfork","prec","precapprox","preccurlyeq","preceq","precnapprox","precneqq","precnsim","precsim","propto","rArr","rarr","restriction","rightarrow","rightarrowtail","rightharpoondown","rightharpoonup","rightleftarrows","rightleftharpoons","rightrightarrows","rightsquigarrow","risingdotseq","searrow","shortmid","shortparallel","sim","simeq","smallfrown","smallsmile","smile","sqsubset","sqsubseteq","sqsupset","sqsupseteq","sub","sube","subseteqq","subsetneq","subsetneqq","succ","succapprox","succcurlyeq","succeq","succnapprox","succneqq","succnsim","succsim","supe","supset","supseteq","supseteqq","supsetneq","supsetneqq","swarrow","thickapprox","thicksim","to","trianglelefteq","triangleq","trianglerighteq","twoheadleftarrow","twoheadrightarrow","uArr","uarr","uparrow","updownarrow","upharpoonleft","upharpoonright","upuparrows","varpropto","varsubsetneq","varsubsetneqq","varsupsetneq","varsupsetneqq","vartriangle","vartriangleleft","vartriangleright","vcentcolon","vdash","vDash"]);const superRegEx=/^?[]+/;const cloneToken$1=e=>[e[0],e[1],e[2],e[3],e[4]];const accentFromChar=Object.freeze({"":"\\grave","":"\\acute","":"\\hat","":"\\tilde","":"\\bar","":"\\bar","":"\\dot","":"\\ddot","":"\\mathring","":"\\check","":"\\underline","":"\\overleftharpoon","":"\\overrightharpoon","":"\\overleftarrow","":"\\vec","":"\\overleftrightarrow"});const wideAccentFromChar=Object.freeze({"":"\\grave","":"\\acute","":"\\widehat","":"\\widetilde","":"\\overline","":"\\overline","":"\\dot","":"\\ddot","":"\\mathring","":"\\check","":"\\underline","":"\\overleftharpoon","":"\\overrightharpoon","":"\\overleftarrow","":"\\overrightarrow","":"\\overleftrightarrow"});const groupSubscript=e=>{const t=e.indexOf("_");return t===-1?e:e.slice(0,t+1)+"{"+e.slice(t+1)+"}"};const checkForTrailingAccent=e=>{const t=e.slice(-1);if(/[\u0300-\u0308\u030A\u030C\u0332\u20d0\u20d1\u20d6\u20d7\u20e1]/.test(t)){e=e.slice(0,-1);return e==="i"?accentFromChar[t]+"{}":e==="j"?accentFromChar[t]+"{}":e.length===1?accentFromChar[t]+"{"+e+"}":wideAccentFromChar[t]+"{"+e+"}"}else{return e}};const lexOneWord=(e,t)=>{const n=wordRegEx.exec(e);if(n){let r=n[0].replace(/_*$/,"");const o=e.charAt(r.length);const i=words[r];if(i&&o!==""){return i}else if(/^\(/.test(o)){return t.ttype===tt.ACCENT?[r,r+"}{",r+"}{",tt.FUNCTION,""]:r==="sqrt"?[r,"\\sqrt","",tt.UNARY,""]:r==="f"?[r,r,"f",tt.FUNCTION,""]:mathOperators.has(r)?[r,"\\"+r,r,tt.FUNCTION,""]:[r,"\\operatorname{"+groupSubscript(r)+"}",r,tt.FUNCTION,""]}else if(t.ttype===tt.ACCESSOR){return[r,r,r,tt.PROPERTY,""]}else if(/[_\u0300-\u0308\u030A\u030C\u0332\u20d0\u20d1\u20d6\u20d7\u20e1]/.test(r)){let t="";if(r.indexOf("_")===-1){t=checkForTrailingAccent(r);return[r,t,r,r.length>2?tt.LONGVAR:tt.VAR,""]}else{const n=r.split("_");for(let e=n.length-1;e>=0;e--){n[e]=checkForTrailingAccent(n[e]);if(e>0){n[e]="_\\text{"+n[e]+"}"}}t=n.join("");const o=/^*/.exec(e.slice(r.length));if(o){r+=o[0];t+="'".repeat(o[0].length)}const i=t.indexOf("_");if(i>-1){t=t.slice(0,i)+"{"+t.slice(i)+"}"}return[r,t,r,n[0].length>1?tt.LONGVAR:tt.VAR,""]}}else if(r.length===2&r.charAt(0)==="\ud835"){return[r,r,r,tt.VAR,""]}else if(r.length>1){return[r,r,r,tt.LONGVAR,""]}else{if(r.charAt(0)==="\ud835"){return[r.substring(0,2),r.substring(0,2),r.substring(0,2),tt.VAR,""]}else{return[r.charAt(0),r.charAt(0),r.charAt(0),tt.VAR,""]}}}};const unitStartRegEx=/^(?:[A-Za-z$]|)/;const unitAndExpo="(?:(?:[A-Za-z][A-Za-z]*\\$?|[$]|)(?:(?:(?:(?:\\^|\\^-)"+"[1-9][0-9]*)|(?:\\^\\(-?[1-9][0-9]*\\))|?[\\u2074-\\u2079][\\u2074-\\u2079]*))?)";const productOfUnits="(?:"+unitAndExpo+"(?:[*.]"+unitAndExpo+")*)";const unitNameRegEx=new RegExp("^"+productOfUnits+"(?:\\/"+productOfUnits+")?");const lexUnitName=e=>{const t=unitNameRegEx.exec(e);return[t[0],unitTeXFromString(t[0]),t[0],tt.UNIT,""]};const lex=(e,t,n,r=false)=>{let o=0;let i="";let s;if(e.length>3&&e.slice(0,3)==="==="){o=e.indexOf('"""',3);if(o>0){i=e.slice(3,o);return['"""'+i+'"""',i,i,tt.MACRO,""]}else{return[e,e.slice(3),e.slice(3),tt.MACRO,""]}}if(e.charAt(0)==='"'){o=e.indexOf('"',1);if(o>0){i=e.substring(1,o).replace(/\r?\n.*/,"");return['"'+i+'"',i,i,tt.STRING,""]}else{return[e,e.replace(/\r?\n.*/,""),e.replace(/\r?\n.*/,""),tt.STRING,""]}}if(/^#/.test(e)){i=e.slice(2);o=i.indexOf("\n");if(o>-1){const e=i.indexOf("\n");if(e>-1&&e<o){o=e}}if(o>-1){i=i.slice(0,o)}return[`#${i}`,`\\text{\\texttt{ \\#${i}}}`,`#${i}`,tt.COMMENT,""]}if(/^``/.test(e)){o=e.indexOf("`",e.charAt(2)==="`"?3:2);const n=o>0?e.slice(2,o):e.slice(2);const i=tablessTrim(n);let s="";if(r){s=DataFrame.quickDisplay(i)}else{const e=DataFrame.dataFrameFromTSV(i);s=DataFrame.display(e.value,"h3",t.decimalFormat)}return["``"+n+"``",s,n,tt.DATAFRAME,""]}if(e.charAt(0)==="`"){o=e.indexOf("`",1);if(o>0){i=e.substring(1,o).replace(/\r?\n.*/,"");return["`"+i+"`",i,i,tt.RICHTEXT,""]}else{return[e,e.replace(/\r?\n.*/,""),e,tt.RICHTEXT,""]}}if(unitRegEx.test(e)){o=e.indexOf("'",1);if(o>0){i=e.substring(1,o);const n="'"+i+"'";if(dateRegEx.test(e)){const e=dateDisplayFromIsoString(n,t.dateFormat,true);return[n,e,i,tt.DATE,""]}else{return[n,unitTeXFromString(i),i,tt.UNIT,""]}}else{return[e.charAt(0),e.charAt(0),e.charAt(0),tt.UNIT,""]}}s=texFunctionRegEx.exec(e);if(s){const e=s[0];i=e.slice(1);if(accents$1.has(i)){return[e,e,e,tt.ACCENT,""]}if(unaries.has(i)){return[e,e,e,tt.UNARY,""]}if(colors.has(i)){return[e,"\\textcolor{"+i+"}",e,tt.UNARY,""]}if(binaries.has(i)){return[e,e,e,tt.BINARY,""]}if(texREL.has(i)){return[e,e,e,tt.REL,""]}const t=texFunctions[e];if(t){return cloneToken$1(t)}if(mathOperators.has(i)){return[e,e,i,tt.FUNCTION,""]}if(greek[i]){const t=greek[i];return[e,t,t,tt.VAR,""]}return[e,e,e,tt.ORD,""]}if(minusRegEx.test(e)){if(isUnary(n)){const n=e.match(numberRegEx$5);if(n){i=texFromNumStr(n,t.decimalFormat);return[n[0],i,n[0],tt.NUM,""]}}return["-","-","-",tt.ADD,""]}const a=e.match(numberRegEx$5);if(a){i=texFromNumStr(a,t.decimalFormat);return[a[0],i,a[0],tt.NUM,""]}if(/^_[([{]/.test(e)){return["_","_","_",tt.SUB,""]}const l=lexOneWord(e,n);if(l){return cloneToken$1(l)}const c=superRegEx.exec(e);if(c){return[c[0],c[0],c[0],tt.SUPCHAR,""]}s=miscRegEx.exec(e);if(s){const e=s[0];for(let t=e.length;t>=1;t--){i=e.slice(0,t);if(miscSymbols[i]){return cloneToken$1(miscSymbols[i])}}}const d=e.charAt(0);if(d==="."&&(n.ttype===tt.VAR||n.ttype===tt.LONGVAR||n.ttype===tt.STRING||n.input==="]"||n.input===")"||n.ttype===tt.PROPERTY)){return[".","{.}",",",tt.ACCESSOR,""]}return[d,addTextEscapes(d),d,tt.VAR,""]};const builtInFunctions=new Set(["Char","Int","abs","acos","acosd","acosh","acot","acotd","acoth","acsc","acscd","acsch","angle","asec","asecd","asech","asin","asind","asinh","atan","atan2","atand","atanh","binomial","ceil","conj","cos","cosd","cosh","cot","cotd","coth","count","csc","cscd","csch","exp","factorial","fetch","findmax","floor","gamma","gcd","hcat","hypot","imag","isnan","length","lerp","ln","log","log10","log2","lfact","lgamma","logn","mod","number","ones","real","rem","rms","round","roundSig","roundn","savedate","sec","secd","sech","sech","sign","sin","sind","sinh","startSvg","string","tan","tand","tanh","tanh","today","trace","transpose","vcat","zeros",""]);const builtInReducerFunctions=new Set(["accumulate","beamDiagram","dataframe","findfirst","matrix2table","max","mean","median","min","product","rand","range","stddev","sum","variance"]);const trigFunctions=new Set(["cos","cosd","cot","cotd","csc","cscd","sec","secd","sin","sind","tand","tan"]);const rationalRPN=e=>{const t=Rnl.fromString(e);return""+String(t[0])+"/"+String(t[1])};const checkForUnaryMinus=(e,t)=>{switch(t.ttype){case tt.NUM:case tt.ORD:case tt.VAR:case tt.DATE:case tt.RIGHTBRACKET:case tt.LONGVAR:case tt.PROPERTY:case tt.UNIT:case tt.SUPCHAR:case tt.PRIME:case tt.FACTORIAL:return e}if(e.output==="-"){return{input:"~",output:"\\text{-}",ttype:tt.UNARYMINUS}}else{return{input:"+",output:"~+",ttype:tt.UNARYMINUS}}};const numFromSuperChar={"":"-","":"2","":"3","":"1","":"0","":"4","":"5","":"6","":"7","":"8","":"9"};const numFromSupChars=e=>{let t="";for(const n of e){t+=numFromSuperChar[n]}return t};const colorSpecRegEx=/^(#([a-f0-9]{6}|[a-f0-9]{3})|[a-z]+|\([^)]+\))/i;const accentRegEx=/^(?:.|\uD835.)[\u0300-\u0308\u030A\u030C\u0332\u20d0\u20d1\u20d6\u20d7\u20e1]_/;const spreadsheetCellRegEx=/^[A-Z](\d+|_end)$/;const dfracRegEx=/\\dfrac{/g;const factorsAfterSpace=/^[A-Za-z\u0391-\u03C9\u03D5\u210B\u210F\u2110\u2112\u2113\u211B\u212C\u2130\u2131\u2133\uD835]/;const factors=/^[[({]/;const setUpIf=(e,t,n,r)=>{const o=e.replace(/^.*\xa0/,"").replace(/$/,"");n.push(o);e=e.length===o.length?"":e.slice(0,e.length-o.length);r.numArgs+=1;if(t==="otherwise"){e+="true"}return e};const functionExpoRegEx=/^[\^\u2074-\u2079]/;const openParenRegEx$2=/^ *\(/;const exponentOfFunction=(e,t,n)=>{let r="";if(e.charAt(0)!=="^"){r=/^?[\u2074-\u2079]+/.exec(e)[0];r=r.split("").map((e=>numeralFromSuperScript(e))).join("")}else if(!openParenRegEx$2.test(e.slice(1))){r=lex(e.slice(1),{decimalFormat:t},{input:"",output:"",ttype:50})[0]}else{r="(";let t=1;for(let n=2;n<e.length;n++){const o=e.charAt(n);r+=o;if("\"'`".indexOf(o)>-1){const t=e.indexOf(o,n+1);r+=e.slice(n+1,t+1);n=t}else if("([{".indexOf(o)>-1){t+=1}else if(")]}".indexOf(o)>-1){t-=1}if(t===0){break}}}const o=r.charAt(0)==="("?r.slice(1,-1).trim():r;if(n){const e=parse$1(o,{decimalFormat:t},true);return[r,"{"+e[0]+"}",e[1]]}else{const e=parse$1(o,{decimalFormat:t},false);return[r,"{"+e+"}",""]}};const testForImplicitMult=(e,t,n,r)=>{if(t.length>0){const e=t[t.length-1].ttype;if(e===tt.UNARY||e===tt.BINARY){return false}if(e===tt.SUB||e===tt.SUP){if(t[t.length-1].isOnFunction){return false}}}let o=false;if(e.output){const t=e.output.charAt(e.length-1);if(")]}".indexOf(t)>-1){if((t===")"||t==="]")&&/^[([]/.test(n)){return false}else{o=true}}else{switch(e.ttype){case tt.ORD:case tt.NUM:case tt.VAR:case tt.LONGVAR:case tt.PRIME:case tt.SUP:case tt.SUPCHAR:case tt.SUB:case tt.PROPERTY:case tt.UNIT:case tt.RIGHTBRACKET:case tt.FACTORIAL:o=true;break;default:o=false}}}if(o&&nextCharIsFactor(n,e.ttype,r)){return true}return false};const multiplicands=new Set([tt.ORD,tt.VAR,tt.NUM,tt.LONGVAR,tt.RIGHTBRACKET,tt.CURRENCY,tt.SUPCHAR,tt.BIG_OPERATOR]);const nextCharIsFactor=(e,t,n)=>{const r=e.replace(leadingLaTeXSpaceRegEx,"");const o=r.charAt(0);let i=false;if(r.length>0){if(o==="|"||o==="");else if(/^[({[0-9]/.test(r)&&multiplicands.has(t)){return true}else{if(factors.test(o)||n&&factorsAfterSpace.test(o)){i=!/^(if|and|atop|or|else|elseif|modulo|otherwise|not|for|in|while|end)\b/.test(r)}}}return i};const cloneToken=e=>({input:e.input,output:e.output,ttype:e.ttype,closeDelim:e.closeDelim});const endOfOrd=new Set([tt.ORD,tt.VAR,tt.NUM,tt.DATE,tt.LONGVAR,tt.RIGHTBRACKET,tt.SUPCHAR]);const leadingSpaceRegEx$3=/^[ \f\r\v\u1680\u2000-\u200a\u2028\u2029\u202f\u205f\u3000\ufeff]+/;const leadingLaTeXSpaceRegEx=/^(|\\quad|\\qquad)+/;const sumRegEx$1=/\\_([^\xa0]+)([^=]+)\xa0=(\xa0[^^]+)\xa0\^\xa0([^]+)\xa0/;const rpnPrecFromType=[13,13,16,14,17,10,8,10,13,-1,-1,-1,1,-1,0,0,7,0,-1,15,0,6,8,5,4,1,13,17,16,-1,15,14,10,3,2,11,-1,-1,4,3,-1,-1,-1,-1,-1];const texPrecFromType=[12,12,15,13,16,10,2,10,12,2,2,2,1,2,2,0,2,1,2,14,1,2,2,1,1,1,2,-1,15,2,14,13,9,-1,1,-1,15,-1,1,-1,2,2,2,2,2];const dNOTHING=0;const dPAREN=1;const dFUNCTION=2;const dACCESSOR=3;const dMATRIX=4;const dVECTORFROMRANGE=5;const dDICTIONARY=6;const dCASES=7;const dBINOMIAL=8;const dSUBSCRIPT=9;const dDISTRIB=10;const parse$1=(e,t={decimalFormat:"1,000,000.",dateFormat:"yyy-mm-dd"},n=false,r=false,o="")=>{let i="";let s="";let a={};let l={input:"",output:"",ttype:50};const c=[];const d=rpnPrecFromType[tt.SUP];let u=true;let p=false;let f=0;let h=false;let m=false;let g=false;let y=false;let b=false;let x;const w=[];const S=[];const R=[{delimType:dNOTHING,isTall:false}];let v=true;let M="";let A="";let T="";let O=-1;const N=[];let E=0;let C=0;const k=e=>{if(n&&e>=0){while(S.length>0){const t=S[S.length-1].prec;if(t<e||t===d&&e===d){break}const n=S.pop().symbol;if(n===""){s=s.slice(0,C+1)+'"'+s.slice(C+1,-1).replace(/\u00a0/g,"")+'"'+T;C=0}s+=n+T}}};const I=(t,r)=>{if(!r){return}if(w.length===0){if(l.ttype!==tt.RIGHTBRACKET&&l.ttype!==tt.LEFTRIGHT){x={pos:f,ttype:l.ttype,closeDelim:""}}return}const o=w[w.length-1];if((t===2||t===12||t===14||t===15)&&(l.ttype!==tt.RIGHTBRACKET&&l.ttype!==tt.LEFTRIGHT)&&o.prec<t){x={pos:f,ttype:l.ttype,closeDelim:""};return}let c={};while(w[w.length-1].prec>=t&&!(w[w.length-1].prec===13&&t===13)){x=w.pop();if(x.prec===0){c=R[R.length-1];if((x.ttype===tt.LEFTBRACKET||x.ttype===tt.LEFTRIGHT)&&x.closeDelim.length>0){if(w.length>0){if(x.ttype===tt.LEFTRIGHT&&a.output===")"&&w[w.length-1].closeDelim===")"){if(c.isTall){i=i.substring(0,x.pos)+"\\middle"+i.substring(x.pos);R[R.length-1].isTall=true}x=w.pop();R.pop();c=R[R.length-1]}}if(c.delimType===dDICTIONARY&&c.open.length>3){i=i.slice(0,x.pos)+c.open+i.slice(x.pos+2);x.closeDelim=c.close}else if(c.delimType===dMATRIX){const e=i.slice(x.pos,x.pos+1)==="\\"?2:1;i=i.slice(0,x.pos)+c.open+i.slice(x.pos+e);x.closeDelim=c.close}else if(c.delimType===dACCESSOR){const e=i.slice(x.pos,x.pos+1)==="\\"?2:1;const t=c.isTall&&c.open.indexOf("\\begin")===-1;i=i.slice(0,x.pos)+(t?"\\left":"")+c.open+i.slice(x.pos+e);x.closeDelim=(t?"\\right":"")+c.close}else if(c.delimType===dCASES){i=i.slice(0,x.pos)+c.open+i.slice(x.pos+2);x.closeDelim=c.close}else if(c.delimType===dPAREN&&c.name==="("&&/^(\/|\\atop\s)/.test(e)){i=i.substring(0,x.pos)+i.substring(x.pos+1);x.closeDelim=""}else if(c.isPrecededByDiv&&c.delimType===dPAREN&&c.name==="("&&(/^[^^_!%]/.test(e)||e.length===0)){i=i.substring(0,x.pos)+i.substring(x.pos+1);x.closeDelim=""}else if(c.isTall){if(/^\\left/.test(i.substring(x.pos))===false){i=i.substring(0,x.pos)+"\\left"+i.substring(x.pos)}if(/\\right/.test(x.closeDelim)===false){x.closeDelim="\\right"+a.output}}}}i=i.replace(/\\, *$/,"");i+=x.closeDelim;if(x.closeDelim.slice(-1)==="{"){if(x.ttype===tt.BINARY){w.push({prec:12,pos:x.pos,ttype:tt.UNARY,closeDelim:"}"});if(n){s+=T;if(S[S.length-1].symbol==="\\sqrt"){S[S.length-1].symbol="root"}}}x.ttype=tt.UNARY;l={input:"",output:"",ttype:tt.UNARY};return}if(w.length===0||x.prec===0){return}}};e=e.replace(leadingSpaceRegEx$3,"");e=e.replace(/\s+$/,"");while(e.length>0){if(e.charAt(0)==="\n"){e=e.slice(1);const t=l?l.input.slice(-1):"0";if(l.ttype===tt.COMMENT||"{[(,;+-".indexOf(t)===-1&&!/^ *[)}\]]/.test(e)){I(0,true);i+="\\\\ ";const t=/^ +/.exec(e);e=e.replace(/^ */,"");if(e.length>0&&e.charAt(0)==="="&i.indexOf("=")>-1){p=true;i+="&"}else if(t){i+="\\quad ".repeat(t[0].length-1)}}e=e.trim()}u=true;y=h&&v&&testForImplicitMult(l,w,e,m);if(n){if(l.input===""&&S.length>1&&S[S.length-2].symbol===""&&s.charAt(s.length-2)==="^"){S.pop()}}if(y){const e=l.ttype;a={input:"",output:[tt.LONGVAR,tt.NUM,tt.UNIT].includes(e)?"\\,":"",ttype:tt.MULT};m=false;g=false;u=false}if(u){const n=l.ttype===tt.NUM&&!m&&unitStartRegEx.test(e)?lexUnitName(e):lex(e,t,l,r);a={input:n[0],output:n[1],ttype:n[3],closeDelim:n[4]};e=e.substring(a.input.length);m=leadingSpaceRegEx$3.test(e)||/^(|\\quad|\\qquad)+/.test(e);g=/^[ \n]/.test(e);e=e.replace(leadingSpaceRegEx$3,"");b=nextCharIsFactor(e,a.ttype,m)}if(a.input==="!"&&(h||!endOfOrd.has(l.ttype))){a.ttype=tt.UNARY;a.input=""}switch(a.ttype){case tt.SPACE:case tt.BIN:case tt.ADD:case tt.MULT:case tt.REL:case tt.BIG_OPERATOR:{if(a.output.length>0&&"- +".indexOf(a.output)>-1){a=checkForUnaryMinus(a,l)}if(n&&a.output===""){s=s.replace(/([^\u00a0]+)$/,'"$1"');C=s.length;const e=i.lastIndexOf("");i=i.slice(0,e)+i.slice(e+1)}if(n&&a.ttype!==tt.SPACE){if(a.output!=="\\text{-}"&&a.ttype!==tt.BIG_OPERATOR){s+=T}k(rpnPrecFromType[a.ttype===tt.BIG_OPERATOR?tt.VAR:a.ttype])}const e=texPrecFromType[a.ttype];I(e,v);i+=a.output+" ";f=i.length;if(a.ttype===tt.BIG_OPERATOR&&R.length>1){R[R.length-1].isTall=true}if(n){if(a.input===""||a.input==="\\sum"){s+="\\";a.input===""}S.push({prec:rpnPrecFromType[a.ttype],symbol:a.input})}v=true;break}case tt.ACCESSOR:case tt.ANGLE:a=checkForUnaryMinus(a,l);if(n){s+=T;O=rpnPrecFromType[a.ttype];k(O);S.push({prec:O,symbol:a.input})}I(texPrecFromType[a.ttype],v);i+=n?a.input:a.output+" ";v=true;break;case tt.BOOLEAN:I(2,v);if(n){k(-1);s+=a.input}if(h){f=i.length}i+=a.output;v=true;break;case tt.NUM:case tt.ORD:case tt.DATE:I(2,v);if(n){k(-1);s+=a.ttype===tt.NUM?rationalRPN(a.input):a.ttype===tt.DATE?dateRPN(a.input):a.input}if(h){f=i.length}if(n&&(l.ttype===tt.MULT||b&&l.ttype!==tt.DIV)){a.output="("+a.output+")"}i+=a.output+" ";v=true;if(!m&&b){I(2,v);if(n){O=rpnPrecFromType[tt.MULT];s+=T;k(O);S.push({prec:O,symbol:""})}}break;case tt.STRING:{I(2,v);const e=a.input.charAt(0);if(n){s+=e+a.output+e}if(h){f=i.length}a.output=addTextEscapes(a.output);a.output=a.output.replace(/ +$/,"\\,");i+="\\text{"+a.output+"}";v=true;break}case tt.RICHTEXT:{I(2,v);const e=a.input.charAt(0);if(n){s+=e+a.output+e}if(h){f=i.length}a.output=a.output==="`"?"`":parse$1(a.output,t,false);i+="{"+a.output+"}";v=true;break}case tt.MACRO:{I(2,v);if(n){s+='"""'+a.output+'"""'}if(h){f=i.length}a.output=addTextEscapes(a.output);i+="\\text{"+a.output+"}";v=true;break}case tt.DATAFRAME:I(2,v);f=i.length;i+=a.output;if(n){s+=a.input;const e=arrayOfRegExMatches(interpolateRegEx,a.input);for(const t of e){c.push(t.value.slice(2,-1))}}v=true;break;case tt.VAR:case tt.LONGVAR:{if(a.ttype===tt.LONGVAR&&l.input===""){i+="\\,"}I(7,v);if(h){f=i.length}if(!n){if(a.ttype===tt.LONGVAR){if(!accentRegEx.test(a.input)){a.output="\\mathrm{"+a.output+"}"}}}else if(l.input==="for"){s+='"'+a.input+'"'}else{if(/^(\.[^.]|\[)/.test(e)){a.output=a.ttype===tt.LONGVAR?"\\mathrm{"+a.output+"}":a.output}else{a.output=a.input;a.output=(C>0?"":"")+a.output}if(o&&spreadsheetCellRegEx.test(a.input)){s+=""+o+T+`"${a.input}"`+T+"."}else{s+=""+a.input}c.push(a.input)}i+=a.output+(e.charAt(0)==="."?"":" ");if(n){R[R.length-1].isTall=true}v=true;break}case tt.UNIT:{if(R.length>1&&R[R.length-1].delimType===dMATRIX){a.output="\\text{Error. Write a unit name outside a matrix, not inside. "+"Apply one unit to the entire matrix.}"}I(14,true);w.push({prec:14,pos:x.pos,ttype:tt.UNIT,closeDelim:""});if(n){k(rpnPrecFromType[tt.UNIT]);s+=T+"applyUnit"+T+a.input.replace(/'/g,"")}if(!/^'?'?$/.test(a.input)){i+="\\;"}i+=a.output;v=true;break}case tt.PROPERTY:{I(15,v);const t=a.input.indexOf("_");if(n){s+='"'+a.output+'"';i+=`\\mathrm{${a.output}}`;if(e.charAt(0)!=="."){i+=" "}}else if(t>-1){i+=a.input.substring(0,t)+"_\\mathrm{"+a.input.substring(t+1)+"}"}else{a.output=addTextEscapes(a.output);a.output=a.output.replace(/ +$/,"\\,");i+="\\text{"+a.output+"}"}v=true;break}case tt.TO:{R[R.length-1].delimType=dDISTRIB;I(1,v);f=i.length;i+=a.output;if(n){s+=T;k(3);const e=R[R.length-1].symbol;const t=e==="("?"normal":e==="["?"uniform":"lognormal";S.push({prec:3,symbol:t})}break}case tt.RANGE:{I(1,v);f=i.length;if(n&&a.input!=="..."){s+=T;k(3);S.push({prec:3,symbol:":"});if(["[",","].includes(l.input)&&/^[,\]]/.test(e)){s+=`1/1${T}""`}else if(/^end[,\]]/.test(e)){s+='""';e=e.slice(3)}}const t=R[R.length-1];i+=t.delimType===dPAREN&&t.symbol==="{"?"\\colon":a.output;break}case tt.DIV:{if(n){s+=T}I(2,true);O=rpnPrecFromType[tt.DIV];k(O);if(a.input==="//"){w.push({prec:2,pos:x.pos,ttype:tt.DIV,closeDelim:"}"});i=i.substring(0,x.pos)+"\\tfrac{"+i.substring(x.pos)+"}{"}else if(a.input==="/"||a.input==="\\over"){w.push({prec:2,pos:x.pos,ttype:tt.DIV,closeDelim:"}"});i=i.slice(0,x.pos)+i.slice(x.pos).replace(dfracRegEx,"\\frac{");i=i.substring(0,x.pos)+"\\dfrac{"+i.substring(x.pos)+"}{"}else{w.push({prec:2,pos:x.pos,ttype:tt.DIV,closeDelim:"}}"});i=i.substring(0,x.pos)+"{{"+i.substring(x.pos)+"}\\atop{";if(R[R.length-1].name==="("){R[R.length-1].delimType=dBINOMIAL}}if(n){if(a.input==="\\atop"){if(R[R.length-1].delimType===dBINOMIAL){S.push({prec:O,symbol:"()"})}}else{S.push({prec:O,symbol:a.input})}}R[R.length-1].isTall=true;f=i.length;v=false;break}case tt.SUB:{I(15,true);const e=l.ttype===tt.FUNCTION?"}{":"}";w.push({prec:15,pos:x.pos,ttype:tt.SUB,closeDelim:e});i+="_{";if(n){s+="_"}v=false;break}case tt.SUP:if(n){if(/e$/.test(s)){s=s.slice(0,-2)+"27182818284590452353602874713527/10000000000000000000000000000000"}s+=T;k(rpnPrecFromType[tt.SUP])}I(13,true);if(l.ttype===tt.RIGHTBRACKET){w.push({prec:13,pos:x.pos,ttype:tt.SUP,closeDelim:"}"})}else{w.push({prec:13,pos:f,ttype:tt.SUP,closeDelim:"}"})}if(n){S.push({prec:rpnPrecFromType[tt.SUP],symbol:"^"})}if(R.length>0&&e.charAt(0)==="("){R[R.length-1].isTall=true}i+="^{";v=false;break;case tt.SUPCHAR:{if(n){if(/e$/.test(s)){s=s.slice(0,-2)+"27182818284590452353602874713527/10000000000000000000000000000000"}s+=T;k(rpnPrecFromType[tt.SUPCHAR])}I(13,true);const e=numFromSupChars(a.output);if(l.ttype===tt.RIGHTBRACKET){w.push({prec:13,pos:x.pos,ttype:tt.SUP,closeDelim:"}"})}else{w.push({prec:13,pos:f,ttype:tt.SUP,closeDelim:"}"})}i+="^{"+e;if(n){S.push({prec:rpnPrecFromType[tt.SUPCHAR],symbol:"^"});s+=rationalRPN(e)}v=true;break}case tt.FUNCTION:{I(2,v);f=i.length;if(functionExpoRegEx.test(e)){const[r,o,i]=exponentOfFunction(e,t.decimalFormat,n);if(n&&i===`-1/1`&&trigFunctions.has(a.input)){a.input="a"+a.input;a.output="\\a"+a.output.slice(1)}else{if(n){a.input+=T+i+T+"^"}a.output+="^"+o}const s=r.length+(e.charAt(0)==="^"?1:0);e=e.slice(s).trim()}if(n){S.push({prec:rpnPrecFromType[tt.FUNCTION],symbol:a.input});if(l.input===""){i+=""}}M=e.charAt(0);w.push({prec:12,pos:i.length,ttype:tt.FUNCTION,closeDelim:M==="("?"":"}"});i+=a.output;i+=M==="("?"":"{";A=a.input;v=false;break}case tt.ACCENT:if(n){s+=T;k(rpnPrecFromType[tt.ACCENT])}I(1,v);if(n){w.push({prec:16,pos:i.length,ttype:tt.ACCENT,closeDelim:""});i+=(C>0?"":"")+a.input;s+=""+a.input;c.push(a.input)}else{w.push({prec:16,pos:i.length,ttype:tt.ACCENT,closeDelim:"}"});i+=a.output+"{"}R[R.length-1].isTall=true;v=false;break;case tt.PRIME:I(15,true);if(n){s+=a.input;c.push(l.input+a.input)}i=i.trim()+a.output+" ";v=true;break;case tt.BINARY:{I(1,v);f=i.length;const e=a.input==="root"?"]{":"}{";w.push({prec:12,pos:i.length,ttype:tt.BINARY,closeDelim:e});if(n){S.push({prec:rpnPrecFromType[tt.BINARY],symbol:a.output})}i+=a.output+(a.input==="root"?"[":"{");R[R.length-1].isTall=true;v=false;break}case tt.CURRENCY:{I(1,v);f=i.length;w.push({prec:12,pos:i.length,ttype:tt.CURRENCY,closeDelim:""});if(n){S.push({prec:rpnPrecFromType[tt.CURRENCY],symbol:"applyUnit"+T+a.input});if(l.input===""){i+=""}}i+=a.output;v=false;break}case tt.UNARY:I(1,v);f=i.length;w.push({prec:12,pos:i.length,ttype:tt.UNARY,closeDelim:"}"});if(n){S.push({prec:rpnPrecFromType[tt.UNARY],symbol:a.input});if(l.input===""){i+=""}}i+=a.output;if(/det|inf/.test(a.input)&&e.charAt(0)==="_"){w.push({prec:15,pos:i.length,ttype:tt.SUB,closeDelim:"}"});a={input:"_",output:"_",ttype:tt.SUB};i+="_{";e=e.substring(1);e=e.replace(/^\s+/,"")}else if(a.input==="\\color"){const t=colorSpecRegEx.exec(e);if(t){i+="{"+t[0].replace(/[()]/g,"")+"}";w.pop();e=e.slice(t[0].length).trim()}else{i+="{"}}else{i+="{"}R[R.length-1].isTall=true;v=false;break;case tt.FACTORIAL:I(12,true);w.push({prec:12,pos:x.pos,ttype:tt.FACTORIAL,closeDelim:""});if(n){k(rpnPrecFromType[tt.FACTORIAL]);s+=T+a.output}i+=a.output;v=true;break;case tt.RETURN:I(1,v);f=i.length;if(n){k(4);S.push({prec:4,symbol:"return"})}i+=a.output+" ";break;case tt.KEYWORD:I(1,true);f=i.length;if(n){k(2)}i+=a.output+" ";break;case tt.LOGIC:{I(1,v);if(n){s+=T}k(4);const e=R[R.length-1];if(a.input==="if"||a.input==="otherwise"){if(e.delimType===dPAREN&&e.name==="{"){e.delimType=dCASES;e.close="\\end{cases}";e.open="\\begin{cases}";if(n&&T===""&&a.input==="if"){s=s.slice(0,e.rpnPos)+s.slice(e.rpnPos).replace(/\xa0/g,"")}}}if(e.delimType===dCASES&&["if","otherwise"].includes(a.input)){i+="&"}i+=a.output;if(n){if(e.delimType===dCASES&&(a.input==="if"||a.input==="otherwise")){s=setUpIf(s,a.input,N,e);T=""}else{S.push({prec:4,symbol:a.input})}}f=i.length;v=true;break}case tt.LEFTBRACKET:{I(2,v);const t=l.ttype===tt.DIV;let r=false;const o={prec:0,pos:i.length,ttype:tt.LEFTBRACKET,closeDelim:a.closeDelim};if((a.input==="("||a.input==="[")&&l.ttype<5){o.closeDelim=""}else if(a.input==="("&&x.ttype===tt.BINARY){o.closeDelim=""}else{o.closeDelim=a.closeDelim;r=(a.input==="("||a.input==="[")&&l.ttype===tt.FUNCTION;i+=a.output}w.push(o);if(n){while(S.length>0&&S[S.length-1].symbol==="."){s+=T+S.pop().symbol}S.push({prec:0,symbol:a.output.trim()})}const c=/^\s*[)}\]]/.test(e)?0:1;const d={name:a.input,isTall:false,open:a.output,close:o.closeDelim,numArgs:c,numRows:c,rpnPos:s.length,isPrecededByDiv:t,isFuncParen:r,isControlWordParen:l.ttype<5};if(r){d.delimType=dFUNCTION;d.name=A}else if(l.ttype===tt.SUB){d.delimType=dSUBSCRIPT;d.name="("}else if(a.input==="{"){d.delimType=dPAREN;d.rpnLength=s.length}else if(a.input==="["&&([tt.VAR,tt.LONGVAR,tt.STRING,tt.PROPERTY].includes(l.ttype)||l.input==="]"||l.input===")"&&!h)){s+=T;d.delimType=dACCESSOR}else{d.delimType=dPAREN;d.name=a.input}R.push(d);A="";f=i.length;v=false;break}case tt.SEP:{I(1,v);f=i.length;const t=R[R.length-1];if((t.delimType===dPAREN||t.delimType===dACCESSOR)&&([";","\t"].includes(a.input)||a.input===","&&g)){t.delimType=t.delimType===dPAREN?dMATRIX:dACCESSOR;const e=t.name==="["?"b":t.name==="("?"p":t.name==="{:"?"":t.name==="|"?"v":t.name===""?"V":"B";t.open=`\\begin{${e}matrix}`;t.close=`\\end{${e}matrix}`;for(let e=R.length-1;e>0;e--){R[e].isTall=true}}if(n){if(l.ttype===tt.LEFTBRACKET&&t.delimType===dACCESSOR){s+="0/1"}s+=T;k(1)}if(t.delimType===dMATRIX&&a.input===","){a.output=" & "}i+=a.output+" ";if(n){if(R.length===1){if(a.input===","){E+=1}}else{if(a.input===";"){t.numRows+=1;if(R.length>0&&t.delimType===dCASES){T=""}}if(t.numRows===1){if([",","\t"].includes(a.input)&&e.charAt(0)==="]"){s+="0/1"}if(a.input===","&&t.delimType===dFUNCTION){if(t.numArgs===2&&t.name==="plot"){s=s.slice(0,t.rpnPos+5)+'"'+s.slice(t.rpnPos+5,-1).replace(/\u00a0/g,"")+'"'+T}}}t.numArgs+=1}}v=true;break}case tt.RIGHTBRACKET:{I(0,true,a.output);const t=R.pop();if(t.delimType===dPAREN&&!t.isControlWordParen&&t.close!==a.output){i=i.slice(0,-1*t.close.length)+a.output}if(t.isTall&&R.length>1){R[R.length-1].isTall=true}if(n){while(S.length>0&&S[S.length-1].prec>0){s+=T+S.pop().symbol}if(t.delimType===dCASES&&l.input!=="otherwise"){s=setUpIf(s,"otherwise",N,t);T=""}const n=S.pop();const r=t.numArgs;const o=t.numRows;const i=t.numArgs/t.numRows;const c=r===0?"":T;switch(t.delimType){case dFUNCTION:{let e=S.pop().symbol;const t=new RegExp(T+"!$");if(r===2){if(e==="log"){e="logn"}if(e==="round"){e="roundn"}if(e==="atan"){e="atan2"}if(e==="plot"){s=s.slice(0,6)+'"'+s.slice(6).replace(/\u00a0/g,"")+'"'}}else if(e==="log"&&t.test(s)){s=s.slice(0,s.length-1)+"lfact";break}s+=e.slice(-1)==="^"?c+e:builtInFunctions.has(e)?c+e:builtInReducerFunctions.has(e)?c+e+T+r:c+"function"+T+e+T+r;break}case dACCESSOR:s+=c+"[]"+T+r;break;case dMATRIX:s+=c+"matrix"+T+o+T+i;break;case dCASES:T="";s+=T+"cases"+T+o+T;while(N.length>0){s+=N.shift()}s=s.slice(0,-1);break;case dVECTORFROMRANGE:s+=T+"matrix"+T+"1"+T+"1";break;case dDISTRIB:break;default:if(r===0&&t.open==="["){s+="matrix"+T+0+T+0}else if(r===1&&t.open==="["){s+=T+"matrix"+T+1+T+1}if(n.symbol==="\\lfloor"){s+=T+""}if(n.symbol==="\\lceil"){s+=T+""}}if(a.input===")"&&!(t.delimType===dFUNCTION&&e.charAt(0)==="["&&!m)&&nextCharIsFactor(e,tt.RIGHTBRACKET,m)||(a.input==="]"&&/^\(/.test(e)||t.delimType===dMATRIX&&/^\[/.test(e))){s+=T;k(rpnPrecFromType[tt.MULT]);S.push({prec:rpnPrecFromType[tt.MULT],symbol:""});m=false;a={input:"",output:"",ttype:tt.MULT}}}f=i.length;v=x.ttype!==tt.BINARY;break}case tt.LEFTRIGHT:{I(1,v);const e=R[R.length-1];let t=false;if(w.length>0){t=w[w.length-1].ttype===tt.LEFTRIGHT||w[w.length-1].closeDelim===""||w[w.length-1].closeDelim==="\\right."}if(t){if(e.delimType!==dMATRIX){e.close=a.input==="|"?"|":"";w[w.length-1].closeDelim=e.close}I(0,v);R.pop();if(n){while(S.length>0&&S[S.length-1].prec>0){s+=T+S.pop().symbol}s+=T+S.pop().symbol}v=x.ttype!==tt.BINARY}else if(e.delimType===dPAREN&&e.name==="{"){i+="\\mid ";f=i.length;v=true}else{w.push({prec:0,pos:i.length,ttype:tt.LEFTRIGHT,closeDelim:a.input==="|"?"|":""});R.push({delimType:dPAREN,name:a.input,isTall:false,open:a.input==="|"?"|":"",close:a.input==="|"?"|":"",numArgs:1,numRows:1,rpnPos:s.length,isPrecededByDiv:l.ttype===tt.DIV});if(n){S.push({prec:0,symbol:a.output})}i+=a.input==="|"?"|":"";f=i.length;v=false}break}case tt.COMMENT:I(0,true);i+=a.output+" ";break;default:if(n){s+=T;k(rpnPrecFromType[tt.ORD])}I(1,v);w.push({prec:1,pos:i.length,ttype:tt.ORD,closeDelim:""});if(n){S.push({prec:rpnPrecFromType[tt.ORD],symbol:a.output})}i+=a.output+" ";f=i.length;v=true}l=cloneToken(a);h=m||a.input===""}I(0,true);let D="";if(n){while(S.length>0){s+=T+S.pop().symbol}let e=sumRegEx$1.exec(s);while(e){D=e[1];s=s.slice(0,e.index)+'"'+e[1]+'"'+e[2]+e[3]+T+'"'+e[4].replace(/\u00a0/g,"")+'"'+s.slice(e.index+e[0].length);e=sumRegEx$1.exec(s)}if(E>0){s+=T+"tuple"+T+String(E+1)}const t=/[^ ().\\,;]+/g;let n;while((n=t.exec(i))!==null){if("".indexOf(n[0][1])===-1){const e=n.index+n[0].length;if(i.length>e&&i.charAt(e)==="("){i=i.slice(0,n.index)+i.slice(n.index+1)}else{i=i.substring(0,e)+""+i.substring(e)}}}}i=i.replace(/ {2,}/g," ");i=i.replace(/\s+(?=[_^'!)}\]])/g,"");i=i.replace(/\s+$/,"");if(D.length>0){i=i.replace(new RegExp(`${D}`,"g"),D)}if(p){const e=i.indexOf("=");i="\\begin{aligned}"+i.slice(0,e)+"&"+i.slice(e)+"\\end{aligned}"}return n?[i,s,c]:i};const PAREN=1;const FRAC=2;const TFRAC=4;const BINARY=8;const ENV=16;const CASES=32;const SUB=64;const charAccents={"\\bar":"","\\grave":"","\\acute":"","\\hat":"","\\tilde":"","\\dot":"","\\ddot":"","\\mathring":"","\\check":"","\\underline":"","\\overleftharpoon":"","\\overrightharpoon":"","\\overleftarrow":"","\\vec":"","\\overleftrightarrow":""};const openParenRegEx$1=/^ *(?:\\(?:left|big|Big|bigg|Bigg))? *\(/;const leadingSpaceRegEx$2=/^\s+/;const trailingSpaceRegEx$1=/ +$/;const inlineFracRegEx=/^\/(?!\/)/;const ignoreRegEx=/^\\(left(?!\.)|right(?!\.)|middle|big|Big|bigg|Bigg)/;const subRegEx=/^\("([A-Za-z\u0391-\u03c9][A-Za-z0-9\u0391-\u03c9]*)"$/;const enviroRegEx=/^\\begin\{(?:(cases)|(|p|b|B|v|V)matrix)\}/;const endEnviroRegEx=/^\\end\{(?:cases|(?:|p|b|B|v|V)matrix)\}/;const greekAlternatives="Alpha|Beta|Gamma|Delta|Epsilon|Zeta|Eta|Theta|Iota|Kappa|Lambda|Mu|Nu|Xi|Omicron|Pi|Rho|Sigma|Tau|Upsilon|Phi|Chi|Psi|Omega|alpha|beta|gamma|delta|epsilon|zeta|eta|theta|iota|kappa|lambda|mu|nu|xi|omicron|pi|rho|sigma|tau|upsilon|phi|chi|psi|omega|varphi";const greekRegEx=RegExp("^\\\\("+greekAlternatives+")\\b");const bracedCharRegEx=RegExp("^\\{([A-Za-z0-9-]|\\\\("+greekAlternatives+"))\\}");const greekLetters={Alpha:"",Beta:"",Gamma:"",Delta:"",Epsilon:"",Zeta:"",Eta:"",Theta:"",Iota:"",Kappa:"",Lambda:"",Mu:"",Nu:"",Xi:"",Omicron:"",Pi:"",Rho:"",Sigma:"",Tau:"",Upsilon:"",Phi:"",Chi:"",Psi:"",Omega:"",alpha:"",beta:"",gamma:"",delta:"",epsilon:"",zeta:"",eta:"",theta:"",iota:"",kappa:"",lambda:"",mu:"",nu:"",xi:"",omicron:"",pi:"",rho:"",sigma:"",tau:"",upsilon:"",phi:"",chi:"",psi:"",omega:"",varphi:""};const matrices={m:["{:",":}"],p:["(",")"],b:["[","]"],B:["{","}"],v:["|","|"],V:["",""]};const eatOneChar=e=>{e=e.slice(1);e=e.replace(leadingSpaceRegEx$2,"");return e};const eatMatch=(e,t)=>{e=e.slice(t[0].length);e=e.replace(leadingSpaceRegEx$2,"");return e};const texToCalc=e=>{let t="";let n={};let r={input:"",output:"",ttype:50};const o=[{ch:"",pos:-1,type:0}];let i=true;e=e.replace(leadingSpaceRegEx$2,"");e=e.replace(/\s+$/,"");while(e.length>0){while(e.length>0&&e.charAt(0)==="'"){t+="";e=eatOneChar(e)}while(inlineFracRegEx.test(e)){t+="";e=eatOneChar(e)}while(e.length>0&&e.charAt(0)==="\n"){t+="\n";e=eatOneChar(e)}while(greekRegEx.test(e)){const n=greekRegEx.exec(e)[0];t+=greekLetters[n.slice(1)]+" ";e=e.slice(n.length);e=e.replace(leadingSpaceRegEx$2,"")}while(enviroRegEx.test(e)){const n=enviroRegEx.exec(e);if(n[1]){o.push({ch:":}",pos:t.length,type:ENV+CASES});t+="{"}else{const e=n[2]?n[2]:"m";o.push({ch:matrices[e][1],pos:t.length,type:ENV});t+=matrices[e][0]}e=eatMatch(e,n)}while(endEnviroRegEx.test(e)){const n=endEnviroRegEx.exec(e);const r=o.pop();if(n[0].indexOf("cases")>-1){let e=t.slice(r.pos+1);e=e.replace(/"if *"/g,"if ");t=t.slice(0,r.pos+1)+e}t+=r.ch;e=eatMatch(e,n)}while(ignoreRegEx.test(e)){const t=ignoreRegEx.exec(e);e=eatMatch(e,t)}const s=lex(e,"10000000.",r);n={input:s[0],output:s[2],ttype:s[3],closeDelim:s[4]};e=e.slice(n.input.length);e=e.replace(leadingSpaceRegEx$2,"");switch(n.ttype){case tt.SPACE:t+=n.output;break;case tt.SUPCHAR:if(t.slice(-1)===" "){t=t.slice(0,-1)}t+=n.output;break;case tt.SUB:case tt.SUP:t+=n.output;if(e.length>0&&e.charAt(0)==="{"){const r=n.ttype===tt.SUB?SUB:PAREN;o.push({ch:")",pos:t.length,type:r});t+="(";e=eatOneChar(e)}break;case tt.NUM:case tt.ORD:case tt.VAR:case tt.ADD:case tt.MULT:case tt.REL:case tt.BIN:case tt.BIG_OPERATOR:case tt.FACTORIAL:if(n.input==="&"&&o[o.length-1].type&ENV){if(o[o.length-1].type===ENV){t+=", "}}else{t+=n.output+" "}break;case tt.LONGVAR:t+=i?n.output.split("").join(" ")+" ":n.output;break;case tt.ACCENT:{if(charAccents[n.input]&&bracedCharRegEx.test(e)){o.push({ch:charAccents[n.input],pos:t.length,type:PAREN});e=eatOneChar(e)}else if(n.input==="\\mathrm"){i=false;o.push({ch:"",pos:t.length,type:PAREN});e=eatOneChar(e)}else{t+=n.output;if(e.length>0&&e.charAt(0)==="{"){t+="(";o.push({ch:")",pos:t.length,type:PAREN});e=eatOneChar(e)}}break}case tt.UNARY:{if(n.input==="\\text"){o.push({ch:'"',pos:t.length,type:PAREN});t+='"';i=false;e=e.slice(1)}else{t+=n.output;if(e.length>0&&e.charAt(0)==="{"){o.push({ch:")",pos:t.length,type:PAREN});t+="(";e=eatOneChar(e)}}break}case tt.BINARY:{const r=t.length;if(n.input==="\\frac"||n.input==="\\dfrac"){t+="(";o.push({ch:")/(",pos:r,type:FRAC})}else if(n.input==="\\tfrac"){t+="(";o.push({ch:")//(",pos:r,type:TFRAC})}else{t+=n.input+"{";o.push({ch:"}{",pos:r,type:BINARY})}e=eatOneChar(e);break}case tt.DIV:{const e=o[o.length-1].pos;t=t.slice(0,e)+"("+t.slice(e+1);o.pop();t+=n.input==="\\over"?")/(":")"+n.input+"(";o.push({ch:")",pos:t.length-1,type:PAREN});break}case tt.FUNCTION:{t+=n.output;const r=t.length;const i=openParenRegEx$1.exec(e);if(i){t+="(";o.push({ch:")",pos:r,type:PAREN});e=eatMatch(e,i)}else{t+=" "}break}case tt.LEFTBRACKET:{o.push({ch:n.closeDelim,pos:t.length,type:PAREN});t+=n.output;break}case tt.SEP:{const e=o[o.length-1].type&ENV;if(n.input==="//"&&e){t+=";"}else{t+=n.output}break}case tt.RIGHTBRACKET:{const n=o.pop();t=t.replace(trailingSpaceRegEx$1,"");if(/ $/.test(t)){t=t.slice(0,-1)}if(n.type===FRAC){t+=") / (";e=eatOneChar(e);o.push({ch:")",pos:t.length-1,type:PAREN})}else if(n.type===TFRAC){t+=")//(";e=eatOneChar(e);o.push({ch:")",pos:t.length-1,type:PAREN})}else if(n.type===BINARY){t+="}{";e=eatOneChar(e);o.push({ch:"}",pos:t.length-1,type:PAREN})}else if(n.type===SUB){let e=t.slice(n.pos);if(subRegEx.test(e)){e=e.replace(subRegEx,"$1");t=t.slice(0,n.pos)+e+" "}else{t+=n.ch+" "}}else{t+=n.ch+" "}if(n.ch==='"'||n.ch===""){i=true}break}default:t+=n.output}r=cloneToken(n)}t=t.replace(/ {2,}/g," ");t=t.replace(/\s+(?=[_^'!)}\]])/g,"");t=t.replace(/\s+$/,"");return t};const CR_NEWLINE_R=/\r\n?/g;const FORMFEED_R=/\f/g;const CLASS_R=/(?:^| )\.([a-z-]+)(?: |&|$)/;const tableClassRegEx=/(?:^| )\.(?:([a-z-]+)(?: |$)|"([^"]+)")/;const floatRegEx=/float="(left|right)"/;const WIDTH_R=/(?:^| )width="?([\d.a-z]+"?)(?: |$)/;const ALT_R=/(?:^| )alt="([A-Za-z\d ]+)"(?: |$)/;const COL_WIDTHS_R=/(?:^| )colWidths="([^"]*)"/;const ID_R=/(?:^| )#([A-Za-z][A-Za-z0-9]*)(?: |$)/;const leadingSpaceRegEx$1=/^ +/;const trailingSpaceRegEx=/ +$/;const preprocess=function(e){return e.replace(CR_NEWLINE_R,"\n").replace(FORMFEED_R,"")};const inlineRegex=function(e){const t=function(t,n){return n.inline?e.exec(t):null};t.regex=e;return t};const blockRegex=function(e){const t=function(t,n){return n.inline?null:e.exec(t)};t.regex=e;return t};const anyScopeRegex=function(e){const t=function(t,n){return e.exec(t)};t.regex=e;return t};const UNESCAPE_URL_R=/\\([^0-9A-Za-z\s])/g;const unescapeUrl=function(e){return e.replace(UNESCAPE_URL_R,"$1")};const isNotAnInteger=e=>isNaN(e)||Number(e)%1!==0;const indentRegEx=/^ +/;const insertNewlines=e=>{const t=e.split("\n");let n=t.length;let r=0;let o=0;let i=true;while(r<n){const e=t[r];const s=e==="";if(!s){if(LIST_ITEM_PREFIX_R.test(e)){const s=indentRegEx.exec(e);const a=s?s[0].length:0;if(a!==o&&!i){t.splice(r,0,"");r+=1;n+=1;i=true;continue}o=a}}i=s;r+=1}return t.join("\n")};const parseList=(e,t)=>{if(!t.inList){e=e.replace(LIST_BLOCK_END_R,"\n");e=insertNewlines(e)}const n=e.match(LIST_ITEM_R);const r=!/\n\n/.test(e.replace(/\n*$/,""));const o=t.inList;t.inList=true;const i=n.map((function(e,n){const o=LIST_ITEM_PREFIX_R.exec(e);const i=o?o[0].length:0;const s=new RegExp("^ {1,"+i+"}","gm");const a=e.replace(s,"").replace(LIST_ITEM_PREFIX_R,"");const l=t.inline;t.inline=r;const c=a.replace(LIST_ITEM_END_R,"");const d=parse(c,t);const u=r?{type:"tight_list_item",content:[{type:"paragraph",content:d}]}:{type:"list_item",content:d};t.inline=l;return u}));t.inList=o;return i};const TABLES=function(){const e=/^ *[|+] *| *[|+] *$/g;const t=/^[-=]+:$/;const n=/^:[-=]+:$/;const r=function(r){r=r.replace(e,"");const o=r.trim().split(/[|+]/);let i="";for(let e=0;e<o.length;e++){i+=n.test(o[e])?` c${String(e+1)}c`:t.test(o[e])?` c${String(e+1)}r`:""}return i.trim()};const o=(e,t)=>{if(!e&&t===""){return["","",null]}const n=tableClassRegEx.exec(e);let r=n?n[1]?n[1]:n[2]:"";const o=r&&r.split(" ").includes("spreadsheet");if(t.length>0){r+=(r.length>0?" ":"")+t}const i=ID_R.exec(e);const s=i?i[1]:"";const a=COL_WIDTHS_R.exec(e);const l=a?a[1].split(" "):null;return[r,s,o,l]};const i=/(?<!\\)\|/;const s=function(e,t,n,r,o,s){const a=e.trim().split(i);a.shift();a.pop();const l=[{type:"tableSeparator"}];for(const e of a){const o=r?[{type:"spreadsheet_cell",attrs:{entry:e.trim()}}]:t(e.trim(),n);l.push(...o);l.push({type:"tableSeparator"})}consolidate(l);const c={type:"table_row",content:[]};let d=-1;l.forEach((function(e,t){if(e.type==="text"){if(t>0&&l[t-1].type==="tableSeparator"){e.text=e.text.replace(leadingSpaceRegEx$1,"")}if(t<l.length-1){e.text=e.text.replace(trailingSpaceRegEx,"")}}if(e.type==="tableSeparator"){if(t!==l.length-1){d+=1;c.content.push({type:s?"table_header":"table_cell",attrs:{colspan:1,rowspan:1,colwidth:o?[Number(o[d])]:null,background:null},content:n.inHtml||r?[]:[{type:"paragraph",content:[]}]})}}else if(n.inHtml||r){c.content[d].content.push(e)}else{c.content[d].content[0].content.push(e)}}));return c};const a=function(){return function(e,t){t.inline=true;const n=r(e[3]);const[i,a,l,c]=o(e[5],n);const d={type:"table",attrs:{},content:[]};if(a){d.attrs.name=a}if(i){d.attrs.class=i}if(l){d.attrs.dtype=dt.SPREADSHEET}if(c&&t.inHtml){let e=0;c.forEach((t=>{e+=Number(t)}));d.attrs.style=`width: ${e}px`;const t={type:"colGroup",content:[]};for(const e of c){t.content.push({type:"col",attrs:[{style:`width: ${e}px`}]})}d.content.push(t)}if(!/^\|+$/.test(e[2])){d.content.push(s(e[2],parse,t,l,c,true))}const u=e[4].trim().split("\n");u.forEach((e=>{d.content.push(s(e,parse,t,l,c,false))}));t.inline=false;if(e[1]){const n={type:"figure",attrs:{class:""},content:[{type:"figcaption",content:parseInline(e[1],t)},d]};if(e[5]){const t=floatRegEx.exec(e[5]);if(t){n.attrs.class=t[1]}}return n}else{return d}}};const l=/^\+:?=/;const c=/ *\n/g;const d=/^\+[-=:]+\+[+=:-]+\+$/g;const u=function(){return function(e,t){const n=e[3];const i=e[2].slice(0,-1).split(c);let s=false;let a=i.length+10;for(let e=0;e<i.length;e++){if(l.test(i[e])){s=true;a=e;break}}const u=s?i[a]:n.slice(1);const p=r(u);const[f,h,m,g]=o(e[4],p);const y=[0];for(let e=1;e<n.length;e++){if(n.charAt(e)==="+"){y.push(e)}}const b=[0];for(let e=1;e<i.length;e++){if(i[e].charAt(0)==="+"){b.push(e)}}let x=0;while(x<b.length){let e=0;const t=new Array(y.length).fill(true);for(let n=b[x]+1;n<i.length;n++){for(let r=0;r<y.length;r++){if(!t[r]){continue}if("+|".indexOf(i[n][y[r]])===-1){t[r]=false;continue}if(i[n][y[r]]==="+"){e=n;break}}if(e!==0){break}}if(!b.includes(e)){b.splice(x+1,0,e)}x+=1;const n=i[e];for(let e=0;e<y.length-1;e++){let t=n.slice(y[e],y[e+1]+1);if(d.test(t)){t=t.slice(1,-1);let n=t.indexOf("+")+1;let r=1;while(n>0){y.splice(e+r,0,y[e]+n);n=t.indexOf("+",n)+1;r+=1}}}}const w=y.length-1;const S=b.length-1;const R=[];for(let e=0;e<S;e++){const e=new Array(w);for(let t=0;t<w;t++){e[t]={rowspan:1}}R.push(e)}for(let e=0;e<S;e++){const t=R[e];for(let n=0;n<w;n++){const r=t[n];if(r.rowspan===0){continue}r.colspan=1;const o=i[b[e+1]-1];for(let e=n+1;e<y.length;e++){if(o.charAt(y[e])==="|"){break}r.colspan+=1;t[e].rowspan=0}for(let t=e+1;t<b.length;t++){const e=i[b[t]].charAt(y[n]+1);if("-=:".indexOf(e)>-1){break}r.rowspan+=1;for(let e=0;e<r.colspan;e++){R[t][n+e].rowspan=0}}const l=y[n]+1;const c=y[n+r.colspan];const d=b[e]+1;const u=b[e+r.rowspan];let p="";for(let e=d;e<u;e++){p+=i[e].slice(l,c).replace(/ +$/,"")+"\n"}r.blob=p.slice(0,-1).replace(/^\n+/,"");const f=/^ +/.exec(r.blob);if(f){const e=f[0].length;const t=new RegExp("^"+" ".repeat(e),"gm");r.blob=r.blob.replace(t,"")}r.inHeader=s&&d<a;if(g){const e=r.colspan===0?null:[];for(let t=0;t<r.colspan;t++){e.push(Number(g[n+t]))}r.width=e}}}const v={type:"table",attrs:{},content:[]};if(h){v.attrs.name=h}if(f){v.attrs.class=f}if(m){v.attrs.dtype=dt.SPREADSHEET}let M=0;if(g&&t.inHtml){let e=0;g.forEach((t=>{e+=Number(t)}));v.attrs.style=`width: ${e}px`;const t={type:"colGroup",attrs:null,content:[]};for(const e of g){t.content.push({type:"col",attrs:[{style:`width: ${e}px`}]})}v.content.push(t);M=1}for(let e=0;e<S;e++){v.content.push({type:"table_row",content:[]});for(let n=0;n<w;n++){if(R[e][n].rowspan===0){continue}const r=R[e][n];t.inline=false;let o=m?[{type:"spreadsheet_cell",attrs:{entry:r.blob.trim()}}]:parse(r.blob,t);if(t.inHtml&&o.length===1&&o[0].type==="paragraph"){o=o[0].content}if(o.length===1&&o[0].type==="null"){o=[{type:"paragraph",content:[]}]}v.content[e+M].content.push({type:r.inHeader?"table_header":"table_cell",attrs:{colspan:r.colspan,rowspan:r.rowspan,colwidth:g?r.width:null,background:null},content:o})}}t.inline=false;if(e[1]){const n={type:"figure",attrs:{class:""},content:[{type:"figcaption",attrs:null,content:parseInline(e[1],t)},v]};if(e[4]){const t=floatRegEx.exec(e[4]);if(t){n.attrs.class=t[1]}}return n}else{return v}}};return{parsePipeTable:a(),PIPE_TABLE_REGEX:/^(?:: ((?:[^\n]|\n(?!\||:|<\/dl>))*)\n)?(\|.*)\n\|([-:]+[-| :]*)\n((?:\|.*(?:\n|$))*)(?:\{([^\n}]+)\}\n)?\n*/,parseGridTable:u(),GRID_TABLE_REGEX:/^(?:: ((?:[^\n]|\n(?!\+|:|<\/dl>))*)\n)?((\+(?:[-:=]+\+)+)\n(?:[+|][^\n]+[+|] *\n)+)(?:\{([^\n}]+)\}\n)?\n*/}}();const LINK_INSIDE="(?:\\[[^\\]]*\\]|[^\\[\\]]|\\](?=[^\\[]*\\]))*";const LINK_HREF_AND_TITLE="\\s*<?((?:\\([^)]*\\)|[^\\s\\\\]|\\\\.)*?)>?(?:\\s+['\"]([\\s\\S]*?)['\"])?\\s*";const linkIndex=e=>{for(let t=0;t<e.length;t++){if(e[t].type==="link"){return t}}};const resultRegEx=/[^]*/;const drawRegEx$1=/^draw\(/;const parseRef=function(e,t,n){let r=e[2]?e[2]:e[1];r=r.replace(/\s+/g," ");if(t._defs&&t._defs[r]){const e=t._defs[r];if(n.type==="figure"){n={type:"figure",attrs:e.attrs,content:[{type:"figimg",attrs:e.attrs},{type:"figcaption",content:parseInline(n.attrs.alt,t)}]};n.content[0].attrs.src=e.target;if(e.attrs.alt){n.content[0].attrs.alt=e.attrs.alt}}else if(n.type==="image"){if(drawRegEx$1.test(e.target)){const t=e.target.replace(/\\n/g,"\n");return{type:"calculation",attrs:{entry:t}}}else{n.attrs=e.attrs;n.attrs.src=e.target}}else{n.attrs.href=e.target}}return n};const parseTextMark=(e,t,n)=>{const r=parseInline(e,t);if(Array.isArray(r)&&r.length===0){return r}consolidate(r);for(const e of r){if(e.marks){e.marks.push({type:n})}else{e.marks=[{type:n}]}}return r};const BLOCK_HTML=/^ *(?:<(head|h[1-6]|p|pre|label|script|style|table)[\s>][\s\S]*?(?:<\/\1>[^\n]*\n)|<(?:\/?(?:!DOCTYPE html|body|li|br|hr|(?:div|article|details|input|ul|ol|dl|main|nav)(?: (?:class|id|name|style|type)=(["'])[A-Za-z0-9_.:;\- ]+\2){0,2})|\/?html(?: lang=(["'])[a-z]+\3)?)>[^\n]*?(?:\n|$))/;const rules=new Map;rules.set("html",{isLeaf:true,match:blockRegex(BLOCK_HTML),parse:function(e,t){if(!t.inHtml){return null}return{type:"html",text:e[0]}}});rules.set("htmlComment",{isLeaf:true,match:blockRegex(/^ *<!--[^>]+-->[^\n]*\n/),parse:function(e,t){return{type:"null"}}}),rules.set("lheading",{isLeaf:false,match:blockRegex(/^([^\n]+)\n *(=|-){3,} *(?:\n *)+\n/),parse:function(e,t){return{type:"heading",attrs:{level:e[2]==="="?1:2},content:parseInline(e[1].trim(),t)}}});rules.set("heading",{isLeaf:false,match:blockRegex(/^ *(#{1,6})([^\n]+?)#* *(?:\n *)+\n/),parse:function(e,t){return{attrs:{level:e[1].length},content:parseInline(e[2].trim(),t)}}});rules.set("dt",{isLeaf:false,match:blockRegex(/^(([^\n]*)\n)(?=<dd>|\n: [^\n]+\n[^|+])/),parse:function(e,t){return{content:parseInline(e[2].trim(),t)}}});rules.set("horizontal_rule",{isLeaf:true,match:blockRegex(/^( *[-*_]){3,} *(?:\n *)+\n/),parse:function(e,t,n){return{type:"horizontal_rule"}}});rules.set("codeBlock",{isLeaf:true,match:blockRegex(/^(?:(?:\t| {4})[^\n]+\n*)+(?:\n *)+\n/),parse:function(e,t){const n=e[0].replace(/^(\t| {4})/gm,"").replace(/\n+$/,"");return{type:"code_block",content:[{type:"text",text:n}]}}});rules.set("fence",{isLeaf:true,match:blockRegex(/^(```|~~~) *(?:(\S+) *)?\n([\s\S]+?)\n?\1 *(?:\n *)+\n/),parse:function(e,t){return{type:"code_block",content:[{type:"text",text:e[3]}]}}});rules.set("alert",{isLeaf:false,match:blockRegex(/^(?: *> \[!(NOTE|TIP|IMPORTANT|WARNING|EPIGRAPH)\])((?:\n *>(?! *\[!)[^\n]*)+)(?:\n *)+\n/),parse:function(e,t){const n=e[2].replace(/\n *> ?/gm,"\n").replace(/^\n/,"");const r=parse(n,t);return{type:e[1].toLowerCase(),content:r}}});rules.set("blockquote",{isLeaf:false,match:blockRegex(/^>([^\n]*(?:\n *>[^\n]*)*)(?:\n *)+\n/),parse:function(e,t){const n=e[1].replace(/\n *> ?/gm,"\n");return{content:parse(n,t)}}});rules.set("ordered_list",{isLeaf:false,match:blockRegex(/^( {0,3})(?:(?:(\d{1,9})|([A-Z])|([a-z]))[.)]) [\s\S]+?(?:\n{2,}(?! )(?!\1(?:\d{1,9}\.) )\n*|\s*$)/),parse:function(e,t){const n=e[2]?Number(e[2]):e[3]?e[3].codePointAt(0)-64:e[4].codePointAt(0)-96;const r=e[2]?"decimal":e[3]?"upper-alpha":"lower-alpha";return{attrs:{class:r,order:n},content:parseList(e[0],t)}}});rules.set("bullet_list",{isLeaf:false,match:blockRegex(/^( {0,3})([*+-]) [\s\S]+?(?:\n{2,}(?! )(?!\1(?:[*+-]) )\n*|\s*$)/),parse:function(e,t){return{content:parseList(e[0],t)}}});rules.set("special_div",{isLeaf:false,match:blockRegex(/^(:{3,}) ?(indented|comment|centered|right_justified|boxed|header|hidden) *\n([\s\S]+?)\n+\1 *(?:\n{2,}|\s*$)/),parse:function(e,t){const n=parse(e[3],t);return{type:e[2],content:n}}});rules.set("figure",{isLeaf:true,match:blockRegex(/^!!\[((?:(?:\\[\s\S]|[^\\])+?)?)\]\[([^\]]*)\] *(?:\n *)+\n/),parse:function(e,t){if(isNotAnInteger(e[1])){return parseRef(e,t,{type:"figure",attrs:{alt:e[1]}})}else{return parseRef(e,t,{type:"figure"})}}});rules.set("def",{isLeaf:true,match:blockRegex(/^\[([^\]\n]+)\]: *(?:(`+)([\s\S]*?[^`])\2(?!`)|<?([^\n>]*)>? *(?:\n\{([^\n}]*)\})?)/),parse:function(e,t){return{type:"null"}}});rules.set("toc",{isLeaf:true,match:blockRegex(/^{\.toc start=(\d) end=(\d)}\n/),parse:function(e,t){return{attrs:{start:Number(e[1]),end:Number(e[2]),body:[]}}}});rules.set("pipeTable",{isLeaf:false,match:blockRegex(TABLES.PIPE_TABLE_REGEX),parse:TABLES.parsePipeTable});rules.set("gridTable",{isLeaf:false,match:blockRegex(TABLES.GRID_TABLE_REGEX),parse:TABLES.parseGridTable});rules.set("dd",{isLeaf:false,match:blockRegex(/^:( +)[\s\S]+?(?:\n{2,}(?! |:)(?!\1)\n*|\s*$)/),parse:function(e,t){let n=" "+e[0].slice(1);const r=1+e[1].length;const o=new RegExp("^ {"+r+","+r+"}","gm");n=n.replace(o,"");return{content:parse(n,t)}}});rules.set("displayTeX",{isLeaf:true,match:blockRegex(/^\$\$\n?((?:\\[\s\S]|[^\\])+?)\n?\$\$ *(?:\n|$)/),parse:function(e,t){const n=e[1].trim();if(t.convertTex){const e=texToCalc(n);return{type:"calculation",attrs:{entry:e,displayMode:true}}}else{return{type:"tex",attrs:{tex:n,displayMode:true}}}}});rules.set("newline",{isLeaf:true,match:blockRegex(/^(?:\n *)*\n/),parse:function(){return{type:"null"}}});rules.set("emptyParagraph",{isLeaf:true,match:blockRegex(/^(?:\n *)+\n/),parse:function(e,t){return{type:"paragraph",content:[]}}});rules.set("paragraph",{isLeaf:false,match:blockRegex(/^((?:[^\n]|\n(?!(?: *\n|(?=[*+-] )|(?=(?:\d{1,9}|[A-Za-z])[.)] ))))+)\n(?:(?: *\n)+|(?=[*+-] )|(?=(?:\d{1,9}|[A-Za-z])[.)] ))/),parse:function(e,t){return{type:"paragraph",content:parseInline(e[1],t)}}});rules.set("escape",{isLeaf:true,match:inlineRegex(/^\\([^0-9A-Za-z\s])/),parse:function(e,t){return{type:"text",text:e[1]}}});rules.set("tableSeparator",{isLeaf:true,match:function(e,t){if(!t.inTable){return null}return/^ *\| */.exec(e)},parse:function(){return{type:"tableSeparator"}}});rules.set("link",{isLeaf:true,match:inlineRegex(new RegExp("^\\[("+LINK_INSIDE+")\\]\\("+LINK_HREF_AND_TITLE+"\\)")),parse:function(e,t){const n=parseTextMark(e[1],t,"link")[0];const r=linkIndex(n.marks);n.marks[r].attrs={href:unescapeUrl(e[2])};return n}});rules.set("image",{isLeaf:true,match:inlineRegex(new RegExp("^!\\[("+LINK_INSIDE+")\\]\\("+LINK_HREF_AND_TITLE+"\\)")),parse:function(e,t){if(isNotAnInteger(e[1])){return{attrs:{alt:e[1],src:unescapeUrl(e[2])}}}else{return{attrs:{src:unescapeUrl(e[2])}}}}});rules.set("reflink",{isLeaf:true,match:inlineRegex(/^\[((?:(?:\\[\s\S]|[^\\])+?)?)\]\[([^\]]*)\]/),parse:function(e,t){const n=e[2]?e[2]:e[1];const r=parseTextMark(e[1],t,"link")[0];const o=linkIndex(r.marks);r.marks[o].attrs={href:t._defs[n].target};return r}});rules.set("footnote",{isLeaf:true,match:inlineRegex(/^\[\^(\d+)\]/),parse:function(e,t){const n=Number(e[1])-1;return{type:"footnote",content:parseInline(t.footnotes[n],t)}}});rules.set("refimage",{isLeaf:true,match:inlineRegex(/^!\[((?:(?:\\[\s\S]|[^\\])+?)?)\]\[([^\]]*)\]/),parse:function(e,t){return parseRef(e,t,{type:"image",attrs:{alt:e[1]}})}});rules.set("autolink",{isLeaf:true,match:inlineRegex(/^<([^: >]+:\/[^ >]+)>/),parse:function(e,t){const n=parseTextMark(e[1],t,"link")[0];const r=linkIndex(n.marks);n.marks[r].attrs={href:unescapeUrl(e[1])};return n}});rules.set("code",{isLeaf:true,match:inlineRegex(/^(`+)([\s\S]*?[^`])\1(?!`)/),parse:function(e,t){const n=e[2].trim();return[{type:"text",text:n,marks:[{type:"code"}]}]}});rules.set("tex",{isLeaf:true,match:inlineRegex(/^(?:\$\$((?:\\[\s\S]|[^\\])+?)\$\$|\$(`+)((?:(?:\\[\s\S]|[^\\])+?)?)\2\$(?![0-9$])|\$(?!\s|\$)((?:(?:\\[\s\S]|[^\\])+?)?)(?<=[^\s\\$])\$(?![0-9$]))/),parse:function(e,t){if(e[1]){const n=e[1].trim();if(t.convertTex){const e=texToCalc(n);return{type:"calculation",attrs:{entry:e,displayMode:true}}}else{return{type:"tex",attrs:{tex:n,displayMode:true}}}}else{const n=(e[3]?e[3]:e[4]).trim();if(t.convertTex){const e=texToCalc(n);return{type:"calculation",attrs:{entry:e,displayMode:false}}}else{return{type:"tex",attrs:{tex:n,displayMode:false}}}}}});rules.set("calculation",{isLeaf:true,match:anyScopeRegex(/^(?:(\?\?|\?|%%|%|@@|@)?(`+)([\s\S]*?[^`])\2(?!`)|(\?\?|\?|%%|%|@@|@)?\n?((?:\\[\s\S]|[^\\])+?)\n?)/),parse:function(e,t){if(e[3]){let t=e[3].trim();if(e[1]){t=t.replace(resultRegEx,e[1])}if(!/^(?:function|draw\()/.test(t)&&t.indexOf("``")===-1){t=t.replace(/\n/g," ")}return{attrs:{entry:t}}}else{let t=e[5].trim();if(e[4]){t=t.replace(resultRegEx,e[4])}return{attrs:{entry:t,displayMode:true}}}}});rules.set("em",{isLeaf:true,match:inlineRegex(/^([_*])(?!\s|\1)((?:\\[\s\S]|[^\\])+?)\1/),parse:function(e,t){return parseTextMark(e[2],t,"em")}});rules.set("strong",{isLeaf:true,match:inlineRegex(/^(\*\*|__)(?=\S)((?:\\[\s\S]|[^\\])+?)\1/),parse:function(e,t){return parseTextMark(e[2],t,"strong")}});rules.set("del",{isLeaf:true,match:inlineRegex(/^<del>([\s\S]*?)<\/del>/),parse:function(e,t){return parseTextMark(e[1],t,"strikethru")}});rules.set("strikethru",{isLeaf:true,match:inlineRegex(/^~~(?=\S)((?:\\[\s\S]|~(?!~)|[^\s~\\]|\s(?!~~))+?)~~/),parse:function(e,t){return parseTextMark(e[1],t,"strikethru")}});rules.set("superscript",{isLeaf:true,match:inlineRegex(/^<sup>([\s\S]*?)<\/sup>/),parse:function(e,t){return parseTextMark(e[1],t,"superscript")}});rules.set("carat",{isLeaf:true,match:inlineRegex(/^\^((?:\\[\s\S]|[^\\])+?)\^/),parse:function(e,t){return parseTextMark(e[1],t,"superscript")}});rules.set("subscript",{isLeaf:true,match:inlineRegex(/^<sub>([\s\S]*?)<\/sub>/),parse:function(e,t){return parseTextMark(e[1],t,"subscript")}});rules.set("tilde",{isLeaf:true,match:inlineRegex(/^~((?:\\[\s\S]|[^\\])+?)~/),parse:function(e,t){return parseTextMark(e[1],t,"subscript")}});rules.set("underline",{isLeaf:true,match:inlineRegex(/^<u>([\s\S]*?)<\/u>/),parse:function(e,t){return parseTextMark(e[1],t,"underline")}});rules.set("highlight",{isLeaf:true,match:inlineRegex(/^<mark>([\s\S]*?)<\/mark>/),parse:function(e,t){return parseTextMark(e[1],t,"highlight")}});rules.set("hard_break",{isLeaf:true,match:anyScopeRegex(/^(\\| {2})\n/),parse:function(){return{text:"\n"}}});rules.set("inline_break",{isLeaf:true,match:anyScopeRegex(/^<br>/),parse:function(){return{type:"hard_break",text:"\n"}}});rules.set("span",{isLeaf:true,match:inlineRegex(/^<span [a-z =":]+>[^<]+<\/span>/),parse:function(e,t){return!t.inHtml?null:{type:"html",text:e[0]}}});rules.set("text",{isLeaf:true,match:anyScopeRegex(/^[\s\S]+?(?=[_*`#>|\\\-+=![({$<~^+:]|\n\n| {2,}\n|\d+[.)]|\w+:\S|$)/),parse:function(e,t){return{text:e[0].replace(/\n/g," ")}}});const parse=(e,t)=>{if(!t.inline){e+="\n\n"}e=preprocess(e);const n=[];while(e){let r=null;let o=null;let i=null;for(const[n,s]of rules){r=s.match(e,t);if(r){i=s;o=n;break}}const s=i.parse(r,t);if(Array.isArray(s)){Array.prototype.push.apply(n,s)}else{if(s.type==null){s.type=o}n.push(s)}t.prevCapture=r[0];e=e.substring(r[0].length)}return n};const parseInline=function(e,t){const n=t.inline||false;t.inline=true;const r=parse(e,t);t.inline=n;return r};const LIST_BULLET="(?:[*+-]|(?:\\d+|[A-Za-z])[\\.\\)])";const LIST_ITEM_PREFIX="( *)("+LIST_BULLET+") +";const LIST_ITEM_PREFIX_R=new RegExp("^"+LIST_ITEM_PREFIX);const LIST_ITEM_R=new RegExp(LIST_ITEM_PREFIX+"[^\\n]*(?:\\n"+"(?!\\1"+LIST_BULLET+" )[^\\n]*)*(\n|$)","gm");const BLOCK_END_R=/\n{2,}$/;const LIST_BLOCK_END_R=BLOCK_END_R;const LIST_ITEM_END_R=/ *\n+$/;const consolidate=e=>{if(Array.isArray(e)&&e.length>0){for(let t=e.length-1;t>0;t--){const n=e[t];const r=e[t-1];if(n.type==="text"&&r.type==="text"&&!n.marks&&!r.marks){r.text+=n.text;e.splice(t,1)}else if(n.type==="indented"&&r.type==="indented"||n.type==="centered"&&r.type==="centered"){r.content=r.content.concat(n.content);e.splice(t,1)}else if(n.type==="null"){e.splice(t,1)}else if(!rules.has(n.type)||!rules.get(n.type).isLeaf){consolidate(n.content)}}if(!rules.has(e[0].type)||!rules.get(e[0].type).isLeaf){consolidate(e[0].content)}}};const populateTOC=e=>{let t;for(const n of e){if(n.type==="toc"){t=n;break}}if(!t){return}const n=t.attrs.start;const r=t.attrs.end;for(const o of e){if(o.type==="heading"){const e=o.attrs.level;if(n<=e&&e<=r){const n=[];let r="";for(const e of o.content){r+=e.text}n.push(r);n.push(e);n.push(0);n.push(0);t.attrs.body.push(n)}}}};const metadataRegEx=/^---+\n((?:[A-Za-z0-9][A-Za-z0-9 _-]*:[^\n]+\n(?:[ \t]+[^\n]+\n)*)+)---+\n/;const metadataItemRegEx=/^[A-Za-z0-9][A-Za-z0-9 _-]*:[^\n]+\n(?:[ \t]+[^\n]+\n)*/;const hurmetMetadataNames=["decimalFormat","dateFormat","fontSize","pageSize","saveDate"];const parseMetadata=e=>{const t={};let n=e.match(metadataItemRegEx);while(n){const r=n[0].split(":");const o=r[0].trim().replace(/ /g,"");if(hurmetMetadataNames.includes(o)){const e=r[1].slice(0,-1).trim().replace(/ *\n[ \t]*/g," ");t[o]=e}e=e.slice(n[0].length);n=e.match(metadataItemRegEx)}return t};const dateMessageRegEx=/^date:([^\n]+)\nmessage:([^\n]+)\n/;const inlineMd2ast=e=>{const t={inline:true,_defs:{},prevCapture:"",inList:false,inHtml:false};const n=parse(e,t);if(Array.isArray(n)&&n.length>0&&n[0].type==="null"){n.shift()}consolidate(n);return n};const md2ast=(e,t=false,n=false)=>{let r=false;if(metadataRegEx.test(e)){const t=metadataRegEx.exec(e);r=parseMetadata(t[1]);e=e.slice(t[0].length)}const o={inline:false,inList:false,_defs:{},footnotes:[],prevCapture:"",inHtml:t,convertTex:n};const i=/\n *\[([^\]\n]+)\]: *([^\n]*) *(?:\n\{([^\n}]*)\})?(?=\n)/gm;const s=/\n *\[\^\d+\]: *([^\n]*)(?=\n)/gm;let a;while((a=i.exec(e))!==null){const e=a[1].replace(/\s+/g," ");const t=a[2].trim();const n=a[3]||"";const r=isNotAnInteger(e)?{alt:e}:{};if(n){const e=CLASS_R.exec(n);const t=WIDTH_R.exec(n);const o=ALT_R.exec(n);const i=ID_R.exec(n);if(e){r.class=e[1]}if(t){r.width=t[1]}if(o){r.alt=o[1]}if(i){r.id=i[1]}}o._defs[e]={target:t,attrs:r}}a=null;while((a=s.exec(e))!==null){o.footnotes.push(a[1].trim())}let l=[];let c=false;if(r){l=e.split("\x3c!--SNAPSHOT--\x3e\n");if(l.length>1){c=true;e=l.shift()}}let d=[];if(r){d=e.split("\x3c!--FALLBACKS--\x3e\n");if(d.length>1){e=d.shift()}else{d=null}}const u=parse(e,o);if(Array.isArray(u)&&u.length>0&&u[0].type==="null"){u.shift()}consolidate(u);populateTOC(u);if(r){if(d){r.fallbacks=JSON.parse(d.pop().trim())}if(c){const e=[];for(const t of l){const n=dateMessageRegEx.exec(t);e.push({date:n[1]?Date.parse(n[1].trim()):undefined,message:n[2]?n[2].trim():undefined,content:n?t.slice(n[0].length):t})}r.snapshots=e}return{type:"doc",attrs:r,content:u}}else{return u}};const sanitizeUrl=function(e){if(e==null){return null}try{const t=decodeURIComponent(e).replace(/[^A-Za-z0-9/:]/g,"").toLowerCase();if(t.indexOf("javascript:")===0||t.indexOf("vbscript:")===0||t.indexOf("data:")===0){return null}}catch(e){return null}return e};const SANITIZE_TEXT_R=/[<>&"']/g;const SANITIZE_TEXT_CODES={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&#x27;","/":"&#x2F;","`":"&#96;"};const sanitizeText=function(e){return String(e).replace(SANITIZE_TEXT_R,(function(e){return SANITIZE_TEXT_CODES[e]}))};const htmlTag=(e,t,n={},r=true)=>{let o="";for(const e in n){if(Object.prototype.hasOwnProperty.call(n,e)){const t=n[e];if(t){const n=e==="src"?t.replace(/</g,"%3C").replace(/>/g,"%3E"):sanitizeText(t);o+=" "+sanitizeText(e)+'="'+n+'"'}}}const i="<"+e+o+">";if(r){if(t.charAt(t.length-1)==="\n"){t=t.slice(0,-1)}return i+t+"</"+e+">"}else{return i}};const tagName={em:"em",strong:"strong",code:"code",strikethru:"del",subscript:"sub",superscript:"sup",underline:"u",highlight:"mark"};const quoteRegEx=/"/g;const dataStr=e=>{if(e.indexOf("'")===-1){return`'${e}'`}else if(e.indexOf('"')===-1){return`"${e}"`}else{return`"${e.replace(quoteRegEx,"&quot;")}"`}};const writeSVG=e=>{let t='<svg xmlns="http://www.w3.org/2000/svg"';Object.keys(e.attrs).forEach((n=>{t+=` ${n}='${e.attrs[n]}'`}));t+=">\n";e.children.forEach((e=>{t+=`<${e.tag}`;Object.keys(e.attrs).forEach((n=>{if(e.tag!=="title"){t+=` ${n}='${e.attrs[n]}'`}}));t+=">\n";if(e.tag==="text"){e.children.forEach((e=>{t+="<tspan";if(e.attrs){Object.keys(e.attrs).forEach((n=>{t+=` ${n}='${e.attrs[n]}'`}))}t+=`>${sanitizeText(e.text)}</tspan>`}))}else if(e.tag==="defs"){t+=`<style>${sanitizeText(e.style)}</style>`}else if(e.tag==="title"){t+=sanitizeText(e.attrs.text)}t+=`</${e.tag}>\n`}));t+="</svg>";return t};const functionOrModuleRegEx$1=/^ *(?:function|module) /;const writeTOC=e=>{let t="<ul class='toc'>\n";for(const n of e.attrs.body){let e="  <li";if(n[1]>0){e+=` style= 'margin-left: ${String(1.5*n[1])}em'`}e+=`><span>${n[0]}</span><span>0</span></li>\n`;t+=e}return t+"</ul>\n"};const headingText=e=>{let t="";for(const n of e){if(n.type&&n.type==="text"){t+=n.text}}return sanitizeText(t)};const headings=[];const nodes$1={html(e){return e.text},heading(e){const t=headingText(e.content);let n="h"+e.attrs.level;n=htmlTag(n,t);if(!headings.includes(t)){n=n.slice(0,3)+" id='"+t.toLowerCase().replace(/,/g,"").replace(/\s+/g,"-")+"'"+n.slice(3);headings.push(t)}return n+"\n"},paragraph(e){return htmlTag("p",ast2html(e.content))+"\n"},blockquote(e){return htmlTag("blockquote",ast2html(e.content))},code_block(e){return htmlTag("pre",htmlTag("code",sanitizeText(e.content[0].text)))},hard_break(e){return"<br>"},def(e){return""},newline(e){return"\n"},horizontal_rule(e){return"<hr>\n"},ordered_list(e){const t={class:e.attrs.class,start:e.attrs.order};return htmlTag("ol",ast2html(e.content),t)+"\n"},bullet_list(e){return htmlTag("ul",ast2html(e.content))+"\n"},list_item(e){return htmlTag("li",ast2html(e.content))+"\n"},tight_list_item(e){return htmlTag("li",ast2html(e.content),{class:"tight"})+"\n"},table(e){const t="dtype"in e.attrs&&e.attrs.dtype===dt.SPREADSHEET?{class:e.attrs.class,dtype:dt.SPREADSHEET}:{class:e.attrs.class};return htmlTag("table",ast2html(e.content),t)+"\n"},colGroup(e){return"\n"+htmlTag("colgroup",ast2html(e.content),e.attrs)+"\n"},col(e){return htmlTag("col","",e.attrs[0],false)},table_row(e){return htmlTag("tr",ast2html(e.content))+"\n"},table_header(e){const t={};if(e.attrs.colspan!==1){t.colspan=e.attrs.colspan}if(e.attrs.rowspan!==1){t.rowspan=e.attrs.rowspan}return htmlTag("th",ast2html(e.content),t)+"\n"},table_cell(e){const t={};if(e.attrs.colspan!==1){t.colspan=e.attrs.colspan}if(e.attrs.rowspan!==1){t.rowspan=e.attrs.rowspan}return htmlTag("td",ast2html(e.content),t)},spreadsheet_cell(e){const t=e.attrs.display?e.attrs.display:e.attrs.entry;return`<div class='hurmet-cell' data-entry=${dataStr(e.attrs.entry)}>`+t+"</div>"},link(e){const t={href:sanitizeUrl(e.attrs.href),title:e.attrs.title};return htmlTag("a",ast2html(e.content),t)},image(e){const t={src:e.attrs.src};if(e.attrs.alt){t.alt=e.attrs.alt}if(e.attrs.class){t.class=e.attrs.class}if(e.attrs.id){t.id=e.attrs.id}if(e.attrs.width){t.width=e.attrs.width}return htmlTag("img","",t,false)},figure(e){return htmlTag("figure",ast2html(e.content))+"\n"},figcaption(e){return htmlTag("figcaption",ast2html(e.content))},figimg(e){const t={src:e.attrs.src,class:"figimg"};if(e.attrs.alt){t.alt=e.attrs.alt}if(e.attrs.id){t.id=e.attrs.id}if(e.attrs.width){t.width=e.attrs.width}return htmlTag("img","",t,false)+"\n"},footnote(e){return htmlTag("footnote","")},calculation(e){if(e.attrs.dtype&&e.attrs.dtype===dt.DRAWING){const t=writeSVG(e.attrs.resultdisplay);const n=t.indexOf('float="right"'>-1)?" style='float: right;'":"";return`<span class='hurmet-calc' data-entry=${dataStr(e.attrs.entry)}${n}>`+`${t}</span>`}else if(e.attrs.dtype&&e.attrs.dtype===dt.MODULE&&functionOrModuleRegEx$1.test(e.attrs.entry)){return`<span class='hurmet-calc' data-entry=${dataStr(e.attrs.entry)}>`+`<span class='hmt-code'>${sanitizeText(e.attrs.entry)}</span></span>`}else{const t=e.attrs.tex?e.attrs.tex:parse$1(e.attrs.entry);const n=globalThis.temml.renderToString(t,{trust:true,wrap:"=",displayMode:e.attrs.displayMode||false});const r=e.attrs.displayMode?"p":"span";return`<${r} class='hurmet-calc' data-entry=${dataStr(e.attrs.entry)}>`+`${n}</${r}>`}},tex(e){const t=globalThis.temml.renderToString(e.attrs.tex,{trust:true,displayMode:e.attrs.displayMode||false});const n=e.attrs.displayMode?"p":"span";return`<${n} class='hurmet-tex' data-entry=${dataStr(e.attrs.tex)}>`+`${t}</${n}>`},indented(e){return htmlTag("div",ast2html(e.content),{class:"indented"})+"\n"},boxed(e){return htmlTag("div",ast2html(e.content),{class:"boxed"})+"\n"},centered(e){return htmlTag("div",ast2html(e.content),{class:"centered"})+"\n"},right_justified(e){return htmlTag("div",ast2html(e.content),{class:"right_justified"})+"\n"},hidden(e){return htmlTag("div",ast2html(e.content),{class:"hidden"})+"\n"},epigraph(e){return htmlTag("blockquote",ast2html(e.content),{class:"epigraph"})+"\n"},note(e){return htmlTag("div",ast2html(e.content),{class:"note"})+"\n"},tip(e){return htmlTag("div",ast2html(e.content),{class:"tip"})+"\n"},important(e){return htmlTag("div",ast2html(e.content),{class:"important"})+"\n"},warning(e){return htmlTag("div",ast2html(e.content),{class:"warning"})+"\n"},header(e){return htmlTag("header",ast2html(e.content))+"\n"},toc(e){return writeTOC(e)},comment(e){return htmlTag("aside",ast2html(e.content),{class:"comment"})+"\n"},dt(e){let t=ast2html(e.content);let n=htmlTag("dt",t);const r=t.indexOf("(");if(r>-1){t=t.slice(0,r).replace("_","-")}n=n.slice(0,3)+" id='"+t.toLowerCase().replace(/\s+/g,"-")+"'"+n.slice(3);return n+"\n"},dd(e){return htmlTag("dd",ast2html(e.content))+"\n"},text(e){const t=sanitizeText(e.text);if(!e.marks){return t}else{let n=t;for(const t of e.marks){if(t.type==="link"){let e=`<a href='${t.attrs.href}'`;if(t.attrs.title){e+=` title='${t.attrs.title}''`}n=e+">"+n+"</a>"}else{const e=tagName[t.type];n=`<${e}>${n}</${e}>`}}return n}}};const getFootnotes=(e,t)=>{if(Array.isArray(e)){for(let n=0;n<e.length;n++){getFootnotes(e[n],t)}}else if(e&&e.type==="footnote"){t.push(e.content)}else if(e.hasOwnProperty("content")){for(let n=0;n<e.content.length;n++){getFootnotes(e.content[n],t)}}};const ast2html=e=>{let t="";if(Array.isArray(e)){for(let n=0;n<e.length;n++){t+=ast2html(e[n])}}else if(e&&e.type==="doc"){t+=ast2html(e.content)}else if(e&&e.type!=="null"){t+=nodes$1[e.type](e)}return t};const ast2text=e=>{let t="";if(Array.isArray(e)){for(let n=0;n<e.length;n++){t+=ast2text(e[n])}}else if(typeof e==="object"&&"content"in e){for(let n=0;n<e.content.length;n++){t+=ast2text(e.content[n])}}else if(e&&e.type==="text"){t+=e.text}else if(e&&e.type==="hard_break"){t+="\n"}else if(e&&e.type!=="null"){t+=""}return t};const md2text=e=>{const t=md2ast(e,false);return ast2text(t)};const md2html=(e,t=false)=>{const n=md2ast(e,t);let r=ast2html(n);const o=[];getFootnotes(n,o);if(o.length>0){r+="\n<hr>\n<ol>\n";for(const e of o){r+="<li><p>"+ast2html(e)+"</p></li>\n"}r+="</ol>\n"}return r};const headsRegEx=/^H[1-6]$/;const levelRegEx=/(\d+)(?:[^\d]+(\d+))?/;const forToC=0;const forPrint=1;const bottomOf=e=>{let t=e.getBoundingClientRect().bottom;const n=e.getElementsByTagName("img");for(let e=0;e<n.length;e++){t=Math.max(t,n[e].getBoundingClientRect().bottom)}const r=e.getElementsByTagName("svg");for(let e=0;e<r.length;e++){t=Math.max(t,r[e].getBoundingClientRect().bottom)}return t};const findTOC=e=>{let t=undefined;let n=0;e.nodesBetween(0,e.content.size,(function(e,r){if(e.type.name==="toc"){t=e;n=r}}));return[t,n]};const tocLevels=(e,t)=>{const n=e.match(levelRegEx);t.tocStartLevel=Number(n[1]);t.tocEndLevel=Number(n[2]?n[2]:t.tocStartLevel)};const footnoteContents=e=>{let t="";let n="";for(const r of e){t+=r.text;let e=sanitizeText(r.text);for(const t of r.marks){const n=tagName[t.type.name];e=`<${n}>${e}</${n}>`}n+=e}return{text:t,innerHTML:n}};const renderToC=(e,t)=>{t.innerHTML="";t.className="toc";for(const n of e){const e=document.createElement("li");if(n[1]>0){e.style.marginLeft=String(1.5*n[1])+"em"}const r=document.createElement("span");r.textContent=n[0].trim();e.appendChild(r);const o=document.createElement("span");o.textContent=String(n[2]).trim();e.appendChild(o);t.appendChild(e)}};const getDraftTocArray=(e,t)=>{const n=[];e.nodesBetween(0,e.content.size,(function(e,r){if(e.type.name==="heading"&&t.tocStartLevel<=e.attrs.level&&e.attrs.level<=t.tocEndLevel){n.push([e.textContent,e.attrs.level,-1])}}));return n};const numHeads=(e,t)=>{if(t.tocEndLevel===0){return 0}let n=0;for(let r=t.tocStartLevel;r<=t.tocEndLevel;r++){const t=e.getElementsByTagName("H"+String(r));n+=t.length}return n};const getElementFootnoteData=(e,t,n)=>{t.ftNote.numFtNotesInElem=0;t.ftNote.elemNotesHeight=0;const r=e.querySelectorAll("footnote");if(r.length>0){if(t.ftNote.end===-1){t.ftNote.elemNotesHeight+=t.ftNote.hrHeight;t.ftNote.end=t.ftNote.start-1}for(let e=t.ftNote.totalNum;e<t.ftNote.totalNum+r.length;e++){const r=t.footnotes[e].text;const o=Math.ceil(n.measureText(r).width/615);t.ftNote.elemNotesHeight+=o*t.ftNote.lineBoxHeight+t.ftNote.botMargin;t.ftNote.numFtNotesInElem+=1}}};const isOrphan=(e,t)=>{if(!e){return false}const n=e.getBoundingClientRect();if(t.pageHeight-t.headerHeight-t.ftNote.pageNotesHeight-t.minElemHeight-t.tocAdjustment<n.top-t.pageTop){return true}if(e.tagName==="DIV"&&e.className==="tableWrapper"){if(t.pageHeight-t.headerHeight-t.ftNote.pageNotesHeight-t.tocAdjustment<n.bottom-t.pageTop){return true}}let r=n.top;const o=e.getElementsByTagName("img");if(o.length>0){r=o[0].getBoundingClientRect().bottom}const i=e.getElementsByTagName("svg");if(i.length>0){r=Math.max(r,i[0].getBoundingClientRect().bottom)}return t.pageHeight-t.headerHeight-t.ftNote.pageNotesHeight-t.tocAdjustment<r-t.pageTop};const populatePage=(e,t,n,r,o)=>{const i=document.createDocumentFragment();if(n&&o.pageNum>0){const e=n.cloneNode(true);e.style.breakBefore="page";i.append(e)}const s=document.createElement("div");s.className="print-body";if(!(n&&o.pageNum>0)){s.style.breakBefore="page"}const a=new Range;if(o.pageTopChild===-1||o.pageTopChild===0&&o.pageTopOffset===0){a.setStartBefore(e)}else{a.setStart(e.childNodes[o.pageTopChild],o.pageTopOffset)}if(o.pageBottomChild===-1){a.setEndAfter(t)}else{a.setEnd(t.childNodes[o.pageBottomChild],o.pageBottomOffset)}s.appendChild(a.cloneContents());if(o.listIndex>=0){const e=s.getElementsByTagName("OL");e[0].setAttribute("start",String(o.listIndex+2))}i.appendChild(s);const l=numHeads(s,o);if(l>0){let e=0;for(let t=0;t<o.tocArray.length;t++){if(o.tocArray[t][2]===-1){e=t;break}}for(let t=0;t<l;t++){o.tocArray[e][2]=o.pageNum;e+=1}}if(o.ftNote.end>=0){const e=t.getBoundingClientRect().bottom-o.pageTop;const n=o.pageHeight-o.headerHeight-e-o.ftNote.pageNotesHeight;if(n>0){const e=document.createElement("div");e.style.height=n-2+"px";i.append(e)}i.append(document.createElement("hr"));const r=document.createElement("ol");if(o.ftNote.start>0){r.setAttribute("start",String(o.ftNote.start+1))}for(let e=o.ftNote.start;e<=o.ftNote.end;e++){const t=document.createElement("p");t.innerHTML=o.footnotes[e].innerHTML;const n=document.createElement("li");n.appendChild(t);r.appendChild(n)}i.append(r)}r.append(i);o.listIndex=t.tagName==="LI"&&t.parentElement.tagName==="OL"?[...t.parentElement.children].indexOf(t):-1;return};const turnThePage=(e,t,n)=>{t.headerHeight=t.stdHdrHeight;t.ftNote.pageNotesHeight=0;t.ftNote.start=t.ftNote.totalNum;t.ftNote.end=-1;t.pageNum+=1;if(e){if(t.pageBottomChild>=0&&t.pageBottomOffset>0){const n=new Range;const r=e.childNodes[t.pageBottomChild];n.setStart(r,t.pageBottomOffset);n.setEnd(r,t.pageBottomOffset+1);t.pageTop=n.getBoundingClientRect().top;t.topMargin=0}else{t.pageTop=e.getBoundingClientRect().top;const n=window.getComputedStyle(e);t.topMargin=n.marginTop}}else{t.pageTop=n.getBoundingClientRect().bottom}t.pageTopChild=t.pageBottomChild;t.pageTopOffset=t.pageBottomOffset;t.pageBottomChild=-1;t.pageBottomOffset=0;return[e,null]};function paginate(e,t,n,r,o){function i(e){const t=e.children;for(let e=0;e<t.length;e++){const n=t[e];const r=bottomOf(n);c.tocAdjustment=0;if(d&&c.pageTop<=c.tocTop&&c.tocTop<r){c.tocAdjustment=u}const o=n.getBoundingClientRect();let s=n;let p=s.nextElementSibling;while(p===null&&s.className!=="editor"){s=s.parentElement;p=s.nextElementSibling}getElementFootnoteData(n,c,b);if(n.tagName==="H1"&&o.top-c.pageTop>.75*c.pageHeight){populatePage(m,g,l,h,c);[m,g]=turnThePage(n,c,a)}else if(headsRegEx.test(n.tagName)&&isOrphan(p,c)){populatePage(m,g,l,h,c);[m,g]=turnThePage(n,c,a)}else if((n.tagName==="OL"||n.tagName==="UL")&&o.botton-c.pageTop<32){populatePage(m,g,l,h,c);[m,g]=turnThePage(n,c,a)}else if(c.pageHeight-c.headerHeight-c.ftNote.pageNotesHeight-c.ftNote.elemNotesHeight>=r+c.tocAdjustment-c.pageTop){g=n;c.ftNote.pageNotesHeight+=c.ftNote.elemNotesHeight;c.ftNote.totalNum+=c.ftNote.numFtNotesInElem;c.ftNote.end+=c.ftNote.numFtNotesInElem}else if(n.tagName!=="P"&&n.tagName!=="PRE"&&!(n.tagName==="DIV"&&n.className==="tableWrapper")){i(n)}else if((n.tagName==="P"||n.tagName==="PRE")&&o.height>64){const e=n.tagName==="PRE"?n.childNodes[0]:n;const t=c.pageTop+c.pageHeight-c.headerHeight-c.ftNote.pageNotesHeight-c.ftNote.elemNotesHeight-c.tocAdjustment;const[r,o]=findParagraphOverflowPoint(e,t);if(r===-1||r===0&&o===0){populatePage(m,g,l,h,c);[m,g]=turnThePage(n,c,a)}else{c.pageBottomChild=r;c.pageBottomOffset=o;populatePage(m,n,l,h,c);[m,g]=turnThePage(n,c,a)}}else{populatePage(m,g,l,h,c);[m,g]=turnThePage(n,c,a)}}}const s=e.state.doc;const[a]=document.getElementsByClassName("ProseMirror-setup");let l=null;const c={pageNum:0,pageTop:0,pageHeight:0,minElemHeight:3.2*s.attrs.fontSize,stdHdrHeight:0,headerHeight:0,tocArray:null,tocStartLevel:r,tocEndLevel:o,tocAdjustment:0,ftNote:{totalNum:0,start:0,end:-1,pageNotesHeight:0},footNotes:[],listIndex:-1,pageTopChild:-1,pageTopOffset:0,pageBottomChild:-1,pageBottomOffset:0};let d=false;let u=0;const[p,f]=findTOC(s);if(r||p){if(p&&!r){c.tocStartLevel=p.attrs.start;c.tocEndLevel=p.attrs.end}c.tocArray=getDraftTocArray(s,c);if(!p||p.attrs.body.length!==c.tocArray.length){d=true;const e=a.getElementsByClassName("toc");if(e.length>0){c.tocTop=e[0].getBoundingClientRect().top}const t=s.attrs.fontSize===10?16:19.195;if(p){u=(c.tocArray.length-p.attrs.body.length)*t}else{const e=s.attrs.fontSize===10?20:24;u=c.tocArray.length*t+e}}}c.pageHeight=(s.attrs.pageSize==="letter"?11*96:297/25.4*96)-121;c.pageTop=a.children[0].getBoundingClientRect().top;const h=document.getElementById("print-div");h.innerHTML="";let m=a.children[0];let g=null;c.pageNum=0;if(s.nodeAt(0).type.name==="header"){l=document.getElementsByTagName("header")[0].children[0].children[0].cloneNode(true);l.classList.add("header");l.innerHTML=l.innerHTML.replace("$PAGE",'&nbsp;<span class="page-display"></span>');const e=document.getElementsByTagName("header")[0];const t=e.getBoundingClientRect();c.stdHdrHeight=t.bottom-t.top}const y=document.createElement("canvas");const b=y.getContext("2d");b.font=`${String(s.attrs.fontSize)}pt Calibri, san-serif`;c.ftNote.hrHeight=s.attrs.fontSize===12?33:29;c.ftNote.lineBoxHeight=s.attrs.fontSize===12?19.2:16;c.ftNote.botMargin=s.attrs.fontSize===12?16:13.333;s.nodesBetween(0,s.content.size,(function(e,t){if(e.type.name==="footnote"){c.footnotes.push(footnoteContents(e.content.content))}}));i(a);populatePage(m,a.lastChild,l,h,c);if(c.tocArray&&n===forPrint){const n={start:p.attrs.start,end:p.attrs.end,body:c.tocArray};const r=e.state.tr;r.replaceWith(f,f+1,t.createAndFill(n));e.dispatch(r);const o=a.getElementsByClassName("toc")[0];const i=h.getElementsByClassName("toc")[0];i.innerHTML=o.innerHTML}return c.tocArray}const binarySearchForOverflow=(e,t)=>{let n=0;let r=e.length;let o=Math.floor(e.length/2);const i=new Range;i.setStart(e,0);const s=new Range;s.setEnd(e,e.length);let a;let l;while(r-n>2){i.setStart(e,n);i.setEnd(e,n+o);a=i.getBoundingClientRect();if(a.bottom<t){if(t-a.bottom<40){return n+o}n=n+o;o=Math.floor((r-n)/2)}else{s.setStart(e,n+o);s.setEnd(e,r);l=s.getBoundingClientRect();if(l.top>t){r=n+o;o=Math.floor((r-n)/2)}else{return Math.max(n+o-280,0)}}}return n+o};const nonBreak=/^[\S\u202F\u00A0]$/;const linearSearchForOverflow=(e,t,n)=>{const r=e.wholeText;let o="";const i=new Range;i.setStart(e,n);let s=n;let a=0;for(let e=n;e<r.length;e++){o=r.slice(e,e+1);if(nonBreak.test(o)){a=e;s=e-1;break}}for(let n=a;n<r.length;n++){o=r.slice(n,n+1);if(!nonBreak.test(o)){i.setEnd(e,n);if(i.getBoundingClientRect().bottom>t){for(let e=s+1;e<r.length;e++){o=r.slice(e,e+1);if(nonBreak.test(o)){return e-1}}return e.length}s=n-1}}return e.length};const unsplittableClasses=["hurmet-calc","hurmet-tex"];const unsplittableTags=["IMG","FIGCAPTION","BR","FOOTNOTE"];const findParagraphOverflowPoint=(e,t)=>{const n=new Range;for(let r=0;r<e.childNodes.length;r++){const o=e.childNodes[r];let i;if(o.nodeType===3){n.setStartBefore(o);n.setEndAfter(o);i=n.getBoundingClientRect()}else{i=o.getBoundingClientRect()}if(i.bottom<t){continue}if(o.nodeType===3){let e=binarySearchForOverflow(o,t);e=linearSearchForOverflow(o,t,e);return[r,e]}else{if(unsplittableClasses.includes(o.className)||unsplittableTags.includes(o.tagName)){if(r===0){return[-1,0]}else{return[r,0]}}let e=binarySearchForOverflow(o.childNodes[0],t);e=linearSearchForOverflow(o.childNodes[0],t,e);return[r,e]}}return[-1,0]};const renderSVG=e=>{const t=document.createElementNS("http://www.w3.org/2000/svg","svg");Object.keys(e.attrs).forEach((n=>{if(n==="float"){t.style.float=e.attrs.float}else{t.setAttribute(n,e.attrs[n])}}));e.children.forEach((e=>{const n=document.createElementNS("http://www.w3.org/2000/svg",e.tag);Object.keys(e.attrs).forEach((t=>{if(e.tag==="title"){n.appendChild(document.createTextNode(e.attrs["text"]))}else{n.setAttribute(t,e.attrs[t])}}));if(e.tag==="text"){e.children.forEach((e=>{const t=document.createElementNS("http://www.w3.org/2000/svg","tspan");if(e.attrs){Object.keys(e.attrs).forEach((n=>{t.setAttribute(n,e.attrs[n])}))}t.appendChild(document.createTextNode(e.text));n.appendChild(t)}))}else if(e.tag==="defs"){const t=document.createElementNS("http://www.w3.org/2000/svg","style");t.appendChild(document.createTextNode(e.style));n.appendChild(t)}t.appendChild(n)}));return t};function insertOneHurmetVar(e,t,n,r){const o=e.format?e.format.value:"h15";if(!Array.isArray(t.name)){e[t.name]=t;if(n){n.add(t.name)}}else if(t.value===null){for(let n=0;n<t.name.length;n++){e[t.name[n]]={value:null}}}else if(isMatrix(t)){const r=Boolean(t.dtype&dt.QUANTITY);let o=t.resultdisplay;o=o.replace(/\\(begin|end){[bp]matrix}/g,"").trim();const i=o.split(/&|\\\\/);if(t.dtype&dt.MATRIX){const o=t.dtype-dt.MATRIX;const s=r?t.value.plain.length:t.value.length;const a=t.name.length/s;let l=0;for(let c=0;c<s;c++){for(let s=0;s<a;s++){const a=r?{plain:t.value.plain[c][s],inBaseUnits:t.value.inBaseUnits[c][s]}:t.value[c][s];e[t.name[c]]={name:t.name[l],value:a,resultdisplay:r?parse$1(i[l].trim()+" '"+t.unit+"'"):i[l].trim(),expos:t.expos,unit:r?t.unit:undefined,dtype:o};if(n){n.add(t.name[c])}l+=1}}}else{const o=Boolean(t.dtype&dt.COLUMNVECTOR);const s=t.dtype-(o?dt.COLUMNVECTOR:dt.ROWVECTOR);for(let o=0;o<t.name.length;o++){const a=r?{plain:t.value.plain[o],inBaseUnits:t.value.inBaseUnits[o]}:t.value[o];e[t.name[o]]={name:t.name[o],value:a,resultdisplay:r?parse$1(i[o].trim()+" '"+t.unit+"'"):i[o].trim(),expos:t.expos,unit:r?t.unit:undefined,dtype:s};if(n){n.add(t.name[o])}}}}else if(t.dtype&dt.MAP){const i=t.unit;const s=i&&i.name?i.name:undefined;const a=t.dtype-dt.MAP;let l=0;if(t.dtype&dt.QUANTITY){for(const i of t.value.data.plain){const c={value:{plain:i},expos:t.expos,factor:t.factor,dtype:a};c.resultdisplay=format(i,o,r);if(s){c.resultdisplay+=" "+unitTeXFromString(s)}e[t.name[l]]=c;if(n){n.add(t.name[l])}l+=1}l=0;for(const n of t.value.data.inBaseUnits){e[t.name[l]].value.inBaseUnits=n;l+=1}}else{for(const i of t.value.data){const c={value:i,expos:t.expos,factor:t.factor,dtype:a};c.resultdisplay=Rnl.isRational(i)?format(i,o,r):String(i);if(s){c.resultdisplay+=" "+unitTeXFromString(s)}e[t.name[l]]=c;if(n){n.add(t.name[l])}l+=1}}}else if(t.dtype===dt.DATAFRAME){const i=t.value.data[0].length===1;for(let s=0;s<t.name.length;s++){let a=t.value.dtype[s];let l=i?undefined:[];for(let e=0;e<t.value.data[0].length;e++){const n=t.value.data[s][e];const r=a&dt.RATIONAL?Rnl.fromString(n):n;if(i){l=r}else{l.push(r)}}if(!i){a+=dt.COLUMNVECTOR}const c={value:l,unit:t.unit[t.value.units[s]],dtype:a};if(a&dt.RATIONAL&&i){c.resultdisplay=parse$1(format(l));if(c.unit&&c.unit.name){c.resultdisplay+=" "+parse$1(`'${c.unit.name}'`)}}else if(a&dt.RATIONAL){c.resultdisplay=Matrix.display({value:l,dtype:a},o,r)+parse$1(`'${t.value.units[s]}'`)}else{c.resultdisplay=parse$1(l)}if(t.value.units[s]){c.value={plain:c.value};const e=t.unit[t.value.units[s]];c.value.inBaseUnits=i?Rnl.multiply(Rnl.add(c.value.plain,e.gauge),e.factor):c.value.plain.map((t=>Rnl.multiply(Rnl.add(t,e.gauge),e.factor)));c.expos=e.expos}e[t.name[s]]=c;if(n){n.add(t.name[s])}}}else if(t.dtype===dt.TUPLE){let r=0;for(const o of t.value.values()){if(o.name){o.name=t.name[r]}e[t.name[r]]=o;if(n){n.add(t.name[r])}r+=1}}else if(t.dtype===dt.MODULE){if(t.name.length!==t.value.length){return errorOprnd("MULT_MIS")}else{let r=0;for(const o of t.value.values()){const i=clone(o);e[t.name[r]]=i;if(n){n.add(t.name[r])}r+=1}}}else;}const checkUnitEquality=(e,t)=>{let n;let r;if(e.expos&&t.expos){n=e.expos;r=t.expos}else{n=e;r=t}if(Array.isArray(n)){if(Array.isArray(r)){if(n.length!==r.length){return false}n.forEach(((e,t)=>{if(e!==r[t]){return false}}));return true}else{return false}}else{return n===r}};const append=(e,t,n,r)=>{let o;let i;if(e.dtype&dt.MAP){if(r!=="scalar"){return errorOprnd("BAD_APPEND",r)}o=e;i=t}else{if(n!=="scalar"){return errorOprnd("BAD_APPEND",n)}o=t;i=e}if(!(o.dtype&i.dtype)){errorOprnd("MAP_APPEND")}if(!checkUnitEquality(o.unit,i.unit)){errorOprnd("UNIT_APEND")}o.value.set(i.name,i.value);return o};const convertFromBaseUnits=(e,t,n)=>{e=e.map((e=>Rnl.isRational(e[0])?e.map((e=>Rnl.divide(e,n))):e));if(!Rnl.isZero(t)){e=e.map((e=>Rnl.isRational(e[0])?e.map((e=>Rnl.subtract(e,t))):e))}return e};const convertToBaseUnits=(e,t,n)=>{if(!Rnl.isZero(t)){e=e.map((e=>Rnl.isRational(e[0])?e.map((e=>Rnl.add(e,t))):e))}e=e.map((e=>Rnl.isRational(e[0])?e.map((e=>Rnl.multiply(e,n))):e));return e};const range=(e,t)=>{let n=clone(e.unit);const[r,o,i,s]=identifyRange(e,t);if(r.length===0&&i===s&&o.length===1){const t=e.value.data[o[0]][i];return{value:t,unit:n,dtype:e.dtype-dt.MAP}}else if(o.length===1){const t=e.value.data[o[0]].slice(i,s+1);const r=o[0]===0?dt.COLUMNVECTOR+(typeof t[0]==="string"?dt.STRING:e.dtype-dt.MAP):e.dtype-dt.MAP+dt.COLUMNVECTOR;if(o[0]===-1){n=null}return{value:t,unit:n,dtype:r}}else{const t=[];const a=[];const l=Object.create(null);const c=r.length===0?false:Object.create(null);for(let n=0;n<o.length;n++){t.push(e.value.headings[o[n]]);l[e.value.headings[n]]=n;if(r.length>0){const t=[];for(let i=0;i<r.length;i++){const s=r[i];t.push(e.value.data[o[n]][e.value.rowMap[s]]);c[s]=i}a.push(t)}else{a.push(e.value.data[o[n]].slice(i,s+1))}}return{value:{data:a,headings:t,columnMap:l,rowMap:c},unit:n,dtype:e.dtype}}};const map=Object.freeze({append:append,convertFromBaseUnits:convertFromBaseUnits,convertToBaseUnits:convertToBaseUnits,range:range});const endRegEx=/_end$/;const alphaRegEx=/^[A-Z]$/;const cellParts=/^([^\d]+)(\d+)?$/;const intRegEx=/^\d+$/;function propertyFromDotAccessor(e,t,n){const r=Object.create(null);if(e.dtype&dt.MAP){return map.range(e,[t],n)}else if(e.dtype&dt.DATAFRAME){return DataFrame.range(e,[t],n)}else if(e.dtype===dt.SPREADSHEET){let r=t.value;if(endRegEx.test(r)){r=r.slice(0,-4);if(!alphaRegEx.test(r)){r=e.columnMap[r]}r=r+Object.keys(e.rowMap).length;return fromAssignment(e.value[r],n)}if(r in e.columnMap||alphaRegEx.test(r)){const t=alphaRegEx.test(r)?r:e.columnMap[r];const o=[];let i=null;let s=null;if(e.value[t+"1"].dtype&dt.RATIONAL){for(let r=1;r<e.numRows;r++){const i=e.value[t+r];if(!(i.dtype&dt.RATIONAL)){return errorOprnd("NANEL",i.name)}if(n){o.push(i.value.inBaseUnits)}else{o.push(i.value.plain)}}i=n?e.units[e.unitMap[t.codePointAt(0)-65]]:allZeros;s=dt.RATIONAL+dt.COLUMNVECTOR}else{for(let n=1;n<e.numRows;n++){o.push(e.value[t+n].value)}s=e.value[t+"1"].dtype+dt.COLUMNVECTOR}return{value:o,unit:i,dtype:s}}else{const t=r.match(cellParts);const o=t[1];if(t[2]){return fromAssignment(e.value[o+t[2]],n)}else{return errorOprnd("BAD_SHT_KEY",r)}}}else if((e.dtype===dt.STRING||e.dtype&dt.ARRAY)&&t.dtype===dt.RATIONAL){const n=Rnl.toNumber(t.value);r.value=e.value.slice(n-1,n);r.unit=e.unit;r.dtype=e.dtype;return r}else if((e.dtype===dt.STRING||e.dtype&dt.ARRAY)&&t.dtype===dt.RANGE){const n=t.value[0]-1;const o=t.value[1];const i=t.value[2]===""?e.value.length:t.value[2];r.unit=e.unit;r.dtype=e.dtype;if(o===1){r.value=e.value.slice(n,i)}else{r.value=[];for(let t=n;t<i;t+=o){r.value.push(e.value[t])}}return r}else if(e.dtype===dt.MODULE){return fromAssignment(e.value[t.value],n)}else{return errorOprnd("NO_PROP",e.name)}}const cellOprnd=(e,t,n)=>{if(t.length===1){let r=t[0].value;if(endRegEx.test(r)){r=r.slice(0,1)+Object.keys(e.rowMap).length}return fromAssignment(parent.value[r],n)}let r="";const o=t[0].value;const i=t[1].value;if(e.columnMap[o]||alphaRegEx.test(o)){r=e.columnMap[o]?e.columnMap[o]:o;if(e.rowMap[i]){r+=e.rowMap[i]}else if(intRegEx.test(i)){r+=i}else;}else if(e.columnMap[i]||alphaRegEx.test(o)){r=e.columnMap[i]?e.columnMap[i]:i;if(e.rowMap[o]){r+=e.rowMap[o]}else if(intRegEx.test(o)){r+=o}else;}else;return fromAssignment(e.value[r],n)};const display=(e,t="h3",n="1,000,000.")=>{if(e.size===0){return""}let r="\\begin{array}{c}";let o=false;for(const t of e.values()){if(t.unit&&t.unit.name){o=true;break}}if(o){let t="";for(const n of e.values()){if(n.unit&&n.unit.name){t+=unitTeXFromString(n.unit.name).replace("\\;\\, ","")}t+="&"}r+=t.slice(0,-1)+" \\\\ ";r+="\\hline "}let i="";for(const r of e.values()){i+=format(r.value,t,n)+" & "}r+=i.slice(0,-1);r+="\\end{array}";return r};const displayAlt=(e,t="h3")=>{if(e.size===0){return""}let n="``";let r=false;for(const t of e.values()){if(t.unit&&t.unit.name){r=true;break}}if(r){let t="";for(const n of e.values()){if(n.unit&&n.unit.name){t+=n.unit.name}t+="\t"}n+=t.slice(0,-1)+"\n"}let o="";for(const n of e.values()){o+=format(n.value,t,"100000.")+"\t"}n+=o.slice(0,-1);return n+"``"};const Tuple=Object.freeze({display:display,displayAlt:displayAlt});const numMisMatchError=e=>{const t="Error. Mismatch in number of multiple assignment.";return[`\\textcolor{firebrick}{\\text{${t}}}`,t]};const testRegEx$1=/^@{1,2}test /;const compRegEx=/\u00a0([><>]|==|in|!in|!=|=>|<=)$/;const negatedComp={"":["",""],"==":["",""],"":["==","=="],">":["\\ngtr ","!>"],"<":["\\nless ","!<"],"":["\\nleq ","!"],"":["\\ngeq ","!"],"":["",""],"":["",""],"":["",""],"":["",""],"":["",""],"":["",""],"":["",""],"":["",""],in:["",""],"!in":["in","in"],"!=":["==","=="],"=>":["\\ngeq ","!"],"<=":["\\ngeq ","!"]};const formatResult=(e,t,n,r,o,i)=>{if(!t){return e}const s=r.decimalFormat;if(t.dtype===dt.DRAWING){e.resultdisplay=t.value;delete e.resultdisplay.temp;return e}const a=!e.name?0:!Array.isArray(e.name)?1:e.name.length;if(e.resulttemplate.indexOf("?")>-1||e.resulttemplate.indexOf("!")>-1||e.resulttemplate.indexOf("@")>-1||e.resulttemplate.indexOf("%")>-1){e.value=t.value;let l="";let c="";if(e.resulttemplate.indexOf("!")>-1){l="";c="";return e}else if(t.dtype&dt.BOOLEAN&&testRegEx$1.test(e.entry)&&compRegEx.test(e.rpn)){if(testValue(t)===true){l=parse$1(e.entry.replace(testRegEx$1,""))+",\\text{ ok }";c=e.entry.replace(testRegEx$1,"")+", ok "}else{const t=compRegEx.exec(e.rpn)[0].slice(1);const n=negatedComp[t];if(o){const r=o.value.replace(/\.$/,"");const i=e.entry.replace(testRegEx$1,"").replace(t,n[0]);l="\\colorbox{Salmon}{"+r+", but $"+parse$1(i)+"$}";c=r+", but "+e.entry.replace(testRegEx$1,"").replace(t,n[1])}else{l=parse$1(e.entry.replace(testRegEx$1,"").replace(t,n[0]))+",\\colorbox{Salmon}{ n.g.}";c=e.entry.replace(testRegEx$1,"").replace(t,n[1])+", n.g."}console.log(c)}}else if(isMatrix(t)){l=Matrix.display(i||t.value.plain?{value:t.value.plain,dtype:t.dtype}:t,n,s);c=Matrix.displayAlt(i||t.value.plain?{value:t.value.plain,dtype:t.dtype}:t,n,s)}else if(t.dtype===dt.DATAFRAME){if(a>1&&a!==t.value.data.length){[l,c]=numMisMatchError()}else{const r=e.name&&Array.isArray(e.name)&&e.name.length>1;l=DataFrame.display(t.value,n,s,r);c=DataFrame.displayAlt(t.value,n,r)}}else if(t.dtype&dt.MAP){let r;if(i||t.value.data.plain){r=clone(t.value);r.data=t.value.data.plain}else{r=t.value}const o=e.name&&Array.isArray(e.name)&&e.name.length>1;l=DataFrame.display(r,n,s,o);c=DataFrame.displayAlt(r,n,s,o)}else if(t.dtype===dt.TUPLE){if(a>1&&a!==t.value.size){[l,c]=numMisMatchError()}else{l=Tuple.display(t.value,n,s);c=Tuple.displayAlt(t.value,n)}}else if(t.dtype&dt.STRING){l="\\text{"+addTextEscapes(t.value)+"}";if(t.unit){l=`\\textcolor{${t.unit}}{${l}}`}c=t.value}else if(t.dtype&dt.RICHTEXT){l=parse$1(t.value,r,false);c=t.value}else if(t.dtype&dt.BOOLEAN){l="\\text{"+t.value+"}";c=String(t.value)}else if(t.dtype===dt.COMPLEX){const e=t.value;[l,c]=Cpx.display(e,n,s)}else if(t.dtype===dt.DATE){l=formatDate(t.value,r.dateFormat);if(l.dtype&&l.dtype===dt.ERROR){l="\textcolor{firebrick}{\\text{"+l.value+"}}";c=l.value}else{c=l.slice(26,-2)}}else if(t.value.plain){l=format(t.value.plain,n,s);if(l.dtype&&l.dtype===dt.ERROR){l="\textcolor{firebrick}{\\text{"+l.value+"}}";c=l.value}else{c=l.replace(/{,}/g,",").replace("\\","")}}else if(Rnl.isRational(t.value)){l=format(t.value,n,s);if(l.dtype&&l.dtype===dt.ERROR){l="\\textcolor{firebrick}{\\text{"+l.value+"}}";c=l.value}else{c=l.replace(/{,}/g,",").replace("\\","")}}else if(t.dtype===dt.IMAGE){return e}else{l=t.value;c=l}const d=/(\? *\??|@ *@?|%%?)/.exec(e.resulttemplate);e.resultdisplay=e.resulttemplate.slice(0,d.index)+l+e.resulttemplate.slice(d.index+d[0].length);if(e.resulttemplate.indexOf("@")>-1){e.tex=e.resultdisplay;e.displaySelector=e.altresulttemplate.indexOf("@@")>-1?"@@":"@";if(!testRegEx$1.test(e.entry)){const t=e.entry.lastIndexOf(e.displaySelector);e.md=e.entry.slice(0,t)+`${c}`+e.entry.slice(t+e.displaySelector.length)}e.alt=e.altresulttemplate.replace(/@@?/,c)}else if(e.resulttemplate.indexOf("?")>-1){let t=e.tex.lastIndexOf("?");e.tex=e.tex.slice(0,t).replace(/\? *$/,"")+l+e.tex.slice(t+1);e.displaySelector=e.altresulttemplate.indexOf("??")>-1?"??":"?";t=e.alt.lastIndexOf(e.displaySelector);e.md=e.alt.slice(0,t)+`${c}`+e.alt.slice(t+e.displaySelector.length);e.alt=e.alt.slice(0,t)+c+e.alt.slice(t+e.displaySelector.length)}else if(e.resulttemplate.indexOf("%")>-1){let t=e.tex.lastIndexOf("%");e.tex=e.tex.slice(0,t).replace(/% *$/,"")+l+e.tex.slice(t+1);e.displaySelector=e.altresulttemplate.indexOf("%%")>-1?"%%":"%";t=e.alt.lastIndexOf(e.displaySelector);e.md=e.alt.slice(0,t)+`${c}`+e.alt.slice(t+e.displaySelector.length);e.alt=e.alt.slice(0,t)+c+e.alt.slice(t+e.displaySelector.length)}}return e};const testValue=e=>{if(isVector(e)){for(let t=0;t<e.value.length;t++){if(!e.value[t]){return false}}}else if(isMatrix(e)){for(let t=0;t<e.value.length;t++){for(let n=0;n<e.value[0].length;n++){if(!e.value[t][n]){return false}}}}else if(e.dtype&dt.MAP){for(let t=0;t<e.value.data.length;t++){for(let n=0;n<e.value.data[0].length;n++){if(!e.value.data[t][n]){return false}}}}else{return e.value}return true};const varRegEx=/[^]*/;const openParenRegEx=/(?:[([{|]|[^\\][,;:](?:\\:)?)$/;const plugValsIntoEcho=(e,t,n,r,o)=>{let i;while((i=varRegEx.exec(e))!==null){const s=i[0].replace(/[()]/g,"").trim().replace(/'/g,"");const a=i[0].length;const l=i.index;let c;let d="";if(s.indexOf(".")>-1){const n=s.split(".");const i=n[0];if(!t[i]){return errorOprnd("V_NAME",i)}c=t[i];if(c.dtype===dt.DATAFRAME&&n.length===2){d="\\mathrm{"+t[n[0]].name+"{.}\\mathrm{"+n[1]+"}";return e.substring(0,l)+d+e.substring(l+a)}else{for(let e=1;e<n.length;e++){const i=n[e].replace("}","").replace("\\mathrm{","").trim();const s={value:i,unit:null,dtype:dt.STRING};c=propertyFromDotAccessor(c,s,t);if(!c){return errorOprnd("V_NAME",i)}const a={resulttemplate:"@",altresulttemplate:"@"};c.resultdisplay=formatResult(a,c,r,null,o).resultdisplay}}}else if(!t[s]&&s==="T"){c={dtype:dt.RATIONAL,resultdisplay:"\\text{T}"}}else if(s==="e"&&/^\^/.test(e.slice(l+3).trim())){e=e.substring(0,l)+"e"+e.substring(l+a);continue}else if(s==="j"){e=e.substring(0,l)+"j"+e.substring(l+a);continue}else if(!t[s]){return errorOprnd("V_NAME",s)}else{c={dtype:t[s].dtype,resultdisplay:t[s].resultdisplay}}if(!c||!c.resultdisplay){const e=s?s:"?";return errorOprnd("NULL",e)}else if(c.error){return errorOprnd("NULL",s)}let u=true;if(isMatrix(c)||c.dtype&dt.DATAFRAME){u=false}if(n&&c.dtype&dt.QUANTITY){u=true}let p=false;if(l>0){const t=e.slice(0,l).trim();if(openParenRegEx.test(t)){const t=e.slice(l+s.length+2).trim();p=t.length>0&&/^([)|\]},;:]|\\right)/.test(t)}else if(/^\\begin{[bp]matrix}/.test(c.resultdisplay)){p=/\\end{[bp]matrix}$/.test(c.resultdisplay)}}u=u&&!p;if(c.dtype===dt.DATAFRAME||c.dtype&dt.MAP||c.resultdisplay.slice(0,1)==="!"){d="\\mathrm{"+parse$1(t[s].name)+"}"}else{d=c.resultdisplay;if(!n){const e=d.lastIndexOf("{\\text{");if(e>-1){d=d.slice(0,e).trim().replace(/\\; *$/,"").trim()}}if(u){d=c.dtype>256?"\\left("+d+"\\right)":"("+d+")"}}e=e.substring(0,l)+d+e.substring(l+a)}return e};const negativeOne=Object.freeze(Rnl.negate(Rnl.one));const oneHalf=[BigInt(1),BigInt(2)];const thirty=[BigInt(30),BigInt(1)];const fortyFive=[BigInt(45),BigInt(1)];const sixty=[BigInt(60),BigInt(1)];const ninety=[BigInt(90),BigInt(1)];const halfPi=Object.freeze(Rnl.divide(Rnl.pi,Rnl.two));const functionExpos=(e,t)=>{const n=t.length;const r=n===1?t[0].unit.expos:null;switch(e){case"abs":case"round":case"roundn":case"sign":case"trace":case"fetch":return r;case"cos":case"sin":case"tan":case"sec":case"csc":case"cot":case"acos":case"arccos":case"asin":case"arcsin":case"atan":case"arctan":case"asec":case"arcsec":case"acsc":case"arccsc":case"acot":case"arccot":case"cosd":case"sind":case"tand":case"secd":case"cscd":case"cotd":case"acosd":case"asind":case"atand":case"asecd":case"acscd":case"acotd":case"gud":if(!unitsAreCompatible(r,allZeros)){return errorOprnd("UNIT_IN",e)}return allZeros;case"exp":case"log":case"ln":case"log10":case"log2":case"logn":case"cosh":case"sinh":case"tanh":case"sech":case"csch":case"coth":case"acosh":case"asinh":case"atanh":case"asech":case"acsch":case"acoth":case"binomial":case"gamma":case"":case"lgamma":case"lfact":case"factorial":if(!unitsAreCompatible(r,allZeros)){return errorOprnd("UNIT_IN",e)}return allZeros;case"sqrt":return r.map((e=>e/2));case"gcd":case"mht":if(!unitsAreCompatible(r,allZeros)){return errorOprnd("UNIT_IN",e)}return e==="hmt"?[1,0,0,0,0,0,0,0]:allZeros;case"atan2":case"hypot":case"rms":case"ceil":case"floor":case"sum":case"mean":case"median":case"min":case"max":case"range":case"stddev":case"variance":{const n=t[0].unit.expos;for(let r=1;r<t.length;r++){const o=t[r].unit.expos;if(n.length!==o.length){return errorOprnd("UNIT_ARG",e)}for(let t=0;t<n.length;t++){if(n[t]!==o[t]){return errorOprnd("UNIT_ARG",e)}}}return e==="atan2"?allZeros:n}case"real":case"imag":case"angle":case"conj":return allZeros;case"product":{const e=clone(t[0].unit.expos);for(let n=1;n<t.length;n++){const r=t[n].unit.expos;e.map(((e,t)=>e+r[t]))}return e}default:return errorOprnd("F_NAME",e)}};const gamma=e=>{if(Rnl.isZero(e)){return errorOprnd("0")}else if(Rnl.isPositive(e)&&Rnl.isInteger(e)&&Rnl.lessThan(e,Rnl.fromNumber(101))){return Rnl.factorial(Rnl.subtract(e,Rnl.one))}else if(Rnl.isNegative(e)&&Rnl.isInteger(e)){return errorOprnd("POLE")}else if(Rnl.lessThan(e,oneHalf)){return Rnl.fromNumber(Math.PI/Math.sin(Math.PI*Rnl.toNumber(e))*Rnl.toNumber(gamma(Rnl.subtract(Rnl.one,e))))}else{return Rnl.lanczos(e)}};const lgamma=e=>{if(Rnl.isZero(e)){return errorOprnd("0")}if(Rnl.isNegative(e)){return errorOprnd("LOG")}if(Rnl.areEqual(e,Rnl.one)||Rnl.areEqual(e,Rnl.two)){return Rnl.zero}if(Rnl.lessThanOrEqualTo(e,Rnl.fromNumber(14))){return Rnl.fromNumber(Math.log(Rnl.toNumber(gamma(e))))}else{const t=Rnl.toNumber(e);const n=(t-.5)*Math.log(t)-t+.5*Math.log(2*Math.PI)+1/(12*t)-1/(360*t**3)+1/(1260*t**5)-1/(1680*t**7)+5/(540*t**9);return Rnl.fromNumber(n)}};const binomial=(e,t)=>{if(Rnl.areEqual(e,t)){return Rnl.one}if(Rnl.isZero(e)){return Rnl.zero}if(Rnl.isNegative(t)){return Rnl.zero}if(Rnl.lessThan(e,t)){return Rnl.zero}if(Rnl.isInteger(e)&&Rnl.isInteger(t)&&Rnl.isPositive(e)&&Rnl.isPositive(t)){return Rnl.divide(Rnl.factorial(e),Rnl.multiply(Rnl.factorial(t),Rnl.factorial(Rnl.subtract(e,t))))}else if(Rnl.isInteger(e)&&Rnl.isInteger(t)&&Rnl.isPositive(t)){return Rnl.multiply(Rnl.power(negativeOne,t),multiset(Rnl.negate(e),t))}else{return Rnl.divide(gamma(Rnl.increment(e)),Rnl.multiply(gamma(Rnl.increment(t)),gamma(Rnl.increment(Rnl.subtract(e,t)))))}};const multiset=(e,t)=>binomial(Rnl.add(e,Rnl.decrement(t)),t);const piOver180=Rnl.divide(Rnl.pi,[BigInt(180),BigInt(1)]);const unary$1={scalar:{abs(e){return Rnl.abs(e)},angle(e){return errorOprnd("NA_REAL","angle")},real(e){return errorOprnd("NA_REAL","real")},imag(e){return errorOprnd("NA_REAL","imag")},conj(e){return errorOprnd("NA_REAL","conj")},cos(e){return Rnl.cos(e)},sin(e){return Rnl.sin(e)},tan(e){return Rnl.tan(e)},cosh(e){return Rnl.cosh(e)},sinh(e){return Rnl.sinh(e)},tanh(e){return Rnl.tanh(e)},acos(e){if(Rnl.greaterThan(Rnl.abs(e),Rnl.one)){return errorOprnd("ATRIG","acos")}return Rnl.fromNumber(Math.acos(Rnl.toNumber(e)))},asin(e){if(Rnl.greaterThan(Rnl.abs(e),Rnl.one)){return errorOprnd("ATRIG","asin")}return Rnl.fromNumber(Math.asin(Rnl.toNumber(e)))},atan(e){return Rnl.fromNumber(Math.atan(Rnl.toNumber(e)))},sec(e){return Rnl.fromNumber(1/Math.cos(Rnl.toNumber(e)))},csc(e){return Rnl.fromNumber(1/Math.sin(Rnl.toNumber(e)))},cot(e){if(Rnl.isZero(e)){return errorOprnd("COT","cotangent")}return Rnl.fromNumber(1/Math.tan(Rnl.toNumber(e)))},asec(e){if(Rnl.greaterThanOrEqualTo(Rnl.abs(e),Rnl.one)){return errorOprnd("ASEC","arcecant")}const t=Math.atn(Math.sqrt(Rnl.toNumber(Rnl.decrement(Rnl.multiply(e,e)))));return Rnl.isPositive(e)?Rnl.fromNumber(t):Rnl.fromNumber(t-Math.PI)},acot(e){if(Rnl.greaterThanOrEqualTo(Rnl.abs(e),Rnl.one)){return errorOprnd("ASEC","acot")}const t=Math.atn(1/Math.sqrt(Rnl.toNumber(Rnl.decrement(Rnl.multiply(e,e)))));return Rnl.isPositive(e)?Rnl.fromNumber(t):Rnl.fromNumber(t-Math.PI)},acsc(e){return Rnl.fromNumber(Math.atn(-Rnl.toNumber(e))+Math.PI)},exp(e){return Rnl.exp(e)},log(e){return Rnl.isZero(e)?errorOprnd("LOG_ZERO"):Rnl.fromNumber(Math.log(Rnl.toNumber(e)))},ln(e){return Rnl.isZero(e)?errorOprnd("LOG_ZERO"):Rnl.fromNumber(Math.log(Rnl.toNumber(e)))},log10(e){return Rnl.isZero(e)?errorOprnd("LOG_ZERO"):Rnl.fromNumber(Math.log10(Rnl.toNumber(e)))},log2(e){return Rnl.isZero(e)?errorOprnd("LOG_ZERO"):Rnl.fromNumber(Math.log2(Rnl.toNumber(e)))},sech(e){const t=Rnl.toNumber(e);return Rnl.fromNumber(2/(Math.exp(t)+Math.exp(-t)))},csch(e){const t=Rnl.toNumber(e);return Rnl.fromNumber(2/(Math.exp(t)-Math.exp(-t)))},coth(e){const t=Rnl.toNumber(e);return Rnl.fromNumber((Math.exp(t)+Math.exp(-t))/(Math.exp(t)-Math.exp(-t)))},acosh(e){const t=Rnl.toNumber(e);return Rnl.fromNumber(Math.log(t+Math.sqrt(t-1)*Math.sqrt(t+1)))},asinh(e){const t=Rnl.toNumber(e);return Rnl.fromNumber(Math.log(t+Math.sqrt(Math.pow(t,2)+1)))},atanh(e){const t=Rnl.toNumber(e);return Rnl.fromNumber((Math.log(1+t)-Math.log(1-t))/2)},asech(e){if(Rnl.isZero(e)){return errorOprnd("DIV")}const t=Rnl.toNumber(e);return Rnl.fromNumber(Math.log((Math.sqrt(-t*t+1)+1)/t))},ascsh(e){if(Rnl.isZero(e)){return errorOprnd("DIV")}const t=Rnl.toNumber(e);return Rnl.fromNumber(Math.log(Math.sqrt(1+1/Math.pow(t,2))+1/t))},acoth(e){if(Rnl.isZero(e)){return errorOprnd("DIV")}const t=Rnl.toNumber(e);return Rnl.fromNumber((Math.log(1+1/t)-Math.log(1-1/t))/2)},ceil(e){return Rnl.ceil(e)},floor(e){return Rnl.floor(e)},gamma(e){return gamma(e)},""(e){return gamma(e)},lgamma(e){if(Rnl.isNegative(e)||Rnl.isZero(e)){return errorOprnd("LOG")}return lgamma(e)},lfact(e){if(Rnl.isNegative(e)||!Rnl.isInteger(e)){return errorOprnd("FACT")}return lgamma(Rnl.add(e,Rnl.one))},factorial(e){return Rnl.factorial(e)},sign(e){return Rnl.isPositive(e)?Rnl.one:Rnl.isZero(e)?Rnl.zero:negativeOne},cosd(e){if(Rnl.areEqual(e,ninety)){return Rnl.zero}if(Rnl.areEqual(e,sixty)){return oneHalf}return this.cos(Rnl.multiply(e,piOver180))},sind(e){if(Rnl.areEqual(e,thirty)){return oneHalf}return this.sin(Rnl.multiply(e,piOver180))},tand(e){if(Rnl.areEqual(e,fortyFive)){return Rnl.one}if(Rnl.areEqual(e,ninety)){return errorOprnd("TAN90","90")}return this.tan(Rnl.multiply(e,piOver180))},cotd(e){return this.cot(Rnl.multiply(e,piOver180))},cscd(e){return this.csc(Rnl.multiply(e,piOver180))},secd(e){return this.sec(Rnl.multiply(e,piOver180))},acosd(e){const t=this.acos(e);return t.dtype?t:Rnl.divide(t,piOver180)},asind(e){const t=this.asin(e);return t.dtype?t:Rnl.divide(t,piOver180)},atand(e){return Rnl.divide(this.atan(e),piOver180)},acotd(e){const t=this.acot(e);return t.dtype?t:Rnl.divide(t,piOver180)},acscd(e){const t=this.acsc(e);return t.dtype?t:Rnl.divide(t,piOver180)},asecd(e){const t=this.asec(e);return t.dtype?t:Rnl.divide(t,piOver180)},Char(e){return String.fromCodePoint(Rnl.toNumber(e))},sqrt(e){const t=[BigInt(1),BigInt(2)];return Cpx.isComplex(e)||Rnl.isNegative(e)?Cpx.power([e,Rnl.zero],t):Rnl.power(e,t)},round(e){return Rnl.fromString(Rnl.toString(e,0))}},complex:{abs(e){return Cpx.abs(e)},angle(e){return Cpx.angle(e)},real(e){return e[0]},imag(e){return e[1]},conj(e){return Cpx.conjugate(e)},cos(e){return Cpx.cos(e)},sin(e){return Cpx.sin(e)},asin(e){return Cpx.asin(e)},atan(e){return Cpx.atan(e)},acos(e){return Cpx.subtract([halfPi,Rnl.zero],Cpx.asin(e))},tan(e){return Cpx.divide(Cpx.sin(e),Cpx.cos(e))},cot(e){return Cpx.divide(Cpx.cos(e),Cpx.sin(e))},sec(e){const t=Cpx.cos(e);return t.dtype?t:Cpx.inverse(t)},csc(e){const t=Cpx.sin(e);return t.dtype?t:Cpx.inverse(t)},asec(e){const t=Cpx.inverse(e);return Cpx.subtract([halfPi,Rnl.zero],Cpx.asin(t))},acot(e){return Cpx.atan(Cpx.inverse(e))},acsc(e){return Cpx.asin(Cpx.inverse(e))},exp(e){return Cpx.exp(e)},log(e){return Cpx.log(e)},ln(e){return Cpx.log(e)},log10(e){return Rnl.fromNumber(Math.log10(Rnl.toNumber(e)))},log2(e){return Rnl.fromNumber(Math.log2(Rnl.toNumber(e)))},cosh(e){return Cpx.divide(Cpx.add(Cpx.exp(e),Cpx.exp(Cpx.negate(e))),[Rnl.two,Rnl.zero])},sinh(e){return Cpx.divide(Cpx.subtract(Cpx.exp(e),Cpx.exp(Cpx.negate(e))),[Rnl.two,Rnl.zero])},tanh(e){const t=Cpx.exp(e);const n=Cpx.exp(Cpx.negate(e));return Cpx.divide(Cpx.subtract(t,n),Cpx.add(t,n))},sech(e){return Cpx.divide([Rnl.two,Rnl.zero],Cpx.add(Cpx.exp(e),Cpx.exp(Cpx.negate(e))))},csch(e){return Cpx.divide([Rnl.two,Rnl.zero],Cpx.subtract(Cpx.exp(e),Cpx.exp(Cpx.negate(e))))},coth(e){const t=Cpx.exp(e);const n=Cpx.exp(Cpx.negate(e));return Cpx.divide(Cpx.add(t,n),Cpx.subtract(t,n))},acosh(e){return Cpx.acosh(e)},asinh(e){return Cpx.asinh(e)},atanh(e){return Cpx.atanh(e)},asech(e){return Cpx.acosh(Cpx.inverse(e))},acsch(e){return Cpx.asinh(Cpx.inverse(e))},acoth(e){return Cpx.atanh(Cpx.inverse(e))},ceil(e){return errorOprnd("NA_COMPL_OP","ceil")},floor(e){return errorOprnd("NA_COMPL_OP","ceil")},gamma(e){return Cpx.gamma(e)},""(e){return Cpx.gamma(e)},lgamma(e){return errorOprnd("NA_COMPL_OP","lgamma")},factorial(e){return errorOprnd("NA_COMPL_OP","factorial")},sign(e){if(Rnl.isZero(e[1])&&Rnl.isPositive(e[0])){return Rnl.one}else if(Rnl.isZero(e[1])&&Rnl.isNegative(e[0])){return Rnl.negate(Rnl.one)}else{return Cpx.divide(e,[Cpx.abs(e),Rnl.zero])}},round(e){return errorOprnd("NA_COMPL_OP","round")}}};const binary$1={logn([e,t]){return Rnl.fromNumber(Math.log(Rnl.toNumber(t))/Math.log(Rnl.toNumber(e)))},roundFixed([e,t]){return Rnl.fromString(Rnl.toString(e,t))},roundSignificant([e,t]){return Rnl.fromString(Rnl.toStringSignificant(e,t))},stringFixed([e,t]){return Rnl.toString(e,t)},stringSignificant([e,t]){return Rnl.toStringSignificant(e,t)},atan2([e,t]){return Rnl.fromNumber(Math.atan2(Rnl.toNumber(t),Rnl.toNumber(e)))},hypot([e,t]){const n=Rnl.max(e,t);const r=Rnl.divide(Rnl.min(e,t),n);return Rnl.multiply(n,Rnl.sqrt(Rnl.increment(Rnl.multiply(r,r))))},gcd([e,t]){return Rnl.gcd(e,t)},rms([e,t]){return this.hypot(e,t)},binomial([e,t]){return binomial(e,t)},ones([e,t]){return Matrix.ones(Rnl.toNumber(e),Rnl.toNumber(t))},zeros([e,t]){return Matrix.zeros(Rnl.toNumber(e),Rnl.toNumber(t))},mod([e,t]){return Rnl.mod(e,t)},rem([e,t]){return Rnl.rem(e,t)}};const reduce={max(e){return e.reduce(((e,t)=>Rnl.max(e,t)))},min(e){return e.reduce(((e,t)=>Rnl.min(e,t)))},sum(e){return e.reduce(((e,t)=>Rnl.add(e,t)))},product(e){return e.reduce(((e,t)=>Rnl.multiply(e,t)))},mean(e){const t=this.sum(e);return Rnl.divide(t,Rnl.fromNumber(e.length))},median(e){const t=this.max(e);const n=this.min(e);return Rnl.divide(Rnl.add(t,n),Rnl.two)},range(e){return Rnl.subtract(this.max(e),this.min(e))},variance(e){const t=this.sum(e);const n=Rnl.divide(t,Rnl.fromNumber(e.length));const r=e.reduce(((e,t)=>Rnl.add(e,Rnl.pow(Rnl.subtract(t,n),Rnl.two))));return Rnl.divide(r,Rnl.subtract(Rnl.fromNumber(e.length),Rnl.one))},stddev(e){const t=this.variance(e);return Rnl.power(t,oneHalf)},accumulate(e){const t=new Array(e.length).fill(0);t[0]=e[0];for(let n=1;n<e.length;n++){t[n]=Rnl.add(t[n-1],e[n])}return t}};const lerp=(e,t)=>{for(let t=0;t<3;t++){if(!(e[t].dtype&dt.RATIONAL)){return errorOprnd("")}}let n=allZeros;if(t){if(e[0].expos!==e[1].expos){return errorOprnd("")}if(e[1].expos!==e[2].expos){return errorOprnd("")}n=e[0].expos}const r=Object.create(null);r.unit=Object.create(null);r.unit.expos=n;r.dtype=dt.RATIONAL;const o=e[0].value;const i=e[1].value;const s=e[2].value;for(let e=0;e<o.length-1;e++){if(Rnl.lessThanOrEqualTo(o[e],s)&Rnl.lessThanOrEqualTo(s,o[e+1])){const t=Rnl.divide(Rnl.subtract(i[e+1],i[e]),Rnl.subtract(o[e+1],o[e]));r.value=Rnl.add(i[e],Rnl.multiply(t,Rnl.subtract(s,o[e])));return Object.freeze(r)}}};const Functions=Object.freeze({functionExpos:functionExpos,unary:unary$1,binary:binary$1,reduce:reduce,lerp:lerp});const multivarFunction=(e,t,n)=>{if(n.length===1){const r=isVector(n[0])?n[0].value:n.dtype&dt.MATRIX?n[0].value.flat():n[0].value;const o=Functions[e][t](r);let i=n[0].dtype;if(e==="reduce"&&t!=="accumulate"){if(i&dt.MATRIX){i-=dt.MATRIX}if(i&dt.ROWVECTOR){i-=dt.ROWVECTOR}if(i&dt.COLUMNVECTOR){i-=dt.COLUMNVECTOR}}return[o,i]}else if(t==="sum"&&n.length===2&&isMatrix(n[0])&&n[1].dtype===dt.RATIONAL){if(Rnl.areEqual(n[1].value,Rnl.two)){const e=dt.COLUMNVECTOR+dt.RATIONAL;const t=n[0].value.map((e=>e.reduce(((e,t)=>Rnl.add(e,t)))));return[t,e]}else if(Rnl.areEqual(n[1].value,Rnl.one)){const e=dt.ROWVECTOR+dt.RATIONAL;const t=Matrix.transpose(n[0]).value.map((e=>e.reduce(((e,t)=>Rnl.add(e,t)))));return[t,e]}else{return[errorOprnd("BAD_SUM"),dt.ERROR]}}else{let r=0;let o=false;let i=false;let s=n[0].dtype;for(r=0;r<n.length;r++){if(isVector(n[r])){o=true;s=n[r].dtype;break}else if(isMatrix(n[r])){i=true;s=n[r].dtype;break}}const a=n.map((e=>e.value));if(!(o||i)){const r=Functions[e][t](a);return t==="zeros"||t==="ones"?[r.value,r.dtype]:[r,n[0].dtype]}else{const n=[];if(o){const o=clone(a);for(let i=0;i<a[r].length;i++){o[r]=a[r][i];n.push(Functions[e][t](o))}}else{const o=clone(a);for(let i=0;i<a[r].length;i++){n.push([]);for(let s=0;s<a[r][0].length;s++){o[r]=a[r][i][s];n[i].push(Functions[e][t](o))}}}return[n,s]}}};const equals=(e,t)=>{if(Rnl.isRational(e)&&Rnl.isRational(t)){return Rnl.areEqual(e,t)}else{return e===t}};const compare=(e,t,n,r)=>{if(t===false&&r){return false}if(t===true&&r){t=r}switch(e){case"=":return errorOprnd("BAD_EQ");case"==":case"":return equals(t,n);case"":case"!=":case"/=":if(Rnl.isRational(t)&&Rnl.isRational(n)){return!Rnl.areEqual(t,n)}else{return t!==n}case">":if(Rnl.isRational(t)&&Rnl.isRational(n)){return Rnl.greaterThan(t,n)}else{return t>n}case"<":if(Rnl.isRational(t)&&Rnl.isRational(n)){return Rnl.lessThan(t,n)}else{return t<n}case"":case">=":if(Rnl.isRational(t)&&Rnl.isRational(n)){return Rnl.greaterThanOrEqualTo(t,n)}else{return t>=n}case"":case"<=":if(Rnl.isRational(t)&&Rnl.isRational(n)){return Rnl.lessThanOrEqualTo(t,n)}else{return t<=n}case"":case"in":if(typeof t==="string"&&typeof n==="string"){if(Array.from(t).length>1){return false}return n.indexOf(t)>-1}else if(Array.isArray(n)&&Rnl.isRational(n[0])&&Rnl.isRational(t)){for(let e=0;e<n.length;e++){if(Rnl.areEqual(t,n[e])){return true}}return false}else if(Array.isArray(n)&&!Array.isArray(t)){for(let e=0;e<n.length;e++){if(equals(t,n[e])){return true}}return false}else if(n instanceof Map){return n.has(t)}else if(typeof t==="string"&&typeof n==="object"&&Object.hasOwnProperty.call(n,"headings")){return Boolean(n.headings.includes(t)||n.rowMap&&Object.hasOwnProperty.call(n.rowMap,t))}else{return errorOprnd("NOT_ARRAY")}case"":if(typeof t==="string"&&typeof n==="string"){if(Array.from(t).length>1){return false}return n.indexOf(t)>-1}else if(t instanceof Map){return t.has(n)}else if(typeof t==="object"&&typeof n==="string"&&Object.hasOwnProperty.call(t,"headings")){return Boolean(t.headings.includes(n)||t.rowMap&&Object.hasOwnProperty.call(t.rowMap,n))}else{return errorOprnd("NO_PROP",t.name)}case"":if(typeof t==="string"&&typeof n==="string"){return t.indexOf(n)>-1}else if(Array.isArray(t)&&Array.isArray(n)){for(let e=0;e<t.length;e++){if(equals(n[0],t[e])){if(e+n.length>t.length){return false}for(let r=1;r<n.length;r++){if(!equals(n[r],t[e+r])){return false}}return true}}return false}else{return errorOprnd("NOT_ARRAY")}case"":case"!in":if(typeof t==="string"&&typeof n==="string"){if(Array.from(t).length===1){return false}return n.indexOf(t)===-1}else if(Array.isArray(n)&&Rnl.isRational(n[0])&&Rnl.isRational(t)){for(let e=0;e<n.length;e++){if(Rnl.areEqual(t,n[e])){return false}}return true}else if(Array.isArray(n)){for(let e=0;e<n.length;e++){if(t===n[e]){return false}}return true}else if(n instanceof Map){return!n.has(t)}else if(typeof t==="string"&&typeof n==="object"&&Object.hasOwnProperty.call(n,"headings")){return!(n.headings.includes(t)||n.rowMap&&Object.hasOwnProperty.call(n.rowMap,t))}else{return errorOprnd("NOT_ARRAY")}case"":if(typeof t==="string"&&typeof n==="string"){if(Array.from(n).length===1){return false}return t.indexOf(n)===-1}else if(t instanceof Map){return!t.has(n)}else if(typeof t==="object"&&typeof n==="string"&&Object.hasOwnProperty.call(t,"headings")){return!(t.headings.includes(n)||t.rowMap&&Object.hasOwnProperty.call(t.rowMap,n))}else{return errorOprnd("NO_PROP",t.name)}case"":if(typeof t==="string"&&typeof n==="string"){return n.indexOf(t)===-1}else if(Array.isArray(t)&&Array.isArray(n)){for(let e=0;e<n.length;e++){if(equals(t[0],n[e])){if(e+t.length>n.length){continue}let r=true;for(let o=1;o<t.length;o++){if(!equals(t[o],n[e+o])){r=false;continue}}if(!r){continue}return true}}return false}else{return errorOprnd("NOT_ARRAY")}case"":if(typeof t==="string"&&typeof n==="string"){return t.indexOf(n)===-1}else if(Array.isArray(t)&&Array.isArray(n)){for(let e=0;e<t.length;e++){if(equals(n[0],t[e])){if(e+n.length>t.length){continue}let r=true;for(let o=1;o<n.length;o++){if(!equals(n[o],t[e+o])){r=false;continue}}if(!r){continue}return true}}return false}else{return errorOprnd("NOT_ARRAY")}}};const dotProduct$1=(e,t)=>e.map(((e,n)=>Rnl.multiply(e,t[n]))).reduce(((e,t)=>Rnl.add(e,t)));const sumOfSquares=e=>e.map((e=>Rnl.multiply(e,e))).reduce(((e,t)=>Rnl.add(e,t)));const oneTenth=[BigInt(1),BigInt(100)];const unary={scalar:{abs(e){return Rnl.abs(e)},norm(e){return Rnl.abs(e)},negate(e){return Rnl.negate(e)},exp(e){return Rnl.exp(e)},floor(e){return Rnl.floor(e)},ceil(e){return Rnl.ceil(e)},percent(e){return Rnl.multiply(oneTenth,e)},factorial(e){return Rnl.factorial(e)},doubleFactorial(e){return Rnl.doubleFactorial(e)},not(e){return!e}},complex:{abs(e){return Cpx.abs(e)},norm(e){return Cpx.abs(e)},conjugate(e){return Cpx.conjugate(e)},negate(e){return Cpx.negate(e)},exp(e){return Cpx.exp(e)},floor(e){return errorOprnd("NA_COMPL_OP","floor")},ceil(e){return errorOprnd("NA_COMPL_OP","ceil")},percent(e){return errorOprnd("NA_COMPL_OP","percent")},factorial(e){return errorOprnd("NA_COMPL_OP","factorial")},doubleFactorial(e){return errorOprnd("NA_COMPL_OP","factorial")},not(e){return errorOprnd("NA_COMPL_OP","not")}},vector:{abs(e){return Rnl.sqrt(sumOfSquares(e))},norm(e){return Rnl.sqrt(sumOfSquares(e))},negate(e){return e.map((e=>Rnl.negate(e)))},exp(e){return e.map((e=>Rnl.exp(e)))},floor(e){return e.map((e=>Rnl.floor(e)))},ceil(e){return e.map((e=>Rnl.ceil(e)))},percent(e){return e.map((e=>Rnl.multiply(oneTenth,e)))},factorial(e){return e.map((e=>Rnl.factorial(e)))},doubleFactorial(e){return e.map((e=>Rnl.doubleFactorial(e)))},not(e){return e.map((e=>!e))}},matrix:{abs(e){return Matrix.invert(e,true)},norm(e){if(e.length===e[0].length){let t=Rnl.zero;for(let n=0;n<e.length;n++){t=Rnl.add(t,sumOfSquares(e[n]))}return t.sqrt()}},negate(e){return e.map((e=>e.map((e=>Rnl.negate(e)))))},exp(e){return e.map((e=>e.map((e=>Rnl.exp(e)))))},floor(e){return e.map((e=>e.map((e=>Rnl.floor(e)))))},ceil(e){return e.map((e=>e.map((e=>Rnl.ceil(e)))))},percent(e){return e.map((e=>e.map((e=>Rnl.multiply(oneTenth,e)))))},factorial(e){return e.map((e=>e.map((e=>Rnl.factorial(e)))))},doubleFactorial(e){return e.map((e=>e.map((e=>Rnl.doubleFactorial(e)))))},not(e){return e.map((e=>e.map((e=>!e))))}},map:{abs(e){e.data=e.data.map((e=>Rnl.isRational(e[0])?e.map((e=>Rnl.abs(e))):e));return e},negate(e){e.data=e.data.map((e=>Rnl.isRational(e[0])?e.map((e=>Rnl.negate(e))):e));return e},exp(e){e.data=e.data.map((e=>Rnl.isRational(e[0])?e.map((e=>Rnl.exp(e))):e));return e},floor(e){e.data=e.data.map((e=>Rnl.isRational(e[0])?e.map((e=>Rnl.floor(e))):e));return e},ceil(e){e.data=e.data.map((e=>Rnl.isRational(e[0])?e.map((e=>Rnl.ceil(e))):e));return e},percent(e){e.data=e.data.map((e=>Rnl.isRational(e[0])?e.map((e=>Rnl.multiply(oneTenth,e))):e));return e},factorial(e){e.data=e.data.map((e=>Rnl.isRational(e[0])?e.map((e=>Rnl.factorial(e))):e));return e},doubleFactorial(e){e.data=e.data.map((e=>Rnl.isRational(e[0])?e.map((e=>Rnl.doubleFactorial(e))):e));return e},not(e){e.data=e.data.map((e=>typeof e[0]==="boolean"?e.map((e=>!e)):e));return e}}};const condition={scalar(e){return e},vector(e){return e.reduce(((e,t)=>e&&t),true)},matrix(e){const t=new Array(e.length);for(let n=0;n<e.length;n++){t[n]=e[n].reduce(((e,t)=>e&&t),true)}return t.reduce(((e,t)=>e&&t),true)}};const dtype={scalar:{scalar(e,t,n){if(e===dt.DATE||t===dt.DATE){return e===t?dt.RATIONAL:dt.DATE}return n==="&"||n==="hcat"||n==="vcat"?e+(n==="&"||n==="hcat"?dt.ROWVECTOR:dt.COLUMNVECTOR):e},complex(e,t,n){return t},vector(e,t,n){return t},matrix(e,t,n){return t},dataFrame(e,t,n){return t},map(e,t,n){return t}},complex:{scalar(e,t,n){return e},complex(e,t,n){return e}},vector:{scalar(e,t,n){return e},map(e,t,n){return t+(e&dt.ROWVECTOR)+(e&dt.COLUMNVECTOR)}},rowVector:{rowVector(e,t,n){return n==="vcat"?e-dt.ROWVECTOR+dt.MATRIX:e},columnVector(e,t,n){return e},matrix(e,t,n){return n==="multiply"?e:t}},columnVector:{rowVector(e,t,n){return n==="dot"?dt.RATIONAL:n==="cross"?e:e-dt.COLUMNVECTOR+dt.MATRIX},columnVector(e,t,n){return n==="&"||n==="hcat"?e-dt.COLUMNVECTOR+dt.MATRIX:e},matrix(e,t,n){return t}},matrix:{scalar(e,t,n){return e},rowVector(e,t,n){return e},columnVector(e,t,n){return n==="*"||n===""?t:e},matrix(e,t,n){return e},map(e,t,n){return 0}},dataFrame:{scalar(e,t,n){return e}},map:{scalar(e,t,n){return e},vector(e,t,n){return e},matrix(e,t,n){return 0},map(e,t,n){return e}}};const binary={scalar:{scalar:{add(e,t){return Rnl.add(e,t)},subtract(e,t){return Rnl.subtract(e,t)},multiply(e,t){return Rnl.multiply(e,t)},divide(e,t){return Rnl.divide(e,t)},power(e,t){return Cpx.isComplex(e)||Rnl.isNegative(e)&&Rnl.isPositive(t)&&Rnl.lessThan(t,Rnl.one)?Cpx.power([e,Rnl.zero],t):Rnl.power(e,t)},modulo(e,t){return Rnl.mod(e,t)},hypot(e,t){return Rnl.hypot(e,t)},rem(e,t){return Rnl.rem(e,t)},and(e,t){return e&&t},or(e,t){return e||t},xor(e,t){return e!==t},concat(e,t){return[e,t]},unshift(e,t){return[e,t]}},complex:{add(e,t){return[Rnl.add(e,t[0]),t[1]]},subtract(e,t){return[Rnl.subtract(e,t[0]),Rnl.negate(t[1])]},multiply(e,t){return[Rnl.multiply(e,t[0]),Rnl.multiply(e,t[1])]},divide(e,t){return Cpx.divide([e,Rnl.zero],t)},power(e,t){return Cpx.power([e,Rnl.zero],t)},rem(e,t){return errorOprnd("NA_COMPL_OP","rem")},and(e,t){return errorOprnd("NA_COMPL_OP","and")},or(e,t){return errorOprnd("NA_COMPL_OP","or")},xor(e,t){return errorOprnd("NA_COMPL_OP","xor")}},vector:{add(e,t){return t.map((t=>Rnl.add(e,t)))},subtract(e,t){return t.map((t=>Rnl.subtract(e,t)))},multiply(e,t){return t.map((t=>Rnl.multiply(e,t)))},divide(e,t){return t.map((t=>Rnl.divide(e,t)))},power(e,t){return t.map((t=>Rnl.power(e,t)))},modulo(e,t){return t.map((t=>Rnl.mod(e,t)))},rem(e,t){return t.map((t=>Rnl.rem(e,t)))},and(e,t){return t.map((t=>e&&t))},or(e,t){return t.map((t=>e||t))},xor(e,t){return t.map((t=>e!==t))},concat(e,t){return[e,...t]}},matrix:{add(e,t){return t.map((t=>t.map((t=>Rnl.add(e,t)))))},subtract(e,t){return t.map((t=>t.map((t=>Rnl.subtract(e,t)))))},multiply(e,t){return t.map((t=>t.map((t=>Rnl.multiply(e,t)))))},divide(e,t){return t.map((t=>t.map((t=>Rnl.divide(e,t)))))},power(e,t){return t.map((t=>t.map((t=>Rnl.power(e,t)))))},modulo(e,t){return t.map((t=>t.map((t=>Rnl.mod(e,t)))))},rem(e,t){return t.map((t=>t.map((t=>Rnl.rem(e,t)))))},and(e,t){return t.map((t=>t.map((t=>e&&t))))},or(e,t){return t.map((t=>t.map((t=>e||t))))},xor(e,t){return t.map((t=>t.map((t=>e!==t))))},concat(e,t){return errorOprnd("BAD_CONCAT")}},dataFrame:{multiply(e,t){t.data=t.data.map((t=>isNaN(t[0])?t:t.map((t=>{let n=t.length;if(t.indexOf(".")){n-=1}return Rnl.toStringSignificant(Rnl.multiply(e,Rnl.fromString(t)),n)}))));return t},divide(e,t){t.data=t.data.map((t=>isNaN(t[0])?t:t.map((t=>{let n=t.length;if(t.indexOf(".")){n-=1}return Rnl.toStringSignificant(Rnl.divide(e,Rnl.fromString(t)),n)}))));return t}},map:{add(e,t){t.data=t.data.map((t=>Rnl.isRational(t[0])?t.map((t=>Rnl.add(e,t))):t));return t},subtract(e,t){t.data=t.data.map((t=>Rnl.isRational(t[0])?t.map((t=>Rnl.subtract(e,t))):t));return t},multiply(e,t){t.data=t.data.map((t=>Rnl.isRational(t[0])?t.map((t=>Rnl.multiply(e,t))):t));return t},divide(e,t){t.data=t.data.map((t=>Rnl.isRational(t[0])?t.map((t=>Rnl.divide(e,t))):t));return t},power(e,t){t.data=t.data.map((t=>Rnl.isRational(t[0])?t.map((t=>Rnl.power(e,t))):t));return t},modulo(e,t){t.data=t.data.map((t=>Rnl.isRational(t[0])?t.map((t=>Rnl.mod(e,t))):t));return t},rem(e,t){t.data=t.data.map((t=>Rnl.isRational(t[0])?t.map((t=>Rnl.rem(e,t))):t));return t},and(e,t){t.data=t.data.map((t=>typeof t[0]==="boolean"?t.map((t=>e&&t)):t));return t},or(e,t){t.data=t.data.map((t=>typeof t[0]==="boolean"?t.map((t=>e||t)):t));return t},xor(e,t){t.data=t.data.map((t=>typeof t[0]==="boolean"?t.map((t=>e!==t)):t));return t}}},complex:{scalar:{add(e,t){return[Rnl.add(e[0],t),e[1]]},subtract(e,t){return[Rnl.subtract(e[0],t),e[1]]},multiply(e,t){return[Rnl.multiply(e[0],t),Rnl.multiply(e[1],t)]},divide(e,t){return Cpx.divide(e,[t,Rnl.zero])},power(e,t){return Cpx.power(e,[t,Rnl.zero])},rem(e,t){return errorOprnd("NA_COMPL_OP","rem")},and(e,t){return errorOprnd("NA_COMPL_OP","and")},or(e,t){return errorOprnd("NA_COMPL_OP","or")},xor(e,t){return errorOprnd("NA_COMPL_OP","xor")}},complex:{add(e,t){return[Rnl.add(e[0],t[0]),Rnl.add(e[1],t[1])]},subtract(e,t){return[Rnl.subtract(e[0],t[0]),Rnl.subtract(e[1],t[1])]},multiply(e,t){return Cpx.multiply(e,t)},divide(e,t){return Cpx.divide(e,t)},power(e,t){return Cpx.power(e,t)},rem(e,t){return errorOprnd("NA_COMPL_OP","rem")},and(e,t){return errorOprnd("NA_COMPL_OP","and")},or(e,t){return errorOprnd("NA_COMPL_OP","or")},xor(e,t){return errorOprnd("NA_COMPL_OP","xor")}}},vector:{scalar:{add(e,t){return e.map((e=>Rnl.add(e,t)))},subtract(e,t){return e.map((e=>Rnl.subtract(e,t)))},multiply(e,t){return e.map((e=>Rnl.multiply(e,t)))},divide(e,t){return e.map((e=>Rnl.divide(e,t)))},power(e,t){return e.map((e=>Rnl.power(e,t)))},modulo(e,t){return e.map((e=>Rnl.mod(e,t)))},rem(e,t){return e.map((e=>Rnl.rem(e,t)))},and(e,t){return e.map((e=>e&&t))},or(e,t){return e.map((e=>e||t))},xor(e,t){return e.map((e=>e!==t))},concat(e,t){return[...e,t]}}},rowVector:{rowVector:{add(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>Rnl.add(e,t[n])))},subtract(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>Rnl.subtract(e,t[n])))},divide(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>Rnl.divide(e,t[n])))},dot(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return dotProduct$1(e,t)},cross(e,t){if(e.length!==3||t.length!==3){return errorOprnd("CROSS")}const n=[Rnl.zero,Rnl.zero,Rnl.zero];n[0]=Rnl.subtract(Rnl.multiply(e[1],t[2]),Rnl.multiply(e[2],t[1]));n[1]=Rnl.subtract(Rnl.multiply(e[2],t[0]),Rnl.multiply(e[0],t[2]));n[2]=Rnl.subtract(Rnl.multiply(e[0],t[1]),Rnl.multiply(e[1],t[0]));return n},multiply(e,t){if(e.length===1&&t.length===1){return[Rnl.multiply(e[0],t[0])]}return errorOprnd("MIS_ELNUM")},circ(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>Rnl.multiply(e,t[n])))},power(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>Rnl.power(e,t[n])))},modulo(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>Rnl.mod(e,t[n])))},and(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>e&&t[n]))},or(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>e||t[n]))},xor(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>e!==t[n]))},concat(e,t){return e.concat(t)},unshift(e,t){return[e,t]}},columnVector:{add(e,t){if(e.length===1&&t.length===1){return[Rnl.add(e[0],t[0])]}return errorOprnd("MIS_ELNUM")},subtract(e,t){if(e.length===1&&t.length===1){return[Rnl.subtract(e[0],t[0])]}return errorOprnd("MIS_ELNUM")},dot(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return dotProduct$1(e,t)},cross(e,t){if(e.length!==3||t.length!==3){return errorOprnd("CROSS")}const n=[Rnl.zero,Rnl.zero,Rnl.zero];n[0]=Rnl.subtract(Rnl.multiply(e[1],t[2]),Rnl.multiply(e[2],t[1]));n[1]=Rnl.subtract(Rnl.multiply(e[2],t[0]),Rnl.multiply(e[0],t[2]));n[2]=Rnl.subtract(Rnl.multiply(e[0],t[1]),Rnl.multiply(e[1],t[0]));return n},multiply(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return dotProduct$1(e,t)},circ(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>Rnl.multiply(e,t[n])))},power(e,t){if(e.length===1&&t.length===1){return[Rnl.power(e[0],t[0])]}return errorOprnd("MIS_ELNUM")},modulo(e,t){if(e.length===1&&t.length===1){return[Rnl.mod(e[0],t[0])]}return errorOprnd("MIS_ELNUM")},and(e,t){if(e.length===1&&t.length===1){return[e[0]&&t[0]]}return errorOprnd("MIS_ELNUM")},or(e,t){if(e.length===1&&t.length===1){return[e[0]||t[0]]}return errorOprnd("MIS_ELNUM")},xor(e,t){if(e.length===1&&t.length===1){return[e[0]!==t[0]]}return errorOprnd("MIS_ELNUM")},concat(e,t){return"BAD_CONCAT"},unshift(e,t){return"BAD_CONCAT"}},matrix:{add(e,t){if(e.length!==t[0].length){return errorOprnd("MIS_ELNUM")}return t.map((t=>t.map(((t,n)=>Rnl.add(e[n],t)))))},subtract(e,t){if(e.length!==t[0].length){return errorOprnd("MIS_ELNUM")}return t.map((t=>t.map(((t,n)=>Rnl.subtract(e[n],t)))))},multiply(e,t){if(e.length!==t[0].length){return errorOprnd("MIS_ELNUM")}t=t[0].map(((e,n)=>t.map((e=>e[n]))));return t.map((t=>dotProduct$1(e,t)))},circ(e,t){if(e.length!==t[0].length){return errorOprnd("MIS_ELNUM")}return t.map((t=>t.map(((t,n)=>Rnl.multiply(e[n],t)))))},divide(e,t){if(e.length!==t[0].length){return errorOprnd("MIS_ELNUM")}return t.map((t=>t.map(((t,n)=>Rnl.divide(e[n],t)))))},power(e,t){if(e.length!==t[0].length){return errorOprnd("MIS_ELNUM")}return t.map((t=>t.map(((t,n)=>Rnl.power(e[n],t)))))},modulo(e,t){if(e.length!==t[0].length){return errorOprnd("MIS_ELNUM")}return t.map((t=>t.map(((t,n)=>Rnl.mod(e[n],t)))))},concat(e,t){if(e.length!==t[0].length){return errorOprnd("BAD_CONCAT")}return t.map(((t,n)=>[e[n],...t]))},unshift(e,t){if(e.length!==t[0].length){return errorOprnd("BAD_CONCAT")}return[e,...t]}}},columnVector:{rowVector:{add(e,t){if(e.length===1&&t.length===1){return[Rnl.add(e[0],t[0])]}return errorOprnd("MIS_ELNUM")},subtract(e,t){if(e.length===1&&t.length===1){return[Rnl.subtract(e[0],t[0])]}return errorOprnd("MIS_ELNUM")},dot(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return dotProduct$1(e,t)},cross(e,t){if(e.length!==3||t.length!==3){return errorOprnd("CROSS")}const n=[Rnl.zero,Rnl.zero,Rnl.zero];n[0]=Rnl.subtract(Rnl.multiply(e[1],t[2]),Rnl.multiply(e[2],t[1]));n[1]=Rnl.subtract(Rnl.multiply(e[2],t[0]),Rnl.multiply(e[0],t[2]));n[2]=Rnl.subtract(Rnl.multiply(e[0],t[1]),Rnl.multiply(e[1],t[0]));return n},multiply(e,t){if(e[0].length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map((e=>t.map((t=>Rnl.multiply(e,t)))))},divide(e,t){return e.map((e=>t.map((t=>Rnl.divide(e,t)))))},circ(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>Rnl.multiply(e,t[n])))},power(e,t){if(e.length===1&&t.length===1){return[Rnl.power(e[0],t[0])]}return errorOprnd("MIS_ELNUM")},modulo(e,t){if(e.length===1&&t.length===1){return[Rnl.mod(e[0],t[0])]}return errorOprnd("MIS_ELNUM")},and(e,t){if(e.length===1&&t.length===1){return[e[0]&&t[0]]}return errorOprnd("MIS_ELNUM")},or(e,t){if(e.length===1&&t.length===1){return[e[0]||t[0]]}return errorOprnd("MIS_ELNUM")},xor(e,t){if(e.length===1&&t.length===1){return[e[0]!==t[0]]}return errorOprnd("MIS_ELNUM")},concat(e,t){return"BAD_CONCAT"},unshift(e,t){return"BAD_CONCAT"}},columnVector:{add(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>Rnl.add(e,t[n])))},subtract(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>Rnl.subtract(e,t[n])))},divide(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>Rnl.divide(e,t[n])))},dot(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return dotProduct$1(e,t)},cross(e,t){if(e.length!==3||t.length!==3){return errorOprnd("CROSS")}const n=[Rnl.zero,Rnl.zero,Rnl.zero];n[0]=Rnl.subtract(Rnl.multiply(e[1],t[2]),Rnl.multiply(e[2],t[1]));n[1]=Rnl.subtract(Rnl.multiply(e[2],t[0]),Rnl.multiply(e[0],t[2]));n[2]=Rnl.subtract(Rnl.multiply(e[0],t[1]),Rnl.multiply(e[1],t[0]));return n},multiply(e,t){if(e.length===1&&t.length===1){return[Rnl.multiply(e[0],t[0])]}return errorOprnd("MIS_ELNUM")},circ(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>Rnl.multiply(e,t[n])))},power(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>Rnl.power(e,t[n])))},modulo(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>Rnl.mod(e,t[n])))},rem(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>Rnl.rem(e,t[n])))},and(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>e&&t[n]))},or(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>e||t[n]))},xor(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>e!==t[n]))},concat(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>[e,t[n]]))},unshift(e,t){return e.concat(t)}},matrix:{add(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return t.map(((t,n)=>t.map((t=>Rnl.add(e[n],t)))))},subtract(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return t.map(((t,n)=>t.map((t=>Rnl.subtract(e[n],t)))))},multiply(e,t){if(t.length!==1){return errorOprnd("MIS_ELNUM")}return t.map(((t,n)=>t.map((t=>Rnl.multiply(e[n],t)))))},circ(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return t.map(((t,n)=>t.map((t=>Rnl.multiply(e[n],t)))))},divide(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return t.map(((t,n)=>t.map((t=>Rnl.divide(e[n],t)))))},power(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return t.map(((t,n)=>t.map((t=>Rnl.power(e[n],t)))))},mod(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return t.map(((t,n)=>t.map((t=>Rnl.mod(e[n],t)))))},concat(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return t.map(((t,n)=>[e[n],...t]))},unshift(e,t){return"BAD_CONCAT"}},map:{add(e,t){t.data=t.data.map((t=>Rnl.isRational(t[0])?t.map(((t,n)=>Rnl.add(e[n],t))):t));return t},subtract(e,t){t.data=t.data.map((t=>Rnl.isRational(t[0])?t.map(((t,n)=>Rnl.subtract(e[n],t))):t));return t},multiply(e,t){t.data=t.data.map((t=>Rnl.isRational(t[0])?t.map(((t,n)=>Rnl.multiply(e[n],t))):t));return t},divide(e,t){t.data=t.data.map((t=>Rnl.isRational(t[0])?t.map(((t,n)=>Rnl.divide(e[n],t))):t));return t},power(e,t){t.data=t.data.map((t=>Rnl.isRational(t[0])?t.map(((t,n)=>Rnl.power(e[n],t))):t));return t},modulo(e,t){t.data=t.data.map((t=>Rnl.isRational(t[0])?t.map(((t,n)=>Rnl.mod(e[n],t))):t));return t},rem(e,t){t.data=t.data.map((t=>Rnl.isRational(t[0])?t.map(((t,n)=>Rnl.rem(e[n],t))):t));return t},and(e,t){t.data=t.data.map((t=>typeof t[0]==="boolean"?t.map(((t,n)=>e[n]&&t)):t));return t},or(e,t){t.data=t.data.map((t=>typeof t[0]==="boolean"?t.map(((t,n)=>e[n]||t)):t));return t},xor(e,t){t.data=t.data.map((t=>typeof t[0]==="boolean"?t.map(((t,n)=>e[n]!==t)):t));return t}}},matrix:{scalar:{add(e,t){return e.map((e=>e.map((e=>Rnl.add(e,t)))))},subtract(e,t){return e.map((e=>e.map((e=>Rnl.subtract(e,t)))))},multiply(e,t){return e.map((e=>e.map((e=>Rnl.multiply(e,t)))))},divide(e,t){return e.map((e=>e.map((e=>Rnl.divide(e,t)))))},power(e,t){if(e.length===e[0].length&&Rnl.areEqual(t,[BigInt(-1),BigInt(1)])){return Matrix.invert(e)}return e.map((e=>e.map((e=>Rnl.power(e,t)))))},modulo(e,t){return e.map((e=>e.map((e=>Rnl.mod(e,t)))))},rem(e,t){return e.map((e=>e.map((e=>Rnl.rem(e,t)))))}},rowVector:{add(e,t){return e.map((e=>e.map(((e,n)=>Rnl.add(e,t[n])))))},subtract(e,t){return e.map((e=>e.map(((e,n)=>Rnl.subtract(e,t[n])))))},multiply(e,t){return e.map((e=>e.map(((e,n)=>Rnl.multiply(e,t[n])))))},circ(e,t){return e.map((e=>e.map(((e,n)=>Rnl.multiply(e,t[n])))))},divide(e,t){return e.map((e=>e.map(((e,n)=>Rnl.divide(e,t[n])))))},power(e,t){return e.map((e=>e.map(((e,n)=>Rnl.power(e,t[n])))))},modulo(e,t){return e.map((e=>e.map(((e,n)=>Rnl.mod(e,t[n])))))},rem(e,t){return e.map((e=>e.map(((e,n)=>Rnl.rem(e,t[n])))))},unshift(e,t){if(e[0].length!==t.length){return errorOprnd("MIS_ELNUM")}return[...e,t]}},columnVector:{add(e,t){return e.map(((e,n)=>e.map((e=>Rnl.add(e,t[n])))))},subtract(e,t){return e.map(((e,n)=>e.map((e=>Rnl.subtract(e,t[n])))))},multiply(e,t){if(e[0].length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map((e=>dotProduct$1(e,t)))},circ(e,t){return e.map(((e,n)=>e.map((e=>Rnl.multiply(e,t[n])))))},divide(e,t){return e.map(((e,n)=>e.map((e=>Rnl.divide(e,t[n])))))},power(e,t){return e.map(((e,n)=>e.map((e=>Rnl.power(e,t[n])))))},modulo(e,t){return e.map(((e,n)=>e.map((e=>Rnl.mod(e,t[n])))))},rem(e,t){return e.map(((e,n)=>e.map((e=>Rnl.rem(e,t[n])))))},concat(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>[...e,t[n]]))}},matrix:{add(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}if(e[0].length!==t[0].length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>e.map(((e,r)=>Rnl.add(e,t[n][r])))))},subtract(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}if(e[0].length!==t[0].length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>e.map(((e,r)=>Rnl.subtract(e,t[n][r])))))},dot(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}if(e[0].length!==t[0].length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>dotProduct$1(e,t[n]))).reduce(((e,t)=>Rnl.add(e,t)))},cross(e,t){return errorOprnd("CROSS")},multiply(e,t){},circ(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}if(e[0].length!==t[0].length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>e.map(((e,r)=>Rnl.multiply(e,t[n][r])))))},divide(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}if(e[0].length!==t[0].length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>e.map(((e,r)=>Rnl.divide(e,t[n][r])))))},power(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}if(e[0].length!==t[0].length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>e.map(((e,r)=>Rnl.power(e,t[n][r])))))},modulo(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}if(e[0].length!==t[0].length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>e.map(((e,r)=>Rnl.mod(e,t[n][r])))))},rem(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}if(e[0].length!==t[0].length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>e.map(((e,r)=>Rnl.rem(e,t[n][r])))))},and(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}if(e[0].length!==t[0].length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>e.map(((e,r)=>e&&t[n][r]))))},or(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}if(e[0].length!==t[0].length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>e.map(((e,r)=>e||t[n][r]))))},xor(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}if(e[0].length!==t[0].length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>e.map(((e,r)=>e!==t[n][r]))))},concat(e,t){if(e.length!==t.length){return errorOprnd("MIS_ELNUM")}return e.map(((e,n)=>e.concat(t[n])))},unshift(e,t){if(e[0].length!==t[0].length){return errorOprnd("MIS_ELNUM")}return e.concat(t)}},map:{}},dataFrame:{multiply(e,t){e.data=e.data.map((e=>isNaN(e[0])?e:e.map((e=>{let n=e.length;if(e.indexOf(".")){n-=1}return Rnl.toStringSignificant(Rnl.multiply(t,Rnl.fromString(e)),n)}))));return e},divide(e,t){e.data=e.data.map((e=>isNaN(e[0])?e:e.map((e=>{let n=e.length;if(e.indexOf(".")){n-=1}return Rnl.toStringSignificant(Rnl.divide(t,Rnl.fromString(e)),n)}))));return e}},map:{scalar:{add(e,t){e.data=e.data.map((e=>Rnl.isRational(e[0])?e.map((e=>Rnl.add(e,t))):e));return e},subtract(e,t){e.data=e.data.map((e=>Rnl.isRational(e[0])?e.map((e=>Rnl.subtract(e,t))):e));return e},multiply(e,t){e.data=e.data.map((e=>Rnl.isRational(e[0])?e.map((e=>Rnl.multiply(e,t))):e));return e},divide(e,t){e.data=e.data.map((e=>Rnl.isRational(e[0])?e.map((e=>Rnl.divide(e,t))):e));return e},power(e,t){e.data=e.data.map((e=>Rnl.isRational(e[0])?e.map((e=>Rnl.power(e,t))):e));return e},modulo(e,t){e.data=e.data.map((e=>Rnl.isRational(e[0])?e.map((e=>Rnl.mod(e,t))):e));return e},rem(e,t){e.data=e.data.map((e=>Rnl.isRational(e[0])?e.map((e=>Rnl.rem(e,t))):e));return e},and(e,t){e.data=e.data.map((e=>typeof e[0]==="boolean"?e.map((e=>e&&t)):e));return e},or(e,t){e.data=e.data.map((e=>typeof e[0]==="boolean"?e.map((e=>e||t)):e));return e},xor(e,t){e.data=e.data.map((e=>typeof e[0]==="boolean"?e.map((e=>e!==t)):e));return e}},columnVector:{add(e,t){e.data=e.data.map((e=>Rnl.isRational(e[0])?e.map(((e,n)=>Rnl.add(e,t[n]))):e));return e},subtract(e,t){e.data=e.data.map((e=>Rnl.isRational(e[0])?e.map(((e,n)=>Rnl.subtract(e,t[n]))):e));return e},multiply(e,t){e.data=e.data.map((e=>Rnl.isRational(e[0])?e.map(((e,n)=>Rnl.multiply(e,t[n]))):e));return e},divide(e,t){e.data=e.data.map((e=>Rnl.isRational(e[0])?e.map(((e,n)=>Rnl.divide(e,t[n]))):e));return e},power(e,t){e.data=e.data.map((e=>Rnl.isRational(e[0])?e.map(((e,n)=>Rnl.power(e,t[n]))):e));return e},modulo(e,t){e.data=e.data.map((e=>Rnl.isRational(e[0])?e.map(((e,n)=>Rnl.mod(e,t[n]))):e));return e},rem(e,t){e.data=e.data.map((e=>Rnl.isRational(e[0])?e.map(((e,n)=>Rnl.rem(e,t[n]))):e));return e},and(e,t){e.data=e.data.map((e=>typeof e[0]==="boolean"?e.map(((e,n)=>e&&t[n])):e));return e},or(e,t){e.data=e.data.map((e=>typeof e[0]==="boolean"?e.map(((e,n)=>e||t[n])):e));return e},xor(e,t){e.data=e.data.map((e=>typeof e[0]==="boolean"?e.map(((e,n)=>e!==t[n])):e));return e}},matrix:{},map:{}}};const strOps=["","in","","","","!in","","",""];const relations={scalar:{scalar:{relate(e,t,n,r){return compare(e,t,n,r)}},vector:{relate(e,t,n,r){if(r===undefined){return n.map((n=>compare(e,t,n,undefined)))}else if(typeof r!=="object"){return n.map((n=>compare(e,t,n,r)))}else if(Array.isArray(r)){return n.map(((n,o)=>compare(e,t,n,r[o])))}else;}},matrix:{relate(e,t,n,r){if(r===undefined){return n.map((n=>n.map((n=>compare(e,t,n,undefined)))))}else if(typeof r!=="object"){return n.map((n=>n.map((n=>compare(e,t,n,r)))))}else if(Array.isArray(r)){return n.map(((n,o)=>n.map(((n,i)=>compare(e,t,n,r[o][i])))))}else;}},map:{relate(e,t,n,r){if(r===undefined){n.data=n.data.map(((n,r)=>r>0||typeof n[0]!=="string"||strOps.includes(e)?n.map((n=>compare(e,t,n,undefined))):n));return n}}}},vector:{scalar:{relate(e,t,n,r){if(r===undefined){return t.map((t=>compare(e,t,n,undefined)))}else if(typeof r!=="object"){return t.map((t=>compare(e,t,n,r)))}else if(Array.isArray(r)){return t.map(((t,o)=>compare(e,t,n,r[o])))}else;}}},rowVector:{rowVector:{relate(e,t,n,r){if(r===undefined){return t.map(((t,r)=>compare(e,t,n[r],undefined)))}}},matrix:{relate(e,t,n,r){if(r===undefined){if(t.length!==n[0].length){return errorOprnd("MIS_ELNUM")}return n.map((n=>n.map(((n,r)=>compare(e,t[r],n,undefined)))))}}}},columnVector:{columnVector:{relate(e,t,n,r){if(r===undefined){return t.map(((t,r)=>compare(e,t,n[r],undefined)))}}},map:{relate(e,t,n,r){if(r===undefined){n.data=n.data.map(((n,r)=>r>0||typeof n[0]!=="string"||strOps.includes(e)?n.map(((n,r)=>compare(e,t[r],n,undefined))):n));return n}}}},matrix:{scalar:{relate(e,t,n,r){if(r===undefined){return t.map((t=>t.map((t=>compare(e,t,n,undefined)))))}else if(typeof r!=="object"){return t.map((t=>t.map((t=>compare(e,t,n,r)))))}else if(Array.isArray(r)){return t.map(((t,o)=>t.map(((t,i)=>compare(e,t,n,r[o][i])))))}else;}},matrix:{relate(e,t,n,r){if(r===undefined){return t.map(((t,r)=>compare(e,t,n[r],undefined)))}}}}};const isDivByZero=(e,t)=>{switch(t){case"scalar":return e[1]===BigInt(0);case"vector":for(let t=0;t<e.length;t++){if(e[t][1]===BigInt(0)){return true}}return false;case"matrix":for(let t=0;t<e.length;t++){for(let n=0;n<e[0].length;n++){if(e[t][n][1]===BigInt(0)){return true}}}return false;case"map":for(let t=0;t<e.data[0].length;t++){if(Rnl.isRational(e.data[t][0])){for(let n=0;n<e.data.length;n++){if(e.data[n][t][1]===BigInt(0)){return true}}}}return false;default:return false}};const Operators=Object.freeze({unary:unary,binary:binary,relations:relations,condition:condition,dtype:dtype});const wideCharRegEx=/[\uD800-\uDBFF][\uDC00-\uDFFF][\uFE00\uFE01]?/g;const findfirst=(e,t)=>{const n=t.value.indexOf(e.value);const r=arrayOfRegExMatches(wideCharRegEx,t.value.slice(0,n));return Rnl.fromNumber(n+r.length+1)};const textRange=(e,t)=>{if(t.dtype!==dt.RATIONAL&&t.dtype!==dt.RANGE){return errorOprnd("STR_INDEX")}const n=Array.from(e);let r="";if(t.dtype===dt.RATIONAL){const e=Rnl.toNumber(t.value)-1;r=n.at(e)}else if(t.dtype===dt.RANGE){const o=Rnl.toNumber(t.value[0]);const i=Rnl.toNumber(t.value[1]);const s=t.value[2]===""?e.length:Rnl.toNumber(t.value[2]);if(i===1){r=n.slice(o-1,s).join("")}else{for(let e=o-1;e<s;e+=i){r+=n.at(e)}}}return{value:r,unit:null,dtype:dt.STRING}};const startSvg=e=>({tag:"svg",children:[],attrs:{xmlns:"http://www.w3.org/2000/svg",width:250,height:250,style:"display: inline;"},temp:{width:250,height:250,xmin:0,xmax:5,ymin:0,ymax:5,xunitlength:20,yunitlength:20,origin:[0,0],stroke:"black",strokewidth:1,strokedasharray:null,fill:"none",fontstyle:"normal",fontfamily:"sans-serif",fontsize:13.33,fontweight:"normal",markerstrokewidth:1,markerstroke:"black",markerfill:"yellow",markersize:4,marker:"none",dotradius:4,axesstroke:"black",gridstroke:"grey",isDim:false}});const setStrokeAndFill=(e,t)=>{e.attrs["stroke-width"]=t.strokewidth;e.attrs.stroke=t.stroke;e.attrs.fill=t.fill;if(t.strokedasharray!=null&&t.strokedasharray!=="none"){e.attrs["stroke-dasharray"]=t.strokedasharray}};const pointZeroRegEx=/\.0+$/;const chopZ=e=>{const t=e.indexOf(".");if(t===-1){return e}if(pointZeroRegEx.test(e)){return e.replace(pointZeroRegEx,"")}let n;for(n=e.length-1;n>t&&e.charAt(n)==="0";n--){if(n===t){n--}}return e.slice(0,n+1)};const markerDot=(e,t,n,r)=>{if(n==null){n=t.stroke}if(r==null){r=t.fill}const o={tag:"circle",attrs:{}};o.attrs.cx=e[0]*t.xunitlength+t.origin[0];o.attrs.cy=t.height-e[1]*t.yunitlength-t.origin[1];o.attrs.r=t.markersize;o.attrs["stroke-width"]=t.strokewidth;o.attrs.stroke=n;o.attrs.fill=r;return o};const rationals2numbers=e=>{const t=[];for(let n=0;n<e.length;n++){const r=e[n];if(r.dtype){t[n]=rationals2numbers(r.value)}else if(Rnl.isRational(r)){t[n]=Rnl.toNumber(r)}else{t[n]=rationals2numbers(r)}}return t};const arrowhead=(e,t,n)=>{const r=e.temp;const o=[t[0]*r.xunitlength+r.origin[0],r.height-t[1]*r.yunitlength-r.origin[1]];const i=[n[0]*r.xunitlength+r.origin[0],r.height-n[1]*r.yunitlength-r.origin[1]];let s=[i[0]-o[0],i[1]-o[1]];const a=Math.sqrt(s[0]*s[0]+s[1]*s[1]);if(a>1e-8){s=[s[0]/a,s[1]/a];const t=r.marker==="markerdot"?3:r.isDim?0:1;const n=[-s[1],s[0]];const o=a>12?12.5:7.8125;const l=a>12?3:1.875;const c={tag:"path",attrs:{}};c.attrs.d="M "+(i[0]-o*s[0]-l*n[0])+","+(i[1]-o*s[1]-l*n[1])+" L "+(i[0]-t*s[0])+","+(i[1]-t*s[1])+" L "+(i[0]-o*s[0]+l*n[0])+","+(i[1]-o*s[1]+l*n[1])+" z";if(r.isDim){c.attrs.stroke="none"}else{c.attrs["stroke-width"]=r.markerstrokewidth;c.attrs.stroke=r.stroke}c.attrs.fill=r.stroke;e.children.push(c)}};const markAttribute={em:["font-style","italic"],strong:["font-weight","bold"],code:["font-family","monospace"],strikethru:["text-decoration","line-through"],subscript:["font-size","0.8em"]};const textLocal=(e,t,n,r)=>{const o=e.temp;let i="middle";let s=0;let a=o.fontsize/3;if(r!=null){if(r.slice(0,5)==="above"){a=-o.fontsize/2}if(r.slice(0,5)==="below"){a=1.25*o.fontsize}if(r.slice(0,5)==="right"||r.slice(5,10)==="right"){i="start";s=o.fontsize/2}if(r.slice(0,4)==="left"||r.slice(5,9)==="left"){i="end";s=-o.fontsize/2}}const l={tag:"text",children:[],attrs:{}};l.attrs["text"]=n;l.attrs.x=t[0]*o.xunitlength+o.origin[0]+s;l.attrs.y=o.height-t[1]*o.yunitlength-o.origin[1]+a;l.attrs["font-family"]=o.fontfamily;l.attrs["font-size"]=o.fontsize;l.attrs["text-anchor"]=i;const c=inlineMd2ast(n);if(Array.isArray(c)){let e=false;for(const t of c){const n={tag:"tspan",text:t.text};let r=false;if(t.marks){n.attrs={};for(const e of t.marks){const t=markAttribute[e.type];n.attrs[t[0]]=t[1];if(e.type==="subscript"){r=true}}}if(r){if(!e){n.attrs.dy="2"}}else if(e){if(!t.marks){n.attrs={}}n.attrs.dy="-2"}e=r;l.children.push(n)}}e.children.push(l);return e};const pointText=(e,t)=>(e[0]*t.xunitlength+t.origin[0]).toFixed(4)+","+(t.height-e[1]*t.yunitlength-t.origin[1]).toFixed(4);const functions$1={stroke(e,t){e.value.temp.stroke=t.value;return e},strokewidth(e,t){e.value.temp.strokewidth=Rnl.toNumber(t.value);return e},strokedasharray(e,t){e.value.temp.strokedasharray=t.value;return e},fill(e,t){e.value.temp.fill=t.value;return e},fontsize(e,t){e.value.temp.fontsize=Rnl.toNumber(t.value);return e},fontfamily(e,t){e.value.temp.fontfamily=t.value;return e},marker(e,t){e.value.temp.marker=t.value;return e},title(e,t){e.value.children.push({tag:"title",attrs:{text:t.value}});return e},frame(e,t=250,n=250,r="inline"){const o=e.value;const i=o.temp;i.width=typeof t==="number"?t:Rnl.toNumber(t.value);o.attrs.width=i.width;i.height=typeof n==="number"?n:Rnl.toNumber(n.value);o.attrs.height=i.height;if(typeof r!=="string"){r=r.value}if(r!=="inline"){o.attrs.float=r}i.xunitlength=i.width/(i.xmax-i.xmin);i.yunitlength=i.height/(i.ymax-i.ymin);i.origin=[-i.xmin*i.xunitlength,-i.ymin*i.yunitlength];return{value:o,unit:null,dtype:dt.DRAWING}},view(e,t=0,n=5,r,o){const i=e.value;const s=i.temp;s.xmin=typeof t==="number"?t:Rnl.toNumber(t.value);s.xmax=typeof n==="number"?n:Rnl.toNumber(n.value);s.xunitlength=s.width/(s.xmax-s.xmin);s.yunitlength=s.xunitlength;if(r==null){s.origin=[-s.xmin*s.xunitlength,s.height/2];s.ymin=-s.height/(2*s.yunitlength);s.ymax=-s.ymin}else{s.ymin=Rnl.toNumber(r.value);if(o!=null){s.ymax=Rnl.toNumber(o.value);s.yunitlength=s.height/(s.ymax-s.ymin)}else{s.ymax=s.height/s.yunitlength+s.ymin}s.origin=[-s.xmin*s.xunitlength,-s.ymin*s.yunitlength]}return{value:i,unit:null,dtype:dt.DRAWING}},grid(e,t,n,r){const o=e.value;const i=o.temp;t=t==null?i.xunitlength:Rnl.toNumber(t.value)*i.xunitlength;n=n==null?t:Rnl.toNumber(n.value)*i.yunitlength;const s={tag:"path",attrs:{}};let a="";for(let e=i.origin[0];e<i.width;e+=t){a+=" M"+e+",0 "+e+","+i.height}for(let e=i.origin[0]-t;e>0;e-=t){a+=" M"+e+",0 "+e+","+i.height}for(let e=i.height-i.origin[1];e<i.height;e+=n){a+=" M0,"+e+" "+i.width+","+e}for(let e=i.height-i.origin[1]-n;e>0;e-=n){a+=" M0,"+e+" "+i.width+","+e}s.attrs.d=a;s.attrs["stroke-width"]=.5;s.attrs.stroke=i.gridstroke;s.attrs.fill=i.fill;o.children.push(s);if(!r){return{value:o,unit:null,dtype:dt.DRAWING}}},axes(e,t,n,r,o,i){let s=e.value;const a=s.temp;t=t==null?a.xunitlength:Rnl.toNumber(t.value)*a.xunitlength;n=n==null?t:Rnl.toNumber(n.value)*a.yunitlength;const l=a.fontsize;a.fontsize=Math.min(t/2,n/2,10);const c=a.fontsize/4;if(o!=null){this.grid(e,o,i,true)}const d={tag:"path",attrs:{}};let u="M0,"+(a.height-a.origin[1])+" "+a.width+","+(a.height-a.origin[1])+" M"+a.origin[0]+",0 "+a.origin[0]+","+a.height;for(let e=a.origin[0]+t;e<a.width;e+=t){u+=" M"+e+" "+(a.height-a.origin[1]+c)+" "+e+","+(a.height-a.origin[1]-c)}for(let e=a.origin[0]-t;e>0;e-=t){u+=" M"+e+","+(a.height-a.origin[1]+c)+" "+e+","+(a.height-a.origin[1]-c)}for(let e=a.height-a.origin[1]+n;e<a.height;e+=n){u+=" M"+(a.origin[0]+c)+","+e+" "+(a.origin[0]-c)+","+e}for(let e=a.height-a.origin[1]-n;e>0;e-=n){u+=" M"+(a.origin[0]+c)+","+e+" "+(a.origin[0]-c)+","+e}if(r!=null){const e=t/a.xunitlength;const r=n/a.yunitlength;const o=a.xmin>0||a.xmax<0?a.xmin:0;const i=a.ymin>0||a.ymax<0?a.ymin:0;const l=i===0?"below":"above";const c=o===0?"left":"right";const d=Math.floor(1.1-Math.log(e)/Math.log(10))+1;const u=Math.floor(1.1-Math.log(r)/Math.log(10))+1;for(let t=e;t<=a.xmax;t+=e){s=textLocal(s,[t,i],chopZ(t.toFixed(d)),l)}for(let t=-e;a.xmin<=t;t-=e){s=textLocal(s,[t,i],chopZ(t.toFixed(d)),l)}for(let e=r;e<=a.ymax;e+=r){s=textLocal(s,[o,e],chopZ(e.toFixed(u)),c)}for(let e=-r;a.ymin<=e;e-=r){s=textLocal(s,[o,e],chopZ(e.toFixed(u)),c)}}d.attrs.d=u;d.attrs["stroke-width"]=.5;d.attrs.stroke=a.axesstroke;d.attrs.fill=a.fill;s.temp.fontsize=l;s.children.push(d);return{value:s,unit:null,dtype:dt.DRAWING}},line(e,t){const n=e.value;const r=n.temp;const o={tag:"path",attrs:{}};const i=[Rnl.toNumber(t.value[0][0]),Rnl.toNumber(t.value[0][1])];const s=[Rnl.toNumber(t.value[1][0]),Rnl.toNumber(t.value[1][1])];o.attrs.d="M"+(i[0]*r.xunitlength+r.origin[0])+","+(r.height-i[1]*r.yunitlength-r.origin[1])+" "+(s[0]*r.xunitlength+r.origin[0])+","+(r.height-s[1]*r.yunitlength-r.origin[1]);setStrokeAndFill(o,r);n.children.push(o);if(r.marker==="dot"||r.marker==="arrowdot"){n.children.push(markerDot(i,r,r.markerstroke,r.markerfill));if(r.marker==="arrowdot"){arrowhead(n,i,s)}n.children.push(markerDot(s,r,r.markerstroke,r.markerfill))}else if(r.marker==="arrow"){arrowhead(n,i,s)}return{value:n,unit:null,dtype:dt.DRAWING}},path(e,t){const n=e.value;const r=n.temp;const o={tag:"path",attrs:{}};let i="";if(t[0].dtype&&t[0].dtype===dt.STRING){i=t[0].value}else{const e=rationals2numbers(t[0].value);if(e[0].length===2){i="M"+pointText(e[0],r)+" L";for(let t=1;t<e.length;t++){i+=" "+pointText(e[t],r)}}else if(e[0].length===3){i="M"+pointText(e[0],r);for(let t=1;t<e.length;t++){if(e[t][2]===0){i+=" L"+pointText(e[t],r)}else{const n=String(Math.abs(e[t][2])*r.xunitlength);const o=Math.sign(e[t][2])>0?0:1;i+=` A${n},${n} 0 0 ${o} ${pointText(e[t],r)}`}}}}o.attrs.d=i;o.attrs["stroke-width"]=r.strokewidth;if(r.strokedasharray!=null){o.attrs["stroke-dasharray"]=r.strokedasharray}o.attrs.stroke=r.stroke;o.attrs.fill=r.fill;if(r.marker==="dot"){for(let e=0;e<t.length;e++){const o=t[e];if(typeof o[0]==="number"){n.children.push(markerDot(o,r,r.markerstroke,r.markerfill))}else{for(const e of o){n.children.push(markerDot(e,r,r.markerstroke,r.markerfill))}}}}else if(r.marker==="arrow"||r.marker==="arrowdot"){const e=rationals2numbers(t[0].value);if(typeof e[0]!=="number"){const t=e[e.length-1];arrowhead(n,e[e.length-2],t);if(r.marker==="arrowdot"){n.children.push(markerDot(t,r,r.markerstroke,r.markerfill))}}else if(typeof e[0]==="number"){const o=t[t.length-2];const i=e;let s;if(typeof o[0]==="number"){s=o}else{s=o[o.length-1]}arrowhead(n,s,i);if(r.marker==="arrowdot"){n.children.push(markerDot(i,r,r.markerstroke,r.markerfill))}}}n.children.push(o);return{value:n,unit:null,dtype:dt.DRAWING}},rect(e,t,n){const r=e.value;const o=r.temp;const i={tag:"rect",attrs:{}};const s=[Rnl.toNumber(t.value[0][0]),Rnl.toNumber(t.value[0][1])];const a=[Rnl.toNumber(t.value[1][0]),Rnl.toNumber(t.value[1][1])];i.attrs.x=Math.min(s[0],a[0])*o.xunitlength+o.origin[0];i.attrs.y=o.height-Math.max(s[1],a[1])*o.yunitlength-o.origin[1];i.attrs.width=Math.abs((a[0]-s[0])*o.xunitlength);i.attrs.height=Math.abs((a[1]-s[1])*o.yunitlength);if(n!=null){const e=Rnl.toNumber(n.value)*o.xunitlength;i.attrs.rx=e;i.attrs.ry=e}setStrokeAndFill(i,o);r.children.push(i);return{value:r,unit:null,dtype:dt.DRAWING}},circle(e,t,n){const r=e.value;const o=r.temp;const i={tag:"circle",attrs:{}};i.attrs.cx=Rnl.toNumber(t.value[0])*o.xunitlength+o.origin[0];i.attrs.cy=o.height-Rnl.toNumber(t.value[1])*o.yunitlength-o.origin[1];i.attrs.r=Rnl.toNumber(n.value)*o.xunitlength;setStrokeAndFill(i,o);r.children.push(i);return{value:r,unit:null,dtype:dt.DRAWING}},ellipse(e,t,n,r){const o=e.value;const i=o.temp;const s={tag:"ellipse",attrs:{}};s.attrs.cx=Rnl.toNumber(t.value[0])*i.xunitlength+i.origin[0];s.attrs.cy=i.height-Rnl.toNumber(t.value[1])*i.yunitlength-i.origin[1];s.attrs.rx=Rnl.toNumber(n.value)*i.xunitlength;s.attrs.ry=Rnl.toNumber(r.value)*i.yunitlength;setStrokeAndFill(s,i);o.children.push(s);return{value:o,unit:null,dtype:dt.DRAWING}},arc(e,t,n){const r=e.value;const o=r.temp;const i={tag:"path",attrs:{}};const s=[Rnl.toNumber(t.value[0][0]),Rnl.toNumber(t.value[0][1])];const a=[Rnl.toNumber(t.value[1][0]),Rnl.toNumber(t.value[1][1])];if(n==null){const e=[a[0]-s[0],a[1]-s[1]];n=Math.sqrt(e[0]*e[0]+e[1]*e[1])*o.yunitlength}else if(isVector(n)){n=n.value.map((e=>Rnl.toNumber(e)*o.yunitlength))}else{n=Rnl.toNumber(n.value)*o.yunitlength}let l="M"+(s[0]*o.xunitlength+o.origin[0])+","+(o.height-s[1]*o.yunitlength-o.origin[1])+" A";l+=Array.isArray(n)?n[0]+","+n[1]:n+","+n;l+=" 0 0,0 "+(a[0]*o.xunitlength+o.origin[0])+","+(o.height-a[1]*o.yunitlength-o.origin[1]);i.attrs.d=l;setStrokeAndFill(i,o);let c=0;if(o.marker==="arrow"||o.marker==="arrowdot"){const e=[(a[1]-s[1])/4,(s[0]-a[0])/4];c=[(a[0]-s[0])/2,(a[1]-s[1])/2];c=[s[0]+c[0]+e[0],s[1]+c[1]+e[1]]}else{c=[s[0],s[1]]}if(o.marker==="dot"||o.marker==="arrowdot"){r.children.push(markerDot(s,o,o.markerstroke,o.markerfill));if(o.marker==="arrowdot"){arrowhead(r,c,a)}r.children.push(markerDot(a,o,o.markerstroke,o.markerfill))}else if(o.marker==="arrow"){arrowhead(r,c,a)}r.children.push(i);return{value:r,unit:null,dtype:dt.DRAWING}},text(e,t,n,r){const o=textLocal(e.value,[Rnl.toNumber(t.value[0]),Rnl.toNumber(t.value[1])],n.value,r==null?null:r.value);return{value:o,unit:null,dtype:dt.DRAWING}},dot(e,t,n,r,o){let i=e.value;const s=i.temp;let a;const l=Rnl.toNumber(t.value[0])*s.xunitlength+s.origin[0];const c=s.height-Rnl.toNumber(t.value[1])*s.yunitlength-s.origin[1];if(n.value==="+"||n.value==="-"||n.value==="|"){a={tag:"path",attrs:{}};if(n.value==="+"){a.attrs.d=" M "+(l-s.ticklength)+","+c+" L "+(l+s.ticklength)+","+c+" M "+l+","+(c-s.ticklength)+" L "+l+","+(c+s.ticklength);a.attrs["stroke-width"]=.5;a.attrs.stroke=s.axesstroke}else{if(n.value==="-"){a.attrs.d=" M "+(l-s.ticklength)+","+c+" L "+(l+s.ticklength)+","+c}else{a.attrs.d=" M "+l+","+(c-s.ticklength)+" L "+l+","+(c+s.ticklength)}a.attrs["stroke-width"]=s.strokewidth;a.attrs["stroke"]=s.stroke}}else{a={tag:"circle",attrs:{}};a.attrs.cx=l;a.attrs.cy=c;a.attrs.r=s.dotradius;a.attrs["stroke-width"]=s.strokewidth;a.attrs.stroke=s.stroke;a.attrs.fill=n.value==="open"?"white":s.stroke}i.children.push(a);if(r!=null){i=textLocal(i,[Rnl.toNumber(t.value[0]),Rnl.toNumber(t.value[1])],r.value,o==null?"below":o.value)}return{value:i,unit:null,dtype:dt.DRAWING}},leader(e,t,n){const r=e.value.temp.marker;e.value.temp.marker="arrow";e.value.temp.isDim=true;const o=clone(t);o.value.reverse();e=this.path(o);const i=rationals2numbers(o.value[0]);const s=rationals2numbers(o.value[o.value.length-1]);let a="right";if(Math.abs(i[0]-s[0])>=Math.abs(i[1]-s[1])){a=i[0]>=s[0]?"right":"left"}else{a=i[1]<s[1]?"below":"above"}const l=textLocal(e.value,i,n.value,a);l.temp.marker=r;l.temp.isDim=false;return{value:l,unit:null,dtype:dt.DRAWING}},dimension(e,t,n){const r=clone(t.value);const o=r.pop();const i=e.value.temp.strokewidth;e.value.temp.strokewidth=.5;e.value.temp.isDim=true;let s=Rnl.fromNumber(6/e.value.temp.xunitlength);const a=r[r.length-1];let l;if(Rnl.lessThan(r[0][1],o[1])&&Rnl.lessThan(o[1],a[1])||Rnl.lessThan(a[1],o[1])&&Rnl.lessThan(o[1],r[0][1])){if(!Rnl.lessThan(a[0],o[0])){s=Rnl.negate(s)}r.forEach((t=>{e=this.line(e,{value:[[Rnl.add(t[0],s),t[1]],[Rnl.add(o[0],s),t[1]]]})}));e.value.temp.marker="arrow";const t=Rnl.lessThanOrEqualTo(a[0],o[0])?"right":"left";for(let i=0;i<r.length-1;i++){e=this.line(e,{value:[[o[0],r[i][1]],[o[0],r[i+1][1]]],unit:null,dtype:dt.MATRIX});e=this.line(e,{value:[[o[0],r[i+1][1]],[o[0],r[i][1]]],unit:null,dtype:dt.MATRIX});const s=[Rnl.toNumber(o[0]),(Rnl.toNumber(r[i][1])+Rnl.toNumber(r[i+1][1]))/2];const a=r.length===2?n.value:n.value[i];l=textLocal(e.value,s,a,t)}}else{if(!Rnl.lessThan(a[1],o[1])){s=Rnl.negate(s)}r.forEach((t=>{e=this.line(e,{value:[[t[0],Rnl.add(t[1],s)],[t[0],Rnl.add(o[1],s)]]})}));e.value.temp.marker="arrow";const t=Rnl.lessThanOrEqualTo(a[1],o[1])?"above":"below";for(let i=0;i<r.length-1;i++){e=this.line(e,{value:[[r[i][0],o[1]],[r[i+1][0],o[1]]],unit:null,dtype:dt.MATRIX});e=this.line(e,{value:[[r[i+1][0],o[1]],[r[i][0],o[1]]],unit:null,dtype:dt.MATRIX});const s=[(Rnl.toNumber(r[i][0])+Rnl.toNumber(r[i+1][0]))/2,Rnl.toNumber(o[1])];const a=r.length===2?n.value:n.value[i];l=textLocal(e.value,s,a,t)}}l.temp.strokewidth=i;l.temp.marker="none";l.temp.isDim=false;return{value:l,unit:null,dtype:dt.DRAWING}}};const draw=Object.freeze({startSvg:startSvg,functions:functions$1});const ord=["first","second","third","fourth","fifth","sixth","seventh","eighth"];const loadTypesFromInput=e=>{let t=false;const n=e.headings||null;const r=Object.create(null);const o=new Array(9).fill(false);if(e==="service"||!e){return[null,o,1,t]}for(let e=0;e<n.length;e++){const i=n[e].replace("*","");r[i]=e+1;if(n[e].indexOf("*")>-1){t=true;o[e+1]=true}}return[r,o,n.length,t]};const combinationsFromInput=(e,t)=>{const n=e.data;const r=e.headings;const o=[];for(let e=0;e<n[0].length;e++){const i=new Array(10).fill(0);for(let o=0;o<r.length;o++){const s=t[r[o].replace("*","")];i[s]=Rnl.toNumber(n[o][e])}o.push(i)}return o};const newNode=(e,t,n)=>({fixity:e,k:e==="spring"?t:0,x:n,P:[0,0,0,0,0,0,0,0,0],M:[0,0,0,0,0,0,0,0,0],Pr:[0,0,0,0,0,0,0,0,0],PrMin:[0,0,0,0,0,0,0,0,0],Mr:[0,0,0,0,0,0,0,0,0],MrMin:[0,0,0,0,0,0,0,0,0]});const incrementDegreesOfFreedom=e=>{switch(e){case"pinned":return 1;case"fixed":return 0;case"hinge":return 3;default:return 2}};const newSegment=(e,t)=>({length:e,xOfLeftEnd:t,P:[0,0,0,0,0,0,0,0,0],M:[0,0,0,0,0,0,0,0,0],Pf:0,Mf:0,w1:[0,0,0,0,0,0,0,0,0],w2:[0,0,0,0,0,0,0,0,0],Vmax:{left:{value:0,case:0},mid:{value:0,case:0,x:0},right:{value:0,case:0}},Vmin:{left:{value:0,case:0},mid:{value:0,case:0,x:0},right:{value:0,case:0}},Mmax:{left:{value:0,case:0},mid:{value:0,case:0,x:0},right:{value:0,case:0}},Mmin:{left:{value:0,case:0},mid:{value:0,case:0,x:0},right:{value:0,case:0}}});const identifySegment=(e,t)=>{for(let n=0;n<t.segments.length;n++){const r=Rnl.add(t.segments[n].xOfLeftEnd,t.segments[n].length);if(Rnl.lessThanOrEqualTo(e,r)){return n}}return-1};const splitSegment=(e,t,n)=>{const r=Rnl.subtract(n,e[t].xOfLeftEnd);if(t===0){e.unshift(newSegment(r,e[0].xOfLeftEnd))}else{const n=e.slice(0,t);n.push(newSegment(r,e[t].xOfLeftEnd));e=n.concat(e.slice(t))}const o=e[t+1];const i=e[t];for(let e=0;e<9;e++){const t=(o.w2[e]-o.w1[e])/Rnl.toNumber(o.length);i.w1[e]=o.w1[e];i.w2[e]=o.w1[e];o.w1[e]=o.w1[e]+t*Rnl.toNumber(r);i.P[e]=o.P[e];o.P[e]=0;i.M[e]=o.M[e];o.M[e]=0}o.xOfLeftEnd=n;o.length=Rnl.subtract(o.length,i.length);return e};function populateData(e,t){const n="";const r={E:0,I:0,k:0,convention:e.convention?e.convention:1,SI:e.SI||false,doLiveLoadPatterns:e.patterns,gotType:[false,false,false,false,false,false,false,false,false],wMax:0,x:180,allLoadsAreUniform:true};if(e.E===1||e.E===0){r.E=1;r.I=1;r.k=0}else{r.E=e.E;r.I=e.I;r.k=e.k}if(r.E===1&&r.I===1&&e.k!==0){return["E and I are necessary for an analysis with spring supports."]}r.EI=r.E*r.I;let o=0;let i=Rnl.zero;const s=[];const a=[];r.numDegreesOfFreedom=0;const[l,c,d,u]=loadTypesFromInput(t);r.numLoadTypes=d;r.getsPattern=c;r.doLiveLoadPatterns=u;for(o=0;o<e.nodes.length;o++){const t=e.nodes[o];if(!t){return[`The ${ord[o]} node designation is invalid.`]}if(t==="spring"&&e.k===0){return["Error. A model with a spring needs a spring constant, k."]}s.push(newNode(t,r.k,i));r.numDegreesOfFreedom+=incrementDegreesOfFreedom(t);if(o<e.spanLength.length){const t=e.spanLength[o];a.push({length:t,segments:Array(1).fill(newSegment(t,i))});i=Rnl.add(i,t)}}if(a.length===0){return[`No span lengths.`]}const p=a.length;r.numSegments=p;r.length=s[s.length-1].x;for(o=0;o<e.loads.length;o++){const t=e.loads[o];if(t.shape==="w"){continue}if(t.from===0){continue}let n=t.type==="none"?0:l?l[t.type]:1;if(n===0){if(r.comboName!=="service"){return[`The ${ord[o]} load must have a load type defined.`]}else{n=1}}const i=e.loads[o].P;const c=e.loads[o].M;const d=e.loads[o].from;let u=false;for(let e=0;e<s.length;e++){if(Rnl.areEqual(d,s[e].x)){s[e].P[0]+=i;s[e].M[0]+=c;if(n!==0){s[e].P[n]+=i}u=true;break}}if(u){continue}for(let e=0;e<a.length;e++){if(Rnl.greaterThan(d,s[e].x)&&Rnl.lessThan(d,s[e+1].x)){const t=a[e];const o=identifySegment(d,t);if(Rnl.greaterThan(d,t.segments[o].xOfLeftEnd)){t.segments=splitSegment(t.segments,o,d);r.numSegments+=1}r.gotType[0]=true;t.segments[o+1].P[0]+=i;t.segments[o+1].M[0]+=c;if(n!==0){r.gotType[n]=true;t.segments[o+1].P[n]+=i;t.segments[o+1].M[n]+=c}}}}r.allLoadsAreUniform=true;for(o=0;o<e.loads.length;o++){const t=e.loads[o];if(t.shape!=="w"){continue}let n=t.type==="none"?0:l?l[t.type]:1;if(n===0){if(r.comboName!=="service"){return[`The ${ord[o]} load must have a load type defined.`]}else{n=1}}const c=t.wStart;const d=t.wEnd;if(Math.abs(c)>r.wMax){r.wMax=Math.abs(c)}if(Math.abs(d)>r.wMax){r.wMax=Math.abs(d)}const u=t.from;const p=Rnl.isZero(t.to)?i:t.to;const f=(d-c)/Rnl.toNumber(Rnl.subtract(p,u));if(f!==0){r.allLoadsAreUniform=false}let h=0;let m=0;let g=0;let y=0;for(let e=0;e<a.length;e++){if(Rnl.areEqual(u,s[e].x)){h=e;g=0;break}if(Rnl.greaterThan(u,s[e].x)&&Rnl.lessThan(u,s[e+1].x)){for(let t=0;t<a[e].segments.length;t++){const n=a[e].segments[t];if(Rnl.areEqual(u,n.xOfLeftEnd)){h=e;g=t;break}const o=t<a[e].segments.length-1?a[e].segments[t+1].xOfLeftEnd:s[e+1].x;if(Rnl.greaterThan(u,n.xOfLeftEnd)&&Rnl.lessThan(u,o)){a[e].segments=splitSegment(a[e].segments,t,u);r.numSegments+=1;h=e;g=t+1;break}}}}for(let e=0;e<a.length;e++){if(Rnl.areEqual(p,s[e+1].x)){m=e;y=a[e].segments.length-1;break}if(Rnl.greaterThan(p,s[e].x)&&Rnl.lessThan(p,s[e+1].x)){for(let t=0;t<a[e].segments.length;t++){const n=a[e].segments[t];const o=t<a[e].segments.length-1?a[e].segments[t+1].xOfLeftEnd:s[e+1].x;if(Rnl.areEqual(p,o)){m=e;y=t;break}if(Rnl.greaterThan(p,n.xOfLeftEnd)&&Rnl.lessThan(p,o)){a[e].segments=splitSegment(a[e].segments,t,p);r.numSegments+=1;m=e;y=t;break}}}}for(let e=h;e<=m;e++){const t=a[e];const r=e===h?g:0;const o=e===m?y:a[e].segments.length-1;for(let e=r;e<=o;e++){const r=t.segments[e].xOfLeftEnd;const o=c+f*Rnl.toNumber(Rnl.subtract(r,u));const i=Rnl.add(t.segments[e].xOfLeftEnd,t.segments[e].length);const s=c+f*Rnl.toNumber(Rnl.subtract(i,u));t.segments[e].w1[0]+=o;t.segments[e].w2[0]+=s;t.segments[e].w1[n]+=o;t.segments[e].w2[n]+=s}}r.gotType[0]=true;if(n!==0){r.gotType[n]=true}}for(let e=0;e<s.length;e++){s[e].x=Rnl.toNumber(s[e].x)}for(let e=0;e<a.length;e++){a[e].length=Rnl.toNumber(a[e].length);for(let t=0;t<a[e].segments.length;t++){a[e].segments[t].length=Rnl.toNumber(a[e].segments[t].length);a[e].segments[t].xOfLeftEnd=Rnl.toNumber(a[e].segments[t].xOfLeftEnd)}}r.length=Rnl.toNumber(r.length);const f=typeof t==="string"?"service":combinationsFromInput(t,l);return[n,r,s,a,f]}const circle=(e,t,n)=>({tag:"circle",attrs:{cx:e,cy:t,r:n}});const restraint=(e,t)=>{const n=[];const r=t.xDiagram+t.xScale*e.x;if(e.fixity==="hinge"||e.fixity==="proppedHinge"){n.push(circle(t.xDiagram+t.xScale*e.x,t.yLoad,4))}const o={tag:"path",attrs:{d:""}};if(e.fixity==="pinned"||e.fixity==="proppedHinge"){const n=e.fixity==="pinned"?t.yLoad+.75:t.yLoad+4;o.attrs.d=`M${r} ${n} l5 10 h-10 z`;o.attrs.style="fill:#fff; stroke:#000"}else if(e.fixity==="fixed"){const n=(e.x===0?-1:1)*7;o.attrs.d=`M${r} ${t.yLoad-7} v14 m0 -14 l${n} 7 M${r} ${t.yLoad} l${n} 7 M${r} ${t.yLoad+7} l${n} 7`}else if(e.fixity==="spring"){const e=t.yLoad+.75;o.attrs.d=`M${r} ${e} v3 l6 1.5 -12 3 12 3 -12 3 6 1.5 v3 m-6 0 h12`}n.push(o);return n};const pointForce=(e,t,n,r,o=false)=>{const i=n<0?-1:1;const s=r==="fixed"?7:r==="pinned"&&o?10:r==="proppedHinge"&&o?18:r==="hinge"?4:r==="spring"&&o?18:0;const a=40-s;const l=t+(o?55:-45);if(o){t+=s+.75}else{t-=.75}if(i===-1&&o){t+=a}if(i===1&&!o){t-=a}const c={tag:"path",attrs:{style:"fill: #000; fill-opacity:1.0",d:`M${e} ${t} l${i*4} ${i*8} h${-i*3.5} v${i*(a-8)} h${-i*1} v${-i*(a-8)} h${-i*3}z`}};const d=textNode(String(Math.abs(n)),e,l,"middle");return[c,d]};const pointMoment=(e,t,n,r=false)=>{let o=n>=0;n=Math.abs(n);let i;let s;if(!r){i=momentArrow(e,t,o?165:15,150,o);s=textNode(String(n),e,t-25,"middle")}else{o=!o;if(e<100){i=momentArrow(e,t,o?260:100,140,o);s=textNode(String(n),e-15,t-15,"end")}else{i=momentArrow(e,t,o?80:280,140,o);s=textNode(String(n),e+16,t-15)}}return[...i,s]};const momentArrow=(e,t,n,r,o)=>{const i=n*(Math.PI/180);const s=o?1:-1;const a=i-s*r*(Math.PI/180);const l=35;const c=l/2;const d=8;const u=i-s*(2*.9*d/l);const p=a-i<=180?"0":"1";let f=0;let h=0;let m=0;let g=0;if(s>0){m=(e+c*Math.cos(u)).toFixed(2);g=(t-c*Math.sin(u)).toFixed(2);f=(e+c*Math.cos(a)).toFixed(2);h=(t-c*Math.sin(a)).toFixed(2)}else{f=(e+c*Math.cos(u)).toFixed(2);h=(t-c*Math.sin(u)).toFixed(2);m=(e+c*Math.cos(a)).toFixed(2);g=(t-c*Math.sin(a)).toFixed(2)}const y={tag:"path",attrs:{d:`M${f} ${h}A${c} ${c} 0 ${p} 0 ${m} ${g}`}};const b=e+c*Math.cos(i);const x=t-c*Math.sin(i);const w=i-s*100/180*Math.PI;const S=22.5*Math.PI/180;const R=Array(3).fill("");const v=Array(3).fill("");R[0]=b.toFixed(2);v[0]=x.toFixed(2);R[1]=(b+d*Math.cos(w-S)).toFixed(2);v[1]=(x-d*Math.sin(w-S)).toFixed(2);R[2]=(b+d*Math.cos(w+S)).toFixed(2);v[2]=(x-d*Math.sin(w+S)).toFixed(2);let M="";for(let e=0;e<R.length;e++){M+=`${R[e]} ${v[e]} `}const A={tag:"polygon",attrs:{points:M}};return[y,A]};const polyline=(e,t)=>{let n=`M${e[0]} ${t[0]}`;for(let r=1;r<e.length;r++){n+=` L${e[r]} ${t[r]}`}return{tag:"path",attrs:{d:n,stroke:"black","fill-opacity":"0.0"}}};const textNode=(e,t,n,r)=>{const o={tag:"text",attrs:{x:String(t),y:String(n)}};if(r==="middle"||r==="end"){o.attrs["text-anchor"]=r}o.children=[{tag:"tspan",text:e}];return o};const Draw=Object.freeze({pointForce:pointForce,pointMoment:pointMoment,polyline:polyline,restraint:restraint,textNode:textNode});const round$1=(e,t)=>{const n=e.toPrecision(t);if(n.indexOf("e")===-1){return n}const r=n.indexOf("e");const o=Number.parseFloat(n.slice(0,r));const i=Number.parseFloat(n.slice(r+1));return(o*10**i).toString()};function createLoadDiagram(e,t,n){e.xDiagram=90;e.yLoad=80;e.xScale=300/t[t.length-1].x;const r=e.SI?1:.3048;const o=e.SI?1e3:4448.2216152605;const i=e.SI?1e3:4448.2216152605*.3048;const s=e.SI?1e3:4448.2216152605/.3048;let a=[];a.push({tag:"title",attrs:{text:"Beam Diagram"}});a.push({tag:"defs",attrs:{},style:`svg { background-color: #fff; }\ntext, tspan { font: 12px Arial; }`});a.push(Draw.textNode("loads",20,e.yLoad+2));a.push(Draw.textNode(`(${e.SI?"kN, m":"kips, ft"})`,20,e.yLoad+16));a.push({tag:"path",attrs:{stroke:"black","stroke-width":"1.5px",d:`M${e.xDiagram} ${e.yLoad} h300`}});for(let n=0;n<t.length;n++){if(t[n].fixity!=="continuous"){a=a.concat(Draw.restraint(t[n],e))}}for(let o=0;o<n.length;o++){let i=true;if(n[o].length*e.xScale<30){continue}if(i){for(let e=1;e<n[o].segments.length;e++){if(n[o].segments[e].P[0]>0){i=false;break}}}if(i){const i=e.xDiagram+e.xScale*(t[o].x+n[o].length/2);const s=e.SI?"":"";const l=round$1(n[o].length/r,3);a.push(Draw.textNode(`${l}${s}`,i,e.yLoad+15))}}for(let n=0;n<t.length;n++){const r=e.xDiagram+e.xScale*t[n].x;if(Math.abs(t[n].P[0])>0){const i=round$1(t[n].P[0]/o,3);a=a.concat(Draw.pointForce(r,e.yLoad,i,t[n].fixity))}if(Math.abs(t[n].M[0])>0){const o=round$1(t[n].M[0]/i,3);a=a.concat(Draw.pointMoment(r,e.yLoad,o))}}const l=20/e.wMax;let c=0;let d=`M${e.xDiagram} ${e.yLoad}`;for(let t=0;t<n.length;t++){for(let r=0;r<n[t].segments.length;r++){const s=n[t].segments[r];const u=e.xDiagram+e.xScale*s.xOfLeftEnd;if(Math.abs(s.P[0])>0){const t=round$1(s.P[0]/o,3);a=a.concat(Draw.pointForce(u,e.yLoad,t,"continuous"))}if(Math.abs(s.M[0])>0){const t=round$1(s.M[0]/i,3);a=a.concat(Draw.pointMoment(u,e.yLoad,t))}const p=u+e.xScale*s.length;if(s.w1[0]!==c){d+=`V${e.yLoad+s.w1[0]*l}`}const f=e.yLoad+s.w2[0]*l;d+=`L${p} ${f}`;c=s.w2[0]}}if(c!==0){d+=`V${e.yLoad}`}a.push({tag:"path",attrs:{d:d,stroke:"black","fill-opacity":"0.0"}});let u=false;let p;let f=0;const h=[];for(let e=0;e<n.length;e++){for(let t=0;t<n[e].segments.length;t++){h.push(n[e].segments[t])}}const m=h.length;for(let t=0;t<h.length;t++){const n=h[t];if(n.w1[0]===n.w2[0]&&Math.abs(n.w1[0])>0){u=true;if(t===0||n.w1[0]!==h[t-1].w1[0]||u===false){p=t;f=e.xScale*n.xOfLeftEnd}if(t===m-1||h[t+1].w1[0]!==h[t+1].w2[0]||n.w1[0]!==h[t+1].w1[0]){const r=t<m-1?h[t+1].xOfLeftEnd-h[p].xOfLeftEnd:e.length-h[p].xOfLeftEnd;if(r*e.xScale>30){let o=true;const i=n.w1[0]>0?10:-4;const c=e.yLoad+l*n.w1[0]+i;const d=round$1(Math.abs(n.w1[0]/s),3);for(let n=p+1;n<=t;n++){if(e.xScale*Math.abs(h[n].xOfLeftEnd-(h[p].xOfLeftEnd+r/2))<35){if(h[n].M[0]||h[n].P[0]!==0){o=false;break}}}if(o){const t=e.xDiagram+f+e.xScale*r/2;a.push(Draw.textNode(d,t,c))}else{o=true;for(let n=p+1;n<=t;n++){if(e.xScale*Math.abs(h[n].xOfLeftEnd-(h[p].xOfLeftEnd+r/3))<35){if(h[n].M[0]||h[n].P[0]!==0){o=false;break}}}if(o){const t=e.xDiagram+f+e.xScale*r/3-17;a.push(Draw.textNode(d,t,c))}else{o=true;for(let n=p+1;n<=t;n++){if(e.xScale*Math.abs(h[n].xOfLeftEnd-(h[p].xOfLeftEnd+2*r/3))<5){if(h[n].M[0]||h[n].P[0]!==0){o=false;break}}}if(o){const t=e.xDiagram+f+e.xScale*2*r/3;a.push(Draw.textNode(d,t,c))}else{if(t===0){a.push(Draw.textNode(d,e.xDiagram-35,c))}}}}}}}else{u=false;const r=t===0?0:(h[t-1].w2[0]-h[t-1].w1[0])/h[t-1].length;const o=(n.w2[0]-n.w1[0])/n.length;const i=t===m-1?0:(h[t+1].w2[0]-h[t+1].w1[0])/h[t+1].length;if(Math.abs(o-r)>.05||t===0){if(Math.abs(n.w1[0])>.05){if(n.length*e.xScale>20){const t=round$1(Math.abs(n.w1[0]/s),3);const r=e.xDiagram+e.xScale*n.xOfLeftEnd;const o=n.w1[0]>0?10:-5;const i=e.yLoad+l*n.w1[0]+o;a.push(Draw.textNode(t,r,i))}}}if(Math.abs(o-i)>.05||t===m-1||Math.abs(n.w2[0]-h[t+1].w1[0])>0){if(Math.abs(n.w2[0])>.05){if(n.length*e.xScale>20){const t=round$1(Math.abs(n.w2[0]/s),3);const r=e.xDiagram+e.xScale*(n.xOfLeftEnd+n.length)-30;const o=n.w2[0]>0?10:-5;const i=e.yLoad+l*n.w2[0]+o;a.push(Draw.textNode(t,r,i))}}}}}return a}const ftRegEx=//g;const numberRegEx$4=new RegExp(Rnl.numberPattern);const lengths=["ft","m","cm","mm"];const metricLengths=["m","cm","mm"];const readNumber=e=>{const t=numberRegEx$4.exec(e);if(t){const e=t[0];return[Rnl.fromString(e),e.length]}else{return["Error",null]}};const convertToBaseUnit=(e,t)=>{const n=unitFromUnitName(t);return Rnl.multiply(Rnl.add(e,n.gauge),n.factor)};const readInputData=e=>{const t=Object.create(null);t.nodes=[];t.spanLength=[];t.loads=[];t.E=1;t.I=1;t.k=0;t.SI=false;t.convention=1;const n=e[1][0].trim();if(numberRegEx$4.test(n)){t.nodes.push("continuous")}const r=n.split(/ +/g);for(let e=0;e<r.length;e++){switch(r[e]){case"p":case"":t.nodes.push("pinned");break;case"f":case"":t.nodes.push("fixed");break;case"h":case"":t.nodes.push("hinged");break;case"ph":case"":case"":t.nodes.push("proppedHinge");break;case"s":case"":t.nodes.push("spring");break;case"-":t.nodes.push("continuous");break;default:{const n=r[e].replace(ftRegEx,"ft");const[o,i]=readNumber(n);if(typeof o==="string"){return"Error. Non-numeric length."}let s=n.slice(i).trim();if(s===""){if(lengths.includes(r[e+1])){s=r[e+1];e+=1}else{s="mm"}}if(metricLengths.includes(s)){t.SI=true}t.spanLength.push(convertToBaseUnit(o,s));break}}}if(numberRegEx$4.test(r[r.length-1])){t.nodes.push("continuous")}for(let n=1;n<e[0].length;n++){const r=e[0][n].trim();let o=e[1][n].trim();switch(r){case"E":{const[e,n]=readNumber(o);if(typeof e==="string"){return"Error. Non-numeric E."}const r=o.slice(n).trim();t.E=Rnl.toNumber(convertToBaseUnit(e,r));break}case"I":{const[e,n]=readNumber(o);if(typeof e==="string"){return"Error. Non-numeric I."}const r=o.slice(n).trim();t.I=Rnl.toNumber(convertToBaseUnit(e,r));break}case"k":{const[e,n]=readNumber(o);if(typeof e==="string"){return"Error. Non-numeric k."}const r=o.slice(n).trim();t.k=Rnl.toNumber(convertToBaseUnit(e,r));break}case"+M":{t.convention=o.charAt(0).toLowerCase()===""?1:-1;break}default:{const e=Object.create(null);o=o.replace(ftRegEx,"ft");const n=o.split(",");let i=n[0];e.type=r;e.from=Rnl.zero;e.to=Rnl.zero;e.P=0;e.M=0;e.wStart=0;e.wEnd=0;let[s,a]=readNumber(i);if(typeof s==="string"){return"Error. Non-numeric load."}let l=s;i=i.slice(a).trim();if(i.slice(0,1)===":"){i=i.slice(1).trim();[l,a]=readNumber(i);i=i.slice(a).trim()}const c=i.trim();const d=unitFromUnitName(c);let u=0;let p=0;let f="";if(n.length>1){i=n[1].trim();[u,a]=readNumber(i);i=i.slice(a).trim();if(i.slice(0,1)===":"){i=i.slice(1).trim();[p,a]=readNumber(i);i=i.slice(a).trim()}else{p=u}f=i.trim();if(f===""){f="mm"}}const h=d.expos.join("");if(h==="01-200000"){e.shape="w";e.wStart=Rnl.toNumber(convertToBaseUnit(s,c));e.wEnd=Rnl.toNumber(convertToBaseUnit(l,c))}else if(h==="11-200000"){e.shape="P";e.P=Rnl.toNumber(convertToBaseUnit(s,c))}else if(h==="21-200000"){e.shape="M";e.M=Rnl.toNumber(convertToBaseUnit(s,c))}else{return`Error. ${c} is not a force, line load, or moment.`}if(u!==0){e.from=convertToBaseUnit(u,f)}if(p!==0){e.to=convertToBaseUnit(p,f)}t.loads.push(e)}}}return t};const dotProduct=(e,t)=>e.map(((e,n)=>e*t[n])).reduce(((e,t)=>e+t));const isLiveish=(e,t)=>t.getsPattern[e];function doAnalysis(e,t,n){const r=t.length;const o=n.length;const i=e.gotType;const s=e.numDegreesOfFreedom;const a=4*o+r;e.numEndActions=a;const l=e.EI;t.unshift(0);n.unshift(0);const c=[];c.push([0,0,0,0,0]);for(let e=1;e<=o;e++){const t=[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]];t[1][1]=l*12/n[e].length**3;t[1][2]=l*6/n[e].length**2;t[1][3]=-l*12/n[e].length**3;t[1][4]=l*6/n[e].length**2;t[2][1]=l*6/n[e].length**2;t[2][2]=l*4/n[e].length;t[2][3]=-l*6/n[e].length**2;t[2][4]=l*2/n[e].length;t[3][1]=-l*12/n[e].length**3;t[3][2]=-l*6/n[e].length**2;t[3][3]=l*12/n[e].length**3;t[3][4]=-l*6/n[e].length**2;t[4][1]=l*6/n[e].length**2;t[4][2]=l*2/n[e].length;t[4][3]=-l*6/n[e].length**2;t[4][4]=l*4/n[e].length;c.push(t)}const d=new Array(a+1).fill(0).map((e=>new Array(s+1).fill(0)));let u=0;for(let e=1;e<=r;e++){if(e===1){if(t[e].fixity==="continuous"||t[e].fixity==="spring"){d[1][1]=1;d[2][1]=1;d[3][2]=1;u=2}else if(t[e].fixity==="fixed");else if(t[e].fixity==="pinned"){d[3][1]=1;u=1}}else if(e===r){if(t[e].fixity==="continuous"||t[e].fixity==="spring"){u=u+1;d[5*o-1][u]=1;u=u+1;d[5*o][u]=1;d[5*o+1][u-1]=1}else if(t[e].fixity==="fixed");else if(t[e].fixity==="pinned"){u=u+1;d[5*o][u]=1}}else{if(t[e].fixity==="continuous"||t[e].fixity==="spring"){u=u+1;d[5*(e-1)-1][u]=1;d[5*(e-1)+1][u]=1;d[5*(e-1)+2][u]=1;u=u+1;d[5*(e-1)][u]=1;d[5*(e-1)+3][u]=1}else if(t[e].fixity==="hinge"){u=u+1;d[5*(e-1)-1][u]=1;d[5*(e-1)+1][u]=1;d[5*(e-1)+2][u]=1;u=u+1;d[5*(e-1)][u]=1;u=u+1;d[5*(e-1)+3][u]=1}else if(t[e].fixity==="proppedHinge"){u=u+1;d[5*(e-1)][u]=1;u=u+1;d[5*(e-1)+3][u]=1}else if(t[e].fixity==="fixed");else if(t[e].fixity==="pinned"){u=u+1;d[5*(e-1)][u]=1;d[5*(e-1)+3][u]=1}}}const p=createLsmDtm(c,d,t,a,s);const[f,h]=createSM(d,p,s);let m=[];let g=[];if(s>1){[m,g]=luDecomposition(f,h)}e.containsLive=false;for(let t=1;t<=e.numLoadTypes;t++){if(e.getsPattern[t]){e.containsLive=true;break}}const y=!e.containsLive?1:!e.doLiveLoadPatterns?1:o>7?e.patterns:2;const b=new Array(a+1).fill(0);const x=new Array(s+1).fill(0);let w;let S;const R=new Array(e.numLoadTypes);const v=new Array(e.numLoadTypes);for(let t=0;t<=e.numLoadTypes;t++){if(e.getsPattern[t]){R[t]=new Array(a+1).fill(0);for(let e=0;e<R[t].length;e++){R[t][e]=new Array(s).fill(0)}v[t]=new Array(s+1).fill(0);for(let e=0;e<v[t].length;e++){v[t][e]=Array(o+1).fill(0)}}else{R[t]=new Array(a).fill(0);v[t]=new Array(s).fill(0)}}for(let c=0;c<=9;c++){if(c===0||i[c]){let i=0;let d=false;if(c===0){d=false;i=1}else if(isLiveish(c,e)&&y>1){d=true;i=o}else{d=false;i=1}for(let u=1;u<=i;u++){for(let e=1;e<=o;e++){const r=n[e].length;const o=5*e-4;const i=5*e-3;const s=5*e-2;const a=5*e-1;const l=5*e;b[o]=0;b[i]=0;b[s]=0;b[a]=0;b[l]=0;let p=false;if(!d){p=true}else{p=e===u}if(p){for(let d=0;d<n[e].segments.length;d++){const u=n[e].segments[d];let p=0;let f=0;const h=u.xOfLeftEnd-t[e].x;let m=u.length;let g=r-h-m;let y=h+m;const x=m+g;let w=false;let S=0;let R=0;let v=0;let M=0;let A=0;if(Math.abs(u.w1[c])<1e-9){u.w1[c]=0}if(Math.abs(u.w2[c])<1e-9){u.w2[c]=0}if(u.w1[c]!==0&&u.w2[c]!==0&&Math.sign(u.w1[c])!==Math.sign(u.w2[c])){w=true;p=0;f=(u.w2[c]-u.w1[c])/m;S=h-u.w1[c]/f;R=y-S;v=g;M=y;A=M-R;m=S-h;y=h+m;g=r-y}else{w=false;p=Math.abs(u.w1[c])<Math.abs(u.w2[c])?u.w1[c]:u.w2[c]}if(h===0){b[o]=u.P[c]}else{b[s]=b[s]+u.P[c]*h*x**2/r**2;b[l]=b[l]-u.P[c]*h**2*x/r**2;b[s]=b[s]-u.M[c]*(-1+4*h/r-3*h**2/r**2);b[l]=b[l]-u.M[c]*h/r*(2-3*h/r);b[i]=b[i]+u.P[c]*x**2/r**3*(3*h+x);b[a]=b[a]+u.P[c]*h**2/r**3*(h+3*x);b[i]=b[i]-6*u.M[c]*h/r**2*(1-h/r);b[a]=b[a]+6*u.M[c]*h/r**2*(1-h/r)}if(p!==0){const e=p*m/(12*r**2*m)*(x**3*(4*r-3*x)-g**3*(4*r-3*g));b[s]=b[s]+e;const t=p*m/(12*r**2*m)*(y**3*(4*r-3*y)-h**3*(4*r-3*h));b[l]=b[l]-t;b[i]=b[i]+p*m/(2*r)*(2*g+m)+(e-t)/r;b[a]=b[a]+p*m/(2*r)*(2*h+m)+(t-e)/r}if(Math.abs(u.w1[c])>Math.abs(u.w2[c])||w){const e=u.w1[c]-p;const t=e;const n=h+m/3;const o=t*y/m;const d=o*r**2/60*(y/r)**2*(10-10*y/r+3*y**2/r**2)-(o-t)*r**2/60*(h/r)**2*(10-10*h/r+3*h**2/r**2)-t*r**2/12*(h/r)**2*(6-8*h/r+3*h**2/r**2);b[s]=b[s]+d;const f=o*r**2/60*(y/r)**3*(5-3*y/r)-(o-t)*r**2/60*(h/r)**3*(5-3*h/r)-t*r**2/12*(h/r)**3*(4-3*h/r);b[l]=b[l]-f;b[i]=b[i]+.5*(t*m)*(r-n)/r+(d-f)/r;b[a]=b[a]+.5*(t*m)*n/r+(f-d)/r}else if(Math.abs(u.w2[c])>Math.abs(u.w1[c])){const e=u.w2[c]-p;const t=e;const n=h+2*m/3;const o=t*x/m;const d=o*r**2/60*(x/r)**3*(5-3*x/r)-(o-t)*r**2/60*(g/r)**3*(5-3*g/r)-t*r**2/12*(g/r)**3*(4-3*g/r);b[s]=b[s]+d;const f=o*r**2/60*(x/r)**2*(10-10*x/r+3*x**2/r**2)-(o-t)*r**2/60*(g/r)**2*(10-10*g/r+3*g**2/r**2)-t*r**2/12*(g/r)**2*(6-8*g/r+3*g**2/r**2);b[l]=b[l]-f;b[i]=b[i]+.5*(t*m)*(r-n)/r+(d-f)/r;b[a]=b[a]+.5*(t*m)*n/r+(f-d)/r}if(w){const e=u.w2[c];const t=S+2*R/3;const n=e*A/R;const o=n*r**2/60*(A/r)**3*(5-3*A/r)-(n-e)*r**2/60*(v/r)**3*(5-3*v/r)-e*r**2/12*(v/r)**3*(4-3*v/r);b[s]=b[s]+o;const d=n*r**2/60*(A/r)**2*(10-10*A/r+3*A**2/r**2)-(n-e)*r**2/60*(v/r)**2*(10-10*v/r+3*v**2/r**2)-e*r**2/12*(v/r)**2*(6-8*v/r+3*v**2/r**2);b[l]=b[l]-d;b[i]=b[i]+.5*(e*R)*(r-t)/r+(o-d)/r;b[a]=b[a]+.5*(e*R)*t/r+(d-o)/r}}}}let i=0;for(let n=1;n<=r;n++){if(n===1){if(t[n].fixity==="continuous"||t[n].fixity==="spring"){x[1]=-b[1]-b[2];x[2]=-b[3];if(isLiveish(c,e)&&y>1){if(u===0){x[1]=x[1]-t[1].P[c];x[2]=x[2]-t[1].M[c]}}else{x[1]=x[1]-t[1].P[c];x[2]=x[2]-t[1].M[c]}i=2}else if(t[n].fixity==="fixed");else if(t[n].fixity==="pinned"){i+=1;x[1]=-b[3];if(isLiveish(c,e)&&y>1){if(u===1){x[i]=x[i]-t[1].M[c]}}else{x[i]=x[i]-t[1].M[c]}}}else if(n===r){if(t[n].fixity==="continuous"||t[n].fixity==="spring"){i+=1;x[i]=-b[5*o-1]-b[5*o+1];i+=1;x[i]=-b[5*o];if(isLiveish(c,e)&&y>1){if(u===o){x[i-1]=x[i-1]-t[r].P[c];x[i]=x[i]-t[r].M[c]}}else{x[i-1]=x[i-1]-t[r].P[c];x[i]=x[i]-t[r].M[c]}}else if(t[n].fixity==="fixed");else if(t[n].fixity==="pinned"){i+=1;x[i]=-b[5*o];if(isLiveish(c,e)&&y>1){if(u===o){x[i]=x[i]-t[r].M[c]}}else{x[i]=x[i]-t[r].M[c]}}}else{if(t[n].fixity==="continuous"||t[n].fixity==="spring"){i+=1;x[i]=-b[5*(n-1)-1]-b[5*(n-1)+1]-b[5*(n-1)+2];i+=1;x[i]=-b[5*(n-1)]-b[5*(n-1)+3];if((c===3||c===5||c===6)&&y>1){if(u===n){x[i-1]=x[i-1]-t[n].P[c];x[i]=x[i]-t[n].M[c]}}else{x[i-1]=x[i-1]-t[n].P[c];x[i]=x[i]-t[n].M[c]}}else if(t[n].fixity==="hinge"){i+=1;x[i]=-b[5*(n-1)-1]-b[5*(n-1)+1]-b[5*(n-1)+2];i+=1;x[i]=-b[5*(n-1)];if((c===3||c===5||c===6)&&y>1){if(u===n){x[i-1]=x[i-1]-t[n].P[c];x[i]=x[i]-t[n].M[c]}}else{x[i-1]=x[i-1]-t[n].P[c];x[i]=x[i]-t[n].M[c]}i+=1;x[i]=-b[5*(n-1)+3]}else if(t[n].fixity==="proppedHinge"){i+=1;x[i]=-b[5*(n-1)];i+=1;x[i]=-b[5*(n-1)+3]}else if(t[n].fixity==="fixed");else if(t[n].fixity==="pinned"){i+=1;x[i]=-b[5*(n-1)]-b[5*(n-1)+3];if((c===3||c===5||c===6)&&y>1){if(u===n){x[i]=x[i]-t[n].M[c]}}else{x[i]=x[i]-t[n].M[c]}}}}if(s===0){S=[0]}else if(s===1){S=[0,x[1]/f[1][1]]}else{S=solveViaLDLt(m,g,x,h)}w=p.map((e=>dotProduct(e,S))).map(((e,t)=>e+b[t]));for(let e=1;e<=a;e++){if(Math.abs(w[e])<1e-14){w[e]=0}}if(!e.getsPattern[c]||typeof R[c][0]==="number"){R[c]=clone(w);if(l!==1){v[c]=clone(S)}}else{for(let e=1;e<5*o+1;e++){R[c][e][u-1]=w[e]}if(l!==1){for(let e=1;e<=s;e++){v[c][e][u]=S[e]}}}if(y===1||!(e.containsLive&&isLiveish(c,e))){if(t[1].fixity==="fixed"){t[1].Mr[c]=w[3]+t[1].M[c]}if(t[1].fixity==="spring"){t[1].Pr[c]=w[1]}else if(t[1].fixity!=="continuous"){t[1].Pr[c]=-w[2]-t[1].P[c]}for(let e=2;e<=o;e++){if(t[e].fixity==="fixed"){t[e].Mr[c]=w[5*(e-1)]+w[5*(e-1)+3]+t[e].M[c]}if(t[e].fixity==="spring"){t[e].Pr[c]=w[5*(e-1)+1]}else if(t[e].fixity!=="continuous"){t[e].Pr[c]=-w[5*(e-1)-1]-w[5*(e-1)+2]-t[e].P[c]}}if(t[r].fixity==="fixed"){t[r].Mr[c]=w[5*o]+t[r].M[c]}if(t[r].fixity==="spring"){t[r].Pr[c]=w[5*o+1]}else if(t[r].fixity!=="continuous"){t[r].Pr[c]=-w[5*o-1]-t[r].P[c]}}else{let e=0;if(t[1].fixity==="fixed"){e=w[3]+t[1].M[c];if(e>0){t[1].Mr[c]=t[1].Mr[c]+e}if(e<0){t[1].MrMin[c]=t[1].MrMin[c]+e}}let n=0;if(t[1].fixity==="spring"){n=w[1]}else if(t[1].fixity!=="continuous"){n=-w[2]-t[1].P[c]}if(n>0){t[1].Pr[c]=t[1].Pr[c]+n}if(n<0){t[1].PrMin[c]=t[1].PrMin[c]+n}for(let r=1;r<o;r++){if(t[r].fixity==="fixed"){e=w[5*(r-1)]+w[5*(r-1)+3]+t[r].M[c];if(e>0){t[r].Mr[c]=t[r].Mr[c]+e}if(e<0){t[r].MrMin[c]=t[r].MrMin[c]+e}}n=0;if(t[r].fixity==="spring"){t[r].Pr[c]=t[r].Pr[c]+w[5*(r-1)+1]}else if(t[r].fixity!=="continuous"){n=-w[5*(r-1)-1]-w[5*(r-1)+2]-t[r].P[c]}if(n>0){t[r].Pr[c]=t[r].Pr[c]+n}if(n<0){t[r].PrMin[c]=t[r].PrMin[c]+n}}if(t[r].fixity==="fixed"){e=w[5*o]+t[o].M[c];if(e>0){t[r].Mr[c]=t[r].Mr[c]+e}if(e<0){t[r].MrMin[c]=t[r].MrMin[c]+e}}n=0;if(t[r].fixity==="spring"){t[r].Pr[c]=t[r].Pr[c]+w[5*o+1]}else if(t[r].fixity!=="continuous"){n=-w[5*o-1]-t[i].P[c]}if(n>0){t[r].Pr[c]=t[r].Pr[c]+n}if(n<0){t[r].PrMin[c]=t[r].PrMin[c]+n}}}}}return[R,v]}const createLsmDtm=(e,t,n,r,o)=>{let i=new Array(r+1).fill(0);i=i.map((e=>new Array(o+1).fill(0)));for(let s=1;s<=r;s++){const r=Math.trunc((s-1)/5)+1;const a=s-1-5*(r-1);for(let l=1;l<=o;l++){if(a===0){i[s][l]=n[r].k*t[s][l]}else{const n=5*r-3;const o=5*r;let c=0;for(let d=n;d<=o;d++){c+=1;i[s][l]=i[s][l]+e[r][a][c]*t[d][l]}}}}return i};const createSM=(e,t,n)=>{let r=Array(n+1).fill(0);r=r.map((e=>Array(n+1).fill(0)));const o=t.length-1;let i=1;for(let n=1;n<e[0].length;n++){for(let s=1;s<=n;s++){for(let i=1;i<=o;i++){r[n][s]=r[n][s]+e[i][n]*t[i][s]}if(r[n][s]!==0&&n-s>i){i=n-s}}}return[r,i]};const luDecomposition=(e,t)=>{const n=new Array(e.length).fill(0);let r=new Array(e.length).fill(0);r=r.map((t=>new Array(e.length-1).fill(0)));const o=e.length-1;for(let i=1;i<=o;i++){let s=Math.max(i-t,1);n[i]=e[i][i];for(let e=s;e<=i-1;e++){n[i]=n[i]-n[e]*r[i][e]*r[i][e]}const a=Math.min(i+t,o);for(let o=i+1;o<=a;o++){s=Math.max(o-t,1);let a=0;for(let e=s;e<=i-1;e++){a=a+n[e]*r[i][e]*r[o][e]}r[o][i]=(e[o][i]-a)/n[i]}}return[n,r]};const solveViaLDLt=(e,t,n,r)=>{const o=n.length-1;for(let e=2;e<=o;e++){const o=e-r<1?1:e-r;for(let r=o;r<=e-1;r++){n[e]=n[e]-t[e][r]*n[r]}}n[o]=n[o]/e[o];for(let i=o-1;i>=1;i--){n[i]=n[i]/e[i];const s=Math.min(o,i+r);for(let e=i+1;e<=s;e++){n[i]=n[i]-t[e][i]*n[e]}}return n};function getLoadPatterns(e,t){if(!e.containsLive||!e.doLiveLoadPatterns){const e=[1];for(let n=2;n<=t;n++){e.push(n)}return[e]}else if(e.numPatterns===2||t>7){const e=[1];for(let n=2;n<=t;n++){e.push(n)}return[e,[]]}else{switch(t){case 1:return[[1],[]];case 2:return[[1,2],[],[1],[2]];case 3:return[[1,2,3],[],[1],[2],[3],[1,2],[1,3],[2,3]];case 4:return[[1,2,3,4],[],[1],[2],[3],[4],[1,2],[1,3],[1,4],[2,3],[2,4],[3,4],[1,2,3],[1,2,4],[1,3,4],[2,3,4]];case 5:return[[1,2,3,4,5],[],[1],[2],[3],[4],[5],[1,2],[1,3],[1,4],[1,5],[2,3],[2,4],[2,5],[3,4],[3,5],[4,5],[1,2,3],[1,2,4],[1,2,5],[1,3,4],[1,3,5],[1,4,5],[2,3,4],[2,3,5],[2,4,5],[3,4,5],[1,2,3,4],[1,2,3,5],[1,2,4,5],[1,3,4,5],[2,3,4,5]];case 6:return[[1,2,3,4,5,6],[],[1],[2],[3],[4],[5],[6],[1,2],[1,3],[1,4],[1,5],[1,6],[2,3],[2,4],[2,5],[2,6],[3,4],[3,5],[3,6],[4,5],[4,6],[5,6],[1,2,3],[1,2,4],[1,2,5],[1,2,6],[1,3,4],[1,3,5],[1,3,6],[1,4,5],[1,4,6],[1,5,6],[2,3,4],[2,3,5],[2,3,6],[2,4,5],[2,4,6],[2,5,6],[3,4,5],[3,4,6],[3,5,6],[4,5,6],[1,2,3,4],[1,2,3,5],[1,2,3,6],[1,2,4,5],[1,2,4,6],[1,2,5,6],[1,3,4,5],[1,3,4,6],[1,3,5,6],[1,4,5,6],[2,3,4,5],[2,3,4,6],[2,3,5,6],[2,4,5,6],[3,4,5,6],[1,2,3,4,5],[1,2,3,4,6],[1,2,3,5,6],[1,2,4,5,6],[1,3,4,5,6],[2,3,4,5,6]];case 7:return[[1,2,3,4,5,6,7],[],[1],[2],[3],[4],[5],[6],[7],[1,2],[1,3],[1,4],[1,5],[1,6],[1,7],[2,3],[2,4],[2,5],[2,6],[2,7],[3,4],[3,5],[3,6],[3,7],[4,5],[4,6],[4,7],[5,6],[5,7],[6,7],[1,2,3],[1,2,4],[1,2,5],[1,2,6],[1,2,7],[1,3,4],[1,3,5],[1,3,6],[1,3,7],[1,4,5],[1,4,6],[1,4,7],[1,5,6],[1,5,7],[1,6,7],[2,3,4],[2,3,5],[2,3,6],[2,3,7],[2,4,5],[2,4,6],[2,4,7],[2,5,6],[2,5,7],[2,6,7],[3,4,5],[3,4,6],[3,4,7],[3,5,6],[3,5,7],[3,6,7],[4,5,6],[4,5,7],[4,6,7],[5,6,7],[1,2,3,4],[1,2,3,5],[1,2,3,6],[1,2,3,7],[1,2,4,5],[1,2,4,6],[1,2,4,7],[1,2,5,6],[1,2,5,7],[1,2,6,7],[1,3,4,5],[1,3,4,6],[1,3,4,7],[1,3,5,6],[1,3,5,7],[1,3,6,7],[1,4,5,6],[1,4,5,7],[1,4,6,7],[1,5,6,7],[2,3,4,5],[2,3,4,6],[2,3,4,7],[2,3,5,6],[2,3,5,7],[2,3,6,7],[2,4,5,6],[2,4,5,7],[2,4,6,7],[2,5,6,7],[3,4,5,6],[3,4,5,7],[3,4,6,7],[3,5,6,7],[4,5,6,7],[1,2,3,4,5],[1,2,3,4,6],[1,2,3,4,7],[1,2,3,5,6],[1,2,3,5,7],[1,2,3,6,7],[1,2,4,5,6],[1,2,4,5,7],[1,2,4,6,7],[1,2,5,6,7],[1,3,4,5,6],[1,3,4,5,7],[1,3,4,6,7],[1,3,5,6,7],[1,4,5,6,7],[2,3,4,5,6],[2,3,4,5,7],[2,3,4,6,7],[2,3,5,6,7],[2,4,5,6,7],[3,4,5,6,7],[1,2,3,4,5,6],[1,2,3,4,5,7],[1,2,3,4,6,7],[1,2,3,5,6,7],[1,2,4,5,6,7],[1,3,4,5,6,7],[2,3,4,5,6,7]]}}}function populateMAM(e,t,n,r,o,i,s){let a=new Array(r.numEndActions).fill(0);const l=i.length-1;const c=o.length-1;const d=r.numPatterns;const u=new Array(c);const p=e[1];a=a.map(((e,t)=>p*s[1][t]));for(let e=1;e<=l;e++){o[e].Pf=p*o[e].P[1];o[e].Mf=p*o[e].M[1];for(let n=0;n<i[e].segments.length;n++){const r=i[e].segments[n];r.w1f[t]=p*r.w1[1];r.w2f=p*r.w2[1];r.Pf=p*r.P[1];r.Mf=p*r.M[1]}}for(let c=2;c<=9;c++){const p=e[c];if(p>0&&r.gotType[c]){if(!r.getsPattern[c]||d===1){a=a.map(((e,t)=>e+p*s[c][t]));for(let e=1;e<=l;e++){o[e].Pf=o[e].Pf+p*o[e].P[c];o[e].Mf=o[e].Mf+p*o[e].M[c];for(let n=0;n<i[e].segments.length;n++){const r=i[e].segments[n];r.w1f[t]=r.w1f[t]+p*r.w1[c];r.w2f=r.w2f+p*r.w2[c];r.Pf=r.Pf+p*r.P[c];r.Mf=r.Mf+p*r.M[c]}}}else{for(let e=1;e<=l;e++){if(n.includes(e)){let t=0;for(let n=1;n<=l;n++){t=5*n-4;a[t]=a[t]+p*s[c][t][e-1];a[t+1]=a[t+1]+p*s[c][t+1][e-1];a[t+2]=a[t+2]+p*s[c][t+2][e-1];a[t+3]=a[t+3]+p*s[c][t+3][e-1];a[t+4]=a[t+4]+p*s[c][t+4][e-1]}a[t+5]=a[t+5]+p*s[c][t+5][e-1]}}u.fill(false);for(let e=1;e<=l;e++){if(n.includes(e)){if(!u[e]){o[e].Pf=o[e].Pf+p*o[e].P[c];o[e].Mf=o[e].Mf+p*o[e].M[c];u[e]=true}if(!u[e+1]){o[e+1].Pf=o[e+1].Pf+p*o[e+1].P[c];o[e+1].Mf=o[e+1].Mf+p*o[e+1].M[c];u[e+1]=true}}for(let r=0;r<i[e].segments.length;r++){const o=i[e].segments[r];if(n.includes(e)){o.w1f[t]=o.w1f[t]+p*o.w1[c];o.w2f=o.w2f+p*o.w2[c];o.Pf=o.Pf+p*o.P[c];o.Mf=o.Mf+p*o.M[c]}}}}}}for(let e=1;e<=l;e++){for(let n=0;n<i[e].segments.length;n++){const r=i[e].segments[n];if(r.length!==0){r.slope[t]=(r.w2f-r.w1f[t])/r.length}}}return a}function combine(e,t,n,r,o,i){const s=n.length-1;const a=i==="service";if(a){i=[[0,1,1,1,1,1,1,1,1,1]]}const l=getLoadPatterns(e,s);const c=l.length;let d=0;let u=0;let p=0;let f=0;let h=0;let m=0;let g=0;let y=0;const b=getNumComberns(i,a,e,c);for(let t=1;t<=s;t++){for(let r=0;r<n[t].segments.length;r++){const o=n[t].segments[r];o.w1f=new Array(b).fill(0);o.w2f=0;o.slope=new Array(b).fill(0);o.V1=new Array(b).fill(0);o.M1=new Array(b).fill(0);if(e.EI!==1){o.theta1=new Array(c).fill(0);o.delta1=new Array(c).fill(0)}}}let x=0;for(let b=0;b<=i.length;b++){const w=b===0&&e.EI!==0?true:a?true:isReqdCombo(i[b-1],e.gotType);if(w){const a=b===0&&e.EI!==0?[0,1,1,1,1,1,1,1,1,1]:i[b-1];for(let i=0;i<c;i++){const c=l[i];const w=populateMAM(a,x,c,e,t,n,r);let S;if(b===0&&e.EI!==1){S=new Array(e.numDegreesOfFreedom+1).fill(0);for(let t=1;t<10;t++){if(e.gotType[t]){if(e.getsPattern[t]){S=getLiveDM(S,o[t],c,s)}else{S=S.map(((e,n)=>e+o[t][n]))}}}}let R=0;for(let r=1;r<=s;r++){let o=0;let i=0;let s=0;let a=0;let l=0;let c=0;let v=0;for(let M=0;M<n[r].segments.length;M++){const A=n[r].segments[M];if(M===0){A.V1[x]=-w[5*r-3];A.M1[x]=w[5*r-2];if(b===0&&e.EI!==1){R=getThetaAndDelta(t[r].fixity,S,A,x,R)}}else{A.V1[x]=i+A.Pf;A.M1[x]=a-A.Mf;if(b===0&&e.EI!==1){A.theta1[x]=l;A.delta1[x]=c}}i=A.V1[x]+A.w1f[x]*A.length+.5*A.slope[x]*A.length**2;if(Math.abs(i)<1e-14){i=0}a=A.M1[x]+A.V1[x]*A.length+.5*A.w1f[x]*A.length**2+A.slope[x]*A.length**3/6;if(Math.abs(a)<1e-14){a=0}if(b===0){if(e.EI!==1){l=A.theta1[x]+(A.M1[x]*A.length+.5*A.V1[x]*A.length**2+A.w1f[x]*A.length**3/6+A.slope[x]*A.length**4/24)/e.EI;v=A.delta1[x]+A.theta1[x]*.5*A.length+(.5*A.M1[x]*(.5*A.length)**2+A.V1[x]*(.5*A.length)**3/6+A.w1f[x]*(.5*A.length)**4/24+A.slope[x]*(.5*A.length)**5/120)/e.EI;c=A.delta1[x]+A.theta1[x]*A.length+(.5*A.M1[x]*A.length**2+A.V1[x]*A.length**3/6+A.w1f[x]*A.length**4/24+A.slope[x]*A.length**5/120)/e.EI;if(A.delta1[x]>h){h=A.delta1[x];m=x}if(A.delta1[x]<g){g=A.delta1[x];m=x}if(c>h){h=c;m=x}if(c<g){g=c;y=x}if(v>h){h=v;m=x}if(v<g){g=v;y=x}}}else{let e=0;if(A.slope[x]!==0){e=-1*A.w1f[x]/A.slope[x];if(e>0&&e<A.length){o=A.V1[x]+A.w1f[x]*e+.5*A.slope[x]*e**2}else{o=A.V1[x]+A.w1f[x]*(A.length/2)+.5*A.slope[x]*(A.length/2)**2}}else{o=A.V1[x]+A.w1f[x]*(A.length/2)+.5*A.slope[x]*(A.length/2)**2}e=0;if(A.slope[x]===0){if(A.w1f[x]!==0){e=-A.V1[x]/A.w1f[x]}}else{if(A.w1f[x]**2-2*A.slope[x]*A.V1[x]>0){e=-(A.w1f[x]+Math.sqrt(A.w1f[x]**2-2*A.slope[x]*A.V1[x]))/A.slope[x]}}if(e>0&&e<A.length){s=A.M1[x]+A.V1[x]*e+.5*A.w1f[x]*e**2+A.slope[x]*e**3/6}else{s=A.M1[x]+A.V1[x]*(A.length/2)+.5*A.w1f[x]*(A.length/2)**2+A.slope[x]*(A.length/2)**3/6}if(A.V1[x]>A.Vmax.left.value&&A.V1[x]>.01){A.Vmax.left.value=A.V1[x];A.Vmax.left.case=x;if(A.V1[x]>u){u=A.V1[x]}}if(o>A.Vmax.mid.value&&o>.01){A.Vmax.mid.value=o;A.Vmax.mid.case=x;if(o>u){u=o}}if(i>A.Vmax.right.value&&i>.01){A.Vmax.right.value=i;A.Vmax.right.case=x;if(i>u){u=i}}if(A.V1[x]<A.Vmin.left.value&&A.V1[x]<-.01){A.Vmin.left.value=A.V1[x];A.Vmin.left.case=x;if(A.V1[x]<d){d=A.V1[x]}}if(o<A.Vmin.mid.value&&o<-.01){A.Vmin.mid.value=o;A.Vmin.mid.case=x;if(o<d){d=o}}if(i<A.Vmin.right.value&&i<-.01){A.Vmin.right.value=i;A.Vmin.right.case=x;if(i<d){d=i}}if(A.M1[x]>A.Mmax.left.value&&A.M1[x]>.01){A.Mmax.left.value=A.M1[x];A.Mmax.left.case=x;if(A.M1[x]>f){f=A.M1[x]}}if(s>A.Mmax.mid.value&&s>.01){A.Mmax.mid.value=s;A.Mmax.mid.case=x;A.Mmax.mid.x=A.xOfLeftEnd+e;if(s>f){f=s}}if(a>A.Mmax.right.value&&a>.01){A.Mmax.right.value=a;A.Mmax.right.case=x;if(a>f){f=a}}if(A.M1[x]<A.Mmin.left.value&&A.M1[x]<-.01){A.Mmin.left.value=A.M1[x];A.Mmin.left.case=x;if(A.M1[x]<p){p=A.M1[x]}}if(s<A.Mmin.mid.value&&s<-.01){A.Mmin.mid.value=s;A.Mmin.mid.case=x;A.Mmin.mid.x=A.xOfLeftEnd+e;if(s<p){p=s}}if(a<A.Mmin.right.value&&a<-.01){A.Mmin.right.value=a;A.Mmin.right.case=x;if(a<p){p=a}}}}}x+=1}}}return[u,d,f,p,h,g,m,y,b]}const isReqdCombo=(e,t)=>{let n=true;for(let r=2;r<e.length;r++){if(e[r]>0){n=false;if(t[r]){return true}}}return n};const getNumComberns=(e,t,n,r)=>{let o=n.EI===1?1:r;for(let i=0;i<e.length;i++){if(t||isReqdCombo(e[i],n.gotType)){o+=r}}return o};const getLiveDM=(e,t,n,r)=>{if(Array.isArray(t[1])){for(let o=1;o<=r;o++){if(n.includes(o)){e=e.map(((e,n)=>e+t[n][o]))}}}else{e=e.map(((e,n)=>e+t[n]))}return e};const getThetaAndDelta=(e,t,n,r,o)=>{if(e==="fixed"){n.delta1[r]=0;n.theta1[r]=0}else if(e==="pinned"){n.delta1[r]=0;o=o+1;n.theta1[r]=-t[o]}else if(e==="continuous"){o=o+1;n.delta1[r]=-t[o];o=o+1;n.theta1[r]=-t[o]}else if(e==="spring"){o=o+1;n.delta1[r]=-t[o];o=o+1;n.theta1[r]=-t[o]}else if(e==="proppedHinge"){o=o+1;n.delta1[r]=0;o=o+1;n.theta1[r]=-t[o]}else if(e==="hinge"){o=o+1;n.delta1[r]=-t[o];o=o+1;o=o+1;n.theta1[r]=-t[o]}return o};function selectCases(e){const t=[];const n=[];for(let r=1;r<e.length;r++){for(let o=0;o<e[r].segments.length;o++){const i=e[r].segments[o];if(i.Vmax.left.value>0){if(!t.includes(i.Vmax.left.case)){t.push(i.Vmax.left.case)}}if(i.Vmin.left.value<0){if(!t.includes(i.Vmin.left.case)){t.push(i.Vmin.left.case)}}if(i.Mmax.left.value>0){if(!n.includes(i.Mmax.left.case)){n.push(i.Mmax.left.case)}}if(i.Mmin.left.value<0){if(!n.includes(i.Mmin.left.case)){n.push(i.Mmin.left.case)}}if(i.Vmax.mid.value>0){if(!t.includes(i.Vmax.mid.case)){t.push(i.Vmax.mid.case)}}if(i.Vmin.mid.value<0){if(!t.includes(i.Vmin.mid.case)){t.push(i.Vmin.mid.case)}}if(i.Mmax.mid.value>0){if(!n.includes(i.Mmax.mid.case)){n.push(i.Mmax.mid.case)}}if(i.Mmin.mid.value<0){if(!n.includes(i.Mmin.mid.case)){n.push(i.Mmin.mid.case)}}if(i.Vmax.right.value>0){if(!t.includes(i.Vmax.right.case)){t.push(i.Vmax.right.case)}}if(i.Vmin.right.value<0){if(!t.includes(i.Vmin.right.case)){t.push(i.Vmin.right.case)}}if(i.Mmax.right.value>0){if(!n.includes(i.Mmax.right.case)){n.push(i.Mmax.right.case)}}if(i.Mmin.right.value<0){if(!n.includes(i.Mmin.right.case)){n.push(i.Mmin.right.case)}}}}return[t,n]}function locateDiagrams(e,t){const[n,r,o,i,s,a,,,]=t;const l=n-r>0?60/(n-r):0;const c=o-i>0?60/(o-i):0;const d=16;let u=n>5e-4?e.yLoad+12+d+n*l+70:e.yLoad+12+d;u=Math.round(u);const p=r<-5e-4?u+r*l+50:u+70;const f=e.convention===1?o:Math.abs(i);const h=e.convention===1?Math.abs(i):o;let m=f>5e-4?p+12+f*c+40:p+12;m=Math.round(m);let g=m;let y=m-c*i;if(y>g){g=y}let b=0;let x=0;if(e.EI!==1){if(s>a){x=30/(s-a)}const e=h>.05*f?m+h*c+14:m+14;b=e+60+s*x;b=Math.round(b);g=b;if(Math.abs(a)>.2*(s-a)){y=b-x*a;if(y>g){g=y}}}g+=20;return[u,m,b,l,c,x,g]}function drawDiagrams(e,t,n,r,o,i,s){let a=[];const l=n.length-1;const[c,d,u,p,,,f,h,m]=i;const[g,y]=r;const[b,x,w,S,R,v]=o;const M=.01*(c-d);const A=.05*(u-p);let T=0;let O=0;let N=0;let E=0;const C=e.length/50;const k=[];const I=[];const D=[];const L=[];const F="middle";a.push(Draw.textNode("shear",20,b+2));a.push(Draw.textNode(`(${e.SI?"kN":"kips"})`,20,b+16));a.push({tag:"path",attrs:{d:`M${e.xDiagram} ${b} h300`,stroke:"black","stroke-width":"1.5px"}});a.push(Draw.textNode("bending",20,x+2));a.push(Draw.textNode(`(${e.SI?"kN-m":"kip-ft"})`,20,x+16));a.push({tag:"path",attrs:{d:`M${e.xDiagram} ${x} h300`,stroke:"black","stroke-width":"1.5px"}});if(s!=="service"){a.push(Draw.textNode("factored",20,b-12));a.push(Draw.textNode("factored",20,x-12))}let _=0;for(let n=1;n<t.length;n++){const r=e.xDiagram+e.xScale*t[n].x;if(Math.abs(t[n].Pr[0])>0){_=1/(e.SI?1e3:4448.2216152605);const o=round$1(t[n].Pr[0]*_,3);a=a.concat(Draw.pointForce(r,e.yLoad,o,t[n].fixity,true))}if(Math.abs(t[n].Mr[0])>0){_=1/(e.SI?1e3:4448.2216152605*.3048);const o=round$1(t[n].Mr[0]*_,3);a=a.concat(Draw.pointMoment(r,e.yLoad,o,true))}}for(let t=0;t<=m;t++){const r=(h===t||f===t)&&e.EI!==1;if(!(g.includes(t)||y.includes(t)||r)){continue}let o=0;let i=0;const s=r?[]:[0];const c=[];const d=[];const u=[];if(!r){d.push(0);u.push(0)}let p=0;for(let a=1;a<=l;a++){for(let l=0;l<n[a].segments.length;l++){const f=n[a].segments[l];const h=f.V1[t]+f.w1f[t]*f.length+.5*f.slope[t]*f.length**2;const m=f.M1[t]+f.V1[t]*f.length+.5*f.w1f[t]*f.length**2+f.slope[t]*f.length**3/6;const g=f.w1f[t]+f.slope[t]*f.length;let y=0;if(r){y=f.delta1[t]+f.theta1[t]*f.length+(.5*f.M1[t]*f.length**2+f.V1[t]*f.length**3/6+f.w1f[t]*f.length**4/24+f.slope[t]*f.length**5/120)/e.EI}let b=0;p+=1;s.push(f.xOfLeftEnd);if(r){c.push(f.delta1[t]);if(f.delta1[t]>T){T=f.delta1[t];N=f.xOfLeftEnd}if(f.delta1[t]<O){O=f.delta1[t];E=f.xOfLeftEnd}if(y>T){T=y;N=f.xOfLeftEnd+f.length}if(y<O){O=y;E=f.xOfLeftEnd+f.length}}else{d.push(f.V1[t]);u.push(f.M1[t])}for(let n=1;n<=Math.trunc(f.length/C);n++){p=p+1;s.push(s[s.length-1]+C);b+=C;if(r){c.push(f.delta1[t]+f.theta1[t]*b+(.5*f.M1[t]*b**2+f.V1[t]*b**3/6+f.w1f[t]*b**4/24+f.slope[t]*b**5/120)/e.EI);if(c[c.length-1]>T){T=c[c.length-1];N=f.xOfLeftEnd+b}if(c[c.length-1]<O){O=c[c.length-1];E=f.xOfLeftEnd+b}}else{d.push(f.V1[t]+f.w1f[t]*b+.5*f.slope[t]*b**2);u.push(f.M1[t]+f.V1[t]*b+.5*f.w1f[t]*b**2+f.slope[t]*b**3/6)}}p+=1;s.push(f.xOfLeftEnd+f.length);if(r){c.push(y)}else{d.push(h);u.push(m)}if(f.Vmax.left.case===t||f.Vmin.left.case===t){if(a===1&&l===0){if(Math.abs(f.V1[t])>M){checkVs(f.V1[t],0,k,I,n,e.length)}}else if(!(i===f.w1f[t]&&Math.abs(f.V1[t]-o)<M)){checkVs(f.V1[t],f.xOfLeftEnd,k,I,n,e.length)}}if(f.Vmax.mid.case===t||f.Vmin.mid.case===t){let r=0;if(f.slope[t]!==0){r=-1*f.w1f[t]/f.slope[t];if(r>0&&r<f.length){const o=f.V1[t]+f.w1f[t]*r+.5*f.slope[t]*r**2;checkVs(o,f.xOfLeftEnd+r,k,I,n,e.length)}}}if(f.Vmax.right.case===t||f.Vmin.right.case===t){if(Math.abs(h)>M){checkVs(h,f.xOfLeftEnd+f.length,k,I,n,e.length)}}if(f.Mmax.left.case===t||f.Mmin.left.case===t){if(a===1&&l===0){if(Math.abs(f.M1[t])>A){checkMs(f.M1[t],0,D,L,n,e.length,A)}}else{checkMs(f.M1[t],f.xOfLeftEnd,D,L,n,e.length,A)}}if(f.Mmax.mid.case===t||f.Mmin.mid.case===t){let r=0;let o=0;if(f.slope[t]===0){if(f.w1f[t]!==0){r=-f.V1[t]/f.w1f[t];if(r>0&&r<f.length){o=f.M1[t]+f.V1[t]*r+.5*f.w1f[t]*r**2+f.slope[t]*r**3/6;checkMs(o,f.xOfLeftEnd+r,D,L,n,e.length,A)}}}else{let i=0;let s=0;let a=0;let l=0;if(f.w1f[t]**2-2*f.slope[t]*f.V1[t]>0){const e=Math.sqrt(f.w1f[t]**2-2*f.slope[t]*f.V1[t]);a=-(f.w1f[t]-e)/f.slope[t];l=-(f.w1f[t]+e)/f.slope[t];if(a>0&&a<f.length){r=a;i=f.M1[t]+f.V1[t]*r+.5*f.w1f[t]*r**2+f.slope[t]*r**3/6}if(l>0&&l<f.length){r=l;s=f.M1[t]+f.V1[t]*r+.5*f.w1f[t]*r**2+f.slope[t]*r**3/6}}if(i>0||s>0){if(i>s){o=i;r=a}else{o=s;r=l}}if(r>0&&r<f.length){o=f.M1[t]+f.V1[t]*r+.5*f.w1f[t]*r**2+f.slope[t]*r**3/6;checkMs(o,f.xOfLeftEnd+r,D,L,n,e.length,A)}}}if(f.Mmax.right.case===t||f.Mmin.right.case===t){checkMs(m,f.xOfLeftEnd+f.length,D,L,n,e.length,A)}i=g;o=h}}const m=p;if(g.includes(t)){let r;let o;if(e.allLoadsAreUniform){let i=new Array(2*e.numSegments+3).fill(0);i=i.map((e=>[0,0]));p=1;i[p][0]=e.xDiagram;i[p][1]=b;for(let r=1;r<=l;r++){for(let o=0;o<n[r].segments.length;o++){const s=n[r].segments[o];p=p+1;i[p][0]=e.xDiagram+e.xScale*s.xOfLeftEnd;i[p][1]=b-S*s.V1[t];p=p+1;i[p][0]=e.xDiagram+e.xScale*(s.xOfLeftEnd+s.length);const a=s.V1[t]+s.w1f[t]*s.length+.5*s.slope[t]*s.length**2;i[p][1]=b-S*a}}p=p+1;i[p][0]=e.xDiagram+e.xScale*e.length;i[p][1]=b;const s=p;r=new Array(s-1);o=new Array(s-1);for(let e=1;e<=s;e++){r[e-1]=i[e][0].toFixed(2);o[e-1]=i[e][1].toFixed(2)}}else{r=new Array(m+1).fill(0);o=new Array(m+1).fill(0);for(let t=0;t<m;t++){r[t]=(e.xDiagram+e.xScale*s[t]).toFixed(2);o[t]=(b-S*d.shift()).toFixed(2)}r[m]=e.xDiagram+300;o[m]=b}a.push(Draw.polyline(r,o))}if(y.includes(t)){const t=new Array(m+1).fill(0);const n=new Array(m+1).fill(0);for(let r=0;r<=m;r++){t[r]=(e.xDiagram+e.xScale*s[r]).toFixed(2);n[r]=(x-e.convention*R*u.shift()).toFixed(2)}t[m+1]=e.xDiagram+300;n[m+1]=x;a.push(Draw.polyline(t,n))}if(r){a.push(Draw.textNode("deflection",20,w+2));a.push({tag:"path",attrs:{d:`M${e.xDiagram} ${w} h300`,stroke:"black","stroke-width":"1.5px"}});const t=new Array(m-1).fill(0);const n=new Array(m-1).fill(0);t[0]=e.xDiagram.toFixed(2);n[0]=w.toFixed(2);for(let r=1;r<=m-1;r++){t[r]=(e.xDiagram+e.xScale*s[r]).toFixed(2);n[r]=(w-v*c[r]).toFixed(2)}a.push(Draw.polyline(t,n))}}_=1/(e.SI?1e3:4448.2216152605);while(k.length>0){const t=(e.xDiagram+e.xScale*I.shift()).toFixed(2);const n=k[0]>0?-2:13;const r=(b-S*k[0]+n).toFixed(2);a.push(Draw.textNode(round$1(k.shift()*_,3),t,r,F))}_=e.convention/(e.SI?1e3:4448.2216152605*.3048);while(D.length>0){const t=(e.xDiagram+e.xScale*L.shift()).toFixed(2);const n=e.convention*D[0]>0?-2:13;const r=(x-e.convention*R*D[0]+n).toFixed(2);const o=round$1(D.shift()*_,3);a.push(Draw.textNode(o,t,r,F))}if(e.EI!==1){e.deflectionMax=Math.max(Math.abs(T),Math.abs(O));_=e.SI?1e3:12/.3048;let t="";let n=0;let r=0;if(T>.2*(T-O)){n=e.xDiagram+e.xScale*N;r=w-v*T-2;if(e.SI){t=round$1(T*_,1)+" mm"}else{t=round$1(T*_,2)+""}a.push(Draw.textNode(t,n,r,F))}if(Math.abs(O)>.2*(T-O)){n=e.xDiagram+e.xScale*E;r=w-v*O+13;if(e.SI){t=round$1(_*O,1)+" mm"}else{t=round$1(_*O,2)+""}a.push(Draw.textNode(t,n,r,F))}}return a}const checkVs=(e,t,n,r,o,i)=>{let s=true;const a=.15*i;for(let n=1;n<o.length;n++){for(let r=0;r<o[n].segments.length;r++){const i=o[n].segments[r];const l=i.xOfLeftEnd+i.length;if(l<t-a){continue}if(i.xOfLeftEnd>t+a){continue}if(Math.abs(i.xOfLeftEnd-t)<a){if(e>0){if(i.Vmax.left.value>e){s=false;break}}else if(i.Vmin.left.value<e){s=false;break}}const c=i.xOfLeftEnd+i.length;if(Math.abs(t-c<a)){if(e>0){if(i.Vmax.right.value>e){s=false;break}}else if(i.Vmin.right.value<e){s=false;break}}}}if(s){n.push(e);r.push(t)}};const checkMs=(e,t,n,r,o,i,s)=>{if(Math.abs(e)<s){return false}let a=true;const l=.15*i;for(let n=1;n<o.length;n++){for(let r=0;r<o[n].segments.length;r++){const i=o[n].segments[r];const s=i.xOfLeftEnd+i.length;if(s<t-l){continue}if(i.xOfLeftEnd>t+l){continue}if(Math.abs(i.xOfLeftEnd-t)<l){if(e>0){if(i.Mmax.left.value>e){a=false;break}}else if(i.Mmin.left.value<e){a=false;break}}if(e>0&&Math.abs(i.Mmax.mid.x-t)<l){if(i.Mmax.mid.value>e){a=false;break}}if(e<0&&Math.abs(i.Mmin.mid.x-t)<l){if(i.Mmin.mid.value<e){a=false;break}}const c=i.xOfLeftEnd+i.length;if(Math.abs(t-c<l)){if(e>0){if(i.Mmax.right.value>e){a=false;break}}else if(i.Mmin.right.value<e){a=false;break}}}}if(a){n.push(e);r.push(t)}};function error(e){if(e===""){return{value:"Error",unit:null,dtype:dt.ERROR}}return{value:e,unit:null,dtype:dt.ERROR}}const beamDiagram=(e,t)=>{const n=readInputData(e);if(typeof n==="string"){return error(n)}const[r,o,i,s,a]=populateData(n,t);if(r){return error(r)}const l={tag:"svg",children:[],attrs:{float:"right"}};const c=createLoadDiagram(o,i,s);l.children=l.children.concat(c);const[d,u]=doAnalysis(o,i,s);const p=combine(o,i,s,d,u,a);const f=selectCases(s);const h=locateDiagrams(o,p);const m=h[6];const g=drawDiagrams(o,i,s,f,h,p,a);l.children=l.children.concat(g);l.attrs.width="375";l.attrs.height=(375/450*m).toFixed(0);l.attrs.viewBox=`0 0 450 ${m.toFixed(0)}`;return l};const setComparisons=["in","!in","","","","","","","",""];const shapeOf=e=>e.dtype===dt.COMPLEX?"complex":e.dtype<128?"scalar":isVector(e)?"vector":e.dtype&dt.MATRIX?"matrix":e.dtype===dt.DATAFRAME?"dataFrame":e.dtype&dt.MAP?"map":"other";const binaryShapesOf=(e,t)=>{let n=shapeOf(e);let r=shapeOf(t);let o=false;if((isMatrix(e)||e.dtyp&dt.MAP)&&(isMatrix(t)||t.dtype&dt.MAP)){o=true;if(n==="vector"){n=e.dtype&dt.ROWVECTOR?"rowVector":"columnVector"}if(r==="vector"){r=t.dtype&dt.ROWVECTOR?"rowVector":"columnVector"}}return[n,r,o]};const matrixMults={"":"cross","":"dot","":"circ",".*":"circ","*":"multiply","":"multiply","":"multiply",modulo:"modulo"};const nextToken=(e,t)=>{if(e.length<t+2){return undefined}return e[t+1]};const arfn=["abs","angle","imag","real","","gamma"];const stringFromOperand=(e,t)=>e.dtype===dt.STRING?e.value:e.dtype===dt.RATIONAL?format(e.value,"h15",t.decimalFormat):isMatrix(e.dtype)?Matrix.displayAlt(e,"h15",t):e.dtype&dt.MAP?DataFrame.displayAlt(e.value,"h15",t):e.value;const evalRpn=(e,t,n,r,o)=>{const i=e.split("");const s=[];let a;for(let e=0;e<i.length;e++){const l=i[e];const c=l.charAt(0);if(c===""){const e=new Array(2);const t=l.indexOf("/");e[0]=BigInt(l.slice(1,t));e[1]=BigInt(l.slice(t+1));const n=Object.create(null);n.value=e;n.unit=Object.create(null);n.unit.expos=allZeros;n.dtype=dt.RATIONAL;s.push(Object.freeze(n))}else if(c===""){const e=Object.create(null);e.value=[BigInt(l.slice(1)),BigInt(1)];e.unit=Object.create(null);e.unit.expos=[0,0,1,0,0,0,0,0],e.dtype=dt.DATE;s.push(Object.freeze(e))}else if(c===""){const e=l.slice(1).split(",");const t=new Array(2);t[0]=[BigInt(e[0]),BigInt(e[1])];t[1]=[BigInt(e[2]),BigInt(e[3])];const n=Object.create(null);n.value=t;n.unit=Object.create(null);n.unit.expos=allZeros;n.dtype=dt.COMPLEX;s.push(Object.freeze(n))}else if(c===""){const n=l.substring(1);let o=Object.create(null);if(n==="undefined"){o.value=undefined;o.unit=null;o.dtype=0}else if(n==="T"&&nextToken(i,e)==="^"&&s.length>0&&isMatrix(s[s.length-1])){e+=1;o=Matrix.transpose(s.pop())}else if(n==="j"&&!t.j){o.value=[Rnl.zero,Rnl.one];o.unit=Object.create(null);o.unit.expos=allZeros;o.dtype=dt.COMPLEX}else{const e=t[n];if(!e){return errorOprnd("V_NAME",n)}o=fromAssignment(e,r);if(o.dtype===dt.ERROR){return o}}s.push(Object.freeze(o))}else if(c==='"'){const e=l.charAt(l.length-1);const t=c==='"'&&e==='"'?l.slice(1,-1):l;s.push(Object.freeze({value:t,unit:null,dtype:dt.STRING}))}else if(/^``/.test(l)){s.push(DataFrame.dataFrameFromTSV(tablessTrim(l.slice(2,-2)),t))}else if(c==="`"){const e=l.charAt(l.length-1);const t=c==="`"&&e==="`"?l.slice(1,-1).trim():l.trim();s.push(Object.freeze({value:t,unit:null,dtype:dt.RICHTEXT}))}else{switch(l){case"true":case"false":{const e=Object.create(null);e.value=l==="true";e.unit=null;e.dtype=dt.BOOLEAN;s.push(Object.freeze(e));break}case"pi":case"":{const e=Object.create(null);e.value=Rnl.pi;e.dtype=dt.RATIONAL;e.unit=Object.create(null);e.unit.expos=allZeros;s.push(Object.freeze(e));break}case"e":{const e=Object.create(null);e.value="e";e.dtype=dt.RATIONAL;e.unit=Object.create(null);e.unit.expos=allZeros;s.push(Object.freeze(e));break}case"":{const e=Object.create(null);e.value=Rnl.hbar;e.dtype=dt.RATIONAL;e.unit=Object.create(null);e.unit.expos=Object.freeze(r?[2,1,-1,0,0,0,0,0]:allZeros);s.push(Object.freeze(e));break}case"":{const e=s.pop();const t=s.pop();if(t.dtype!==dt.RATIONAL||e.dtype!==dt.RATIONAL){return errorOprnd("NAN_OP")}const n=Rnl.toNumber(e.value);const r=Object.create(null);r.value=[Rnl.multiply(t.value,Rnl.fromNumber(Math.cos(n))),Rnl.multiply(t.value,Rnl.fromNumber(Math.sin(n)))];r.unit=Object.create(null);r.unit.expos=allZeros;r.dtype=dt.COMPLEX;s.push(Object.freeze(r));break}case"+":case".+":case"-":case".-":{const e=s.pop();const t=s.pop();const n=l==="+"||l===".+"?"add":"subtract";if(!((t.dtype&dt.RATIONAL||t.dtype&dt.DATE||t.dtype&dt.COMPLEX)&&(e.dtype&dt.RATIONAL||e.dtype&dt.DATE||e.dtype&dt.COMPLEX))){return errorOprnd("NAN_OP")}if(r){if(!unitsAreCompatible(t.unit.expos,e.unit.expos)){return errorOprnd("UNIT_ADD")}}const[o,i,a]=binaryShapesOf(t,e);const c=Object.create(null);c.value=Operators.binary[o][i][n](t.value,e.value);if(c.value.dtype&&c.value.dtype===dt.ERROR){return c.value}c.unit=t.unit;c.dtype=Operators.dtype[o][i](t.dtype,e.dtype,l);s.push(Object.freeze(c));break}case"~":{const e=s.pop();if(!(e.dtype&dt.RATIONAL||e.dtype===dt.COMPLEX)){return errorOprnd("NAN_OP")}const t=Object.create(null);t.value=Operators.unary[shapeOf(e)]["negate"](e.value);if(t.value.dtype&&t.value.dtype===dt.ERROR){return t.value}t.unit=e.unit;t.dtype=e.dtype;s.push(Object.freeze(t));break}case"":case"":case"*":case"":case"":case"":{const e=s.pop();const t=e.dtype===dt.DATAFRAME?clone(e):e;const o=s.pop();if((l==="*"||l==="")&&o.dtype===dt.STRING&&o.dtype===dt.STRING){const e=stringFromOperand(o,n);const r=stringFromOperand(t,n);return{value:e+r,unit:null,dtype:dt.STRING}}if(!((o.dtype&dt.RATIONAL||o.dtype&dt.COMPLEX)&&(t.dtype&dt.RATIONAL||t.dtype&dt.COMPLEX||t.dtype===dt.DATAFRAME))){return errorOprnd("NAN_OP")}const i=Object.create(null);let a=Object.create(null);if(r){if(o.dtype===dt.DATAFRAME&&t.dtype===dt.RATIONAL||o.dtype===dt.RATIONAL&&t.dtype===dt.DATAFRAME){a=o.dtype===dt.DATAFRAME?o.unit:t.unit}else{a.expos=o.unit.expos.map(((e,n)=>e+t.unit.expos[n]))}}else{a.expos=allZeros}i.unit=t.dtype===dt.DATAFRAME?clone(t.unit):Object.freeze(a);const[c,d,u]=binaryShapesOf(o,t);const p=u?matrixMults[l]:"multiply";i.dtype=l===""||c==="scalar"||c==="map"||c==="complex"||d==="scalar"||d==="map"||d==="complex"?Operators.dtype[c][d](o.dtype,t.dtype,p):l===""?dt.RATIONAL:l===""?dt.COLUMNVECTOR:Matrix.multResultType(o,t);i.value=Operators.binary[c][d][p](o.value,t.value);if(i.value.dtype&&i.value.dtype===dt.ERROR){return i.value}s.push(Object.freeze(i));break}case"/":case"./":case"//":case"///":case"":{const e=s.pop();const t=s.pop();if(!((t.dtype&dt.RATIONAL||t.dtype===dt.COMPLEX)&&(e.dtype&dt.RATIONAL||e.dtype===dt.COMPLEX))){return errorOprnd("NAN_OP")}const n=Object.create(null);const o=Object.create(null);o.expos=r?t.unit.expos.map(((t,n)=>t-e.unit.expos[n])):allZeros;n.unit=Object.freeze(o);const[i,a,l]=binaryShapesOf(t,e);n.value=Operators.binary[i][a]["divide"](t.value,e.value);if(n.value.dtype&&n.value.dtype===dt.ERROR){return n.value}n.dtype=Operators.dtype[i][a](t.dtype,e.dtype,"divide");if(isDivByZero(n.value,shapeOf(n))){return errorOprnd("DIV")}s.push(Object.freeze(n));break}case"^":case".^":{const e=s.pop();const t=s.pop();if(!((t.dtype&dt.RATIONAL||t.dtype===dt.COMPLEX)&&(e.dtype&dt.RATIONAL||e.dtype===dt.COMPLEX)||isMatrix(t)&&e.value==="T")){return errorOprnd("NAN_OP")}const n=Object.create(null);const o=Object.create(null);o.expos=allZeros;if(r){const n=typeof e.unit==="number"?e.unit:Rnl.toNumber(e.value);o.expos=t.unit.expos.map((e=>e*n))}n.unit=Object.freeze(o);const[i,a,c]=binaryShapesOf(t,e);n.value=Operators.binary[i][a]["power"](t.value,e.value);if(n.value.dtype){return n.value}n.dtype=Cpx.isComplex(n.value)?dt.COMPLEX:Operators.dtype[i][a](t.dtype,e.dtype,l);s.push(Object.freeze(n));break}case"modulo":{if(r){return errorOprnd("UNIT_UN","modulo")}const e=s.pop();const t=s.pop();if(!(t.dtype&dt.RATIONAL)||!(e.dtype&dt.RATIONAL)){return errorOprnd("NAN_OP")}const[n,o,i]=binaryShapesOf(t,e);const a=Object.create(null);a.unit=allZeros;a.dtype=Operators.dtype[n][o](t.dtype,e.dtype,"modulo");a.value=Operators.binary[n][o]["modulo"](t.value,e.value);s.push(Object.freeze(a));break}case"&":case"hcat":case"vcat":{const e=s.pop();const o=s.pop();const i=l==="vcat"?"unshift":"concat";const[a,c,d]=binaryShapesOf(o,e);let u=Object.create(null);if(o.dtype===dt.STRING&&o.dtype===dt.STRING){const t=stringFromOperand(o,n);const r=stringFromOperand(e,n);u.value=t+r;u.unit=null;u.dtype=dt.STRING}else if(o.dtype&dt.DATAFRAME&&isVector(e)&&l!=="vcat"){u=DataFrame.append(o,e,t.format.value,r);if(u.dtype===dt.ERROR){return u}}else if(isVector(o)&&e.dtype&dt.DATAFRAME&&l!=="vcat"){u=DataFrame.append(o,e,t.format.value,r);if(u.dtype===dt.ERROR){return u}}else if(o.dtype&dt.DATAFRAME&&c==="scalar"||a==="scalar"&&e.dtype&dt.DATAFRAME){u=DataFrame.append(o,e,t.format.value,r);if(u.dtype===dt.ERROR){return u}}else if(o.dtype&dt.MAP||e.dtype&dt.MAP){u=map.append(o,e,a,c);if(u.dtype===dt.ERROR){return u}}else{if(r){if(!unitsAreCompatible(o.unit.expos,e.unit.expos)){return errorOprnd("UNIT_ADD")}}u.value=Operators.binary[a][c][i](o.value,e.value);if(u.value.dtype){return u.value}u.dtype=Operators.dtype[a][c](o.dtype,e.dtype,l);if(o.dtype===dt.COLUMNVECTOR&&c==="scalar"){u.dtype=o.dtype+e.dtype}u.unit=o.unit}s.push(Object.freeze(u));break}case"":case"":case"":{const e=l.charCodeAt(0)-8728;const t=[BigInt(1),BigInt(e)];const n=s.pop();if(!(n.dtype&dt.RATIONAL||n.dtype&dt.COMPLEX)){return errorOprnd("NAN_OP")}const o=Object.create(null);const i=Object.create(null);i.expos=allZeros;if(r){i.expos=n.unit.expos.map((t=>t/e))}o.unit=Object.freeze(i);const a=shapeOf(n);o.value=Operators.binary[a]["scalar"]["power"](n.value,t);if(o.value.dtype&&o.value.dtype===dt.ERROR){return o.value}o.dtype=Cpx.isComplex(o.value)?dt.COMPLEX:Operators.dtype[a]["scalar"](n.dtype,dt.RATIONAL,l);s.push(Object.freeze(o));break}case"root":{const e=s.pop();const t=s.pop();if(!(t.dtype&dt.RATIONAL&(e.dtype&dt.RATIONAL))){return errorOprnd("NAN_OP")}const n=Object.create(null);const o=Object.create(null);o.expos=allZeros;if(r){o.expos=e.unit.expos.map((e=>e/Number(t.value[0])))}n.unit=Object.freeze(o);const i=Rnl.reciprocal(t.value);const a=shapeOf(t);n.value=Operators.binary[a]["scalar"]["power"](e.value,i);if(n.value.dtype&&n.value.dtype===dt.ERROR){return n.value}n.dtype=Operators.dtype[a]["scalar"](t.dtype,dt.RATIONAL,l);s.push(Object.freeze(n));break}case".":{const t=s.pop();const n=s.pop();let o;if((n.dtype===dt.DATAFRAME||n.dtype===dt.SPREADSHEET)&&i.length-e>2&&i[e+2]==="."){const s={value:i[e+1].replace(/"/g,""),unit:null,dtype:dt.STRING};const a=n.dtype===dt.SPREADSHEET?[t,s]:t.value in n.value.columnMap?[s,t]:[t,s];o=n.dtype===dt.DATAFRAME?DataFrame.range(n,a,r):cellOprnd(n,a,r);e+=2}else if((n.dtype===dt.DATAFRAME||n.dtype===dt.SPREADSHEET)&&i.length-e>3&&i[e+2]==="[]"&&i[e+3]==="1"&&i[e+1].slice(0,1)==='"'){const s={value:i[e+1].replace(/"/g,""),unit:null,dtype:dt.STRING};const a=t.value in n.value.columnMap?[s,t]:[t,s];o=n.dtype===dt.DATAFRAME?DataFrame.range(n,a,r):cellOprnd(n,a,r);e+=3}else{o=propertyFromDotAccessor(n,t,r)}if(o.dtype===dt.ERROR){return o}s.push(Object.freeze(o));break}case"[]":{const t=Number(i[e+1]);e+=1;const n=[];for(let e=0;e<t;e++){n.unshift(s.pop())}const o=s.pop();let a;if(o.dtype&dt.DATAFRAME){if(n.length===1&&n[0].dtype===dt.STRING&&i.length-e>2&&i[e+2]==="."){const t=n[0];const s={value:i[e+1].replace(/"/g,""),unit:null,dtype:dt.STRING};const l=t.value in o.value.columnMap?[s,t]:[t,s];a=DataFrame.range(o,l,r);e+=2}else if(n.length===1&&n[0].dtype===dt.STRING&&i.length-e>3&&i[e+2]==="[]"&&i[e+3]==="1"&&i[e+1].slice(0,1)==='"'){const t=n[0];const s={value:i[e+1].replace(/"/g,""),unit:null,dtype:dt.STRING};const l=t.value in o.value.columnMap?[s,t]:[t,s];a=DataFrame.range(o,l,r);e+=3}else{a=DataFrame.range(o,n,r)}}else if(o.dtype&dt.MAP){a=map.range(o,n,r)}else if(o.dtype===dt.STRING){a=textRange(o.value,n[0])}else if(o.dtype===dt.MODULE){if(t===1){a=fromAssignment(o.value[n[0].value],r)}else{a={value:new Map,unit:null,dtype:dt.TUPLE};for(let e=0;e<n.length;e++){const t=n[e].value;a.value.set(t,fromAssignment(o.value[t],r))}}}else{const e=n[0];const i=t===2?n[1]:isVector(o)?null:{value:Rnl.zero,unit:allZeros,dtype:dt.RATIONAL};a=o.dtype&dt.DATAFRAME?DataFrame.range(o,e,i,r):Matrix.submatrix(o,e,i)}if(a.dtype===dt.ERROR){return a}s.push(Object.freeze(a));break}case":":{const e=s.pop();const t=s.pop();if(!(t.dtype===dt.RATIONAL||t.dtype===dt.RANGE)){return errorOprnd("NAN_OP")}const n=Object.create(null);n.unit=null;n.dtype=dt.RANGE;const r=t.dtype!==dt.RATIONAL?t.value[2]:e.value===""||Rnl.lessThanOrEqualTo(t.value,e.value)?Rnl.one:Rnl.negate(Rnl.one);n.value=t.dtype===dt.RATIONAL?[t.value,r,e.value]:[t.value[0],t.value[2],e.value];s.push(Object.freeze(n));break}case"normal":case"uniform":case"lognormal":{s.pop();s.pop();break}case"!":case"":case"!!":{const e=s.pop();if(!(e.dtype&dt.RATIONAL)){return errorOprnd("NAN_OP")}if(r){if(!unitsAreCompatible(e.unit.expos,allZeros)){return errorOprnd("FACT")}}const t=e.value;if(!Rnl.isInteger(t)||Rnl.isNegative(t)){return errorOprnd("FACT")}const n=Object.create(null);n.unit=allZeros;n.dtype=dt.RATIONAL;n.value=l==="!"?Operators.unary[shapeOf(e)]["factorial"](t):Operators.unary[shapeOf(e)]["doubleFactorial"](t);if(n.value.dtype){return n.value}s.push(Object.freeze(n));break}case"%":{const e=s.pop();if(!(e.dtype&dt.RATIONAL)){return errorOprnd("NAN_OP")}const t=Object.create(null);t.unit=e.unit;t.dtype=e.dtype;t.value=Operators.unary[shapeOf(e)]["percent"](e.value);if(t.value){return t.value}s.push(Object.freeze(t));break}case"|":case"":{const e=s.pop();if(!(e.dtype&dt.RATIONAL||e.dtype===dt.COMPLEX)){return errorOprnd("NAN_OP")}const t=l==="|"?"abs":"norm";const n=Object.create(null);n.unit=e.unit;n.dtype=dt.RATIONAL;n.value=Operators.unary[shapeOf(e)][t](e.value);if(n.value.dtype&&n.value.dtype===dt.ERROR){return n.value}s.push(Object.freeze(n));break}case"matrix":{const t=Number(i[e+1]);const n=Number(i[e+2]);e+=2;const r=s.length>0&&s[s.length-1].dtype===dt.RANGE?Matrix.operandFromRange(s.pop().value):Matrix.operandFromTokenStack(s,t,n);if(r.dtype===dt.ERROR){return r}s.push(r);break}case"tuple":{const t=Number(i[e+1]);e+=1;const n={value:[],unit:null,dtype:dt.TUPLE};for(let e=0;e<t;e++){n.value.unshift(s.pop())}s.push(n);break}case"startSvg":s.push({value:draw.startSvg(),unit:null,dtype:dt.DRAWING});break;case"beamDiagram":{const t=Number(i[e+1]);e+=1;let n="service";if(t===2){n=s.pop().value}const r=s.pop();if(!(r.dtype&dt.MAP)){return errorOprnd("BAD_TYPE","beamDiagram")}const o=beamDiagram(r.value.data,n);if(o.dtype&&o.dtype===dt.ERROR){return o}s.push({value:o,resultdisplay:o,unit:null,dtype:dt.DRAWING});break}case"abs":case"cos":case"sin":case"tan":case"acos":case"asin":case"atan":case"sec":case"csc":case"cot":case"asec":case"acsc":case"acot":case"exp":case"log":case"ln":case"log10":case"log2":case"cosh":case"sinh":case"tanh":case"sech":case"csch":case"coth":case"acosh":case"asinh":case"atanh":case"asech":case"acsch":case"acoth":case"gamma":case"":case"lgamma":case"lfact":case"factorial":case"cosd":case"sind":case"tand":case"acosd":case"asind":case"atand":case"secd":case"cscd":case"cotd":case"asecd":case"acscd":case"acotd":case"real":case"imag":case"angle":case"conj":case"ceil":case"floor":case"Char":case"round":case"sqrt":case"sign":{const e=s.pop();if(!(e.dtype&dt.RATIONAL||e.dtype&dt.COMPLEX)){return errorOprnd("UNREAL",l)}const t=Object.create(null);const n=Object.create(null);n.expos=r?Functions.functionExpos(l,[e]):allZeros;if(n.expos.dtype&&n.expos.dtype===dt.ERROR){return n.expos}t.unit=l==="Char"?null:Object.freeze(n);const o=e.dtype&dt.RATIONAL?"scalar":"complex";let i;if(e.dtype&dt.MAP){i=e.value;i.data=i.data.map((e=>Rnl.isRational(e[0])?e.map((e=>Functions.unary[o][l](e))):e))}else{i=isVector(e)?e.value.map((e=>Functions.unary[o][l](e))):isMatrix(e)?e.value.map((e=>e.map((e=>Functions.unary[o][l](e))))):Functions.unary[o][l](e.value)}if(i.dtype&&i.dtype===dt.ERROR){return i}t.value=Object.freeze(i);t.dtype=l==="Char"?e.dtype-dt.RATIONAL+dt.STRING:e.dtype&dt.COMPLEX&&arfn.includes(l)?e.dtype-dt.COMPLEX+dt.RATIONAL:e.dtype;s.push(Object.freeze(t));break}case"logn":case"atan2":case"hypot":case"gcd":case"rms":case"binomial":case"ones":case"zeros":case"mod":case"rem":{const e=[];e.push(s.pop());e.unshift(s.pop());if(!(e[0].dtype&dt.RATIONAL)){return errorOprnd("")}const t=Object.create(null);const n=Object.create(null);n.expos=r?Functions.functionExpos(l,e):allZeros;if(n.dtype&&n.dtype===dt.ERROR){return n}t.unit=Object.freeze(n);const[o,i]=multivarFunction("binary",l,e);if(i===dt.ERROR){return o}t.value=Object.freeze(o);t.dtype=i;s.push(Object.freeze(t));break}case"today":case"savedate":{if(l==="savedate"&&!t["@savedate"]){return errorOprnd("UNSAVED")}const e={unit:{expos:[0,0,1,0,0,0,0,0]},dtype:dt.DATE};const n=l==="today"?dateInSecondsFromToday():dateInSecondsFromIsoString("'"+t["@savedate"]+"'");e.value=Rnl.fromNumber(n);s.push(e);break}case"Int":{const e=s.pop();const t=Object.create(null);t.unit={expos:allZeros};if(!(e.dtype&dt.BOOLEAN)){return errorOprnd("LOGIC","Int")}t.value=isVector(e)?e.value.map((e=>Rnl.fromNumber(Number(e)))):isMatrix(e)?e.value.map((e=>e.map((e=>Rnl.fromNumber(Number(e)))))):Rnl.fromNumber(Number(e.value));t.dtype=e.dtype-dt.BOOLEAN+dt.RATIONAL;s.push(Object.freeze(t));break}case"number":{const e=s.pop();const t=Object.create(null);t.unit={expos:allZeros};if(!(e.dtype&dt.STRING)){return errorOprnd("STRING")}t.value=isVector(e)?e.value.map((e=>Rnl.fromString(e))):isMatrix(e)?e.value.map((e=>e.map((e=>Rnl.fromString(e))))):Rnl.fromString(e.value);t.dtype=e.dtype-dt.STRING+dt.RATIONAL;s.push(Object.freeze(t));break}case"findmax":{const e=s.pop();let t=e.value[0];let n=1;if(!(isVector(e)&&e.dtype&dt.RATIONAL)){return errorOprnd("NOT_VECTOR","findmax")}for(let r=1;r<e.value.length;r++){if(Rnl.greaterThan(e.value[r],t)){t=e.value[r];n=Rnl.fromNumber(r+1)}}const r={value:new Map,unit:null,dtype:dt.TUPLE};r.value.set("max",{value:t,unit:allZeros,dtype:dt.RATIONAL});r.value.set("index",{value:n,unit:allZeros,dtype:dt.RATIONAL});s.push(r);break}case"findfirst":{const t=Number(i[e+1]);e+=1;const n=[];n.push(s.pop());if(t===2){n.unshift(s.pop())}const r=t===2&&n[1].dtype&dt.STRING;const o=Object.create(null);o.unit={expos:allZeros};o.value=r&&isVector(n[1])?n[1].value.map((e=>findfirst(n[0],e))):r&&isMatrix(n[1])?n[1].value.map((e=>e.map((e=>findfirst(n[0],e))))):r?findfirst(n[0],n[1]):t===1?Matrix.findfirst(true,n[0]):isVector(n[1])?Matrix.findfirst(n[0].value,n[1]):errorOprnd("ERR_FUNC","Error. Did not understand arguments");if(r){o.dtype=n[1].dtype-dt.STRING+dt.RATIONAL}else{o.dtype=dt.RATIONAL}s.push(Object.freeze(o));break}case"roundn":case"string":{const e=s.pop();const t=s.pop();if(!(t.dtype&dt.RATIONAL)){return errorOprnd("")}if(!(e.dtype&dt.STRING)){return errorOprnd("")}if(!/(?:[fr])\d+/.test(e.value)){return errorOprnd("")}let n="";const r=Object.create(null);if(l==="string"){n=e.value.charAt()==="f"?"stringFixed":"stringSignificant";r.unit=null;r.dtype=t.dtype-dt.RATIONAL+dt.STRING}else{n=e.value.charAt()==="f"?"roundFixed":"roundSignificant";r.unit=t.unit;r.dtype=t.dtype}const o=Number(e.value.slice(1));let i;if(t.dtype&dt.MAP){i=t.value;i.data=i.data.map((e=>Rnl.isRational(e[0])?e.map((e=>Functions.binary[n][l]([e,o]))):e))}else{i=isVector(t)?t.value.map((e=>Functions.binary[n]([e,o]))):isMatrix(t)?t.value.map((e=>e.map((e=>Functions.binary[n]([e,o]))))):Functions.binary[n]([t.value,o])}if(i.dtype&&i.dtype===dt.ERROR){return i}r.value=Object.freeze(i);if(t.name){r.name=t.name}s.push(Object.freeze(r));break}case"dataframe":case"max":case"min":case"sum":case"product":case"range":case"mean":case"median":case"variance":case"stddev":case"accumulate":{const n=Number(i[e+1]);e+=1;const o=[];for(let e=0;e<n;e++){const e=s.pop();if(l!=="dataframe"&&!(e.dtype&dt.RATIONAL)){return errorOprnd("NANARG",l)}o.unshift(e)}if(l==="dataframe"){const e=DataFrame.dataFrameFromVectors(o,t.format.value);if(e.dtype&&e.dtype===dt.ERROR){return e}s.push(e);break}const a=Object.create(null);const c=Object.create(null);c.expos=r?Functions.functionExpos(l,o):allZeros;if(c.dtype&&c.dtype===dt.ERROR){return errorOprnd("")}a.unit=Object.freeze(c);const[d,u]=multivarFunction("reduce",l,o);if(u===dt.ERROR){return d}a.value=Object.freeze(d);a.dtype=u;s.push(Object.freeze(a));break}case"spreadsheetSum":{const e=s.pop();const t=s.pop();s.push(spreadsheetSum(t,e.value,r));break}case"rand":{const t=Number(i[e+1]);e+=1;if(t===0){const e=Rnl.fromNumber(Math.random());s.push({value:e,unit:allZeros,dtype:dt.RATIONAL})}else if(t===1){const e=Rnl.toNumber(s.pop().value);if(!Number.isInteger(e)){return errorOprnd("INT_ARG","rand")}const t=new Array(e).fill(0).map((e=>Rnl.fromNumber(Math.random())));s.push({value:t,unit:allZeros,dtype:dt.RATIONAL+dt.COLUMNVECTOR})}else if(t===2){const e=Rnl.toNumber(s.pop().value);if(!Number.isInteger(e)){return errorOprnd("INT_ARG","rand")}const t=Rnl.toNumber(s.pop().value);if(!Number.isInteger(t)){return errorOprnd("INT_ARG","rand")}let n=new Array(t).fill(new Array(e).fill(0));n=n.map((e=>e.map((e=>Rnl.fromNumber(Math.random())))));s.push({value:n,unit:allZeros,dtype:dt.RATIONAL+dt.MATRIX})}else{return errorOprnd("BAD_ARGS","rand")}break}case"isnan":{const e=s.pop();const t=Object.create(null);t.value=!(e.dtype&dt.RATIONAL);t.unit=null;t.dtype=dt.BOOLEAN;s.push(Object.freeze(t));break}case"length":{const e=s.pop();const t=e.value;const n=isVector(e)?t.length:e.dtype&dt.MATRIX?t.length*t[0].length:e.dtype===dt.STRING?Array.from(t).length:e.dtype&dt.MAP?e.keys().value.length:0;const r=Object.create(null);r.value=Object.freeze(Rnl.fromNumber(n));r.unit=Object.create(null);r.unit.expos=allZeros;r.dtype=dt.RATIONAL;s.push(Object.freeze(r));break}case"count":{const e=s.pop();const t=s.pop();if(e.dtype!==dt.STRING||t.dtype!==dt.STRING){return errorOprnd("COUNT")}const n=Object.create(null);n.value=Object.freeze(Rnl.fromNumber(t.value.split(e.value).length-1));n.unit=Object.create(null);n.unit.expos=allZeros;n.dtype=dt.RATIONAL;s.push(Object.freeze(n));break}case"lerp":{const e=new Array(3);e[2]=s.pop();e[1]=s.pop();e[0]=s.pop();const t=Functions.lerp(e,r);if(t.dtype===dt.ERROR){return t}s.push(t);break}case"matrix2table":{const t=Number(i[e+1]);e+=1;const n=t===3?s.pop().value:[];const r=s.pop().value;const o=s.pop();const a=DataFrame.matrix2table(o,r,n);if(a.dtype===dt.ERROR){return a}s.push(a);break}case"transpose":s.push(Matrix.transpose(s.pop()));break;case"trace":s.push(Matrix.trace(s.pop()));break;case"fetch":return errorOprnd("FETCH");case"function":{const a=i[e+1];const l=Number(i[e+2]);e+=2;const c=new Array(l);for(let e=l-1;e>=0;e--){c[e]=s.pop()}let d;if(t.svg&&(a==="plot"||draw.functions[a])){if(a==="plot"){c.splice(1,0,n.decimalFormat);d=plot(...c)}else if(a==="path"){d=draw.functions[a](c[0],c.slice(1))}else{d=draw.functions[a](...c)}}else if(nextToken(i,e)==="."){let t=s.pop().value;if(t.value){t=t.value}const o=t[a];if(o===undefined){return errorOprnd("F_NAME",a)}if(o.dtype===dt.ERROR){return o}d=evalCustomFunction(o,c,n,r,t);e+=1}else if(o&&o[a]){const e=o[a];d=evalCustomFunction(e,c,n,r,o)}else if(t[a]&&t[a].dtype===dt.MODULE){const e=t[a]["value"];d=evalCustomFunction(e,c,n,r)}else{return errorOprnd("BAD_FUN_NM",a)}if(d.dtype===dt.ERROR){return d}s.push(d);break}case"=":case"==":case"":case"<":case">":case"<=":case"":case">=":case"":case"":case"!=":case"":case"in":case"":case"!in":case"":case"":case"":case"":case"":case"":{const e=s.pop();const t=s.pop();if(r&&!(t.dtype&dt.STRING||e.dtype&dt.STRING||t.dtype===dt.NULL||e.dtype===dt.NULL)){if(!unitsAreCompatible(t.unit.expos,e.unit.expos)){return errorOprnd("UNIT_COMP")}}const n=Object.create(null);n.unit=null;const o=t.dtype===dt.BOOLEANFROMCOMPARISON?a.value:undefined;if(setComparisons.includes(l)){n.value=compare(l,t.value,e.value,o);n.dtype=t.dtype+dt.BOOLEANFROMCOMPARISON}else{const[r,i,s]=binaryShapesOf(t,e);n.value=Operators.relations[r][i].relate(l,t.value,e.value,o);n.dtype=Operators.dtype[r][i](t.dtype,e.dtype,l)+dt.BOOLEANFROMCOMPARISON}if(n.value.dtype&&n.value.dtype===dt.ERROR){return n.value}if(n.dtype&dt.RATIONAL){n.dtype-=dt.RATIONAL}if(n.dtype&dt.COMPLEX){n.dtype-=dt.COMPLEX}if(n.dtype&dt.STRING){n.dtype-=dt.STRING}a=e;s.push(Object.freeze(n));break}case"and":case"&&":case"or":case"||":case"":case"":case"":{const t=s.pop();const n=s.pop();if(!(n.dtype&dt.BOOLEAN)||!(t.dtype&dt.BOOLEAN)){return errorOprnd("LOGIC",i[e])}const r={and:"and","&&":"and",or:"or","":"and","||":"or","":"or","":"xor"}[l];const[o,a,c]=binaryShapesOf(n,t);const d=Object.create(null);d.unit=null;d.value=Operators.binary[o][a][r](n.value,t.value);if(d.value.dtype&&d.value.dtype===dt.ERROR){return d.value}d.dtype=Operators.dtype[o][a](n.dtype,t.dtype,l);s.push(Object.freeze(d));break}case"not":case"":{const e=s.pop();if(!(e.dtype&dt.BOOLEAN)){return errorOprnd("LOGIC",l)}const t=Object.create(null);t.unit=null;t.value=Operators.unary[shapeOf(e)]["not"](e.value);if(t.value.dtype&&t.value.dtype===dt.ERROR){return t.value}t.dtype=dt.BOOLEAN;s.push(Object.freeze(t));break}case"cases":{const a=Number(i[e+1]);e+=1;const l=new Array(a);for(let e=a-1;e>=0;e--){l[e]=s.pop()}for(let c=0;c<a;c++){if((l[c].dtype&dt.BOOLEAN)===0){return errorOprnd("LOGIC","if")}const a=Operators.condition[shapeOf(l[c])](l[c].value);if(a){const a=i[e+c+1].replace(//g,"");const l=evalRpn(a,t,n,r,o);if(l.dtype===dt.ERROR){return l}s.push(l);break}}e+=a;break}case"applyUnit":{if(!r){return errorOprnd("UNIT_AWARE",i[e+1])}const t=s.pop();if(!(t.dtype&dt.RATIONAL)){return errorOprnd("QUANT_NUM")}const n=i[e+1];e+=1;const o=Object.create(null);o.unit=Object.create(null);o.dtype=t.dtype;if(!r){o.value=t.value;if(t.dtype&dt.MAP){o.unit=unitFromUnitName(n)}else{o.unit.name=n}}else{const e=unitFromUnitName(n);if(e.dtype&&e.dtype===dt.ERROR){return e}if(isMatrix(t)){o.unit.expos=t.unit.expos.map(((t,n)=>t+e.expos[n]));o.value=Matrix.convertToBaseUnits(t,e.gauge,e.factor)}else if(t.dtype&dt.MAP){o.unit=e;o.value=t.value;o.value.data=map.convertToBaseUnits(t.value.data,e.gauge,e.factor)}else{o.unit.expos=t.unit.expos.map(((t,n)=>t+e.expos[n]));o.value=Rnl.multiply(Rnl.add(t.value,e.gauge),e.factor)}}s.push(Object.freeze(o));break}case"rem%":{const e=s.pop();const t=s.pop();if(!(t.dtype&dt.RATIONAL&(e.dtype&dt.RATIONAL))){return errorOprnd("NAN_OP")}const[n,r,o]=binaryShapesOf(t,e);const i=Object.create(null);i.unit=Object.create(null);i.unit.expos=allZeros;i.value=Operators.binary[n][r]["rem"](t.value,e.value);if(i.value.dtype&&i.value.dtype===dt.ERROR){return i.value}i.dtype=Operators.dtype[n][r](t.dtype,e.dtype,l);s.push(Object.freeze(i));break}case"":case"":{const e=s.pop();if(!(e.dtype&dt.RATIONAL)){return errorOprnd("NAN_OP")}if(r){if(!unitsAreCompatible(e.unit.expos,allZeros)){{return errorOprnd("")}}}const t=l===""?"ceil":"floor";const n=Object.create(null);n.value=Operators.unary[shapeOf(e)][t](e.value);if(n.value.dtype&&n.value.dtype===dt.ERROR){return n.value}n.unit=e.unit;n.dtype=e.dtype;s.push(Object.freeze(n));break}case"()":{const e=[];e.unshift(s.pop());e.unshift(s.pop());if(r){if(!unitsAreCompatible(e[0].unit.expos,allZeros)||!unitsAreCompatible(e[1].unit.expos,allZeros)){return errorOprnd("BINOM")}}const t=Object.create(null);t.unit=Object.create(null);t.unit.expos=allZeros;const[n,o]=multivarFunction("binary","binomial",e);t.value=n;t.dtype=o;s.push(Object.freeze(t));break}case"":{const e=s.pop().value.replace(//g,"");const t=s.pop().value;s.push({dtype:dt.MODULE,unit:null,value:{parameters:[{name:t}],statements:[{rpn:e,stype:"return"}]}});break}case"":{const e=s.pop().value.replace(//g,"");const r=s.pop().value;let o=s.pop().value;const i=s.pop().value;let a=Rnl.zero;while(Rnl.lessThanOrEqualTo(o,r)){t[i]={value:o,unit:allZeros,dtype:dt.RATIONAL};const r=evalRpn(e,t,n,false);a=Rnl.add(a,r.value);o=Rnl.add(o,Rnl.one)}delete t[i];s.push({value:a,unit:allZeros,dtype:dt.RATIONAL});break}case"throw":return{value:s.pop().value,unit:null,dtype:dt.ERROR};case"\\blue":case"\\gray":case"\\green":case"\\orange":case"\\pink":case"\\purple":case"\\red":{const e=clone(s.pop());if(e.dtype===dt.STRING){e.unit=l.slice(1)}s.push(e);break}}}}const l=s.pop();if(s.length>0){return errorOprnd("ERROR")}return l};const plot=(e,t,n,r,o,i)=>{const s=e.value.temp;r=r==null?Rnl.fromNumber(250):r.value;const a=o==null?Rnl.fromNumber(s.xmin):o.value;const l=i==null?Rnl.fromNumber(s.xmax):i.value;const c=Rnl.divide(Rnl.subtract(l,a),r);const d=Matrix.operandFromRange([a,c,l]);const u={value:d.value,unit:null,dtype:dt.COLUMNVECTOR+dt.RATIONAL};let p;let f;if(n.value.dtype&&n.value.dtype===dt.MODULE){p=evalCustomFunction(n.value,[u],t,false);f=u.value.map(((e,t)=>[e,p.value[t]]))}else if(n.dtype===dt.STRING){if(/matrix12$/.test(n.value)){u.name="t";f=evalRpn(n.value.replace(//g,""),{t:u},t,false).value}else{u.name="x";p=evalRpn(n.value.replace(//g,""),{x:u},t,false);f=u.value.map(((e,t)=>[e,p.value[t]]))}}else;const h={value:f,unit:null,dtype:dt.MATRIX+dt.RATIONAL};return draw.functions.path(e,[h])};const elementFromIterable=(e,t,n)=>{let r;let o=Rnl.increment(t);const i=Rnl.toNumber(t);let s=0;if(e.dtype===dt.RANGE){r=t;o=Rnl.add(t,n);s=dt.RATIONAL}else if(e.dtype===dt.STRING){if(e.value.slice(i-1,i)==="\ud835"){r="\ud835"+e.value.slice(i+1,i+2);o=Rnl.add(t,1)}else{r=e.value.slice(i,i+1)}s=dt.STRING}else{r=e.value[i];s=e.dtype&dt.STRING?dt.STRING:e.dtype&dt.ROWVECTOR?e.dtype-dt.ROWVECTOR:e.dtype&dt.COLUMNVECTOR?e.dtype-dt.COLUMNVECTOR:e.dtype-dt.MATRIX}const a={value:r,unit:e.unit,dtype:s};return[a,o]};const loopTypes=["while","for"];const evalCustomFunction=(e,t,n,r,o)=>{if(e.dtype===dt.ERROR){return e}if(t.length>e.parameters.length){return errorOprnd("NUMARGS",e.name)}const i=Object.create(null);for(let n=0;n<t.length;n++){i[e.parameters[n].name]=t[n]}if(e.parameters.length>t.length){for(let n=t.length;n<e.parameters.length;n++){i[e.parameters[n].name]=e.parameters[n].default}}if(e.dtype===dt.DRAWING){i["svg"]={value:draw.startSvg(),unit:null,dtype:dt.DRAWING}}const s=[{type:"if",condition:true,endOfBlock:e.statements.length-1}];for(let t=0;t<e.statements.length;t++){const a=e.statements[t];const l=a.stype;const c=s.length-1;switch(l){case"statement":{if(s[c].condition){const e=evalRpn(a.rpn,i,n,r,o);if(e.dtype===dt.ERROR){console.log(a.rpn);return e}if(a.name){a.resultdisplay=r?"!!":"!";const[t,o]=conditionResult(a,e,r);insertOneHurmetVar(i,t,null,n)}}break}case"if":{if(s[c].condition){const e=evalRpn(a.rpn,i,n,r,o);if(e.dtype===dt.ERROR){return e}const t=Operators.condition[shapeOf(e)](e.value);s.push({type:"if",condition:t,endOfBlock:a.endOfBlock})}else{t=a.endOfBlock}break}case"elseif":{if(s[c].type==="if"&&s[c].condition){t=s[c].endOfBlock;s.pop()}else{const e=evalRpn(a.rpn,i,n,r,o);if(e.dtype===dt.ERROR){return e}const t=Operators.condition[shapeOf(e)](e.value);s[s.length-1].condition=t}break}case"else":if(s[c].type==="if"&&s[c].condition){t=s[c].endOfBlock;s.pop()}else{s[c].condition=true}break;case"while":{if(s[c].condition){const e={type:"while",startStatement:t,rpn:a.rpn,endOfBlock:a.endOfBlock};const l=evalRpn(a.rpn,i,n,r,o);if(l.dtype===dt.ERROR){return l}const c=Operators.condition[shapeOf(l)](l.value);e.condition=c;if(e.condition===true){s.push(e)}else{t=a.endOfBlock}}else{t=a.endOfBlock}break}case"for":{if(s[c].condition){const e={type:"for",condition:true,startStatement:t,endOfBlock:a.endOfBlock};const l=a.rpn.split("");e.dummyVariable=l.shift().slice(1);const c=evalRpn(l.join(""),i,n,r,o);e.index=c.dtype&dt.RANGE?c.value[0]:Rnl.fromNumber(0);e.step=c.dtype&dt.RANGE?c.value[1]:Rnl.fromNumber(1);e.endIndex=c.dtype&dt.RANGE?c.value[2]:Rnl.fromNumber(c.value.length-1);const[d,u]=elementFromIterable(c,e.index,e.step);e.nextIndex=u;e.iterable=c;s.push(e);i[e.dummyVariable]=d}else{t=a.endOfBlock}break}case"break":{if(s[c].condition){for(let e=s.length-1;e>0;e--){if(loopTypes.includes(s[e].type)||e===0){t=s[e].endOfBlock;s.pop();break}else{s.pop()}}}break}case"end":{if(s[c].type==="if"&&t>=s[c].endOfBlock){s.pop()}else if(s[c].type==="if"&&s[c].condition){if(t<s[c].endOfBlock){t=s[c].endOfBlock}s.pop()}else if(s[c].type==="while"){const e=evalRpn(s[c].rpn,i,n,r,o);if(e.dtype===dt.ERROR){return e}s[c].condition=e.value;if(s[c].condition){t=s[c].startStatement}else{s.pop()}}else if(s[c].type==="for"){s[c].index=s[c].nextIndex;const e=Rnl.isRational(s[c].index)&&Rnl.isPositive(s[c].step)?Rnl.lessThanOrEqualTo(s[c].index,s[c].endIndex):Rnl.isRational(s[c].index)?Rnl.greaterThanOrEqualTo(s[c].index,s[c].endIndex):s[c].index<=s[c].endIndex;if(e){const[e,n]=elementFromIterable(s[c].iterable,s[c].index,s[c].step);i[s[c].dummyVariable]=e;s[c].nextIndex=n;t=s[c].startStatement}else{s.pop()}}break}case"return":if(s[c].condition){if(a.rpn){const e=evalRpn(a.rpn,i,n,r,o);return e}else{return{value:Rnl.zero,unit:allZeros,dtype:dt.RATIONAL}}}break;case"print":if(s[c].condition){if(a.rpn){const e=evalRpn(a.rpn,i,n,r,o);if(e.dtype===dt.ERROR){return e}const t=e.dtype===dt.RATIONAL?Rnl.toNumber(e.value):e.dtype===dt.STRING||e.dtype===dt.BOOLEAN?e.value:isVector(e)&&e.dtype&dt.RATIONAL?e.value.map((e=>Rnl.toNumber(e))):e.dtype===dt.MATRIX+dt.RATIONAL?e.value.map((e=>e.map((e=>Rnl.toNumber(e))))):e.value;console.log(t)}}break;case"throw":if(s[c].condition){if(a.rpn){const e=evalRpn(a.rpn,i,n,r,o);return{value:e.value,unit:null,dtype:dt.ERROR}}else{return{value:a.rpn,unit:null,dtype:dt.ERROR}}}break}}};const errorResult=(e,t)=>{e.value=null;e.resultDisplay="\\textcolor{firebrick}{\\text{"+t.value.replace(/%/g,"\\%")+"}}";e.altResultDisplay=t.value;e.error=true;e.dtype=dt.ERROR;if(e.resulttemplate.indexOf("!")>-1){e.tex+="= "+e.resultDisplay;e.alt+=t.value}else if(e.resulttemplate.indexOf("@")>-1){e.tex=e.resulttemplate.replace(/@@?/,e.resultDisplay);e.alt=e.altresulttemplate.replace(/@@?/,e.altResultDisplay)}else{e.tex=e.tex.replace(/[?%] *[?%]|[?%]/,e.resultDisplay);e.alt=e.alt.replace(/[?%] *[?%]|[?%]/,e.altResultDisplay)}return[e,t]};const spreadsheetSum=(e,t,n)=>{let r=Rnl.zero;if(/^[A-Z]$/.test(t)){const o=e.numRows-1;for(let i=1;i<=o-1;i++){const o=fromAssignment(e.value[t+String(i)],n);if(o.dtype===dt.ERROR){return o}r=Rnl.add(r,o.value)}}else if(isNaN(t)){return errorOprnd("SHEET_INDEX")}else{const o=Object.keys(e.columnMap).length;for(let i=1;i<=o-1;i++){const o=String.fromCodePoint(65+i)+t;const s=fromAssignment(e.value[o],n);if(s.dtype===dt.ERROR){return s}r=Rnl.add(r,s.value)}}return{value:r,unit:allZeros,dtype:dt.RATIONAL}};const conditionResult=(e,t,n)=>{let r=Object.create(null);r.value=t.dtype===dt.DATAFRAME?t.value:clone(t.value);r.unit=clone(t.unit);r.dtype=t.dtype;if(r.dtype===dt.COMPLEX&&Rnl.isZero(Cpx.imag(r.value))){r.value=Cpx.real(r.value);r.dtype=1}if(r.dtype!==dt.ERROR&&n&&e.resultdisplay.indexOf("!")===-1&&(e.unit&&e.unit.expos||r.unit&&r.unit.expos&&Array.isArray(r.unit.expos))){const t=r.dtype===dt.DATE&&e.unit===undefined?[0,0,1,0,0,0,0,0]:e.unit&&e.unit.expos?e.unit.expos:allZeros;if(!unitsAreCompatible(r.unit.expos,t)){const t=e.unit&&e.unit.expos?"UNIT_RES":"UNIT_MISS";r=errorOprnd(t)}}if(r.dtype===dt.ERROR){return errorResult(e,r)}if(e.resulttemplate&&e.resulttemplate.indexOf("!")>-1&&!(r.dtype===dt.DATAFRAME||r.dtype&dt.MAP||isMatrix(r)||r.dtype&dt.TUPLE)){return errorResult(e,errorOprnd("BAD_DISPLAY"))}if(r.dtype&dt.RATIONAL){if(r.dtype&dt.MAP){r.value.data=r.value.data.map((e=>Rnl.isRational(e[0])?e.map((e=>Rnl.normalize(e))):e))}else{r.value=isVector(r)?r.value.map((e=>Rnl.normalize(e))):isMatrix(r)?r.value.map((e=>e.map((e=>Rnl.normalize(e))))):r.dtype===dt.RATIONAL?Rnl.normalize(r.value):r.value}}else if(r.dtype===dt.COMPLEX){r.value=[Rnl.normalize(r.value[0]),Rnl.normalize(r.value[1])]}e.dtype=r.dtype;const o=e.unit&&e.unit.factor&&(!Rnl.areEqual(e.unit.factor,Rnl.one)||e.unit.gauge);if(r.dtype&dt.DATAFRAME||typeof e.resultdisplay==="string"&&e.resultdisplay.indexOf("!")>-1){e.unit=r.unit}else if(n&&r.dtype&dt.RATIONAL){if(!o&unitsAreCompatible(r.unit.expos,allZeros)){e.unit={factor:Rnl.one,gauge:Rnl.zero,expos:allZeros}}if(r.dtype&dt.MAP){r.value.data={plain:map.convertFromBaseUnits(r.value.data,e.unit.gauge,e.unit.factor),inBaseUnits:r.value.data}}else{r.value={plain:isMatrix(r)?Matrix.convertFromBaseUnits({value:r.value,dtype:r.dtype},e.unit.gauge,e.unit.factor):Rnl.subtract(Rnl.divide(r.value,e.unit.factor),e.unit.gauge),inBaseUnits:r.value}}e.dtype+=dt.QUANTITY;e.expos=r.unit.expos}else if(o){if(r.dtype&dt.MAP){const t={plain:r.value.data,inBaseUnits:map.convertToBaseUnits(r.value.data,e.unit.gauge,e.unit.factor)};r.value.data=t}else{r.value={plain:r.value,inBaseUnits:isMatrix(r)?Matrix.convertToBaseUnits({value:r.value,dtype:r.dtype},e.unit.gauge,e.unit.factor):Rnl.multiply(Rnl.add(r.value,e.unit.gauge),e.unit.factor)}}e.dtype+=dt.QUANTITY}else if(r.dtype&dt.RATIONAL||r.dtype&dt.COMPLEX){e.unit={expos:allZeros}}if(Object.prototype.hasOwnProperty.call(r,"value")){e.value=r.value}return[e,r]};const evaluateDrawing=(e,t,n={decimalFormat:"1,000,000.",dateFormat:"yyyy-mm-dd"})=>{const r=e.value;const o=[];for(let e=0;e<r.parameters.length;e++){const i=r.parameters[e].name;o.push(evalRpn(""+i,t,n,false,{}))}const i=evalCustomFunction(r,o,n,false,{});if(i.dtype===dt.ERROR){e.error=true;e.tex="\\textcolor{firebrick}{\\text{"+i.value+"}}";e.value=null;e.dtype=dt.ERROR}else{e.resultdisplay=i.value;delete e.resultdisplay.temp}return e};const evaluate=(e,t,n={decimalFormat:"1,000,000.",dateFormat:"yyyy-mm-dd"})=>{e.tex=e.template?e.template:"";e.alt=e.altTemplate?e.altTemplate:"";const r=/\?\?|!!|%%|@@|/.test(e.resulttemplate);const o=t.format?t.format.value:"h15";if(e.tex.indexOf("")>-1){const i=plugValsIntoEcho(e.tex,t,r,o,n);if(i.dtype&&i.dtype===dt.ERROR){const[t,n]=errorResult(e,i);return t}else{e.tex=i}}if(e.rpn){let i=evalRpn(e.rpn,t,n,r);if(i.dtype===dt.ERROR){[e,i]=errorResult(e,i);return e}let s;[e,s]=conditionResult(e,i,r);if(e.error){return e}const a=t.assert?t.assert:null;e=formatResult(e,s,o,n,a,r)}return e};const numberRegEx$3=new RegExp(Rnl.numberPattern);const matrixRegEx=/^[([] *(?:(?:-?[0-9.]+|"[^"]+"|true|false) *[,;\t]? *)+[)\]]/;const numStr="(-?(?:0x[0-9A-Fa-f]+|[0-9]+(?: [0-9]+\\/[0-9]+|(?:\\.[0-9]+)?(?:e[+-]?[0-9]+|%)?)))";const nonNegNumStr="(0x[0-9A-Fa-f]+|[0-9]+(?: [0-9]+\\/[0-9]+|(?:\\.[0-9]+)?(?:e[+-]?[0-9]+|%)?))";const complexRegEx=new RegExp("^"+numStr+"(?: *([+-]) *(?: j *"+nonNegNumStr+"|"+nonNegNumStr+" *"+numStr+"()?))");const unitFromString=e=>{if(e.length===0){return["",""]}const t=e.replace(/'/g,"").trim();const n=unitFromUnitName(t);const r=n.dtype&&n.dtype===dt.ERROR?"":unitTeXFromString(t);return[n,r]};const literalWithUnit=(e,t,n)=>{let r=e.dtype&dt.RATIONAL?{expos:allZeros}:null;let o="";let i=e.value;if(n.length>0){[r,o]=unitFromString(n);if(r.dtype&&r.dtype===dt.ERROR){return[0,null,dt.ERROR,""]}i=e.dtype===dt.RATIONAL?{plain:e.value,inBaseUnits:Rnl.multiply(Rnl.add(e.value,r.gauge),r.factor)}:{plain:e.value,inBaseUnits:Matrix.convertToBaseUnits(e,r.gauge,r.factor)}}let s=e.dtype;if(o.length>0){s+=dt.QUANTITY;return[i,r,s,t+"\\,"+o]}else{return[i,r,s,t]}};const valueFromLiteral=(e,t,n)=>{if(/^[({[].* to /.test(e)){return[0,null,dt.ERROR,""]}else if(e==="true"||e==="false"){return[Boolean(e),null,dt.BOOLEAN,`\\mathord{\\text{${e}}}`]}else if(e.length>3&&e.slice(0,3)==='"""'){return[e.slice(3,-3),undefined,dt.MACRO,""]}else if(/^\x22.+\x22/.test(e)){if(t==="format"){return validateFormatSpec(e.slice(1,-1).trim())}else{const t=parse$1(e,n);return[e.slice(1,-1),undefined,dt.STRING,t]}}else if(matrixRegEx.test(e)){const t=matrixRegEx.exec(e)[0];const[r,o,i]=parse$1(t,n,true);const s=evalRpn(o,{},n,false,{});const a=e.slice(t.length).trim();return literalWithUnit(s,r,a)}else if(/^``/.test(e)){const t=e.indexOf("``",2);const r=tablessTrim(e.slice(2,t));const o=DataFrame.dataFrameFromTSV(r);if(o.dtype===dt.DATAFRAME){return[o.value,o.unit,dt.DATAFRAME,DataFrame.display(o.value,"h3",n.decimalFormat)]}else{const r=e.slice(t+2).trim();let i;let s="";if(r.length>0){[i,s]=unitFromString(r);if(i.dtype&&i.dtype===dt.ERROR){return[0,null,dt.ERROR,""]}o.unit=i;o.dtype=dt.MAP+dt.RATIONAL+dt.QUANTITY;o.value.data={plain:o.value.data,inBaseUnits:map.convertToBaseUnits(o.value.data,i.gauge,i.factor)}}return[o.value,i,o.dtype,DataFrame.display(o.value,"h3",n.decimalFormat)+"\\;"+s]}}else if(complexRegEx.test(e)){const t=parse$1(e,n);const r=e.match(complexRegEx);let o;let i;if(r[3]){o=Rnl.fromString(r[1]);i=Rnl.fromString(r[3]);if(r[2]==="-"){i=Rnl.negate(i)}}else{const e=Rnl.fromString(r[1]);let t=Rnl.fromString(r[4]);if(r[5]){t=Rnl.divide(Rnl.multiply(t,Rnl.pi),Rnl.fromNumber(180))}o=Rnl.multiply(e,Rnl.fromNumber(Math.cos(Rnl.toNumber(t))));i=Rnl.multiply(e,Rnl.fromNumber(Math.sin(Rnl.toNumber(t))))}return[[o,i],allZeros,dt.COMPLEX,t]}else if(dateRegEx$1.test(e)){const t=[BigInt(dateInSecondsFromIsoString(e)),BigInt(1)];const r=formatDate(t,n.dateFormat);return[t,{expos:[0,0,1,0,0,0,0,0]},dt.DATE,r]}else{const t=numberRegEx$3.exec(e);if(t){const r=t[0];const o=e.slice(r.length).trim();const[i,s,a]=parse$1(r,n,true);const l=evalRpn(s,{},n,false,{});return literalWithUnit(l,i,o)}else{return[0,null,dt.ERROR,""]}}};const isValidIdentifier=/^(?:[A-Za-z\u0391-\u03C9\u03D5\u210B\u210F\u2110\u2112\u2113\u211B\u212C\u2130\u2131\u2133]|(?:\uD835[\uDC00-\udc33\udc9c-\udcb5]))[A-Za-z0-9_\u0391-\u03C9\u03D5\u0300-\u0308\u030A\u030C\u0332\u20d0\u20d1\u20d6\u20d7\u20e1]**$/;const keywordRegEx=/^(if|elseif|else|return|throw|while|for|break|print|end)(\u2002|\b)/;const drawCommandRegEx=/^(title|frame|view|axes|grid|stroke|strokewidth|strokedasharray|fill|fontsize|fontweight|fontstyle|fontfamily|marker|line|path|plot|curve|rect|circle|ellipse|arc|text|dot|leader|dimension)\b/;const leadingSpaceRegEx=/^[\t ]+/;const oneLinerRegEx=/^( *)if ([^\n`]+) +(return|throw|print|break)\b([^\n]+)?(?: end)? *\n/gm;const functionRegEx$1=/^function (?:[A-Za-z\u0391-\u03C9\u03D5\u210B\u210F\u2110\u2112\u2113\u211B\u212C\u2130\u2131\u2133]|(?:\uD835[\uDC00-\udc33\udc9c-\udcb5]))[A-Za-z0-9_\u0391-\u03C9\u03D5\u0300-\u0308\u030A\u030C\u0332\u20d0\u20d1\u20d6\u20d7\u20e1]**\(/;const moduleRegEx=/^module ([A-Za-z][A-Za-z0-9]*)/;const drawRegEx=/^draw\(/;const startSvgRegEx=/^startSvg\(\)/;const lexRegEx=/"[^"]*"|``.*|`[^`]*`|'[^']*'|#|[^"`'#]+/g;const testForStatement=e=>{const t=e.indexOf("=");if(t===-1){return false}const n=e.slice(0,t).replace(leadingSpaceRegEx,"").trim();if(isValidIdentifier.test(n)){return true}if(n.indexOf(",")===-1){return false}let r=true;const o=n.split(",");o.forEach((e=>{if(!isValidIdentifier.test(e.trim())){r=false}}));return r};const stripComment=e=>{const t=arrayOfRegExMatches(lexRegEx,e);for(let n=0;n<t.length;n++){if(t[n].value==="#"){e=e.slice(0,t[n].index);break}}return e.trim()};const scanModule=(e,t)=>{const n=Object.create(null);e=e.replace(oneLinerRegEx,"$1if$2\n$1    $3$4\n$1end\n");const r=e.split(/\r?\n/g);for(let e=0;e<r.length;e++){const o=stripComment(r[e]);if(o.length===0){continue}if(functionRegEx$1.test(o)||drawRegEx.test(o)){const[o,i]=scanFunction(r,t,e);if(o.dtype&&o.dtype===dt.ERROR){return o}n[o.name]=o;e=i}else if(testForStatement(o)){const[o,i]=scanAssignment(r,t,e);n[o.name]=o;e=i}}return{value:n,unit:null,dtype:dt.MODULE}};const handleTSV=(e,t,n)=>{for(let r=n+1;r<t.length;r++){const n=tablessTrim(t[r]);if(n.length===0){continue}e+="\n"+n;if(n.slice(-2)==="``"){return[e,r]}}};const scanFunction=(e,t,n)=>{const r=stripComment(e[n]);let o=r.charAt(0)==="d";const i=r.indexOf("(");let s="";if(o){s="draw"}else{const e=r.indexOf("function");s=r.slice(e+8,i).trim()}const a=r.slice(i+1,-1).trim();const l=a.length===0?[]:a.split(/ *[,;] */g);const c=[];for(const e of l){const n=e.split(/ *= */);const r=n[0];let o={name:r,value:null,dtype:null};if(n[1]){const[e,i,s,a]=valueFromLiteral(n[1],"",t);o={name:r,value:e,unit:i,dtype:s,resultDisplay:a}}c.push({name:r,default:o})}const d={name:s,dtype:o?dt.DRAWING:dt.MODULE,parameters:c,statements:[]};const u=[];let p="";let f=false;let h="";let m="";let g=false;let y=n;for(let r=n+1;r<e.length;r++){y+=1;let n=stripComment(e[r]);if(n.length===0){continue}if(f){const e=h.slice(-1);n=e===";"&&"})]".indexOf(n.charAt(0))>-1?h.slice(0,-1).trim()+n:e===";"||e===","?h+" "+n:h+n}if(/[{([,;]$/.test(n)){f=true;h=n;continue}else if(e.length>r+1&&/^\s*[+\-)\]}]/.test(e[r+1])){f=true;h=n;continue}let i=false;const a=keywordRegEx.exec(n);if(a){m=a[1];if(a[2]){i=true}p=n.slice(m.length).trim();if(p.length>0&&/^``/.test(p)){[p,r]=handleTSV(p,e,r)}}else if(o&&drawCommandRegEx.test(n)){m="svg";p=n.indexOf(" ")===-1?n+"(svg)":n.replace(" ","(svg, ")+")";g=true}else{if(testForStatement(n)){const t=n.indexOf("=");m=n.slice(0,t-1).trim();p=n.slice(t+1).trim();if(/^``/.test(p)){[p,r]=handleTSV(p,e,r)}if(startSvgRegEx.test(p)){o=true}g=true}else{return[errorOprnd("FUNC_LINE",s+", line "+(y+1)+"\n"+n),r]}}if(i){y-=1}let l="";let c;if(p){[,l,c]=parse$1(p,t,true);if(m==="for"){l=l.replace(/\u00a0in\u00a0/,"").replace(/\u00a0in$/,"")}}const b=g?"statement":m;if(g&&/[,;]/.test(m)){m=m.split(/[,;]/).map((e=>e.trim()))}d.statements.push({name:m,rpn:l,stype:b});if(b==="if"||b==="while"||b==="for"){u.push({type:b,statementNum:d.statements.length-1})}else if(b==="end"){if(u.length===0){if(o){d.statements.splice(-1,0,{name:"return",rpn:"svg",stype:"return"})}return[d,r]}const e=u[u.length-1];d.statements[e.statementNum].endOfBlock=d.statements.length-1;u.pop()}g=false;f=false;h="";m="";p=""}return[errorOprnd("END_MISS",s),0]};const scanAssignment=(e,t,n)=>{let r=false;let o="";let i=n;for(let t=n;t<e.length;t++){const n=stripComment(e[t]);if(n.length===0){continue}if(r){o=o.slice(-1)===";"&&"})]".indexOf(n.charAt(0))>-1?o.slice(0,-1).trim()+n:o+n}else{o=n}if(/[{([,;]$/.test(o)){r=true}else if(e.length>t+1&&/^\s*[+\-)\]}]/.test(e[t+1])){r=true}else{i=t;break}}const s=o.indexOf("=");let a=o.slice(0,s).trim();if(/[,;]/.test(a)){a=a.split(/[,;]/).map((e=>e.trim()))}let l=o.slice(s+1).trim();if(l.length>3&&l.slice(0,3)==='"""'){let t=i;let n=l.indexOf('"""',3);while(n<0&&t<e.length-1){t+=1;l+="\n"+e[t];n=l.indexOf('"""',3)}i=t}const[c,d,u,p]=valueFromLiteral(l,a,t);const f={name:a,value:c,unit:d,dtype:u,resultDisplay:p};return[f,i]};const containsOperator=/[+\-*/^%&!|&=<>]|\xa0(function|mod|\\atop|root|sum|abs|cos|sin|tan|acos|asin|atan|sec|csc|cot|asec|acsc|acot|exp|log|ln|log10|log2|cosh|sinh|tanh|sech|csch|coth|acosh|asinh|atanh|asech|acsch|acoth|gamma||lgamma|log|lfact|cosd|sind|tand|acosd|asind|atand|secd|cscd|cotd|asecd|acscd|acotd|real|imag|angle|Char|round|sqrt|sign|\?{}|%|||\[\]|\(\))\xa0/;const mustDoCalculation=/^(``.+``|[$$\u20A0-\u20CF]?(\?{1,2}|@{1,2}|%{1,2}|!{1,2})[^=!(?@%!{})]*)$/;const assignDataFrameRegEx=/^[^=]+=\s*``[\s\S]+``\s*$/;const currencyRegEx=/^[$\u20A0-\u20CF]/;const matrixOfNames=/^[([](?:[A-Za-z\u0391-\u03C9\u03D5\u210B\u210F\u2110\u2112\u2113\u211B\u212C\u2130\u2131\u2133]|(?:\uD835[\uDC00-\udc33\udc9c-\udcb5]))[A-Za-z0-9_\u0391-\u03C9\u03D5\u0300-\u0308\u030A\u030C\u0332\u20d0\u20d1\u20d6\u20d7\u20e1]**[,;].+[)\]]$/;const isKeyWord=/^(|true|false|root|if|else|elseif|and|or|otherwise|mod|for|while|break|return|throw)$/;const testRegEx=/^(@{1,2})test /;const shortcut=(e,t)=>{const n=parse$1(e,t);return{entry:e,tex:n,alt:e}};const compile=(e,t={decimalFormat:"1,000,000.",dateFormat:"yyyy-mm-dd"})=>{let n="";let r="";let o="";let i=false;let s=false;let a=false;let l=false;let c=false;let d=0;let u="";let p="";let f="";let h=[];let m="";let g="";let y=false;let b;let x;let w;let S="";const R=moduleRegEx.test(e);const v=drawRegEx.test(e);if(functionRegEx$1.test(e)||v||R){let n="";if(v){n="draw"}else if(R){n=moduleRegEx.exec(e)[1].trim()}else if(!R){const t=e.indexOf("function");const r=e.indexOf("(");n=e.slice(t+8,r).trim()}const r=scanModule(e,t);const o=r.dtype&&r.dtype===dt.ERROR;if(o){window.alert(r.value)}const i={entry:e,name:n,value:o||R?r.value:r.value[n],resultdisplay:"\\text{"+n+"}",dtype:o?dt.ERROR:n==="draw"?dt.DRAWING:dt.MODULE,error:o};return i}S=e;if(testRegEx.test(e)){S=S.replace(testRegEx,"").trim();const[n,r,o]=parse$1(S,t,true);const i=testRegEx.exec(e)[1];return{entry:e,template:"",rpn:r,dependencies:o,resulttemplate:i,altresulttemplate:i,resultdisplay:""}}const M=assignDataFrameRegEx.test(S);const A=M?S.indexOf("=")+1:S.lastIndexOf("=")+1;if(A>1){r=S.substring(0,A-1).replace(/ +$/,"");if(r.length>0&&/;\s*$/.test(r)){c=true;r=r.replace(/;\s*$/,"")}r=r.trim();o=S.substring(A).trim();if(mustDoCalculation.test(o)){i=true;s=o.indexOf("!")>-1;a=o.indexOf("@")>-1;l=o.indexOf("%")>-1;d=r.indexOf("=")+1;if(d){n=r.slice(0,d-1).trim();u=r.substring(d).trim();if(matrixOfNames.test(n)){n=n.slice(1,-1).trim()}if(/[,;]/.test(n)){const e=n.split(/[,;]/);for(let n=0;n<e.length;n++){const r=e[n].trim();if(isKeyWord.test(r)||!isValidIdentifier$1.test(r)){return shortcut(S,t)}}g=e.map((e=>e.trim()))}else{if(isValidIdentifier$1.test(n)&&!isKeyWord.test(n)){g=n}else{u=r}}}else{u=r}}else if(M){g=r;u=o}else if(isValidIdentifier$1.test(r)&&!isKeyWord.test(r)){g=r;if(o===""){const e=parse$1(S,t);return{entry:S,tex:e,alt:S}}}else{return shortcut(S,t)}}else{return shortcut(S,t)}if(u.length>0){if(/^\s*fetch\(/.test(u)){p=""}else{[p,f,h]=parse$1(u,t,true);if(s||a||p.indexOf("")===-1||/\u00a0for\u00a0/.test(f)){p=""}else if(l){p=""}else{if(containsOperator.test(""+f+"")){p="\\textcolor{#0000ff}{"+p+"}"}else{p=""}}}}if(currencyRegEx.test(o)){y=true;x=o.charAt(0)}if(i){b=null;if(!y){x=o.replace(/[?@%!']/g,"").trim()}if(s){m=o}else{if(x){m=o.trim().replace(/([^ ?!@%]+)$/,"'"+"$1"+"'");m=parse$1(m,t).replace(/\\%/g,"%").replace("@ @","@@")}else{m=parse$1(o,t).replace(/\\%/g,"%").replace("@ @","@@")}m=m.replace(/\\text\{(\?\??|%%?)\}/,"$1");m=m.replace(/([?%]) ([?%])/,"$1"+"$2")}}else{[b,x,w,m]=valueFromLiteral(o,g,t);if(w===dt.ERROR){return shortcut(S,t)}f=""}let T="";let O="";if(!a){T=parse$1(r,t);if(c){T="\\begin{aligned}"+T;const e=T.indexOf("=");T=T.slice(0,e)+"&"+T.slice(e)}const e=c?"\\\\ &":"";O=r;if(p.length>0&&!l){T+=` ${e}= `+p}if(!s){T+=" "+(c?"\\\\&":"")+"= "+m;O+=" = "+o}if(c){T+="\\end{aligned}"}}const N={entry:S,template:T,altTemplate:O,resultdisplay:m,dtype:w,error:false};if(g){N.name=g}if(i){N.resulttemplate=m;N.altresulttemplate=o}else{N.tex=T;N.alt=O}if(f){N.rpn=f}if(h.length>0){N.dependencies=h}if(b){N.value=b}if(x){if(f&&!N.value){N.unit=typeof x==="string"?unitFromUnitName(x):{factor:1,gauge:0,expos:allZeros}}else{N.unit=Array.isArray(x)?{expos:x}:x}}return N};const calculate=(e,t={},n=false,r={decimalFormat:"1,000,000.",dateFormat:"yyyy-mm-dd"})=>{let o=compile(e,r);if(o.rpn){o=evaluate(clone(o),t,r)}else if(o.dtype&&o.dtype===dt.DRAWING){o=evaluateDrawing(o,t,r)}if(o.name){insertOneHurmetVar(t,o)}return o.dtype&&o.dtype===dt.DRAWING?o:n?o.alt:o.tex};class MarkdownSerializer{constructor(e,t){this.nodes=e;this.marks=t}serialize(e,t,n,r=false,o=false,i=false){let s=new MarkdownSerializerState(this.nodes,this.marks,t,n,r,i);s.renderContent(e);for(let e=0;e<s.footnotes.length;e++){s.write("\n[^"+String(e+1)+"]: ");s.renderInline(s.footnotes[e]);s.write("\n")}if(!o){for(const[e,t]of s.paths.entries()){s.write("\n["+e+"]: "+t+"\n")}}return s.out}}const ampRegEx=/=[^=]*@[^=]*$/;const hurmetNodes={blockquote(e,t){e.wrapBlock("> ",null,t,(()=>e.renderContent(t)))},comment(e,t){if(e.isGFM){e.renderContent(t)}else{e.wrapBlock("",null,t,(()=>e.renderContent(t)),"comment")}},indented(e,t){if(e.isGFM){e.renderContent(t)}else{e.wrapBlock("",null,t,(()=>e.renderContent(t)),"indented")}},centered(e,t){if(e.isGFM){e.renderContent(t)}else{e.wrapBlock("",null,t,(()=>e.renderContent(t)),"centered")}},right_justified(e,t){if(e.isGFM){e.renderContent(t)}else{e.wrapBlock("",null,t,(()=>e.renderContent(t)),"right_justified")}},boxed(e,t){if(e.isGFM){e.renderContent(t)}else{e.wrapBlock("",null,t,(()=>e.renderContent(t)),"boxed")}},epigraph(e,t){if(e.isGFM){e.wrapBlock("> ",null,t,(()=>e.renderContent(t)))}else{e.wrapBlock("> ",null,t,(()=>e.renderContent(t)),"epigraph")}},note(e,t){e.wrapBlock("> ",null,t,(()=>e.renderContent(t)),"note")},tip(e,t){e.wrapBlock("> ",null,t,(()=>e.renderContent(t)),e.isGFM?"note":"tip")},important(e,t){e.wrapBlock("> ",null,t,(()=>e.renderContent(t)),"important")},warning(e,t){e.wrapBlock("> ",null,t,(()=>e.renderContent(t)),"warning")},header(e,t){if(e.isGFM){e.renderContent(t)}else{e.wrapBlock("","",t,(()=>e.renderContent(t)),"header")}},code_block(e,t){e.write("```"+(t.attrs.params||"")+"\n");e.text(t.textContent,false);e.ensureNewLine();e.write("```");e.closeBlock(t)},heading(e,t){e.write(e.repeat("#",t.attrs.level)+" ");e.renderInline(t);e.closeBlock(t)},toc(e,t){e.write(`{.toc start=${t.attrs.start} end=${t.attrs.end}}\n\n`)},horizontal_rule(e,t){e.write(t.attrs.markup||"--------------------");e.closeBlock(t)},bullet_list(e,t){e.renderList(t,"    ",(()=>(t.attrs.bullet||"*")+"   "))},ordered_list(e,t){const n=t.attrs.order||1;const r=e.isGFM?"decimal":t.attrs.class;let o=String(n+t.childCount-1).length;let i=e.repeat(" ",o+2);e.renderList(t,i,(t=>{let i=r==="decimal"?String(n+t):r==="upper-alpha"?String.fromCodePoint(n+t+64):String.fromCodePoint(n+t+96);return e.repeat(" ",o-i.length)+i+".  "}));if(e.delim===""){e.write("\n")}},list_item(e,t){e.renderContent(t)},tight_list_item(e,t){e.renderInline(t)},paragraph(e,t){const n=e.out.length;if(t.content.content.length>0){e.renderInline(t)}else{e.write("")}if(!e.isGFM){e.out=limitLineLength(e.out,n,e.delim,e.lineLimit)}e.closeBlock(t)},table(e,t){e.renderTable(t,e.delim,null,e.isGFM);e.closeBlock(t)},footnote(e,t){const n=t.content;e.footnotes.push(n);e.write(`[^${e.footnotes.length}]`)},figure(e,t){let n;if(t.content.content[1].type.name==="table"){const n=t.content.content[0];e.write(": ");e.renderInline(n);e.closeBlock(n);const r=e.out.length;const o=t.content.content[1];const i=t.attrs.class.trim();e.renderTable(o,e.delim,i,e.isGFM);e.closeBlock(o);e.out=e.out.slice(0,r)+e.out.slice(r+1)}else{if(!e.isGFM){const e=t.content.content[1];const r=new MarkdownSerializerState(hurmetNodes,hurmetMarks,this.paths,this.footnotes,false,false);r.renderInline(e);n=r.out}else{n=t.attrs.alt}const r=getRef(t,e);const o=t.content.content[0].attrs;if(t.attrs.class){o.class=t.attrs.class}let i=o.src;if(!e.isGFM&&(o.class||o.width||o.alt)){i+="\n{";if(o.class){i+="."+e.esc(o.class)}if(o.width&&!isNaN(o.width)){i+=" width="+o.width}if(o.alt){i+=' alt="'+e.esc(o.alt)+'"'}i+="}"}e.paths.set(r,i);if(r===n){e.write(`!![${n}][]\n\n`)}else{e.write(`!![${n}][${r}]\n\n`)}}},image(e,t){let n=e.esc(t.attrs.src);if(!e.isGFM&&(t.attrs.class||t.attrs.width||t.attrs.alt)){n+="\n{";if(t.attrs.class){n+="."+e.esc(t.attrs.class)}if(t.attrs.width&&!isNaN(t.attrs.width)){n+=" width="+t.attrs.width}if(t.attrs.alt){n+=' alt="'+e.esc(t.attrs.alt)+'"'}n+="}"}const r=getRef(t,e);e.paths.set(r,n);if(t.attrs.alt&&r!==t.attrs.alt){e.write(`![${t.attrs.alt}][${r}]`)}else{e.write(`![${r}][]`)}},hard_break(e,t,n,r){for(let o=r+1;o<n.childCount;o++)if(n.child(o).type!=t.type){e.write("\\\n");return}},text(e,t){e.text(t.text)},tex(e,t){const n=t.attrs.tex.trim();writeTex(e,t.attrs.displayMode,n)},calculation(e,t){let n=t.attrs.entry.trim().replace(/\n(?: *\n)+/g,"\n").replace(/\n/gm,"\n"+e.delim);if(e.isGFM){if(t.attrs.alt&&t.attrs.value){if(ampRegEx.test(n)){e.write(t.attrs.alt)}else{writeTex(e,t.attrs.displayMode,t.attrs.tex)}}else{const r=parse$1(n);writeTex(e,t.attrs.displayMode,r)}}else{if(t.attrs.entry.slice(0,5)==="draw("){const r=getRef(t,e);e.paths.set(r,n.replace(/\n/g,"\\n"));e.write(`![${r}][]`)}else if(e.withResults){const r=t.attrs.md?t.attrs.displaySelector:"";let o=t.attrs.md?t.attrs.md:n;if(t.attrs.displayMode){e.write(""+r+" "+o+" ")}else{const t=backticksFor({text:n,isText:true},-1).trim();o=""+r+t+" "+o+" "+t;e.write(o)}}else if(t.attrs.displayMode){e.write(""+" "+n+" ")}else{const t=backticksFor({text:n,isText:true},-1).trim();e.write(""+t+" "+n+" "+t)}}}};const hurmetMarks={em:{open:"_",close:"_",mixable:true,expelEnclosingWhitespace:true},strong:{open:"**",close:"**",mixable:true,expelEnclosingWhitespace:true},link:{open(e,t,n,r){return isPlainURL(t,n,r,1)?"<":"["},close(e,t,n,r){if(isPlainURL(t,n,r,-1)){return">"}else{const o=getRef(t,e);e.paths.set(o,e.esc(t.attrs.href));let i=n.child(r-1).text;return"]["+(i===o?"":o)+"]"}}},code:{open(e,t,n,r){return backticksFor(n.child(r),-1)},close(e,t,n,r){return backticksFor(n.child(r-1),1)},escape:false},superscript:{open(e){return e.isGFM?"<sup>":"^"},close(e){return e.isGFM?"</sup>":"^"},expelEnclosingWhitespace:true},subscript:{open(e){return e.isGFM?"<sub>":"~"},close(e){return e.isGFM?"</sub>":"~"},expelEnclosingWhitespace:true},strikethru:{open:"~~",close:"~~",mixable:true,expelEnclosingWhitespace:true},underline:{open:"<u>",close:"</u>",expelEnclosingWhitespace:true},highlight:{open:"<mark>",close:"</mark>",expelEnclosingWhitespace:true}};const hurmetMarkdownSerializer=new MarkdownSerializer(hurmetNodes,hurmetMarks,new Map);function backticksFor(e,t){let n=/`+/g,r,o=0;if(e.isText)while(r=n.exec(e.text))o=Math.max(o,r[0].length);let i=o>0&&t>0?" `":"`";for(let e=0;e<o;e++)i+="`";if(o>0&&t<0)i+=" ";return i}function isPlainURL(e,t,n,r){if(!/^\w+:/.test(e.attrs.href))return false;let o=t.child(n+(r<0?-1:0));if(!o.isText||o.text!=e.attrs.href||o.marks[o.marks.length-1]!=e)return false;if(n==(r<0?1:t.childCount-1))return true;let i=t.child(n+(r<0?-2:1));return!e.isInSet(i.marks)}const titleRegEx=/\n *title +"([^\n]+)" *\n/;const getRef=(e,t)=>{let n=e.type.name==="image"?e.attrs.alt:e.type.name==="figimg"?e.content.content[0].attrs.alt:null;if(e.attrs.entry&&titleRegEx.test(e.attrs.entry)){n=titleRegEx.exec(e.attrs.entry)[1].trim()}if(!isNaN(n)&&Number(n)%1===0){n=null}const r=isNaN(t.paths.size)?"1":String(t.paths.size+1);if(n){for(const e of t.paths.keys()){if(e===n){return r}}return n}else{return r}};const blockRegEx=/^(?:[>*+-] |#+ |\d+[.)] |[A-B]\. |\-\-\-|```|[iCFHhITWADE]> )/;function limitLineLength(e,t,n,r){let o=e.slice(t);if(o.length<=r){return e}if(/``|` *(?:function|draw\()/.test(o)){return e}const i="\n"+n;let s="";let a=0;while(o.length>r){const e=o.indexOf("\n");const t=r-(a>0?i.length:0);if(e>-1){let n=o.slice(0,e+1);while(n.length>t&&n.lastIndexOf(" ",t)>-1){const e=n.lastIndexOf(" ",t);s+=n.slice(0,e)+"\n";n=n.slice(e+1)}s+=n;o=o.slice(e+1)}else{let e=o.lastIndexOf(" ",t);if(e===-1){break}while(blockRegEx.test(o.slice(e+1))){e=o.lastIndexOf(" ",e-1);if(e===-1){break}}if(e===-1||o.length-e<7&&r===80){break}s+=(a>0?i:"")+o.slice(0,e);o=o.slice(e+1);a+=1}}s+=(a>0?i:"")+o;return e.slice(0,t)+s}const newlineRegEx=/\n/gm;const dollarRegEx=/([^ \\])\$/g;const writeTex=(e,t,n)=>{n=n.replace(newlineRegEx,"\n"+e.delim);n=n.replace(dollarRegEx,"$1 $");if(t){e.write("$$ "+n+" $$")}else{e.write("$"+n+"$")}};const justifyRegEx=/c(\d)([cr])/g;const trailNewlineRegEx=/\n+$/;const colWidthPicker=[0,80,50,35];class MarkdownSerializerState{constructor(e,t,n,r,o,i){this.nodes=e;this.marks=t;this.paths=n;this.footnotes=r;this.isGFM=o;this.withResults=i;this.delim=this.out="";this.divFence="";this.closed=false;this.lineLimit=80}flushClose(e){if(this.closed){if(!this.atBlank())this.out+="\n";if(e==null)e=2;if(e>1){let t=this.delim;let n=/\s+$/.exec(t);if(n)t=t.slice(0,t.length-n[0].length);for(let n=1;n<e;n++)this.out+=t+"\n"}this.closed=false}}wrapBlock(e,t,n,r,o){let i=this.delim;if(o){if(e.length>0){if(o){this.write(`> [!${o.toUpperCase()}]\n`)}}else{this.divFence+=":::";this.write(`${this.divFence} ${o}\n`)}}this.write(t||e);this.delim+=e;r();this.delim=i;if(o&&e.length===0){this.out=this.out.replace(trailNewlineRegEx,"")+`\n${this.delim}${this.divFence}\n`;this.divFence=this.divFence.slice(0,-3)}this.closeBlock(n)}atBlank(){return/(^|\n)$/.test(this.out)}ensureNewLine(){if(!this.atBlank())this.out+="\n"}write(e){this.flushClose();if(this.delim&&this.atBlank())this.out+=this.delim;if(e)this.out+=e}closeBlock(e){this.closed=e}text(e,t){let n=e.split("\n");for(let e=0;e<n.length;e++){var r=this.atBlank()||this.closed;this.write();this.out+=t!==false?this.esc(n[e],r):n[e];if(e!=n.length-1)this.out+="\n"}}render(e,t,n){if(typeof t=="number")throw new Error("!");this.nodes[e.type.name](this,e,t,n)}renderContent(e){e.forEach(((t,n,r)=>this.render(t,e,r)))}renderInline(e){let t=[],n="";let r=(r,o,i)=>{let s=r?r.marks:[];if(r&&r.type.name==="hard_break")s=s.filter((t=>{if(i+1==e.childCount)return false;let n=e.child(i+1);return t.isInSet(n.marks)&&(!n.isText||/\S/.test(n.text))}));let a=n;n="";if(r&&r.isText&&s.some((e=>{let t=this.marks[e.type.name];return t&&t.expelEnclosingWhitespace}))){let[e,o,i,l]=/^(\s*)(.*?)(\s*)$/m.exec(r.text);a+=o;n=l;if(o||l){r=i?r.withText(i):null;if(!r)s=t}}let l=s.length&&s[s.length-1],c=l&&this.marks[l.type.name].escape===false;let d=s.length-(c?1:0);e:for(let e=0;e<d;e++){let n=s[e];if(!this.marks[n.type.name].mixable)break;for(let r=0;r<t.length;r++){let o=t[r];if(!this.marks[o.type.name].mixable)break;if(n.eq(o)){if(e>r)s=s.slice(0,r).concat(n).concat(s.slice(r,e)).concat(s.slice(e+1,d));else if(r>e)s=s.slice(0,e).concat(s.slice(e+1,r)).concat(n).concat(s.slice(r,d));continue e}}}let u=0;while(u<Math.min(t.length,d)&&s[u].eq(t[u]))++u;while(u<t.length)this.text(this.markString(t.pop(),false,e,i),false);if(a)this.text(a);if(r){while(t.length<d){let n=s[t.length];t.push(n);this.text(this.markString(n,true,e,i),false)}if(c&&r.isText)this.text(this.markString(l,true,e,i)+r.text+this.markString(l,false,e,i+1),false);else this.render(r,e,i)}};e.forEach(r);r(null,null,e.childCount)}renderList(e,t,n){this.flushClose();e.forEach(((r,o,i)=>{if(r.type.name==="tight_list_item"){this.flushClose(1)}this.wrapBlock(t,n(i),e,(()=>this.render(r,e,i)))}))}paddedCell(e,t,n){const r=" ".repeat(n-e.length);return t==="r"?r+e:e+r}renderTable(e,t,n,r){const o="dtype"in e.attrs?e.attrs.dtype===dt.SPREADSHEET:false;const i=e.content.content;let s=i[0].content.content.length;for(let e=1;e<i.length;e++){s=Math.max(s,i[e].content.content.length)}let a=0;for(let e=0;e<i.length;e++){if(i[e].content.content[0].type.name==="table_header"){a+=1}else{break}}const l=e.attrs.class;const c=new Array(s).fill("L");let d;while((d=justifyRegEx.exec(l))!==null){c[Number(d[1])-1]=d[2]}const u=new Array(i.length);const p=new Array(i.length);const f=new Array(i.length);for(let e=0;e<i.length;e++){u[e]=new Array(s).fill("");p[e]=new Array(s).fill(1);f[e]=new Array(s).fill(1)}const h=new Array(s).fill(0);const m=[];let g=!r&&a>1;let y=new MarkdownSerializerState(hurmetNodes,hurmetMarks,this.paths,this.footnotes,this.isGFM,this.withResults);y.lineLimit=s>3?25:colWidthPicker[s];let b=0;let x=0;let w=0;while(b<i.length){while(x<s){if(p[b][x]===0||f[b][x]===0){x+=1;continue}const e=i[b].content.content[w];if(!e){f[b][x]=0;x+=1;continue}if(e.attrs.rowspan>1){p[b][x]=e.attrs.rowspan;for(let t=b+1;t<b+e.attrs.rowspan;t++){p[t][x]=0;f[t][x]=0}}if(e.attrs.colspan>1){f[b][x]=e.attrs.colspan;for(let t=x+1;t<x+e.attrs.colspan;t++){f[b][t]=0}}if(e.content.content.length>0){if(e.attrs.colspan>1){m.push([b,x,w])}else{const t=y.out.length;if(o){y.write(e.content.content[0].attrs.entry)}else{y.renderContent(e)}const n=y.out.slice(t).replace(/^\n+/,"").replace(/\n+$/,"").split("\n");u[b][x]=n;if(n.length>1&&!r){g=true}if(f[b][x]===1){for(let e of u[b][x]){if(e.length>h[x]){h[x]=e.length}}}}}x+=e.attrs.colspan;w+=1}b+=1;x=0;w=0}for(const e of m){const t=e[0];const n=e[1];const r=e[2];const s=i[t].content.content[r];let a=h[n];for(let e=1;e<f[t][n];e++){a+=h[n+e]+3}y.lineLimit=a;const l=y.out.length;if(o){y.write(s.content.content[0].attrs.entry)}else{y.renderContent(s)}u[t][n]=y.out.slice(l).replace(/^\n+/,"").split("\n")}for(let e=0;e<u.length;e++){for(let t=0;t<s;t++){if(p[e][t]>0&&f[e][t]>0){let n=h[t];for(let r=1;r<f[e][t];r++){n+=h[t+r]+3}for(let o=0;o<u[e][t].length;o++){if(u[e][t][o].indexOf("|")>-1&&!r){g=true}u[e][t][o]+=" ".repeat(n-u[e][t][o].length)}}}}if(m.length>0||y.out.indexOf("|")>-1){g=true}this.write(g?gridTable(u,s,a,p,f,h,c,t):pipeTable(u,s,h,c,t,a));let S="";for(let e=0;e<i.length;e++){if(i[e].content.content.length===s){for(const t of i[e].content.content){const e=t.attrs.colwidth?t.attrs.colwidth[0]:null;S+=" "+String(e)}break}}let R=e.attrs.class.replace(/ c\d+[cr]/g,"").trim();if(R.indexOf(" ")>-1){R=`"${R}"`}const v="name"in e.attrs?e.attrs.name:"";let M=`\n${t}{`;if(v){M+=`#${v} `}M+=`.${R}`;if(n&&n==="left"||n==="right"){M+=` float="${n}"`}M+=` colWidths="${S.trim()}"}\n`;if(!r){this.write(M)}}esc(e,t){e=e.replace(/([`*\\\$<\[_~^])/g,"\\$1");if(t){e=e.replace(/^(\#|:|\-|\*|\+|>)/,"\\$1").replace(/^(\d+|[A-Za-z])\.(?= )/,"$1\\.")}return e}quote(e){var t=e.indexOf('"')==-1?'""':e.indexOf("'")==-1?"''":"()";return t[0]+e+t[1]}repeat(e,t){let n="";for(let r=0;r<t;r++)n+=e;return n}markString(e,t,n,r){let o=this.marks[e.type.name];let i=t?o.open:o.close;return typeof i=="string"?i:i(this,e,n,r)}getEnclosingWhitespace(e){return{leading:(e.match(/^(\s+)/)||[])[0],trailing:(e.match(/(\s+)$/)||[])[0]}}}const pipeTable=(e,t,n,r,o,i)=>{let s="";if(i===0){s+="|".repeat(t+1)}else{s+="|";for(let n=0;n<t;n++){let t=e[0][n][0];if(t.trim()===""){t=t.replace(""," ")}s+=" "+t+" |"}}s+="\n|";for(let e=0;e<t;e++){let t=r[e]==="c"?":":"-";t+="-".repeat(n[e]);t+=("cr".indexOf(r[e])>-1?":":"-")+"|";s+=t}const a=i===0?0:1;for(let n=a;n<e.length;n++){s+="\n"+(n===0?"":o)+"|";for(let r=0;r<t;r++){let t=e[n][r][0];if(t.trim()===""){t=t.replace(""," ")}s+=" "+t+" |"}}return s};const gridTable=(e,t,n,r,o,i,s,a)=>{const l=(e,t,n,r)=>{let a="";for(let l=0;l<o[n===-1?0:n][r];l++){a+=t&&s[r]==="c"?":":e;a+=e.repeat(i[r+l]);a+=t&&"cr".indexOf(s[r])>-1?":":e;if(n<o.length-1&&r+l<o[0].length-1){a+=o[n+1][r+l+1]>0?"+":e}else{a+="+"}}return a};let c="+";let d=n===0?"=":"-";let u=d==="="||n===0;for(let e=0;e<t;e++){if(r[0][e]===0){continue}c+=l(d,u,-1,e)}const p=[];for(let e=0;e<t;e++){p.push({row:0,line:0})}const f=new Array(e.length).fill(false);let h=0;const m=new Array(e.length).fill(false);const g=[c];while(p[0].row<e.length){f[h]=true;let s=a+"|";for(let c=0;c<t;c++){if(r[p[c].row][c]===0){continue}if(o[p[c].row][c]===0){continue}const t=p[c].row+r[p[c].row][c]-1;if(e[p[c].row][c].length>p[c].line){let n=e[p[c].row][c][p[c].line];if(n===""){n=" "}s+=" "+n+" |";p[c].line+=1;if(p[c].line<e[p[c].row][c].length){f[t]=false}else if(o[p[c].row][c]>1){let e=0;for(let n=0;n<c+o[p[c].row][c]-1;n++){e+=i[n]+3;if(n>=c&&s.charAt(e)==="|"){f[t]=false;break}}}}else if(m[t]){if(c===0){s=a+"+"}d=n===t+1?"=":"-";u=d==="=";const e="+"+l(d,u,p[c].row,c);s=s.slice(0,-1)+e.slice(0,-1)+"+"}else{for(let e=0;e<o[p[c].row][c];e++){const t=e===o[p[c].row][c]-1?"|":" ";s+=" ".repeat(i[c+e]+2)+t}}}if(m[h]){for(let e=0;e<t;e++){if(p[e].row+r[p[e].row][e]-1===h){p[e].line=0;p[e].row+=r[p[e].row][e]}}h+=1}else if(f[h]){m[h]=true}g.push(s)}return g.join("\n")};const sheetNameRegEx=/^[\w]+\b/;const sheetLimits=(e,t)=>{let n=0;let r=0;let o;for(let e=t.depth;e>0;e--){const i=t.node(e);if(i.type.spec.tableRole==="table"){n=t.before(e);r=t.after(e);o=t.node(e-1);break}}return[n,r,o]};const numberRegEx$2=new RegExp(Rnl.numberPattern);const cellRefRegEx=/"[A-Z][1-9]+"/g;const innerRefRegEx=/^(?:[A-Z](?:\d+|_end)|up|left)$/;const sumRegEx=/(up|left)([\xa0])sum[\xa0]1(?=[\xa0]|$)/g;const spreadsheetRegEx=/ spreadsheet\b/;const grafRegEx=/\n\n/;const compileCell=(e,t,n,r,o="1,000,000.")=>{const i={entry:e.entry,name:e.name};const s=e.entry;if(s.length===0){i.value=null;i.dtype=dt.NULL}else if(s.slice(0,1)==="="){const r=s.replace(/^==?/,"").trim();let[a,l,c]=parse$1(r,o,true,false,t.name);const d=new Set;for(const e of c){if(!innerRefRegEx.test(e)){d.add(e)}}let u;while((u=sumRegEx.exec(l))!==null){const n=u[1]==="up"?e.name.slice(0,1):e.name.slice(1,2);l=l.slice(0,u.index)+`${t.name}`+u[2]+`"${n}"`+u[2]+"spreadsheetSum"+l.slice(u.index+u[0].length)}i.rpn=l;i.dependencies=d.size>0?[...d.values()]:[];i.resulttemplate=s.length>1&&s.slice(1,2)==="="?"@@":"@";i.altresulttemplate=i.resulttemplate;i.resultdisplay=i.resulttemplate;i.unit=n?n:{factor:Rnl.one,gauge:Rnl.zero,expos:allZeros}}else if(s==='"'||s===""){if(r.rpn){let e=r.rpn;const n=arrayOfRegExMatches(cellRefRegEx,e);for(let r=n.length-1;r>=0;r--){const o=n[r];const i=Math.min(t.numRows-1,Number(o.value.slice(2,-1))+1);e=e.slice(0,o.index+2)+String(i)+e.slice(o.index+o.length-String(i).length)}i.rpn=e;i.resulttemplate=r.resulttemplate;i.altresulttemplate=i.resulttemplate;i.resultdisplay=i.resulttemplate;i.unit=r.unit}else{i.value=r.value;i.dtype=r.dtype;i.display=r.display?r.display:r.entry}}else{const t=s.replace(/,/g,"");if(numberRegEx$2.test(t)){let e=Rnl.fromString(t);let r=dt.RATIONAL;if(n){e={plain:e,inBaseUnits:Rnl.multiply(Rnl.add(e,n.gauge),n.factor)};r+=dt.QUANTITY}i.value=e;i.dtype=r}else if(s==="true"||s==="false"){i.value=Boolean(s);i.dtype=dt.BOOLEAN}else if(complexRegEx.test(s)){const[t,n,r,a]=valueFromLiteral(s,e.name,o);i.value=t;i.dtype=r}else{i.value=s;i.dtype=dt.STRING}}return i};const compileSheet=(e,t)=>{e.attrs.numRows=e.content.length;e.attrs.columnMap={};e.attrs.rowMap={};e.attrs.unitMap=[];e.attrs.units={};e.attrs.dependencies=[];e.attrs.dtype=dt.SPREADSHEET;if(e.content[0].type==="colGroup"){e.content.shift()}const n=e.content.length;e.attrs.numRows=n;const r=e.content[0].content.length;for(let o=0;o<r;o++){let r={};for(let i=0;i<n;i++){const n=e.content[i].content[o].content[0];const s=String.fromCodePoint(65+o)+String(i);const a=n.attrs.entry;if(i===0){const t=md2text(a);let n="";let r="";const o=t.indexOf("\n");if(o===-1){n=t.trim()}else{r=t.slice(o+1).trim();n=t.slice(0,o).trim()}e.attrs.columnMap[n]=s.slice(0,1);if(r.length>0){const t=unitFromUnitName(r);if(t.dtype&&t.dtype===dt.ERROR){r=""}else{e.attrs.units[r]=t}}e.attrs.unitMap.push(r)}else{if(o===0){e.attrs.rowMap[a]=i}}const l={type:"spreadsheet_cell",attrs:{entry:a}};if(i===0){l.attrs.display=md2html(a)}else{l.attrs.name=s;const n=e.attrs.unitMap[o].length>0?e.attrs.units[e.attrs.unitMap[o]]:null;l.attrs=compileCell(l.attrs,e.attrs,n,r,t);r=l.attrs;r.unit=n;if(l.attrs.dependencies){for(const t of l.attrs.dependencies){if(!e.attrs.dependencies.includes(t)){e.attrs.dependencies.push(t)}}}}e.content[i].content[o].content=[l]}}return e};const tableToSheet=(e,t)=>{const[n,r,o]=sheetLimits(e.doc,e.selection.$from);if(o.content.content===1||o.content.content[0].type.name!=="figcaption"){alert("Table must have a caption that begins with the spreadsheets name.")}const i=o.content.content[0];const s=i.textContent;if(s.length===0){alert("Table caption must contain a string that begins with the spreadsheets name.");return}const a=sheetNameRegEx.exec(s);if(!a){alert("Table caption must begin with a valid identifier for the spreadsheets name.");return}const l=a[0];let c=t.toJSON();c.attrs.name=l;const d=c.content.length;const u=c.content[0].content.length;for(let e=0;e<u;e++){for(let n=0;n<d;n++){const r=t.content.content[n].content.content[e];let o=n===0?hurmetMarkdownSerializer.serialize(r,new Map,[]):r.textContent;if(n===0){o=o.replace(grafRegEx,"\\\n")}const i={type:"spreadsheet_cell",attrs:{entry:o}};if(n===0){i.attrs.display=md2html(o)}c.content[n].content[e].content=[i]}}const p={decimalFormat:e.doc.attrs.decimalFormat,dateFormat:e.doc.attrs.dateFormat};c=compileSheet(c,p);c.attrs.class+=" spreadsheet";c.attrs.dtype=dt.SPREADSHEET;return[c,n,r]};const sheetToTable=(e,t)=>{const n=t.toJSON();const r=n.attrs.class.replace(spreadsheetRegEx,"");n.attrs={class:r,dtype:dt.NULL};const o=n.content;for(let e=0;e<o.length;e++){const t=o[e].content;for(let n=0;n<t.length;n++){if(e===0){t[n].content=md2ast(t[n].content[0].attrs.entry)}else{const e=t[n].content[0].attrs.entry;if(e.length>0){t[n].content=[{type:"paragraph",content:[{type:"text",text:e}]}]}else{t[n].content=[{type:"paragraph",content:[]}]}}}}const[i,s,a]=sheetLimits(e.doc,e.selection.$from);return[n,i,s]};const fetchRegEx=/^(?:[A-Za-z\u0391-\u03C9\u03D5\u210B\u210F\u2110\u2112\u2113\u211B\u212C\u2130\u2131\u2133]|(?:\uD835[\uDC00-\udc33\udc9c-\udcb5]))[A-Za-z0-9_\u0391-\u03C9\u03D5\u0300-\u0308\u030A\u030C\u0332\u20d0\u20d1\u20d6\u20d7\u20e1]** *= *(?:fetch|import)\(/;const importRegEx=/^[^=]+= *import/;const fileErrorRegEx=/^Error while reading file. Status Code: \d*$/;const textRegEx=/\\text{[^}]+}/;const urlFromEntry=e=>{const t=e.replace(/^[^()]+\("?/,"");return t.replace(/"?\).*$/,"").trim()};const processFetchedString=(e,t,n,r)=>{const o=Object.create(null);o.entry=e;o.name=e.replace(/=.+$/,"").trim();let i=parse$1(e.replace(/\s*=\s*[$$\u20A0-\u20CF]?(?:!{1,2}).*$/,""),r);const s=urlFromEntry(e);if(/\.(?:tsv|txt)$/.test(s)){const e=s.replace(/.+\//,"");const t=textRegEx.exec(i);i=i.slice(0,t.index)+"\\text{"+addTextEscapes(e)+"})"}o.tex=i;o.alt=e;if(t==="File not found."||fileErrorRegEx.test(t)){o.dtype=dt.ERROR;o.tex+=` = \\red{\\text{${t}}}`;o.alt=" = "+t;o.value=null;return o}const a=importRegEx.test(e)?scanModule(t,r):DataFrame.dataFrameFromTSV(t);o.value=a.value;o.dtype=a.dtype;o.unit=a.unit;o.isFetch=true;o.fallback=a.dtype===dt.MODULE?t:"";if(a.dtype===dt.MODULE&&/^importedParameters *=/.test(e)){let e="\\begin{matrix}";let t=0;Object.entries(a.value).forEach((([r,o])=>{n[r]=o;e+=parse$1(o.name)+" & ";t+=1;if(t===5){e=e.slice(0,-1)+"\\\\ ";t=0}}));e=e.slice(0,t===0?-2:-1)+"\\end{matrix}";o.tex=o.tex.replace("\\mathrm{importedParameters}",e)}return o};const mustCalc=(e,t,n,r,o)=>{if(r||o){return true}if(e.rpn&&!(e.name&&t[e.name]&&t[e.name].isFetch)){for(const t of e.dependencies){if(n.has(t)){return true}}}if(e.dtype&&e.dtype===dt.DRAWING&&e.value.parameters&&e.value.parameters.length>0){for(const t of e.value.parameters){if(n.has(t)){return true}}}return false};const workWithFetchedTexts=(e,t,n,r,o,i,s,a,l,c)=>{const d=e.state;if(d.selection.to===s+1){d.selection=d.selection.constructor.near(d.doc.resolve(s+1))}const u=d.tr;for(let e=0;e<c.length;e++){const s=l[e];const p=o?t.nodeAt(s).attrs.entry:i.entry;const f=processFetchedString(p,c[e],a,r);f.inDraftMode=n;u.replaceWith(s,s+1,d.schema.nodes.calculation.createAndFill(f));if(f.name){insertOneHurmetVar(a,f,null,r.decimalFormat)}}proceedAfterFetch(e,o,i,s,a,u)};const workAsync=(e,t,n,r,o,i,s)=>{const a=e.state.doc;const l=a.attrs.inDraftMode;const c={decimalFormat:a.attrs.decimalFormat,dateFormat:a.attrs.dateFormat};if(!navigator.onLine){const d=[];for(const e of i){Object.keys(a.attrs.fallbacks).forEach((function(t){if(a.attrs.fallbacks[t].url===e){d.push(a.attrs.fallbacks[t].text)}}))}workWithFetchedTexts(e,a,l,c,t,n,r,o,s,d)}else{Promise.all(i.map((e=>fetch(e,{method:"GET",headers:{"Content-Type":"text/plain;charset=UTF-8"},mode:"cors"})))).then((e=>Promise.all(e.map((e=>{if(e.status!==200&&e.status!==0){Object.keys(a.attrs.fallbacks).forEach((function(t){if(a.attrs.fallbacks[t].url===e.url){return a.attrs.fallbacks[t].text}}));return e.status===404?"File not found.":"Error while reading file. Status Code: "+e.status}return e.text()}))))).then((i=>{workWithFetchedTexts(e,a,l,c,t,n,r,o,s,i)}))}};const proceedAfterFetch=(e,t,n,r,o,i)=>{const s=e.state.doc;const a={decimalFormat:s.attrs.decimalFormat,dateFormat:s.attrs.dateFormat};const l=e.state.schema.nodes.calculation;const c=t?null:new Set;if(!t&&(n.name||n.rpn||n.dtype&&n.dtype===dt.DRAWING)){s.nodesBetween(0,r,(function(e,t){if(e.type.name==="calculation"){const t=e.attrs;if(t.name){if(t.name==="importedParameters"){Object.entries(t.value).forEach((([e,t])=>{o[e]=t}))}else{insertOneHurmetVar(o,t,null,a.decimalFormat)}}}else if("dtype"in e.attrs&&e.attrs.dtype===dt.SPREADSHEET){const t=e.attrs.name;const n=clone(e.attrs);n.value={};o[t]=n;const r=e.content.content.length;const i=e.content.content[0].content.content.length;for(let n=0;n<i;n++){for(let i=1;i<r;i++){const r=e.content.content[i].content.content[n].content.content[0];o[t].value[r.attrs.name]=clone(r.attrs)}}}}));s.nodesBetween(r+1,s.content.size,(function(e,t){if(e.type.name==="calculation"&&e.attrs.dtype===dt.MODULE){insertOneHurmetVar(o,e.attrs,null,a.decimalFormat)}}));if(!fetchRegEx.test(n.entry)){if(!("dtype"in n&&n.dtype===dt.SPREADSHEET)){let e=clone(n);try{if(e.rpn||n.dtype&&n.dtype===dt.DRAWING){e=e.dtype&&e.dtype===dt.DRAWING?evaluateDrawing(e,o,a):evaluate(e,o,a)}if(e.name){insertOneHurmetVar(o,e,c,a.decimalFormat)}}catch(t){e.tex="\\text{"+e.entry+" = "+t+"}"}i.replaceWith(r,r+1,l.createAndFill(e))}else{const t=s.nodeAt(r);const n=t.toJSON();const l=n.attrs.name;const d=clone(n.attrs);delete d["value"];d.value={};o[l]=d;const u=n.content.length;const p=n.content[0].content.length;n.attrs.rowMap={};for(let e=0;e<p;e++){for(let t=1;t<u;t++){const r=n.content[t].content[e].content[0];if(r.attrs.rpn){r.attrs=evaluate(r.attrs,o,a);r.attrs.display=r.attrs.alt;if(e===0){n.attrs.rowMap[r.attrs.alt]=t}}else if(e===0&&typeof r.attrs.value==="string"){n.attrs.rowMap[r.attrs.value]=t}o[l].value[r.attrs.name]=r.attrs}}c.add(l);i.replaceWith(r,r+t.nodeSize,e.state.schema.nodeFromJSON(n))}}}const d=t?0:r+1;const u=n&&n.name&&n.name==="format";s.nodesBetween(d,s.content.size,(function(n,s){if(n.type.name==="calculation"){const e=t?!fetchRegEx.test(n.attrs.entry):!n.attrs.isFetch;if(e){const e=n.attrs.entry;let r=t?compile(e,a):clone(n.attrs);r.displayMode=n.attrs.displayMode;const d=r.dtype&&r.dtype===dt.DRAWING&&(r.rpn||(r.value.parameters.length>0||t));if(mustCalc(r,o,c,t,u)){try{if(r.rpn||d){r.error=false;r=r.rpn?evaluate(r,o,a):evaluateDrawing(r,o,a)}if(r.name){insertOneHurmetVar(o,r,c,a.decimalFormat)}}catch(e){r.tex="\\text{"+r.entry+" = "+e+"}"}if(t||r.rpn||d){i.replaceWith(s,s+1,l.createAndFill(r))}}else if(r.name&&r.value){insertOneHurmetVar(o,r,null,a.decimalFormat)}}else if(n.attrs.name&&!(t&&n.attrs.isFetch)){if(n.attrs.name){if(n.attrs.name==="importedParameters"){Object.entries(n.attrs.value).forEach((([e,t])=>{o[e]=t}))}else{insertOneHurmetVar(o,n.attrs,null,a.decimalFormat)}}}}else if("dtype"in n.attrs&&n.attrs.dtype===dt.SPREADSHEET&&s!==r){let r=clone(n.toJSON());let l=false;if(t){r=compileSheet(r,a);l=true}else{for(const e of r.attrs.dependencies){if(c.has(e)){l=true;break}}}if(l){const l=r.attrs.name;o[l]=r.attrs;o[l].value={};const d=r.content.length;const u=r.content[0].content.length;r.attrs.rowMap={};for(let e=0;e<u;e++){for(let t=1;t<d;t++){const n=r.content[t].content[e].content[0];if(n.attrs.rpn){n.attrs=evaluate(n.attrs,o,a);n.attrs.display=n.attrs.alt;if(e===0){r.attrs.rowMap[n.attrs.alt]=t}}else if(e===0&&typeof n.attrs.value==="string"){r.attrs.rowMap[n.attrs.value]=t}o[l].value[n.attrs.name]=n.attrs}}if(!t){c.add(l)}i.replaceWith(s,s+n.nodeSize,e.state.schema.nodeFromJSON(r))}}}));if(!t){i.setSelection(e.state.selection.constructor.near(i.doc.resolve(r+1)))}e.dispatch(i);e.focus()};function updateCalculations(e,t=false,n,r){const o=e.state.doc;const i=e.state.schema.nodes.calculation;if(!(t||n.name||n.rpn||n.dtype&&n.dtype===dt.DRAWING)){const t=e.state;if(t.selection.to===r+1){t.selection=t.selection.constructor.near(t.doc.resolve(r+1))}const o=t.tr;try{o.replaceWith(r,r+1,i.createAndFill(n))}catch(e){}finally{e.dispatch(o);e.focus()}return}const s=Object.create(null);s.format={value:"h15"};s["@savedate"]=o.attrs.saveDate;const a={decimalFormat:o.attrs.decimalFormat,dateFormat:o.attrs.dateFormat};const l=[];const c=[];if(!t){const e=n.entry;if(fetchRegEx.test(e)){l.push(urlFromEntry(e));c.push(r)}}else{o.nodesBetween(0,o.content.size,(function(e,t){if(e.type.name==="calculation"&&!e.attrs.value){const n=e.attrs.entry;if(fetchRegEx.test(n)){l.push(urlFromEntry(n));c.push(t)}else if(/^function /.test(n)){e.attrs=compile(n,a);insertOneHurmetVar(s,e.attrs,null,a.decimalFormat)}}else if(e.attrs.isFetch||e.attrs.dtype&&e.attrs.dtype===dt.MODULE){insertOneHurmetVar(s,e.attrs,null,a.decimalFormat)}}))}if(l.length>0){workAsync(e,t,n,r,s,l,c)}else{const o=e.state;if(o.selection.to===r+1){o.selection=o.selection.constructor.near(o.doc.resolve(r+1))}const i=o.tr;proceedAfterFetch(e,t,n,r,s,i)}}const helpers=Object.freeze({fetchRegEx:fetchRegEx,textRegEx:textRegEx,urlFromEntry:urlFromEntry,processFetchedString:processFetchedString});async function fetchTexts(e){return Promise.all(e.map((e=>fetch(e,{method:"GET",headers:{"Content-Type":"text/plain;charset=UTF-8"},mode:"cors"})))).then((e=>Promise.all(e.map((e=>{if(e.status!==200&&e.status!==0){return e.status===404?"File not found.":"Error while reading file. Status Code: "+e.status}return e.text()}))))).then((e=>e))}async function getRemoteTexts(e){return await fetchTexts(e)}const getCalcNodes=(e,t)=>{if(Array.isArray(e)){for(let n=0;n<e.length;n++){getCalcNodes(e[n],t)}}else if(e&&e.type==="calculation"){t.push(e)}else if(e&&e.type==="table"&&"name"in e.attrs){t.push(e)}else if("content"in e){for(let n=0;n<e.content.length;n++){getCalcNodes(e.content[n],t)}}};async function updateCalcs(e){const t=Object.create(null);t.format={value:"h15"};t["@savedate"]=e.attrs.saveDate;const n={decimalFormat:e.attrs.decimalFormat,dateFormat:e.attrs.dateFormat};const r=[];getCalcNodes(Array.isArray(e)?e:e.content,r);if(r.length===0){return e}const o=[];const i=[];for(const e of r){const r=e.attrs.entry;if(helpers.fetchRegEx.test(r)){o.push(helpers.urlFromEntry(r));i.push(e)}else if(/^function /.test(r)){e.attrs=compile(r,n);insertOneHurmetVar(t,e.attrs,null,n.decimalFormat)}}if(o.length>0){const e=await getRemoteTexts(o);for(let r=0;r<e.length;r++){const o=i[r];const s=o.attrs.entry;o.attrs=helpers.processFetchedString(s,e[r],t,n);if(o.attrs.name){if(o.attrs.name==="importedParameters"){Object.entries(o.attrs.value).forEach((([e,n])=>{t[e]=n}))}else{insertOneHurmetVar(t,o.attrs,null,n.decimalFormat)}}}}try{for(const e of r){if(e.type==="calculation"){if(!helpers.fetchRegEx.test(e.attrs.entry)){const r=e.attrs.entry;let o=compile(r,n);o.displayMode=e.attrs.displayMode;const i=o.dtype&&o.dtype===dt.DRAWING;if(o.rpn||i){o=o.rpn?evaluate(o,t,n):evaluateDrawing(o,t,n)}if(o.name){insertOneHurmetVar(t,o,null,n.decimalFormat)}e.attrs=o}}else if("dtype"in e.attrs&&e.attrs.dtype===dt.SPREADSHEET){const r=compileSheet(e,n);const o=r.attrs.name;t[o]=r.attrs;t[o].value={};const i=r.content.length;const s=r.content[0].content.length;r.attrs.rowMap={};for(let e=0;e<s;e++){for(let s=1;s<i;s++){const i=r.content[s].content[e].content[0];if(i.attrs.rpn){i.attrs.altresulttemplate=i.attrs.resulttemplate;i.attrs=evaluate(i.attrs,t,n);i.attrs.display=i.attrs.alt;if(e===0){r.attrs.rowMap[i.attrs.alt]=s}}else if(e===0&&typeof i.attrs.value==="string"){r.attrs.rowMap[i.attrs.value]=s}t[o].value[i.attrs.name]=i.attrs}}e.attrs=r.attrs;e.content=r.content}}return e}catch(e){console.log(e)}}const getTOCitems=(e,t,n,r,o)=>{if(Array.isArray(e)){for(let i=0;i<e.length;i++){getTOCitems(e[i],t,n,r,o)}}else if(e&&e.type==="heading"){const o=e.attrs.level;if(n<=o&&o<=r){t.push([headingText(e.content),o-n])}}else if(e.type==="toc"){o.push(e)}else if(e.hasOwnProperty("content")){for(let i=0;i<e.content.length;i++){getTOCitems(e.content[i],t,n,r,o)}}};const wrapWithHead=(e,t,n)=>{t=t?t:"Hurmet doc";const r=n&&n.fontSize?{10:"long-primer",12:"pica",18:"great-primer"}[n.fontSize]:"long-primer";const o=`<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="utf-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1">\n  <title>${t}</title>\n  <link rel="stylesheet" href="./styles.css">\n</head>\n<body>\n<article class="ProseMirror ${r}">\n<div class="ProseMirror-setup">\n`;return o+e+"\n</div></article>\n</body>\n</html>"};async function hurmet2html(e,t="",n=false){let r=md2ast(e,n);const o=/\n *\n{\.toc start=(\d) end=(\d)}\n/.exec(e);if(o){const e=Number(o[1]);const t=Number(o[2]);const n=[];const i=[];getTOCitems(r,n,e,t,i);i[0].attrs.body=n}r=await updateCalcs(r);let i=ast2html(r);if(t.length>0){i=wrapWithHead(i,t,r.attrs)}return i}class ParseError{constructor(e,t){let n=" "+e;let r;const o=t&&t.loc;if(o&&o.start<=o.end){const e=o.lexer.input;r=o.start;const t=o.end;if(r===e.length){n+=" at end of input: "}else{n+=" at position "+(r+1)+": "}const i=e.slice(r,t).replace(/[^]/g,"$&");let s;if(r>15){s=""+e.slice(r-15,r)}else{s=e.slice(0,r)}let a;if(t+15<e.length){a=e.slice(t,t+15)+""}else{a=e.slice(t)}n+=s+i+a}const i=new Error(n);i.name="ParseError";i.__proto__=ParseError.prototype;i.position=r;return i}}ParseError.prototype.__proto__=Error.prototype;const deflt=function(e,t){return e===undefined?t:e};const uppercase=/([A-Z])/g;const hyphenate=function(e){return e.replace(uppercase,"-$1").toLowerCase()};const ESCAPE_LOOKUP={"&":"&amp;",">":"&gt;","<":"&lt;",'"':"&quot;","'":"&#x27;"};const ESCAPE_REGEX=/[&><"']/g;function escape(e){return String(e).replace(ESCAPE_REGEX,(e=>ESCAPE_LOOKUP[e]))}const getBaseElem=function(e){if(e.type==="ordgroup"){if(e.body.length===1){return getBaseElem(e.body[0])}else{return e}}else if(e.type==="color"){if(e.body.length===1){return getBaseElem(e.body[0])}else{return e}}else if(e.type==="font"){return getBaseElem(e.body)}else{return e}};const isCharacterBox=function(e){const t=getBaseElem(e);return t.type==="mathord"||t.type==="textord"||t.type==="atom"};const assert=function(e){if(!e){throw new Error("Expected non-null, but got "+String(e))}return e};const protocolFromUrl=function(e){const t=/^[\x00-\x20]*([^\\/#?]*?)(:|&#0*58|&#x0*3a|&colon)/i.exec(e);if(!t){return"_relative"}if(t[2]!==":"){return null}if(!/^[a-zA-Z][a-zA-Z0-9+\-.]*$/.test(t[1])){return null}return t[1].toLowerCase()};const round=function(e){return+e.toFixed(4)};var utils={deflt:deflt,escape:escape,hyphenate:hyphenate,getBaseElem:getBaseElem,isCharacterBox:isCharacterBox,protocolFromUrl:protocolFromUrl,round:round};class Settings{constructor(e){e=e||{};this.displayMode=utils.deflt(e.displayMode,false);this.annotate=utils.deflt(e.annotate,false);this.leqno=utils.deflt(e.leqno,false);this.throwOnError=utils.deflt(e.throwOnError,false);this.errorColor=utils.deflt(e.errorColor,"#b22222");this.macros=e.macros||{};this.wrap=utils.deflt(e.wrap,"tex");this.xml=utils.deflt(e.xml,false);this.colorIsTextColor=utils.deflt(e.colorIsTextColor,false);this.strict=utils.deflt(e.strict,false);this.trust=utils.deflt(e.trust,false);this.maxSize=e.maxSize===undefined?[Infinity,Infinity]:Array.isArray(e.maxSize)?e.maxSize:[Infinity,Infinity];this.maxExpand=Math.max(0,utils.deflt(e.maxExpand,1e3))}isTrusted(e){if(e.url&&!e.protocol){const t=utils.protocolFromUrl(e.url);if(t==null){return false}e.protocol=t}const t=typeof this.trust==="function"?this.trust(e):this.trust;return Boolean(t)}}const _functions={};const _mathmlGroupBuilders={};function defineFunction({type:e,names:t,props:n,handler:r,mathmlBuilder:o}){const i={type:e,numArgs:n.numArgs,argTypes:n.argTypes,allowedInArgument:!!n.allowedInArgument,allowedInText:!!n.allowedInText,allowedInMath:n.allowedInMath===undefined?true:n.allowedInMath,numOptionalArgs:n.numOptionalArgs||0,infix:!!n.infix,primitive:!!n.primitive,handler:r};for(let e=0;e<t.length;++e){_functions[t[e]]=i}if(e){if(o){_mathmlGroupBuilders[e]=o}}}function defineFunctionBuilders({type:e,mathmlBuilder:t}){defineFunction({type:e,names:[],props:{numArgs:0},handler(){throw new Error("Should never be called.")},mathmlBuilder:t})}const normalizeArgument=function(e){return e.type==="ordgroup"&&e.body.length===1?e.body[0]:e};const ordargument=function(e){return e.type==="ordgroup"?e.body:[e]};class DocumentFragment{constructor(e){this.children=e;this.classes=[];this.style={}}hasClass(e){return this.classes.includes(e)}toNode(){const e=document.createDocumentFragment();for(let t=0;t<this.children.length;t++){e.appendChild(this.children[t].toNode())}return e}toMarkup(){let e="";for(let t=0;t<this.children.length;t++){e+=this.children[t].toMarkup()}return e}toText(){const e=e=>e.toText();return this.children.map(e).join("")}}const createClass=function(e){return e.filter((e=>e)).join(" ")};const initNode=function(e,t){this.classes=e||[];this.attributes={};this.style=t||{}};const toNode=function(e){const t=document.createElement(e);t.className=createClass(this.classes);for(const e in this.style){if(Object.prototype.hasOwnProperty.call(this.style,e)){t.style[e]=this.style[e]}}for(const e in this.attributes){if(Object.prototype.hasOwnProperty.call(this.attributes,e)){t.setAttribute(e,this.attributes[e])}}for(let e=0;e<this.children.length;e++){t.appendChild(this.children[e].toNode())}return t};const toMarkup=function(e){let t=`<${e}`;if(this.classes.length){t+=` class="${utils.escape(createClass(this.classes))}"`}let n="";for(const e in this.style){if(Object.prototype.hasOwnProperty.call(this.style,e)){n+=`${utils.hyphenate(e)}:${this.style[e]};`}}if(n){t+=` style="${n}"`}for(const e in this.attributes){if(Object.prototype.hasOwnProperty.call(this.attributes,e)){t+=` ${e}="${utils.escape(this.attributes[e])}"`}}t+=">";for(let e=0;e<this.children.length;e++){t+=this.children[e].toMarkup()}t+=`</${e}>`;return t};class Span{constructor(e,t,n){initNode.call(this,e,n);this.children=t||[]}setAttribute(e,t){this.attributes[e]=t}toNode(){return toNode.call(this,"span")}toMarkup(){return toMarkup.call(this,"span")}}let TextNode$1=class e{constructor(e){this.text=e}toNode(){return document.createTextNode(this.text)}toMarkup(){return utils.escape(this.text)}};class Img{constructor(e,t,n){this.alt=t;this.src=e;this.classes=["mord"];this.style=n}hasClass(e){return this.classes.includes(e)}toNode(){const e=document.createElement("img");e.src=this.src;e.alt=this.alt;e.className="mord";for(const t in this.style){if(Object.prototype.hasOwnProperty.call(this.style,t)){e.style[t]=this.style[t]}}return e}toMarkup(){let e=`<img src='${this.src}' alt='${this.alt}'`;let t="";for(const e in this.style){if(Object.prototype.hasOwnProperty.call(this.style,e)){t+=`${utils.hyphenate(e)}:${this.style[e]};`}}if(t){e+=` style="${utils.escape(t)}"`}e+=">";return e}}function newDocumentFragment(e){return new DocumentFragment(e)}class MathNode{constructor(e,t,n,r){this.type=e;this.attributes={};this.children=t||[];this.classes=n||[];this.style=r||{}}setAttribute(e,t){this.attributes[e]=t}getAttribute(e){return this.attributes[e]}toNode(){const e=document.createElementNS("http://www.w3.org/1998/Math/MathML",this.type);for(const t in this.attributes){if(Object.prototype.hasOwnProperty.call(this.attributes,t)){e.setAttribute(t,this.attributes[t])}}if(this.classes.length>0){e.className=createClass(this.classes)}for(const t in this.style){if(Object.prototype.hasOwnProperty.call(this.style,t)){e.style[t]=this.style[t]}}for(let t=0;t<this.children.length;t++){e.appendChild(this.children[t].toNode())}return e}toMarkup(){let e="<"+this.type;for(const t in this.attributes){if(Object.prototype.hasOwnProperty.call(this.attributes,t)){e+=" "+t+'="';e+=utils.escape(this.attributes[t]);e+='"'}}if(this.classes.length>0){e+=` class="${utils.escape(createClass(this.classes))}"`}let t="";for(const e in this.style){if(Object.prototype.hasOwnProperty.call(this.style,e)){t+=`${utils.hyphenate(e)}:${this.style[e]};`}}if(t){e+=` style="${t}"`}e+=">";for(let t=0;t<this.children.length;t++){e+=this.children[t].toMarkup()}e+="</"+this.type+">";return e}toText(){return this.children.map((e=>e.toText())).join("")}}class TextNode{constructor(e){this.text=e}toNode(){return document.createTextNode(this.text)}toMarkup(){return utils.escape(this.toText())}toText(){return this.text}}const wrapWithMstyle=e=>{let t;if(e.length===1&&e[0].type==="mrow"){t=e.pop();t.type="mstyle"}else{t=new MathNode("mstyle",e)}return t};var mathMLTree={MathNode:MathNode,TextNode:TextNode,newDocumentFragment:newDocumentFragment};const estimatedWidth=e=>{let t=0;if(e.body){for(const n of e.body){t+=estimatedWidth(n)}}else if(e.type==="supsub"){t+=estimatedWidth(e.base);if(e.sub){t+=.7*estimatedWidth(e.sub)}if(e.sup){t+=.7*estimatedWidth(e.sup)}}else if(e.type==="mathord"||e.type==="textord"){for(const n of e.text.split("")){const e=n.codePointAt(0);if(96<e&&e<123||944<e&&e<970){t+=.56}else if(47<e&&e<58){t+=.5}else{t+=.92}}}else{t+=1}return t};const stretchyCodePoint={widehat:"^",widecheck:"",widetilde:"~",wideparen:"",utilde:"~",overleftarrow:"",underleftarrow:"",xleftarrow:"",overrightarrow:"",underrightarrow:"",xrightarrow:"",underbrace:"",overbrace:"",overgroup:"",overparen:"",undergroup:"",underparen:"",overleftrightarrow:"",underleftrightarrow:"",xleftrightarrow:"",Overrightarrow:"",xRightarrow:"",overleftharpoon:"",xleftharpoonup:"",overrightharpoon:"",xrightharpoonup:"",xLeftarrow:"",xLeftrightarrow:"",xhookleftarrow:"",xhookrightarrow:"",xmapsto:"",xrightharpoondown:"",xleftharpoondown:"",xtwoheadleftarrow:"",xtwoheadrightarrow:"",xlongequal:"=",xrightleftarrows:"",yields:"",yieldsLeft:"",mesomerism:"",longrightharpoonup:"",longleftharpoondown:"",eqrightharpoonup:"",eqleftharpoondown:"","\\cdrightarrow":"","\\cdleftarrow":"","\\cdlongequal":"="};const mathMLnode=function(e){const t=new mathMLTree.TextNode(stretchyCodePoint[e.slice(1)]);const n=new mathMLTree.MathNode("mo",[t]);n.setAttribute("stretchy","true");return n};const crookedWides=["\\widetilde","\\widehat","\\widecheck","\\utilde"];const accentNode=e=>{const t=mathMLnode(e.label);if(crookedWides.includes(e.label)){const n=estimatedWidth(e.base);if(1<n&&n<1.6){t.classes.push("tml-crooked-2")}else if(1.6<=n&&n<2.5){t.classes.push("tml-crooked-3")}else if(2.5<=n){t.classes.push("tml-crooked-4")}}return t};var stretchy={mathMLnode:mathMLnode,accentNode:accentNode};const ATOMS={bin:1,close:1,inner:1,open:1,punct:1,rel:1};const NON_ATOMS={"accent-token":1,mathord:1,"op-token":1,spacing:1,textord:1};const symbols={math:{},text:{}};function defineSymbol(e,t,n,r,o){symbols[e][r]={group:t,replace:n};if(o&&n){symbols[e][n]=symbols[e][r]}}const math="math";const text="text";const accent="accent-token";const bin="bin";const close="close";const inner="inner";const mathord="mathord";const op="op-token";const open="open";const punct="punct";const rel="rel";const spacing="spacing";const textord="textord";defineSymbol(math,rel,"","\\equiv",true);defineSymbol(math,rel,"","\\prec",true);defineSymbol(math,rel,"","\\succ",true);defineSymbol(math,rel,"","\\sim",true);defineSymbol(math,rel,"","\\perp",true);defineSymbol(math,rel,"","\\preceq",true);defineSymbol(math,rel,"","\\succeq",true);defineSymbol(math,rel,"","\\simeq",true);defineSymbol(math,rel,"","\\backcong",true);defineSymbol(math,rel,"|","\\mid",true);defineSymbol(math,rel,"","\\ll",true);defineSymbol(math,rel,"","\\gg",true);defineSymbol(math,rel,"","\\asymp",true);defineSymbol(math,rel,"","\\parallel");defineSymbol(math,rel,"","\\smile",true);defineSymbol(math,rel,"","\\sqsubseteq",true);defineSymbol(math,rel,"","\\sqsupseteq",true);defineSymbol(math,rel,"","\\doteq",true);defineSymbol(math,rel,"","\\frown",true);defineSymbol(math,rel,"","\\ni",true);defineSymbol(math,rel,"","\\notni",true);defineSymbol(math,rel,"","\\propto",true);defineSymbol(math,rel,"","\\vdash",true);defineSymbol(math,rel,"","\\dashv",true);defineSymbol(math,rel,"","\\owns");defineSymbol(math,rel,"","\\arceq",true);defineSymbol(math,rel,"","\\wedgeq",true);defineSymbol(math,rel,"","\\veeeq",true);defineSymbol(math,rel,"","\\stareq",true);defineSymbol(math,rel,"","\\eqdef",true);defineSymbol(math,rel,"","\\measeq",true);defineSymbol(math,rel,"","\\questeq",true);defineSymbol(math,rel,"","\\ne",true);defineSymbol(math,rel,"","\\neq");defineSymbol(math,rel,"","\\eqeq",true);defineSymbol(math,rel,"","\\eqeqeq",true);defineSymbol(math,rel,"","\\dblcolon",true);defineSymbol(math,rel,"","\\coloneqq",true);defineSymbol(math,rel,"","\\eqqcolon",true);defineSymbol(math,rel,"","\\eqcolon",true);defineSymbol(math,rel,"","\\Coloneqq",true);defineSymbol(math,punct,".","\\ldotp");defineSymbol(math,punct,"","\\cdotp");defineSymbol(math,textord,"#","\\#");defineSymbol(text,textord,"#","\\#");defineSymbol(math,textord,"&","\\&");defineSymbol(text,textord,"&","\\&");defineSymbol(math,textord,"","\\aleph",true);defineSymbol(math,textord,"","\\forall",true);defineSymbol(math,textord,"","\\hbar",true);defineSymbol(math,textord,"","\\exists",true);defineSymbol(math,bin,"","\\nabla",true);defineSymbol(math,textord,"","\\flat",true);defineSymbol(math,textord,"","\\ell",true);defineSymbol(math,textord,"","\\natural",true);defineSymbol(math,textord,"","\\Angstrom",true);defineSymbol(text,textord,"","\\Angstrom",true);defineSymbol(math,textord,"","\\clubsuit",true);defineSymbol(math,textord,"","\\varclubsuit",true);defineSymbol(math,textord,"","\\wp",true);defineSymbol(math,textord,"","\\sharp",true);defineSymbol(math,textord,"","\\diamondsuit",true);defineSymbol(math,textord,"","\\vardiamondsuit",true);defineSymbol(math,textord,"","\\Re",true);defineSymbol(math,textord,"","\\heartsuit",true);defineSymbol(math,textord,"","\\varheartsuit",true);defineSymbol(math,textord,"","\\Im",true);defineSymbol(math,textord,"","\\spadesuit",true);defineSymbol(math,textord,"","\\varspadesuit",true);defineSymbol(math,textord,"","\\female",true);defineSymbol(math,textord,"","\\male",true);defineSymbol(math,textord,"","\\S",true);defineSymbol(text,textord,"","\\S");defineSymbol(math,textord,"","\\P",true);defineSymbol(text,textord,"","\\P");defineSymbol(text,textord,"","\\smiley",true);defineSymbol(math,textord,"","\\smiley",true);defineSymbol(math,textord,"","\\dag");defineSymbol(text,textord,"","\\dag");defineSymbol(text,textord,"","\\textdagger");defineSymbol(math,textord,"","\\ddag");defineSymbol(text,textord,"","\\ddag");defineSymbol(text,textord,"","\\textdaggerdbl");defineSymbol(math,close,"","\\rmoustache",true);defineSymbol(math,open,"","\\lmoustache",true);defineSymbol(math,close,"","\\rgroup",true);defineSymbol(math,open,"","\\lgroup",true);defineSymbol(math,bin,"","\\mp",true);defineSymbol(math,bin,"","\\ominus",true);defineSymbol(math,bin,"","\\uplus",true);defineSymbol(math,bin,"","\\sqcap",true);defineSymbol(math,bin,"","\\ast");defineSymbol(math,bin,"","\\sqcup",true);defineSymbol(math,bin,"","\\bigcirc",true);defineSymbol(math,bin,"","\\bullet",true);defineSymbol(math,bin,"","\\ddagger");defineSymbol(math,bin,"","\\wr",true);defineSymbol(math,bin,"","\\amalg");defineSymbol(math,bin,"&","\\And");defineSymbol(math,bin,"","\\sslash",true);defineSymbol(math,rel,"","\\longleftarrow",true);defineSymbol(math,rel,"","\\Leftarrow",true);defineSymbol(math,rel,"","\\Longleftarrow",true);defineSymbol(math,rel,"","\\longrightarrow",true);defineSymbol(math,rel,"","\\Rightarrow",true);defineSymbol(math,rel,"","\\Longrightarrow",true);defineSymbol(math,rel,"","\\leftrightarrow",true);defineSymbol(math,rel,"","\\longleftrightarrow",true);defineSymbol(math,rel,"","\\Leftrightarrow",true);defineSymbol(math,rel,"","\\Longleftrightarrow",true);defineSymbol(math,rel,"","\\mapsfrom",true);defineSymbol(math,rel,"","\\mapsto",true);defineSymbol(math,rel,"","\\longmapsto",true);defineSymbol(math,rel,"","\\nearrow",true);defineSymbol(math,rel,"","\\hookleftarrow",true);defineSymbol(math,rel,"","\\hookrightarrow",true);defineSymbol(math,rel,"","\\searrow",true);defineSymbol(math,rel,"","\\leftharpoonup",true);defineSymbol(math,rel,"","\\rightharpoonup",true);defineSymbol(math,rel,"","\\swarrow",true);defineSymbol(math,rel,"","\\leftharpoondown",true);defineSymbol(math,rel,"","\\rightharpoondown",true);defineSymbol(math,rel,"","\\nwarrow",true);defineSymbol(math,rel,"","\\rightleftharpoons",true);defineSymbol(math,mathord,"","\\lightning",true);defineSymbol(math,mathord,"","\\QED",true);defineSymbol(math,mathord,"","\\permil",true);defineSymbol(text,textord,"","\\permil");defineSymbol(math,mathord,"","\\astrosun",true);defineSymbol(math,mathord,"","\\sun",true);defineSymbol(math,mathord,"","\\leftmoon",true);defineSymbol(math,mathord,"","\\rightmoon",true);defineSymbol(math,mathord,"","\\Earth");defineSymbol(math,rel,"","\\nless",true);defineSymbol(math,rel,"","\\lneq",true);defineSymbol(math,rel,"","\\lneqq",true);defineSymbol(math,rel,"","\\lvertneqq");defineSymbol(math,rel,"","\\lnsim",true);defineSymbol(math,rel,"","\\lnapprox",true);defineSymbol(math,rel,"","\\nprec",true);defineSymbol(math,rel,"","\\npreceq",true);defineSymbol(math,rel,"","\\precnsim",true);defineSymbol(math,rel,"","\\precnapprox",true);defineSymbol(math,rel,"","\\nsim",true);defineSymbol(math,rel,"","\\nmid",true);defineSymbol(math,rel,"","\\nshortmid");defineSymbol(math,rel,"","\\nvdash",true);defineSymbol(math,rel,"","\\nvDash",true);defineSymbol(math,rel,"","\\ntriangleleft");defineSymbol(math,rel,"","\\ntrianglelefteq",true);defineSymbol(math,rel,"","\\nsubset",true);defineSymbol(math,rel,"","\\nsupset",true);defineSymbol(math,rel,"","\\subsetneq",true);defineSymbol(math,rel,"","\\varsubsetneq");defineSymbol(math,rel,"","\\subsetneqq",true);defineSymbol(math,rel,"","\\varsubsetneqq");defineSymbol(math,rel,"","\\ngtr",true);defineSymbol(math,rel,"","\\gneq",true);defineSymbol(math,rel,"","\\gneqq",true);defineSymbol(math,rel,"","\\gvertneqq");defineSymbol(math,rel,"","\\gnsim",true);defineSymbol(math,rel,"","\\gnapprox",true);defineSymbol(math,rel,"","\\nsucc",true);defineSymbol(math,rel,"","\\nsucceq",true);defineSymbol(math,rel,"","\\succnsim",true);defineSymbol(math,rel,"","\\succnapprox",true);defineSymbol(math,rel,"","\\ncong",true);defineSymbol(math,rel,"","\\nparallel",true);defineSymbol(math,rel,"","\\nshortparallel");defineSymbol(math,rel,"","\\nVDash",true);defineSymbol(math,rel,"","\\ntriangleright");defineSymbol(math,rel,"","\\ntrianglerighteq",true);defineSymbol(math,rel,"","\\supsetneq",true);defineSymbol(math,rel,"","\\varsupsetneq");defineSymbol(math,rel,"","\\supsetneqq",true);defineSymbol(math,rel,"","\\varsupsetneqq");defineSymbol(math,rel,"","\\nVdash",true);defineSymbol(math,rel,"","\\precneqq",true);defineSymbol(math,rel,"","\\succneqq",true);defineSymbol(math,bin,"","\\unlhd");defineSymbol(math,bin,"","\\unrhd");defineSymbol(math,rel,"","\\nleftarrow",true);defineSymbol(math,rel,"","\\nrightarrow",true);defineSymbol(math,rel,"","\\nLeftarrow",true);defineSymbol(math,rel,"","\\nRightarrow",true);defineSymbol(math,rel,"","\\nleftrightarrow",true);defineSymbol(math,rel,"","\\nLeftrightarrow",true);defineSymbol(math,rel,"","\\vartriangle");defineSymbol(math,textord,"","\\hslash");defineSymbol(math,textord,"","\\triangledown");defineSymbol(math,textord,"","\\lozenge");defineSymbol(math,textord,"","\\circledS");defineSymbol(math,textord,"","\\circledR",true);defineSymbol(text,textord,"","\\circledR");defineSymbol(text,textord,"","\\textregistered");defineSymbol(math,textord,"","\\measuredangle",true);defineSymbol(math,textord,"","\\nexists");defineSymbol(math,textord,"","\\mho");defineSymbol(math,textord,"","\\Finv",true);defineSymbol(math,textord,"","\\Game",true);defineSymbol(math,textord,"","\\backprime");defineSymbol(math,textord,"","\\backdprime");defineSymbol(math,textord,"","\\backtrprime");defineSymbol(math,textord,"","\\blacktriangle");defineSymbol(math,textord,"","\\blacktriangledown");defineSymbol(math,textord,"","\\blacksquare");defineSymbol(math,textord,"","\\blacklozenge");defineSymbol(math,textord,"","\\bigstar");defineSymbol(math,textord,"","\\sphericalangle",true);defineSymbol(math,textord,"","\\complement",true);defineSymbol(math,textord,"","\\eth",true);defineSymbol(text,textord,"","");defineSymbol(math,textord,"","\\diagup");defineSymbol(math,textord,"","\\diagdown");defineSymbol(math,textord,"","\\square");defineSymbol(math,textord,"","\\Box");defineSymbol(math,textord,"","\\Diamond");defineSymbol(math,textord,"","\\yen",true);defineSymbol(text,textord,"","\\yen",true);defineSymbol(math,textord,"","\\checkmark",true);defineSymbol(text,textord,"","\\checkmark");defineSymbol(math,textord,"","\\ballotx",true);defineSymbol(text,textord,"","\\ballotx");defineSymbol(text,textord,"","\\textbullet");defineSymbol(math,textord,"","\\beth",true);defineSymbol(math,textord,"","\\daleth",true);defineSymbol(math,textord,"","\\gimel",true);defineSymbol(math,textord,"","\\digamma",true);defineSymbol(math,textord,"","\\varkappa");defineSymbol(math,open,"","\\ulcorner",true);defineSymbol(math,close,"","\\urcorner",true);defineSymbol(math,open,"","\\llcorner",true);defineSymbol(math,close,"","\\lrcorner",true);defineSymbol(math,rel,"","\\leqq",true);defineSymbol(math,rel,"","\\leqslant",true);defineSymbol(math,rel,"","\\eqslantless",true);defineSymbol(math,rel,"","\\lesssim",true);defineSymbol(math,rel,"","\\lessapprox",true);defineSymbol(math,rel,"","\\approxeq",true);defineSymbol(math,bin,"","\\lessdot");defineSymbol(math,rel,"","\\lll",true);defineSymbol(math,rel,"","\\lessgtr",true);defineSymbol(math,rel,"","\\lesseqgtr",true);defineSymbol(math,rel,"","\\lesseqqgtr",true);defineSymbol(math,rel,"","\\doteqdot");defineSymbol(math,rel,"","\\risingdotseq",true);defineSymbol(math,rel,"","\\fallingdotseq",true);defineSymbol(math,rel,"","\\backsim",true);defineSymbol(math,rel,"","\\backsimeq",true);defineSymbol(math,rel,"","\\subseteqq",true);defineSymbol(math,rel,"","\\Subset",true);defineSymbol(math,rel,"","\\sqsubset",true);defineSymbol(math,rel,"","\\preccurlyeq",true);defineSymbol(math,rel,"","\\curlyeqprec",true);defineSymbol(math,rel,"","\\precsim",true);defineSymbol(math,rel,"","\\precapprox",true);defineSymbol(math,rel,"","\\vartriangleleft");defineSymbol(math,rel,"","\\trianglelefteq");defineSymbol(math,rel,"","\\vDash",true);defineSymbol(math,rel,"","\\VDash",true);defineSymbol(math,rel,"","\\Vvdash",true);defineSymbol(math,rel,"","\\smallsmile");defineSymbol(math,rel,"","\\smallfrown");defineSymbol(math,rel,"","\\bumpeq",true);defineSymbol(math,rel,"","\\Bumpeq",true);defineSymbol(math,rel,"","\\geqq",true);defineSymbol(math,rel,"","\\geqslant",true);defineSymbol(math,rel,"","\\eqslantgtr",true);defineSymbol(math,rel,"","\\gtrsim",true);defineSymbol(math,rel,"","\\gtrapprox",true);defineSymbol(math,bin,"","\\gtrdot");defineSymbol(math,rel,"","\\ggg",true);defineSymbol(math,rel,"","\\gtrless",true);defineSymbol(math,rel,"","\\gtreqless",true);defineSymbol(math,rel,"","\\gtreqqless",true);defineSymbol(math,rel,"","\\eqcirc",true);defineSymbol(math,rel,"","\\circeq",true);defineSymbol(math,rel,"","\\triangleq",true);defineSymbol(math,rel,"","\\thicksim");defineSymbol(math,rel,"","\\thickapprox");defineSymbol(math,rel,"","\\supseteqq",true);defineSymbol(math,rel,"","\\Supset",true);defineSymbol(math,rel,"","\\sqsupset",true);defineSymbol(math,rel,"","\\succcurlyeq",true);defineSymbol(math,rel,"","\\curlyeqsucc",true);defineSymbol(math,rel,"","\\succsim",true);defineSymbol(math,rel,"","\\succapprox",true);defineSymbol(math,rel,"","\\vartriangleright");defineSymbol(math,rel,"","\\trianglerighteq");defineSymbol(math,rel,"","\\Vdash",true);defineSymbol(math,rel,"","\\shortmid");defineSymbol(math,rel,"","\\shortparallel");defineSymbol(math,rel,"","\\between",true);defineSymbol(math,rel,"","\\pitchfork",true);defineSymbol(math,rel,"","\\varpropto");defineSymbol(math,rel,"","\\blacktriangleleft");defineSymbol(math,rel,"","\\therefore",true);defineSymbol(math,rel,"","\\backepsilon");defineSymbol(math,rel,"","\\blacktriangleright");defineSymbol(math,rel,"","\\because",true);defineSymbol(math,rel,"","\\llless");defineSymbol(math,rel,"","\\gggtr");defineSymbol(math,bin,"","\\lhd");defineSymbol(math,bin,"","\\rhd");defineSymbol(math,rel,"","\\eqsim",true);defineSymbol(math,rel,"","\\Doteq",true);defineSymbol(math,rel,"","\\strictif",true);defineSymbol(math,rel,"","\\strictfi",true);defineSymbol(math,bin,"","\\dotplus",true);defineSymbol(math,bin,"","\\smallsetminus");defineSymbol(math,bin,"","\\Cap",true);defineSymbol(math,bin,"","\\Cup",true);defineSymbol(math,bin,"","\\doublebarwedge",true);defineSymbol(math,bin,"","\\boxminus",true);defineSymbol(math,bin,"","\\boxplus",true);defineSymbol(math,bin,"","\\boxslash",true);defineSymbol(math,bin,"","\\divideontimes",true);defineSymbol(math,bin,"","\\ltimes",true);defineSymbol(math,bin,"","\\rtimes",true);defineSymbol(math,bin,"","\\leftthreetimes",true);defineSymbol(math,bin,"","\\rightthreetimes",true);defineSymbol(math,bin,"","\\curlywedge",true);defineSymbol(math,bin,"","\\curlyvee",true);defineSymbol(math,bin,"","\\circleddash",true);defineSymbol(math,bin,"","\\circledast",true);defineSymbol(math,bin,"","\\intercal",true);defineSymbol(math,bin,"","\\doublecap");defineSymbol(math,bin,"","\\doublecup");defineSymbol(math,bin,"","\\boxtimes",true);defineSymbol(math,bin,"","\\bowtie",true);defineSymbol(math,bin,"","\\Join");defineSymbol(math,bin,"","\\leftouterjoin",true);defineSymbol(math,bin,"","\\rightouterjoin",true);defineSymbol(math,bin,"","\\fullouterjoin",true);defineSymbol(math,bin,"","\\dotminus",true);defineSymbol(math,bin,"","\\wedgedot",true);defineSymbol(math,bin,"","\\veedot",true);defineSymbol(math,bin,"","\\doublebarvee",true);defineSymbol(math,bin,"","\\veedoublebar",true);defineSymbol(math,bin,"","\\wedgebar",true);defineSymbol(math,bin,"","\\wedgedoublebar",true);defineSymbol(math,bin,"","\\Vee",true);defineSymbol(math,bin,"","\\Wedge",true);defineSymbol(math,bin,"","\\barcap",true);defineSymbol(math,bin,"","\\barcup",true);defineSymbol(math,bin,"","\\capbarcup",true);defineSymbol(math,bin,"","\\capdot",true);defineSymbol(math,bin,"","\\capovercup",true);defineSymbol(math,bin,"","\\cupovercap",true);defineSymbol(math,bin,"","\\closedvarcap",true);defineSymbol(math,bin,"","\\closedvarcup",true);defineSymbol(math,bin,"","\\minusdot",true);defineSymbol(math,bin,"","\\minusfdots",true);defineSymbol(math,bin,"","\\minusrdots",true);defineSymbol(math,bin,"","\\Xor",true);defineSymbol(math,bin,"","\\Nand",true);defineSymbol(math,bin,"","\\Nor",true);defineSymbol(math,bin,"","\\barvee");defineSymbol(math,bin,"","\\interleave",true);defineSymbol(math,bin,"","\\shuffle",true);defineSymbol(math,bin,"","\\threedotcolon",true);defineSymbol(math,bin,"","\\typecolon",true);defineSymbol(math,bin,"","\\invlazys",true);defineSymbol(math,bin,"","\\twocaps",true);defineSymbol(math,bin,"","\\twocups",true);defineSymbol(math,bin,"","\\Sqcap",true);defineSymbol(math,bin,"","\\Sqcup",true);defineSymbol(math,bin,"","\\veeonvee",true);defineSymbol(math,bin,"","\\wedgeonwedge",true);defineSymbol(math,bin,"","\\blackhourglass",true);defineSymbol(math,bin,"","\\boxast",true);defineSymbol(math,bin,"","\\boxbox",true);defineSymbol(math,bin,"","\\boxcircle",true);defineSymbol(math,bin,"","\\circledequal",true);defineSymbol(math,bin,"","\\circledparallel",true);defineSymbol(math,bin,"","\\circledvert",true);defineSymbol(math,bin,"","\\circlehbar",true);defineSymbol(math,bin,"","\\concavediamond",true);defineSymbol(math,bin,"","\\concavediamondtickleft",true);defineSymbol(math,bin,"","\\concavediamondtickright",true);defineSymbol(math,bin,"","\\diamond",true);defineSymbol(math,bin,"","\\hourglass",true);defineSymbol(math,bin,"","\\lozengeminus",true);defineSymbol(math,bin,"","\\obar",true);defineSymbol(math,bin,"","\\obslash",true);defineSymbol(math,bin,"","\\odiv",true);defineSymbol(math,bin,"","\\ogreaterthan",true);defineSymbol(math,bin,"","\\olessthan",true);defineSymbol(math,bin,"","\\operp",true);defineSymbol(math,bin,"","\\Otimes",true);defineSymbol(math,bin,"","\\otimeshat",true);defineSymbol(math,bin,"","\\star",true);defineSymbol(math,bin,"","\\triangle",true);defineSymbol(math,bin,"","\\triangleminus",true);defineSymbol(math,bin,"","\\triangleplus",true);defineSymbol(math,bin,"","\\triangletimes",true);defineSymbol(math,bin,"","\\whitesquaretickleft",true);defineSymbol(math,bin,"","\\whitesquaretickright",true);defineSymbol(math,bin,"","\\smashtimes",true);defineSymbol(math,rel,"","\\dashrightarrow",true);defineSymbol(math,rel,"","\\dashleftarrow",true);defineSymbol(math,rel,"","\\leftleftarrows",true);defineSymbol(math,rel,"","\\leftrightarrows",true);defineSymbol(math,rel,"","\\Lleftarrow",true);defineSymbol(math,rel,"","\\twoheadleftarrow",true);defineSymbol(math,rel,"","\\leftarrowtail",true);defineSymbol(math,rel,"","\\looparrowleft",true);defineSymbol(math,rel,"","\\leftrightharpoons",true);defineSymbol(math,rel,"","\\curvearrowleft",true);defineSymbol(math,rel,"","\\circlearrowleft",true);defineSymbol(math,rel,"","\\Lsh",true);defineSymbol(math,rel,"","\\upuparrows",true);defineSymbol(math,rel,"","\\upharpoonleft",true);defineSymbol(math,rel,"","\\downharpoonleft",true);defineSymbol(math,rel,"","\\origof",true);defineSymbol(math,rel,"","\\imageof",true);defineSymbol(math,rel,"","\\multimap",true);defineSymbol(math,rel,"","\\leftrightsquigarrow",true);defineSymbol(math,rel,"","\\rightrightarrows",true);defineSymbol(math,rel,"","\\rightleftarrows",true);defineSymbol(math,rel,"","\\twoheadrightarrow",true);defineSymbol(math,rel,"","\\rightarrowtail",true);defineSymbol(math,rel,"","\\looparrowright",true);defineSymbol(math,rel,"","\\curvearrowright",true);defineSymbol(math,rel,"","\\circlearrowright",true);defineSymbol(math,rel,"","\\Rsh",true);defineSymbol(math,rel,"","\\downdownarrows",true);defineSymbol(math,rel,"","\\upharpoonright",true);defineSymbol(math,rel,"","\\downharpoonright",true);defineSymbol(math,rel,"","\\rightsquigarrow",true);defineSymbol(math,rel,"","\\leadsto");defineSymbol(math,rel,"","\\Rrightarrow",true);defineSymbol(math,rel,"","\\restriction");defineSymbol(math,textord,"","`");defineSymbol(math,textord,"$","\\$");defineSymbol(text,textord,"$","\\$");defineSymbol(text,textord,"$","\\textdollar");defineSymbol(math,textord,"","\\cent");defineSymbol(text,textord,"","\\cent");defineSymbol(math,textord,"%","\\%");defineSymbol(text,textord,"%","\\%");defineSymbol(math,textord,"_","\\_");defineSymbol(text,textord,"_","\\_");defineSymbol(text,textord,"_","\\textunderscore");defineSymbol(text,textord,"","\\textvisiblespace",true);defineSymbol(math,textord,"","\\angle",true);defineSymbol(math,textord,"","\\infty",true);defineSymbol(math,textord,"","\\prime");defineSymbol(math,textord,"","\\dprime");defineSymbol(math,textord,"","\\trprime");defineSymbol(math,textord,"","\\qprime");defineSymbol(math,textord,"","\\triangle");defineSymbol(text,textord,"","\\Alpha",true);defineSymbol(text,textord,"","\\Beta",true);defineSymbol(text,textord,"","\\Gamma",true);defineSymbol(text,textord,"","\\Delta",true);defineSymbol(text,textord,"","\\Epsilon",true);defineSymbol(text,textord,"","\\Zeta",true);defineSymbol(text,textord,"","\\Eta",true);defineSymbol(text,textord,"","\\Theta",true);defineSymbol(text,textord,"","\\Iota",true);defineSymbol(text,textord,"","\\Kappa",true);defineSymbol(text,textord,"","\\Lambda",true);defineSymbol(text,textord,"","\\Mu",true);defineSymbol(text,textord,"","\\Nu",true);defineSymbol(text,textord,"","\\Xi",true);defineSymbol(text,textord,"","\\Omicron",true);defineSymbol(text,textord,"","\\Pi",true);defineSymbol(text,textord,"","\\Rho",true);defineSymbol(text,textord,"","\\Sigma",true);defineSymbol(text,textord,"","\\Tau",true);defineSymbol(text,textord,"","\\Upsilon",true);defineSymbol(text,textord,"","\\Phi",true);defineSymbol(text,textord,"","\\Chi",true);defineSymbol(text,textord,"","\\Psi",true);defineSymbol(text,textord,"","\\Omega",true);defineSymbol(math,mathord,"","\\Alpha",true);defineSymbol(math,mathord,"","\\Beta",true);defineSymbol(math,mathord,"","\\Gamma",true);defineSymbol(math,mathord,"","\\Delta",true);defineSymbol(math,mathord,"","\\Epsilon",true);defineSymbol(math,mathord,"","\\Zeta",true);defineSymbol(math,mathord,"","\\Eta",true);defineSymbol(math,mathord,"","\\Theta",true);defineSymbol(math,mathord,"","\\Iota",true);defineSymbol(math,mathord,"","\\Kappa",true);defineSymbol(math,mathord,"","\\Lambda",true);defineSymbol(math,mathord,"","\\Mu",true);defineSymbol(math,mathord,"","\\Nu",true);defineSymbol(math,mathord,"","\\Xi",true);defineSymbol(math,mathord,"","\\Omicron",true);defineSymbol(math,mathord,"","\\Pi",true);defineSymbol(math,mathord,"","\\Rho",true);defineSymbol(math,mathord,"","\\Sigma",true);defineSymbol(math,mathord,"","\\Tau",true);defineSymbol(math,mathord,"","\\Upsilon",true);defineSymbol(math,mathord,"","\\Phi",true);defineSymbol(math,mathord,"","\\Chi",true);defineSymbol(math,mathord,"","\\Psi",true);defineSymbol(math,mathord,"","\\Omega",true);defineSymbol(math,open,"","\\neg",true);defineSymbol(math,open,"","\\lnot");defineSymbol(math,textord,"","\\top");defineSymbol(math,textord,"","\\bot");defineSymbol(math,textord,"","\\emptyset");defineSymbol(math,textord,"","\\varnothing");defineSymbol(math,mathord,"","\\alpha",true);defineSymbol(math,mathord,"","\\beta",true);defineSymbol(math,mathord,"","\\gamma",true);defineSymbol(math,mathord,"","\\delta",true);defineSymbol(math,mathord,"","\\epsilon",true);defineSymbol(math,mathord,"","\\zeta",true);defineSymbol(math,mathord,"","\\eta",true);defineSymbol(math,mathord,"","\\theta",true);defineSymbol(math,mathord,"","\\iota",true);defineSymbol(math,mathord,"","\\kappa",true);defineSymbol(math,mathord,"","\\lambda",true);defineSymbol(math,mathord,"","\\mu",true);defineSymbol(math,mathord,"","\\nu",true);defineSymbol(math,mathord,"","\\xi",true);defineSymbol(math,mathord,"","\\omicron",true);defineSymbol(math,mathord,"","\\pi",true);defineSymbol(math,mathord,"","\\rho",true);defineSymbol(math,mathord,"","\\sigma",true);defineSymbol(math,mathord,"","\\tau",true);defineSymbol(math,mathord,"","\\upsilon",true);defineSymbol(math,mathord,"","\\phi",true);defineSymbol(math,mathord,"","\\chi",true);defineSymbol(math,mathord,"","\\psi",true);defineSymbol(math,mathord,"","\\omega",true);defineSymbol(math,mathord,"","\\varepsilon",true);defineSymbol(math,mathord,"","\\vartheta",true);defineSymbol(math,mathord,"","\\varpi",true);defineSymbol(math,mathord,"","\\varrho",true);defineSymbol(math,mathord,"","\\varsigma",true);defineSymbol(math,mathord,"","\\varphi",true);defineSymbol(math,mathord,"","\\Coppa",true);defineSymbol(math,mathord,"","\\coppa",true);defineSymbol(math,mathord,"","\\varcoppa",true);defineSymbol(math,mathord,"","\\Koppa",true);defineSymbol(math,mathord,"","\\koppa",true);defineSymbol(math,mathord,"","\\Sampi",true);defineSymbol(math,mathord,"","\\sampi",true);defineSymbol(math,mathord,"","\\Stigma",true);defineSymbol(math,mathord,"","\\stigma",true);defineSymbol(math,mathord,"","\\Bot");defineSymbol(math,bin,"","",true);defineSymbol(math,bin,"+","+");defineSymbol(math,bin,"*","*");defineSymbol(math,bin,"","/",true);defineSymbol(math,bin,"","");defineSymbol(math,bin,"","-",true);defineSymbol(math,bin,"","\\cdot",true);defineSymbol(math,bin,"","\\circ",true);defineSymbol(math,bin,"","\\div",true);defineSymbol(math,bin,"","\\pm",true);defineSymbol(math,bin,"","\\times",true);defineSymbol(math,bin,"","\\cap",true);defineSymbol(math,bin,"","\\cup",true);defineSymbol(math,bin,"","\\setminus",true);defineSymbol(math,bin,"","\\land");defineSymbol(math,bin,"","\\lor");defineSymbol(math,bin,"","\\wedge",true);defineSymbol(math,bin,"","\\vee",true);defineSymbol(math,open,"","\\llbracket",true);defineSymbol(math,close,"","\\rrbracket",true);defineSymbol(math,open,"","\\langle",true);defineSymbol(math,open,"","\\lAngle",true);defineSymbol(math,open,"","\\llangle",true);defineSymbol(math,open,"|","\\lvert");defineSymbol(math,open,"","\\lVert");defineSymbol(math,textord,"!","\\oc");defineSymbol(math,textord,"?","\\wn");defineSymbol(math,textord,"","\\shpos");defineSymbol(math,textord,"","\\shift");defineSymbol(math,textord,"","\\shneg");defineSymbol(math,close,"?","?");defineSymbol(math,close,"!","!");defineSymbol(math,close,"","");defineSymbol(math,close,"","\\rangle",true);defineSymbol(math,close,"","\\rAngle",true);defineSymbol(math,close,"","\\rrangle",true);defineSymbol(math,close,"|","\\rvert");defineSymbol(math,close,"","\\rVert");defineSymbol(math,open,"","\\lBrace",true);defineSymbol(math,close,"","\\rBrace",true);defineSymbol(math,rel,"=","\\equal",true);defineSymbol(math,rel,":",":");defineSymbol(math,rel,"","\\approx",true);defineSymbol(math,rel,"","\\cong",true);defineSymbol(math,rel,"","\\ge");defineSymbol(math,rel,"","\\geq",true);defineSymbol(math,rel,"","\\gets");defineSymbol(math,rel,">","\\gt",true);defineSymbol(math,rel,"","\\in",true);defineSymbol(math,rel,"","\\notin",true);defineSymbol(math,rel,"","\\@not");defineSymbol(math,rel,"","\\subset",true);defineSymbol(math,rel,"","\\supset",true);defineSymbol(math,rel,"","\\subseteq",true);defineSymbol(math,rel,"","\\supseteq",true);defineSymbol(math,rel,"","\\nsubseteq",true);defineSymbol(math,rel,"","\\nsubseteqq");defineSymbol(math,rel,"","\\nsupseteq",true);defineSymbol(math,rel,"","\\nsupseteqq");defineSymbol(math,rel,"","\\models");defineSymbol(math,rel,"","\\leftarrow",true);defineSymbol(math,rel,"","\\le");defineSymbol(math,rel,"","\\leq",true);defineSymbol(math,rel,"<","\\lt",true);defineSymbol(math,rel,"","\\rightarrow",true);defineSymbol(math,rel,"","\\to");defineSymbol(math,rel,"","\\ngeq",true);defineSymbol(math,rel,"","\\ngeqq");defineSymbol(math,rel,"","\\ngeqslant");defineSymbol(math,rel,"","\\nleq",true);defineSymbol(math,rel,"","\\nleqq");defineSymbol(math,rel,"","\\nleqslant");defineSymbol(math,rel,"","\\Perp",true);defineSymbol(math,spacing,"","\\ ");defineSymbol(math,spacing,"","\\space");defineSymbol(math,spacing,"","\\nobreakspace");defineSymbol(text,spacing,"","\\ ");defineSymbol(text,spacing,""," ");defineSymbol(text,spacing,"","\\space");defineSymbol(text,spacing,"","\\nobreakspace");defineSymbol(math,spacing,null,"\\nobreak");defineSymbol(math,spacing,null,"\\allowbreak");defineSymbol(math,punct,",",",");defineSymbol(text,punct,":",":");defineSymbol(math,punct,";",";");defineSymbol(math,bin,"","\\barwedge");defineSymbol(math,bin,"","\\veebar");defineSymbol(math,bin,"","\\odot",true);defineSymbol(math,bin,"","\\oplus");defineSymbol(math,bin,"","\\otimes",true);defineSymbol(math,textord,"","\\partial",true);defineSymbol(math,bin,"","\\oslash",true);defineSymbol(math,bin,"","\\circledcirc",true);defineSymbol(math,bin,"","\\boxdot",true);defineSymbol(math,bin,"","\\bigtriangleup");defineSymbol(math,bin,"","\\bigtriangledown");defineSymbol(math,bin,"","\\dagger");defineSymbol(math,bin,"","\\diamond");defineSymbol(math,bin,"","\\triangleleft");defineSymbol(math,bin,"","\\triangleright");defineSymbol(math,open,"{","\\{");defineSymbol(text,textord,"{","\\{");defineSymbol(text,textord,"{","\\textbraceleft");defineSymbol(math,close,"}","\\}");defineSymbol(text,textord,"}","\\}");defineSymbol(text,textord,"}","\\textbraceright");defineSymbol(math,open,"{","\\lbrace");defineSymbol(math,close,"}","\\rbrace");defineSymbol(math,open,"[","\\lbrack",true);defineSymbol(text,textord,"[","\\lbrack",true);defineSymbol(math,close,"]","\\rbrack",true);defineSymbol(text,textord,"]","\\rbrack",true);defineSymbol(math,open,"(","\\lparen",true);defineSymbol(math,close,")","\\rparen",true);defineSymbol(math,open,"","\\llparenthesis",true);defineSymbol(math,close,"","\\rrparenthesis",true);defineSymbol(text,textord,"<","\\textless",true);defineSymbol(text,textord,">","\\textgreater",true);defineSymbol(math,open,"","\\lfloor",true);defineSymbol(math,close,"","\\rfloor",true);defineSymbol(math,open,"","\\lceil",true);defineSymbol(math,close,"","\\rceil",true);defineSymbol(math,textord,"\\","\\backslash");defineSymbol(math,textord,"|","|");defineSymbol(math,textord,"|","\\vert");defineSymbol(text,textord,"|","\\textbar",true);defineSymbol(math,textord,"","\\|");defineSymbol(math,textord,"","\\Vert");defineSymbol(text,textord,"","\\textbardbl");defineSymbol(text,textord,"~","\\textasciitilde");defineSymbol(text,textord,"\\","\\textbackslash");defineSymbol(text,textord,"^","\\textasciicircum");defineSymbol(math,rel,"","\\uparrow",true);defineSymbol(math,rel,"","\\Uparrow",true);defineSymbol(math,rel,"","\\downarrow",true);defineSymbol(math,rel,"","\\Downarrow",true);defineSymbol(math,rel,"","\\updownarrow",true);defineSymbol(math,rel,"","\\Updownarrow",true);defineSymbol(math,op,"","\\coprod");defineSymbol(math,op,"","\\bigvee");defineSymbol(math,op,"","\\bigwedge");defineSymbol(math,op,"","\\biguplus");defineSymbol(math,op,"","\\bigcupplus");defineSymbol(math,op,"","\\bigcupdot");defineSymbol(math,op,"","\\bigdoublevee");defineSymbol(math,op,"","\\bigdoublewedge");defineSymbol(math,op,"","\\bigcap");defineSymbol(math,op,"","\\bigcup");defineSymbol(math,op,"","\\int");defineSymbol(math,op,"","\\intop");defineSymbol(math,op,"","\\iint");defineSymbol(math,op,"","\\iiint");defineSymbol(math,op,"","\\prod");defineSymbol(math,op,"","\\sum");defineSymbol(math,op,"","\\bigotimes");defineSymbol(math,op,"","\\bigoplus");defineSymbol(math,op,"","\\bigodot");defineSymbol(math,op,"","\\bigtimes");defineSymbol(math,op,"","\\oint");defineSymbol(math,op,"","\\oiint");defineSymbol(math,op,"","\\oiiint");defineSymbol(math,op,"","\\intclockwise");defineSymbol(math,op,"","\\varointclockwise");defineSymbol(math,op,"","\\iiiint");defineSymbol(math,op,"","\\intbar");defineSymbol(math,op,"","\\intBar");defineSymbol(math,op,"","\\fint");defineSymbol(math,op,"","\\rppolint");defineSymbol(math,op,"","\\scpolint");defineSymbol(math,op,"","\\pointint");defineSymbol(math,op,"","\\sqint");defineSymbol(math,op,"","\\intlarhk");defineSymbol(math,op,"","\\intx");defineSymbol(math,op,"","\\intcap");defineSymbol(math,op,"","\\intcup");defineSymbol(math,op,"","\\bigsqcap");defineSymbol(math,op,"","\\bigsqcup");defineSymbol(math,op,"","\\smallint");defineSymbol(text,inner,"","\\textellipsis");defineSymbol(math,inner,"","\\mathellipsis");defineSymbol(text,inner,"","\\ldots",true);defineSymbol(math,inner,"","\\ldots",true);defineSymbol(math,inner,"","\\iddots",true);defineSymbol(math,inner,"","\\@cdots",true);defineSymbol(math,inner,"","\\ddots",true);defineSymbol(math,textord,"","\\varvdots");defineSymbol(text,textord,"","\\textvdots");defineSymbol(math,accent,"","\\acute");defineSymbol(math,accent,"`","\\grave");defineSymbol(math,accent,"","\\ddot");defineSymbol(math,accent,"","\\dddot");defineSymbol(math,accent,".","\\ddddot");defineSymbol(math,accent,"~","\\tilde");defineSymbol(math,accent,"","\\bar");defineSymbol(math,accent,"","\\breve");defineSymbol(math,accent,"","\\check");defineSymbol(math,accent,"^","\\hat");defineSymbol(math,accent,"","\\vec");defineSymbol(math,accent,"","\\dot");defineSymbol(math,accent,"","\\mathring");defineSymbol(math,mathord,"","\\imath",true);defineSymbol(math,mathord,"","\\jmath",true);defineSymbol(math,textord,"","");defineSymbol(math,textord,"","");defineSymbol(text,textord,"","\\i",true);defineSymbol(text,textord,"","\\j",true);defineSymbol(text,textord,"","\\ss",true);defineSymbol(text,textord,"","\\ae",true);defineSymbol(text,textord,"","\\oe",true);defineSymbol(text,textord,"","\\o",true);defineSymbol(math,mathord,"","\\o",true);defineSymbol(text,textord,"","\\AE",true);defineSymbol(text,textord,"","\\OE",true);defineSymbol(text,textord,"","\\O",true);defineSymbol(math,mathord,"","\\O",true);defineSymbol(text,accent,"","\\'");defineSymbol(text,accent,"","\\`");defineSymbol(text,accent,"","\\^");defineSymbol(text,accent,"","\\~");defineSymbol(text,accent,"","\\=");defineSymbol(text,accent,"","\\u");defineSymbol(text,accent,"","\\.");defineSymbol(text,accent,"","\\c");defineSymbol(text,accent,"","\\r");defineSymbol(text,accent,"","\\v");defineSymbol(text,accent,"",'\\"');defineSymbol(text,accent,"","\\H");defineSymbol(math,accent,"","\\'");defineSymbol(math,accent,"","\\`");defineSymbol(math,accent,"","\\^");defineSymbol(math,accent,"","\\~");defineSymbol(math,accent,"","\\=");defineSymbol(math,accent,"","\\u");defineSymbol(math,accent,"","\\.");defineSymbol(math,accent,"","\\c");defineSymbol(math,accent,"","\\r");defineSymbol(math,accent,"","\\v");defineSymbol(math,accent,"",'\\"');defineSymbol(math,accent,"","\\H");const ligatures={"--":true,"---":true,"``":true,"''":true};defineSymbol(text,textord,"","--",true);defineSymbol(text,textord,"","\\textendash");defineSymbol(text,textord,"","---",true);defineSymbol(text,textord,"","\\textemdash");defineSymbol(text,textord,"","`",true);defineSymbol(text,textord,"","\\textquoteleft");defineSymbol(text,textord,"","'",true);defineSymbol(text,textord,"","\\textquoteright");defineSymbol(text,textord,"","``",true);defineSymbol(text,textord,"","\\textquotedblleft");defineSymbol(text,textord,"","''",true);defineSymbol(text,textord,"","\\textquotedblright");defineSymbol(math,textord,"","\\degree",true);defineSymbol(text,textord,"","\\degree");defineSymbol(text,textord,"","\\textdegree",true);defineSymbol(math,textord,"","\\pounds");defineSymbol(math,textord,"","\\mathsterling",true);defineSymbol(text,textord,"","\\pounds");defineSymbol(text,textord,"","\\textsterling",true);defineSymbol(math,textord,"","\\maltese");defineSymbol(text,textord,"","\\maltese");defineSymbol(math,textord,"","\\euro",true);defineSymbol(text,textord,"","\\euro",true);defineSymbol(text,textord,"","\\texteuro");defineSymbol(math,textord,"","\\copyright",true);defineSymbol(text,textord,"","\\textcopyright");defineSymbol(math,textord,"","\\diameter",true);defineSymbol(text,textord,"","\\diameter");defineSymbol(math,textord,"","\\varGamma");defineSymbol(math,textord,"","\\varDelta");defineSymbol(math,textord,"","\\varTheta");defineSymbol(math,textord,"","\\varLambda");defineSymbol(math,textord,"","\\varXi");defineSymbol(math,textord,"","\\varPi");defineSymbol(math,textord,"","\\varSigma");defineSymbol(math,textord,"","\\varUpsilon");defineSymbol(math,textord,"","\\varPhi");defineSymbol(math,textord,"","\\varPsi");defineSymbol(math,textord,"","\\varOmega");defineSymbol(text,textord,"","\\varGamma");defineSymbol(text,textord,"","\\varDelta");defineSymbol(text,textord,"","\\varTheta");defineSymbol(text,textord,"","\\varLambda");defineSymbol(text,textord,"","\\varXi");defineSymbol(text,textord,"","\\varPi");defineSymbol(text,textord,"","\\varSigma");defineSymbol(text,textord,"","\\varUpsilon");defineSymbol(text,textord,"","\\varPhi");defineSymbol(text,textord,"","\\varPsi");defineSymbol(text,textord,"","\\varOmega");const mathTextSymbols='0123456789/@."';for(let e=0;e<mathTextSymbols.length;e++){const t=mathTextSymbols.charAt(e);defineSymbol(math,textord,t,t)}const textSymbols='0123456789!@*()-=+";:?/.,';for(let e=0;e<textSymbols.length;e++){const t=textSymbols.charAt(e);defineSymbol(text,textord,t,t)}const letters="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";for(let e=0;e<letters.length;e++){const t=letters.charAt(e);defineSymbol(math,mathord,t,t);defineSymbol(text,textord,t,t)}const narrow="";for(let e=0;e<narrow.length;e++){const t=narrow.charAt(e);defineSymbol(math,mathord,t,t);defineSymbol(text,textord,t,t)}let wideChar="";for(let e=0;e<letters.length;e++){wideChar=String.fromCharCode(55349,56320+e);defineSymbol(math,mathord,wideChar,wideChar);defineSymbol(text,textord,wideChar,wideChar);wideChar=String.fromCharCode(55349,56372+e);defineSymbol(math,mathord,wideChar,wideChar);defineSymbol(text,textord,wideChar,wideChar);wideChar=String.fromCharCode(55349,56424+e);defineSymbol(math,mathord,wideChar,wideChar);defineSymbol(text,textord,wideChar,wideChar);wideChar=String.fromCharCode(55349,56580+e);defineSymbol(math,mathord,wideChar,wideChar);defineSymbol(text,textord,wideChar,wideChar);wideChar=String.fromCharCode(55349,56736+e);defineSymbol(math,mathord,wideChar,wideChar);defineSymbol(text,textord,wideChar,wideChar);wideChar=String.fromCharCode(55349,56788+e);defineSymbol(math,mathord,wideChar,wideChar);defineSymbol(text,textord,wideChar,wideChar);wideChar=String.fromCharCode(55349,56840+e);defineSymbol(math,mathord,wideChar,wideChar);defineSymbol(text,textord,wideChar,wideChar);wideChar=String.fromCharCode(55349,56944+e);defineSymbol(math,mathord,wideChar,wideChar);defineSymbol(text,textord,wideChar,wideChar);wideChar=String.fromCharCode(55349,56632+e);defineSymbol(math,mathord,wideChar,wideChar);defineSymbol(text,textord,wideChar,wideChar);const t=letters.charAt(e);wideChar=String.fromCharCode(55349,56476+e);defineSymbol(math,mathord,t,wideChar);defineSymbol(text,textord,t,wideChar)}for(let e=0;e<10;e++){wideChar=String.fromCharCode(55349,57294+e);defineSymbol(math,mathord,wideChar,wideChar);defineSymbol(text,textord,wideChar,wideChar);wideChar=String.fromCharCode(55349,57314+e);defineSymbol(math,mathord,wideChar,wideChar);defineSymbol(text,textord,wideChar,wideChar);wideChar=String.fromCharCode(55349,57324+e);defineSymbol(math,mathord,wideChar,wideChar);defineSymbol(text,textord,wideChar,wideChar);wideChar=String.fromCharCode(55349,57334+e);defineSymbol(math,mathord,wideChar,wideChar);defineSymbol(text,textord,wideChar,wideChar)}const openDelims="([{";const closeDelims=")]}";function setLineBreaks(e,t,n){const r=[];let o=[];let i=[];let s=0;let a=0;let l=0;while(a<e.length){while(e[a]instanceof DocumentFragment){e.splice(a,1,...e[a].children)}const n=e[a];if(n.attributes&&n.attributes.linebreak&&n.attributes.linebreak==="newline"){if(i.length>0){o.push(new mathMLTree.MathNode("mrow",i))}o.push(n);i=[];const e=new mathMLTree.MathNode("mtd",o);e.style.textAlign="left";r.push(new mathMLTree.MathNode("mtr",[e]));o=[];a+=1;continue}i.push(n);if(n.type&&n.type==="mo"&&n.children.length===1&&!Object.hasOwn(n.attributes,"movablelimits")){const r=n.children[0].text;if(openDelims.indexOf(r)>-1){l+=1}else if(closeDelims.indexOf(r)>-1){l-=1}else if(l===0&&t==="="&&r==="="){s+=1;if(s>1){i.pop();const e=new mathMLTree.MathNode("mrow",i);o.push(e);i=[n]}}else if(l===0&&t==="tex"&&r!==""){const t=a<e.length-1?e[a+1]:null;let n=true;if(!(t&&t.type==="mtext"&&t.attributes.linebreak&&t.attributes.linebreak==="nobreak")){for(let t=a+1;t<e.length;t++){const r=e[t];if(r.type&&r.type==="mspace"&&!(r.attributes.linebreak&&r.attributes.linebreak==="newline")){i.push(r);a+=1;if(r.attributes&&r.attributes.linebreak&&r.attributes.linebreak==="nobreak"){n=false}}else{break}}}if(n){const e=new mathMLTree.MathNode("mrow",i);o.push(e);i=[]}}}a+=1}if(i.length>0){const e=new mathMLTree.MathNode("mrow",i);o.push(e)}if(r.length>0){const e=new mathMLTree.MathNode("mtd",o);e.style.textAlign="left";const t=new mathMLTree.MathNode("mtr",[e]);r.push(t);const i=new mathMLTree.MathNode("mtable",r);if(!n){i.setAttribute("columnalign","left");i.setAttribute("rowspacing","0em")}return i}return mathMLTree.newDocumentFragment(o)}const makeText=function(e,t,n){if(symbols[t][e]&&symbols[t][e].replace&&e.charCodeAt(0)!==55349&&!(Object.prototype.hasOwnProperty.call(ligatures,e)&&n&&(n.fontFamily&&n.fontFamily.slice(4,6)==="tt"||n.font&&n.font.slice(4,6)==="tt"))){e=symbols[t][e].replace}return new mathMLTree.TextNode(e)};const copyChar=(e,t)=>{if(e.children.length===0||e.children[e.children.length-1].type!=="mtext"){const n=new mathMLTree.MathNode("mtext",[new mathMLTree.TextNode(t.children[0].text)]);e.children.push(n)}else{e.children[e.children.length-1].children[0].text+=t.children[0].text}};const consolidateText=e=>{if(e.type!=="mrow"&&e.type!=="mstyle"){return e}if(e.children.length===0){return e}const t=new mathMLTree.MathNode("mrow");for(let n=0;n<e.children.length;n++){const r=e.children[n];if(r.type==="mtext"&&Object.keys(r.attributes).length===0){copyChar(t,r)}else if(r.type==="mrow"){let e=true;for(let t=0;t<r.children.length;t++){const n=r.children[t];if(n.type!=="mtext"||Object.keys(r.attributes).length!==0){e=false;break}}if(e){for(let e=0;e<r.children.length;e++){const n=r.children[e];copyChar(t,n)}}else{t.children.push(r)}}else{t.children.push(r)}}for(let n=0;n<t.children.length;n++){if(t.children[n].type==="mtext"){const r=t.children[n];if(r.children[0].text.charAt(0)===" "){r.children[0].text=""+r.children[0].text.slice(1)}const o=r.children[0].text.length;if(o>0&&r.children[0].text.charAt(o-1)===" "){r.children[0].text=r.children[0].text.slice(0,-1)+""}for(const[t,n]of Object.entries(e.attributes)){r.attributes[t]=n}}}if(t.children.length===1&&t.children[0].type==="mtext"){return t.children[0]}else{return t}};const numberRegEx$1=/^[0-9]$/;const isDotOrComma=(e,t)=>(e.type==="textord"&&e.text==="."||e.type==="atom"&&e.text===",")&&e.loc&&t.loc&&e.loc.end===t.loc.start;const consolidateNumbers=e=>{if(e.length<2){return}const t=[];let n=false;for(let r=0;r<e.length;r++){const o=e[r];if(o.type==="textord"&&numberRegEx$1.test(o.text)){if(!n){t.push({start:r})}n=true}else{if(n){t[t.length-1].end=r-1}n=false}}if(n){t[t.length-1].end=e.length-1}for(let n=t.length-1;n>0;n--){if(t[n-1].end===t[n].start-2&&isDotOrComma(e[t[n].start-1],e[t[n].start])){t[n-1].end=t[n].end;t.splice(n,1)}}for(let n=t.length-1;n>=0;n--){for(let r=t[n].start+1;r<=t[n].end;r++){e[t[n].start].text+=e[r].text}e.splice(t[n].start+1,t[n].end-t[n].start);if(e.length>t[n].start+1){const r=e[t[n].start+1];if(r.type==="supsub"&&r.base&&r.base.type==="textord"&&numberRegEx$1.test(r.base.text)){r.base.text=e[t[n].start].text+r.base.text;e.splice(t[n].start,1)}}}};const makeRow=function(e,t=false){if(e.length===1&&!(e[0]instanceof DocumentFragment)){return e[0]}else if(!t){if(e[0]instanceof MathNode&&e[0].type==="mo"&&!e[0].attributes.fence){e[0].attributes.lspace="0em";e[0].attributes.rspace="0em"}const t=e.length-1;if(e[t]instanceof MathNode&&e[t].type==="mo"&&!e[t].attributes.fence){e[t].attributes.lspace="0em";e[t].attributes.rspace="0em"}}return new mathMLTree.MathNode("mrow",e)};const isRel=e=>e.type==="atom"&&e.family==="rel"||e.type==="mclass"&&e.mclass==="mrel";const buildExpression=function(e,t,n=false){if(!n&&e.length===1){const n=buildGroup$1(e[0],t);if(n instanceof MathNode&&n.type==="mo"){n.setAttribute("lspace","0em");n.setAttribute("rspace","0em")}return[n]}consolidateNumbers(e);const r=[];for(let n=0;n<e.length;n++){const o=buildGroup$1(e[n],t);if(n<e.length-1&&isRel(e[n])&&isRel(e[n+1])){o.setAttribute("rspace","0em")}if(n>0&&isRel(e[n])&&isRel(e[n-1])){o.setAttribute("lspace","0em")}r.push(o)}return r};const buildExpressionRow=function(e,t,n=false){return makeRow(buildExpression(e,t,n),n)};const buildGroup$1=function(e,t){if(!e){return new mathMLTree.MathNode("mrow")}if(_mathmlGroupBuilders[e.type]){const n=_mathmlGroupBuilders[e.type](e,t);return n}else{throw new ParseError("Got group of unknown type: '"+e.type+"'")}};const glue$1=e=>new mathMLTree.MathNode("mtd",[],[],{padding:"0",width:"50%"});const taggedExpression=(e,t,n,r)=>{t=buildExpressionRow(t[0].body,n);t=consolidateText(t);t.classes.push("tml-tag");e=new mathMLTree.MathNode("mtd",[e]);const o=[glue$1(),e,glue$1()];o[r?0:2].classes.push(r?"tml-left":"tml-right");o[r?0:2].children.push(t);const i=new mathMLTree.MathNode("mtr",o,["tml-tageqn"]);const s=new mathMLTree.MathNode("mtable",[i]);s.style.width="100%";s.setAttribute("displaystyle","true");return s};function buildMathML(e,t,n,r){let o=null;if(e.length===1&&e[0].type==="tag"){o=e[0].tag;e=e[0].body}const i=buildExpression(e,n);const s=r.displayMode||r.annotate?"none":r.wrap;const a=i.length===0?null:i[0];let l=i.length===1&&o===null&&a instanceof MathNode?i[0]:setLineBreaks(i,s,r.displayMode);if(o){l=taggedExpression(l,o,n,r.leqno)}if(r.annotate){const e=new mathMLTree.MathNode("annotation",[new mathMLTree.TextNode(t)]);e.setAttribute("encoding","application/x-tex");l=new mathMLTree.MathNode("semantics",[l,e])}const c=new mathMLTree.MathNode("math",[l]);if(r.xml){c.setAttribute("xmlns","http://www.w3.org/1998/Math/MathML")}if(r.displayMode){c.setAttribute("display","block");c.style.display="block math";c.classes=["tml-display"]}return c}const smalls="acegmnopqrsuvwxyz";const talls="ABCDEFGHIJKLMNOPQRSTUVWXYZbdfhklt"+"";const longSmalls=new Set(["\\alpha","\\gamma","\\delta","\\epsilon","\\eta","\\iota","\\kappa","\\mu","\\nu","\\pi","\\rho","\\sigma","\\tau","\\upsilon","\\chi","\\psi","\\omega","\\imath","\\jmath"]);const longTalls=new Set(["\\Gamma","\\Delta","\\Sigma","\\Omega","\\beta","\\delta","\\lambda","\\theta","\\psi"]);const mathmlBuilder$a=(e,t)=>{const n=e.isStretchy?stretchy.accentNode(e):new mathMLTree.MathNode("mo",[makeText(e.label,e.mode)]);if(e.label==="\\vec"){n.style.transform="scale(0.75) translate(10%, 30%)"}else{n.style.mathStyle="normal";n.style.mathDepth="0";if(needWebkitShift.has(e.label)&&utils.isCharacterBox(e.base)){let t="";const r=e.base.text;if(smalls.indexOf(r)>-1||longSmalls.has(r)){t="tml-xshift"}if(talls.indexOf(r)>-1||longTalls.has(r)){t="tml-capshift"}if(t){n.classes.push(t)}}}if(!e.isStretchy){n.setAttribute("stretchy","false")}const r=new mathMLTree.MathNode(e.label==="\\c"?"munder":"mover",[buildGroup$1(e.base,t),n]);return r};const nonStretchyAccents=new Set(["\\acute","\\grave","\\ddot","\\dddot","\\ddddot","\\tilde","\\bar","\\breve","\\check","\\hat","\\vec","\\dot","\\mathring"]);const needWebkitShift=new Set(["\\acute","\\bar","\\breve","\\check","\\dot","\\ddot","\\grave","\\hat","\\mathring","\\'","\\^","\\~","\\=","\\u","\\.",'\\"',"\\r","\\H","\\v"]);const combiningChar={"\\`":"","\\'":"","\\^":"","\\~":"","\\=":"","\\u":"","\\.":"",'\\"':"","\\r":"","\\H":"","\\v":""};defineFunction({type:"accent",names:["\\acute","\\grave","\\ddot","\\dddot","\\ddddot","\\tilde","\\bar","\\breve","\\check","\\hat","\\vec","\\dot","\\mathring","\\overparen","\\widecheck","\\widehat","\\wideparen","\\widetilde","\\overrightarrow","\\overleftarrow","\\Overrightarrow","\\overleftrightarrow","\\overgroup","\\overleftharpoon","\\overrightharpoon"],props:{numArgs:1},handler:(e,t)=>{const n=normalizeArgument(t[0]);const r=!nonStretchyAccents.has(e.funcName);return{type:"accent",mode:e.parser.mode,label:e.funcName,isStretchy:r,base:n}},mathmlBuilder:mathmlBuilder$a});defineFunction({type:"accent",names:["\\'","\\`","\\^","\\~","\\=","\\c","\\u","\\.",'\\"',"\\r","\\H","\\v"],props:{numArgs:1,allowedInText:true,allowedInMath:true,argTypes:["primitive"]},handler:(e,t)=>{const n=normalizeArgument(t[0]);const r=e.parser.mode;if(r==="math"&&e.parser.settings.strict){console.log(`Temml parse error: Command ${e.funcName} is invalid in math mode.`)}if(r==="text"&&n.text&&n.text.length===1&&e.funcName in combiningChar&&smalls.indexOf(n.text)>-1){return{type:"textord",mode:"text",text:n.text+combiningChar[e.funcName]}}else{return{type:"accent",mode:r,label:e.funcName,isStretchy:false,base:n}}},mathmlBuilder:mathmlBuilder$a});defineFunction({type:"accentUnder",names:["\\underleftarrow","\\underrightarrow","\\underleftrightarrow","\\undergroup","\\underparen","\\utilde"],props:{numArgs:1},handler:({parser:e,funcName:t},n)=>{const r=n[0];return{type:"accentUnder",mode:e.mode,label:t,base:r}},mathmlBuilder:(e,t)=>{const n=stretchy.accentNode(e);n.style["math-depth"]=0;const r=new mathMLTree.MathNode("munder",[buildGroup$1(e.base,t),n]);return r}});const ptPerUnit={pt:800/803,pc:12*800/803,dd:1238/1157*800/803,cc:14856/1157*800/803,nd:685/642*800/803,nc:1370/107*800/803,sp:1/65536*800/803,mm:25.4/72,cm:2.54/72,in:1/72,px:96/72};const validUnits=["em","ex","mu","pt","mm","cm","in","px","bp","pc","dd","cc","nd","nc","sp"];const validUnit=function(e){if(typeof e!=="string"){e=e.unit}return validUnits.indexOf(e)>-1};const emScale=e=>{const t=Math.max(e-1,0);return[1,.7,.5][t]};const calculateSize=function(e,t){let n=e.number;if(t.maxSize[0]<0&&n>0){return{number:0,unit:"em"}}const r=e.unit;switch(r){case"mm":case"cm":case"in":case"px":{const e=n*ptPerUnit[r];if(e>t.maxSize[1]){return{number:t.maxSize[1],unit:"pt"}}return{number:n,unit:r}}case"em":case"ex":{if(r==="ex"){n*=.431}n=Math.min(n/emScale(t.level),t.maxSize[0]);return{number:utils.round(n),unit:"em"}}case"bp":{if(n>t.maxSize[1]){n=t.maxSize[1]}return{number:n,unit:"pt"}}case"pt":case"pc":case"dd":case"cc":case"nd":case"nc":case"sp":{n=Math.min(n*ptPerUnit[r],t.maxSize[1]);return{number:utils.round(n),unit:"pt"}}case"mu":{n=Math.min(n/18,t.maxSize[0]);return{number:utils.round(n),unit:"em"}}default:throw new ParseError("Invalid unit: '"+r+"'")}};const padding$2=e=>{const t=new mathMLTree.MathNode("mspace");t.setAttribute("width",e+"em");return t};const paddedNode=(e,t=.3,n=0)=>{if(e==null&&n===0){return padding$2(t)}const r=e?[e]:[];if(t!==0){r.unshift(padding$2(t))}if(n>0){r.push(padding$2(n))}return new mathMLTree.MathNode("mrow",r)};const labelSize=(e,t)=>Number(e)/emScale(t);const munderoverNode=(e,t,n,r)=>{const o=stretchy.mathMLnode(e);const i=e.slice(1,3)==="eq";const s=e.charAt(1)==="x"?"1.75":e.slice(2,4)==="cd"?"3.0":i?"1.0":"2.0";o.setAttribute("lspace","0");o.setAttribute("rspace",i?"0.5em":"0");const a=r.withLevel(r.level<2?2:3);const l=labelSize(s,a.level);const c=labelSize(s,3);const d=paddedNode(null,l.toFixed(4),0);const u=paddedNode(null,c.toFixed(4),0);const p=labelSize(i?0:.3,a.level).toFixed(4);let f;let h;const m=t&&t.body&&(t.body.body||t.body.length>0);if(m){let e=buildGroup$1(t,a);e=paddedNode(e,p,p);f=new mathMLTree.MathNode("mover",[e,u])}const g=n&&n.body&&(n.body.body||n.body.length>0);if(g){let e=buildGroup$1(n,a);e=paddedNode(e,p,p);h=new mathMLTree.MathNode("munder",[e,u])}let y;if(!m&&!g){y=new mathMLTree.MathNode("mover",[o,d])}else if(m&&g){y=new mathMLTree.MathNode("munderover",[o,h,f])}else if(m){y=new mathMLTree.MathNode("mover",[o,f])}else{y=new mathMLTree.MathNode("munder",[o,h])}if(s==="3.0"){y.style.height="1em"}y.setAttribute("accent","false");return y};defineFunction({type:"xArrow",names:["\\xleftarrow","\\xrightarrow","\\xLeftarrow","\\xRightarrow","\\xleftrightarrow","\\xLeftrightarrow","\\xhookleftarrow","\\xhookrightarrow","\\xmapsto","\\xrightharpoondown","\\xrightharpoonup","\\xleftharpoondown","\\xleftharpoonup","\\xlongequal","\\xtwoheadrightarrow","\\xtwoheadleftarrow","\\yields","\\yieldsLeft","\\mesomerism","\\longrightharpoonup","\\longleftharpoondown","\\\\cdrightarrow","\\\\cdleftarrow","\\\\cdlongequal"],props:{numArgs:1,numOptionalArgs:1},handler({parser:e,funcName:t},n,r){return{type:"xArrow",mode:e.mode,name:t,body:n[0],below:r[0]}},mathmlBuilder(e,t){const n=munderoverNode(e.name,e.body,e.below,t);const r=[n];r.unshift(padding$2(.2778));r.push(padding$2(.2778));return new mathMLTree.MathNode("mrow",r)}});const arrowComponent={"\\xtofrom":["\\xrightarrow","\\xleftarrow"],"\\xleftrightharpoons":["\\xleftharpoonup","\\xrightharpoondown"],"\\xrightleftharpoons":["\\xrightharpoonup","\\xleftharpoondown"],"\\yieldsLeftRight":["\\yields","\\yieldsLeft"],"\\equilibrium":["\\longrightharpoonup","\\longleftharpoondown"],"\\equilibriumRight":["\\longrightharpoonup","\\eqleftharpoondown"],"\\equilibriumLeft":["\\eqrightharpoonup","\\longleftharpoondown"]};defineFunction({type:"stackedArrow",names:["\\xtofrom","\\xleftrightharpoons","\\xrightleftharpoons","\\yieldsLeftRight","\\equilibrium","\\equilibriumRight","\\equilibriumLeft"],props:{numArgs:1,numOptionalArgs:1},handler({parser:e,funcName:t},n,r){const o=n[0]?{type:"hphantom",mode:e.mode,body:n[0]}:null;const i=r[0]?{type:"hphantom",mode:e.mode,body:r[0]}:null;return{type:"stackedArrow",mode:e.mode,name:t,body:n[0],upperArrowBelow:i,lowerArrowBody:o,below:r[0]}},mathmlBuilder(e,t){const n=arrowComponent[e.name][0];const r=arrowComponent[e.name][1];const o=munderoverNode(n,e.body,e.upperArrowBelow,t);const i=munderoverNode(r,e.lowerArrowBody,e.below,t);let s;const a=new mathMLTree.MathNode("mpadded",[o]);a.setAttribute("voffset","0.3em");a.setAttribute("height","+0.3em");a.setAttribute("depth","-0.3em");if(e.name==="\\equilibriumLeft"){const e=new mathMLTree.MathNode("mpadded",[i]);e.setAttribute("width","0.5em");s=new mathMLTree.MathNode("mpadded",[padding$2(.2778),e,a,padding$2(.2778)])}else{a.setAttribute("width",e.name==="\\equilibriumRight"?"0.5em":"0");s=new mathMLTree.MathNode("mpadded",[padding$2(.2778),a,i,padding$2(.2778)])}s.setAttribute("voffset","-0.18em");s.setAttribute("height","-0.18em");s.setAttribute("depth","+0.18em");return s}});function assertNodeType(e,t){if(!e||e.type!==t){throw new Error(`Expected node of type ${t}, but got `+(e?`node of type ${e.type}`:String(e)))}return e}function assertSymbolNodeType(e){const t=checkSymbolNodeType(e);if(!t){throw new Error(`Expected node of symbol group type, but got `+(e?`node of type ${e.type}`:String(e)))}return t}function checkSymbolNodeType(e){if(e&&(e.type==="atom"||Object.prototype.hasOwnProperty.call(NON_ATOMS,e.type))){return e}return null}const cdArrowFunctionName={">":"\\\\cdrightarrow","<":"\\\\cdleftarrow","=":"\\\\cdlongequal",A:"\\uparrow",V:"\\downarrow","|":"\\Vert",".":"no arrow"};const newCell=()=>({type:"styling",body:[],mode:"math",scriptLevel:"display"});const isStartOfArrow=e=>e.type==="textord"&&e.text==="@";const isLabelEnd=(e,t)=>(e.type==="mathord"||e.type==="atom")&&e.text===t;function cdArrow(e,t,n){const r=cdArrowFunctionName[e];switch(r){case"\\\\cdrightarrow":case"\\\\cdleftarrow":return n.callFunction(r,[t[0]],[t[1]]);case"\\uparrow":case"\\downarrow":{const e=n.callFunction("\\\\cdleft",[t[0]],[]);const o={type:"atom",text:r,mode:"math",family:"rel"};const i=n.callFunction("\\Big",[o],[]);const s=n.callFunction("\\\\cdright",[t[1]],[]);const a={type:"ordgroup",mode:"math",body:[e,i,s],semisimple:true};return n.callFunction("\\\\cdparent",[a],[])}case"\\\\cdlongequal":return n.callFunction("\\\\cdlongequal",[],[]);case"\\Vert":{const e={type:"textord",text:"\\Vert",mode:"math"};return n.callFunction("\\Big",[e],[])}default:return{type:"textord",text:" ",mode:"math"}}}function parseCD(e){const t=[];e.gullet.beginGroup();e.gullet.macros.set("\\cr","\\\\\\relax");e.gullet.beginGroup();while(true){t.push(e.parseExpression(false,"\\\\"));e.gullet.endGroup();e.gullet.beginGroup();const n=e.fetch().text;if(n==="&"||n==="\\\\"){e.consume()}else if(n==="\\end"){if(t[t.length-1].length===0){t.pop()}break}else{throw new ParseError("Expected \\\\ or \\cr or \\end",e.nextToken)}}let n=[];const r=[n];for(let o=0;o<t.length;o++){const i=t[o];let s=newCell();for(let t=0;t<i.length;t++){if(!isStartOfArrow(i[t])){s.body.push(i[t])}else{n.push(s);t+=1;const r=assertSymbolNodeType(i[t]).text;const o=new Array(2);o[0]={type:"ordgroup",mode:"math",body:[]};o[1]={type:"ordgroup",mode:"math",body:[]};if("=|.".indexOf(r)>-1);else if("<>AV".indexOf(r)>-1){for(let e=0;e<2;e++){let n=true;for(let s=t+1;s<i.length;s++){if(isLabelEnd(i[s],r)){n=false;t=s;break}if(isStartOfArrow(i[s])){throw new ParseError("Missing a "+r+" character to complete a CD arrow.",i[s])}o[e].body.push(i[s])}if(n){throw new ParseError("Missing a "+r+" character to complete a CD arrow.",i[t])}}}else{throw new ParseError(`Expected one of "<>AV=|." after @.`)}const a=cdArrow(r,o,e);n.push(a);s=newCell()}}if(o%2===0){n.push(s)}else{n.shift()}n=[];r.push(n)}r.pop();e.gullet.endGroup();e.gullet.endGroup();return{type:"array",mode:"math",body:r,envClasses:["jot","cd"],cols:[],hLinesBeforeRow:new Array(r.length+1).fill([])}}defineFunction({type:"cdlabel",names:["\\\\cdleft","\\\\cdright"],props:{numArgs:1},handler({parser:e,funcName:t},n){return{type:"cdlabel",mode:e.mode,side:t.slice(4),label:n[0]}},mathmlBuilder(e,t){let n=new mathMLTree.MathNode("mrow",[buildGroup$1(e.label,t)]);n=new mathMLTree.MathNode("mpadded",[n]);n.setAttribute("width","0");if(e.side==="left"){n.setAttribute("lspace","-1width")}n.setAttribute("voffset","0.7em");n=new mathMLTree.MathNode("mstyle",[n]);n.setAttribute("displaystyle","false");n.setAttribute("scriptlevel","1");return n}});defineFunction({type:"cdlabelparent",names:["\\\\cdparent"],props:{numArgs:1},handler({parser:e},t){return{type:"cdlabelparent",mode:e.mode,fragment:t[0]}},mathmlBuilder(e,t){return new mathMLTree.MathNode("mrow",[buildGroup$1(e.fragment,t)])}});defineFunction({type:"textord",names:["\\@char"],props:{numArgs:1,allowedInText:true},handler({parser:e,token:t},n){const r=assertNodeType(n[0],"ordgroup");const o=r.body;let i="";for(let e=0;e<o.length;e++){const t=assertNodeType(o[e],"textord");i+=t.text}const s=parseInt(i);if(isNaN(s)){throw new ParseError(`\\@char has non-numeric argument ${i}`,t)}return{type:"textord",mode:e.mode,text:String.fromCodePoint(s)}}});const htmlRegEx=/^(#[a-f0-9]{3}|#?[a-f0-9]{6})$/i;const htmlOrNameRegEx=/^(#[a-f0-9]{3}|#?[a-f0-9]{6}|[a-z]+)$/i;const RGBregEx=/^ *\d{1,3} *(?:, *\d{1,3} *){2}$/;const rgbRegEx=/^ *[10](?:\.\d*)? *(?:, *[10](?:\.\d*)? *){2}$/;const xcolorHtmlRegEx=/^[a-f0-9]{6}$/i;const toHex=e=>{let t=e.toString(16);if(t.length===1){t="0"+t}return t};const xcolors=JSON.parse(`{\n  "Apricot": "#ffb484",\n  "Aquamarine": "#08b4bc",\n  "Bittersweet": "#c84c14",\n  "blue": "#0000FF",\n  "Blue": "#303494",\n  "BlueGreen": "#08b4bc",\n  "BlueViolet": "#503c94",\n  "BrickRed": "#b8341c",\n  "brown": "#BF8040",\n  "Brown": "#802404",\n  "BurntOrange": "#f8941c",\n  "CadetBlue": "#78749c",\n  "CarnationPink": "#f884b4",\n  "Cerulean": "#08a4e4",\n  "CornflowerBlue": "#40ace4",\n  "cyan": "#00FFFF",\n  "Cyan": "#08acec",\n  "Dandelion": "#ffbc44",\n  "darkgray": "#404040",\n  "DarkOrchid": "#a8548c",\n  "Emerald": "#08ac9c",\n  "ForestGreen": "#089c54",\n  "Fuchsia": "#90348c",\n  "Goldenrod": "#ffdc44",\n  "gray": "#808080",\n  "Gray": "#98949c",\n  "green": "#00FF00",\n  "Green": "#08a44c",\n  "GreenYellow": "#e0e474",\n  "JungleGreen": "#08ac9c",\n  "Lavender": "#f89cc4",\n  "lightgray": "#c0c0c0",\n  "lime": "#BFFF00",\n  "LimeGreen": "#90c43c",\n  "magenta": "#FF00FF",\n  "Magenta": "#f0048c",\n  "Mahogany": "#b0341c",\n  "Maroon": "#b03434",\n  "Melon": "#f89c7c",\n  "MidnightBlue": "#086494",\n  "Mulberry": "#b03c94",\n  "NavyBlue": "#086cbc",\n  "olive": "#7F7F00",\n  "OliveGreen": "#407c34",\n  "orange": "#FF8000",\n  "Orange": "#f8843c",\n  "OrangeRed": "#f0145c",\n  "Orchid": "#b074ac",\n  "Peach": "#f8945c",\n  "Periwinkle": "#8074bc",\n  "PineGreen": "#088c74",\n  "pink": "#ff7f7f",\n  "Plum": "#98248c",\n  "ProcessBlue": "#08b4ec",\n  "purple": "#BF0040",\n  "Purple": "#a0449c",\n  "RawSienna": "#983c04",\n  "red": "#ff0000",\n  "Red": "#f01c24",\n  "RedOrange": "#f86434",\n  "RedViolet": "#a0246c",\n  "Rhodamine": "#f0549c",\n  "Royallue": "#0874bc",\n  "RoyalPurple": "#683c9c",\n  "RubineRed": "#f0047c",\n  "Salmon": "#f8948c",\n  "SeaGreen": "#30bc9c",\n  "Sepia": "#701404",\n  "SkyBlue": "#48c4dc",\n  "SpringGreen": "#c8dc64",\n  "Tan": "#e09c74",\n  "teal": "#007F7F",\n  "TealBlue": "#08acb4",\n  "Thistle": "#d884b4",\n  "Turquoise": "#08b4cc",\n  "violet": "#800080",\n  "Violet": "#60449c",\n  "VioletRed": "#f054a4",\n  "WildStrawberry": "#f0246c",\n  "yellow": "#FFFF00",\n  "Yellow": "#fff404",\n  "YellowGreen": "#98cc6c",\n  "YellowOrange": "#ffa41c"\n}`);const colorFromSpec=(e,t)=>{let n="";if(e==="HTML"){if(!htmlRegEx.test(t)){throw new ParseError("Invalid HTML input.")}n=t}else if(e==="RGB"){if(!RGBregEx.test(t)){throw new ParseError("Invalid RGB input.")}t.split(",").map((e=>{n+=toHex(Number(e.trim()))}))}else{if(!rgbRegEx.test(t)){throw new ParseError("Invalid rbg input.")}t.split(",").map((e=>{const t=Number(e.trim());if(t>1){throw new ParseError("Color rgb input must be < 1.")}n+=toHex(Number((t*255).toFixed(0)))}))}if(n.charAt(0)!=="#"){n="#"+n}return n};const validateColor=(e,t,n)=>{const r=`\\\\color@${e}`;const o=htmlOrNameRegEx.exec(e);if(!o){throw new ParseError("Invalid color: '"+e+"'",n)}if(xcolorHtmlRegEx.test(e)){return"#"+e}else if(e.charAt(0)==="#"){return e}else if(t.has(r)){e=t.get(r).tokens[0].text}else if(xcolors[e]){e=xcolors[e]}return e};const mathmlBuilder$9=(e,t)=>{let n=buildExpression(e.body,t.withColor(e.color));n=n.map((t=>{t.style.color=e.color;return t}));return mathMLTree.newDocumentFragment(n)};defineFunction({type:"color",names:["\\textcolor"],props:{numArgs:2,numOptionalArgs:1,allowedInText:true,argTypes:["raw","raw","original"]},handler({parser:e,token:t},n,r){const o=r[0]&&assertNodeType(r[0],"raw").string;let i="";if(o){const e=assertNodeType(n[0],"raw").string;i=colorFromSpec(o,e)}else{i=validateColor(assertNodeType(n[0],"raw").string,e.gullet.macros,t)}const s=n[1];return{type:"color",mode:e.mode,color:i,isTextColor:true,body:ordargument(s)}},mathmlBuilder:mathmlBuilder$9});defineFunction({type:"color",names:["\\color"],props:{numArgs:1,numOptionalArgs:1,allowedInText:true,argTypes:["raw","raw"]},handler({parser:e,breakOnTokenText:t,token:n},r,o){const i=o[0]&&assertNodeType(o[0],"raw").string;let s="";if(i){const e=assertNodeType(r[0],"raw").string;s=colorFromSpec(i,e)}else{s=validateColor(assertNodeType(r[0],"raw").string,e.gullet.macros,n)}const a=e.parseExpression(true,t,true);return{type:"color",mode:e.mode,color:s,isTextColor:false,body:a}},mathmlBuilder:mathmlBuilder$9});defineFunction({type:"color",names:["\\definecolor"],props:{numArgs:3,allowedInText:true,argTypes:["raw","raw","raw"]},handler({parser:e,funcName:t,token:n},r){const o=assertNodeType(r[0],"raw").string;if(!/^[A-Za-z]+$/.test(o)){throw new ParseError("Color name must be latin letters.",n)}const i=assertNodeType(r[1],"raw").string;if(!["HTML","RGB","rgb"].includes(i)){throw new ParseError("Color model must be HTML, RGB, or rgb.",n)}const s=assertNodeType(r[2],"raw").string;const a=colorFromSpec(i,s);e.gullet.macros.set(`\\\\color@${o}`,{tokens:[{text:a}],numArgs:0});return{type:"internal",mode:e.mode}}});defineFunction({type:"cr",names:["\\\\"],props:{numArgs:0,numOptionalArgs:0,allowedInText:true},handler({parser:e},t,n){const r=e.gullet.future().text==="["?e.parseSizeGroup(true):null;const o=!e.settings.displayMode;return{type:"cr",mode:e.mode,newLine:o,size:r&&assertNodeType(r,"size").value}},mathmlBuilder(e,t){const n=new mathMLTree.MathNode("mo");if(e.newLine){n.setAttribute("linebreak","newline");if(e.size){const r=calculateSize(e.size,t);n.setAttribute("height",r.number+r.unit)}}return n}});const globalMap={"\\global":"\\global","\\long":"\\\\globallong","\\\\globallong":"\\\\globallong","\\def":"\\gdef","\\gdef":"\\gdef","\\edef":"\\xdef","\\xdef":"\\xdef","\\let":"\\\\globallet","\\futurelet":"\\\\globalfuture"};const checkControlSequence=e=>{const t=e.text;if(/^(?:[\\{}$&#^_]|EOF)$/.test(t)){throw new ParseError("Expected a control sequence",e)}return t};const getRHS=e=>{let t=e.gullet.popToken();if(t.text==="="){t=e.gullet.popToken();if(t.text===" "){t=e.gullet.popToken()}}return t};const letCommand=(e,t,n,r)=>{let o=e.gullet.macros.get(n.text);if(o==null){n.noexpand=true;o={tokens:[n],numArgs:0,unexpandable:!e.gullet.isExpandable(n.text)}}e.gullet.macros.set(t,o,r)};defineFunction({type:"internal",names:["\\global","\\long","\\\\globallong"],props:{numArgs:0,allowedInText:true},handler({parser:e,funcName:t}){e.consumeSpaces();const n=e.fetch();if(globalMap[n.text]){if(t==="\\global"||t==="\\\\globallong"){n.text=globalMap[n.text]}return assertNodeType(e.parseFunction(),"internal")}throw new ParseError(`Invalid token after macro prefix`,n)}});defineFunction({type:"internal",names:["\\def","\\gdef","\\edef","\\xdef"],props:{numArgs:0,allowedInText:true,primitive:true},handler({parser:e,funcName:t}){let n=e.gullet.popToken();const r=n.text;if(/^(?:[\\{}$&#^_]|EOF)$/.test(r)){throw new ParseError("Expected a control sequence",n)}let o=0;let i;const s=[[]];while(e.gullet.future().text!=="{"){n=e.gullet.popToken();if(n.text==="#"){if(e.gullet.future().text==="{"){i=e.gullet.future();s[o].push("{");break}n=e.gullet.popToken();if(!/^[1-9]$/.test(n.text)){throw new ParseError(`Invalid argument number "${n.text}"`)}if(parseInt(n.text)!==o+1){throw new ParseError(`Argument number "${n.text}" out of order`)}o++;s.push([])}else if(n.text==="EOF"){throw new ParseError("Expected a macro definition")}else{s[o].push(n.text)}}let{tokens:a}=e.gullet.consumeArg();if(i){a.unshift(i)}if(t==="\\edef"||t==="\\xdef"){a=e.gullet.expandTokens(a);if(a.length>e.gullet.settings.maxExpand){throw new ParseError("Too many expansions in an "+t)}a.reverse()}e.gullet.macros.set(r,{tokens:a,numArgs:o,delimiters:s},t===globalMap[t]);return{type:"internal",mode:e.mode}}});defineFunction({type:"internal",names:["\\let","\\\\globallet"],props:{numArgs:0,allowedInText:true,primitive:true},handler({parser:e,funcName:t}){const n=checkControlSequence(e.gullet.popToken());e.gullet.consumeSpaces();const r=getRHS(e);letCommand(e,n,r,t==="\\\\globallet");return{type:"internal",mode:e.mode}}});defineFunction({type:"internal",names:["\\futurelet","\\\\globalfuture"],props:{numArgs:0,allowedInText:true,primitive:true},handler({parser:e,funcName:t}){const n=checkControlSequence(e.gullet.popToken());const r=e.gullet.popToken();const o=e.gullet.popToken();letCommand(e,n,o,t==="\\\\globalfuture");e.gullet.pushToken(o);e.gullet.pushToken(r);return{type:"internal",mode:e.mode}}});defineFunction({type:"internal",names:["\\newcommand","\\renewcommand","\\providecommand"],props:{numArgs:0,allowedInText:true,primitive:true},handler({parser:e,funcName:t}){let n="";const r=e.gullet.popToken();if(r.text==="{"){n=checkControlSequence(e.gullet.popToken());e.gullet.popToken()}else{n=checkControlSequence(r)}const o=e.gullet.isDefined(n);if(o&&t==="\\newcommand"){throw new ParseError(`\\newcommand{${n}} attempting to redefine ${n}; use \\renewcommand`)}if(!o&&t==="\\renewcommand"){throw new ParseError(`\\renewcommand{${n}} when command ${n} does not yet exist; use \\newcommand`)}let i=0;if(e.gullet.future().text==="["){let t=e.gullet.popToken();t=e.gullet.popToken();if(!/^[0-9]$/.test(t.text)){throw new ParseError(`Invalid number of arguments: "${t.text}"`)}i=parseInt(t.text);t=e.gullet.popToken();if(t.text!=="]"){throw new ParseError(`Invalid argument "${t.text}"`)}}const{tokens:s}=e.gullet.consumeArg();e.gullet.macros.set(n,{tokens:s,numArgs:i});return{type:"internal",mode:e.mode}}});const delimiterSizes={"\\bigl":{mclass:"mopen",size:1},"\\Bigl":{mclass:"mopen",size:2},"\\biggl":{mclass:"mopen",size:3},"\\Biggl":{mclass:"mopen",size:4},"\\bigr":{mclass:"mclose",size:1},"\\Bigr":{mclass:"mclose",size:2},"\\biggr":{mclass:"mclose",size:3},"\\Biggr":{mclass:"mclose",size:4},"\\bigm":{mclass:"mrel",size:1},"\\Bigm":{mclass:"mrel",size:2},"\\biggm":{mclass:"mrel",size:3},"\\Biggm":{mclass:"mrel",size:4},"\\big":{mclass:"mord",size:1},"\\Big":{mclass:"mord",size:2},"\\bigg":{mclass:"mord",size:3},"\\Bigg":{mclass:"mord",size:4}};const delimiters=["(","\\lparen",")","\\rparen","[","\\lbrack","]","\\rbrack","\\{","\\lbrace","\\}","\\rbrace","","\\llparenthesis","","\\rrparenthesis","\\lfloor","\\rfloor","","","\\lceil","\\rceil","","","<",">","\\langle","","\\rangle","","\\lAngle","","\\rAngle","","\\llangle","","\\rrangle","","\\lt","\\gt","\\lvert","\\rvert","\\lVert","\\rVert","\\lgroup","\\rgroup","","","\\lmoustache","\\rmoustache","","","\\llbracket","\\rrbracket","","","\\lBrace","\\rBrace","","","/","\\backslash","|","\\vert","\\|","\\Vert","\\uparrow","\\Uparrow","\\downarrow","\\Downarrow","\\updownarrow","\\Updownarrow","."];const dels=["}","\\left","\\middle","\\right"];const isDelimiter=e=>e.length>0&&(delimiters.includes(e)||delimiterSizes[e]||dels.includes(e));const sizeToMaxHeight=[0,1.2,1.8,2.4,3];function checkDelimiter(e,t){const n=checkSymbolNodeType(e);if(n&&delimiters.includes(n.text)){if(["<","\\lt"].includes(n.text)){n.text=""}if([">","\\gt"].includes(n.text)){n.text=""}return n}else if(n){throw new ParseError(`Invalid delimiter '${n.text}' after '${t.funcName}'`,e)}else{throw new ParseError(`Invalid delimiter type '${e.type}'`,e)}}const needExplicitStretch=["/","\\","\\backslash","\\vert","|"];defineFunction({type:"delimsizing",names:["\\bigl","\\Bigl","\\biggl","\\Biggl","\\bigr","\\Bigr","\\biggr","\\Biggr","\\bigm","\\Bigm","\\biggm","\\Biggm","\\big","\\Big","\\bigg","\\Bigg"],props:{numArgs:1,argTypes:["primitive"]},handler:(e,t)=>{const n=checkDelimiter(t[0],e);return{type:"delimsizing",mode:e.parser.mode,size:delimiterSizes[e.funcName].size,mclass:delimiterSizes[e.funcName].mclass,delim:n.text}},mathmlBuilder:e=>{const t=[];if(e.delim==="."){e.delim=""}t.push(makeText(e.delim,e.mode));const n=new mathMLTree.MathNode("mo",t);if(e.mclass==="mopen"||e.mclass==="mclose"){n.setAttribute("fence","true")}else{n.setAttribute("fence","false")}if(needExplicitStretch.includes(e.delim)||e.delim.indexOf("arrow")>-1){n.setAttribute("stretchy","true")}n.setAttribute("symmetric","true");n.setAttribute("minsize",sizeToMaxHeight[e.size]+"em");n.setAttribute("maxsize",sizeToMaxHeight[e.size]+"em");return n}});function assertParsed(e){if(!e.body){throw new Error("Bug: The leftright ParseNode wasn't fully parsed.")}}defineFunction({type:"leftright-right",names:["\\right"],props:{numArgs:1,argTypes:["primitive"]},handler:(e,t)=>({type:"leftright-right",mode:e.parser.mode,delim:checkDelimiter(t[0],e).text})});defineFunction({type:"leftright",names:["\\left"],props:{numArgs:1,argTypes:["primitive"]},handler:(e,t)=>{const n=checkDelimiter(t[0],e);const r=e.parser;++r.leftrightDepth;let o=r.parseExpression(false,null,true);let i=r.fetch();while(i.text==="\\middle"){r.consume();const e=r.fetch().text;if(!symbols.math[e]){throw new ParseError(`Invalid delimiter '${e}' after '\\middle'`)}checkDelimiter({type:"atom",mode:"math",text:e},{funcName:"\\middle"});o.push({type:"middle",mode:"math",delim:e});r.consume();o=o.concat(r.parseExpression(false,null,true));i=r.fetch()}--r.leftrightDepth;r.expect("\\right",false);const s=assertNodeType(r.parseFunction(),"leftright-right");return{type:"leftright",mode:r.mode,body:o,left:n.text,right:s.delim}},mathmlBuilder:(e,t)=>{assertParsed(e);const n=buildExpression(e.body,t);if(e.left==="."){e.left=""}const r=new mathMLTree.MathNode("mo",[makeText(e.left,e.mode)]);r.setAttribute("fence","true");r.setAttribute("form","prefix");if(e.left==="/"||e.left==="\\"||e.left.indexOf("arrow")>-1){r.setAttribute("stretchy","true")}n.unshift(r);if(e.right==="."){e.right=""}const o=new mathMLTree.MathNode("mo",[makeText(e.right,e.mode)]);o.setAttribute("fence","true");o.setAttribute("form","postfix");if(e.right===""||e.right.indexOf("arrow")>-1){o.setAttribute("stretchy","true")}if(e.body.length>0){const t=e.body[e.body.length-1];if(t.type==="color"&&!t.isTextColor){o.setAttribute("mathcolor",t.color)}}n.push(o);return makeRow(n)}});defineFunction({type:"middle",names:["\\middle"],props:{numArgs:1,argTypes:["primitive"]},handler:(e,t)=>{const n=checkDelimiter(t[0],e);if(!e.parser.leftrightDepth){throw new ParseError("\\middle without preceding \\left",n)}return{type:"middle",mode:e.parser.mode,delim:n.text}},mathmlBuilder:(e,t)=>{const n=makeText(e.delim,e.mode);const r=new mathMLTree.MathNode("mo",[n]);r.setAttribute("fence","true");if(e.delim.indexOf("arrow")>-1){r.setAttribute("stretchy","true")}r.setAttribute("form","prefix");r.setAttribute("lspace","0.05em");r.setAttribute("rspace","0.05em");return r}});const padding$1=e=>{const t=new mathMLTree.MathNode("mspace");t.setAttribute("width","3pt");return t};const mathmlBuilder$8=(e,t)=>{let n;if(e.label.indexOf("colorbox")>-1||e.label==="\\boxed"){n=new mathMLTree.MathNode("mrow",[padding$1(),buildGroup$1(e.body,t),padding$1()])}else{n=new mathMLTree.MathNode("menclose",[buildGroup$1(e.body,t)])}switch(e.label){case"\\overline":n.setAttribute("notation","top");n.classes.push("tml-overline");break;case"\\underline":n.setAttribute("notation","bottom");n.classes.push("tml-underline");break;case"\\cancel":n.setAttribute("notation","updiagonalstrike");n.children.push(new mathMLTree.MathNode("mrow",[],["tml-cancel","upstrike"]));break;case"\\bcancel":n.setAttribute("notation","downdiagonalstrike");n.children.push(new mathMLTree.MathNode("mrow",[],["tml-cancel","downstrike"]));break;case"\\sout":n.setAttribute("notation","horizontalstrike");n.children.push(new mathMLTree.MathNode("mrow",[],["tml-cancel","sout"]));break;case"\\xcancel":n.setAttribute("notation","updiagonalstrike downdiagonalstrike");n.classes.push("tml-xcancel");break;case"\\longdiv":n.setAttribute("notation","longdiv");n.classes.push("longdiv-top");n.children.push(new mathMLTree.MathNode("mrow",[],["longdiv-arc"]));break;case"\\phase":n.setAttribute("notation","phasorangle");n.classes.push("phasor-bottom");n.children.push(new mathMLTree.MathNode("mrow",[],["phasor-angle"]));break;case"\\textcircled":n.setAttribute("notation","circle");n.classes.push("circle-pad");n.children.push(new mathMLTree.MathNode("mrow",[],["textcircle"]));break;case"\\angl":n.setAttribute("notation","actuarial");n.classes.push("actuarial");break;case"\\boxed":n.setAttribute("notation","box");n.classes.push("tml-box");n.setAttribute("scriptlevel","0");n.setAttribute("displaystyle","true");break;case"\\fbox":n.setAttribute("notation","box");n.classes.push("tml-fbox");break;case"\\fcolorbox":case"\\colorbox":{const t={padding:"3pt 0 3pt 0"};if(e.label==="\\fcolorbox"){t.border="0.0667em solid "+String(e.borderColor)}n.style=t;break}}if(e.backgroundColor){n.setAttribute("mathbackground",e.backgroundColor)}return n};defineFunction({type:"enclose",names:["\\colorbox"],props:{numArgs:2,numOptionalArgs:1,allowedInText:true,argTypes:["raw","raw","text"]},handler({parser:e,funcName:t},n,r){const o=r[0]&&assertNodeType(r[0],"raw").string;let i="";if(o){const e=assertNodeType(n[0],"raw").string;i=colorFromSpec(o,e)}else{i=validateColor(assertNodeType(n[0],"raw").string,e.gullet.macros)}const s=n[1];return{type:"enclose",mode:e.mode,label:t,backgroundColor:i,body:s}},mathmlBuilder:mathmlBuilder$8});defineFunction({type:"enclose",names:["\\fcolorbox"],props:{numArgs:3,numOptionalArgs:1,allowedInText:true,argTypes:["raw","raw","raw","text"]},handler({parser:e,funcName:t},n,r){const o=r[0]&&assertNodeType(r[0],"raw").string;let i="";let s;if(o){const e=assertNodeType(n[0],"raw").string;const t=assertNodeType(n[0],"raw").string;i=colorFromSpec(o,e);s=colorFromSpec(o,t)}else{i=validateColor(assertNodeType(n[0],"raw").string,e.gullet.macros);s=validateColor(assertNodeType(n[1],"raw").string,e.gullet.macros)}const a=n[2];return{type:"enclose",mode:e.mode,label:t,backgroundColor:s,borderColor:i,body:a}},mathmlBuilder:mathmlBuilder$8});defineFunction({type:"enclose",names:["\\fbox"],props:{numArgs:1,argTypes:["hbox"],allowedInText:true},handler({parser:e},t){return{type:"enclose",mode:e.mode,label:"\\fbox",body:t[0]}}});defineFunction({type:"enclose",names:["\\angl","\\cancel","\\bcancel","\\xcancel","\\sout","\\overline","\\boxed","\\longdiv","\\phase"],props:{numArgs:1},handler({parser:e,funcName:t},n){const r=n[0];return{type:"enclose",mode:e.mode,label:t,body:r}},mathmlBuilder:mathmlBuilder$8});defineFunction({type:"enclose",names:["\\underline"],props:{numArgs:1,allowedInText:true},handler({parser:e,funcName:t},n){const r=n[0];return{type:"enclose",mode:e.mode,label:t,body:r}},mathmlBuilder:mathmlBuilder$8});defineFunction({type:"enclose",names:["\\textcircled"],props:{numArgs:1,argTypes:["text"],allowedInArgument:true,allowedInText:true},handler({parser:e,funcName:t},n){const r=n[0];return{type:"enclose",mode:e.mode,label:t,body:r}},mathmlBuilder:mathmlBuilder$8});const _environments={};function defineEnvironment({type:e,names:t,props:n,handler:r,mathmlBuilder:o}){const i={type:e,numArgs:n.numArgs||0,allowedInText:false,numOptionalArgs:0,handler:r};for(let e=0;e<t.length;++e){_environments[t[e]]=i}if(o){_mathmlGroupBuilders[e]=o}}const StyleLevel={DISPLAY:0,TEXT:1,SCRIPT:2,SCRIPTSCRIPT:3};const _macros={};function defineMacro(e,t){_macros[e]=t}const macros=_macros;defineMacro("\\noexpand",(function(e){const t=e.popToken();if(e.isExpandable(t.text)){t.noexpand=true;t.treatAsRelax=true}return{tokens:[t],numArgs:0}}));defineMacro("\\expandafter",(function(e){const t=e.popToken();e.expandOnce(true);return{tokens:[t],numArgs:0}}));defineMacro("\\@firstoftwo",(function(e){const t=e.consumeArgs(2);return{tokens:t[0],numArgs:0}}));defineMacro("\\@secondoftwo",(function(e){const t=e.consumeArgs(2);return{tokens:t[1],numArgs:0}}));defineMacro("\\@ifnextchar",(function(e){const t=e.consumeArgs(3);e.consumeSpaces();const n=e.future();if(t[0].length===1&&t[0][0].text===n.text){return{tokens:t[1],numArgs:0}}else{return{tokens:t[2],numArgs:0}}}));defineMacro("\\@ifstar","\\@ifnextchar *{\\@firstoftwo{#1}}");defineMacro("\\TextOrMath",(function(e){const t=e.consumeArgs(2);if(e.mode==="text"){return{tokens:t[0],numArgs:0}}else{return{tokens:t[1],numArgs:0}}}));const stringFromArg=e=>{let t="";for(let n=e.length-1;n>-1;n--){t+=e[n].text}return t};const digitToNumber={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,a:10,A:10,b:11,B:11,c:12,C:12,d:13,D:13,e:14,E:14,f:15,F:15};const nextCharNumber=e=>{const t=e.future().text;if(t==="EOF"){return[null,""]}return[digitToNumber[t.charAt(0)],t]};const appendCharNumbers=(e,t,n)=>{for(let r=1;r<t.length;r++){const o=digitToNumber[t.charAt(r)];e*=n;e+=o}return e};defineMacro("\\char",(function(e){let t=e.popToken();let n;let r="";if(t.text==="'"){n=8;t=e.popToken()}else if(t.text==='"'){n=16;t=e.popToken()}else if(t.text==="`"){t=e.popToken();if(t.text[0]==="\\"){r=t.text.charCodeAt(1)}else if(t.text==="EOF"){throw new ParseError("\\char` missing argument")}else{r=t.text.charCodeAt(0)}}else{n=10}if(n){let o=t.text;r=digitToNumber[o.charAt(0)];if(r==null||r>=n){throw new ParseError(`Invalid base-${n} digit ${t.text}`)}r=appendCharNumbers(r,o,n);let i;[i,o]=nextCharNumber(e);while(i!=null&&i<n){r*=n;r+=i;r=appendCharNumbers(r,o,n);e.popToken();[i,o]=nextCharNumber(e)}}return`\\@char{${r}}`}));function recreateArgStr(e){const t=e.consumeArgs(1)[0];let n="";let r=t[t.length-1].loc.start;for(let e=t.length-1;e>=0;e--){const o=t[e].loc.start;if(o>r){n+=" ";r=o}n+=t[e].text;r+=t[e].text.length}return n}defineMacro("\\surd","\\sqrt{\\vphantom{|}}");defineMacro("","\\oplus");defineMacro("\\long","");defineMacro("\\bgroup","{");defineMacro("\\egroup","}");defineMacro("~","\\nobreakspace");defineMacro("\\lq","`");defineMacro("\\rq","'");defineMacro("\\aa","\\r a");defineMacro("\\Bbbk","\\Bbb{k}");defineMacro("\\mathstrut","\\vphantom{(}");defineMacro("\\underbar","\\underline{\\text{#1}}");defineMacro("\\vdots","\\TextOrMath{\\textvdots}{{\\varvdots\\rule{0pt}{15pt}}}\\relax");defineMacro("","\\vdots");defineMacro("\\arraystretch","1");defineMacro("\\arraycolsep","6pt");defineMacro("\\substack","\\begin{subarray}{c}#1\\end{subarray}");defineMacro("\\iff","\\DOTSB\\;\\Longleftrightarrow\\;");defineMacro("\\implies","\\DOTSB\\;\\Longrightarrow\\;");defineMacro("\\impliedby","\\DOTSB\\;\\Longleftarrow\\;");const dotsByToken={",":"\\dotsc","\\not":"\\dotsb","+":"\\dotsb","=":"\\dotsb","<":"\\dotsb",">":"\\dotsb","-":"\\dotsb","*":"\\dotsb",":":"\\dotsb","\\DOTSB":"\\dotsb","\\coprod":"\\dotsb","\\bigvee":"\\dotsb","\\bigwedge":"\\dotsb","\\biguplus":"\\dotsb","\\bigcap":"\\dotsb","\\bigcup":"\\dotsb","\\prod":"\\dotsb","\\sum":"\\dotsb","\\bigotimes":"\\dotsb","\\bigoplus":"\\dotsb","\\bigodot":"\\dotsb","\\bigsqcap":"\\dotsb","\\bigsqcup":"\\dotsb","\\bigtimes":"\\dotsb","\\And":"\\dotsb","\\longrightarrow":"\\dotsb","\\Longrightarrow":"\\dotsb","\\longleftarrow":"\\dotsb","\\Longleftarrow":"\\dotsb","\\longleftrightarrow":"\\dotsb","\\Longleftrightarrow":"\\dotsb","\\mapsto":"\\dotsb","\\longmapsto":"\\dotsb","\\hookrightarrow":"\\dotsb","\\doteq":"\\dotsb","\\mathbin":"\\dotsb","\\mathrel":"\\dotsb","\\relbar":"\\dotsb","\\Relbar":"\\dotsb","\\xrightarrow":"\\dotsb","\\xleftarrow":"\\dotsb","\\DOTSI":"\\dotsi","\\int":"\\dotsi","\\oint":"\\dotsi","\\iint":"\\dotsi","\\iiint":"\\dotsi","\\iiiint":"\\dotsi","\\idotsint":"\\dotsi","\\DOTSX":"\\dotsx"};defineMacro("\\dots",(function(e){let t="\\dotso";const n=e.expandAfterFuture().text;if(n in dotsByToken){t=dotsByToken[n]}else if(n.slice(0,4)==="\\not"){t="\\dotsb"}else if(n in symbols.math){if(["bin","rel"].includes(symbols.math[n].group)){t="\\dotsb"}}return t}));const spaceAfterDots={")":true,"]":true,"\\rbrack":true,"\\}":true,"\\rbrace":true,"\\rangle":true,"\\rceil":true,"\\rfloor":true,"\\rgroup":true,"\\rmoustache":true,"\\right":true,"\\bigr":true,"\\biggr":true,"\\Bigr":true,"\\Biggr":true,$:true,";":true,".":true,",":true};defineMacro("\\dotso",(function(e){const t=e.future().text;if(t in spaceAfterDots){return"\\ldots\\,"}else{return"\\ldots"}}));defineMacro("\\dotsc",(function(e){const t=e.future().text;if(t in spaceAfterDots&&t!==","){return"\\ldots\\,"}else{return"\\ldots"}}));defineMacro("\\cdots",(function(e){const t=e.future().text;if(t in spaceAfterDots){return"\\@cdots\\,"}else{return"\\@cdots"}}));defineMacro("\\dotsb","\\cdots");defineMacro("\\dotsm","\\cdots");defineMacro("\\dotsi","\\!\\cdots");defineMacro("\\idotsint","\\dotsi");defineMacro("\\dotsx","\\ldots\\,");defineMacro("\\DOTSI","\\relax");defineMacro("\\DOTSB","\\relax");defineMacro("\\DOTSX","\\relax");defineMacro("\\tmspace","\\TextOrMath{\\kern#1#3}{\\mskip#1#2}\\relax");defineMacro("\\,","{\\tmspace+{3mu}{.1667em}}");defineMacro("\\thinspace","\\,");defineMacro("\\>","\\mskip{4mu}");defineMacro("\\:","{\\tmspace+{4mu}{.2222em}}");defineMacro("\\medspace","\\:");defineMacro("\\;","{\\tmspace+{5mu}{.2777em}}");defineMacro("\\thickspace","\\;");defineMacro("\\!","{\\tmspace-{3mu}{.1667em}}");defineMacro("\\negthinspace","\\!");defineMacro("\\negmedspace","{\\tmspace-{4mu}{.2222em}}");defineMacro("\\negthickspace","{\\tmspace-{5mu}{.277em}}");defineMacro("\\enspace","\\kern.5em ");defineMacro("\\enskip","\\hskip.5em\\relax");defineMacro("\\quad","\\hskip1em\\relax");defineMacro("\\qquad","\\hskip2em\\relax");defineMacro("\\AA","\\TextOrMath{\\Angstrom}{\\mathring{A}}\\relax");defineMacro("\\tag","\\@ifstar\\tag@literal\\tag@paren");defineMacro("\\tag@paren","\\tag@literal{({#1})}");defineMacro("\\tag@literal",(e=>{if(e.macros.get("\\df@tag")){throw new ParseError("Multiple \\tag")}return"\\def\\df@tag{\\text{#1}}"}));defineMacro("\\bmod","\\mathbin{\\text{mod}}");defineMacro("\\pod","\\allowbreak"+"\\mathchoice{\\mkern18mu}{\\mkern8mu}{\\mkern8mu}{\\mkern8mu}(#1)");defineMacro("\\pmod","\\pod{{\\rm mod}\\mkern6mu#1}");defineMacro("\\mod","\\allowbreak"+"\\mathchoice{\\mkern18mu}{\\mkern12mu}{\\mkern12mu}{\\mkern12mu}"+"{\\rm mod}\\,\\,#1");defineMacro("\\newline","\\\\\\relax");defineMacro("\\TeX","\\textrm{T}\\kern-.1667em\\raisebox{-.5ex}{E}\\kern-.125em\\textrm{X}");defineMacro("\\LaTeX","\\textrm{L}\\kern-.35em\\raisebox{0.2em}{\\scriptstyle A}\\kern-.15em\\TeX");defineMacro("\\Temml","\\textrm{T}\\kern-0.2em\\lower{0.2em}{\\textrm{E}}\\kern-0.08em{\\textrm{M}\\kern-0.08em\\raise{0.2em}\\textrm{M}\\kern-0.08em\\textrm{L}}");defineMacro("\\hspace","\\@ifstar\\@hspacer\\@hspace");defineMacro("\\@hspace","\\hskip #1\\relax");defineMacro("\\@hspacer","\\rule{0pt}{0pt}\\hskip #1\\relax");defineMacro("\\colon",`\\mathpunct{\\char"3a}`);defineMacro("\\prescript","\\pres@cript{_{#1}^{#2}}{}{#3}");defineMacro("\\ordinarycolon",`\\char"3a`);defineMacro("\\vcentcolon","\\mathrel{\\raisebox{0.035em}{\\ordinarycolon}}");defineMacro("\\coloneq",'\\mathrel{\\raisebox{0.035em}{\\ordinarycolon}\\char"2212}');defineMacro("\\Coloneq",'\\mathrel{\\char"2237\\char"2212}');defineMacro("\\Eqqcolon",'\\mathrel{\\char"3d\\char"2237}');defineMacro("\\Eqcolon",'\\mathrel{\\char"2212\\char"2237}');defineMacro("\\colonapprox",'\\mathrel{\\raisebox{0.035em}{\\ordinarycolon}\\char"2248}');defineMacro("\\Colonapprox",'\\mathrel{\\char"2237\\char"2248}');defineMacro("\\colonsim",'\\mathrel{\\raisebox{0.035em}{\\ordinarycolon}\\char"223c}');defineMacro("\\Colonsim",'\\mathrel{\\raisebox{0.035em}{\\ordinarycolon}\\char"223c}');defineMacro("\\ratio","\\vcentcolon");defineMacro("\\coloncolon","\\dblcolon");defineMacro("\\colonequals","\\coloneqq");defineMacro("\\coloncolonequals","\\Coloneqq");defineMacro("\\equalscolon","\\eqqcolon");defineMacro("\\equalscoloncolon","\\Eqqcolon");defineMacro("\\colonminus","\\coloneq");defineMacro("\\coloncolonminus","\\Coloneq");defineMacro("\\minuscolon","\\eqcolon");defineMacro("\\minuscoloncolon","\\Eqcolon");defineMacro("\\coloncolonapprox","\\Colonapprox");defineMacro("\\coloncolonsim","\\Colonsim");defineMacro("\\notni","\\mathrel{\\char`}");defineMacro("\\limsup","\\DOTSB\\operatorname*{lim\\,sup}");defineMacro("\\liminf","\\DOTSB\\operatorname*{lim\\,inf}");defineMacro("\\injlim","\\DOTSB\\operatorname*{inj\\,lim}");defineMacro("\\projlim","\\DOTSB\\operatorname*{proj\\,lim}");defineMacro("\\varlimsup","\\DOTSB\\operatorname*{\\overline{\\text{lim}}}");defineMacro("\\varliminf","\\DOTSB\\operatorname*{\\underline{\\text{lim}}}");defineMacro("\\varinjlim","\\DOTSB\\operatorname*{\\underrightarrow{\\text{lim}}}");defineMacro("\\varprojlim","\\DOTSB\\operatorname*{\\underleftarrow{\\text{lim}}}");defineMacro("\\centerdot","{\\medspace\\rule{0.167em}{0.189em}\\medspace}");defineMacro("\\argmin","\\DOTSB\\operatorname*{arg\\,min}");defineMacro("\\argmax","\\DOTSB\\operatorname*{arg\\,max}");defineMacro("\\plim","\\DOTSB\\operatorname*{plim}");defineMacro("\\leftmodels","\\mathop{\\reflectbox{$\\models$}}");defineMacro("\\bra","\\mathinner{\\langle{#1}|}");defineMacro("\\ket","\\mathinner{|{#1}\\rangle}");defineMacro("\\braket","\\mathinner{\\langle{#1}\\rangle}");defineMacro("\\Bra","\\left\\langle#1\\right|");defineMacro("\\Ket","\\left|#1\\right\\rangle");const replaceVert=(e,t)=>{const n=t[0]==="|"?"\\vert":"\\Vert";const r=`}\\,\\middle${n}\\,{`;return e.slice(0,t.index)+r+e.slice(t.index+t[0].length)};defineMacro("\\Braket",(function(e){let t=recreateArgStr(e);const n=/\|\||\||\\\|/g;let r;while((r=n.exec(t))!==null){t=replaceVert(t,r)}return"\\left\\langle{"+t+"}\\right\\rangle"}));defineMacro("\\Set",(function(e){let t=recreateArgStr(e);const n=/\|\||\||\\\|/.exec(t);if(n){t=replaceVert(t,n)}return"\\left\\{\\:{"+t+"}\\:\\right\\}"}));defineMacro("\\set",(function(e){const t=recreateArgStr(e);return"\\{{"+t.replace(/\|/,"}\\mid{")+"}\\}"}));defineMacro("\\angln","{\\angl n}");defineMacro("\\odv","\\@ifstar\\odv@next\\odv@numerator");defineMacro("\\odv@numerator","\\frac{\\mathrm{d}#1}{\\mathrm{d}#2}");defineMacro("\\odv@next","\\frac{\\mathrm{d}}{\\mathrm{d}#2}#1");defineMacro("\\pdv","\\@ifstar\\pdv@next\\pdv@numerator");const pdvHelper=e=>{const t=e[0][0].text;const n=stringFromArg(e[1]).split(",");const r=String(n.length);const o=r==="1"?"\\partial":`\\partial^${r}`;let i="";n.map((e=>{i+="\\partial "+e.trim()+"\\,"}));return[t,o,i.replace(/\\,$/,"")]};defineMacro("\\pdv@numerator",(function(e){const[t,n,r]=pdvHelper(e.consumeArgs(2));return`\\frac{${n} ${t}}{${r}}`}));defineMacro("\\pdv@next",(function(e){const[t,n,r]=pdvHelper(e.consumeArgs(2));return`\\frac{${n}}{${r}} ${t}`}));defineMacro("\\upalpha","\\up@greek{\\alpha}");defineMacro("\\upbeta","\\up@greek{\\beta}");defineMacro("\\upgamma","\\up@greek{\\gamma}");defineMacro("\\updelta","\\up@greek{\\delta}");defineMacro("\\upepsilon","\\up@greek{\\epsilon}");defineMacro("\\upzeta","\\up@greek{\\zeta}");defineMacro("\\upeta","\\up@greek{\\eta}");defineMacro("\\uptheta","\\up@greek{\\theta}");defineMacro("\\upiota","\\up@greek{\\iota}");defineMacro("\\upkappa","\\up@greek{\\kappa}");defineMacro("\\uplambda","\\up@greek{\\lambda}");defineMacro("\\upmu","\\up@greek{\\mu}");defineMacro("\\upnu","\\up@greek{\\nu}");defineMacro("\\upxi","\\up@greek{\\xi}");defineMacro("\\upomicron","\\up@greek{\\omicron}");defineMacro("\\uppi","\\up@greek{\\pi}");defineMacro("\\upalpha","\\up@greek{\\alpha}");defineMacro("\\uprho","\\up@greek{\\rho}");defineMacro("\\upsigma","\\up@greek{\\sigma}");defineMacro("\\uptau","\\up@greek{\\tau}");defineMacro("\\upupsilon","\\up@greek{\\upsilon}");defineMacro("\\upphi","\\up@greek{\\phi}");defineMacro("\\upchi","\\up@greek{\\chi}");defineMacro("\\uppsi","\\up@greek{\\psi}");defineMacro("\\upomega","\\up@greek{\\omega}");defineMacro("\\invamp",'\\mathbin{\\char"214b}');defineMacro("\\parr",'\\mathbin{\\char"214b}');defineMacro("\\with",'\\mathbin{\\char"26}');defineMacro("\\multimapinv",'\\mathrel{\\char"27dc}');defineMacro("\\multimapboth",'\\mathrel{\\char"29df}');defineMacro("\\scoh",'{\\mkern5mu\\char"2322\\mkern5mu}');defineMacro("\\sincoh",'{\\mkern5mu\\char"2323\\mkern5mu}');defineMacro("\\coh",`{\\mkern5mu\\rule{}{0.7em}\\mathrlap{\\smash{\\raise2mu{\\char"2322}}}\n{\\smash{\\lower4mu{\\char"2323}}}\\mkern5mu}`);defineMacro("\\incoh",`{\\mkern5mu\\rule{}{0.7em}\\mathrlap{\\smash{\\raise2mu{\\char"2323}}}\n{\\smash{\\lower4mu{\\char"2322}}}\\mkern5mu}`);defineMacro("\\standardstate","\\text{\\tiny\\char`}");defineMacro("\\ce",(function(e){return chemParse(e.consumeArgs(1)[0],"ce")}));defineMacro("\\pu",(function(e){return chemParse(e.consumeArgs(1)[0],"pu")}));defineMacro("\\uniDash",`{\\rule{0.672em}{0.06em}}`);defineMacro("\\triDash",`{\\rule{0.15em}{0.06em}\\kern2mu\\rule{0.15em}{0.06em}\\kern2mu\\rule{0.15em}{0.06em}}`);defineMacro("\\tripleDash",`\\kern0.075em\\raise0.25em{\\triDash}\\kern0.075em`);defineMacro("\\tripleDashOverLine",`\\kern0.075em\\mathrlap{\\raise0.125em{\\uniDash}}\\raise0.34em{\\triDash}\\kern0.075em`);defineMacro("\\tripleDashOverDoubleLine",`\\kern0.075em\\mathrlap{\\mathrlap{\\raise0.48em{\\triDash}}\\raise0.27em{\\uniDash}}{\\raise0.05em{\\uniDash}}\\kern0.075em`);defineMacro("\\tripleDashBetweenDoubleLine",`\\kern0.075em\\mathrlap{\\mathrlap{\\raise0.48em{\\uniDash}}\\raise0.27em{\\triDash}}{\\raise0.05em{\\uniDash}}\\kern0.075em`);var chemParse=function(e,t){var n="";var r=e.length&&e[e.length-1].loc.start;for(var o=e.length-1;o>=0;o--){if(e[o].loc.start>r){n+=" ";r=e[o].loc.start}n+=e[o].text;r+=e[o].text.length}var i=texify.go(mhchemParser.go(n,t));return i};var mhchemParser={go:function(e,t){if(!e){return[]}if(t===undefined){t="ce"}var n="0";var r={};r["parenthesisLevel"]=0;e=e.replace(/\n/g," ");e=e.replace(/[\u2212\u2013\u2014\u2010]/g,"-");e=e.replace(/[\u2026]/g,"...");var o;var i=10;var s=[];while(true){if(o!==e){i=10;o=e}else{i--}var a=mhchemParser.stateMachines[t];var l=a.transitions[n]||a.transitions["*"];e:for(var c=0;c<l.length;c++){var d=mhchemParser.patterns.match_(l[c].pattern,e);if(d){var u=l[c].task;for(var p=0;p<u.action_.length;p++){var f;if(a.actions[u.action_[p].type_]){f=a.actions[u.action_[p].type_](r,d.match_,u.action_[p].option)}else if(mhchemParser.actions[u.action_[p].type_]){f=mhchemParser.actions[u.action_[p].type_](r,d.match_,u.action_[p].option)}else{throw["MhchemBugA","mhchem bug A. Please report. ("+u.action_[p].type_+")"]}mhchemParser.concatArray(s,f)}n=u.nextState||n;if(e.length>0){if(!u.revisit){e=d.remainder}if(!u.toContinue){break e}}else{return s}}}if(i<=0){throw["MhchemBugU","mhchem bug U. Please report."]}}},concatArray:function(e,t){if(t){if(Array.isArray(t)){for(var n=0;n<t.length;n++){e.push(t[n])}}else{e.push(t)}}},patterns:{patterns:{empty:/^$/,else:/^./,else2:/^./,space:/^\s/,"space A":/^\s(?=[A-Z\\$])/,space$:/^\s$/,"a-z":/^[a-z]/,x:/^x/,x$:/^x$/,i$:/^i$/,letters:/^(?:[a-zA-Z\u03B1-\u03C9\u0391-\u03A9?@]|(?:\\(?:alpha|beta|gamma|delta|epsilon|zeta|eta|theta|iota|kappa|lambda|mu|nu|xi|omicron|pi|rho|sigma|tau|upsilon|phi|chi|psi|omega|Gamma|Delta|Theta|Lambda|Xi|Pi|Sigma|Upsilon|Phi|Psi|Omega)(?:\s+|\{\}|(?![a-zA-Z]))))+/,"\\greek":/^\\(?:alpha|beta|gamma|delta|epsilon|zeta|eta|theta|iota|kappa|lambda|mu|nu|xi|omicron|pi|rho|sigma|tau|upsilon|phi|chi|psi|omega|Gamma|Delta|Theta|Lambda|Xi|Pi|Sigma|Upsilon|Phi|Psi|Omega)(?:\s+|\{\}|(?![a-zA-Z]))/,"one lowercase latin letter $":/^(?:([a-z])(?:$|[^a-zA-Z]))$/,"$one lowercase latin letter$ $":/^\$(?:([a-z])(?:$|[^a-zA-Z]))\$$/,"one lowercase greek letter $":/^(?:\$?[\u03B1-\u03C9]\$?|\$?\\(?:alpha|beta|gamma|delta|epsilon|zeta|eta|theta|iota|kappa|lambda|mu|nu|xi|omicron|pi|rho|sigma|tau|upsilon|phi|chi|psi|omega)\s*\$?)(?:\s+|\{\}|(?![a-zA-Z]))$/,digits:/^[0-9]+/,"-9.,9":/^[+\-]?(?:[0-9]+(?:[,.][0-9]+)?|[0-9]*(?:\.[0-9]+))/,"-9.,9 no missing 0":/^[+\-]?[0-9]+(?:[.,][0-9]+)?/,"(-)(9.,9)(e)(99)":function(e){var t=e.match(/^(\+\-|\+\/\-|\+|\-|\\pm\s?)?([0-9]+(?:[,.][0-9]+)?|[0-9]*(?:\.[0-9]+))?(\((?:[0-9]+(?:[,.][0-9]+)?|[0-9]*(?:\.[0-9]+))\))?(?:([eE]|\s*(\*|x|\\times|\u00D7)\s*10\^)([+\-]?[0-9]+|\{[+\-]?[0-9]+\}))?/);if(t&&t[0]){return{match_:t.splice(1),remainder:e.substr(t[0].length)}}return null},"(-)(9)^(-9)":function(e){var t=e.match(/^(\+\-|\+\/\-|\+|\-|\\pm\s?)?([0-9]+(?:[,.][0-9]+)?|[0-9]*(?:\.[0-9]+)?)\^([+\-]?[0-9]+|\{[+\-]?[0-9]+\})/);if(t&&t[0]){return{match_:t.splice(1),remainder:e.substr(t[0].length)}}return null},"state of aggregation $":function(e){var t=mhchemParser.patterns.findObserveGroups(e,"",/^\([a-z]{1,3}(?=[\),])/,")","");if(t&&t.remainder.match(/^($|[\s,;\)\]\}])/)){return t}var n=e.match(/^(?:\((?:\\ca\s?)?\$[amothc]\$\))/);if(n){return{match_:n[0],remainder:e.substr(n[0].length)}}return null},"_{(state of aggregation)}$":/^_\{(\([a-z]{1,3}\))\}/,"{[(":/^(?:\\\{|\[|\()/,")]}":/^(?:\)|\]|\\\})/,", ":/^[,;]\s*/,",":/^[,;]/,".":/^[.]/,". ":/^([.\u22C5\u00B7\u2022])\s*/,"...":/^\.\.\.(?=$|[^.])/,"* ":/^([*])\s*/,"^{(...)}":function(e){return mhchemParser.patterns.findObserveGroups(e,"^{","","","}")},"^($...$)":function(e){return mhchemParser.patterns.findObserveGroups(e,"^","$","$","")},"^a":/^\^([0-9]+|[^\\_])/,"^\\x{}{}":function(e){return mhchemParser.patterns.findObserveGroups(e,"^",/^\\[a-zA-Z]+\{/,"}","","","{","}","",true)},"^\\x{}":function(e){return mhchemParser.patterns.findObserveGroups(e,"^",/^\\[a-zA-Z]+\{/,"}","")},"^\\x":/^\^(\\[a-zA-Z]+)\s*/,"^(-1)":/^\^(-?\d+)/,"'":/^'/,"_{(...)}":function(e){return mhchemParser.patterns.findObserveGroups(e,"_{","","","}")},"_($...$)":function(e){return mhchemParser.patterns.findObserveGroups(e,"_","$","$","")},_9:/^_([+\-]?[0-9]+|[^\\])/,"_\\x{}{}":function(e){return mhchemParser.patterns.findObserveGroups(e,"_",/^\\[a-zA-Z]+\{/,"}","","","{","}","",true)},"_\\x{}":function(e){return mhchemParser.patterns.findObserveGroups(e,"_",/^\\[a-zA-Z]+\{/,"}","")},"_\\x":/^_(\\[a-zA-Z]+)\s*/,"^_":/^(?:\^(?=_)|\_(?=\^)|[\^_]$)/,"{}":/^\{\}/,"{...}":function(e){return mhchemParser.patterns.findObserveGroups(e,"","{","}","")},"{(...)}":function(e){return mhchemParser.patterns.findObserveGroups(e,"{","","","}")},"$...$":function(e){return mhchemParser.patterns.findObserveGroups(e,"","$","$","")},"${(...)}$":function(e){return mhchemParser.patterns.findObserveGroups(e,"${","","","}$")},"$(...)$":function(e){return mhchemParser.patterns.findObserveGroups(e,"$","","","$")},"=<>":/^[=<>]/,"#":/^[#\u2261]/,"+":/^\+/,"-$":/^-(?=[\s_},;\]/]|$|\([a-z]+\))/,"-9":/^-(?=[0-9])/,"- orbital overlap":/^-(?=(?:[spd]|sp)(?:$|[\s,;\)\]\}]))/,"-":/^-/,"pm-operator":/^(?:\\pm|\$\\pm\$|\+-|\+\/-)/,operator:/^(?:\+|(?:[\-=<>]|<<|>>|\\approx|\$\\approx\$)(?=\s|$|-?[0-9]))/,arrowUpDown:/^(?:v|\(v\)|\^|\(\^\))(?=$|[\s,;\)\]\}])/,"\\bond{(...)}":function(e){return mhchemParser.patterns.findObserveGroups(e,"\\bond{","","","}")},"->":/^(?:<->|<-->|->|<-|<=>>|<<=>|<=>|[\u2192\u27F6\u21CC])/,CMT:/^[CMT](?=\[)/,"[(...)]":function(e){return mhchemParser.patterns.findObserveGroups(e,"[","","","]")},"1st-level escape":/^(&|\\\\|\\hline)\s*/,"\\,":/^(?:\\[,\ ;:])/,"\\x{}{}":function(e){return mhchemParser.patterns.findObserveGroups(e,"",/^\\[a-zA-Z]+\{/,"}","","","{","}","",true)},"\\x{}":function(e){return mhchemParser.patterns.findObserveGroups(e,"",/^\\[a-zA-Z]+\{/,"}","")},"\\ca":/^\\ca(?:\s+|(?![a-zA-Z]))/,"\\x":/^(?:\\[a-zA-Z]+\s*|\\[_&{}%])/,orbital:/^(?:[0-9]{1,2}[spdfgh]|[0-9]{0,2}sp)(?=$|[^a-zA-Z])/,others:/^[\/~|]/,"\\frac{(...)}":function(e){return mhchemParser.patterns.findObserveGroups(e,"\\frac{","","","}","{","","","}")},"\\overset{(...)}":function(e){return mhchemParser.patterns.findObserveGroups(e,"\\overset{","","","}","{","","","}")},"\\underset{(...)}":function(e){return mhchemParser.patterns.findObserveGroups(e,"\\underset{","","","}","{","","","}")},"\\underbrace{(...)}":function(e){return mhchemParser.patterns.findObserveGroups(e,"\\underbrace{","","","}_","{","","","}")},"\\color{(...)}0":function(e){return mhchemParser.patterns.findObserveGroups(e,"\\color{","","","}")},"\\color{(...)}{(...)}1":function(e){return mhchemParser.patterns.findObserveGroups(e,"\\color{","","","}","{","","","}")},"\\color(...){(...)}2":function(e){return mhchemParser.patterns.findObserveGroups(e,"\\color","\\","",/^(?=\{)/,"{","","","}")},"\\ce{(...)}":function(e){return mhchemParser.patterns.findObserveGroups(e,"\\ce{","","","}")},oxidation$:/^(?:[+-][IVX]+|\\pm\s*0|\$\\pm\$\s*0)$/,"d-oxidation$":/^(?:[+-]?\s?[IVX]+|\\pm\s*0|\$\\pm\$\s*0)$/,"roman numeral":/^[IVX]+/,"1/2$":/^[+\-]?(?:[0-9]+|\$[a-z]\$|[a-z])\/[0-9]+(?:\$[a-z]\$|[a-z])?$/,amount:function(e){var t;t=e.match(/^(?:(?:(?:\([+\-]?[0-9]+\/[0-9]+\)|[+\-]?(?:[0-9]+|\$[a-z]\$|[a-z])\/[0-9]+|[+\-]?[0-9]+[.,][0-9]+|[+\-]?\.[0-9]+|[+\-]?[0-9]+)(?:[a-z](?=\s*[A-Z]))?)|[+\-]?[a-z](?=\s*[A-Z])|\+(?!\s))/);if(t){return{match_:t[0],remainder:e.substr(t[0].length)}}var n=mhchemParser.patterns.findObserveGroups(e,"","$","$","");if(n){t=n.match_.match(/^\$(?:\(?[+\-]?(?:[0-9]*[a-z]?[+\-])?[0-9]*[a-z](?:[+\-][0-9]*[a-z]?)?\)?|\+|-)\$$/);if(t){return{match_:t[0],remainder:e.substr(t[0].length)}}}return null},amount2:function(e){return this["amount"](e)},"(KV letters),":/^(?:[A-Z][a-z]{0,2}|i)(?=,)/,formula$:function(e){if(e.match(/^\([a-z]+\)$/)){return null}var t=e.match(/^(?:[a-z]|(?:[0-9\ \+\-\,\.\(\)]+[a-z])+[0-9\ \+\-\,\.\(\)]*|(?:[a-z][0-9\ \+\-\,\.\(\)]+)+[a-z]?)$/);if(t){return{match_:t[0],remainder:e.substr(t[0].length)}}return null},uprightEntities:/^(?:pH|pOH|pC|pK|iPr|iBu)(?=$|[^a-zA-Z])/,"/":/^\s*(\/)\s*/,"//":/^\s*(\/\/)\s*/,"*":/^\s*[*.]\s*/},findObserveGroups:function(e,t,n,r,o,i,s,a,l,c){var d=function(e,t){if(typeof t==="string"){if(e.indexOf(t)!==0){return null}return t}else{var n=e.match(t);if(!n){return null}return n[0]}};var u=function(e,t,n){var r=0;while(t<e.length){var o=e.charAt(t);var i=d(e.substr(t),n);if(i!==null&&r===0){return{endMatchBegin:t,endMatchEnd:t+i.length}}else if(o==="{"){r++}else if(o==="}"){if(r===0){throw["ExtraCloseMissingOpen","Extra close brace or missing open brace"]}else{r--}}t++}if(r>0){return null}return null};var p=d(e,t);if(p===null){return null}e=e.substr(p.length);p=d(e,n);if(p===null){return null}var f=u(e,p.length,r||o);if(f===null){return null}var h=e.substring(0,r?f.endMatchEnd:f.endMatchBegin);if(!(i||s)){return{match_:h,remainder:e.substr(f.endMatchEnd)}}else{var m=this.findObserveGroups(e.substr(f.endMatchEnd),i,s,a,l);if(m===null){return null}var g=[h,m.match_];return{match_:c?g.join(""):g,remainder:m.remainder}}},match_:function(e,t){var n=mhchemParser.patterns.patterns[e];if(n===undefined){throw["MhchemBugP","mhchem bug P. Please report. ("+e+")"]}else if(typeof n==="function"){return mhchemParser.patterns.patterns[e](t)}else{var r=t.match(n);if(r){var o;if(r[2]){o=[r[1],r[2]]}else if(r[1]){o=r[1]}else{o=r[0]}return{match_:o,remainder:t.substr(r[0].length)}}return null}}},actions:{"a=":function(e,t){e.a=(e.a||"")+t},"b=":function(e,t){e.b=(e.b||"")+t},"p=":function(e,t){e.p=(e.p||"")+t},"o=":function(e,t){e.o=(e.o||"")+t},"q=":function(e,t){e.q=(e.q||"")+t},"d=":function(e,t){e.d=(e.d||"")+t},"rm=":function(e,t){e.rm=(e.rm||"")+t},"text=":function(e,t){e.text_=(e.text_||"")+t},insert:function(e,t,n){return{type_:n}},"insert+p1":function(e,t,n){return{type_:n,p1:t}},"insert+p1+p2":function(e,t,n){return{type_:n,p1:t[0],p2:t[1]}},copy:function(e,t){return t},rm:function(e,t){return{type_:"rm",p1:t||""}},text:function(e,t){return mhchemParser.go(t,"text")},"{text}":function(e,t){var n=["{"];mhchemParser.concatArray(n,mhchemParser.go(t,"text"));n.push("}");return n},"tex-math":function(e,t){return mhchemParser.go(t,"tex-math")},"tex-math tight":function(e,t){return mhchemParser.go(t,"tex-math tight")},bond:function(e,t,n){return{type_:"bond",kind_:n||t}},"color0-output":function(e,t){return{type_:"color0",color:t[0]}},ce:function(e,t){return mhchemParser.go(t)},"1/2":function(e,t){var n=[];if(t.match(/^[+\-]/)){n.push(t.substr(0,1));t=t.substr(1)}var r=t.match(/^([0-9]+|\$[a-z]\$|[a-z])\/([0-9]+)(\$[a-z]\$|[a-z])?$/);r[1]=r[1].replace(/\$/g,"");n.push({type_:"frac",p1:r[1],p2:r[2]});if(r[3]){r[3]=r[3].replace(/\$/g,"");n.push({type_:"tex-math",p1:r[3]})}return n},"9,9":function(e,t){return mhchemParser.go(t,"9,9")}},createTransitions:function(e){var t,n;var r;var o;var i={};for(t in e){for(n in e[t]){r=n.split("|");e[t][n].stateArray=r;for(o=0;o<r.length;o++){i[r[o]]=[]}}}for(t in e){for(n in e[t]){r=e[t][n].stateArray||[];for(o=0;o<r.length;o++){var s=e[t][n];if(s.action_){s.action_=[].concat(s.action_);for(var a=0;a<s.action_.length;a++){if(typeof s.action_[a]==="string"){s.action_[a]={type_:s.action_[a]}}}}else{s.action_=[]}var l=t.split("|");for(var c=0;c<l.length;c++){if(r[o]==="*"){for(var d in i){i[d].push({pattern:l[c],task:s})}}else{i[r[o]].push({pattern:l[c],task:s})}}}}}return i},stateMachines:{}};mhchemParser.stateMachines={ce:{transitions:mhchemParser.createTransitions({empty:{"*":{action_:"output"}},else:{"0|1|2":{action_:"beginsWithBond=false",revisit:true,toContinue:true}},oxidation$:{0:{action_:"oxidation-output"}},CMT:{r:{action_:"rdt=",nextState:"rt"},rd:{action_:"rqt=",nextState:"rdt"}},arrowUpDown:{"0|1|2|as":{action_:["sb=false","output","operator"],nextState:"1"}},uprightEntities:{"0|1|2":{action_:["o=","output"],nextState:"1"}},orbital:{"0|1|2|3":{action_:"o=",nextState:"o"}},"->":{"0|1|2|3":{action_:"r=",nextState:"r"},"a|as":{action_:["output","r="],nextState:"r"},"*":{action_:["output","r="],nextState:"r"}},"+":{o:{action_:"d= kv",nextState:"d"},"d|D":{action_:"d=",nextState:"d"},q:{action_:"d=",nextState:"qd"},"qd|qD":{action_:"d=",nextState:"qd"},dq:{action_:["output","d="],nextState:"d"},3:{action_:["sb=false","output","operator"],nextState:"0"}},amount:{"0|2":{action_:"a=",nextState:"a"}},"pm-operator":{"0|1|2|a|as":{action_:["sb=false","output",{type_:"operator",option:"\\pm"}],nextState:"0"}},operator:{"0|1|2|a|as":{action_:["sb=false","output","operator"],nextState:"0"}},"-$":{"o|q":{action_:["charge or bond","output"],nextState:"qd"},d:{action_:"d=",nextState:"d"},D:{action_:["output",{type_:"bond",option:"-"}],nextState:"3"},q:{action_:"d=",nextState:"qd"},qd:{action_:"d=",nextState:"qd"},"qD|dq":{action_:["output",{type_:"bond",option:"-"}],nextState:"3"}},"-9":{"3|o":{action_:["output",{type_:"insert",option:"hyphen"}],nextState:"3"}},"- orbital overlap":{o:{action_:["output",{type_:"insert",option:"hyphen"}],nextState:"2"},d:{action_:["output",{type_:"insert",option:"hyphen"}],nextState:"2"}},"-":{"0|1|2":{action_:[{type_:"output",option:1},"beginsWithBond=true",{type_:"bond",option:"-"}],nextState:"3"},3:{action_:{type_:"bond",option:"-"}},a:{action_:["output",{type_:"insert",option:"hyphen"}],nextState:"2"},as:{action_:[{type_:"output",option:2},{type_:"bond",option:"-"}],nextState:"3"},b:{action_:"b="},o:{action_:{type_:"- after o/d",option:false},nextState:"2"},q:{action_:{type_:"- after o/d",option:false},nextState:"2"},"d|qd|dq":{action_:{type_:"- after o/d",option:true},nextState:"2"},"D|qD|p":{action_:["output",{type_:"bond",option:"-"}],nextState:"3"}},amount2:{"1|3":{action_:"a=",nextState:"a"}},letters:{"0|1|2|3|a|as|b|p|bp|o":{action_:"o=",nextState:"o"},"q|dq":{action_:["output","o="],nextState:"o"},"d|D|qd|qD":{action_:"o after d",nextState:"o"}},digits:{o:{action_:"q=",nextState:"q"},"d|D":{action_:"q=",nextState:"dq"},q:{action_:["output","o="],nextState:"o"},a:{action_:"o=",nextState:"o"}},"space A":{"b|p|bp":{}},space:{a:{nextState:"as"},0:{action_:"sb=false"},"1|2":{action_:"sb=true"},"r|rt|rd|rdt|rdq":{action_:"output",nextState:"0"},"*":{action_:["output","sb=true"],nextState:"1"}},"1st-level escape":{"1|2":{action_:["output",{type_:"insert+p1",option:"1st-level escape"}]},"*":{action_:["output",{type_:"insert+p1",option:"1st-level escape"}],nextState:"0"}},"[(...)]":{"r|rt":{action_:"rd=",nextState:"rd"},"rd|rdt":{action_:"rq=",nextState:"rdq"}},"...":{"o|d|D|dq|qd|qD":{action_:["output",{type_:"bond",option:"..."}],nextState:"3"},"*":{action_:[{type_:"output",option:1},{type_:"insert",option:"ellipsis"}],nextState:"1"}},". |* ":{"*":{action_:["output",{type_:"insert",option:"addition compound"}],nextState:"1"}},"state of aggregation $":{"*":{action_:["output","state of aggregation"],nextState:"1"}},"{[(":{"a|as|o":{action_:["o=","output","parenthesisLevel++"],nextState:"2"},"0|1|2|3":{action_:["o=","output","parenthesisLevel++"],nextState:"2"},"*":{action_:["output","o=","output","parenthesisLevel++"],nextState:"2"}},")]}":{"0|1|2|3|b|p|bp|o":{action_:["o=","parenthesisLevel--"],nextState:"o"},"a|as|d|D|q|qd|qD|dq":{action_:["output","o=","parenthesisLevel--"],nextState:"o"}},", ":{"*":{action_:["output","comma"],nextState:"0"}},"^_":{"*":{}},"^{(...)}|^($...$)":{"0|1|2|as":{action_:"b=",nextState:"b"},p:{action_:"b=",nextState:"bp"},"3|o":{action_:"d= kv",nextState:"D"},q:{action_:"d=",nextState:"qD"},"d|D|qd|qD|dq":{action_:["output","d="],nextState:"D"}},"^a|^\\x{}{}|^\\x{}|^\\x|'":{"0|1|2|as":{action_:"b=",nextState:"b"},p:{action_:"b=",nextState:"bp"},"3|o":{action_:"d= kv",nextState:"d"},q:{action_:"d=",nextState:"qd"},"d|qd|D|qD":{action_:"d="},dq:{action_:["output","d="],nextState:"d"}},"_{(state of aggregation)}$":{"d|D|q|qd|qD|dq":{action_:["output","q="],nextState:"q"}},"_{(...)}|_($...$)|_9|_\\x{}{}|_\\x{}|_\\x":{"0|1|2|as":{action_:"p=",nextState:"p"},b:{action_:"p=",nextState:"bp"},"3|o":{action_:"q=",nextState:"q"},"d|D":{action_:"q=",nextState:"dq"},"q|qd|qD|dq":{action_:["output","q="],nextState:"q"}},"=<>":{"0|1|2|3|a|as|o|q|d|D|qd|qD|dq":{action_:[{type_:"output",option:2},"bond"],nextState:"3"}},"#":{"0|1|2|3|a|as|o":{action_:[{type_:"output",option:2},{type_:"bond",option:"#"}],nextState:"3"}},"{}":{"*":{action_:{type_:"output",option:1},nextState:"1"}},"{...}":{"0|1|2|3|a|as|b|p|bp":{action_:"o=",nextState:"o"},"o|d|D|q|qd|qD|dq":{action_:["output","o="],nextState:"o"}},"$...$":{a:{action_:"a="},"0|1|2|3|as|b|p|bp|o":{action_:"o=",nextState:"o"},"as|o":{action_:"o="},"q|d|D|qd|qD|dq":{action_:["output","o="],nextState:"o"}},"\\bond{(...)}":{"*":{action_:[{type_:"output",option:2},"bond"],nextState:"3"}},"\\frac{(...)}":{"*":{action_:[{type_:"output",option:1},"frac-output"],nextState:"3"}},"\\overset{(...)}":{"*":{action_:[{type_:"output",option:2},"overset-output"],nextState:"3"}},"\\underset{(...)}":{"*":{action_:[{type_:"output",option:2},"underset-output"],nextState:"3"}},"\\underbrace{(...)}":{"*":{action_:[{type_:"output",option:2},"underbrace-output"],nextState:"3"}},"\\color{(...)}{(...)}1|\\color(...){(...)}2":{"*":{action_:[{type_:"output",option:2},"color-output"],nextState:"3"}},"\\color{(...)}0":{"*":{action_:[{type_:"output",option:2},"color0-output"]}},"\\ce{(...)}":{"*":{action_:[{type_:"output",option:2},"ce"],nextState:"3"}},"\\,":{"*":{action_:[{type_:"output",option:1},"copy"],nextState:"1"}},"\\x{}{}|\\x{}|\\x":{"0|1|2|3|a|as|b|p|bp|o|c0":{action_:["o=","output"],nextState:"3"},"*":{action_:["output","o=","output"],nextState:"3"}},others:{"*":{action_:[{type_:"output",option:1},"copy"],nextState:"3"}},else2:{a:{action_:"a to o",nextState:"o",revisit:true},as:{action_:["output","sb=true"],nextState:"1",revisit:true},"r|rt|rd|rdt|rdq":{action_:["output"],nextState:"0",revisit:true},"*":{action_:["output","copy"],nextState:"3"}}}),actions:{"o after d":function(e,t){var n;if((e.d||"").match(/^[0-9]+$/)){var r=e.d;e.d=undefined;n=this["output"](e);e.b=r}else{n=this["output"](e)}mhchemParser.actions["o="](e,t);return n},"d= kv":function(e,t){e.d=t;e.dType="kv"},"charge or bond":function(e,t){if(e["beginsWithBond"]){var n=[];mhchemParser.concatArray(n,this["output"](e));mhchemParser.concatArray(n,mhchemParser.actions["bond"](e,t,"-"));return n}else{e.d=t}},"- after o/d":function(e,t,n){var r=mhchemParser.patterns.match_("orbital",e.o||"");var o=mhchemParser.patterns.match_("one lowercase greek letter $",e.o||"");var i=mhchemParser.patterns.match_("one lowercase latin letter $",e.o||"");var s=mhchemParser.patterns.match_("$one lowercase latin letter$ $",e.o||"");var a=t==="-"&&(r&&r.remainder===""||o||i||s);if(a&&!e.a&&!e.b&&!e.p&&!e.d&&!e.q&&!r&&i){e.o="$"+e.o+"$"}var l=[];if(a){mhchemParser.concatArray(l,this["output"](e));l.push({type_:"hyphen"})}else{r=mhchemParser.patterns.match_("digits",e.d||"");if(n&&r&&r.remainder===""){mhchemParser.concatArray(l,mhchemParser.actions["d="](e,t));mhchemParser.concatArray(l,this["output"](e))}else{mhchemParser.concatArray(l,this["output"](e));mhchemParser.concatArray(l,mhchemParser.actions["bond"](e,t,"-"))}}return l},"a to o":function(e){e.o=e.a;e.a=undefined},"sb=true":function(e){e.sb=true},"sb=false":function(e){e.sb=false},"beginsWithBond=true":function(e){e["beginsWithBond"]=true},"beginsWithBond=false":function(e){e["beginsWithBond"]=false},"parenthesisLevel++":function(e){e["parenthesisLevel"]++},"parenthesisLevel--":function(e){e["parenthesisLevel"]--},"state of aggregation":function(e,t){return{type_:"state of aggregation",p1:mhchemParser.go(t,"o")}},comma:function(e,t){var n=t.replace(/\s*$/,"");var r=n!==t;if(r&&e["parenthesisLevel"]===0){return{type_:"comma enumeration L",p1:n}}else{return{type_:"comma enumeration M",p1:n}}},output:function(e,t,n){var r;if(!e.r){r=[];if(!e.a&&!e.b&&!e.p&&!e.o&&!e.q&&!e.d&&!n);else{if(e.sb){r.push({type_:"entitySkip"})}if(!e.o&&!e.q&&!e.d&&!e.b&&!e.p&&n!==2){e.o=e.a;e.a=undefined}else if(!e.o&&!e.q&&!e.d&&(e.b||e.p)){e.o=e.a;e.d=e.b;e.q=e.p;e.a=e.b=e.p=undefined}else{if(e.o&&e.dType==="kv"&&mhchemParser.patterns.match_("d-oxidation$",e.d||"")){e.dType="oxidation"}else if(e.o&&e.dType==="kv"&&!e.q){e.dType=undefined}}r.push({type_:"chemfive",a:mhchemParser.go(e.a,"a"),b:mhchemParser.go(e.b,"bd"),p:mhchemParser.go(e.p,"pq"),o:mhchemParser.go(e.o,"o"),q:mhchemParser.go(e.q,"pq"),d:mhchemParser.go(e.d,e.dType==="oxidation"?"oxidation":"bd"),dType:e.dType})}}else{var o;if(e.rdt==="M"){o=mhchemParser.go(e.rd,"tex-math")}else if(e.rdt==="T"){o=[{type_:"text",p1:e.rd||""}]}else{o=mhchemParser.go(e.rd)}var i;if(e.rqt==="M"){i=mhchemParser.go(e.rq,"tex-math")}else if(e.rqt==="T"){i=[{type_:"text",p1:e.rq||""}]}else{i=mhchemParser.go(e.rq)}r={type_:"arrow",r:e.r,rd:o,rq:i}}for(var s in e){if(s!=="parenthesisLevel"&&s!=="beginsWithBond"){delete e[s]}}return r},"oxidation-output":function(e,t){var n=["{"];mhchemParser.concatArray(n,mhchemParser.go(t,"oxidation"));n.push("}");return n},"frac-output":function(e,t){return{type_:"frac-ce",p1:mhchemParser.go(t[0]),p2:mhchemParser.go(t[1])}},"overset-output":function(e,t){return{type_:"overset",p1:mhchemParser.go(t[0]),p2:mhchemParser.go(t[1])}},"underset-output":function(e,t){return{type_:"underset",p1:mhchemParser.go(t[0]),p2:mhchemParser.go(t[1])}},"underbrace-output":function(e,t){return{type_:"underbrace",p1:mhchemParser.go(t[0]),p2:mhchemParser.go(t[1])}},"color-output":function(e,t){return{type_:"color",color1:t[0],color2:mhchemParser.go(t[1])}},"r=":function(e,t){e.r=t},"rdt=":function(e,t){e.rdt=t},"rd=":function(e,t){e.rd=t},"rqt=":function(e,t){e.rqt=t},"rq=":function(e,t){e.rq=t},operator:function(e,t,n){return{type_:"operator",kind_:n||t}}}},a:{transitions:mhchemParser.createTransitions({empty:{"*":{}},"1/2$":{0:{action_:"1/2"}},else:{0:{nextState:"1",revisit:true}},"$(...)$":{"*":{action_:"tex-math tight",nextState:"1"}},",":{"*":{action_:{type_:"insert",option:"commaDecimal"}}},else2:{"*":{action_:"copy"}}}),actions:{}},o:{transitions:mhchemParser.createTransitions({empty:{"*":{}},"1/2$":{0:{action_:"1/2"}},else:{0:{nextState:"1",revisit:true}},letters:{"*":{action_:"rm"}},"\\ca":{"*":{action_:{type_:"insert",option:"circa"}}},"\\x{}{}|\\x{}|\\x":{"*":{action_:"copy"}},"${(...)}$|$(...)$":{"*":{action_:"tex-math"}},"{(...)}":{"*":{action_:"{text}"}},else2:{"*":{action_:"copy"}}}),actions:{}},text:{transitions:mhchemParser.createTransitions({empty:{"*":{action_:"output"}},"{...}":{"*":{action_:"text="}},"${(...)}$|$(...)$":{"*":{action_:"tex-math"}},"\\greek":{"*":{action_:["output","rm"]}},"\\,|\\x{}{}|\\x{}|\\x":{"*":{action_:["output","copy"]}},else:{"*":{action_:"text="}}}),actions:{output:function(e){if(e.text_){var t={type_:"text",p1:e.text_};for(var n in e){delete e[n]}return t}}}},pq:{transitions:mhchemParser.createTransitions({empty:{"*":{}},"state of aggregation $":{"*":{action_:"state of aggregation"}},i$:{0:{nextState:"!f",revisit:true}},"(KV letters),":{0:{action_:"rm",nextState:"0"}},formula$:{0:{nextState:"f",revisit:true}},"1/2$":{0:{action_:"1/2"}},else:{0:{nextState:"!f",revisit:true}},"${(...)}$|$(...)$":{"*":{action_:"tex-math"}},"{(...)}":{"*":{action_:"text"}},"a-z":{f:{action_:"tex-math"}},letters:{"*":{action_:"rm"}},"-9.,9":{"*":{action_:"9,9"}},",":{"*":{action_:{type_:"insert+p1",option:"comma enumeration S"}}},"\\color{(...)}{(...)}1|\\color(...){(...)}2":{"*":{action_:"color-output"}},"\\color{(...)}0":{"*":{action_:"color0-output"}},"\\ce{(...)}":{"*":{action_:"ce"}},"\\,|\\x{}{}|\\x{}|\\x":{"*":{action_:"copy"}},else2:{"*":{action_:"copy"}}}),actions:{"state of aggregation":function(e,t){return{type_:"state of aggregation subscript",p1:mhchemParser.go(t,"o")}},"color-output":function(e,t){return{type_:"color",color1:t[0],color2:mhchemParser.go(t[1],"pq")}}}},bd:{transitions:mhchemParser.createTransitions({empty:{"*":{}},x$:{0:{nextState:"!f",revisit:true}},formula$:{0:{nextState:"f",revisit:true}},else:{0:{nextState:"!f",revisit:true}},"-9.,9 no missing 0":{"*":{action_:"9,9"}},".":{"*":{action_:{type_:"insert",option:"electron dot"}}},"a-z":{f:{action_:"tex-math"}},x:{"*":{action_:{type_:"insert",option:"KV x"}}},letters:{"*":{action_:"rm"}},"'":{"*":{action_:{type_:"insert",option:"prime"}}},"${(...)}$|$(...)$":{"*":{action_:"tex-math"}},"{(...)}":{"*":{action_:"text"}},"\\color{(...)}{(...)}1|\\color(...){(...)}2":{"*":{action_:"color-output"}},"\\color{(...)}0":{"*":{action_:"color0-output"}},"\\ce{(...)}":{"*":{action_:"ce"}},"\\,|\\x{}{}|\\x{}|\\x":{"*":{action_:"copy"}},else2:{"*":{action_:"copy"}}}),actions:{"color-output":function(e,t){return{type_:"color",color1:t[0],color2:mhchemParser.go(t[1],"bd")}}}},oxidation:{transitions:mhchemParser.createTransitions({empty:{"*":{}},"roman numeral":{"*":{action_:"roman-numeral"}},"${(...)}$|$(...)$":{"*":{action_:"tex-math"}},else:{"*":{action_:"copy"}}}),actions:{"roman-numeral":function(e,t){return{type_:"roman numeral",p1:t||""}}}},"tex-math":{transitions:mhchemParser.createTransitions({empty:{"*":{action_:"output"}},"\\ce{(...)}":{"*":{action_:["output","ce"]}},"{...}|\\,|\\x{}{}|\\x{}|\\x":{"*":{action_:"o="}},else:{"*":{action_:"o="}}}),actions:{output:function(e){if(e.o){var t={type_:"tex-math",p1:e.o};for(var n in e){delete e[n]}return t}}}},"tex-math tight":{transitions:mhchemParser.createTransitions({empty:{"*":{action_:"output"}},"\\ce{(...)}":{"*":{action_:["output","ce"]}},"{...}|\\,|\\x{}{}|\\x{}|\\x":{"*":{action_:"o="}},"-|+":{"*":{action_:"tight operator"}},else:{"*":{action_:"o="}}}),actions:{"tight operator":function(e,t){e.o=(e.o||"")+"{"+t+"}"},output:function(e){if(e.o){var t={type_:"tex-math",p1:e.o};for(var n in e){delete e[n]}return t}}}},"9,9":{transitions:mhchemParser.createTransitions({empty:{"*":{}},",":{"*":{action_:"comma"}},else:{"*":{action_:"copy"}}}),actions:{comma:function(){return{type_:"commaDecimal"}}}},pu:{transitions:mhchemParser.createTransitions({empty:{"*":{action_:"output"}},space$:{"*":{action_:["output","space"]}},"{[(|)]}":{"0|a":{action_:"copy"}},"(-)(9)^(-9)":{0:{action_:"number^",nextState:"a"}},"(-)(9.,9)(e)(99)":{0:{action_:"enumber",nextState:"a"}},space:{"0|a":{}},"pm-operator":{"0|a":{action_:{type_:"operator",option:"\\pm"},nextState:"0"}},operator:{"0|a":{action_:"copy",nextState:"0"}},"//":{d:{action_:"o=",nextState:"/"}},"/":{d:{action_:"o=",nextState:"/"}},"{...}|else":{"0|d":{action_:"d=",nextState:"d"},a:{action_:["space","d="],nextState:"d"},"/|q":{action_:"q=",nextState:"q"}}}),actions:{enumber:function(e,t){var n=[];if(t[0]==="+-"||t[0]==="+/-"){n.push("\\pm ")}else if(t[0]){n.push(t[0])}if(t[1]){mhchemParser.concatArray(n,mhchemParser.go(t[1],"pu-9,9"));if(t[2]){if(t[2].match(/[,.]/)){mhchemParser.concatArray(n,mhchemParser.go(t[2],"pu-9,9"))}else{n.push(t[2])}}t[3]=t[4]||t[3];if(t[3]){t[3]=t[3].trim();if(t[3]==="e"||t[3].substr(0,1)==="*"){n.push({type_:"cdot"})}else{n.push({type_:"times"})}}}if(t[3]){n.push("10^{"+t[5]+"}")}return n},"number^":function(e,t){var n=[];if(t[0]==="+-"||t[0]==="+/-"){n.push("\\pm ")}else if(t[0]){n.push(t[0])}mhchemParser.concatArray(n,mhchemParser.go(t[1],"pu-9,9"));n.push("^{"+t[2]+"}");return n},operator:function(e,t,n){return{type_:"operator",kind_:n||t}},space:function(){return{type_:"pu-space-1"}},output:function(e){var t;var n=mhchemParser.patterns.match_("{(...)}",e.d||"");if(n&&n.remainder===""){e.d=n.match_}var r=mhchemParser.patterns.match_("{(...)}",e.q||"");if(r&&r.remainder===""){e.q=r.match_}if(e.d){e.d=e.d.replace(/\u00B0C|\^oC|\^{o}C/g,"{}^{\\circ}C");e.d=e.d.replace(/\u00B0F|\^oF|\^{o}F/g,"{}^{\\circ}F")}if(e.q){e.q=e.q.replace(/\u00B0C|\^oC|\^{o}C/g,"{}^{\\circ}C");e.q=e.q.replace(/\u00B0F|\^oF|\^{o}F/g,"{}^{\\circ}F");var o={d:mhchemParser.go(e.d,"pu"),q:mhchemParser.go(e.q,"pu")};if(e.o==="//"){t={type_:"pu-frac",p1:o.d,p2:o.q}}else{t=o.d;if(o.d.length>1||o.q.length>1){t.push({type_:" / "})}else{t.push({type_:"/"})}mhchemParser.concatArray(t,o.q)}}else{t=mhchemParser.go(e.d,"pu-2")}for(var i in e){delete e[i]}return t}}},"pu-2":{transitions:mhchemParser.createTransitions({empty:{"*":{action_:"output"}},"*":{"*":{action_:["output","cdot"],nextState:"0"}},"\\x":{"*":{action_:"rm="}},space:{"*":{action_:["output","space"],nextState:"0"}},"^{(...)}|^(-1)":{1:{action_:"^(-1)"}},"-9.,9":{0:{action_:"rm=",nextState:"0"},1:{action_:"^(-1)",nextState:"0"}},"{...}|else":{"*":{action_:"rm=",nextState:"1"}}}),actions:{cdot:function(){return{type_:"tight cdot"}},"^(-1)":function(e,t){e.rm+="^{"+t+"}"},space:function(){return{type_:"pu-space-2"}},output:function(e){var t=[];if(e.rm){var n=mhchemParser.patterns.match_("{(...)}",e.rm||"");if(n&&n.remainder===""){t=mhchemParser.go(n.match_,"pu")}else{t={type_:"rm",p1:e.rm}}}for(var r in e){delete e[r]}return t}}},"pu-9,9":{transitions:mhchemParser.createTransitions({empty:{0:{action_:"output-0"},o:{action_:"output-o"}},",":{0:{action_:["output-0","comma"],nextState:"o"}},".":{0:{action_:["output-0","copy"],nextState:"o"}},else:{"*":{action_:"text="}}}),actions:{comma:function(){return{type_:"commaDecimal"}},"output-0":function(e){var t=[];e.text_=e.text_||"";if(e.text_.length>4){var n=e.text_.length%3;if(n===0){n=3}for(var r=e.text_.length-3;r>0;r-=3){t.push(e.text_.substr(r,3));t.push({type_:"1000 separator"})}t.push(e.text_.substr(0,n));t.reverse()}else{t.push(e.text_)}for(var o in e){delete e[o]}return t},"output-o":function(e){var t=[];e.text_=e.text_||"";if(e.text_.length>4){var n=e.text_.length-3;for(var r=0;r<n;r+=3){t.push(e.text_.substr(r,3));t.push({type_:"1000 separator"})}t.push(e.text_.substr(r))}else{t.push(e.text_)}for(var o in e){delete e[o]}return t}}}};var texify={go:function(e,t){if(!e){return""}var n="";var r=false;for(var o=0;o<e.length;o++){var i=e[o];if(typeof i==="string"){n+=i}else{n+=texify._go2(i);if(i.type_==="1st-level escape"){r=true}}}if(!t&&!r&&n){n="{"+n+"}"}return n},_goInner:function(e){if(!e){return e}return texify.go(e,true)},_go2:function(e){var t;switch(e.type_){case"chemfive":t="";var n={a:texify._goInner(e.a),b:texify._goInner(e.b),p:texify._goInner(e.p),o:texify._goInner(e.o),q:texify._goInner(e.q),d:texify._goInner(e.d)};if(n.a){if(n.a.match(/^[+\-]/)){n.a="{"+n.a+"}"}t+=n.a+"\\,"}if(n.b||n.p){t+="{\\vphantom{X}}";t+="^{\\hphantom{"+(n.b||"")+"}}_{\\hphantom{"+(n.p||"")+"}}";t+="{\\vphantom{X}}";t+="^{\\vphantom{2}\\mathllap{"+(n.b||"")+"}}";t+="_{\\vphantom{2}\\mathllap{"+(n.p||"")+"}}"}if(n.o){if(n.o.match(/^[+\-]/)){n.o="{"+n.o+"}"}t+=n.o}if(e.dType==="kv"){if(n.d||n.q){t+="{\\vphantom{X}}"}if(n.d){t+="^{"+n.d+"}"}if(n.q){t+="_{"+n.q+"}"}}else if(e.dType==="oxidation"){if(n.d){t+="{\\vphantom{X}}";t+="^{"+n.d+"}"}if(n.q){t+="{{}}";t+="_{"+n.q+"}"}}else{if(n.q){t+="{{}}";t+="_{"+n.q+"}"}if(n.d){t+="{{}}";t+="^{"+n.d+"}"}}break;case"rm":t="\\mathrm{"+e.p1+"}";break;case"text":if(e.p1.match(/[\^_]/)){e.p1=e.p1.replace(" ","~").replace("-","\\text{-}");t="\\mathrm{"+e.p1+"}"}else{t="\\text{"+e.p1+"}"}break;case"roman numeral":t="\\mathrm{"+e.p1+"}";break;case"state of aggregation":t="\\mskip2mu "+texify._goInner(e.p1);break;case"state of aggregation subscript":t="\\mskip1mu "+texify._goInner(e.p1);break;case"bond":t=texify._getBond(e.kind_);if(!t){throw["MhchemErrorBond","mhchem Error. Unknown bond type ("+e.kind_+")"]}break;case"frac":var r="\\frac{"+e.p1+"}{"+e.p2+"}";t="\\mathchoice{\\textstyle"+r+"}{"+r+"}{"+r+"}{"+r+"}";break;case"pu-frac":var o="\\frac{"+texify._goInner(e.p1)+"}{"+texify._goInner(e.p2)+"}";t="\\mathchoice{\\textstyle"+o+"}{"+o+"}{"+o+"}{"+o+"}";break;case"tex-math":t=e.p1+" ";break;case"frac-ce":t="\\frac{"+texify._goInner(e.p1)+"}{"+texify._goInner(e.p2)+"}";break;case"overset":t="\\overset{"+texify._goInner(e.p1)+"}{"+texify._goInner(e.p2)+"}";break;case"underset":t="\\underset{"+texify._goInner(e.p1)+"}{"+texify._goInner(e.p2)+"}";break;case"underbrace":t="\\underbrace{"+texify._goInner(e.p1)+"}_{"+texify._goInner(e.p2)+"}";break;case"color":t="{\\color{"+e.color1+"}{"+texify._goInner(e.color2)+"}}";break;case"color0":t="\\color{"+e.color+"}";break;case"arrow":var i={rd:texify._goInner(e.rd),rq:texify._goInner(e.rq)};var s=texify._getArrow(e.r);if(i.rq){s+="[{\\rm "+i.rq+"}]"}if(i.rd){s+="{\\rm "+i.rd+"}"}else{s+="{}"}t=s;break;case"operator":t=texify._getOperator(e.kind_);break;case"1st-level escape":t=e.p1+" ";break;case"space":t=" ";break;case"entitySkip":t="~";break;case"pu-space-1":t="~";break;case"pu-space-2":t="\\mkern3mu ";break;case"1000 separator":t="\\mkern2mu ";break;case"commaDecimal":t="{,}";break;case"comma enumeration L":t="{"+e.p1+"}\\mkern6mu ";break;case"comma enumeration M":t="{"+e.p1+"}\\mkern3mu ";break;case"comma enumeration S":t="{"+e.p1+"}\\mkern1mu ";break;case"hyphen":t="\\text{-}";break;case"addition compound":t="\\,{\\cdot}\\,";break;case"electron dot":t="\\mkern1mu \\text{\\textbullet}\\mkern1mu ";break;case"KV x":t="{\\times}";break;case"prime":t="\\prime ";break;case"cdot":t="\\cdot ";break;case"tight cdot":t="\\mkern1mu{\\cdot}\\mkern1mu ";break;case"times":t="\\times ";break;case"circa":t="{\\sim}";break;case"^":t="uparrow";break;case"v":t="downarrow";break;case"ellipsis":t="\\ldots ";break;case"/":t="/";break;case" / ":t="\\,/\\,";break;default:throw["MhchemBugT","mhchem bug T. Please report."]}return t},_getArrow:function(e){switch(e){case"->":return"\\yields";case"":return"\\yields";case"":return"\\yields";case"<-":return"\\yieldsLeft";case"<->":return"\\mesomerism";case"<--\x3e":return"\\yieldsLeftRight";case"<=>":return"\\equilibrium";case"":return"\\equilibrium";case"<=>>":return"\\equilibriumRight";case"<<=>":return"\\equilibriumLeft";default:throw["MhchemBugT","mhchem bug T. Please report."]}},_getBond:function(e){switch(e){case"-":return"{-}";case"1":return"{-}";case"=":return"{=}";case"2":return"{=}";case"#":return"{\\equiv}";case"3":return"{\\equiv}";case"~":return"{\\tripleDash}";case"~-":return"{\\tripleDashOverLine}";case"~=":return"{\\tripleDashOverDoubleLine}";case"~--":return"{\\tripleDashOverDoubleLine}";case"-~-":return"{\\tripleDashBetweenDoubleLine}";case"...":return"{{\\cdot}{\\cdot}{\\cdot}}";case"....":return"{{\\cdot}{\\cdot}{\\cdot}{\\cdot}}";case"->":return"{\\rightarrow}";case"<-":return"{\\leftarrow}";case"<":return"{<}";case">":return"{>}";default:throw["MhchemBugT","mhchem bug T. Please report."]}},_getOperator:function(e){switch(e){case"+":return" {}+{} ";case"-":return" {}-{} ";case"=":return" {}={} ";case"<":return" {}<{} ";case">":return" {}>{} ";case"<<":return" {}\\ll{} ";case">>":return" {}\\gg{} ";case"\\pm":return" {}\\pm{} ";case"\\approx":return" {}\\approx{} ";case"$\\approx$":return" {}\\approx{} ";case"v":return" \\downarrow{} ";case"(v)":return" \\downarrow{} ";case"^":return" \\uparrow{} ";case"(^)":return" \\uparrow{} ";default:throw["MhchemBugT","mhchem bug T. Please report."]}}};defineMacro("\\darr","\\downarrow");defineMacro("\\dArr","\\Downarrow");defineMacro("\\Darr","\\Downarrow");defineMacro("\\lang","\\langle");defineMacro("\\rang","\\rangle");defineMacro("\\uarr","\\uparrow");defineMacro("\\uArr","\\Uparrow");defineMacro("\\Uarr","\\Uparrow");defineMacro("\\N","\\mathbb{N}");defineMacro("\\R","\\mathbb{R}");defineMacro("\\Z","\\mathbb{Z}");defineMacro("\\alef","\\aleph");defineMacro("\\alefsym","\\aleph");defineMacro("\\bull","\\bullet");defineMacro("\\clubs","\\clubsuit");defineMacro("\\cnums","\\mathbb{C}");defineMacro("\\Complex","\\mathbb{C}");defineMacro("\\Dagger","\\ddagger");defineMacro("\\diamonds","\\diamondsuit");defineMacro("\\empty","\\emptyset");defineMacro("\\exist","\\exists");defineMacro("\\harr","\\leftrightarrow");defineMacro("\\hArr","\\Leftrightarrow");defineMacro("\\Harr","\\Leftrightarrow");defineMacro("\\hearts","\\heartsuit");defineMacro("\\image","\\Im");defineMacro("\\infin","\\infty");defineMacro("\\isin","\\in");defineMacro("\\larr","\\leftarrow");defineMacro("\\lArr","\\Leftarrow");defineMacro("\\Larr","\\Leftarrow");defineMacro("\\lrarr","\\leftrightarrow");defineMacro("\\lrArr","\\Leftrightarrow");defineMacro("\\Lrarr","\\Leftrightarrow");defineMacro("\\natnums","\\mathbb{N}");defineMacro("\\plusmn","\\pm");defineMacro("\\rarr","\\rightarrow");defineMacro("\\rArr","\\Rightarrow");defineMacro("\\Rarr","\\Rightarrow");defineMacro("\\real","\\Re");defineMacro("\\reals","\\mathbb{R}");defineMacro("\\Reals","\\mathbb{R}");defineMacro("\\sdot","\\cdot");defineMacro("\\sect","\\S");defineMacro("\\spades","\\spadesuit");defineMacro("\\sub","\\subset");defineMacro("\\sube","\\subseteq");defineMacro("\\supe","\\supseteq");defineMacro("\\thetasym","\\vartheta");defineMacro("\\weierp","\\wp");defineMacro("\\quantity","{\\left\\{ #1 \\right\\}}");defineMacro("\\qty","{\\left\\{ #1 \\right\\}}");defineMacro("\\pqty","{\\left( #1 \\right)}");defineMacro("\\bqty","{\\left[ #1 \\right]}");defineMacro("\\vqty","{\\left\\vert #1 \\right\\vert}");defineMacro("\\Bqty","{\\left\\{ #1 \\right\\}}");defineMacro("\\absolutevalue","{\\left\\vert #1 \\right\\vert}");defineMacro("\\abs","{\\left\\vert #1 \\right\\vert}");defineMacro("\\norm","{\\left\\Vert #1 \\right\\Vert}");defineMacro("\\evaluated","{\\left.#1 \\right\\vert}");defineMacro("\\eval","{\\left.#1 \\right\\vert}");defineMacro("\\order","{\\mathcal{O} \\left( #1 \\right)}");defineMacro("\\commutator","{\\left[ #1 , #2 \\right]}");defineMacro("\\comm","{\\left[ #1 , #2 \\right]}");defineMacro("\\anticommutator","{\\left\\{ #1 , #2 \\right\\}}");defineMacro("\\acomm","{\\left\\{ #1 , #2 \\right\\}}");defineMacro("\\poissonbracket","{\\left\\{ #1 , #2 \\right\\}}");defineMacro("\\pb","{\\left\\{ #1 , #2 \\right\\}}");defineMacro("\\vectorbold","{\\boldsymbol{ #1 }}");defineMacro("\\vb","{\\boldsymbol{ #1 }}");defineMacro("\\vectorarrow","{\\vec{\\boldsymbol{ #1 }}}");defineMacro("\\va","{\\vec{\\boldsymbol{ #1 }}}");defineMacro("\\vectorunit","{{\\boldsymbol{\\hat{ #1 }}}}");defineMacro("\\vu","{{\\boldsymbol{\\hat{ #1 }}}}");defineMacro("\\dotproduct","\\mathbin{\\boldsymbol\\cdot}");defineMacro("\\vdot","{\\boldsymbol\\cdot}");defineMacro("\\crossproduct","\\mathbin{\\boldsymbol\\times}");defineMacro("\\cross","\\mathbin{\\boldsymbol\\times}");defineMacro("\\cp","\\mathbin{\\boldsymbol\\times}");defineMacro("\\gradient","{\\boldsymbol\\nabla}");defineMacro("\\grad","{\\boldsymbol\\nabla}");defineMacro("\\divergence","{\\grad\\vdot}");defineMacro("\\curl","{\\grad\\cross}");defineMacro("\\laplacian","\\nabla^2");defineMacro("\\tr","{\\operatorname{tr}}");defineMacro("\\Tr","{\\operatorname{Tr}}");defineMacro("\\rank","{\\operatorname{rank}}");defineMacro("\\erf","{\\operatorname{erf}}");defineMacro("\\Res","{\\operatorname{Res}}");defineMacro("\\principalvalue","{\\mathcal{P}}");defineMacro("\\pv","{\\mathcal{P}}");defineMacro("\\PV","{\\operatorname{P.V.}}");defineMacro("\\qqtext","{\\quad\\text{ #1 }\\quad}");defineMacro("\\qq","{\\quad\\text{ #1 }\\quad}");defineMacro("\\qcomma","{\\text{,}\\quad}");defineMacro("\\qc","{\\text{,}\\quad}");defineMacro("\\qcc","{\\quad\\text{c.c.}\\quad}");defineMacro("\\qif","{\\quad\\text{if}\\quad}");defineMacro("\\qthen","{\\quad\\text{then}\\quad}");defineMacro("\\qelse","{\\quad\\text{else}\\quad}");defineMacro("\\qotherwise","{\\quad\\text{otherwise}\\quad}");defineMacro("\\qunless","{\\quad\\text{unless}\\quad}");defineMacro("\\qgiven","{\\quad\\text{given}\\quad}");defineMacro("\\qusing","{\\quad\\text{using}\\quad}");defineMacro("\\qassume","{\\quad\\text{assume}\\quad}");defineMacro("\\qsince","{\\quad\\text{since}\\quad}");defineMacro("\\qlet","{\\quad\\text{let}\\quad}");defineMacro("\\qfor","{\\quad\\text{for}\\quad}");defineMacro("\\qall","{\\quad\\text{all}\\quad}");defineMacro("\\qeven","{\\quad\\text{even}\\quad}");defineMacro("\\qodd","{\\quad\\text{odd}\\quad}");defineMacro("\\qinteger","{\\quad\\text{integer}\\quad}");defineMacro("\\qand","{\\quad\\text{and}\\quad}");defineMacro("\\qor","{\\quad\\text{or}\\quad}");defineMacro("\\qas","{\\quad\\text{as}\\quad}");defineMacro("\\qin","{\\quad\\text{in}\\quad}");defineMacro("\\differential","{\\text{d}}");defineMacro("\\dd","{\\text{d}}");defineMacro("\\derivative","{\\frac{\\text{d}{ #1 }}{\\text{d}{ #2 }}}");defineMacro("\\dv","{\\frac{\\text{d}{ #1 }}{\\text{d}{ #2 }}}");defineMacro("\\partialderivative","{\\frac{\\partial{ #1 }}{\\partial{ #2 }}}");defineMacro("\\variation","{\\delta}");defineMacro("\\var","{\\delta}");defineMacro("\\functionalderivative","{\\frac{\\delta{ #1 }}{\\delta{ #2 }}}");defineMacro("\\fdv","{\\frac{\\delta{ #1 }}{\\delta{ #2 }}}");defineMacro("\\innerproduct","{\\left\\langle {#1} \\mid { #2} \\right\\rangle}");defineMacro("\\outerproduct","{\\left\\vert { #1 } \\right\\rangle\\left\\langle { #2} \\right\\vert}");defineMacro("\\dyad","{\\left\\vert { #1 } \\right\\rangle\\left\\langle { #2} \\right\\vert}");defineMacro("\\ketbra","{\\left\\vert { #1 } \\right\\rangle\\left\\langle { #2} \\right\\vert}");defineMacro("\\op","{\\left\\vert { #1 } \\right\\rangle\\left\\langle { #2} \\right\\vert}");defineMacro("\\expectationvalue","{\\left\\langle {#1 } \\right\\rangle}");defineMacro("\\expval","{\\left\\langle {#1 } \\right\\rangle}");defineMacro("\\ev","{\\left\\langle {#1 } \\right\\rangle}");defineMacro("\\matrixelement","{\\left\\langle{ #1 }\\right\\vert{ #2 }\\left\\vert{#3}\\right\\rangle}");defineMacro("\\matrixel","{\\left\\langle{ #1 }\\right\\vert{ #2 }\\left\\vert{#3}\\right\\rangle}");defineMacro("\\mel","{\\left\\langle{ #1 }\\right\\vert{ #2 }\\left\\vert{#3}\\right\\rangle}");function getHLines(e){const t=[];e.consumeSpaces();let n=e.fetch().text;if(n==="\\relax"){e.consume();e.consumeSpaces();n=e.fetch().text}while(n==="\\hline"||n==="\\hdashline"){e.consume();t.push(n==="\\hdashline");e.consumeSpaces();n=e.fetch().text}return t}const validateAmsEnvironmentContext=e=>{const t=e.parser.settings;if(!t.displayMode){throw new ParseError(`{${e.envName}} can be used only in display mode.`)}};const sizeRegEx$1=/([-+]?) *(\d+(?:\.\d*)?|\.\d+) *([a-z]{2})/;const arrayGaps=e=>{let t=e.get("\\arraystretch");if(typeof t!=="string"){t=stringFromArg(t.tokens)}t=isNaN(t)?null:Number(t);let n=e.get("\\arraycolsep");if(typeof n!=="string"){n=stringFromArg(n.tokens)}const r=sizeRegEx$1.exec(n);const o=r?{number:+(r[1]+r[2]),unit:r[3]}:null;return[t,o]};const getTag=(e,t,n)=>{let r;const o=e.tags.shift();if(o){if(o.body){r=buildExpressionRow(o.body,t,true);r.classes=["tml-tag"]}else{r=new mathMLTree.MathNode("mtext",[],[]);return r}}else if(e.envClasses.includes("multline")&&(e.leqno&&n!==0||!e.leqno&&n!==e.body.length-1)){r=new mathMLTree.MathNode("mtext",[],[]);return r}else{r=new mathMLTree.MathNode("mtext",[new Span(["tml-eqn"])])}return r};function parseArray(e,{cols:t,envClasses:n,addEqnNum:r,singleRow:o,emptySingleRow:i,maxNumCols:s,leqno:a,arraystretch:l,arraycolsep:c},d){e.gullet.beginGroup();if(!o){e.gullet.macros.set("\\cr","\\\\\\relax")}if(r){e.gullet.macros.set("\\tag","\\@ifstar\\envtag@literal\\envtag@paren");e.gullet.macros.set("\\envtag@paren","\\env@tag{{(\\text{#1})}}");e.gullet.macros.set("\\envtag@literal","\\env@tag{\\text{#1}}");e.gullet.macros.set("\\notag","\\env@notag");e.gullet.macros.set("\\nonumber","\\env@notag")}e.gullet.beginGroup();let u=[];const p=[u];const f=[];const h=[];let m;const g=[];g.push(getHLines(e));while(true){let t=e.parseExpression(false,o?"\\end":"\\\\");if(r&&!m){for(let e=0;e<t.length;e++){if(t[e].type==="envTag"||t[e].type==="noTag"){m=t[e].type==="envTag"?t.splice(e,1)[0].body.body[0]:{body:null};break}}}e.gullet.endGroup();e.gullet.beginGroup();t={type:"ordgroup",mode:e.mode,body:t,semisimple:true};u.push(t);const a=e.fetch().text;if(a==="&"){if(s&&u.length===s){if(n.includes("array")){if(e.settings.strict){throw new ParseError("Too few columns "+"specified in the {array} column argument.",e.nextToken)}}else if(s===2){throw new ParseError("The split environment accepts no more than two columns",e.nextToken)}else{throw new ParseError("The equation environment accepts only one column",e.nextToken)}}e.consume()}else if(a==="\\end"){if(u.length===1&&t.body.length===0&&(p.length>1||!i)){p.pop()}if(g.length<p.length+1){g.push([])}break}else if(a==="\\\\"){e.consume();let t;if(e.gullet.future().text!==" "){t=e.parseSizeGroup(true)}f.push(t?t.value:null);h.push(m);g.push(getHLines(e));u=[];m=null;p.push(u)}else{throw new ParseError("Expected & or \\\\ or \\cr or \\end",e.nextToken)}}e.gullet.endGroup();e.gullet.endGroup();h.push(m);return{type:"array",mode:e.mode,body:p,cols:t,rowGaps:f,hLinesBeforeRow:g,envClasses:n,addEqnNum:r,scriptLevel:d,tags:h,leqno:a,arraystretch:l,arraycolsep:c}}function dCellStyle(e){return e.slice(0,1)==="d"?"display":"text"}const alignMap={c:"center ",l:"left ",r:"right "};const glue=e=>{const t=new mathMLTree.MathNode("mtd",[]);t.style={padding:"0",width:"50%"};if(e.envClasses.includes("multline")){t.style.width="7.5%"}return t};const mathmlBuilder$7=function(e,t){const n=[];const r=e.body.length;const o=e.hLinesBeforeRow;for(let i=0;i<r;i++){const s=e.body[i];const a=[];const l=e.scriptLevel==="text"?StyleLevel.TEXT:e.scriptLevel==="script"?StyleLevel.SCRIPT:StyleLevel.DISPLAY;for(let n=0;n<s.length;n++){const o=new mathMLTree.MathNode("mtd",[buildGroup$1(s[n],t.withLevel(l))]);if(e.envClasses.includes("multline")){const e=i===0?"left":i===r-1?"right":"center";o.setAttribute("columnalign",e);if(e!=="center"){o.classes.push("tml-"+e)}}a.push(o)}if(e.addEqnNum){a.unshift(glue(e));a.push(glue(e));const n=getTag(e,t.withLevel(l),i);if(e.leqno){a[0].children.push(n);a[0].classes.push("tml-left")}else{a[a.length-1].children.push(n);a[a.length-1].classes.push("tml-right")}}const c=new mathMLTree.MathNode("mtr",a,[]);if(i===0&&o[0].length>0){if(o[0].length===2){c.children.forEach((e=>{e.style.borderTop="0.15em double"}))}else{c.children.forEach((e=>{e.style.borderTop=o[0][0]?"0.06em dashed":"0.06em solid"}))}}if(o[i+1].length>0){if(o[i+1].length===2){c.children.forEach((e=>{e.style.borderBottom="0.15em double"}))}else{c.children.forEach((e=>{e.style.borderBottom=o[i+1][0]?"0.06em dashed":"0.06em solid"}))}}n.push(c)}if(e.envClasses.length>0){let r=e.envClasses.includes("jot")?"0.7":e.envClasses.includes("small")?"0.35":"0.5";if(e.arraystretch&&e.arraystretch!==1){r=String(1.4*e.arraystretch-.8)}let o=e.envClasses.includes("abut")?"0":e.envClasses.includes("cases")?"0":e.envClasses.includes("small")?"0.1389":e.envClasses.includes("cd")?"0.25":"0.4";let i="em";if(e.arraycolsep){const n=calculateSize(e.arraycolsep,t);o=n.number;i=n.unit}const s=n.length===0?0:n[0].children.length;const a=(t,n)=>{if(t===0&&n===0){return"0"}if(t===s-1&&n===1){return"0"}if(e.envClasses[0]!=="align"){return o}if(n===1){return"0"}if(e.addEqnNum){return t%2?"1":"0"}else{return t%2?"0":"1"}};for(let e=0;e<n.length;e++){for(let t=0;t<n[e].children.length;t++){n[e].children[t].style.padding=`${r}ex ${a(t,1)}${i}`+` ${r}ex ${a(t,0)}${i}`}}const l=e.envClasses.includes("align")||e.envClasses.includes("alignat");for(let t=0;t<n.length;t++){const r=n[t];if(l){for(let e=0;e<r.children.length;e++){r.children[e].classes=["tml-"+(e%2?"left":"right")]}if(e.addEqnNum){const t=e.leqno?0:r.children.length-1;r.children[t].classes=["tml-"+(e.leqno?"left":"right")]}}if(r.children.length>1&&e.envClasses.includes("cases")){r.children[1].style.padding=r.children[1].style.padding.replace(/0em$/,"1em")}if(e.envClasses.includes("cases")||e.envClasses.includes("subarray")){for(const e of r.children){e.classes.push("tml-left")}}}}else{for(let e=0;e<n.length;e++){n[e].children[0].style.paddingLeft="0em";if(n[e].children.length===n[0].children.length){n[e].children[n[e].children.length-1].style.paddingRight="0em"}}}let i=new mathMLTree.MathNode("mtable",n);if(e.scriptLevel==="display"){i.setAttribute("displaystyle","true")}if(e.addEqnNum||e.envClasses.includes("multline")){i.style.width="100%"}let s="";if(e.cols&&e.cols.length>0){const t=e.cols;let n=false;let r=0;let o=t.length;while(t[r].type==="separator"){r+=1}while(t[o-1].type==="separator"){o-=1}if(t[0].type==="separator"){const e=t[1].type==="separator"?"0.15em double":t[0].separator==="|"?"0.06em solid ":"0.06em dashed ";for(const t of i.children){t.children[0].style.borderLeft=e}}let a=e.addEqnNum?0:-1;for(let e=r;e<o;e++){if(t[e].type==="align"){const r=alignMap[t[e].align];s+=r;a+=1;for(const e of i.children){if(r.trim()!=="center"&&a<e.children.length){e.children[a].classes=["tml-"+r.trim()]}}n=true}else if(t[e].type==="separator"){if(n){const n=t[e+1].type==="separator"?"0.15em double":t[e].separator==="|"?"0.06em solid":"0.06em dashed";for(const e of i.children){if(a<e.children.length){e.children[a].style.borderRight=n}}}n=false}}if(t[t.length-1].type==="separator"){const e=t[t.length-2].type==="separator"?"0.15em double":t[t.length-1].separator==="|"?"0.06em solid":"0.06em dashed";for(const t of i.children){t.children[t.children.length-1].style.borderRight=e;t.children[t.children.length-1].style.paddingRight="0.4em"}}}if(e.addEqnNum){s="left "+(s.length>0?s:"center ")+"right "}if(s){i.setAttribute("columnalign",s.trim())}if(e.envClasses.includes("small")){i=new mathMLTree.MathNode("mstyle",[i]);i.setAttribute("scriptlevel","1")}return i};const alignedHandler=function(e,t){if(e.envName.indexOf("ed")===-1){validateAmsEnvironmentContext(e)}const n=[];const r=parseArray(e.parser,{cols:n,addEqnNum:e.envName==="align"||e.envName==="alignat",emptySingleRow:true,envClasses:["abut","jot"],maxNumCols:e.envName==="split"?2:undefined,leqno:e.parser.settings.leqno},"display");let o;let i=0;const s=e.envName.indexOf("at")>-1;if(t[0]&&s){let e="";for(let n=0;n<t[0].body.length;n++){const r=assertNodeType(t[0].body[n],"textord");e+=r.text}if(isNaN(e)){throw new ParseError("The alignat enviroment requires a numeric first argument.")}o=Number(e);i=o*2}r.body.forEach((function(e){if(s){const t=e.length/2;if(o<t){throw new ParseError("Too many math in a row: "+`expected ${o}, but got ${t}`,e[0])}}else if(i<e.length){i=e.length}}));for(let e=0;e<i;++e){let t="r";if(e%2===1){t="l"}n[e]={type:"align",align:t}}if(e.envName==="split");else if(s){r.envClasses.push("alignat")}else{r.envClasses[0]="align"}return r};defineEnvironment({type:"array",names:["array","darray"],props:{numArgs:1},handler(e,t){const n=checkSymbolNodeType(t[0]);const r=n?[t[0]]:assertNodeType(t[0],"ordgroup").body;const o=r.map((function(e){const t=assertSymbolNodeType(e);const n=t.text;if("lcr".indexOf(n)!==-1){return{type:"align",align:n}}else if(n==="|"){return{type:"separator",separator:"|"}}else if(n===":"){return{type:"separator",separator:":"}}throw new ParseError("Unknown column alignment: "+n,e)}));const[i,s]=arrayGaps(e.parser.gullet.macros);const a={cols:o,envClasses:["array"],maxNumCols:o.length,arraystretch:i,arraycolsep:s};return parseArray(e.parser,a,dCellStyle(e.envName))},mathmlBuilder:mathmlBuilder$7});defineEnvironment({type:"array",names:["matrix","pmatrix","bmatrix","Bmatrix","vmatrix","Vmatrix","matrix*","pmatrix*","bmatrix*","Bmatrix*","vmatrix*","Vmatrix*"],props:{numArgs:0},handler(e){const t={matrix:null,pmatrix:["(",")"],bmatrix:["[","]"],Bmatrix:["\\{","\\}"],vmatrix:["|","|"],Vmatrix:["\\Vert","\\Vert"]}[e.envName.replace("*","")];let n="c";const r={envClasses:[],cols:[]};if(e.envName.charAt(e.envName.length-1)==="*"){const t=e.parser;t.consumeSpaces();if(t.fetch().text==="["){t.consume();t.consumeSpaces();n=t.fetch().text;if("lcr".indexOf(n)===-1){throw new ParseError("Expected l or c or r",t.nextToken)}t.consume();t.consumeSpaces();t.expect("]");t.consume();r.cols=[]}}const o=parseArray(e.parser,r,"text");o.cols=new Array(o.body[0].length).fill({type:"align",align:n});const[i,s]=arrayGaps(e.parser.gullet.macros);return t?{type:"leftright",mode:e.mode,body:[o],left:t[0],right:t[1],rightColor:undefined,arraystretch:i,arraycolsep:s}:o},mathmlBuilder:mathmlBuilder$7});defineEnvironment({type:"array",names:["smallmatrix"],props:{numArgs:0},handler(e){const t={type:"small"};const n=parseArray(e.parser,t,"script");n.envClasses=["small"];return n},mathmlBuilder:mathmlBuilder$7});defineEnvironment({type:"array",names:["subarray"],props:{numArgs:1},handler(e,t){const n=checkSymbolNodeType(t[0]);const r=n?[t[0]]:assertNodeType(t[0],"ordgroup").body;const o=r.map((function(e){const t=assertSymbolNodeType(e);const n=t.text;if("lc".indexOf(n)!==-1){return{type:"align",align:n}}throw new ParseError("Unknown column alignment: "+n,e)}));if(o.length>1){throw new ParseError("{subarray} can contain only one column")}let i={cols:o,envClasses:["small"]};i=parseArray(e.parser,i,"script");if(i.body.length>0&&i.body[0].length>1){throw new ParseError("{subarray} can contain only one column")}return i},mathmlBuilder:mathmlBuilder$7});defineEnvironment({type:"array",names:["cases","dcases","rcases","drcases"],props:{numArgs:0},handler(e){const t={cols:[],envClasses:["cases"]};const n=parseArray(e.parser,t,dCellStyle(e.envName));return{type:"leftright",mode:e.mode,body:[n],left:e.envName.indexOf("r")>-1?".":"\\{",right:e.envName.indexOf("r")>-1?"\\}":".",rightColor:undefined}},mathmlBuilder:mathmlBuilder$7});defineEnvironment({type:"array",names:["align","align*","aligned","split"],props:{numArgs:0},handler:alignedHandler,mathmlBuilder:mathmlBuilder$7});defineEnvironment({type:"array",names:["alignat","alignat*","alignedat"],props:{numArgs:1},handler:alignedHandler,mathmlBuilder:mathmlBuilder$7});defineEnvironment({type:"array",names:["gathered","gather","gather*"],props:{numArgs:0},handler(e){if(e.envName!=="gathered"){validateAmsEnvironmentContext(e)}const t={cols:[],envClasses:["abut","jot"],addEqnNum:e.envName==="gather",emptySingleRow:true,leqno:e.parser.settings.leqno};return parseArray(e.parser,t,"display")},mathmlBuilder:mathmlBuilder$7});defineEnvironment({type:"array",names:["equation","equation*"],props:{numArgs:0},handler(e){validateAmsEnvironmentContext(e);const t={addEqnNum:e.envName==="equation",emptySingleRow:true,singleRow:true,maxNumCols:1,envClasses:["align"],leqno:e.parser.settings.leqno};return parseArray(e.parser,t,"display")},mathmlBuilder:mathmlBuilder$7});defineEnvironment({type:"array",names:["multline","multline*"],props:{numArgs:0},handler(e){validateAmsEnvironmentContext(e);const t={addEqnNum:e.envName==="multline",maxNumCols:1,envClasses:["jot","multline"],leqno:e.parser.settings.leqno};return parseArray(e.parser,t,"display")},mathmlBuilder:mathmlBuilder$7});defineEnvironment({type:"array",names:["CD"],props:{numArgs:0},handler(e){validateAmsEnvironmentContext(e);return parseCD(e.parser)},mathmlBuilder:mathmlBuilder$7});defineFunction({type:"text",names:["\\hline","\\hdashline"],props:{numArgs:0,allowedInText:true,allowedInMath:true},handler(e,t){throw new ParseError(`${e.funcName} valid only within array environment`)}});const environments=_environments;defineFunction({type:"environment",names:["\\begin","\\end"],props:{numArgs:1,argTypes:["text"]},handler({parser:e,funcName:t},n){const r=n[0];if(r.type!=="ordgroup"){throw new ParseError("Invalid environment name",r)}let o="";for(let e=0;e<r.body.length;++e){o+=assertNodeType(r.body[e],"textord").text}if(t==="\\begin"){if(!Object.prototype.hasOwnProperty.call(environments,o)){throw new ParseError("No such environment: "+o,r)}const t=environments[o];const{args:n,optArgs:i}=e.parseArguments("\\begin{"+o+"}",t);const s={mode:e.mode,envName:o,parser:e};const a=t.handler(s,n,i);e.expect("\\end",false);const l=e.nextToken;const c=assertNodeType(e.parseFunction(),"environment");if(c.name!==o){throw new ParseError(`Mismatch: \\begin{${o}} matched by \\end{${c.name}}`,l)}return a}return{type:"environment",mode:e.mode,name:o,nameGroup:r}}});defineFunction({type:"envTag",names:["\\env@tag"],props:{numArgs:1,argTypes:["math"]},handler({parser:e},t){return{type:"envTag",mode:e.mode,body:t[0]}},mathmlBuilder(e,t){return new mathMLTree.MathNode("mrow")}});defineFunction({type:"noTag",names:["\\env@notag"],props:{numArgs:0},handler({parser:e}){return{type:"noTag",mode:e.mode}},mathmlBuilder(e,t){return new mathMLTree.MathNode("mrow")}});const isLongVariableName=(e,t)=>{if(t!=="mathrm"||e.body.type!=="ordgroup"||e.body.body.length===1){return false}if(e.body.body[0].type!=="mathord"){return false}for(let t=1;t<e.body.body.length;t++){const n=e.body.body[t].type;if(!(n==="mathord"||n==="textord"&&!isNaN(e.body.body[t].text))){return false}}return true};const mathmlBuilder$6=(e,t)=>{const n=e.font;const r=t.withFont(n);const o=buildGroup$1(e.body,r);if(o.children.length===0){return o}if(n==="boldsymbol"&&["mo","mpadded","mrow"].includes(o.type)){o.style.fontWeight="bold";return o}if(isLongVariableName(e,n)){const e=o.children[0].children[0];delete e.attributes.mathvariant;for(let t=1;t<o.children.length;t++){e.children[0].text+=o.children[t].type==="mn"?o.children[t].children[0].text:o.children[t].children[0].children[0].text}const t=new mathMLTree.MathNode("mtext",new mathMLTree.TextNode(""));return new mathMLTree.MathNode("mrow",[t,e])}let i=o.children[0].type==="mo";for(let e=1;e<o.children.length;e++){if(o.children[e].type==="mo"&&n==="boldsymbol"){o.children[e].style.fontWeight="bold"}if(o.children[e].type!=="mi"){i=false}const t=o.children[e].attributes&&o.children[e].attributes.mathvariant||"";if(t!=="normal"){i=false}}if(!i){return o}const s=o.children[0];for(let e=1;e<o.children.length;e++){s.children.push(o.children[e].children[0])}if(s.attributes.mathvariant&&s.attributes.mathvariant==="normal"){const e=new mathMLTree.MathNode("mtext",new mathMLTree.TextNode(""));return new mathMLTree.MathNode("mrow",[e,s])}return s};const fontAliases={"\\Bbb":"\\mathbb","\\bold":"\\mathbf","\\frak":"\\mathfrak","\\bm":"\\boldsymbol"};defineFunction({type:"font",names:["\\mathrm","\\mathit","\\mathbf","\\mathnormal","\\up@greek","\\boldsymbol","\\mathbb","\\mathcal","\\mathfrak","\\mathscr","\\mathsf","\\mathtt","\\Bbb","\\bm","\\bold","\\frak"],props:{numArgs:1,allowedInArgument:true},handler:({parser:e,funcName:t},n)=>{const r=normalizeArgument(n[0]);let o=t;if(o in fontAliases){o=fontAliases[o]}return{type:"font",mode:e.mode,font:o.slice(1),body:r}},mathmlBuilder:mathmlBuilder$6});defineFunction({type:"font",names:["\\rm","\\sf","\\tt","\\bf","\\it","\\cal"],props:{numArgs:0,allowedInText:true},handler:({parser:e,funcName:t,breakOnTokenText:n},r)=>{const{mode:o}=e;const i=e.parseExpression(true,n,true);const s=`math${t.slice(1)}`;return{type:"font",mode:o,font:s,body:{type:"ordgroup",mode:e.mode,body:i}}},mathmlBuilder:mathmlBuilder$6});const stylArray=["display","text","script","scriptscript"];const scriptLevel={auto:-1,display:0,text:0,script:1,scriptscript:2};const mathmlBuilder$5=(e,t)=>{const n=e.scriptLevel==="auto"?t.incrementLevel():e.scriptLevel==="display"?t.withLevel(StyleLevel.TEXT):e.scriptLevel==="text"?t.withLevel(StyleLevel.SCRIPT):t.withLevel(StyleLevel.SCRIPTSCRIPT);let r=new mathMLTree.MathNode("mfrac",[buildGroup$1(e.numer,n),buildGroup$1(e.denom,n)]);if(!e.hasBarLine){r.setAttribute("linethickness","0px")}else if(e.barSize){const n=calculateSize(e.barSize,t);r.setAttribute("linethickness",n.number+n.unit)}if(e.leftDelim!=null||e.rightDelim!=null){const t=[];if(e.leftDelim!=null){const n=new mathMLTree.MathNode("mo",[new mathMLTree.TextNode(e.leftDelim.replace("\\",""))]);n.setAttribute("fence","true");t.push(n)}t.push(r);if(e.rightDelim!=null){const n=new mathMLTree.MathNode("mo",[new mathMLTree.TextNode(e.rightDelim.replace("\\",""))]);n.setAttribute("fence","true");t.push(n)}r=makeRow(t)}if(e.scriptLevel!=="auto"){r=new mathMLTree.MathNode("mstyle",[r]);r.setAttribute("displaystyle",String(e.scriptLevel==="display"));r.setAttribute("scriptlevel",scriptLevel[e.scriptLevel])}return r};defineFunction({type:"genfrac",names:["\\dfrac","\\frac","\\tfrac","\\dbinom","\\binom","\\tbinom","\\\\atopfrac","\\\\bracefrac","\\\\brackfrac"],props:{numArgs:2,allowedInArgument:true},handler:({parser:e,funcName:t},n)=>{const r=n[0];const o=n[1];let i=false;let s=null;let a=null;let l="auto";switch(t){case"\\dfrac":case"\\frac":case"\\tfrac":i=true;break;case"\\\\atopfrac":i=false;break;case"\\dbinom":case"\\binom":case"\\tbinom":s="(";a=")";break;case"\\\\bracefrac":s="\\{";a="\\}";break;case"\\\\brackfrac":s="[";a="]";break;default:throw new Error("Unrecognized genfrac command")}switch(t){case"\\dfrac":case"\\dbinom":l="display";break;case"\\tfrac":case"\\tbinom":l="text";break}return{type:"genfrac",mode:e.mode,continued:false,numer:r,denom:o,hasBarLine:i,leftDelim:s,rightDelim:a,scriptLevel:l,barSize:null}},mathmlBuilder:mathmlBuilder$5});defineFunction({type:"genfrac",names:["\\cfrac"],props:{numArgs:2},handler:({parser:e,funcName:t},n)=>{const r=n[0];const o=n[1];return{type:"genfrac",mode:e.mode,continued:true,numer:r,denom:o,hasBarLine:true,leftDelim:null,rightDelim:null,scriptLevel:"display",barSize:null}}});defineFunction({type:"infix",names:["\\over","\\choose","\\atop","\\brace","\\brack"],props:{numArgs:0,infix:true},handler({parser:e,funcName:t,token:n}){let r;switch(t){case"\\over":r="\\frac";break;case"\\choose":r="\\binom";break;case"\\atop":r="\\\\atopfrac";break;case"\\brace":r="\\\\bracefrac";break;case"\\brack":r="\\\\brackfrac";break;default:throw new Error("Unrecognized infix genfrac command")}return{type:"infix",mode:e.mode,replaceWith:r,token:n}}});const delimFromValue=function(e){let t=null;if(e.length>0){t=e;t=t==="."?null:t}return t};defineFunction({type:"genfrac",names:["\\genfrac"],props:{numArgs:6,allowedInArgument:true,argTypes:["math","math","size","text","math","math"]},handler({parser:e},t){const n=t[4];const r=t[5];const o=normalizeArgument(t[0]);const i=o.type==="atom"&&o.family==="open"?delimFromValue(o.text):null;const s=normalizeArgument(t[1]);const a=s.type==="atom"&&s.family==="close"?delimFromValue(s.text):null;const l=assertNodeType(t[2],"size");let c;let d=null;if(l.isBlank){c=true}else{d=l.value;c=d.number>0}let u="auto";let p=t[3];if(p.type==="ordgroup"){if(p.body.length>0){const e=assertNodeType(p.body[0],"textord");u=stylArray[Number(e.text)]}}else{p=assertNodeType(p,"textord");u=stylArray[Number(p.text)]}return{type:"genfrac",mode:e.mode,numer:n,denom:r,continued:false,hasBarLine:c,barSize:d,leftDelim:i,rightDelim:a,scriptLevel:u}},mathmlBuilder:mathmlBuilder$5});defineFunction({type:"infix",names:["\\above"],props:{numArgs:1,argTypes:["size"],infix:true},handler({parser:e,funcName:t,token:n},r){return{type:"infix",mode:e.mode,replaceWith:"\\\\abovefrac",barSize:assertNodeType(r[0],"size").value,token:n}}});defineFunction({type:"genfrac",names:["\\\\abovefrac"],props:{numArgs:3,argTypes:["math","size","math"]},handler:({parser:e,funcName:t},n)=>{const r=n[0];const o=assert(assertNodeType(n[1],"infix").barSize);const i=n[2];const s=o.number>0;return{type:"genfrac",mode:e.mode,numer:r,denom:i,continued:false,hasBarLine:s,barSize:o,leftDelim:null,rightDelim:null,scriptLevel:"auto"}},mathmlBuilder:mathmlBuilder$5});defineFunction({type:"hbox",names:["\\hbox"],props:{numArgs:1,argTypes:["hbox"],allowedInArgument:true,allowedInText:false},handler({parser:e},t){return{type:"hbox",mode:e.mode,body:ordargument(t[0])}},mathmlBuilder(e,t){const n=t.withLevel(StyleLevel.TEXT);const r=buildExpressionRow(e.body,n);return consolidateText(r)}});const mathmlBuilder$4=(e,t)=>{const n=stretchy.mathMLnode(e.label);n.style["math-depth"]=0;return new mathMLTree.MathNode(e.isOver?"mover":"munder",[buildGroup$1(e.base,t),n])};defineFunction({type:"horizBrace",names:["\\overbrace","\\underbrace"],props:{numArgs:1},handler({parser:e,funcName:t},n){return{type:"horizBrace",mode:e.mode,label:t,isOver:/^\\over/.test(t),base:n[0]}},mathmlBuilder:mathmlBuilder$4});defineFunction({type:"href",names:["\\href"],props:{numArgs:2,argTypes:["url","original"],allowedInText:true},handler:({parser:e,token:t},n)=>{const r=n[1];const o=assertNodeType(n[0],"url").url;if(!e.settings.isTrusted({command:"\\href",url:o})){throw new ParseError(`Function "\\href" is not trusted`,t)}return{type:"href",mode:e.mode,href:o,body:ordargument(r)}},mathmlBuilder:(e,t)=>{let n=buildExpressionRow(e.body,t);if(!(n instanceof MathNode)){n=new MathNode("mrow",[n])}n.setAttribute("href",e.href);return n}});defineFunction({type:"href",names:["\\url"],props:{numArgs:1,argTypes:["url"],allowedInText:true},handler:({parser:e,token:t},n)=>{const r=assertNodeType(n[0],"url").url;if(!e.settings.isTrusted({command:"\\url",url:r})){throw new ParseError(`Function "\\url" is not trusted`,t)}const o=[];for(let e=0;e<r.length;e++){let t=r[e];if(t==="~"){t="\\textasciitilde"}o.push({type:"textord",mode:"text",text:t})}const i={type:"text",mode:e.mode,font:"\\texttt",body:o};return{type:"href",mode:e.mode,href:r,body:ordargument(i)}}});defineFunction({type:"html",names:["\\class","\\id","\\style","\\data"],props:{numArgs:2,argTypes:["raw","original"],allowedInText:true},handler:({parser:e,funcName:t,token:n},r)=>{const o=assertNodeType(r[0],"raw").string;const i=r[1];if(e.settings.strict){throw new ParseError(`Function "${t}" is disabled in strict mode`,n)}let s;const a={};switch(t){case"\\class":a.class=o;s={command:"\\class",class:o};break;case"\\id":a.id=o;s={command:"\\id",id:o};break;case"\\style":a.style=o;s={command:"\\style",style:o};break;case"\\data":{const e=o.split(",");for(let t=0;t<e.length;t++){const n=e[t].split("=");if(n.length!==2){throw new ParseError("Error parsing key-value for \\data")}a["data-"+n[0].trim()]=n[1].trim()}s={command:"\\data",attributes:a};break}default:throw new Error("Unrecognized html command")}if(!e.settings.isTrusted(s)){throw new ParseError(`Function "${t}" is not trusted`,n)}return{type:"html",mode:e.mode,attributes:a,body:ordargument(i)}},mathmlBuilder:(e,t)=>{const n=buildExpressionRow(e.body,t);const r=[];if(e.attributes.class){r.push(...e.attributes.class.trim().split(/\s+/))}n.classes=r;for(const t in e.attributes){if(t!=="class"&&Object.prototype.hasOwnProperty.call(e.attributes,t)){n.setAttribute(t,e.attributes[t])}}return n}});const sizeData=function(e){if(/^[-+]? *(\d+(\.\d*)?|\.\d+)$/.test(e)){return{number:+e,unit:"bp"}}else{const t=/([-+]?) *(\d+(?:\.\d*)?|\.\d+) *([a-z]{2})/.exec(e);if(!t){throw new ParseError("Invalid size: '"+e+"' in \\includegraphics")}const n={number:+(t[1]+t[2]),unit:t[3]};if(!validUnit(n)){throw new ParseError("Invalid unit: '"+n.unit+"' in \\includegraphics.")}return n}};defineFunction({type:"includegraphics",names:["\\includegraphics"],props:{numArgs:1,numOptionalArgs:1,argTypes:["raw","url"],allowedInText:false},handler:({parser:e,token:t},n,r)=>{let o={number:0,unit:"em"};let i={number:.9,unit:"em"};let s={number:0,unit:"em"};let a="";if(r[0]){const e=assertNodeType(r[0],"raw").string;const t=e.split(",");for(let e=0;e<t.length;e++){const n=t[e].split("=");if(n.length===2){const e=n[1].trim();switch(n[0].trim()){case"alt":a=e;break;case"width":o=sizeData(e);break;case"height":i=sizeData(e);break;case"totalheight":s=sizeData(e);break;default:throw new ParseError("Invalid key: '"+n[0]+"' in \\includegraphics.")}}}}const l=assertNodeType(n[0],"url").url;if(a===""){a=l;a=a.replace(/^.*[\\/]/,"");a=a.substring(0,a.lastIndexOf("."))}if(!e.settings.isTrusted({command:"\\includegraphics",url:l})){throw new ParseError(`Function "\\includegraphics" is not trusted`,t)}return{type:"includegraphics",mode:e.mode,alt:a,width:o,height:i,totalheight:s,src:l}},mathmlBuilder:(e,t)=>{const n=calculateSize(e.height,t);const r={number:0,unit:"em"};if(e.totalheight.number>0){if(e.totalheight.unit===n.unit&&e.totalheight.number>n.number){r.number=e.totalheight.number-n.number;r.unit=n.unit}}let o=0;if(e.width.number>0){o=calculateSize(e.width,t)}const i={height:n.number+r.number+"em"};if(o.number>0){i.width=o.number+o.unit}if(r.number>0){i.verticalAlign=-r.number+r.unit}const s=new Img(e.src,e.alt,i);s.height=n;s.depth=r;return new mathMLTree.MathNode("mtext",[s])}});defineFunction({type:"kern",names:["\\kern","\\mkern","\\hskip","\\mskip"],props:{numArgs:1,argTypes:["size"],primitive:true,allowedInText:true},handler({parser:e,funcName:t,token:n},r){const o=assertNodeType(r[0],"size");if(e.settings.strict){const r=t[1]==="m";const i=o.value.unit==="mu";if(r){if(!i){throw new ParseError(`LaTeX's ${t} supports only mu units, `+`not ${o.value.unit} units`,n)}if(e.mode!=="math"){throw new ParseError(`LaTeX's ${t} works only in math mode`,n)}}else{if(i){throw new ParseError(`LaTeX's ${t} doesn't support mu units`,n)}}}return{type:"kern",mode:e.mode,dimension:o.value}},mathmlBuilder(e,t){const n=calculateSize(e.dimension,t);const r=n.unit==="em"?spaceCharacter(n.number):"";if(e.mode==="text"&&r.length>0){const e=new mathMLTree.TextNode(r);return new mathMLTree.MathNode("mtext",[e])}else{const e=new mathMLTree.MathNode("mspace");e.setAttribute("width",n.number+n.unit);if(n.number<0){e.style.marginLeft=n.number+n.unit}return e}}});const spaceCharacter=function(e){if(e>=.05555&&e<=.05556){return""}else if(e>=.1666&&e<=.1667){return""}else if(e>=.2222&&e<=.2223){return""}else if(e>=.2777&&e<=.2778){return""}else{return""}};const invalidIdRegEx=/[^A-Za-z_0-9-]/g;defineFunction({type:"label",names:["\\label"],props:{numArgs:1,argTypes:["raw"]},handler({parser:e},t){return{type:"label",mode:e.mode,string:t[0].string.replace(invalidIdRegEx,"")}},mathmlBuilder(e,t){const n=new mathMLTree.MathNode("mrow",[],["tml-label"]);if(e.string.length>0){n.setAttribute("id",e.string)}return n}});const textModeLap=["\\clap","\\llap","\\rlap"];defineFunction({type:"lap",names:["\\mathllap","\\mathrlap","\\mathclap","\\clap","\\llap","\\rlap"],props:{numArgs:1,allowedInText:true},handler:({parser:e,funcName:t,token:n},r)=>{if(textModeLap.includes(t)){if(e.settings.strict&&e.mode!=="text"){throw new ParseError(`{${t}} can be used only in text mode.\n Try \\math${t.slice(1)}`,n)}t=t.slice(1)}else{t=t.slice(5)}const o=r[0];return{type:"lap",mode:e.mode,alignment:t,body:o}},mathmlBuilder:(e,t)=>{let n;if(e.alignment==="llap"){const r=buildExpression(ordargument(e.body),t);const o=new mathMLTree.MathNode("mphantom",r);n=new mathMLTree.MathNode("mpadded",[o]);n.setAttribute("width","0px")}const r=buildGroup$1(e.body,t);let o;if(e.alignment==="llap"){r.style.position="absolute";r.style.right="0";r.style.bottom=`0`;o=new mathMLTree.MathNode("mpadded",[n,r])}else{o=new mathMLTree.MathNode("mpadded",[r])}if(e.alignment==="rlap"){if(e.body.body.length>0&&e.body.body[0].type==="genfrac"){o.setAttribute("lspace","0.16667em")}}else{const t=e.alignment==="llap"?"-1":"-0.5";o.setAttribute("lspace",t+"width");if(e.alignment==="llap"){o.style.position="relative"}else{o.style.display="flex";o.style.justifyContent="center"}}o.setAttribute("width","0px");return o}});defineFunction({type:"ordgroup",names:["\\(","$"],props:{numArgs:0,allowedInText:true,allowedInMath:false},handler({funcName:e,parser:t},n){const r=t.mode;t.switchMode("math");const o=e==="\\("?"\\)":"$";const i=t.parseExpression(false,o);t.expect(o);t.switchMode(r);return{type:"ordgroup",mode:t.mode,body:i}}});defineFunction({type:"text",names:["\\)","\\]"],props:{numArgs:0,allowedInText:true,allowedInMath:false},handler(e,t){throw new ParseError(`Mismatched ${e.funcName}`,t)}});const chooseStyle=(e,t)=>{switch(t.level){case StyleLevel.DISPLAY:return e.display;case StyleLevel.TEXT:return e.text;case StyleLevel.SCRIPT:return e.script;case StyleLevel.SCRIPTSCRIPT:return e.scriptscript;default:return e.text}};defineFunction({type:"mathchoice",names:["\\mathchoice"],props:{numArgs:4,primitive:true},handler:({parser:e},t)=>({type:"mathchoice",mode:e.mode,display:ordargument(t[0]),text:ordargument(t[1]),script:ordargument(t[2]),scriptscript:ordargument(t[3])}),mathmlBuilder:(e,t)=>{const n=chooseStyle(e,t);return buildExpressionRow(n,t)}});const textAtomTypes=["text","textord","mathord","atom"];const padding=e=>{const t=new mathMLTree.MathNode("mspace");t.setAttribute("width",e+"em");return t};function mathmlBuilder$3(e,t){let n;const r=buildExpression(e.body,t);if(e.mclass==="minner"){n=new mathMLTree.MathNode("mpadded",r)}else if(e.mclass==="mord"){if(e.isCharacterBox||r[0].type==="mathord"){n=r[0];n.type="mi";if(n.children.length===1&&n.children[0].text&&n.children[0].text===""){n.setAttribute("mathvariant","normal")}}else{n=new mathMLTree.MathNode("mi",r)}}else{n=new mathMLTree.MathNode("mrow",r);if(e.mustPromote){n=r[0];n.type="mo";if(e.isCharacterBox&&e.body[0].text&&/[A-Za-z]/.test(e.body[0].text)){n.setAttribute("mathvariant","italic")}}else{n=new mathMLTree.MathNode("mrow",r)}const o=t.level<2;if(n.type==="mrow"){if(o){if(e.mclass==="mbin"){n.children.unshift(padding(.2222));n.children.push(padding(.2222))}else if(e.mclass==="mrel"){n.children.unshift(padding(.2778));n.children.push(padding(.2778))}else if(e.mclass==="mpunct"){n.children.push(padding(.1667))}else if(e.mclass==="minner"){n.children.unshift(padding(.0556));n.children.push(padding(.0556))}}}else{if(e.mclass==="mbin"){n.attributes.lspace=o?"0.2222em":"0";n.attributes.rspace=o?"0.2222em":"0"}else if(e.mclass==="mrel"){n.attributes.lspace=o?"0.2778em":"0";n.attributes.rspace=o?"0.2778em":"0"}else if(e.mclass==="mpunct"){n.attributes.lspace="0em";n.attributes.rspace=o?"0.1667em":"0"}else if(e.mclass==="mopen"||e.mclass==="mclose"){n.attributes.lspace="0em";n.attributes.rspace="0em"}else if(e.mclass==="minner"&&o){n.attributes.lspace="0.0556em";n.attributes.width="+0.1111em"}}if(!(e.mclass==="mopen"||e.mclass==="mclose")){delete n.attributes.stretchy;delete n.attributes.form}}return n}defineFunction({type:"mclass",names:["\\mathord","\\mathbin","\\mathrel","\\mathopen","\\mathclose","\\mathpunct","\\mathinner"],props:{numArgs:1,primitive:true},handler({parser:e,funcName:t},n){const r=n[0];const o=utils.isCharacterBox(r);let i=true;const s={type:"mathord",text:"",mode:e.mode};const a=r.body?r.body:[r];for(const t of a){if(textAtomTypes.includes(t.type)){if(symbols[e.mode][t.text]){s.text+=symbols[e.mode][t.text].replace}else if(t.text){s.text+=t.text}else if(t.body){t.body.map((e=>{s.text+=e.text}))}}else{i=false;break}}return{type:"mclass",mode:e.mode,mclass:"m"+t.slice(5),body:ordargument(i?s:r),isCharacterBox:o,mustPromote:i}},mathmlBuilder:mathmlBuilder$3});const binrelClass=e=>{const t=e.type==="ordgroup"&&e.body.length?e.body[0]:e;if(t.type==="atom"&&(t.family==="bin"||t.family==="rel")){return"m"+t.family}else{return"mord"}};defineFunction({type:"mclass",names:["\\@binrel"],props:{numArgs:2},handler({parser:e},t){return{type:"mclass",mode:e.mode,mclass:binrelClass(t[0]),body:ordargument(t[1]),isCharacterBox:utils.isCharacterBox(t[1])}}});defineFunction({type:"mclass",names:["\\stackrel","\\overset","\\underset"],props:{numArgs:2},handler({parser:e,funcName:t},n){const r=n[1];const o=n[0];const i={type:"op",mode:r.mode,limits:true,alwaysHandleSupSub:true,parentIsSupSub:false,symbol:false,stack:true,suppressBaseShift:t!=="\\stackrel",body:ordargument(r)};return{type:"supsub",mode:o.mode,base:i,sup:t==="\\underset"?null:o,sub:t==="\\underset"?o:null}},mathmlBuilder:mathmlBuilder$3});const buildGroup=(e,t,n)=>{if(!e){return n}const r=buildGroup$1(e,t);if(r.type==="mrow"&&r.children.length===0){return n}return r};defineFunction({type:"multiscript",names:["\\sideset","\\pres@cript"],props:{numArgs:3},handler({parser:e,funcName:t,token:n},r){if(r[2].body.length===0){throw new ParseError(t+`cannot parse an empty base.`)}const o=r[2].body[0];if(e.settings.strict&&t==="\\sideset"&&!o.symbol){throw new ParseError(`The base of \\sideset must be a big operator. Try \\prescript.`)}if(r[0].body.length>0&&r[0].body[0].type!=="supsub"||r[1].body.length>0&&r[1].body[0].type!=="supsub"){throw new ParseError("\\sideset can parse only subscripts and "+"superscripts in its first two arguments",n)}const i=r[0].body.length>0?r[0].body[0]:null;const s=r[1].body.length>0?r[1].body[0]:null;if(!i&&!s){return o}else if(!i){return{type:"styling",mode:e.mode,scriptLevel:"text",body:[{type:"supsub",mode:e.mode,base:o,sup:s.sup,sub:s.sub}]}}else{return{type:"multiscript",mode:e.mode,isSideset:t==="\\sideset",prescripts:i,postscripts:s,base:o}}},mathmlBuilder(e,t){const n=buildGroup$1(e.base,t);const r=new mathMLTree.MathNode("mprescripts");const o=new mathMLTree.MathNode("none");let i=[];const s=buildGroup(e.prescripts.sub,t,o);const a=buildGroup(e.prescripts.sup,t,o);if(e.isSideset){s.setAttribute("style","text-align: left;");a.setAttribute("style","text-align: left;")}if(e.postscripts){const l=buildGroup(e.postscripts.sub,t,o);const c=buildGroup(e.postscripts.sup,t,o);i=[n,l,c,r,s,a]}else{i=[n,r,s,a]}return new mathMLTree.MathNode("mmultiscripts",i)}});defineFunction({type:"not",names:["\\not"],props:{numArgs:1,primitive:true,allowedInText:false},handler({parser:e},t){const n=utils.isCharacterBox(t[0]);let r;if(n){r=ordargument(t[0]);if(r[0].text.charAt(0)==="\\"){r[0].text=symbols.math[r[0].text].replace}r[0].text=r[0].text.slice(0,1)+""+r[0].text.slice(1)}else{const e={type:"textord",mode:"math",text:""};const n={type:"kern",mode:"math",dimension:{number:-.6,unit:"em"}};r=[e,n,t[0]]}return{type:"not",mode:e.mode,body:r,isCharacterBox:n}},mathmlBuilder(e,t){if(e.isCharacterBox){const n=buildExpression(e.body,t,true);return n[0]}else{return buildExpressionRow(e.body,t)}}});const ordAtomTypes=["textord","mathord","atom"];const noSuccessor=["\\smallint"];const ordTypes=["textord","mathord","ordgroup","close","leftright","font"];const setSpacing=e=>{e.attributes.lspace="0.1667em";e.attributes.rspace="0.1667em"};const mathmlBuilder$2=(e,t)=>{let n;if(e.symbol){n=new MathNode("mo",[makeText(e.name,e.mode)]);if(noSuccessor.includes(e.name)){n.setAttribute("largeop","false")}else if(e.limits){n.setAttribute("stretchy","true")}else{n.setAttribute("movablelimits","false")}if(e.fromMathOp){setSpacing(n)}}else if(e.body){n=new MathNode("mo",buildExpression(e.body,t));if(e.fromMathOp){setSpacing(n)}}else{n=new MathNode("mi",[new TextNode(e.name.slice(1))]);if(!e.parentIsSupSub){const t=new MathNode("mo",[makeText("","text")]);const r=[n,t];if(e.needsLeadingSpace){const e=new MathNode("mspace");e.setAttribute("width","0.1667em");r.unshift(e)}if(!e.isFollowedByDelimiter){const e=new MathNode("mspace");e.setAttribute("width","0.1667em");r.push(e)}n=new MathNode("mrow",r)}}return n};const singleCharBigOps={"":"\\prod","":"\\coprod","":"\\sum","":"\\bigwedge","":"\\bigvee","":"\\bigcap","":"\\bigcup","":"\\bigodot","":"\\bigoplus","":"\\bigotimes","":"\\biguplus","":"\\bigsqcap","":"\\bigsqcup","":"\\bigcupdot","":"\\bigdoublevee","":"\\bigdoublewedge","":"\\bigtimes"};defineFunction({type:"op",names:["\\coprod","\\bigvee","\\bigwedge","\\biguplus","\\bigcupplus","\\bigcupdot","\\bigcap","\\bigcup","\\bigdoublevee","\\bigdoublewedge","\\intop","\\prod","\\sum","\\bigotimes","\\bigoplus","\\bigodot","\\bigsqcap","\\bigsqcup","\\bigtimes","\\smallint","","","","","","","","","","","",""],props:{numArgs:0},handler:({parser:e,funcName:t},n)=>{let r=t;if(r.length===1){r=singleCharBigOps[r]}return{type:"op",mode:e.mode,limits:true,parentIsSupSub:false,symbol:true,stack:false,name:r}},mathmlBuilder:mathmlBuilder$2});defineFunction({type:"op",names:["\\mathop"],props:{numArgs:1,primitive:true},handler:({parser:e},t)=>{const n=t[0];const r=n.body?n.body:[n];const o=r.length===1&&ordAtomTypes.includes(r[0].type);return{type:"op",mode:e.mode,limits:true,parentIsSupSub:false,symbol:o,fromMathOp:true,stack:false,name:o?r[0].text:null,body:o?null:ordargument(n)}},mathmlBuilder:mathmlBuilder$2});const singleCharIntegrals={"":"\\int","":"\\iint","":"\\iiint","":"\\oint","":"\\oiint","":"\\oiiint","":"\\intclockwise","":"\\varointclockwise","":"\\iiiint","":"\\intbar","":"\\intBar","":"\\fint","":"\\rppolint","":"\\scpolint","":"\\pointint","":"\\sqint","":"\\intlarhk","":"\\intx","":"\\intcap","":"\\intcup"};defineFunction({type:"op",names:["\\arcsin","\\arccos","\\arctan","\\arctg","\\arcctg","\\arg","\\ch","\\cos","\\cosec","\\cosh","\\cot","\\cotg","\\coth","\\csc","\\ctg","\\cth","\\deg","\\dim","\\exp","\\hom","\\ker","\\lg","\\ln","\\log","\\sec","\\sin","\\sinh","\\sh","\\sgn","\\tan","\\tanh","\\tg","\\th"],props:{numArgs:0},handler({parser:e,funcName:t}){const n=e.prevAtomType;const r=e.gullet.future().text;return{type:"op",mode:e.mode,limits:false,parentIsSupSub:false,symbol:false,stack:false,isFollowedByDelimiter:isDelimiter(r),needsLeadingSpace:n.length>0&&ordTypes.includes(n),name:t}},mathmlBuilder:mathmlBuilder$2});defineFunction({type:"op",names:["\\det","\\gcd","\\inf","\\lim","\\max","\\min","\\Pr","\\sup"],props:{numArgs:0},handler({parser:e,funcName:t}){const n=e.prevAtomType;const r=e.gullet.future().text;return{type:"op",mode:e.mode,limits:true,parentIsSupSub:false,symbol:false,stack:false,isFollowedByDelimiter:isDelimiter(r),needsLeadingSpace:n.length>0&&ordTypes.includes(n),name:t}},mathmlBuilder:mathmlBuilder$2});defineFunction({type:"op",names:["\\int","\\iint","\\iiint","\\iiiint","\\oint","\\oiint","\\oiiint","\\intclockwise","\\varointclockwise","\\intbar","\\intBar","\\fint","\\rppolint","\\scpolint","\\pointint","\\sqint","\\intlarhk","\\intx","\\intcap","\\intcup","","","","","","","","","","","","","","","","","","","",""],props:{numArgs:0},handler({parser:e,funcName:t}){let n=t;if(n.length===1){n=singleCharIntegrals[n]}return{type:"op",mode:e.mode,limits:false,parentIsSupSub:false,symbol:true,stack:false,name:n}},mathmlBuilder:mathmlBuilder$2});const mathmlBuilder$1=(e,t)=>{let n=buildExpression(e.body,t.withFont("mathrm"));let r=true;for(let e=0;e<n.length;e++){let t=n[e];if(t instanceof mathMLTree.MathNode){if(t.type==="mrow"&&t.children.length===1&&t.children[0]instanceof mathMLTree.MathNode){t=t.children[0]}switch(t.type){case"mi":case"mn":case"ms":case"mtext":break;case"mspace":{if(t.attributes.width){const o=t.attributes.width.replace("em","");const i=spaceCharacter(Number(o));if(i===""){r=false}else{n[e]=new mathMLTree.MathNode("mtext",[new mathMLTree.TextNode(i)])}}}break;case"mo":{const e=t.children[0];if(t.children.length===1&&e instanceof mathMLTree.TextNode){e.text=e.text.replace(/\u2212/,"-").replace(/\u2217/,"*")}else{r=false}break}default:r=false}}else{r=false}}if(r){const e=n.map((e=>e.toText())).join("");n=[new mathMLTree.TextNode(e)]}else if(n.length===1&&["mover","munder"].includes(n[0].type)&&(n[0].children[0].type==="mi"||n[0].children[0].type==="mtext")){n[0].children[0].type="mi";if(e.parentIsSupSub){return new mathMLTree.MathNode("mrow",n)}else{const e=new mathMLTree.MathNode("mo",[makeText("","text")]);return mathMLTree.newDocumentFragment([n[0],e])}}let o;if(r){o=new mathMLTree.MathNode("mi",n);if(n[0].text.length===1){o.setAttribute("mathvariant","normal")}}else{o=new mathMLTree.MathNode("mrow",n)}if(!e.parentIsSupSub){const t=new mathMLTree.MathNode("mo",[makeText("","text")]);const n=[o,t];if(e.needsLeadingSpace){const e=new mathMLTree.MathNode("mspace");e.setAttribute("width","0.1667em");n.unshift(e)}if(!e.isFollowedByDelimiter){const e=new mathMLTree.MathNode("mspace");e.setAttribute("width","0.1667em");n.push(e)}return mathMLTree.newDocumentFragment(n)}return o};defineFunction({type:"operatorname",names:["\\operatorname@","\\operatornamewithlimits"],props:{numArgs:1,allowedInArgument:true},handler:({parser:e,funcName:t},n)=>{const r=n[0];const o=e.prevAtomType;const i=e.gullet.future().text;return{type:"operatorname",mode:e.mode,body:ordargument(r),alwaysHandleSupSub:t==="\\operatornamewithlimits",limits:false,parentIsSupSub:false,isFollowedByDelimiter:isDelimiter(i),needsLeadingSpace:o.length>0&&ordTypes.includes(o)}},mathmlBuilder:mathmlBuilder$1});defineMacro("\\operatorname","\\@ifstar\\operatornamewithlimits\\operatorname@");defineFunctionBuilders({type:"ordgroup",mathmlBuilder(e,t){return buildExpressionRow(e.body,t,e.semisimple)}});defineFunction({type:"phantom",names:["\\phantom"],props:{numArgs:1,allowedInText:true},handler:({parser:e},t)=>{const n=t[0];return{type:"phantom",mode:e.mode,body:ordargument(n)}},mathmlBuilder:(e,t)=>{const n=buildExpression(e.body,t);return new mathMLTree.MathNode("mphantom",n)}});defineFunction({type:"hphantom",names:["\\hphantom"],props:{numArgs:1,allowedInText:true},handler:({parser:e},t)=>{const n=t[0];return{type:"hphantom",mode:e.mode,body:n}},mathmlBuilder:(e,t)=>{const n=buildExpression(ordargument(e.body),t);const r=new mathMLTree.MathNode("mphantom",n);const o=new mathMLTree.MathNode("mpadded",[r]);o.setAttribute("height","0px");o.setAttribute("depth","0px");return o}});defineFunction({type:"vphantom",names:["\\vphantom"],props:{numArgs:1,allowedInText:true},handler:({parser:e},t)=>{const n=t[0];return{type:"vphantom",mode:e.mode,body:n}},mathmlBuilder:(e,t)=>{const n=buildExpression(ordargument(e.body),t);const r=new mathMLTree.MathNode("mphantom",n);const o=new mathMLTree.MathNode("mpadded",[r]);o.setAttribute("width","0px");return o}});defineFunction({type:"pmb",names:["\\pmb"],props:{numArgs:1,allowedInText:true},handler({parser:e},t){return{type:"pmb",mode:e.mode,body:ordargument(t[0])}},mathmlBuilder(e,t){const n=buildExpression(e.body,t);const r=wrapWithMstyle(n);r.setAttribute("style","font-weight:bold");return r}});const mathmlBuilder=(e,t)=>{const n=t.withLevel(StyleLevel.TEXT);const r=new mathMLTree.MathNode("mpadded",[buildGroup$1(e.body,n)]);const o=calculateSize(e.dy,t);r.setAttribute("voffset",o.number+o.unit);if(o.number>0){r.style.padding=o.number+o.unit+" 0 0 0"}else{r.style.padding="0 0 "+Math.abs(o.number)+o.unit+" 0"}return r};defineFunction({type:"raise",names:["\\raise","\\lower"],props:{numArgs:2,argTypes:["size","primitive"],primitive:true},handler({parser:e,funcName:t},n){const r=assertNodeType(n[0],"size").value;if(t==="\\lower"){r.number*=-1}const o=n[1];return{type:"raise",mode:e.mode,dy:r,body:o}},mathmlBuilder:mathmlBuilder});defineFunction({type:"raise",names:["\\raisebox"],props:{numArgs:2,argTypes:["size","hbox"],allowedInText:true},handler({parser:e,funcName:t},n){const r=assertNodeType(n[0],"size").value;const o=n[1];return{type:"raise",mode:e.mode,dy:r,body:o}},mathmlBuilder:mathmlBuilder});defineFunction({type:"ref",names:["\\ref","\\eqref"],props:{numArgs:1,argTypes:["raw"]},handler({parser:e,funcName:t},n){return{type:"ref",mode:e.mode,funcName:t,string:n[0].string.replace(invalidIdRegEx,"")}},mathmlBuilder(e,t){const n=e.funcName==="\\ref"?["tml-ref"]:["tml-ref","tml-eqref"];const r=new mathMLTree.MathNode("mtext",[new mathMLTree.TextNode("")],n);r.setAttribute("href","#"+e.string);return r}});defineFunction({type:"reflect",names:["\\reflectbox"],props:{numArgs:1,argTypes:["hbox"],allowedInText:true},handler({parser:e},t){return{type:"reflect",mode:e.mode,body:t[0]}},mathmlBuilder(e,t){const n=buildGroup$1(e.body,t);n.style.transform="scaleX(-1)";return n}});defineFunction({type:"internal",names:["\\relax"],props:{numArgs:0,allowedInText:true},handler({parser:e}){return{type:"internal",mode:e.mode}}});defineFunction({type:"rule",names:["\\rule"],props:{numArgs:2,numOptionalArgs:1,argTypes:["size","size","size"]},handler({parser:e},t,n){const r=n[0];const o=assertNodeType(t[0],"size");const i=assertNodeType(t[1],"size");return{type:"rule",mode:e.mode,shift:r&&assertNodeType(r,"size").value,width:o.value,height:i.value}},mathmlBuilder(e,t){const n=calculateSize(e.width,t);const r=calculateSize(e.height,t);const o=e.shift?calculateSize(e.shift,t):{number:0,unit:"em"};const i=t.color&&t.getColor()||"black";const s=new mathMLTree.MathNode("mspace");if(n.number>0&&r.number>0){s.setAttribute("mathbackground",i)}s.setAttribute("width",n.number+n.unit);s.setAttribute("height",r.number+r.unit);if(o.number===0){return s}const a=new mathMLTree.MathNode("mpadded",[s]);if(o.number>=0){a.setAttribute("height","+"+o.number+o.unit)}else{a.setAttribute("height",o.number+o.unit);a.setAttribute("depth","+"+-o.number+o.unit)}a.setAttribute("voffset",o.number+o.unit);return a}});const sizeMap={"\\tiny":.5,"\\sixptsize":.6,"\\Tiny":.6,"\\scriptsize":.7,"\\footnotesize":.8,"\\small":.9,"\\normalsize":1,"\\large":1.2,"\\Large":1.44,"\\LARGE":1.728,"\\huge":2.074,"\\Huge":2.488};defineFunction({type:"sizing",names:["\\tiny","\\sixptsize","\\Tiny","\\scriptsize","\\footnotesize","\\small","\\normalsize","\\large","\\Large","\\LARGE","\\huge","\\Huge"],props:{numArgs:0,allowedInText:true},handler:({breakOnTokenText:e,funcName:t,parser:n},r)=>{if(n.settings.strict&&n.mode==="math"){console.log(`Temml strict-mode warning: Command ${t} is invalid in math mode.`)}const o=n.parseExpression(false,e,true);return{type:"sizing",mode:n.mode,funcName:t,body:o}},mathmlBuilder:(e,t)=>{const n=t.withFontSize(sizeMap[e.funcName]);const r=buildExpression(e.body,n);const o=wrapWithMstyle(r);const i=(sizeMap[e.funcName]/t.fontSize).toFixed(4);o.setAttribute("mathsize",i+"em");return o}});defineFunction({type:"smash",names:["\\smash"],props:{numArgs:1,numOptionalArgs:1,allowedInText:true},handler:({parser:e},t,n)=>{let r=false;let o=false;const i=n[0]&&assertNodeType(n[0],"ordgroup");if(i){let e="";for(let t=0;t<i.body.length;++t){const n=i.body[t];e=n.text;if(e==="t"){r=true}else if(e==="b"){o=true}else{r=false;o=false;break}}}else{r=true;o=true}const s=t[0];return{type:"smash",mode:e.mode,body:s,smashHeight:r,smashDepth:o}},mathmlBuilder:(e,t)=>{const n=new mathMLTree.MathNode("mpadded",[buildGroup$1(e.body,t)]);if(e.smashHeight){n.setAttribute("height","0px")}if(e.smashDepth){n.setAttribute("depth","0px")}return n}});defineFunction({type:"sqrt",names:["\\sqrt"],props:{numArgs:1,numOptionalArgs:1},handler({parser:e},t,n){const r=n[0];const o=t[0];return{type:"sqrt",mode:e.mode,body:o,index:r}},mathmlBuilder(e,t){const{body:n,index:r}=e;return r?new mathMLTree.MathNode("mroot",[buildGroup$1(n,t),buildGroup$1(r,t.incrementLevel())]):new mathMLTree.MathNode("msqrt",[buildGroup$1(n,t)])}});const styleMap={display:0,text:1,script:2,scriptscript:3};const styleAttributes={display:["0","true"],text:["0","false"],script:["1","false"],scriptscript:["2","false"]};defineFunction({type:"styling",names:["\\displaystyle","\\textstyle","\\scriptstyle","\\scriptscriptstyle"],props:{numArgs:0,allowedInText:true,primitive:true},handler({breakOnTokenText:e,funcName:t,parser:n},r){const o=n.parseExpression(true,e,true);const i=t.slice(1,t.length-5);return{type:"styling",mode:n.mode,scriptLevel:i,body:o}},mathmlBuilder(e,t){const n=t.withLevel(styleMap[e.scriptLevel]);const r=buildExpression(e.body,n);const o=wrapWithMstyle(r);const i=styleAttributes[e.scriptLevel];o.setAttribute("scriptlevel",i[0]);o.setAttribute("displaystyle",i[1]);return o}});const symbolRegEx=/^m(over|under|underover)$/;defineFunctionBuilders({type:"supsub",mathmlBuilder(e,t){let n=false;let r;let o;let i=false;let s=false;let a=false;if(e.base&&e.base.type==="horizBrace"){o=!!e.sup;if(o===e.base.isOver){n=true;r=e.base.isOver}}if(e.base&&!e.base.stack&&(e.base.type==="op"||e.base.type==="operatorname")){e.base.parentIsSupSub=true;i=!e.base.symbol;s=i&&!e.isFollowedByDelimiter;a=e.base.needsLeadingSpace}const l=e.base&&e.base.stack?[buildGroup$1(e.base.body[0],t)]:[buildGroup$1(e.base,t)];const c=t.inSubOrSup();if(e.sub){l.push(buildGroup$1(e.sub,c))}if(e.sup){const t=buildGroup$1(e.sup,c);const n=t.type==="mrow"?t.children[0]:t;if(n&&n.type==="mo"&&n.classes.includes("tml-prime")&&e.base&&e.base.text&&e.base.text==="f"){n.classes.push("prime-pad")}l.push(t)}let d;if(n){d=r?"mover":"munder"}else if(!e.sub){const n=e.base;if(n&&n.type==="op"&&n.limits&&(t.level===StyleLevel.DISPLAY||n.alwaysHandleSupSub)){d="mover"}else if(n&&n.type==="operatorname"&&n.alwaysHandleSupSub&&(n.limits||t.level===StyleLevel.DISPLAY)){d="mover"}else{d="msup"}}else if(!e.sup){const n=e.base;if(n&&n.type==="op"&&n.limits&&(t.level===StyleLevel.DISPLAY||n.alwaysHandleSupSub)){d="munder"}else if(n&&n.type==="operatorname"&&n.alwaysHandleSupSub&&(n.limits||t.level===StyleLevel.DISPLAY)){d="munder"}else{d="msub"}}else{const n=e.base;if(n&&(n.type==="op"&&n.limits||n.type==="multiscript")&&(t.level===StyleLevel.DISPLAY||n.alwaysHandleSupSub)){d="munderover"}else if(n&&n.type==="operatorname"&&n.alwaysHandleSupSub&&(t.level===StyleLevel.DISPLAY||n.limits)){d="munderover"}else{d="msubsup"}}let u=new mathMLTree.MathNode(d,l);if(i){const e=new mathMLTree.MathNode("mo",[makeText("","text")]);if(a){const t=new mathMLTree.MathNode("mspace");t.setAttribute("width","0.1667em");u=mathMLTree.newDocumentFragment([t,u,e])}else{u=mathMLTree.newDocumentFragment([u,e])}if(s){const e=new mathMLTree.MathNode("mspace");e.setAttribute("width","0.1667em");u.children.push(e)}}else if(symbolRegEx.test(d)){u=new mathMLTree.MathNode("mrow",[u])}return u}});const short=["\\shortmid","\\nshortmid","\\shortparallel","\\nshortparallel","\\smallsetminus"];const arrows=["\\Rsh","\\Lsh","\\restriction"];const isArrow=e=>{if(e.length===1){const t=e.codePointAt(0);return 8591<t&&t<8704}return e.indexOf("arrow")>-1||e.indexOf("harpoon")>-1||arrows.includes(e)};defineFunctionBuilders({type:"atom",mathmlBuilder(e,t){const n=new mathMLTree.MathNode("mo",[makeText(e.text,e.mode)]);if(e.family==="punct"){n.setAttribute("separator","true")}else if(e.family==="open"||e.family==="close"){if(e.family==="open"){n.setAttribute("form","prefix");n.setAttribute("stretchy","false")}else if(e.family==="close"){n.setAttribute("form","postfix");n.setAttribute("stretchy","false")}}else if(e.text==="\\mid"){n.setAttribute("lspace","0.22em");n.setAttribute("rspace","0.22em");n.setAttribute("stretchy","false")}else if(e.family==="rel"&&isArrow(e.text)){n.setAttribute("stretchy","false")}else if(short.includes(e.text)){n.setAttribute("mathsize","70%")}else if(e.text===":"){n.attributes.lspace="0.2222em";n.attributes.rspace="0.2222em"}return n}});const fontMap={mathbf:"bold",mathrm:"normal",textit:"italic",mathit:"italic",mathnormal:"italic",mathbb:"double-struck",mathcal:"script",mathfrak:"fraktur",mathscr:"script",mathsf:"sans-serif",mathtt:"monospace"};const getVariant=function(e,t){if(t.fontFamily==="texttt"){return"monospace"}else if(t.fontFamily==="textsc"){return"normal"}else if(t.fontFamily==="textsf"){if(t.fontShape==="textit"&&t.fontWeight==="textbf"){return"sans-serif-bold-italic"}else if(t.fontShape==="textit"){return"sans-serif-italic"}else if(t.fontWeight==="textbf"){return"sans-serif-bold"}else{return"sans-serif"}}else if(t.fontShape==="textit"&&t.fontWeight==="textbf"){return"bold-italic"}else if(t.fontShape==="textit"){return"italic"}else if(t.fontWeight==="textbf"){return"bold"}const n=t.font;if(!n||n==="mathnormal"){return null}const r=e.mode;switch(n){case"mathit":return"italic";case"mathrm":{const t=e.text.codePointAt(0);return 939<t&&t<975?"italic":"normal"}case"greekItalic":return"italic";case"up@greek":return"normal";case"boldsymbol":case"mathboldsymbol":return"bold-italic";case"mathbf":return"bold";case"mathbb":return"double-struck";case"mathfrak":return"fraktur";case"mathscr":case"mathcal":return"script";case"mathsf":return"sans-serif";case"mathtt":return"monospace"}let o=e.text;if(symbols[r][o]&&symbols[r][o].replace){o=symbols[r][o].replace}return Object.prototype.hasOwnProperty.call(fontMap,n)?fontMap[n]:null};const script=Object.freeze({B:8426,E:8427,F:8427,H:8387,I:8391,L:8390,M:8422,R:8393,e:8394,g:8355,o:8389});const frak=Object.freeze({C:8426,H:8388,I:8392,R:8394,Z:8398});const bbb$1=Object.freeze({C:8383,H:8389,N:8391,P:8393,Q:8393,R:8395,Z:8394});const bold=Object.freeze({"":119527,"":119564,"":119534,"":119577,"":119535,"":119563});const boldItalic=Object.freeze({"":119643,"":119680,"":119650,"":119693,"":119651,"":119679});const boldsf=Object.freeze({"":119701,"":119738,"":119708,"":119751,"":119709,"":119737});const bisf=Object.freeze({"":119759,"":119796,"":119766,"":119809,"":119767,"":119795});const offset=Object.freeze({upperCaseLatin:{normal:e=>0,bold:e=>119743,italic:e=>119795,"bold-italic":e=>119847,script:e=>script[e]||119899,"script-bold":e=>119951,fraktur:e=>frak[e]||120003,"fraktur-bold":e=>120107,"double-struck":e=>bbb$1[e]||120055,"sans-serif":e=>120159,"sans-serif-bold":e=>120211,"sans-serif-italic":e=>120263,"sans-serif-bold-italic":e=>120380,monospace:e=>120367},lowerCaseLatin:{normal:e=>0,bold:e=>119737,italic:e=>e==="h"?8358:119789,"bold-italic":e=>119841,script:e=>script[e]||119893,"script-bold":e=>119945,fraktur:e=>119997,"fraktur-bold":e=>120101,"double-struck":e=>120049,"sans-serif":e=>120153,"sans-serif-bold":e=>120205,"sans-serif-italic":e=>120257,"sans-serif-bold-italic":e=>120309,monospace:e=>120361},upperCaseGreek:{normal:e=>0,bold:e=>119575,italic:e=>119633,"bold-italic":e=>119575,script:e=>0,"script-bold":e=>0,fraktur:e=>0,"fraktur-bold":e=>0,"double-struck":e=>0,"sans-serif":e=>119749,"sans-serif-bold":e=>119749,"sans-serif-italic":e=>0,"sans-serif-bold-italic":e=>119807,monospace:e=>0},lowerCaseGreek:{normal:e=>0,bold:e=>119569,italic:e=>119627,"bold-italic":e=>e===""?119678:119685,script:e=>0,"script-bold":e=>0,fraktur:e=>0,"fraktur-bold":e=>0,"double-struck":e=>0,"sans-serif":e=>119743,"sans-serif-bold":e=>119743,"sans-serif-italic":e=>0,"sans-serif-bold-italic":e=>119801,monospace:e=>0},varGreek:{normal:e=>0,bold:e=>bold[e]||-51,italic:e=>0,"bold-italic":e=>boldItalic[e]||58,script:e=>0,"script-bold":e=>0,fraktur:e=>0,"fraktur-bold":e=>0,"double-struck":e=>0,"sans-serif":e=>boldsf[e]||116,"sans-serif-bold":e=>boldsf[e]||116,"sans-serif-italic":e=>0,"sans-serif-bold-italic":e=>bisf[e]||174,monospace:e=>0},numeral:{normal:e=>0,bold:e=>120734,italic:e=>0,"bold-italic":e=>0,script:e=>0,"script-bold":e=>0,fraktur:e=>0,"fraktur-bold":e=>0,"double-struck":e=>120744,"sans-serif":e=>120754,"sans-serif-bold":e=>120764,"sans-serif-italic":e=>0,"sans-serif-bold-italic":e=>0,monospace:e=>120774}});const variantChar=(e,t)=>{const n=e.codePointAt(0);const r=64<n&&n<91?"upperCaseLatin":96<n&&n<123?"lowerCaseLatin":912<n&&n<938?"upperCaseGreek":944<n&&n<970||e===""?"lowerCaseGreek":120545<n&&n<120572||bold[e]?"varGreek":47<n&&n<58?"numeral":"other";return r==="other"?e:String.fromCodePoint(n+offset[r][t](e))};const smallCaps=Object.freeze({a:"",b:"",c:"",d:"",e:"",f:"",g:"",h:"",i:"",j:"",k:"",l:"",m:"",n:"",o:"",p:"",q:"",r:"",s:"s",t:"",u:"",v:"",w:"",x:"x",y:"",z:""});const numberRegEx=/^\d(?:[\d,.]*\d)?$/;const latinRegEx=/[A-Ba-z]/;const primes=new Set(["\\prime","\\dprime","\\trprime","\\qprime","\\backprime","\\backdprime","\\backtrprime"]);const italicNumber=(e,t,n)=>{const r=new mathMLTree.MathNode(n,[e]);const o=new mathMLTree.MathNode("mstyle",[r]);o.style["font-style"]="italic";o.style["font-family"]="Cambria, 'Times New Roman', serif";if(t==="bold-italic"){o.style["font-weight"]="bold"}return o};defineFunctionBuilders({type:"mathord",mathmlBuilder(e,t){const n=makeText(e.text,e.mode,t);const r=n.text.codePointAt(0);const o=912<r&&r<938?"normal":"italic";const i=getVariant(e,t)||o;if(i==="script"){n.text=variantChar(n.text,i);return new mathMLTree.MathNode("mi",[n],[t.font])}else if(i!=="italic"){n.text=variantChar(n.text,i)}let s=new mathMLTree.MathNode("mi",[n]);if(i==="normal"){s.setAttribute("mathvariant","normal");if(n.text.length===1){s=new mathMLTree.MathNode("mrow",[s])}}return s}});defineFunctionBuilders({type:"textord",mathmlBuilder(e,t){let n=e.text;const r=n.codePointAt(0);if(t.fontFamily==="textsc"){if(96<r&&r<123){n=smallCaps[n]}}const o=makeText(n,e.mode,t);const i=getVariant(e,t)||"normal";let s;if(numberRegEx.test(e.text)){const t=e.mode==="text"?"mtext":"mn";if(i==="italic"||i==="bold-italic"){return italicNumber(o,i,t)}else{if(i!=="normal"){o.text=o.text.split("").map((e=>variantChar(e,i))).join("")}s=new mathMLTree.MathNode(t,[o])}}else if(e.mode==="text"){if(i!=="normal"){o.text=variantChar(o.text,i)}s=new mathMLTree.MathNode("mtext",[o])}else if(primes.has(e.text)){s=new mathMLTree.MathNode("mo",[o]);s.classes.push("tml-prime")}else{const e=o.text;if(i!=="italic"){o.text=variantChar(o.text,i)}s=new mathMLTree.MathNode("mi",[o]);if(o.text===e&&latinRegEx.test(e)){s.setAttribute("mathvariant","italic")}}return s}});const cssSpace={"\\nobreak":"nobreak","\\allowbreak":"allowbreak"};const regularSpace={" ":{},"\\ ":{},"~":{className:"nobreak"},"\\space":{},"\\nobreakspace":{className:"nobreak"}};defineFunctionBuilders({type:"spacing",mathmlBuilder(e,t){let n;if(Object.prototype.hasOwnProperty.call(regularSpace,e.text)){n=new mathMLTree.MathNode("mtext",[new mathMLTree.TextNode("")])}else if(Object.prototype.hasOwnProperty.call(cssSpace,e.text)){n=new mathMLTree.MathNode("mo");if(e.text==="\\nobreak"){n.setAttribute("linebreak","nobreak")}}else{throw new ParseError(`Unknown type of space "${e.text}"`)}return n}});defineFunctionBuilders({type:"tag"});const textFontFamilies={"\\text":undefined,"\\textrm":"textrm","\\textsf":"textsf","\\texttt":"texttt","\\textnormal":"textrm","\\textsc":"textsc"};const textFontWeights={"\\textbf":"textbf","\\textmd":"textmd"};const textFontShapes={"\\textit":"textit","\\textup":"textup"};const styleWithFont=(e,t)=>{const n=e.font;if(!n){return t}else if(textFontFamilies[n]){return t.withTextFontFamily(textFontFamilies[n])}else if(textFontWeights[n]){return t.withTextFontWeight(textFontWeights[n])}else if(n==="\\emph"){return t.fontShape==="textit"?t.withTextFontShape("textup"):t.withTextFontShape("textit")}return t.withTextFontShape(textFontShapes[n])};defineFunction({type:"text",names:["\\text","\\textrm","\\textsf","\\texttt","\\textnormal","\\textsc","\\textbf","\\textmd","\\textit","\\textup","\\emph"],props:{numArgs:1,argTypes:["text"],allowedInArgument:true,allowedInText:true},handler({parser:e,funcName:t},n){const r=n[0];return{type:"text",mode:e.mode,body:ordargument(r),font:t}},mathmlBuilder(e,t){const n=styleWithFont(e,t);const r=buildExpressionRow(e.body,n);return consolidateText(r)}});defineFunction({type:"verb",names:["\\verb"],props:{numArgs:0,allowedInText:true},handler(e,t,n){throw new ParseError("\\verb ended by end of line instead of matching delimiter")},mathmlBuilder(e,t){const n=new mathMLTree.TextNode(makeVerb(e));const r=new mathMLTree.MathNode("mtext",[n]);r.setAttribute("mathvariant","monospace");return r}});const makeVerb=e=>e.body.replace(/ /g,e.star?"":"");const functions=_functions;class SourceLocation{constructor(e,t,n){this.lexer=e;this.start=t;this.end=n}static range(e,t){if(!t){return e&&e.loc}else if(!e||!e.loc||!t.loc||e.loc.lexer!==t.loc.lexer){return null}else{return new SourceLocation(e.loc.lexer,e.loc.start,t.loc.end)}}}class Token{constructor(e,t){this.text=e;this.loc=t}range(e,t){return new Token(t,SourceLocation.range(this,e))}}const spaceRegexString="[ \r\n\t]";const controlWordRegexString="\\\\[a-zA-Z@]+";const controlSymbolRegexString="\\\\[^\ud800-\udfff]";const controlWordWhitespaceRegexString=`(${controlWordRegexString})${spaceRegexString}*`;const controlSpaceRegexString="\\\\(\n|[ \r\t]+\n?)[ \r\t]*";const combiningDiacriticalMarkString="[-]";const combiningDiacriticalMarksEndRegex=new RegExp(`${combiningDiacriticalMarkString}+$`);const tokenRegexString=`(${spaceRegexString}+)|`+`${controlSpaceRegexString}|`+"([!-\\[\\]---]"+`${combiningDiacriticalMarkString}*`+"|[\ud800-\udbff][\udc00-\udfff]"+`${combiningDiacriticalMarkString}*`+"|\\\\verb\\*([^]).*?\\4"+"|\\\\verb([^*a-zA-Z]).*?\\5"+`|${controlWordWhitespaceRegexString}`+`|${controlSymbolRegexString})`;class Lexer{constructor(e,t){this.input=e;this.settings=t;this.tokenRegex=new RegExp(tokenRegexString,"g");this.catcodes={"%":14,"~":13}}setCatcode(e,t){this.catcodes[e]=t}lex(){const e=this.input;const t=this.tokenRegex.lastIndex;if(t===e.length){return new Token("EOF",new SourceLocation(this,t,t))}const n=this.tokenRegex.exec(e);if(n===null||n.index!==t){throw new ParseError(`Unexpected character: '${e[t]}'`,new Token(e[t],new SourceLocation(this,t,t+1)))}const r=n[6]||n[3]||(n[2]?"\\ ":" ");if(this.catcodes[r]===14){const t=e.indexOf("\n",this.tokenRegex.lastIndex);if(t===-1){this.tokenRegex.lastIndex=e.length;if(this.settings.strict){throw new ParseError("% comment has no terminating newline; LaTeX would "+"fail because of commenting the end of math mode")}}else{this.tokenRegex.lastIndex=t+1}return this.lex()}return new Token(r,new SourceLocation(this,t,this.tokenRegex.lastIndex))}}class Namespace{constructor(e={},t={}){this.current=t;this.builtins=e;this.undefStack=[]}beginGroup(){this.undefStack.push({})}endGroup(){if(this.undefStack.length===0){throw new ParseError("Unbalanced namespace destruction: attempt "+"to pop global namespace; please report this as a bug")}const e=this.undefStack.pop();for(const t in e){if(Object.prototype.hasOwnProperty.call(e,t)){if(e[t]===undefined){delete this.current[t]}else{this.current[t]=e[t]}}}}has(e){return Object.prototype.hasOwnProperty.call(this.current,e)||Object.prototype.hasOwnProperty.call(this.builtins,e)}get(e){if(Object.prototype.hasOwnProperty.call(this.current,e)){return this.current[e]}else{return this.builtins[e]}}set(e,t,n=false){if(n){for(let t=0;t<this.undefStack.length;t++){delete this.undefStack[t][e]}if(this.undefStack.length>0){this.undefStack[this.undefStack.length-1][e]=t}}else{const t=this.undefStack[this.undefStack.length-1];if(t&&!Object.prototype.hasOwnProperty.call(t,e)){t[e]=this.current[e]}}this.current[e]=t}}const implicitCommands={"^":true,_:true,"\\limits":true,"\\nolimits":true};class MacroExpander{constructor(e,t,n){this.settings=t;this.expansionCount=0;this.feed(e);this.macros=new Namespace(macros,t.macros);this.mode=n;this.stack=[]}feed(e){this.lexer=new Lexer(e,this.settings)}switchMode(e){this.mode=e}beginGroup(){this.macros.beginGroup()}endGroup(){this.macros.endGroup()}future(){if(this.stack.length===0){this.pushToken(this.lexer.lex())}return this.stack[this.stack.length-1]}popToken(){this.future();return this.stack.pop()}pushToken(e){this.stack.push(e)}pushTokens(e){this.stack.push(...e)}scanArgument(e){let t;let n;let r;if(e){this.consumeSpaces();if(this.future().text!=="["){return null}t=this.popToken();({tokens:r,end:n}=this.consumeArg(["]"]))}else{({tokens:r,start:t,end:n}=this.consumeArg())}this.pushToken(new Token("EOF",n.loc));this.pushTokens(r);return t.range(n,"")}consumeSpaces(){for(;;){const e=this.future();if(e.text===" "){this.stack.pop()}else{break}}}consumeArg(e){const t=[];const n=e&&e.length>0;if(!n){this.consumeSpaces()}const r=this.future();let o;let i=0;let s=0;do{o=this.popToken();t.push(o);if(o.text==="{"){++i}else if(o.text==="}"){--i;if(i===-1){throw new ParseError("Extra }",o)}}else if(o.text==="EOF"){throw new ParseError("Unexpected end of input in a macro argument"+", expected '"+(e&&n?e[s]:"}")+"'",o)}if(e&&n){if((i===0||i===1&&e[s]==="{")&&o.text===e[s]){++s;if(s===e.length){t.splice(-s,s);break}}else{s=0}}}while(i!==0||n);if(r.text==="{"&&t[t.length-1].text==="}"){t.pop();t.shift()}t.reverse();return{tokens:t,start:r,end:o}}consumeArgs(e,t){if(t){if(t.length!==e+1){throw new ParseError("The length of delimiters doesn't match the number of args!")}const n=t[0];for(let e=0;e<n.length;e++){const t=this.popToken();if(n[e]!==t.text){throw new ParseError("Use of the macro doesn't match its definition",t)}}}const n=[];for(let r=0;r<e;r++){n.push(this.consumeArg(t&&t[r+1]).tokens)}return n}expandOnce(e){const t=this.popToken();const n=t.text;const r=!t.noexpand?this._getExpansion(n):null;if(r==null||e&&r.unexpandable){if(e&&r==null&&n[0]==="\\"&&!this.isDefined(n)){throw new ParseError("Undefined control sequence: "+n)}this.pushToken(t);return false}this.expansionCount++;if(this.expansionCount>this.settings.maxExpand){throw new ParseError("Too many expansions: infinite loop or "+"need to increase maxExpand setting")}let o=r.tokens;const i=this.consumeArgs(r.numArgs,r.delimiters);if(r.numArgs){o=o.slice();for(let e=o.length-1;e>=0;--e){let t=o[e];if(t.text==="#"){if(e===0){throw new ParseError("Incomplete placeholder at end of macro body",t)}t=o[--e];if(t.text==="#"){o.splice(e+1,1)}else if(/^[1-9]$/.test(t.text)){o.splice(e,2,...i[+t.text-1])}else{throw new ParseError("Not a valid argument number",t)}}}}this.pushTokens(o);return o.length}expandAfterFuture(){this.expandOnce();return this.future()}expandNextToken(){for(;;){if(this.expandOnce()===false){const e=this.stack.pop();if(e.treatAsRelax){e.text="\\relax"}return e}}throw new Error}expandMacro(e){return this.macros.has(e)?this.expandTokens([new Token(e)]):undefined}expandTokens(e){const t=[];const n=this.stack.length;this.pushTokens(e);while(this.stack.length>n){if(this.expandOnce(true)===false){const e=this.stack.pop();if(e.treatAsRelax){e.noexpand=false;e.treatAsRelax=false}t.push(e)}}return t}expandMacroAsText(e){const t=this.expandMacro(e);if(t){return t.map((e=>e.text)).join("")}else{return t}}_getExpansion(e){const t=this.macros.get(e);if(t==null){return t}if(e.length===1){const t=this.lexer.catcodes[e];if(t!=null&&t!==13){return}}const n=typeof t==="function"?t(this):t;if(typeof n==="string"){let e=0;if(n.indexOf("#")!==-1){const t=n.replace(/##/g,"");while(t.indexOf("#"+(e+1))!==-1){++e}}const t=new Lexer(n,this.settings);const r=[];let o=t.lex();while(o.text!=="EOF"){r.push(o);o=t.lex()}r.reverse();const i={tokens:r,numArgs:e};return i}return n}isDefined(e){return this.macros.has(e)||Object.prototype.hasOwnProperty.call(functions,e)||Object.prototype.hasOwnProperty.call(symbols.math,e)||Object.prototype.hasOwnProperty.call(symbols.text,e)||Object.prototype.hasOwnProperty.call(implicitCommands,e)}isExpandable(e){const t=this.macros.get(e);return t!=null?typeof t==="string"||typeof t==="function"||!t.unexpandable:Object.prototype.hasOwnProperty.call(functions,e)&&!functions[e].primitive}}const unicodeSubRegEx=/^[]/;const uSubsAndSups=Object.freeze({"":"+","":"-","":"=","":"(","":")","":"0","":"1","":"2","":"3","":"4","":"5","":"6","":"7","":"8","":"9","":"a","":"e","":"h","":"i","":"j","":"k","":"l","":"m","":"n","":"o","":"p","":"r","":"s","":"t","":"u","":"v","":"x","":"","":"","":"","":"","":"","":"+","":"-","":"=","":"(","":")","":"0","":"1","":"2","":"3","":"4","":"5","":"6","":"7","":"8","":"9","":"A","":"B","":"D","":"E","":"G","":"H","":"I","":"J","":"K","":"L","":"M","":"N","":"O","":"P","":"R","":"T","":"U","":"V","":"W","":"a","":"b","":"c","":"d","":"e","":"f","":"g","":"h","":"i","":"j","":"k","":"l","":"m","":"n","":"o","":"p","":"r","":"s","":"t","":"u","":"v","":"w","":"x","":"y","":"z","":"","":"","":"","":"","":"","":""});const asciiFromScript=Object.freeze({"":"A","":"B","":"C","":"D","":"E","":"F","":"G","":"H","":"I","":"J","":"K","":"L","":"M","":"N","":"O","":"P","":"Q","":"R","":"S","":"T","":"U","":"V","":"W","":"X","":"Y","":"Z"});var unicodeAccents={"":{text:"\\'",math:"\\acute"},"":{text:"\\`",math:"\\grave"},"":{text:'\\"',math:"\\ddot"},"":{text:"\\~",math:"\\tilde"},"":{text:"\\=",math:"\\bar"},"":{text:"\\u",math:"\\breve"},"":{text:"\\v",math:"\\check"},"":{text:"\\^",math:"\\hat"},"":{text:"\\.",math:"\\dot"},"":{text:"\\r",math:"\\mathring"},"":{text:"\\H"},"":{text:"\\c"}};var unicodeSymbols={"":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"b","":"c","":"c","":"c","":"c","":"d","":"d","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"f","":"g","":"g","":"g","":"g","":"g","":"g","":"h","":"h","":"h","":"h","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"j","":"j","":"k","":"k","":"l","":"l","":"m","":"m","":"n","":"n","":"n","":"n","":"n","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"p","":"p","":"r","":"r","":"r","":"s","":"s","":"s","":"s","":"s","":"s","":"t","":"t","":"t","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"v","":"w","":"w","":"w","":"w","":"w","":"w","":"x","":"x","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"z","":"z","":"z","":"z","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"B","":"C","":"C","":"C","":"C","":"D","":"D","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"F","":"G","":"G","":"G","":"G","":"G","":"G","":"H","":"H","":"H","":"H","":"I","":"I","":"I","":"I","":"I","":"I","":"I","":"I","":"I","":"I","":"J","":"K","":"K","":"L","":"L","":"M","":"M","":"N","":"N","":"N","":"N","":"N","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"P","":"P","":"R","":"R","":"R","":"S","":"S","":"S","":"S","":"S","":"S","":"T","":"T","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"V","":"W","":"W","":"W","":"W","":"W","":"X","":"X","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Z","":"Z","":"Z","":"Z","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};const binLeftCancellers=["bin","op","open","punct","rel"];const sizeRegEx=/([-+]?) *(\d+(?:\.\d*)?|\.\d+) *([a-z]{2})/;class Parser{constructor(e,t,n=false){this.mode="math";this.gullet=new MacroExpander(e,t,this.mode);this.settings=t;this.isPreamble=n;this.leftrightDepth=0;this.prevAtomType=""}expect(e,t=true){if(this.fetch().text!==e){throw new ParseError(`Expected '${e}', got '${this.fetch().text}'`,this.fetch())}if(t){this.consume()}}consume(){this.nextToken=null}fetch(){if(this.nextToken==null){this.nextToken=this.gullet.expandNextToken()}return this.nextToken}switchMode(e){this.mode=e;this.gullet.switchMode(e)}parse(){this.gullet.beginGroup();if(this.settings.colorIsTextColor){this.gullet.macros.set("\\color","\\textcolor")}const e=this.parseExpression(false);this.expect("EOF");if(this.isPreamble){const e=Object.create(null);Object.entries(this.gullet.macros.current).forEach((([t,n])=>{e[t]=n}));this.gullet.endGroup();return e}const t=this.gullet.macros.get("\\df@tag");this.gullet.endGroup();if(t){this.gullet.macros.current["\\df@tag"]=t}return e}static get endOfExpression(){return["}","\\endgroup","\\end","\\right","\\endtoggle","&"]}subparse(e){const t=this.nextToken;this.consume();this.gullet.pushToken(new Token("}"));this.gullet.pushTokens(e);const n=this.parseExpression(false);this.expect("}");this.nextToken=t;return n}parseExpression(e,t,n){const r=[];this.prevAtomType="";while(true){if(this.mode==="math"){this.consumeSpaces()}const o=this.fetch();if(Parser.endOfExpression.indexOf(o.text)!==-1){break}if(t&&o.text===t){break}if(n&&o.text==="\\middle"){break}if(e&&functions[o.text]&&functions[o.text].infix){break}const i=this.parseAtom(t);if(!i){break}else if(i.type==="internal"){continue}r.push(i);this.prevAtomType=i.type==="atom"?i.family:i.type}if(this.mode==="text"){this.formLigatures(r)}return this.handleInfixNodes(r)}handleInfixNodes(e){let t=-1;let n;for(let r=0;r<e.length;r++){if(e[r].type==="infix"){if(t!==-1){throw new ParseError("only one infix operator per group",e[r].token)}t=r;n=e[r].replaceWith}}if(t!==-1&&n){let r;let o;const i=e.slice(0,t);const s=e.slice(t+1);if(i.length===1&&i[0].type==="ordgroup"){r=i[0]}else{r={type:"ordgroup",mode:this.mode,body:i}}if(s.length===1&&s[0].type==="ordgroup"){o=s[0]}else{o={type:"ordgroup",mode:this.mode,body:s}}let a;if(n==="\\\\abovefrac"){a=this.callFunction(n,[r,e[t],o],[])}else{a=this.callFunction(n,[r,o],[])}return[a]}else{return e}}handleSupSubscript(e){const t=this.fetch();const n=t.text;this.consume();this.consumeSpaces();const r=this.parseGroup(e);if(!r){throw new ParseError("Expected group after '"+n+"'",t)}return r}formatUnsupportedCmd(e){const t=[];for(let n=0;n<e.length;n++){t.push({type:"textord",mode:"text",text:e[n]})}const n={type:"text",mode:this.mode,body:t};const r={type:"color",mode:this.mode,color:this.settings.errorColor,body:[n]};return r}parseAtom(e){const t=this.parseGroup("atom",e);if(this.mode==="text"){return t}let n;let r;while(true){this.consumeSpaces();const e=this.fetch();if(e.text==="\\limits"||e.text==="\\nolimits"){if(t&&t.type==="op"){const n=e.text==="\\limits";t.limits=n;t.alwaysHandleSupSub=true}else if(t&&t.type==="operatorname"){if(t.alwaysHandleSupSub){t.limits=e.text==="\\limits"}}else{throw new ParseError("Limit controls must follow a math operator",e)}this.consume()}else if(e.text==="^"){if(n){throw new ParseError("Double superscript",e)}n=this.handleSupSubscript("superscript")}else if(e.text==="_"){if(r){throw new ParseError("Double subscript",e)}r=this.handleSupSubscript("subscript")}else if(e.text==="'"){if(n){throw new ParseError("Double superscript",e)}const t={type:"textord",mode:this.mode,text:"\\prime"};const r=[t];this.consume();while(this.fetch().text==="'"){r.push(t);this.consume()}if(this.fetch().text==="^"){r.push(this.handleSupSubscript("superscript"))}n={type:"ordgroup",mode:this.mode,body:r}}else if(uSubsAndSups[e.text]){const t=unicodeSubRegEx.test(e.text);const o=[];o.push(new Token(uSubsAndSups[e.text]));this.consume();while(true){const e=this.fetch().text;if(!uSubsAndSups[e]){break}if(unicodeSubRegEx.test(e)!==t){break}o.unshift(new Token(uSubsAndSups[e]));this.consume()}const i=this.subparse(o);if(t){r={type:"ordgroup",mode:"math",body:i}}else{n={type:"ordgroup",mode:"math",body:i}}}else{break}}if(n||r){if(t&&t.type==="multiscript"&&!t.postscripts){t.postscripts={sup:n,sub:r};return t}else{const e=!t||t.type!=="op"&&t.type!=="operatorname"?undefined:isDelimiter(this.nextToken.text);return{type:"supsub",mode:this.mode,base:t,sup:n,sub:r,isFollowedByDelimiter:e}}}else{return t}}parseFunction(e,t){const n=this.fetch();const r=n.text;const o=functions[r];if(!o){return null}this.consume();if(t&&t!=="atom"&&!o.allowedInArgument){throw new ParseError("Got function '"+r+"' with no arguments"+(t?" as "+t:""),n)}else if(this.mode==="text"&&!o.allowedInText){throw new ParseError("Can't use function '"+r+"' in text mode",n)}else if(this.mode==="math"&&o.allowedInMath===false){throw new ParseError("Can't use function '"+r+"' in math mode",n)}const i=this.prevAtomType;const{args:s,optArgs:a}=this.parseArguments(r,o);this.prevAtomType=i;return this.callFunction(r,s,a,n,e)}callFunction(e,t,n,r,o){const i={funcName:e,parser:this,token:r,breakOnTokenText:o};const s=functions[e];if(s&&s.handler){return s.handler(i,t,n)}else{throw new ParseError(`No function handler for ${e}`)}}parseArguments(e,t){const n=t.numArgs+t.numOptionalArgs;if(n===0){return{args:[],optArgs:[]}}const r=[];const o=[];for(let i=0;i<n;i++){let n=t.argTypes&&t.argTypes[i];const s=i<t.numOptionalArgs;if(t.primitive&&n==null||t.type==="sqrt"&&i===1&&o[0]==null){n="primitive"}const a=this.parseGroupOfType(`argument to '${e}'`,n,s);if(s){o.push(a)}else if(a!=null){r.push(a)}else{throw new ParseError("Null argument, please report this as a bug")}}return{args:r,optArgs:o}}parseGroupOfType(e,t,n){switch(t){case"size":return this.parseSizeGroup(n);case"url":return this.parseUrlGroup(n);case"math":case"text":return this.parseArgumentGroup(n,t);case"hbox":{const e=this.parseArgumentGroup(n,"text");return e!=null?{type:"styling",mode:e.mode,body:[e],scriptLevel:"text"}:null}case"raw":{const e=this.parseStringGroup("raw",n);return e!=null?{type:"raw",mode:"text",string:e.text}:null}case"primitive":{if(n){throw new ParseError("A primitive argument cannot be optional")}const t=this.parseGroup(e);if(t==null){throw new ParseError("Expected group as "+e,this.fetch())}return t}case"original":case null:case undefined:return this.parseArgumentGroup(n);default:throw new ParseError("Unknown group type as "+e,this.fetch())}}consumeSpaces(){while(true){const e=this.fetch().text;if(e===" "||e===""||e===""){this.consume()}else{break}}}parseStringGroup(e,t){const n=this.gullet.scanArgument(t);if(n==null){return null}let r="";let o;while((o=this.fetch()).text!=="EOF"){r+=o.text;this.consume()}this.consume();n.text=r;return n}parseRegexGroup(e,t){const n=this.fetch();let r=n;let o="";let i;while((i=this.fetch()).text!=="EOF"&&e.test(o+i.text)){r=i;o+=r.text;this.consume()}if(o===""){throw new ParseError("Invalid "+t+": '"+n.text+"'",n)}return n.range(r,o)}parseSizeGroup(e){let t;let n=false;this.gullet.consumeSpaces();if(!e&&this.gullet.future().text!=="{"){t=this.parseRegexGroup(/^[-+]? *(?:$|\d+|\d+\.\d*|\.\d*) *[a-z]{0,2} *$/,"size")}else{t=this.parseStringGroup("size",e)}if(!t){return null}if(!e&&t.text.length===0){t.text="0pt";n=true}const r=sizeRegEx.exec(t.text);if(!r){throw new ParseError("Invalid size: '"+t.text+"'",t)}const o={number:+(r[1]+r[2]),unit:r[3]};if(!validUnit(o)){throw new ParseError("Invalid unit: '"+o.unit+"'",t)}return{type:"size",mode:this.mode,value:o,isBlank:n}}parseUrlGroup(e){this.gullet.lexer.setCatcode("%",13);this.gullet.lexer.setCatcode("~",12);const t=this.parseStringGroup("url",e);this.gullet.lexer.setCatcode("%",14);this.gullet.lexer.setCatcode("~",13);if(t==null){return null}let n=t.text.replace(/\\([#$%&~_^{}])/g,"$1");n=t.text.replace(/{\u2044}/g,"/");return{type:"url",mode:this.mode,url:n}}parseArgumentGroup(e,t){const n=this.gullet.scanArgument(e);if(n==null){return null}const r=this.mode;if(t){this.switchMode(t)}this.gullet.beginGroup();const o=this.parseExpression(false,"EOF");this.expect("EOF");this.gullet.endGroup();const i={type:"ordgroup",mode:this.mode,loc:n.loc,body:o};if(t){this.switchMode(r)}return i}parseGroup(e,t){const n=this.fetch();const r=n.text;let o;if(r==="{"||r==="\\begingroup"||r==="\\toggle"){this.consume();const e=r==="{"?"}":r==="\\begingroup"?"\\endgroup":"\\endtoggle";this.gullet.beginGroup();const t=this.parseExpression(false,e);const i=this.fetch();this.expect(e);this.gullet.endGroup();o={type:i.text==="\\endtoggle"?"toggle":"ordgroup",mode:this.mode,loc:SourceLocation.range(n,i),body:t,semisimple:r==="\\begingroup"||undefined}}else{o=this.parseFunction(t,e)||this.parseSymbol();if(o==null&&r[0]==="\\"&&!Object.prototype.hasOwnProperty.call(implicitCommands,r)){o=this.formatUnsupportedCmd(r);this.consume()}}return o}formLigatures(e){let t=e.length-1;for(let n=0;n<t;++n){const r=e[n];const o=r.text;if(o==="-"&&e[n+1].text==="-"){if(n+1<t&&e[n+2].text==="-"){e.splice(n,3,{type:"textord",mode:"text",loc:SourceLocation.range(r,e[n+2]),text:"---"});t-=2}else{e.splice(n,2,{type:"textord",mode:"text",loc:SourceLocation.range(r,e[n+1]),text:"--"});t-=1}}if((o==="'"||o==="`")&&e[n+1].text===o){e.splice(n,2,{type:"textord",mode:"text",loc:SourceLocation.range(r,e[n+1]),text:o+o});t-=1}}}parseSymbol(){const e=this.fetch();let t=e.text;if(/^\\verb[^a-zA-Z]/.test(t)){this.consume();let e=t.slice(5);const n=e.charAt(0)==="*";if(n){e=e.slice(1)}if(e.length<2||e.charAt(0)!==e.slice(-1)){throw new ParseError(`\\verb assertion failed --\n                    please report what input caused this bug`)}e=e.slice(1,-1);return{type:"verb",mode:"text",body:e,star:n}}if(Object.prototype.hasOwnProperty.call(unicodeSymbols,t[0])&&this.mode==="math"&&!symbols[this.mode][t[0]]){if(this.settings.strict&&this.mode==="math"){throw new ParseError(`Accented Unicode text character "${t[0]}" used in `+`math mode`,e)}t=unicodeSymbols[t[0]]+t.slice(1)}const n=this.mode==="math"?combiningDiacriticalMarksEndRegex.exec(t):null;if(n){t=t.substring(0,n.index);if(t==="i"){t=""}else if(t==="j"){t=""}}let r;if(symbols[this.mode][t]){let n=symbols[this.mode][t].group;if(n==="bin"&&binLeftCancellers.includes(this.prevAtomType)){n="open"}const o=SourceLocation.range(e);let i;if(Object.prototype.hasOwnProperty.call(ATOMS,n)){const e=n;i={type:"atom",mode:this.mode,family:e,loc:o,text:t}}else{if(asciiFromScript[t]){this.consume();const e=this.fetch().text.charCodeAt(0);const n=e===65025?"mathscr":"mathcal";if(e===65024||e===65025){this.consume()}return{type:"font",mode:"math",font:n,body:{type:"mathord",mode:"math",loc:o,text:asciiFromScript[t]}}}i={type:n,mode:this.mode,loc:o,text:t}}r=i}else if(t.charCodeAt(0)>=128||combiningDiacriticalMarksEndRegex.exec(t)){if(this.settings.strict&&this.mode==="math"){throw new ParseError(`Unicode text character "${t[0]}" used in math mode`,e)}r={type:"textord",mode:"text",loc:SourceLocation.range(e),text:t}}else{return null}this.consume();if(n){for(let t=0;t<n[0].length;t++){const o=n[0][t];if(!unicodeAccents[o]){throw new ParseError(`Unknown accent ' ${o}'`,e)}const i=unicodeAccents[o][this.mode]||unicodeAccents[o].text;if(!i){throw new ParseError(`Accent ${o} unsupported in ${this.mode} mode`,e)}r={type:"accent",mode:this.mode,loc:SourceLocation.range(e),label:i,isStretchy:false,base:r}}}return r}}const parseTree=function(e,t){if(!(typeof e==="string"||e instanceof String)){throw new TypeError("Temml can only parse string typed expression")}const n=new Parser(e,t);delete n.gullet.macros.current["\\df@tag"];let r=n.parse();if(!(r.length>0&&r[0].type&&r[0].type==="array"&&r[0].addEqnNum)){if(n.gullet.macros.get("\\df@tag")){if(!t.displayMode){throw new ParseError("\\tag works only in display mode")}n.gullet.feed("\\df@tag");r=[{type:"tag",mode:"text",body:r,tag:n.parse()}]}}return r};const subOrSupLevel=[2,2,3,3];class Style{constructor(e){this.level=e.level;this.color=e.color;this.font=e.font||"";this.fontFamily=e.fontFamily||"";this.fontSize=e.fontSize||1;this.fontWeight=e.fontWeight||"";this.fontShape=e.fontShape||"";this.maxSize=e.maxSize}extend(e){const t={level:this.level,color:this.color,font:this.font,fontFamily:this.fontFamily,fontSize:this.fontSize,fontWeight:this.fontWeight,fontShape:this.fontShape,maxSize:this.maxSize};for(const n in e){if(Object.prototype.hasOwnProperty.call(e,n)){t[n]=e[n]}}return new Style(t)}withLevel(e){return this.extend({level:e})}incrementLevel(){return this.extend({level:Math.min(this.level+1,3)})}inSubOrSup(){return this.extend({level:subOrSupLevel[this.level]})}withColor(e){return this.extend({color:e})}withFont(e){return this.extend({font:e})}withTextFontFamily(e){return this.extend({fontFamily:e,font:""})}withFontSize(e){return this.extend({fontSize:e})}withTextFontWeight(e){return this.extend({fontWeight:e,font:""})}withTextFontShape(e){return this.extend({fontShape:e,font:""})}getColor(){return this.color}}const version="0.10.32";function postProcess(e){const t={};let n=0;const r=e.getElementsByClassName("tml-tageqn");for(const e of r){const r=e.getElementsByClassName("tml-eqn");if(r.length>0){n+=1;r[0].id="tml-eqn-"+n}const o=e.getElementsByClassName("tml-label");if(o.length===0){continue}if(r.length>0){t[o[0].id]=String(n)}else{const n=e.getElementsByClassName("tml-tag");if(n.length>0){t[o[0].id]=n[0].textContent}}}const o=e.getElementsByClassName("tml-ref");[...o].forEach((e=>{let n=t[e.getAttribute("href").slice(1)];if(e.className.indexOf("tml-eqref")===-1){n=n.replace(/^\(/,"");n=n.replace(/\($/,"")}{if(n.charAt(0)!=="("){n="("+n}if(n.slice(-1)!==")"){n=n+")"}}e.textContent=n}))}let render$1=function(e,t,n={}){t.textContent="";const r=t.tagName.toLowerCase()==="math";if(r){n.wrap="none"}const o=renderToMathMLTree(e,n);if(r){t.textContent="";o.children.forEach((e=>{t.appendChild(e.toNode())}))}else if(o.children.length>1){t.textContent="";o.children.forEach((e=>{t.appendChild(e.toNode())}))}else{t.appendChild(o.toNode())}};if(typeof document!=="undefined"){if(document.compatMode!=="CSS1Compat"){typeof console!=="undefined"&&console.warn("Warning: Temml doesn't work in quirks mode. Make sure your "+"website has a suitable doctype.");render$1=function(){throw new ParseError("Temml doesn't work in quirks mode.")}}}const renderToString=function(e,t){const n=renderToMathMLTree(e,t).toMarkup();return n};const generateParseTree=function(e,t){const n=new Settings(t);return parseTree(e,n)};const definePreamble=function(e,t){const n=new Settings(t);n.macros={};if(!(typeof e==="string"||e instanceof String)){throw new TypeError("Temml can only parse string typed expression")}const r=new Parser(e,n,true);delete r.gullet.macros.current["\\df@tag"];const o=r.parse();return o};const renderError=function(e,t,n){if(n.throwOnError||!(e instanceof ParseError)){throw e}const r=new Span(["temml-error"],[new TextNode$1(t+"\n"+e.toString())]);r.style.color=n.errorColor;r.style.whiteSpace="pre-line";return r};const renderToMathMLTree=function(e,t){const n=new Settings(t);try{const t=parseTree(e,n);const r=new Style({level:n.displayMode?StyleLevel.DISPLAY:StyleLevel.TEXT,maxSize:n.maxSize});return buildMathML(t,e,r,n)}catch(t){return renderError(t,e,n)}};var temml={version:version,render:render$1,renderToString:renderToString,postProcess:postProcess,ParseError:ParseError,definePreamble:definePreamble,__parse:generateParseTree,__renderToMathMLTree:renderToMathMLTree,__defineSymbol:defineSymbol,__defineMacro:defineMacro};const render=(e,t,n)=>{temml.render(e,t,n)};var hurmet={parse:parse$1,calculate:calculate,compile:compile,md2ast:md2ast,md2html:md2html,hurmet2html:hurmet2html,scanModule:scanModule,updateCalculations:updateCalculations,render:render,Rnl:Rnl};function getCellAttrs(e,t){let n=e.getAttribute("data-colwidth");let r=n&&/^\d+(,\d+)*$/.test(n)?n.split(",").map((e=>Number(e))):null;let o=Number(e.getAttribute("colspan")||1);let i={colspan:o,rowspan:Number(e.getAttribute("rowspan")||1),colwidth:r&&r.length==o?r:null};for(let n in t){let r=t[n].getFromDOM;let o=r&&r(e);if(o!=null)i[n]=o}return i}function setCellAttrs(e,t){let n={};if(e.attrs.colspan!=1)n.colspan=e.attrs.colspan;if(e.attrs.rowspan!=1)n.rowspan=e.attrs.rowspan;if(e.attrs.colwidth)n["data-colwidth"]=e.attrs.colwidth.join(",");for(let r in t){let o=t[r].setDOMAttr;if(o)o(e.attrs[r],n)}return n}const functionOrModuleRegEx=/^ *(?:function|module) /;const nodes={doc:{content:"block+",attrs:{decimalFormat:{default:"1,000,000.",validate:"string"},dateFormat:{default:"yyyy-mm-dd",validate:"string"},inDraftMode:{default:false,validate:"boolean"},saveIsValid:{default:false,validate:"boolean"},fileHandle:{default:null,validate:"null|string"},saveDate:{default:null,validate:"null|string"},fontSize:{default:12,validate:"number|string"},pageSize:{default:"letter",validate:"string"},snapshots:{default:[]},fallbacks:{default:{}}}},fragment:{content:"block+"},paragraph:{content:"inline*",group:"block",parseDOM:[{tag:"p"}],toDOM(){return["p",0]}},indented:{content:"block+",group:"block",defining:true,parseDOM:[{tag:"div.indented"}],toDOM(){return["div",{class:"indented"},0]}},centered:{content:"block+",group:"block",defining:true,parseDOM:[{tag:"div.centered"}],toDOM(){return["div",{class:"centered"},0]}},right_justified:{content:"block+",group:"block",defining:true,parseDOM:[{tag:"div.right-justified"}],toDOM(){return["div",{class:"right-justified"},0]}},boxed:{content:"block+",group:"block",defining:true,parseDOM:[{tag:"div.boxed"}],toDOM(){return["div",{class:"boxed"},0]}},epigraph:{content:"block+",group:"block",defining:true,parseDOM:[{tag:"blockquote.epigraph"}],toDOM(){return["blockquote",{class:"epigraph"},0]}},blockquote:{content:"block+",group:"block",defining:true,parseDOM:[{tag:"blockquote"}],toDOM(){return["blockquote",0]}},note:{content:"block+",group:"block",defining:true,parseDOM:[{tag:"div.note"}],toDOM(){return["div",{class:"note"},0]}},tip:{content:"block+",group:"block",defining:true,parseDOM:[{tag:"div.tip"}],toDOM(){return["div",{class:"tip"},0]}},important:{content:"block+",group:"block",defining:true,parseDOM:[{tag:"div.important"}],toDOM(){return["div",{class:"important"},0]}},warning:{content:"block+",group:"block",defining:true,parseDOM:[{tag:"div.warning"}],toDOM(){return["div",{class:"warning"},0]}},horizontal_rule:{group:"block",parseDOM:[{tag:"hr"}],toDOM(){return["hr"]}},heading:{attrs:{level:{default:1,validate:"number"}},content:"inline*",group:"block",defining:true,parseDOM:[{tag:"h1",attrs:{level:1}},{tag:"h2",attrs:{level:2}},{tag:"h3",attrs:{level:3}},{tag:"h4",attrs:{level:4}},{tag:"h5",attrs:{level:5}},{tag:"h6",attrs:{level:6}}],toDOM(e){return["h"+e.attrs.level,0]}},code_block:{content:"text*",marks:"",group:"block",code:true,defining:true,parseDOM:[{tag:"pre",preserveWhitespace:"full"}],toDOM(){return["pre",["code",0]]}},text:{group:"inline"},image:{inline:true,attrs:{src:{validate:"string"},alt:{default:null,validate:"null|string"},width:{default:null,validate:"null|string"},class:{default:"inline",validate:"string"}},group:"inline",draggable:true,parseDOM:[{tag:"img[src]",getAttrs(e){return{src:e.getAttribute("src"),alt:e.getAttribute("alt"),width:e.getAttribute("width"),class:e.getAttribute("class")}}}],toDOM(e){return["img",e.attrs]}},figimg:{attrs:{src:{validate:"string"},alt:{default:null,validate:"null|string"},width:{default:null,validate:"null|string"}},group:"block",draggable:false,parseDOM:[{tag:"img.figimg",getAttrs(e){return{src:e.getAttribute("src"),alt:e.getAttribute("alt"),width:e.getAttribute("width"),class:"figimg"}}}],toDOM(e){return["img",e.attrs]}},figure:{content:"block{2,2}",attrs:{class:{default:"auto",validate:"string"}},group:"block",marks:"",parseDOM:[{tag:"figure",getAttrs(e){return{class:e.getAttribute("class")}}}],toDOM(e){return["figure",e.attrs,0]}},figcaption:{content:"inline*",attrs:{class:{default:null,validate:"null|string"}},group:"block",parseDOM:[{tag:"figcaption",getAttrs(e){return{class:e.getAttribute("class")}}}],toDOM(e){return["figcaption",e.attrs,0]}},footnote:{group:"inline",content:"inline*",inline:true,atom:true,toDOM:()=>["footnote",0],parseDOM:[{tag:"footnote"}]},toc:{atom:true,attrs:{start:{default:1,validate:"number"},end:{default:2,validate:"number"},body:{default:[]}},group:"block",draggable:true,parseDOM:[{tag:"ul.toc",getAttrs(e){const[t,n]=tocLevels(e.getAttribute("data-levels"));const r=JSON.parse(e.getAttribute("data-body"));return{start:t,end:n,body:r}}}],toDOM(e){const t=document.createElement("ul");t.dataset.levels=String(e.attrs.start)+".."+String(e.attrs.end);t.dataset.body=JSON.stringify(e.attrs.body);renderToC(e.attrs.body,t);return t}},ordered_list:{attrs:{class:{default:"decimal",validate:"string"},order:{default:1,validate:"number"}},content:"list_item+|tight_list_item+",group:"block",parseDOM:[{tag:"ol",getAttrs(e){return{class:e.getAttribute("class"),order:e.hasAttribute("start")?+e.getAttribute("start"):1}}}],toDOM(e){return e.attrs.order==1&&e.attrs.class==="decimal"?["ol",0]:e.attrs.order==1?["ol",{class:e.attrs.class},0]:e.attrs.class==="decimal"?["ol",{start:e.attrs.order},0]:["ol",{class:e.attrs.class,start:e.attrs.order},0]}},bullet_list:{content:"list_item+|tight_list_item+",group:"block",parseDOM:[{tag:"ul"}],toDOM(){return["ul",0]}},tight_list_item:{content:"paragraph",parseDOM:[{tag:"li.tight"}],toDOM(){return["li",{class:"tight"},0]},defining:true},list_item:{content:"block*",parseDOM:[{tag:"li"}],toDOM(){return["li",0]},defining:true},hard_break:{inline:true,group:"inline",selectable:false,parseDOM:[{tag:"br"}],toDOM(){return["br"]}},table:{content:"table_row+",tableRole:"table",group:"block",attrs:{class:{default:"grid",validate:"string"},name:{default:"",validate:"string"},numRows:{default:0,validage:"number"},columnMap:{default:{}},unitMap:{default:[]},units:{default:{}},rowMap:{default:{}},dependencies:{default:null},dtype:{default:dt.NULL,validate:"number"}},parseDOM:[{tag:"table",getAttrs(e){const t=e.getAttribute("class");const n=t.indexOf(" spreadsheet")>-1?dt.SPREADSHEET:0;return{class:t||"grid",name:e.getAttribute("id"),dtype:n}}}],toDOM(e){return["table",{class:e.attrs.class,id:e.attrs.name},["tbody",0]]}},table_row:{content:"(table_cell | table_header)*",tableRole:"row",parseDOM:[{tag:"tr"}],toDOM(){return["tr",0]}},table_cell:{content:"block+|spreadsheet_cell",attrs:{colspan:{default:1,validate:"number"},rowspan:{default:1,validate:"number"},colwidth:{default:null},background:{default:null,validate:"null|string"}},tableRole:"cell",isolating:true,parseDOM:[{tag:"td",getAttrs:e=>getCellAttrs(e,[])}],toDOM(e){return["td",setCellAttrs(e,[]),0]}},table_header:{content:"block+",attrs:{colspan:{default:1,validate:"number"},rowspan:{default:1,validate:"number"},colwidth:{default:null},background:{default:null,validate:"null|string"}},tableRole:"header_cell",isolating:true,parseDOM:[{tag:"th",getAttrs:e=>getCellAttrs(e,[])}],toDOM(e){return["th",setCellAttrs(e,[]),0]}},header:{content:"table",group:"block",defining:true,parseDOM:[{tag:"header"}],toDOM(){return["header",0]}},spreadsheet_cell:{atom:true,defining:false,marks:"",group:"block",attrs:{entry:{default:"",validate:"string"},name:{default:"",validate:"string"},rpn:{default:"",validate:"string"},resulttemplate:{default:"@",validate:"string"},altresulttemplate:{default:"@",validate:"string"},resultdisplay:{default:"@",validate:"string"},value:{default:null},dependencies:{default:[]},display:{default:"",validate:"string"},unit:{default:null},dtype:{default:0,validate:"number"}},parseDOM:[{tag:"div.hurmet-cell",getAttrs(e){return{entry:e.getAttribute("data-entry")}}}],toDOM(e){let t;t=document.createElement("div");t.classList="hurmet-cell";t.dataset.entry=e.attrs.entry;t.innerHTML=e.attrs.display?e.attrs.display:e.attrs.entry;return t}},calculation:{atom:true,defining:false,marks:"",group:"inline",inline:true,attrs:{entry:{default:""},displayMode:{default:false},name:{default:null},tex:{default:""},alt:{default:""},md:{default:null},displaySelector:{default:""},rpn:{default:null},dependencies:{default:[]},inDraftMode:{default:false},resulttemplate:{default:null},altresulttemplate:{default:null},resultdisplay:{default:null},template:{default:null},altTemplate:{default:""},value:{default:null},unit:{default:null},dtype:{default:0},isFetch:{default:false},fallback:{default:""},error:{default:false}},parseDOM:[{tag:"span.hurmet-calc",getAttrs(e){const t=Boolean(e.getAttribute("data-display"))||false;return{entry:e.getAttribute("data-entry"),displayMode:t}}}],toDOM(e){let t;t=document.createElement("span");t.classList="hurmet-calc";if(e.attrs.dtype&&e.attrs.dtype===dt.DRAWING){t=document.createElement("span");if(e.attrs.resultdisplay.attrs.float){t.style.float=e.attrs.resultdisplay.attrs.float}t.appendChild(renderSVG(e.attrs.resultdisplay))}else if(e.attrs.dtype&&e.attrs.dtype===dt.MODULE&&functionOrModuleRegEx.test(e.attrs.entry)){t.appendChild(document.createElement("span"));t.firstChild.className="hmt-code";t.firstChild.textContent=e.attrs.entry}else if(e.attrs.inDraftMode||!e.attrs.tex){t.appendChild(document.createElement("span"));t.firstChild.className="hmt-code";t.firstChild.textContent=e.attrs.alt?e.attrs.alt:e.attrs.entry}else{const n=e.attrs.tex;hurmet.render(n,t,{displayMode:e.attrs.displayMode,trust:e=>e.command==="\\class"&&(e.class==="special-fraction"||e.class==="date-result"),wrap:"="})}if(e.attrs.displayMode){t.firstChild.style.display="inline-block"}t.dataset.entry=e.attrs.entry;if(e.attrs.displayMode){t.dataset.display="true"}else if("display"in t.dataset){delete t.dataset.display}return t}},tex:{atom:true,marks:"",group:"inline",inline:true,attrs:{tex:{default:"",validate:"string"},displayMode:{default:false,validate:"boolean"}},parseDOM:[{tag:"span.hurmet-tex",getAttrs(e){const t=Boolean(e.getAttribute("data-display"))||false;return{tex:e.getAttribute("data-tex"),displayMode:t}}}],toDOM(e){const t=document.createElement("span");t.classList="hurmet-tex";const n=e.attrs.tex;t.dataset.tex=n;if(e.attrs.displayMode){t.dataset.display="true"}else if("display"in t.dataset){delete t.dataset.display}hurmet.render(n,t,{displayMode:e.attrs.displayMode,wrap:"="});if(e.attrs.displayMode){t.firstChild.style.display="inline-block"}return t}},comment:{content:"block+",group:"block",isolating:true,parseDOM:[{tag:"aside.comment"}],toDOM(e){return["aside",{class:"comment"},0]}}};const marks={link:{attrs:{href:{}},inclusive:false,parseDOM:[{tag:"a[href]",getAttrs(e){return{href:e.getAttribute("href")}}}],toDOM(e){e.attrs.title=e.attrs.href;return["a",e.attrs]}},em:{parseDOM:[{tag:"i"},{tag:"em"},{style:"font-style=italic"}],toDOM(){return["em"]}},strong:{parseDOM:[{tag:"strong"},{tag:"b",getAttrs:e=>e.style.fontWeight!="normal"&&null},{style:"font-weight",getAttrs:e=>/^(bold(er)?|[5-9]\d{2,})$/.test(e)&&null}],toDOM(){return["strong"]}},code:{parseDOM:[{tag:"code"}],toDOM(){return["code"]}},subscript:{excludes:"superscript",parseDOM:[{tag:"sub"}],toDOM(){return["sub"]}},superscript:{excludes:"subscript",parseDOM:[{tag:"sup"}],toDOM(){return["sup"]}},strikethru:{parseDOM:[{tag:"del"}],toDOM(){return["del"]}},underline:{parseDOM:[{tag:"u"}],toDOM(){return["u"]}},highlight:{parseDOM:[{tag:"mark"}],toDOM(){return["mark"]}}};function wrapInList(e,t){return function(n,r){let{$from:o,$to:i}=n.selection;let s=o.blockRange(i),a=false,l=s;if(!s)return false;if(s.depth>=2&&o.node(s.depth-1).type.compatibleContent(e)&&s.startIndex==0){if(o.index(s.depth-1)==0)return false;let e=n.doc.resolve(s.start-2);l=new NodeRange(e,e,s.depth);if(s.endIndex<s.parent.childCount)s=new NodeRange(o,n.doc.resolve(i.end(s.depth)),s.depth);a=true}let c=findWrapping(l,e,t,s);if(!c)return false;if(r)r(doWrapInList(n.tr,s,c,a,e).scrollIntoView());return true}}function doWrapInList(e,t,n,r,o){let i=Fragment.empty;for(let e=n.length-1;e>=0;e--)i=Fragment.from(n[e].type.create(n[e].attrs,i));e.step(new ReplaceAroundStep(t.start-(r?2:0),t.end,t.start,t.end,new Slice(i,0,0),n.length,true));let s=0;for(let e=0;e<n.length;e++)if(n[e].type==o)s=e+1;let a=n.length-s;let l=t.start+n.length-(r?2:0),c=t.parent;for(let n=t.startIndex,r=t.endIndex,o=true;n<r;n++,o=false){if(!o&&canSplit(e.doc,l,a)){e.split(l,a);l+=2*a}l+=c.child(n).nodeSize}return e}const listItems=["list_item","tight_list_item"];function splitListItem(e){return function(t,n){let{$from:r,$to:o,node:i}=t.selection;if(i&&i.isBlock||r.depth<2||!r.sameParent(o))return false;let s=r.node(-1);if(!listItems.includes(s.type.name))return false;if(r.parent.content.size==0){if(r.depth==2||r.node(-3).type!=e||r.index(-2)!=r.node(-2).childCount-1)return false;if(n){let o=Fragment.empty,i=r.index(-1)>0;for(let e=r.depth-(i?1:2);e>=r.depth-3;e--)o=Fragment.from(r.node(e).copy(o));o=o.append(Fragment.from(e.createAndFill()));let s=t.tr.replace(r.before(i?null:-1),r.after(-3),new Slice(o,i?3:2,2));s.setSelection(t.selection.constructor.near(s.doc.resolve(r.pos+(i?3:2))));n(s.scrollIntoView())}return true}let a=o.pos==r.end()?s.contentMatchAt(0).defaultType:null;let l=t.tr.delete(r.pos,o.pos);let c=a&&[null,{type:a}];if(!canSplit(l.doc,r.pos,2,c))return false;if(n)n(l.split(r.pos,2,c).scrollIntoView());return true}}function liftListItem(e){return function(t,n){let{$from:r,$to:o}=t.selection;let i=r.blockRange(o,(t=>t.childCount&&t.firstChild.type==e));if(!i)return false;if(!n)return true;if(r.node(i.depth-1).type==e)return liftToOuterList(t,n,e,i);else return liftOutOfList(t,n,i)}}function liftToOuterList(e,t,n,r){let o=e.tr,i=r.end,s=r.$to.end(r.depth);if(i<s){o.step(new ReplaceAroundStep(i-1,s,i,s,new Slice(Fragment.from(n.create(null,r.parent.copy())),1,0),1,true));r=new NodeRange(o.doc.resolve(r.$from.pos),o.doc.resolve(s),r.depth)}t(o.lift(r,liftTarget(r)).scrollIntoView());return true}function liftOutOfList(e,t,n){let r=e.tr,o=n.parent;for(let e=n.end,t=n.endIndex-1,i=n.startIndex;t>i;t--){e-=o.child(t).nodeSize;r.delete(e-1,e+1)}let i=r.doc.resolve(n.start),s=i.nodeAfter;let a=n.startIndex==0,l=n.endIndex==o.childCount;let c=i.node(-1),d=i.index(-1);if(!c.canReplace(d+(a?0:1),d+1,s.content.append(l?Fragment.empty:Fragment.from(o))))return false;let u=i.pos,p=u+s.nodeSize;r.step(new ReplaceAroundStep(u-(a?1:0),p+(l?1:0),u+1,p-1,new Slice((a?Fragment.empty:Fragment.from(o.copy(Fragment.empty))).append(l?Fragment.empty:Fragment.from(o.copy(Fragment.empty))),a?0:1,l?0:1),a?0:1));t(r.scrollIntoView());return true}function sinkListItem(e){return function(t,n){let{$from:r,$to:o}=t.selection;let i=r.blockRange(o,(t=>t.childCount&&t.firstChild.type==e));if(!i)return false;let s=i.startIndex;if(s==0)return false;let a=i.parent,l=a.child(s-1);if(l.type!=e)return false;if(n){let r=l.lastChild&&l.lastChild.type==a.type;let o=Fragment.from(r?e.create():null);let s=new Slice(Fragment.from(e.create(null,Fragment.from(a.copy(o)))),r?3:1,0);let c=i.start,d=i.end;n(t.tr.step(new ReplaceAroundStep(c-(r?3:1),d,c,d,s,1,true)).scrollIntoView())}return true}}const schema=new Schema({nodes:nodes,marks:marks});const prefix$1="ProseMirror-prompt";function insertHint(e){if(e.inMathZone){const t=new Range;t.setStart(e.textNode,e.start);t.setEnd(e.textNode,e.end);const n=document.createElement("text");n.innerHTML=e.str;t.deleteContents();t.insertNode(n);const r=window.getSelection();r.removeAllRanges();r.addRange(t);r.collapseToEnd()}else{const t=e.state.tr;t.replaceSelectionWith(e.state.schema.text(e.str));e.dispatch(t)}document.getElementsByClassName("ProseMirror-prompt")[0].remove()}function openPrompt(e){const t=document.body.appendChild(document.createElement("div"));t.className=prefix$1;const n=e=>{if(!t.contains(e.target)){r()}};setTimeout((()=>window.addEventListener("mousedown",n)),50);const r=()=>{window.removeEventListener("mousedown",n);if(t.parentNode){t.parentNode.removeChild(t)}};const o=[];for(const t in e.fields){o.push(e.fields[t].render())}const i=document.createElement("button");i.type="submit";i.className=prefix$1+"-submit";i.textContent="OK";const s=document.createElement("button");s.type="button";s.className=prefix$1+"-cancel";s.textContent="Cancel";s.addEventListener("click",r);const a=t.appendChild(document.createElement("form"));if(e.title){a.appendChild(document.createElement("h5")).textContent=e.title}if(e.note){const t=document.createElement("p");t.textContent=e.note;a.append(t)}o.forEach((e=>{a.appendChild(document.createElement("div")).appendChild(e)}));if(e.radioButtons){const t=document.createElement("div");t.style.display="flex";t.style["flex-direction"]=e.radioButtons.direction;t.style.margin="8px 0 8px 0";const n=e.radioButtons.current;e.radioButtons.buttons.forEach((r=>{const o=document.createElement("span");const i=document.createElement("input");i.type="radio";i.name=e.radioButtons.name;i.value=r[0];i.setAttribute("id",r[0]);if(r[0]===n){i.setAttribute("checked",null)}const s=document.createElement("label");s.setAttribute("for",r[1]);s.appendChild(document.createTextNode(r[1]));o.appendChild(i);o.appendChild(s);t.appendChild(o)}));if(e.radioButtons.name!=="rounding"){a.appendChild(t)}else{const n=document.createElement("div");n.style.display="flex";n.style["flex-direction"]="row";n.style["align-items"]="center";n.appendChild(t);const r=document.createElement("div");r.style.display="flex";r.style["flex-direction"]="column";r.style.margin="3em";const o=document.createElement("label");r.appendChild(o);o.setAttribute("for","digits");o.textContent="Number of digits";const i=document.createElement("input");i.setAttribute("type","text");i.setAttribute("name","digits");i.style.width="3em";i.setAttribute("value",e.numDigits);r.appendChild(i);n.appendChild(r);a.appendChild(n)}}let l;if(e.checkbox){l=a.appendChild(document.createElement("input"));l.setAttribute("type","checkbox");l.setAttribute("id","checkbox");const t=a.appendChild(document.createElement("label"));t.setAttribute("for","checkbox");t.innerHTML=e.checkbox.name;if(e.checkbox.checked){l.checked=true}}else{l={checked:false}}if(e.hints){const t=document.getSelection();let n=t.anchorNode;let r=false;let o=-1;let i=-1;if(n.nodeType===3&&n.parentNode.parentNode.classList.contains("math-code")){r=true;o=Math.min(t.anchorOffset,t.extentOffset);i=Math.max(t.anchorOffset,t.extentOffset)}else if(n.nodeType===1&&n.parentNode.classList.contains("math-code")){r=true;if(n.children.length>0){n=n.firstChild;o=n.length;i=n.length}else{o=0;i=0}}else{o=e.state.selection.$from;i=e.state.selection.$to}if(e.title==="Display Selectors"){const t=a.appendChild(document.createElement("table"));t.className="ProseMirror grid c1c c2c";t.appendChild(document.createElement("tr"));t.firstChild.append(document.createElement("th"));t.firstChild.firstChild.textContent="Regular";t.firstChild.append(document.createElement("th"));t.firstChild.children[1].textContent="Unit-Aware";t.firstChild.append(document.createElement("th"));t.firstChild.children[2].textContent="How much to display?";for(let s=0;s<4;s++){t.appendChild(document.createElement("tr"));for(let a=0;a<3;a++){t.children[s+1].append(document.createElement("td"));if(a<2){const l=document.createElement("button");l.className="hint-button";l.textContent=e.hints[s][a];const c={inMathZone:r,start:o,end:i};if(r){c.textNode=n}else{c.state=e.state;c.dispatch=e.dispatch}c.str=l.textContent;l.addEventListener("click",(e=>insertHint(c)));t.children[s+1].children[a].append(l)}else{t.children[s+1].children[a].textContent=e.hints[s][a]}}}}else{const t=a.appendChild(document.createElement("div"));for(const s of e.hints){for(const a of s){const s=document.createElement("button");s.className="hint-button";const l={inMathZone:r,start:o,end:i};if(r){l.textNode=n}else{l.state=e.state;l.dispatch=e.dispatch}if(e.title==="Accents"){s.innerHTML=a[0];l.str=a[1]}else{s.innerHTML=a;l.str=a}s.addEventListener("click",(e=>insertHint(l)));t.appendChild(s)}t.appendChild(document.createElement("br"))}}}const c=a.appendChild(document.createElement("div"));c.className=prefix$1+"-buttons";c.appendChild(i);c.appendChild(document.createTextNode(" "));c.appendChild(s);if(e.useOkButton){c.lastChild.style.float="right";c.style.display="block"}const d=t.getBoundingClientRect();t.style.top=(window.innerHeight-d.height)/2+"px";t.style.left=(window.innerWidth-d.width)/2+"px";const u=()=>{const t=getValues(e.fields,o);if(e.radioButtons){if(e.radioButtons.name==="rounding"){t.value=a[e.radioButtons.name].value+a.digits.value}else if(e.radioButtons.name==="dateFormat"){t.format=a[e.radioButtons.name].value}else{t.class=a[e.radioButtons.name].value}}if(e.src&&!t.src){t.src=e.src}t.checkbox=l.checked;if(t){r();if(e.callback){e.callback(t)}}};a.addEventListener("submit",(e=>{e.preventDefault();u()}));a.addEventListener("keydown",(n=>{if(n.keyCode===27){n.preventDefault();r()}else if(n.keyCode===13){const t=e.useOkButton&&n.shiftKey?true:!e.useOkButton&&!(n.ctrlKey||n.metaKey||n.shiftKey)?true:false;if(t){n.preventDefault();u()}}else if(n.keyCode===9){window.setTimeout((()=>{if(!t.contains(document.activeElement)){r()}}),500)}}));const p=a.elements[0];if(p&&p.type&&p.type==="text"){p.focus()}}function getValues(e,t){const n=Object.create(null);let r=0;for(const o in e){const i=e[o];const s=t[r++];const a=s.tagname==="INPUT"?i.read(s):i.read(s.lastChild);const l=i.validate(a);if(l){reportInvalid(s,l);return null}n[o]=i.clean(a)}return n}function reportInvalid(e,t){const n=e.parentNode;const r=n.appendChild(document.createElement("div"));r.style.left=e.offsetLeft+e.offsetWidth+2+"px";r.style.top=e.offsetTop-5+"px";r.className="ProseMirror-invalid";r.textContent=t;setTimeout((()=>n.removeChild(r)),1500)}class Field{constructor(e){this.options=e}read(e){return e.value}validateType(e){}validate(e){if(!e&&this.options.required){return"Required field"}return this.validateType(e)||this.options.validate&&this.options.validate(e)}clean(e){return this.options.clean?this.options.clean(e):e}}class TextField extends Field{render(){const e=document.createElement("input");e.type="text";e.placeholder=this.options.label;e.value=this.options.value||"";e.autocomplete="off";if(this.options.leader){e.style.width="50px";const t=document.createElement("span");t.textContent=this.options.leader;const n=document.createElement("div");n.appendChild(t);n.appendChild(e);return n}else{return e}}}const prefix="ProseMirror-prompt";function openSelectPrompt(e,t,n){const r=document.body.appendChild(document.createElement("div"));r.className=prefix;const o=e=>{if(!r.contains(e.target)){i()}};setTimeout((()=>window.addEventListener("mousedown",o)),50);const i=()=>{window.removeEventListener("mousedown",o);if(r.parentNode){r.parentNode.removeChild(r)}};const s=r.appendChild(document.createElement("form"));s.appendChild(document.createElement("h5")).textContent=e;for(let e=0;e<t.length;e++){const r=document.createElement("button");r.type="button";r.className=prefix+"-button";r.textContent=t[e].textContent;r.dataset.pos=t[e].pos;r.onclick=function(e){const t=e.target.dataset.pos;i();n(t)};s.appendChild(r)}const a=r.getBoundingClientRect();r.style.top=(window.innerHeight-a.height)/2+"px";r.style.left=(window.innerWidth-a.width)/2+"px"}function draftMode(e,t,n){const r=!e.doc.attrs.inDraftMode;e.doc.attrs.inDraftMode=r;const o=e.tr;e.doc.nodesBetween(0,e.doc.content.size,(function(e,t){if(e.type.name==="calculation"){const i=Object.assign({},e.attrs);i.inDraftMode=r;o.replaceWith(t,t+1,n.createAndFill(i))}}));t(o)}const handleContents=(e,t,n,r)=>{if(/^/.test(n)){n=n.substring(3)}let o;if(r==="hurmet"){o=JSON.parse(n)}else if(r==="markdown"){const e=hurmet.md2ast(n);if(typeof e==="object"&&e.type&&e.type==="doc"){o=e}else{o={type:"doc",attrs:{decimalFormat:"1,000,000.",inDraftMode:false,fontSize:12,fileHandle:null,pageSize:"letter"},content:e}}o=JSON.parse(JSON.stringify(o))}const i=o.attrs.fontSize?Number(o.attrs.fontSize):12;const s=document.getElementById("editor-content");if(i===10&&s.classList.contains("pica")){s.classList.add("long-primer");s.classList.remove("pica")}else if(i===12&&s.classList.contains("long-primer")){s.classList.add("pica");s.classList.remove("long-primer")}document.getElementById("print-div").className=i===12?"ProseMirror pica":"ProseMirror long-primer";const a=o.attrs.pageSize?o.attrs.pageSize:"letter";const l=document.getElementById("pageStyle");l.innerHTML=a==="letter"?`@media print {@page{size: letter; margin: 16mm 0.75in 16mm 0.75in;}}`:`@media print {@page{size: A4; margin: 16mm 16.1mm 16mm 16.1mm;}}`;e.dispatch(e.state.tr.replaceWith(0,e.state.doc.content.size,t.nodeFromJSON(o)));e.state.doc.attrs.fontSize=i;e.state.doc.attrs.pageSize=a;if(o.attrs.saveDate){e.state.doc.attrs.saveDate=o.attrs.saveDate}if(o.attrs.snapshots){e.state.doc.attrs.snapshots=o.attrs.snapshots}if(o.attrs.fallbacks){e.state.doc.attrs.fallbacks=o.attrs.fallbacks}hurmet.updateCalculations(e,true);e.state.doc.attrs.fallbacks={}};async function getFile(e,t,n){const r={types:[{description:"Text",accept:{"text/*":[".md"]}}],excludeAcceptAllOption:true,multiple:false};const[o]=await window.showOpenFilePicker(r);const i=await o.getFile();const s=await i.text();e.state.doc.attrs.fileHandle=o;handleContents(e,t,s,n);document.title=o.name.replace(/\.md$/,"")}function readFile(e,t,n,r,o){if(window.showOpenFilePicker&&!(o==="hurmet")){getFile(n,r,o);e.doc.attrs.saveIsValid=true}else{const e=document.createElement("input");e.type="file";e.accept=o==="hurmet"?".hurmet":".md";e.onchange=t=>{const i=e.files[0];const s=new FileReader;s.onload=function(e){const t=e.target.result;handleContents(n,r,t,o)};s.readAsText(i)};e.click()}}var commonjsGlobal=typeof globalThis!=="undefined"?globalThis:typeof window!=="undefined"?window:typeof global!=="undefined"?global:typeof self!=="undefined"?self:{};var FileSaver={exports:{}};(function(e){
/*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */
var t=t||function(e){if(typeof navigator!=="undefined"&&/MSIE [1-9]\./.test(navigator.userAgent)){return}var t=e.document,n=function(){return e.URL||e.webkitURL||e},r=t.createElementNS("http://www.w3.org/1999/xhtml","a"),o="download"in r,i=function(e){var t=new MouseEvent("click");e.dispatchEvent(t)},s=/Version\/[\d\.]+.*Safari/.test(navigator.userAgent),a=e.webkitRequestFileSystem,l=e.requestFileSystem||a||e.mozRequestFileSystem,c=function(t){(e.setImmediate||e.setTimeout)((function(){throw t}),0)},d="application/octet-stream",u=0,p=1e3*40,f=function(e){var t=function(){if(typeof e==="string"){n().revokeObjectURL(e)}else{e.remove()}};setTimeout(t,p)},h=function(e,t,n){t=[].concat(t);var r=t.length;while(r--){var o=e["on"+t[r]];if(typeof o==="function"){try{o.call(e,n||e)}catch(e){c(e)}}}},m=function(e){if(/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)){return new Blob(["",e],{type:e.type})}return e},g=function(t,c,p){if(!p){t=m(t)}var g=this,y=t.type,b=false,x,w,S=function(){h(g,"writestart progress write writeend".split(" "))},R=function(){if(w&&s&&typeof FileReader!=="undefined"){var r=new FileReader;r.onloadend=function(){var e=r.result;w.location.href="data:attachment/file"+e.slice(e.search(/[,;]/));g.readyState=g.DONE;S()};r.readAsDataURL(t);g.readyState=g.INIT;return}if(b||!x){x=n().createObjectURL(t)}if(w){w.location.href=x}else{var o=e.open(x,"_blank");if(o===undefined&&s){e.location.href=x}}g.readyState=g.DONE;S();f(x)},v=function(e){return function(){if(g.readyState!==g.DONE){return e.apply(this,arguments)}}},M={create:true,exclusive:false},A;g.readyState=g.INIT;if(!c){c="download"}if(o){x=n().createObjectURL(t);setTimeout((function(){r.href=x;r.download=c;i(r);S();f(x);g.readyState=g.DONE}));return}if(e.chrome&&y&&y!==d){A=t.slice||t.webkitSlice;t=A.call(t,0,t.size,d);b=true}if(a&&c!=="download"){c+=".download"}if(y===d||a){w=e}if(!l){R();return}u+=t.size;l(e.TEMPORARY,u,v((function(e){e.root.getDirectory("saved",M,v((function(e){var n=function(){e.getFile(c,M,v((function(e){e.createWriter(v((function(n){n.onwriteend=function(t){w.location.href=e.toURL();g.readyState=g.DONE;h(g,"writeend",t);f(e)};n.onerror=function(){var e=n.error;if(e.code!==e.ABORT_ERR){R()}};"writestart progress write abort".split(" ").forEach((function(e){n["on"+e]=g["on"+e]}));n.write(t);g.abort=function(){n.abort();g.readyState=g.DONE};g.readyState=g.WRITING})),R)})),R)};e.getFile(c,{create:false},v((function(e){e.remove();n()})),v((function(e){if(e.code===e.NOT_FOUND_ERR){n()}else{R()}})))})),R)})),R)},y=g.prototype,b=function(e,t,n){return new g(e,t,n)};if(typeof navigator!=="undefined"&&navigator.msSaveOrOpenBlob){return function(e,t,n){if(!n){e=m(e)}return navigator.msSaveOrOpenBlob(e,t||"download")}}y.abort=function(){var e=this;e.readyState=e.DONE;h(e,"abort")};y.readyState=y.INIT=0;y.WRITING=1;y.DONE=2;y.error=y.onwritestart=y.onprogress=y.onwrite=y.onabort=y.onerror=y.onwriteend=null;return b}(typeof self!=="undefined"&&self||typeof window!=="undefined"&&window||commonjsGlobal.content);if(e.exports){e.exports.saveAs=t}})(FileSaver);var FileSaverExports=FileSaver.exports;const showDiff=e=>{const t="Show the difference since:";const n=[];const r=e.doc.attrs.snapshots;if(e.doc.attrs.snapshots.length===0){alert("There are no snapshots to diff.");return}for(let t=0;t<e.doc.attrs.snapshots.length;t++){n.push({textContent:new Date(r[t].date).toISOString().replace(/T.+/,"")+"  "+r[t].message,pos:t})}const o=t=>{const n=new diff_match_patch;const r=e.doc.attrs.snapshots[t].content;const o=hurmetMarkdownSerializer.serialize(e.doc,new Map,false,true);n.Diff_Timeout=2;n.Diff_EditCost=4;let i=n.diff_main(r,o);n.diff_cleanupSemantic(i);const s=n.diff_prettyHtml(i);const a=document.body.appendChild(document.createElement("div"));a.className="ProseMirror-prompt";a.style="width: 850px; height: 500px";a.id="";const l=a.appendChild(document.createElement("div"));l.style="width: 850px; max-height: 450px; overflow: scroll;";l.innerHTML=s;const c=a.appendChild(document.createElement("div"));c.style.height="10px";const d=document.createElement("button");d.type="button";d.style.marginRight="2em";d.textContent="Previous";d.onclick=function(e){const t=l.getBoundingClientRect().top;const n=Array.from(l.getElementsByClassName("diff"));for(let e=n.length-1;e>=0;e--){const r=n[e].getBoundingClientRect().bottom;if(r<t){n[e].scrollIntoView();l.scrollTo({top:l.scrollTop-80});break}}};a.appendChild(d);const u=document.createElement("button");u.type="button";u.style.marginRight="2em";u.textContent="Next";u.onclick=function(e){const t=l.getBoundingClientRect().bottom;const n=l.getElementsByClassName("diff");for(let e of[...n]){const n=e.getBoundingClientRect().top;if(n>t){e.scrollIntoView();l.scrollTo({top:l.scrollTop-80});break}}};a.appendChild(u);const p=document.createElement("button");p.type="button";p.textContent="Close";p.onclick=function(e){a.parentNode.removeChild(a)};a.appendChild(p);const f=a.getBoundingClientRect();a.style.top=(window.innerHeight-f.height)/2+"px";a.style.left=(window.innerWidth-f.width)/2+"px"};openSelectPrompt(t,n,o)};const diff_match_patch=function(){this.Diff_Timeout=1;this.Diff_EditCost=4;this.Match_Threshold=.5;this.Match_Distance=1e3;this.Patch_DeleteThreshold=.5;this.Patch_Margin=4;this.Match_MaxBits=32};var DIFF_DELETE=-1;var DIFF_INSERT=1;var DIFF_EQUAL=0;diff_match_patch.Diff=function(e,t){this[0]=e;this[1]=t};diff_match_patch.Diff.prototype.length=2;diff_match_patch.Diff.prototype.toString=function(){return this[0]+","+this[1]};diff_match_patch.prototype.diff_main=function(e,t,n,r){if(typeof r=="undefined"){if(this.Diff_Timeout<=0){r=Number.MAX_VALUE}else{r=(new Date).getTime()+this.Diff_Timeout*1e3}}var o=r;if(e==null||t==null){throw new Error("Null input. (diff_main)")}if(e==t){if(e){return[new diff_match_patch.Diff(DIFF_EQUAL,e)]}return[]}if(typeof n=="undefined"){n=true}var i=n;var s=this.diff_commonPrefix(e,t);var a=e.substring(0,s);e=e.substring(s);t=t.substring(s);s=this.diff_commonSuffix(e,t);var l=e.substring(e.length-s);e=e.substring(0,e.length-s);t=t.substring(0,t.length-s);var c=this.diff_compute_(e,t,i,o);if(a){c.unshift(new diff_match_patch.Diff(DIFF_EQUAL,a))}if(l){c.push(new diff_match_patch.Diff(DIFF_EQUAL,l))}this.diff_cleanupMerge(c);return c};diff_match_patch.prototype.diff_compute_=function(e,t,n,r){var o;if(!e){return[new diff_match_patch.Diff(DIFF_INSERT,t)]}if(!t){return[new diff_match_patch.Diff(DIFF_DELETE,e)]}var i=e.length>t.length?e:t;var s=e.length>t.length?t:e;var a=i.indexOf(s);if(a!=-1){o=[new diff_match_patch.Diff(DIFF_INSERT,i.substring(0,a)),new diff_match_patch.Diff(DIFF_EQUAL,s),new diff_match_patch.Diff(DIFF_INSERT,i.substring(a+s.length))];if(e.length>t.length){o[0][0]=o[2][0]=DIFF_DELETE}return o}if(s.length==1){return[new diff_match_patch.Diff(DIFF_DELETE,e),new diff_match_patch.Diff(DIFF_INSERT,t)]}var l=this.diff_halfMatch_(e,t);if(l){var c=l[0];var d=l[1];var u=l[2];var p=l[3];var f=l[4];var h=this.diff_main(c,u,n,r);var m=this.diff_main(d,p,n,r);return h.concat([new diff_match_patch.Diff(DIFF_EQUAL,f)],m)}if(n&&e.length>100&&t.length>100){return this.diff_lineMode_(e,t,r)}return this.diff_bisect_(e,t,r)};diff_match_patch.prototype.diff_lineMode_=function(e,t,n){var r=this.diff_linesToChars_(e,t);e=r.chars1;t=r.chars2;var o=r.lineArray;var i=this.diff_main(e,t,false,n);this.diff_charsToLines_(i,o);this.diff_cleanupSemantic(i);i.push(new diff_match_patch.Diff(DIFF_EQUAL,""));var s=0;var a=0;var l=0;var c="";var d="";while(s<i.length){switch(i[s][0]){case DIFF_INSERT:l++;d+=i[s][1];break;case DIFF_DELETE:a++;c+=i[s][1];break;case DIFF_EQUAL:if(a>=1&&l>=1){i.splice(s-a-l,a+l);s=s-a-l;var u=this.diff_main(c,d,false,n);for(var p=u.length-1;p>=0;p--){i.splice(s,0,u[p])}s=s+u.length}l=0;a=0;c="";d="";break}s++}i.pop();return i};diff_match_patch.prototype.diff_bisect_=function(e,t,n){var r=e.length;var o=t.length;var i=Math.ceil((r+o)/2);var s=i;var a=2*i;var l=new Array(a);var c=new Array(a);for(var d=0;d<a;d++){l[d]=-1;c[d]=-1}l[s+1]=0;c[s+1]=0;var u=r-o;var p=u%2!=0;var f=0;var h=0;var m=0;var g=0;for(var y=0;y<i;y++){if((new Date).getTime()>n){break}for(var b=-y+f;b<=y-h;b+=2){var x=s+b;var w;if(b==-y||b!=y&&l[x-1]<l[x+1]){w=l[x+1]}else{w=l[x-1]+1}var S=w-b;while(w<r&&S<o&&e.charAt(w)==t.charAt(S)){w++;S++}l[x]=w;if(w>r){h+=2}else if(S>o){f+=2}else if(p){var R=s+u-b;if(R>=0&&R<a&&c[R]!=-1){var v=r-c[R];if(w>=v){return this.diff_bisectSplit_(e,t,w,S,n)}}}}for(var M=-y+m;M<=y-g;M+=2){var R=s+M;var v;if(M==-y||M!=y&&c[R-1]<c[R+1]){v=c[R+1]}else{v=c[R-1]+1}var A=v-M;while(v<r&&A<o&&e.charAt(r-v-1)==t.charAt(o-A-1)){v++;A++}c[R]=v;if(v>r){g+=2}else if(A>o){m+=2}else if(!p){var x=s+u-M;if(x>=0&&x<a&&l[x]!=-1){var w=l[x];var S=s+w-x;v=r-v;if(w>=v){return this.diff_bisectSplit_(e,t,w,S,n)}}}}}return[new diff_match_patch.Diff(DIFF_DELETE,e),new diff_match_patch.Diff(DIFF_INSERT,t)]};diff_match_patch.prototype.diff_bisectSplit_=function(e,t,n,r,o){var i=e.substring(0,n);var s=t.substring(0,r);var a=e.substring(n);var l=t.substring(r);var c=this.diff_main(i,s,false,o);var d=this.diff_main(a,l,false,o);return c.concat(d)};diff_match_patch.prototype.diff_linesToChars_=function(e,t){var n=[];var r={};n[0]="";function o(e){var t="";var o=0;var s=-1;var a=n.length;while(s<e.length-1){s=e.indexOf("\n",o);if(s==-1){s=e.length-1}var l=e.substring(o,s+1);if(r.hasOwnProperty?r.hasOwnProperty(l):r[l]!==undefined){t+=String.fromCharCode(r[l])}else{if(a==i){l=e.substring(o);s=e.length}t+=String.fromCharCode(a);r[l]=a;n[a++]=l}o=s+1}return t}var i=4e4;var s=o(e);i=65535;var a=o(t);return{chars1:s,chars2:a,lineArray:n}};diff_match_patch.prototype.diff_charsToLines_=function(e,t){for(var n=0;n<e.length;n++){var r=e[n][1];var o=[];for(var i=0;i<r.length;i++){o[i]=t[r.charCodeAt(i)]}e[n][1]=o.join("")}};diff_match_patch.prototype.diff_commonPrefix=function(e,t){if(!e||!t||e.charAt(0)!=t.charAt(0)){return 0}var n=0;var r=Math.min(e.length,t.length);var o=r;var i=0;while(n<o){if(e.substring(i,o)==t.substring(i,o)){n=o;i=n}else{r=o}o=Math.floor((r-n)/2+n)}return o};diff_match_patch.prototype.diff_commonSuffix=function(e,t){if(!e||!t||e.charAt(e.length-1)!=t.charAt(t.length-1)){return 0}var n=0;var r=Math.min(e.length,t.length);var o=r;var i=0;while(n<o){if(e.substring(e.length-o,e.length-i)==t.substring(t.length-o,t.length-i)){n=o;i=n}else{r=o}o=Math.floor((r-n)/2+n)}return o};diff_match_patch.prototype.diff_commonOverlap_=function(e,t){var n=e.length;var r=t.length;if(n==0||r==0){return 0}if(n>r){e=e.substring(n-r)}else if(n<r){t=t.substring(0,n)}var o=Math.min(n,r);if(e==t){return o}var i=0;var s=1;while(true){var a=e.substring(o-s);var l=t.indexOf(a);if(l==-1){return i}s+=l;if(l==0||e.substring(o-s)==t.substring(0,s)){i=s;s++}}};diff_match_patch.prototype.diff_halfMatch_=function(e,t){if(this.Diff_Timeout<=0){return null}var n=e.length>t.length?e:t;var r=e.length>t.length?t:e;if(n.length<4||r.length*2<n.length){return null}var o=this;function i(e,t,n){var r=e.substring(n,n+Math.floor(e.length/4));var i=-1;var s="";var a,l,c,d;while((i=t.indexOf(r,i+1))!=-1){var u=o.diff_commonPrefix(e.substring(n),t.substring(i));var p=o.diff_commonSuffix(e.substring(0,n),t.substring(0,i));if(s.length<p+u){s=t.substring(i-p,i)+t.substring(i,i+u);a=e.substring(0,n-p);l=e.substring(n+u);c=t.substring(0,i-p);d=t.substring(i+u)}}if(s.length*2>=e.length){return[a,l,c,d,s]}else{return null}}var s=i(n,r,Math.ceil(n.length/4));var a=i(n,r,Math.ceil(n.length/2));var l;if(!s&&!a){return null}else if(!a){l=s}else if(!s){l=a}else{l=s[4].length>a[4].length?s:a}var c,d,u,p;if(e.length>t.length){c=l[0];d=l[1];u=l[2];p=l[3]}else{u=l[0];p=l[1];c=l[2];d=l[3]}var f=l[4];return[c,d,u,p,f]};diff_match_patch.prototype.diff_cleanupSemantic=function(e){var t=false;var n=[];var r=0;var o=null;var i=0;var s=0;var a=0;var l=0;var c=0;while(i<e.length){if(e[i][0]==DIFF_EQUAL){n[r++]=i;s=l;a=c;l=0;c=0;o=e[i][1]}else{if(e[i][0]==DIFF_INSERT){l+=e[i][1].length}else{c+=e[i][1].length}if(o&&o.length<=Math.max(s,a)&&o.length<=Math.max(l,c)){e.splice(n[r-1],0,new diff_match_patch.Diff(DIFF_DELETE,o));e[n[r-1]+1][0]=DIFF_INSERT;r--;r--;i=r>0?n[r-1]:-1;s=0;a=0;l=0;c=0;o=null;t=true}}i++}if(t){this.diff_cleanupMerge(e)}this.diff_cleanupSemanticLossless(e);i=1;while(i<e.length){if(e[i-1][0]==DIFF_DELETE&&e[i][0]==DIFF_INSERT){var d=e[i-1][1];var u=e[i][1];var p=this.diff_commonOverlap_(d,u);var f=this.diff_commonOverlap_(u,d);if(p>=f){if(p>=d.length/2||p>=u.length/2){e.splice(i,0,new diff_match_patch.Diff(DIFF_EQUAL,u.substring(0,p)));e[i-1][1]=d.substring(0,d.length-p);e[i+1][1]=u.substring(p);i++}}else{if(f>=d.length/2||f>=u.length/2){e.splice(i,0,new diff_match_patch.Diff(DIFF_EQUAL,d.substring(0,f)));e[i-1][0]=DIFF_INSERT;e[i-1][1]=u.substring(0,u.length-f);e[i+1][0]=DIFF_DELETE;e[i+1][1]=d.substring(f);i++}}i++}i++}};diff_match_patch.prototype.diff_cleanupSemanticLossless=function(e){function t(e,t){if(!e||!t){return 6}var n=e.charAt(e.length-1);var r=t.charAt(0);var o=n.match(diff_match_patch.nonAlphaNumericRegex_);var i=r.match(diff_match_patch.nonAlphaNumericRegex_);var s=o&&n.match(diff_match_patch.whitespaceRegex_);var a=i&&r.match(diff_match_patch.whitespaceRegex_);var l=s&&n.match(diff_match_patch.linebreakRegex_);var c=a&&r.match(diff_match_patch.linebreakRegex_);var d=l&&e.match(diff_match_patch.blanklineEndRegex_);var u=c&&t.match(diff_match_patch.blanklineStartRegex_);if(d||u){return 5}else if(l||c){return 4}else if(o&&!s&&a){return 3}else if(s||a){return 2}else if(o||i){return 1}return 0}var n=1;while(n<e.length-1){if(e[n-1][0]==DIFF_EQUAL&&e[n+1][0]==DIFF_EQUAL){var r=e[n-1][1];var o=e[n][1];var i=e[n+1][1];var s=this.diff_commonSuffix(r,o);if(s){var a=o.substring(o.length-s);r=r.substring(0,r.length-s);o=a+o.substring(0,o.length-s);i=a+i}var l=r;var c=o;var d=i;var u=t(r,o)+t(o,i);while(o.charAt(0)===i.charAt(0)){r+=o.charAt(0);o=o.substring(1)+i.charAt(0);i=i.substring(1);var p=t(r,o)+t(o,i);if(p>=u){u=p;l=r;c=o;d=i}}if(e[n-1][1]!=l){if(l){e[n-1][1]=l}else{e.splice(n-1,1);n--}e[n][1]=c;if(d){e[n+1][1]=d}else{e.splice(n+1,1);n--}}}n++}};diff_match_patch.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/;diff_match_patch.whitespaceRegex_=/\s/;diff_match_patch.linebreakRegex_=/[\r\n]/;diff_match_patch.blanklineEndRegex_=/\n\r?\n$/;diff_match_patch.blanklineStartRegex_=/^\r?\n\r?\n/;diff_match_patch.prototype.diff_cleanupMerge=function(e){e.push(new diff_match_patch.Diff(DIFF_EQUAL,""));var t=0;var n=0;var r=0;var o="";var i="";var s;while(t<e.length){switch(e[t][0]){case DIFF_INSERT:r++;i+=e[t][1];t++;break;case DIFF_DELETE:n++;o+=e[t][1];t++;break;case DIFF_EQUAL:if(n+r>1){if(n!==0&&r!==0){s=this.diff_commonPrefix(i,o);if(s!==0){if(t-n-r>0&&e[t-n-r-1][0]==DIFF_EQUAL){e[t-n-r-1][1]+=i.substring(0,s)}else{e.splice(0,0,new diff_match_patch.Diff(DIFF_EQUAL,i.substring(0,s)));t++}i=i.substring(s);o=o.substring(s)}s=this.diff_commonSuffix(i,o);if(s!==0){e[t][1]=i.substring(i.length-s)+e[t][1];i=i.substring(0,i.length-s);o=o.substring(0,o.length-s)}}t-=n+r;e.splice(t,n+r);if(o.length){e.splice(t,0,new diff_match_patch.Diff(DIFF_DELETE,o));t++}if(i.length){e.splice(t,0,new diff_match_patch.Diff(DIFF_INSERT,i));t++}t++}else if(t!==0&&e[t-1][0]==DIFF_EQUAL){e[t-1][1]+=e[t][1];e.splice(t,1)}else{t++}r=0;n=0;o="";i="";break}}if(e[e.length-1][1]===""){e.pop()}var a=false;t=1;while(t<e.length-1){if(e[t-1][0]==DIFF_EQUAL&&e[t+1][0]==DIFF_EQUAL){if(e[t][1].substring(e[t][1].length-e[t-1][1].length)==e[t-1][1]){e[t][1]=e[t-1][1]+e[t][1].substring(0,e[t][1].length-e[t-1][1].length);e[t+1][1]=e[t-1][1]+e[t+1][1];e.splice(t-1,1);a=true}else if(e[t][1].substring(0,e[t+1][1].length)==e[t+1][1]){e[t-1][1]+=e[t+1][1];e[t][1]=e[t][1].substring(e[t+1][1].length)+e[t+1][1];e.splice(t+1,1);a=true}}t++}if(a){this.diff_cleanupMerge(e)}};diff_match_patch.prototype.diff_xIndex=function(e,t){var n=0;var r=0;var o=0;var i=0;var s;for(s=0;s<e.length;s++){if(e[s][0]!==DIFF_INSERT){n+=e[s][1].length}if(e[s][0]!==DIFF_DELETE){r+=e[s][1].length}if(n>t){break}o=n;i=r}if(e.length!=s&&e[s][0]===DIFF_DELETE){return i}return i+(t-o)};diff_match_patch.prototype.diff_prettyHtml=function(e){var t=[];var n=/&/g;var r=/</g;var o=/>/g;var i=/\n/g;if(e.length===1&&e[0][0]===DIFF_EQUAL){return"<span>There is no difference.</span><br>"}for(var s=0;s<e.length;s++){var a=e[s][0];var l=e[s][1];var c=l.replace(n,"&amp;").replace(r,"&lt;").replace(o,"&gt;").replace(i,"<br>");switch(a){case DIFF_INSERT:t[s]='<ins class="diff" style="background:#e6ffe6;">'+c+"</ins>";break;case DIFF_DELETE:t[s]='<del class="diff" style="background:#ffe6e6;">'+c+"</del>";break;case DIFF_EQUAL:t[s]="<span>"+c+"</span>";break}}return t.join("")+"<br>"};diff_match_patch.prototype.diff_text1=function(e){var t=[];for(var n=0;n<e.length;n++){if(e[n][0]!==DIFF_INSERT){t[n]=e[n][1]}}return t.join("")};diff_match_patch.prototype.diff_text2=function(e){var t=[];for(var n=0;n<e.length;n++){if(e[n][0]!==DIFF_DELETE){t[n]=e[n][1]}}return t.join("")};diff_match_patch.prototype.diff_levenshtein=function(e){var t=0;var n=0;var r=0;for(var o=0;o<e.length;o++){var i=e[o][0];var s=e[o][1];switch(i){case DIFF_INSERT:n+=s.length;break;case DIFF_DELETE:r+=s.length;break;case DIFF_EQUAL:t+=Math.max(n,r);n=0;r=0;break}}t+=Math.max(n,r);return t};diff_match_patch.prototype.diff_toDelta=function(e){var t=[];for(var n=0;n<e.length;n++){switch(e[n][0]){case DIFF_INSERT:t[n]="+"+encodeURI(e[n][1]);break;case DIFF_DELETE:t[n]="-"+e[n][1].length;break;case DIFF_EQUAL:t[n]="="+e[n][1].length;break}}return t.join("\t").replace(/%20/g," ")};diff_match_patch.prototype.diff_fromDelta=function(e,t){var n=[];var r=0;var o=0;var i=t.split(/\t/g);for(var s=0;s<i.length;s++){var a=i[s].substring(1);switch(i[s].charAt(0)){case"+":try{n[r++]=new diff_match_patch.Diff(DIFF_INSERT,decodeURI(a))}catch(e){throw new Error("Illegal escape in diff_fromDelta: "+a)}break;case"-":case"=":var l=parseInt(a,10);if(isNaN(l)||l<0){throw new Error("Invalid number in diff_fromDelta: "+a)}var c=e.substring(o,o+=l);if(i[s].charAt(0)=="="){n[r++]=new diff_match_patch.Diff(DIFF_EQUAL,c)}else{n[r++]=new diff_match_patch.Diff(DIFF_DELETE,c)}break;default:if(i[s]){throw new Error("Invalid diff operation in diff_fromDelta: "+i[s])}}}if(o!=e.length){throw new Error("Delta length ("+o+") does not equal source text length ("+e.length+").")}return n};const hurmetIcons={navicon:{width:16,height:16,path:"M3 4h10v1.5h-20z M3 8h10v1.5h-20z M3 12h10v1.5h-20z"},recalc:{width:16,height:16,path:"M0 9c0 2.389 1.048 4.534 2.709 6l1.323-1.5c-1.246-1.099-2.031-2.708-2.031-4.5 0-3.314 2.686-6 6-6 1.657 0 3.157 0.672 4.243 1.757l-2.243 2.243h6v-6l-2.343 2.343c-1.448-1.448-3.448-2.343-5.657-2.343-4.418 0-8 3.582-8 8z"},subscript:{text:"X",css:"font-weight: bold"},superscript:{text:"X",css:"font-weight: bold"},strikethru:{width:1024,height:1024,path:"M1024 512v64h-234.506c27.504 38.51 42.506 82.692 42.506 128 0 70.878-36.66 139.026-100.58 186.964-59.358 44.518-137.284 69.036-219.42 69.036-82.138 0-160.062-24.518-219.42-69.036-63.92-47.938-100.58-116.086-100.58-186.964h128c0 69.382 87.926 128 192 128s192-58.618 192-128c0-69.382-87.926-128-192-128h-512v-64h299.518c-2.338-1.654-4.656-3.324-6.938-5.036-63.92-47.94-100.58-116.086-100.58-186.964s36.66-139.024 100.58-186.964c59.358-44.518 137.282-69.036 219.42-69.036 82.136 0 160.062 24.518 219.42 69.036 63.92 47.94 100.58 116.086 100.58 186.964h-128c0-69.382-87.926-128-192-128s-192 58.618-192 128c0 69.382 87.926 128 192 128 78.978 0 154.054 22.678 212.482 64h299.518z"},underline:{width:1024,height:1024,path:"M704 64h128v416c0 159.058-143.268 288-320 288-176.73 0-320-128.942-320-288v-416h128v416c0 40.166 18.238 78.704 51.354 108.506 36.896 33.204 86.846 51.494 140.646 51.494s103.75-18.29 140.646-51.494c33.116-29.802 51.354-68.34 51.354-108.506v-416zM192 832h640v128h-640z"},highlight:{text:""},paragraph:{width:24,height:24,path:"M22.5.248H7.228a6.977,6.977,0,1,0,0,13.954H9.546a.25.25,0,0,1,.25.25V22.5a1.25,1.25,0,0,0,2.5,0V3a.25.25,0,0,1,.25-.25h3.682a.25.25,0,0,1,.25.25V22.5a1.25,1.25,0,0,0,2.5,0V3a.249.249,0,0,1,.25-.25H22.5a1.25,1.25,0,0,0,0-2.5ZM9.8,11.452a.25.25,0,0,1-.25.25H7.228a4.477,4.477,0,1,1,0-8.954H9.546A.25.25,0,0,1,9.8,3Z"},upload:{width:16,height:16,path:"M7 9h2v-4h3l-4-4-4 4h3zM10 6.75v1.542l4.579 1.708-6.579 2.453-6.579-2.453 4.579-1.708v-1.542l-6 2.25v4l8 3 8-3v-4z"},image:{width:16,height:16,path:"M14.998 2c0.001 0.001 0.001 0.001 0.002 0.002v11.996c-0.001 0.001-0.001 0.001-0.002 0.002h-13.996c-0.001-0.001-0.001-0.001-0.002-0.002v-11.996c0.001-0.001 0.001-0.001 0.002-0.002h13.996zM15 1h-14c-0.55 0-1 0.45-1 1v12c0 0.55 0.45 1 1 1h14c0.55 0 1-0.45 1-1v-12c0-0.55-0.45-1-1-1v0z M13 4.5c0 0.828-0.672 1.5-1.5 1.5s-1.5-0.672-1.5-1.5 0.672-1.5 1.5-1.5 1.5 0.672 1.5 1.5z M14 13h-12v-2l3.5-6 4 5h1l3.5-3z"},comment:{width:1024,height:1024,path:"M512 219q-116 0-218 39t-161 107-59 145q0 64 40 122t115 100l49 28-15 54q-13 52-40 98 86-36 157-97l24-21 32 3q39 4 74 4 116 0 218-39t161-107 59-145-59-145-161-107-218-39zM1024 512q0 99-68 183t-186 133-257 48q-40 0-82-4-113 100-262 138-28 8-65 12h-2q-8 0-15-6t-9-15v-0q-1-2-0-6t1-5 2-5l3-5t4-4 4-5q4-4 17-19t19-21 17-22 18-29 15-33 14-43q-89-50-141-125t-51-160q0-99 68-183t186-133 257-48 257 48 186 133 68 183z"},footnote:{width:16,height:16,path:"M3.032 13l0.9-3h4.137l0.9 3h1.775l-3-10h-3.488l-3 10h1.776zM5.432 5h1.137l0.9 3h-2.937l0.9-3zM11 13l2.5-4 2.5 4h-5z M13.5 2h-1c-0.276 0-0.5-0.224-0.5-0.5s0.224-0.5 0.5-0.5h2c0.276 0 0.5-0.224 0.5-0.5s-0.224-0.5-0.5-0.5h-2c-0.827 0-1.5 0.673-1.5 1.5 0 0.384 0.145 0.734 0.383 1 0.275 0.307 0.674 0.5 1.117 0.5h1c0.276 0 0.5 0.224 0.5 0.5s-0.224 0.5-0.5 0.5h-2c-0.276 0-0.5 0.224-0.5 0.5s0.224 0.5 0.5 0.5h2c0.827 0 1.5-0.673 1.5-1.5 0-0.384-0.145-0.734-0.383-1-0.275-0.307-0.674-0.5-1.117-0.5z"},scroll:{width:512,height:512,path:"M426.667 0c-46.933 0-85.333 38.4-85.333 85.333V192c0 12.8 8.533 21.333 21.333 21.333h128c12.8 0 21.333-8.533 21.333-21.333V85.333C512 38.4 473.6 0 426.667 0zm42.666 170.667H384V85.333c0-23.467 19.2-42.667 42.667-42.667s42.667 19.2 42.667 42.667v85.334zM362.667 384c-12.8 0-21.333 8.533-21.333 21.333v21.333c0 12.8 8.533 21.333 21.333 21.333S384 439.467 384 426.667v-21.333c0-12.801-8.533-21.334-21.333-21.334z M362.667 405.333c-12.8 0-21.333 8.533-21.333 21.333 0 23.467-19.2 42.667-42.667 42.667S256 450.133 256 426.667v-21.333c0-12.8-8.533-21.333-21.333-21.333-12.8 0-21.333 8.533-21.333 21.333v21.333c0 46.933 38.4 85.333 85.333 85.333S384 473.6 384 426.667c0-12.8-8.533-21.334-21.333-21.334z M426.667 0h-320c-36.267 0-64 27.733-64 64v341.333c0 12.8 8.533 21.333 21.333 21.333s21.333-8.533 21.333-21.333V64c0-12.8 8.533-21.333 21.333-21.333H352c-6.4 12.8-10.667 27.733-10.667 42.667v320c0 12.8 8.533 21.333 21.333 21.333S384 418.133 384 405.333v-320c0-23.467 19.2-42.667 42.667-42.667C454.4 42.667 454.4 0 426.667 0z M298.667 469.333c-23.467 0-42.667-19.2-42.667-42.667v-21.333c0-12.8-8.533-21.333-21.333-21.333H21.333C8.533 384 0 392.533 0 405.333v21.333C0 473.6 38.4 512 85.333 512h213.333c27.734 0 27.734-42.667.001-42.667zm-213.334 0c-23.467 0-42.667-19.2-42.667-42.667h170.667c0 14.933 4.267 29.867 10.667 42.667H85.333zM192 106.667h-42.667C136.533 106.667 128 115.2 128 128s8.533 21.333 21.333 21.333H192c12.8 0 21.333-8.533 21.333-21.333S204.8 106.667 192 106.667zM277.333 192h-42.667c-12.8 0-21.333 8.533-21.333 21.333 0 12.8 8.533 21.333 21.333 21.333h42.667c12.8 0 21.333-8.533 21.333-21.333.001-12.8-8.533-21.333-21.333-21.333zM277.333 106.667H256c-12.8 0-21.333 8.533-21.333 21.333S243.2 149.333 256 149.333h21.333c12.8 0 21.333-8.533 21.333-21.333s-8.533-21.333-21.333-21.333zM192 277.333h-42.667c-12.8 0-21.333 8.533-21.333 21.333 0 12.8 8.533 21.333 21.333 21.333H192c12.8 0 21.333-8.533 21.333-21.333 0-12.799-8.533-21.333-21.333-21.333zM277.333 277.333H256c-12.8 0-21.333 8.533-21.333 21.333 0 12.8 8.533 21.333 21.333 21.333h21.333c12.8 0 21.333-8.533 21.333-21.333.001-12.799-8.533-21.333-21.333-21.333zM149.333 192c-12.8 0-21.333 8.533-21.333 21.333 0 12.8 8.533 21.333 21.333 21.333 12.8 0 21.333-8.533 21.333-21.333.001-12.8-8.533-21.333-21.333-21.333z"},tighten:{width:16,height:16,path:"M0 4h3v2.75h-3z M4.5 4H16v2.75H4.5z M0 9h3v2.75h-3z M4.5 9H16v2.75H4.5z M7 0H13.5L10.25 4 M7 16L10.25 12L13.5 16z"},table:{width:24,height:24,path:"M17,17 L17,22 L19,22 C20.6568542,22 22,20.6568542 22,19 L22,17 L17,17 Z M15,17 L9,17 L9,22 L15,22 L15,17 Z M17,15 L22,15 L22,9 L17,9 L17,15 Z M15,15 L15,9 L9,9 L9,15 L15,15 Z M17,7 L22,7 L22,5 C22,3.34314575 20.6568542,2 19,2 L17,2 L17,7 Z M15,7 L15,2 L9,2 L9,7 L15,7 Z M24,16.1768671 L24,19 C24,21.7614237 21.7614237,24 19,24 L5,24 C2.23857625,24 2.11453371e-15,21.7614237 1.77635684e-15,19 L0,5 C-3.38176876e-16,2.23857625 2.23857625,2.28362215e-15 5,0 L19,0 C21.7614237,-5.07265313e-16 24,2.23857625 24,5 L24,7.82313285 C24.0122947,7.88054124 24.0187107,7.93964623 24.0187107,8 C24.0187107,8.06035377 24.0122947,8.11945876 24,8.17686715 L24,15.8231329 C24.0122947,15.8805412 24.0187107,15.9396462 24.0187107,16 C24.0187107,16.0603538 24.0122947,16.1194588 24,16.1768671 Z M7,2 L5,2 C3.34314575,2 2,3.34314575 2,5 L2,7 L7,7 L7,2 Z M2,9 L2,15 L7,15 L7,9 L2,9 Z M2,17 L2,19 C2,20.6568542 3.34314575,22 5,22 L7,22 L7,17 L2,17 Z"},delete_table:{width:24,height:24,path:"M19,14 C21.7600532,14.0033061 23.9966939,16.2399468 24,19 C24,21.7614237 21.7614237,24 19,24 C16.2385763,24 14,21.7614237 14,19 C14,16.2385763 16.2385763,14 19,14 Z M16.5,19.9375 L21.5,19.9375 C22.017767,19.9375 22.4375,19.517767 22.4375,19 C22.4375,18.482233 22.017767,18.0625 21.5,18.0625 L16.5,18.0625 C15.982233,18.0625 15.5625,18.482233 15.5625,19 C15.5625,19.517767 15.982233,19.9375 16.5,19.9375 Z M12.2898787,17 L9,17 L9,22 L12.6736312,22 C13.0297295,22.7496048 13.515133,23.4258795 14.1010173,24 L5,24 C2.23857625,24 -1.43817996e-15,21.7614237 -1.77635684e-15,19 L-3.55271368e-15,5 C-3.89089055e-15,2.23857625 2.23857625,5.07265313e-16 5,-1.77635684e-15 L19,-1.77635684e-15 C21.7614237,-2.28362215e-15 24,2.23857625 24,5 L24,7.82313285 C24.0122947,7.88054124 24.0187107,7.93964623 24.0187107,8 C24.0187107,8.06035377 24.0122947,8.11945876 24,8.17686715 L24,14.1010173 C23.4258795,13.515133 22.7496048,13.0297295 22,12.6736312 L22,9 L17,9 L17,12.2898787 C16.2775651,12.5048858 15.6040072,12.8333806 15,13.2546893 L15,9 L9,9 L9,15 L13.2546893,15 C12.8333806,15.6040072 12.5048858,16.2775651 12.2898787,17 Z M17,7 L22,7 L22,5 C22,3.34314575 20.6568542,2 19,2 L17,2 L17,7 Z M15,7 L15,2 L9,2 L9,7 L15,7 Z M7,2 L5,2 C3.34314575,2 2,3.34314575 2,5 L2,7 L7,7 L7,2 Z M2,9 L2,15 L7,15 L7,9 L2,9 Z M2,17 L2,19 C2,20.6568542 3.34314575,22 5,22 L7,22 L7,17 L2,17 Z"},add_col_before:{width:24,height:24,path:"M19,14 C21.7600532,14.0033061 23.9966939,16.2399468 24,19 C24,21.7614237 21.7614237,24 19,24 C16.2385763,24 14,21.7614237 14,19 C14,16.2385763 16.2385763,14 19,14 Z M21.5,19.9375 C22.017767,19.9375 22.4375,19.517767 22.4375,19 C22.4375,18.482233 22.017767,18.0625 21.5,18.0625 L20.25,18.0625 C20.077411,18.0625 19.9375,17.922589 19.9375,17.75 L19.9375,16.5 C19.9375,15.982233 19.517767,15.5625 19,15.5625 C18.482233,15.5625 18.0625,15.982233 18.0625,16.5 L18.0625,17.75 C18.0625,17.922589 17.922589,18.0625 17.75,18.0625 L16.5,18.0625 C15.982233,18.0625 15.5625,18.482233 15.5625,19 C15.5625,19.517767 15.982233,19.9375 16.5,19.9375 L17.75,19.9375 C17.922589,19.9375 18.0625,20.077411 18.0625,20.25 L18.0625,21.5 C18.0625,22.017767 18.482233,22.4375 19,22.4375 C19.517767,22.4375 19.9375,22.017767 19.9375,21.5 L19.9375,20.25 C19.9375,20.077411 20.077411,19.9375 20.25,19.9375 L21.5,19.9375 Z M2,19 C2,20.6568542 3.34314575,22 5,22 C6.65685425,22 8,20.6568542 8,19 L8,5 C8,3.34314575 6.65685425,2 5,2 C3.34314575,2 2,3.34314575 2,5 L2,19 Z M-2.7585502e-16,19 L5.81397739e-16,5 C-1.37692243e-16,2.23857625 2.23857625,0 5,0 C7.76142375,0 10,2.23857625 10,5 L10,19 C10,21.7614237 7.76142375,24 5,24 C2.23857625,24 4.43234962e-16,21.7614237 -2.7585502e-16,19 Z"},add_col_after:{width:24,height:24,path:"M5,14 C7.76005315,14.0033061 9.99669388,16.2399468 10,19 C10,21.7614237 7.76142375,24 5,24 C2.23857625,24 1.77635684e-15,21.7614237 1.77635684e-15,19 C1.77635684e-15,16.2385763 2.23857625,14 5,14 Z M7.5,19.9375 C8.01776695,19.9375 8.4375,19.517767 8.4375,19 C8.4375,18.482233 8.01776695,18.0625 7.5,18.0625 L6.25,18.0625 C6.07741102,18.0625 5.9375,17.922589 5.9375,17.75 L5.9375,16.5 C5.9375,15.982233 5.51776695,15.5625 5,15.5625 C4.48223305,15.5625 4.0625,15.982233 4.0625,16.5 L4.0625,17.75 C4.0625,17.922589 3.92258898,18.0625 3.75,18.0625 L2.5,18.0625 C1.98223305,18.0625 1.5625,18.482233 1.5625,19 C1.5625,19.517767 1.98223305,19.9375 2.5,19.9375 L3.75,19.9375 C3.92258898,19.9375 4.0625,20.077411 4.0625,20.25 L4.0625,21.5 C4.0625,22.017767 4.48223305,22.4375 5,22.4375 C5.51776695,22.4375 5.9375,22.017767 5.9375,21.5 L5.9375,20.25 C5.9375,20.077411 6.07741102,19.9375 6.25,19.9375 L7.5,19.9375 Z M16,19 C16,20.6568542 17.3431458,22 19,22 C20.6568542,22 22,20.6568542 22,19 L22,5 C22,3.34314575 20.6568542,2 19,2 C17.3431458,2 16,3.34314575 16,5 L16,19 Z M14,19 L14,5 C14,2.23857625 16.2385763,0 19,0 C21.7614237,0 24,2.23857625 24,5 L24,19 C24,21.7614237 21.7614237,24 19,24 C16.2385763,24 14,21.7614237 14,19 Z"},add_row_before:{width:24,height:24,path:"M19,14 C21.7600532,14.0033061 23.9966939,16.2399468 24,19 C24,21.7614237 21.7614237,24 19,24 C16.2385763,24 14,21.7614237 14,19 C14,16.2385763 16.2385763,14 19,14 Z M21.5,19.9375 C22.017767,19.9375 22.4375,19.517767 22.4375,19 C22.4375,18.482233 22.017767,18.0625 21.5,18.0625 L20.25,18.0625 C20.077411,18.0625 19.9375,17.922589 19.9375,17.75 L19.9375,16.5 C19.9375,15.982233 19.517767,15.5625 19,15.5625 C18.482233,15.5625 18.0625,15.982233 18.0625,16.5 L18.0625,17.75 C18.0625,17.922589 17.922589,18.0625 17.75,18.0625 L16.5,18.0625 C15.982233,18.0625 15.5625,18.482233 15.5625,19 C15.5625,19.517767 15.982233,19.9375 16.5,19.9375 L17.75,19.9375 C17.922589,19.9375 18.0625,20.077411 18.0625,20.25 L18.0625,21.5 C18.0625,22.017767 18.482233,22.4375 19,22.4375 C19.517767,22.4375 19.9375,22.017767 19.9375,21.5 L19.9375,20.25 C19.9375,20.077411 20.077411,19.9375 20.25,19.9375 L21.5,19.9375 Z M5,2 C3.34314575,2 2,3.34314575 2,5 C2,6.65685425 3.34314575,8 5,8 L19,8 C20.6568542,8 22,6.65685425 22,5 C22,3.34314575 20.6568542,2 19,2 L5,2 Z M5,0 L19,0 C21.7614237,-5.07265313e-16 24,2.23857625 24,5 C24,7.76142375 21.7614237,10 19,10 L5,10 C2.23857625,10 3.38176876e-16,7.76142375 0,5 C-1.2263553e-15,2.23857625 2.23857625,5.07265313e-16 5,0 Z"},add_row_after:{width:24,height:24,path:"M19,0 C21.7600532,0.00330611633 23.9966939,2.23994685 24,5 C24,7.76142375 21.7614237,10 19,10 C16.2385763,10 14,7.76142375 14,5 C14,2.23857625 16.2385763,0 19,0 Z M21.5,5.9375 C22.017767,5.9375 22.4375,5.51776695 22.4375,5 C22.4375,4.48223305 22.017767,4.0625 21.5,4.0625 L20.25,4.0625 C20.077411,4.0625 19.9375,3.92258898 19.9375,3.75 L19.9375,2.5 C19.9375,1.98223305 19.517767,1.5625 19,1.5625 C18.482233,1.5625 18.0625,1.98223305 18.0625,2.5 L18.0625,3.75 C18.0625,3.92258898 17.922589,4.0625 17.75,4.0625 L16.5,4.0625 C15.982233,4.0625 15.5625,4.48223305 15.5625,5 C15.5625,5.51776695 15.982233,5.9375 16.5,5.9375 L17.75,5.9375 C17.922589,5.9375 18.0625,6.07741102 18.0625,6.25 L18.0625,7.5 C18.0625,8.01776695 18.482233,8.4375 19,8.4375 C19.517767,8.4375 19.9375,8.01776695 19.9375,7.5 L19.9375,6.25 C19.9375,6.07741102 20.077411,5.9375 20.25,5.9375 L21.5,5.9375 Z M5,16 C3.34314575,16 2,17.3431458 2,19 C2,20.6568542 3.34314575,22 5,22 L19,22 C20.6568542,22 22,20.6568542 22,19 C22,17.3431458 20.6568542,16 19,16 L5,16 Z M5,14 L19,14 C21.7614237,14 24,16.2385763 24,19 C24,21.7614237 21.7614237,24 19,24 L5,24 C2.23857625,24 3.38176876e-16,21.7614237 0,19 C-1.2263553e-15,16.2385763 2.23857625,14 5,14 Z"},combine_cells:{width:24,height:24,path:"M2,19 C2,20.6568542 3.34314575,22 5,22 L19,22 C20.6568542,22 22,20.6568542 22,19 L22,5 C22,3.34314575 20.6568542,2 19,2 L5,2 C3.34314575,2 2,3.34314575 2,5 L2,19 Z M-1.16403344e-15,19 L-3.0678068e-16,5 C-6.44957556e-16,2.23857625 2.23857625,0 5,0 L19,0 C21.7614237,0 24,2.23857625 24,5 L24,19 C24,21.7614237 21.7614237,24 19,24 L5,24 C2.23857625,24 9.50500275e-16,21.7614237 -1.16403344e-15,19 Z M12,10 C12.5522847,10 13,10.4477153 13,11 L13,13 C13,13.5522847 12.5522847,14 12,14 C11.4477153,14 11,13.5522847 11,13 L11,11 C11,10.4477153 11.4477153,10 12,10 Z M12,16 C12.5522847,16 13,16.4477153 13,17 L13,20 C13,20.5522847 12.5522847,21 12,21 C11.4477153,21 11,20.5522847 11,20 L11,17 C11,16.4477153 11.4477153,16 12,16 Z M12,3 C12.5522847,3 13,3.44771525 13,4 L13,7 C13,7.55228475 12.5522847,8 12,8 C11.4477153,8 11,7.55228475 11,7 L11,4 C11,3.44771525 11.4477153,3 12,3 Z"},table_caption:{width:24,height:24,path:"M17,18 L17,22 L19,22 C20.6568542,22,22,20.6568542,22,19 L22,18 L17,18 Z M15,18 L9,18 L9,22 L15,22 L15,18 Z M17,16 L22,16 L22,12 L17,12 L17,16 Z M15,16 L15,12 L9,12 L9,16 L15,16 Z M17,10 L22,10 L22,9 C22,9,22,6,19,6 L17,6 L17,10 Z M15,10 L15,6 L9,6 L9,10 L15,10 Z M24,16.1768671 L24,19 C24,21.7614237,21.7614237,24,19,24 L5,24 C2.23857625,24,0,21.7614237,0,19 L0,9 C0,6,2,4,5,4 L19,4 C21.7614237,4,24,6.23857625,24,9 L24,7.82313285 C24.0122947,7.88054124,24.0187107,7.93964623,24.0187107,8 C24.0187107,8.06035377,24.0122947,8.11945876,24,8.17686715 L24,15.8231329 C24.0122947,15.8805412,24.0187107,15.9396462,24.0187107,16 C24.0187107,16.0603538,24.0122947,16.1194588,24,16.1768671 Z M7,6 L5,6 C3.34314575,6,2,7.34314575,2,9 L2,10 L7,10 L7,6 Z M2,12 L2,16 L7,16 L7,12 L2,12 Z M2,18 L2,19 C2,20.6568542,3.34314575,22,5,22 L7,22 L7,18 L2,18 Z M4,0 H20 V1.75 H4 Z"},delete_col:{width:24,height:24,path:"M12.6414391,21.9312708 C12.9358807,22.5689168 13.3234155,23.1547532 13.7866134,23.6713497 C13.2317936,23.8836754 12.6294813,24 12,24 C9.23857625,24 7,21.7614237 7,19 L7,5 C7,2.23857625 9.23857625,0 12,0 C14.7614237,0 17,2.23857625 17,5 L17,12.2898787 C16.2775651,12.5048858 15.6040072,12.8333806 15,13.2546893 L15,5 C15,3.34314575 13.6568542,2 12,2 C10.3431458,2 9,3.34314575 9,5 L9,19 C9,20.6568542 10.3431458,22 12,22 C12.220157,22 12.4347751,21.9762852 12.6414391,21.9312708 Z M19,14 C21.7600532,14.0033061 23.9966939,16.2399468 24,19 C24,21.7614237 21.7614237,24 19,24 C16.2385763,24 14,21.7614237 14,19 C14,16.2385763 16.2385763,14 19,14 Z M16.5,19.9375 L21.5,19.9375 C22.017767,19.9375 22.4375,19.517767 22.4375,19 C22.4375,18.482233 22.017767,18.0625 21.5,18.0625 L16.5,18.0625 C15.982233,18.0625 15.5625,18.482233 15.5625,19 C15.5625,19.517767 15.982233,19.9375 16.5,19.9375 Z"},delete_row:{width:24,height:24,path:"M13.2546893,15 C12.8333806,15.6040072 12.5048858,16.2775651 12.2898787,17 L5,17 C2.23857625,17 3.38176876e-16,14.7614237 0,12 C-1.2263553e-15,9.23857625 2.23857625,7 5,7 L19,7 C21.7614237,7 24,9.23857625 24,12 C24,12.6294813 23.8836754,13.2317936 23.6713497,13.7866134 C23.1547532,13.3234155 22.5689168,12.9358807 21.9312708,12.6414391 C21.9762852,12.4347751 22,12.220157 22,12 C22,10.3431458 20.6568542,9 19,9 L5,9 C3.34314575,9 2,10.3431458 2,12 C2,13.6568542 3.34314575,15 5,15 L13.2546893,15 Z M19,14 C21.7600532,14.0033061 23.9966939,16.2399468 24,19 C24,21.7614237 21.7614237,24 19,24 C16.2385763,24 14,21.7614237 14,19 C14,16.2385763 16.2385763,14 19,14 Z M16.5,19.9375 L21.5,19.9375 C22.017767,19.9375 22.4375,19.517767 22.4375,19 C22.4375,18.482233 22.017767,18.0625 21.5,18.0625 L16.5,18.0625 C15.982233,18.0625 15.5625,18.482233 15.5625,19 C15.5625,19.517767 15.982233,19.9375 16.5,19.9375 Z"},spreadsheet:{width:24,height:24,path:"M17 22 L 19 22 C20.6569 22 22 20.6569 22 19 L22 7 L 22 5 C 22 3.3431 20.6569 2 19 2 L7 2 L5 2 C 3.3431 2 3 3.3431 2 5 L2 17 L2 19 C 2 20.6569 3.3431 22 5 22 L7 22 Z M24,16.1768671 L24,19 C24,21.7614237 21.7614237,24 19,24 L5,24 C2.23857625,24 2.11453371e-15,21.7614237 1.77635684e-15,19 L0,5 C-3.38176876e-16,2.23857625 2.23857625,2.28362215e-15 5,0 L19,0 C21.7614237,-5.07265313e-16 24,2.23857625 24,5 L24,7.82313285 C24.0122947,7.88054124 24.0187107,7.93964623 24.0187107,8 C24.0187107,8.06035377 24.0122947,8.11945876 24,8.17686715 L24,15.8231329 C24.0122947,15.8805412 24.0187107,15.9396462 24.0187107,16 C24.0187107,16.0603538 24.0122947,16.1194588 24,16.1768671 Z M19 7 H5 V10 H19 Z M19 14 H5 V17 H19 Z"},grid:{width:16,height:16,path:"M0 1v13h16v-13h-16zM6 9v-3h4v3h-4zM10 10v3h-4v-3h4zM10 2v3h-4v-3h4zM5 2v3h-4v-3h4zM1 6h4v3h-4v-3zM11 6h4v3h-4v-3zM11 5v-3h4v3h-4zM1 10h4v3h-4v-3zM11 13v-3h4v3h-4z"},nogrid:{text:"",css:"font-weight: bold"},oneRule:{width:16,height:16,path:"M0 2h16v-1.5h-16z"},twoRules:{width:16,height:16,path:"M0 2h16v-1h-16zM0 14h16v-1h-16z"},threeRules:{width:16,height:16,path:"M0 2h16v-2h-16zM0 5h16v-1h-16zM0 16h16v-2h-16z"},fourRules:{width:16,height:16,path:"M0 2h16v-2h-16zM0 5h16v-1h-16zM0 12h16v-1h-16zM0 16h16v-2h-16z"},rules:{width:16,height:16,path:"M0 1h16v1h-16zM0 5h16v1h-16zM0 9h16v1h-16zM0 13h16v1h-16z"},striped:{width:16,height:16,path:"M0 1h16v3h-16zM0 9h16v3h-16z"},cog:{width:16,height:16,path:"M14.59 9.535c-0.839-1.454-0.335-3.317 1.127-4.164l-1.572-2.723c-0.449 0.263-0.972 0.414-1.529 0.414-1.68 0-3.042-1.371-3.042-3.062h-3.145c0.004 0.522-0.126 1.051-0.406 1.535-0.839 1.454-2.706 1.948-4.17 1.106l-1.572 2.723c0.453 0.257 0.845 0.634 1.123 1.117 0.838 1.452 0.336 3.311-1.12 4.16l1.572 2.723c0.448-0.261 0.967-0.41 1.522-0.41 1.675 0 3.033 1.362 3.042 3.046h3.145c-0.001-0.517 0.129-1.040 0.406-1.519 0.838-1.452 2.7-1.947 4.163-1.11l1.572-2.723c-0.45-0.257-0.839-0.633-1.116-1.113zM8 11.24c-1.789 0-3.24-1.45-3.24-3.24s1.45-3.24 3.24-3.24c1.789 0 3.24 1.45 3.24 3.24s-1.45 3.24-3.24 3.24z"},"align-left":{width:16,height:16,path:"M0 1h16v2h-16zM0 4h10v2h-10zM0 10h10v2h-10zM0 7h16v2h-16zM0 13h16v2h-16"},"align-center":{width:16,height:16,path:"M0 1h16v2h-16zM3 4h10v2h-10zM3 10h10v2h-10zM0 7h16v2h-16zM0 13h16v2h-16z"},"align-right":{width:16,height:16,path:"M0 1h16v2h-16zM6 4h10v2h-10zM6 10h10v2h-10zM0 7h16v2h-16zM0 13h16v2h-16z"},info:{width:16,height:16,path:"M7 4.75c0-0.412 0.338-0.75 0.75-0.75h0.5c0.412 0 0.75 0.338 0.75 0.75v0.5c0 0.412-0.338 0.75-0.75 0.75h-0.5c-0.412 0-0.75-0.338-0.75-0.75v-0.5z M10 12h-4v-1h1v-3h-1v-1h3v4h1z M8 0c-4.418 0-8 3.582-8 8s3.582 8 8 8 8-3.582 8-8-3.582-8-8-8zM8 14.5c-3.59 0-6.5-2.91-6.5-6.5s2.91-6.5 6.5-6.5 6.5 2.91 6.5 6.5-2.91 6.5-6.5 6.5z"}};function canInsert(e,t){let n=e.selection.$from;for(let e=n.depth;e>=0;e--){let r=n.index(e);if(n.node(e).canReplaceWith(r,r,t))return true}return false}function insertHeader(e,t){return new MenuItem({title:"Insert a print header",label:"Print header",enable(){return true},run(e,t){window.scrollTo(0,0);if(e.doc.nodeAt(0).type.name==="header"){return}t(e.tr.insert(0,schema.nodeFromJSON(JSON.parse(`{"type":"header","content":[{"type":"table","attrs":{"class":"one-rule c2c c3r"},\n"content":[{"type":"table_row","content":[{"type":"table_header","content":[\n{"type":"paragraph","content":[{"type":"text","text":"left"}]}]},\n{"type":"table_header","content":[{"type":"paragraph","content":[{"type":"text","text":"center"}]}]},\n{"type":"table_header","content":[{"type":"paragraph","content":[{"type":"text","text":"$PAGE"}]}]}]}]}]}`))))}})}const navigate=()=>new MenuItem({title:"Navigate",icon:hurmetIcons.navicon,run(e,t,n){const r=[{textContent:"Top",pos:0}];const o=n.dom.getBoundingClientRect().bottom-320;e.doc.nodesBetween(0,e.doc.content.size,(function(e,t){if(e.type.name==="heading"&&(e.attrs.level===1||e.attrs.level===2)){r.push({textContent:e.attrs.level===1?e.textContent:""+e.textContent,pos:t})}}));r.push({textContent:"Bottom",pos:o});const i=e=>{const t=n.coordsAtPos(e).top;const r=n.dom.getBoundingClientRect().top;window.scrollTo(0,t-r)};openSelectPrompt("Scroll to",r,i)}});const tighten=()=>new MenuItem({title:"Tighten list item",icon:hurmetIcons.tighten,select:e=>{const{$from:t,$to:n,node:r}=e.selection;const o=t.node(-1);return t.node().type.name=="paragraph"&&o.type.name=="list_item"&&o.childCount<2&&t.pos===n.pos},run(e,t,n){const{$from:r,$to:o,node:i}=e.selection;const s=r.pos;const a=r.node(-2);const l=r.start(-2)-1;const c=a.toJSON();for(const e of c.content){e.type="tight_list_item"}const d=schema.nodeFromJSON(c);const u=e.tr;u.replaceWith(l,l+a.nodeSize,d);u.setSelection(TextSelection.create(u.doc,s));n.dispatch(u)}});const findParentNode=e=>t=>{const{$from:n}=t;for(let t=n.depth;t>0;t--){const r=n.node(t);if(e(r)){return{pos:t>0?n.before(t):0,start:n.start(t),depth:t,node:r}}}};function printHurmet(e){paginate(e,schema.nodes.toc,forPrint);window.print()}const print=()=>new MenuItem({title:"Print",label:"Print",run(e,t,n){printHurmet(n)}});const hint=(e,t,n,r,o)=>new MenuItem({label:e,title:t,class:r,run(e,t,r){const i={title:n,hints:o,state:e,dispatch:t};openPrompt(i)}});const footnote=()=>new MenuItem({title:"Insert footnote",icon:hurmetIcons.footnote,select(e){return insertPoint(e.doc,e.selection.from,schema.nodes.footnote)!=null},run(e,t){let{empty:n,$from:r,$to:o}=e.selection,i=Fragment.empty;if(!n&&r.sameParent(o)&&r.parent.inlineContent){i=r.parent.content.cut(r.parentOffset,o.parentOffset)}const s=e.tr;s.replaceSelectionWith(schema.nodes.footnote.create(null,i));if(i.content.length===0){s.setSelection(NodeSelection.create(s.doc,r.pos))}t(s)}});const findTable=e=>findParentNode((e=>e.type.spec.tableRole&&e.type.spec.tableRole==="table"))(e);const isCellSelection=e=>e instanceof CellSelection;const getSelectionRect=e=>{if(!isCellSelection(e)){return}const t=e.$anchorCell.start(-1);const n=TableMap.get(e.$anchorCell.node(-1));return n.rectBetween(e.$anchorCell.pos-t,e.$headCell.pos-t)};const pruneHurmet=(e,t)=>{const n=[];const r=e.tr;e.doc.nodesBetween(0,e.doc.content.size,(function(e,t){if(e.type.name==="calculation"&&e.attrs.entry.length===0||e.type.name==="tex"&&e.attrs.tex.length===0){n.push(t)}}));for(let e=n.length-1;e>=0;e--){r.delete(n[e],n[e]+1)}t.dispatch(r)};function deleteComments(e,t){return new MenuItem({title:"Delete all comments",label:"Delete all comments",enable(){return true},run(e,t){const n=[];const r=e.tr;e.doc.nodesBetween(0,e.doc.content.size,(function(e,t){if(e.type.name==="comment"){n.push({start:t,end:t+e.nodeSize})}}));for(let e=n.length-1;e>=0;e--){r.delete(n[e].start,n[e].end)}t(r)}})}async function writeFile(e,t){const n=await e.createWritable();await n.write(t);await n.close()}function sleep(e){return new Promise((t=>setTimeout(t,e)))}function saveFileAsMarkdown(e,t,n=false){pruneHurmet(e,t);let r=`---------------\ndecimalFormat: ${e.doc.attrs.decimalFormat}\nfontSize: ${e.doc.attrs.fontSize}\npageSize: ${e.doc.attrs.pageSize}\ndateFormat: ${e.doc.attrs.dateFormat}\nsaveDate: ${new Date((new Date).getTime()-(new Date).getTimezoneOffset()*60*1e3).toISOString().split("T")[0]}\n---------------\n\n`+hurmetMarkdownSerializer.serialize(e.doc,new Map,[],false,false,false);let o=false;const i={};e.doc.nodesBetween(0,e.doc.content.size,(function(e,t){if(e.type.name==="calculation"&&e.attrs.isFetch){o=true;const t=e.attrs.entry.replace(/^[^()]+\("?/,"").replace(/"?\).*$/,"").trim();let n="";if(e.attrs.dtype===dt.MODULE){n=e.attrs.fallback}else if(e.attrs.dtype===dt.DATAFRAME){n+=e.attrs.value.rowMap?"#":"";n+=e.attrs.value.headings.join("\t");if(e.attrs.value.units){n+="\n"+e.attrs.value.units.join("\t")}Array.from(e.attrs.value.usedRows).sort(((e,t)=>e-t)).forEach((t=>{let r="\n";for(let n=0;n<e.attrs.value.headings.length;n++){r+=e.attrs.value.data[n][t]+"\t"}n+=r.slice(0,-1)}))}i[e.attrs.name]={url:t,text:n}}}));if(o){r+=`\n\x3c!--FALLBACKS--\x3e\n`+JSON.stringify(i)}for(const t of e.doc.attrs.snapshots){r+=`\n\x3c!--SNAPSHOT--\x3e\ndate: ${t.date}\nmessage: ${t.message}\n\n`;r+=t.content}r=r;if(window.showOpenFilePicker&&e.doc.attrs.saveIsValid&&e.doc.attrs.fileHandle&&!n){const t=document.getElementsByClassName("ProseMirror-menubar").item(0).children[1];t.classList.add("ProseMirror-menu-active");writeFile(e.doc.attrs.fileHandle,r);sleep(500).then((()=>{t.classList.remove("ProseMirror-menu-active")}))}else{const t=new Blob([r],{type:"text/plain;charset=utf-8"});FileSaverExports.saveAs(t,"HurmetFile.md",{autoBom:false});e.doc.attrs.saveIsValid=false;document.name="Hurmet.org"}}function saveFile(){return new MenuItem({title:window.showOpenFilePicker?"Save file   Ctrl-S":'"Save" works only in Chrome or Edge.',label:"Save",enable(e){return e.doc.attrs.saveIsValid},run(e,t,n){saveFileAsMarkdown(e,n)}})}function saveFileAs(){return new MenuItem({title:window.showOpenFilePicker?"Save file as":"Download file",label:window.showOpenFilePicker?"Save as":"Download file",run(e,t,n){saveFileAsMarkdown(e,n,true)}})}function permalink(){return new MenuItem({title:"Create a permalink URL in the address bar",label:"Create permalink",run(e,t,n){const r=/[\r\n%#"()<>?[\\\]^`{|}]/g;const o=hurmetMarkdownSerializer.serialize(e.doc,new Map,[],false,false,false);if(o&&o.length>0){const e="#"+o.replace(r,encodeURIComponent);if(e.length>32e3){alert(`A URL this long will not work.\nFor best results, limit to one page and do not include embedded images.`)}else{if(e.length>5e3){alert(`A URL this long may not work in some browsers.\nFor best results, limit to one page and do not include embedded images.`)}location.hash=e}}}})}function openFile(){return new MenuItem({title:"Open file...",label:"Open",run(e,t,n){readFile(e,t,n,schema,"markdown")}})}function copyText(e,t,n=false){const r=hurmetMarkdownSerializer.serialize(e.selection.content().content,new Map,[],t,false,n);const o="text/plain";const i=new Blob([r],{type:o});const s=[new ClipboardItem({[o]:i})];navigator.clipboard.write(s)}function copyAsMarkdown(){return new MenuItem({label:"Copy as Hurmet Markdown",run(e,t,n){copyText(e,false)}})}function copyAsMarkdownWithResults(){return new MenuItem({label:"Copy as MD w/Results",title:"Copy as Markdown. Include human-readable results.",run(e,t,n){copyText(e,false,true)}})}function copyAsGFM(){return new MenuItem({label:"Copy as GitHub Markdown",title:"Copy as GitHub Flavored Markdown",run(e,t,n){copyText(e,true)}})}function pasteAsMarkdown(e){return new MenuItem({label:e?"Convert TeX and Paste":"Paste from Markdown",title:e?"Given Markdown text, convert the LaTeX parts to Hurmet calclations, then paste.":"Paste Markdown text into the document.",run(t,n,r){navigator.clipboard.readText().then((n=>{const o=hurmet.md2ast(n,false,e);const i={type:"fragment",content:o};const{$from:s,$to:a}=t.selection;r.dispatch(r.state.tr.replaceWith(s.pos,a.pos,schema.nodeFromJSON(i)));hurmet.updateCalculations(r,true)}))}})}function uploadImage(e){return new MenuItem({title:"Upload image file",icon:hurmetIcons.upload,enable(t){return canInsert(t,e)},run(e,t,n){const r=document.createElement("input");r.type="file";r.accept=".gif,.jpg,.jpeg,.png,.svg";r.onchange=e=>{const t=r.files[0];const o=t.name.replace(/\..+$/,"");const i=new FileReader;i.onload=function(e){const t=e.target.result;const r=n.state.selection.from;n.dispatch(n.state.tr.replaceWith(r,r,schema.nodes.image.create({src:t,alt:o})))};i.readAsDataURL(t)};r.click()}})}function toggleTableCaption(){return new MenuItem({title:"Insert or delete caption",icon:hurmetIcons.table_caption,select(e){return isInTable(e)},run(e,t,n){const r=findTable(e.selection);let o=0;let i=0;let s=-1;let a=false;let l=e.selection.$from;const c=e.doc.resolve(e.selection.from);for(let e=l.depth;e>=0;e--){if(l.node(e).type.name==="table"){o=c.before(e);i=c.after(e);a=e>0&&l.node(e-1).type.name==="figure";s=e;break}}if(a){const t=c.before(s-1);const o=c.after(s-1);const i=e.tr;i.replaceWith(t,o,r.node);n.dispatch(i);n.focus()}else{const t={title:"Insert Table Caption",fields:{caption:new TextField({label:"Caption",value:""})},radioButtons:{name:"position",direction:"row",buttons:[["auto","auto"],["left","left"],["right","right"]],current:"auto"},callback(t){const s=t.caption?t.caption:"caption";const a=schema.nodes.figcaption.createAndFill(null,[schema.text(s)]);t.class+=" top-caption";const l=e.tr;l.replaceWith(o,i,schema.nodes.figure.createAndFill(t,[a,r.node]));n.dispatch(l);n.focus()}};openPrompt(t)}}})}function toggleSpreadsheet(){return new MenuItem({title:"Toggle Table  Spreadsheet",icon:hurmetIcons.spreadsheet,select(e){return isInTable(e)},run(e,t,n){let r=findTable(e.selection);let o;let i=0;let s=0;const a=r.node.content.content[0].content.content[0].content.content[0].type.name==="spreadsheet_cell";if(a){[o,i,s]=sheetToTable(e,r.node)}else{[o,i,s]=tableToSheet(e,r.node)}const l=e.tr;l.replaceWith(i,s,e.schema.nodeFromJSON(o));n.dispatch(l);if(!a){hurmet.updateCalculations(n,false,o.attrs,i)}}})}function insertImage(e){return new MenuItem({title:"Insert link to image or edit existing image",icon:hurmetIcons.image,enable(t){if(t.selection.node&&t.selection.node.type.name=="figimg"){e=schema.nodes.figimg}return canInsert(t,e)},run(t,n,r){let{from:o,to:i}=t.selection;let s=null;if(t.selection instanceof NodeSelection&&t.selection.node.type==e){s=t.selection.node.attrs}const a=t.doc.resolve(o);const l=a.parent;const c=l.type.name==="figure";const d=c?o-1:0;const u=c?o-1+l.nodeSize:0;const p={title:s&&s.src?"Edit image":"Insert image",fields:{alt:new TextField({label:"Description",value:s?s.alt:t.doc.textBetween(o,i," ")}),width:new TextField({label:"Width",value:s&&s.width})},radioButtons:{name:"position",direction:"row",buttons:[["inline","inline"],["left","left"],["center","center"],["right","right"]],current:s&&s.class?s.class:"inline"},checkbox:{name:"Include a caption",checked:c},callback(t){const n=r.state.tr;if(t.checkbox&&!c){const e=t.alt?t.alt:"caption";const r=schema.nodes.figcaption.createAndFill(null,[schema.text(e)]);const o=schema.nodes.figimg.createAndFill(t);n.replaceSelectionWith(schema.nodes.figure.createAndFill(t,[o,r]))}else if(c&&!t.checkbox){n.replaceWith(d,u,e.createAndFill(t))}else{n.replaceSelectionWith(e.createAndFill(t))}r.dispatch(n);r.focus()}};if(!(s&&s.src)||s&&s.src&&s.src.length<400){p.fields={src:new TextField({label:"File path",required:true,value:s&&s.src}),...p.fields}}else if(s&&s.src){p.src=s.src}openPrompt(p)}})}function setRoundingCriteria(e){return new MenuItem({title:"Insert rounding criteria",label:".#",class:"math-button",enable(t){return canInsert(t,e)},run(e,t,n){let r="h3";const o=e.selection.$from.pos;e.doc.nodesBetween(0,o,(function(e,t){if(e.type.name==="calculation"&&e.attrs.name==="format"){r=e.attrs.value}}));const i={title:"Rounding Criteria",radioButtons:{name:"rounding",direction:"column",buttons:[["f","Digits after decimal (f)"],["r","Significant digits (r)"],["h","Significant digits in fraction (h)"],["S","Scientific (S)"],["N","Engineering (N)"],["e","Programmer (e)"],["k","SI prefix (k)"],["%","Percentage (%)"],["t","Truncate to integer (t)"],["b","Binary (b)"],["x","Hexadecimal (x)"]],current:r.slice(0,1)},numDigits:r.slice(1),callback(e){let t=e.value;const r=t.slice(1);if(r.length===0){t+="0"}if(isNaN(r)){alert("Invalid number of digits");return}const o=hurmet.compile(`format = "${t}"`);const i=n.state.tr;i.replaceSelectionWith(schema.nodes.calculation.createAndFill(o));n.dispatch(i);hurmet.updateCalculations(n,true);n.focus()}};openPrompt(i)}})}function wrapInEpigraph(e){return new MenuItem({title:"Wrap in an epigraph",label:"Epigraph",enable(t){return canInsert(t,e)},run(e,t){const{$from:n,$to:r}=e.selection;let o=e.doc.resolve(e.selection.from);const i=o.before(o.depth);o=e.doc.resolve(e.selection.to);const s=o.after(o.depth);const a=e.tr;a.addMark(i,s,schema.marks.em.create());let l=n.blockRange(r);const c=l&&findWrapping(l,schema.nodes.epigraph);if(!c)return false;a.wrap(l,c);t(a)}})}function toggleComment(e){return new MenuItem({title:"Insert or delete a comment",icon:hurmetIcons.comment,enable(t){return canInsert(t,e)},run(e,t){const n=e.selection.$anchor;for(let r=n.depth;r>0;r--){if(n.node(r).type.name=="comment"){t(e.tr.delete(n.before(r),n.after(r)).scrollIntoView());return false}}const r=e.doc.resolve(e.selection.from);const o=r.parent;if(o.type.name==="comment"){return}const i=e.tr;const s=r.before(r.depth);i.insert(s,schema.nodeFromJSON(JSON.parse(`{"type":"comment", "content":[{"type":"paragraph","content":[]}]}`)));i.setSelection(TextSelection.create(i.doc,s+1));t(i)}})}function takeSnapshot(){return new MenuItem({title:"Take and save a snapshot of the current document",label:"Take a snapshot...",run(e,t,n){openPrompt({title:"Snapshot",fields:{message:new TextField({label:"Commit message",required:true})},callback(t){const n=(new Date).toISOString().replace(/T.+/,"");let r=hurmetMarkdownSerializer.serialize(e.doc,new Map,[],false,true,false);r=r.replace(/\n\n\[[^\]]+\\: .+/,"");e.doc.attrs.snapshots.push({message:t.message,date:n,content:r})}})}})}function showDiffMenuItem(){return new MenuItem({label:"Show diff...",run(e,t,n){showDiff(e)}})}function deleteSnapshots(){return new MenuItem({label:"Delete all snapshots...",run(e,t,n){openPrompt({title:"Delete Snapshots",note:"This will delete all snapshots. It cannot be undone.",useOkButton:true,callback(){e.doc.attrs.snapshots=[]}})}})}function expandHurmetMacro(e,t){let n=0;let r=0;if(e.selection.from<e.selection.to){n=e.selection.from;r=e.selection.to}else{n=e.doc.resolve(e.selection.from).before();r=e.selection.from}const o=e.doc.textBetween(n,r);const i=/[A-Za-z][A-Za-z0-9_]*$/.exec(o);if(i){const n=i[0];e.doc.nodesBetween(0,e.doc.content.size,(function(e,o){if(e.type.name==="calculation"&&e.attrs.dtype===dt.MODULE){if(e.attrs.value[n]&&e.attrs.value[n].dtype===dt.MACRO){const o=e.attrs.value[n].value;const i={type:"fragment",content:hurmet.md2ast(o)};t.dispatch(t.state.tr.replaceWith(r-n.length,r,schema.nodeFromJSON(i)));hurmet.updateCalculations(t,true)}}}))}}function macroButton(){return new MenuItem({icon:hurmetIcons.scroll,title:"Expand a macro from the previous word.  Alt-E",run(e,t,n){expandHurmetMacro(e,n)}})}function insertToC(e){return new MenuItem({title:"Insert or edit a Table of Contents",label:"ToC",enable(t){return canInsert(t,e)},run(t,n,r){t.selection;let o=null;if(t.selection instanceof NodeSelection&&t.selection.node.type==e)o=t.selection.node.attrs;if(!o){o={start:1,end:2,body:[]}}openPrompt({title:"Table of Contents",note:"Set a range of heading levels:",fields:{start:new TextField({label:"Start",required:true,value:o&&o.start,validate(e){if(!/^[1-6]$/.test(e)){return"Input must be an integer between 1 and 6."}}}),end:new TextField({label:"End",required:true,value:o&&o.end,validate(e){if(!/^[1-6]$/.test(e)){return"Input must be an integer between 1 and 6."}}})},callback(o){const{$from:i,$to:s}=t.selection;const a=i.sharedDepth(s);const l=a!==0?i.before(a):i.pos;const c=a!==0?i.after(a):l+1;o.body=paginate(r,schema.nodes.toc,forToC,o.start,o.end);n(t.tr.replaceWith(l,c,e.createAndFill(o)))}})}})}function insertMath(e,t,n){const r=n==="calculation"?schema.nodes.calculation:schema.nodes.tex;let o=n==="calculation"?{entry:""}:{tex:""};if(e.selection instanceof NodeSelection&&e.selection.node.type==r){o=e.selection.node.attrs}const i=t.state.tr;const s=i.selection.from;const a=e.doc.resolve(s);const l=e.doc.resolve(a.before(a.depth)).parent;if(l.type.name==="centered"){o.displayMode=true}i.replaceSelectionWith(r.createAndFill(o));i.setSelection(NodeSelection.create(i.doc,s));t.dispatch(i)}function mathMenuItem(e,t){return new MenuItem({title:"Insert "+(t==="calculation"?"a calculation cell  Alt-C":"a TeX cell"),label:t==="calculation"?"":"",class:t==="tex"?"math-button":"mb-left",enable(t){return canInsert(t,e)},run(e,n,r){insertMath(e,r,t)}})}const createTable=(e,t=3,n=3,r=true)=>{const o=[];const i=[];for(let t=0;t<n;t++){o.push(e.nodes.table_cell.createAndFill());if(r){i.push(e.nodes.table_header.createAndFill())}}const s=[];for(let n=0;n<t;n++){s.push(e.nodes.table_row.createChecked(null,r&&n===0?i:o))}return e.nodes.table.create(null,s)};function cmdItem(e,t){let n={label:t.title,run:e};for(let e in t)n[e]=t[e];if(!t.enable||t.enable===true)n["enable"]=t=>e(t);return new MenuItem(n)}function markActive(e,t){let{from:n,$from:r,to:o,empty:i}=e.selection;if(i)return t.isInSet(e.storedMarks||r.marks());else return e.doc.rangeHasMark(n,o,t)}function markItem(e,t){let n={active(t){return markActive(t,e)},enable:true};for(let e in t)n[e]=t[e];return cmdItem(toggleMark(e),n)}function toggleDraftMode(){return new MenuItem({title:"Toggle draft mode",label:"Draft mode",enable(){return true},active(e){return e.doc.attrs.inDraftMode},run(e,t){draftMode(e,t,schema.nodes.calculation)}})}function tableItem(e,t,n,r){return new MenuItem({title:"title",icon:hurmetIcons[t],select(e){return isInTable(e)},run(e,t){n(e,t)}})}function deleteTable(){return new MenuItem({title:"Delete Table",icon:hurmetIcons["delete_table"],select(e){return isInTable(e)},run(e,t){const n=e.selection.$anchor;for(let r=n.depth;r>0;r--){const o=n.node(r);if(o.type.spec.tableRole=="table"){const o=n.node(r-1);if(o.type.name=="figure"){t(e.tr.delete(n.before(r-1),n.after(r-1)).scrollIntoView())}else{t(e.tr.delete(n.before(r),n.after(r)).scrollIntoView())}break}}return false}})}function reCalcAll(){return new MenuItem({title:"Recalculate all",icon:hurmetIcons.recalc,run(e,t,n){hurmet.updateCalculations(n,true)}})}function setDecimalFormat(e){return new MenuItem({label:e,run(t,n,r){t.doc.attrs.decimalFormat=e;hurmet.updateCalculations(r,true)}})}const setDateFormat=new MenuItem({label:"Date format...",title:"Set date format",run(e,t,n){let r=e.doc.attrs.dateFormat;const o=dateFormatRegEx.exec(r);const i=o[1]?true:false;if(i){r=r.slice(o[1].length+1).trim()}if(o[7]){r=r.slice(0,-o[7].length).trim()}const s={title:"Date Format",radioButtons:{name:"dateFormat",direction:"column",buttons:[["yyyy-mm-dd","yyyy-mm-dd"],["dd.mm.yyyy","dd.mm.yyyy"],["d mmmm yyyy","d mmmm yyyy"],["d mmm yyyy","d mmm yyyy"],["mmmm d, yyyy","mmmm d, yyyy"],["mmm d, yyyy","mmm d, yyyy"],["d de mmmm de yyyy","d de mmmm de yyyy"]],current:r},checkbox:{name:"Prepend weekday",checked:i},fields:{language:new TextField({label:"Language code",leader:"Language code",value:o[7]?o[7]:"en",required:false})},callback(t){let r=t.format;if(t.checkbox){r=(r.indexOf("mmmm")>-1?"wwww":"www")+", "+r}if(t.language&&t.language!=="en"){r+=" "+t.language}e.doc.attrs.dateFormat=r;hurmet.updateCalculations(n,true)}};openPrompt(s)}});function setFontSize(e){return new MenuItem({label:String(e)+" pt",run(t,n,r){t.doc.attrs.fontSize=e;const o=document.getElementById("editor-content");if(o.classList.contains("pica")){o.classList.add("long-primer");o.classList.remove("pica")}else{o.classList.add("pica");o.classList.remove("long-primer")}document.getElementById("print-div").className=e===12?"ProseMirror pica":"ProseMirror long-primer"}})}function setPageSize(e){return new MenuItem({label:e,run(t,n,r){t.doc.attrs.pageSize=e;const o=document.getElementById("pageStyle");o.innerHTML=e==="letter"?`@media print {@page{size: letter; margin: 16mm 0.75in 16mm 0.75in;}}`:`@media print {@page{size: A4; margin: 16mm 16.1mm 16mm 16.1mm;}}`}})}function tableStyle(e,t,n){return new MenuItem({title:e,icon:hurmetIcons[n],select(e){return isInTable(e)},run(e,n){const r=findTable(e.selection);const o=clone(r.node.attrs);const i=o.class.split(" ");const s=e.tr;if(/^align/.test(t)){const n=t.slice(6,7);const r=getSelectionRect(e.selection);if(r){for(let e=r.left+1;e<r.right+1;e++){let t=false;for(let r=0;r<i.length;r++){const o=i[r].slice(1,2);if(!isNaN(o)){if(Number(o)===e){t=true;i[r]=n==="l"?"":"c"+o+n}}}if(!t)i.push("c"+e+n)}}}else{i[0]=t}o.class=i.join(" ").replace(/ {2,}/g," ");s.setNodeMarkup(r.pos,undefined,o);n(s)}})}const liftItem=new MenuItem({title:"Lift (unwrap) out of enclosing block",run(e,t){let{$from:n,$to:r}=e.selection;let o=n.blockRange(r),i=o&&liftTarget(o);const s=o.depth;if(i==null)return false;const a=e.tr;if(n.node(-1).type.name=="centered"){e.doc.nodesBetween(n.before(s+1),r.after(s+1),(function(e,t){if(e.type.name==="calculation"||e.type.name==="tex"){const n=e.attrs;n.displayMode=false;a.replaceWith(t,t+1,schema.nodes[e.type.name].createAndFill(n))}}))}a.lift(o,i).scrollIntoView();if(t)t(a);return true},select:e=>lift(e),icon:icons.lift});const centerBlock=new MenuItem({title:"Center block",label:"Centered",run(e,t){let{$from:n,$to:r}=e.selection;let o=n.blockRange(r);const i=n.depth;const s=o&&findWrapping(o,schema.nodes.centered);if(!s)return false;const a=e.tr;e.doc.nodesBetween(n.before(i),r.after(i),(function(t,n){if(t.type.name==="calculation"||t.type.name==="tex"){if(e.doc.resolve(n).parent.childCount===1){const e=t.attrs;e.displayMode=true;a.replaceWith(n,n+1,schema.nodes[t.type.name].createAndFill(e))}}}));a.wrap(o,s).scrollIntoView();if(t)t(a);return true},select(e){return wrapIn(schema.nodes.centered)(e)}});const selectParentNodeItem=new MenuItem({title:"Select parent node",run:selectParentNode,enable:e=>selectParentNode(e),icon:icons.selectParentNode});function linkItem(e){return new MenuItem({title:"Add or remove link",icon:icons.link,active(t){return markActive(t,e)},enable(e){return!e.selection.empty},run(t,n,r){if(markActive(t,e)){toggleMark(e)(t,n);return true}openPrompt({title:"Create a link",fields:{href:new TextField({label:"Link target",required:true})},callback(t){toggleMark(e,t)(r.state,r.dispatch);r.focus()}})}})}function wrapListItem(e,t){return cmdItem(wrapInList(e,t.attrs),t)}function buildMenuItems(e){const t={};let n;t.navigate=navigate();t.openFile=openFile();t.saveFile=saveFile();t.saveFileAs=saveFileAs();t.permalink=permalink();t.insertHeader=insertHeader();t.dot=setDecimalFormat("1000000.");t.commadot=setDecimalFormat("1,000,000.");t.lakh=setDecimalFormat("1,00,000.");t.cn=setDecimalFormat("1,0000,0000.");t.comma=setDecimalFormat("1000000,");t.spacecomma=setDecimalFormat("1 000 000,");t.apostrophecomma=setDecimalFormat("1000000,");t.dotcomma=setDecimalFormat("1.000.000,");t.pica=setFontSize(12);t.longprimer=setFontSize(10);t.letter=setPageSize("letter");t.A4=setPageSize("A4");t.toggleDraftMode=toggleDraftMode();t.recalcAll=reCalcAll();t.deleteComments=deleteComments();t.takeSnapshot=takeSnapshot();t.showDiffMenuItem=showDiffMenuItem();t.deleteSnapshots=deleteSnapshots();t.print=print();if(n=e.marks.strong)t.toggleStrong=markItem(n,{title:"Toggle strong style",icon:icons.strong});if(n=e.marks.em)t.toggleEm=markItem(n,{title:"Toggle emphasis",icon:icons.em});if(n=e.marks.code)t.toggleCode=markItem(n,{title:"Toggle code font  Ctrl-`",icon:icons.code});if(n=e.marks.subscript)t.toggleSubscript=markItem(n,{title:"Toggle subscript  Ctrl-,",icon:hurmetIcons.subscript});if(n=e.marks.superscript)t.toggleSuperscript=markItem(n,{title:"Toggle superscript  Ctrl-.",icon:hurmetIcons.superscript});if(n=e.marks.strikethru)t.toggleStrikethru=markItem(n,{title:"Toggle strikethrough",icon:hurmetIcons.strikethru});if(n=e.marks.underline)t.toggleUnderline=markItem(n,{title:"Toggle underline  Ctrl-u",icon:hurmetIcons.underline});if(n=e.marks.highlight)t.toggleHighlight=markItem(n,{title:"Toggle highlight",icon:hurmetIcons.highlight});if(n=e.marks.link)t.toggleLink=linkItem(n);if(n=e.nodes.image)t.imageUpload=uploadImage(n);if(n=e.nodes.image)t.imageLink=insertImage(n);if(n=e.nodes.footnote)t.footnote=footnote();if(n=e.nodes.toc)t.toc=insertToC(n);t.macroButton=macroButton();if(n=e.nodes.calculation)t.insertCalclation=mathMenuItem(n,"calculation");if(n=e.nodes.tex)t.insertTeX=mathMenuItem(n,"tex");if(n=e.nodes.comment)t.toggleComment=toggleComment(n);if(n=e.nodes.tight_list_item)t.tighten=tighten();if(n=e.nodes.bullet_list)t.wrapBulletList=wrapListItem(n,{title:"Wrap in bullet list",icon:icons.bulletList});if(n=e.nodes.ordered_list)t.wrapOrderedList=wrapListItem(n,{title:"Wrap in ordered list",icon:icons.orderedList});if(n=e.nodes.blockquote)t.wrapBlockQuote=wrapItem(n,{title:"Wrap in block quote",icon:icons.blockquote});if(n=e.nodes.epigraph)t.wrapEpigraph=wrapInEpigraph(n);if(n=e.nodes.centered)t.wrapCentered=centerBlock;if(n=e.nodes.right_justified)t.wrapRightJustified=wrapItem(n,{title:"Right-justify block",label:"Right-justifed"});if(n=e.nodes.indented)t.wrapIndent=wrapItem(n,{title:"Indent block  Alt-I",label:"Indented  Alt-I"});if(n=e.nodes.boxed)t.wrapBoxed=wrapItem(n,{title:"Draw box around block",label:"Boxed"});if(n=e.nodes.note)t.wrapNote=wrapItem(n,{title:"Note alert",label:"Note"});if(n=e.nodes.tip)t.wrapTip=wrapItem(n,{title:"Tip alert",label:"Tip"});if(n=e.nodes.important)t.wrapImportant=wrapItem(n,{title:"Alert as important",label:"Important"});if(n=e.nodes.warning)t.wrapWarning=wrapItem(n,{title:"Warning alert",label:"Warning"});if(n=e.nodes.paragraph)t.makeParagraph=blockTypeItem(n,{title:"Change to plain paragraph",icon:hurmetIcons.paragraph});if(n=e.nodes.code_block)t.makeCodeBlock=blockTypeItem(n,{title:"Change to code block",icon:icons.code});if(n=e.nodes.heading){for(let e=1;e<=6;e++){t["makeHead"+e]=blockTypeItem(n,{title:"Change to heading "+e,label:"H"+e+"",attrs:{level:e}})}}if(n=e.nodes.horizontal_rule){let e=n;t.insertHorizontalRule=new MenuItem({title:"Insert horizontal rule",label:"",enable(t){return canInsert(t,e)},run(t,n){n(t.tr.replaceSelectionWith(e.create()))}})}if(n=e.nodes.table){let r=n;t.insertTable=new MenuItem({title:"Insert Table",icon:hurmetIcons.table,enable(e){return canInsert(e,r)},run(t,n){n(t.tr.replaceSelectionWith(createTable(e,3,3,true)))}})}t.deleteTable=deleteTable();t.addRowBefore=tableItem("Insert row before","add_row_before",addRowBefore);t.deleteRow=tableItem("Delete row","delete_row",deleteRow);t.addColumnBefore=tableItem("Insert column before","add_col_before",addColumnBefore);t.deleteColumn=tableItem("Delete column","delete_col",deleteColumn);t.toggleCellMerge=new MenuItem({title:"Toggle cell merge",icon:hurmetIcons.combine_cells,select(e){return isInTable(e)},run(e,t){if(mergeCells(e,t)){return}splitCell(e,t)}});t.toggleTableCaption=toggleTableCaption();t.toggleSpreadsheet=toggleSpreadsheet();t.grid=tableStyle("Grid","grid","grid");t.nogrid=tableStyle("No borders","nogrid","nogrid");t.oneRule=tableStyle("Border below header","one-rule","oneRule");t.twoRules=tableStyle("Borders below header and above bottom line.","two-rules","twoRules");t.threeRules=tableStyle("Three rules","three-rules","threeRules");t.fourRules=tableStyle("Four rules","four-rules","fourRules");t.rules=tableStyle("All rules","rules","rules");t.striped=tableStyle("striped","striped","striped");t.alignColLeft=tableStyle("Align Column Left","align-left","align-left");t.alignColCenter=tableStyle("Align Column Center","align-center","align-center");t.alignColRight=tableStyle("Align Column Right","align-right","align-right");t.help=blockTypeItem(n,{title:"Help",icon:hurmetIcons.info,enable(){return true},run(){window.open("manual.html")}});t.accessors=hint("Accessors","Accessors","Accessors","",[["vector[number]"],["vector[start:finish]"],["matrix[rowNum, colNum]"],["matrix[startRowNum,:finishRowNum, startColNum:finishColNum]"],['dataframe["rowName", "colName"]'],["dataFrame.rowName.colName"],["dataFrame.colName.rowName"],["dataFrame.colName.end"],["dataframe.colName[rowNum]"],['dataframe[["rowName1"; "rowName2"]]["col1", "col2"]'],["spreadsheet.A1"],["spreadsheet.A"],["spreadsheet.colName"]]);t.display=hint("?","Display Selectors","Display Selectors","math-button",[["?","??","All"],["%","%%","Omit blue echo"],["!","!!","Omit result"],["@","@@","Result only"]]);t.letters=hint("","Letters","Letters","math-button",[["","","","","","","","","",""],["","","","","","","","","","","",""],["","","","","","","","","","",""],["","","","","","","","","","","","",""],["","","","","","","","","","","","",""],["","","","","","","","","","","","",""],["","","","","","","","","","","","",""],["","","","","","","",""],["","","","","","","","","","","",""],["","","","","","","","","","","","",""]]);t.symbols=hint("","Symbols","Symbols","math-button",[["","","","","","","","","","",""],["","","","*","","","","","","","","","",""],["","","","","","","","","","","","","",""],["","","","","","","","","","","","","","","","",""]]);t.accents=hint("","Accents","Accents","math-button",[[["acute",""],["bar",""],["breve",""],["check",""],["dot",""],["ddot",""],["grave",""],["hat",""]],[["harpoon",""],["leftharpoon",""],["leftrightvec",""],["leftvec",""],["ring",""],["tilde",""],["vec",""],["ul",""]]]);t.syntax=hint("Syntax","Syntax","Syntax","",[["a_subscript","b^exponent","x"],["(a+b) / (c+d)","1//2","2///3"],["[1; 2; 3]","(a, b; c, d)"],["[start:step:end] = ?"],["{a if b; c otherwise}"]]);t.trig=hint("Trigonometry","Trigonometry","Trigonometry Functions","",[["cos","sin","tan","sec","csc","cot"],["acos","asin","atan","atan2","asec","acsc","acot"],["cosd","sind","tand","secd","cscd","cotd"],["acosd","asind","atand","asecd","acscd","acotd"]]);t.hyperbolic=hint("Hyperbolic","Hyperbolic","Hyperbolic Functions","",[["cosh","sinh","tanh","sech","csch","coth"],["acosh","asinh","atanh","asech","acsch","acoth"]]);t.math=hint("Math","Math","Math Functions","",[["ln","log","log10","log2","logn"],["binomial","exp","factorial","lfact","lgamma","gamma",""],["isnan","Int","abs","ceil","floor","sign"],["conj","imag","real","angle"],["gcd","hypot","rand","rms","mod","rem"],["format","round","roundSig","roundn"]]);t.matrix=hint("Matrix","Matrix","Matrix Functions","",[["length","accumulate","findmax","hcat","vcat"],["lerp","trace","transpose","ones","zeros","matrix2table"]]);t.reducers=hint("Reducer","Reducer","Reducer Functions","",[["accumulate","dataframe","findfirst","matrix2table"],["min","max","sum","mean","median"],["product","range","stddev","variance"]]);t.string=hint("String","String","String Functions","",[["fetch","Char","count","number","string"]]);t.date=hint("Date","Date","Date functions","",[["today","savedate",""]]);t.functionsDropDown=new Dropdown([t.trig,t.hyperbolic,t.math,t.matrix,t.reducers,t.string,t.date],{label:"",title:"Functions",class:"math-dropdown"});t.rounding=setRoundingCriteria(e.nodes.calculation);t.hintDropDown=new Dropdown([t.accessors,t.syntax],{label:"Q",title:"Quick Reference",class:"md-right"});let r=e=>e.filter((e=>e));t.fontsize=new DropdownSubmenu([t.pica,t.longprimer],{label:"Font size"});t.dateFormat=setDateFormat;t.pagesize=new DropdownSubmenu([t.letter,t.A4],{label:"Page size"});t.separators=new DropdownSubmenu([t.dot,t.commadot,t.lakh,t.cn,t.comma,t.spacecomma,t.apostrophecomma,t.dotcomma],{title:"Set decimal format",label:"Decimal format"});t.fileDropDown=new Dropdown([t.openFile,t.saveFile,t.saveFileAs,t.permalink,t.takeSnapshot,t.showDiffMenuItem,t.deleteSnapshots,t.pagesize,t.print],{label:"File"});t.documentDropDown=new Dropdown([t.separators,t.fontsize,t.dateFormat,t.toggleDraftMode,t.insertHeader,t.deleteComments],{label:"Doc"});t.fileMenu=[[t.navigate,t.fileDropDown,t.documentDropDown,t.recalcAll]];t.inlineMenu=[[t.toggleStrong,t.toggleEm,t.toggleCode,t.toggleSubscript,t.toggleSuperscript,t.toggleStrikethru,t.toggleUnderline,t.toggleHighlight]];t.insertMenu=[[t.toggleLink,t.insertHorizontalRule,t.imageUpload,t.imageLink,t.footnote,t.toc,t.toggleComment]];t.headingDropDown=new Dropdown([t.makeHead4,t.makeHead5,t.makeHead6],{label:"H*"});t.typeMenu=[r([t.makeParagraph,t.makeCodeBlock,t.makeHead1,t.makeHead2,t.makeHead3,t.headingDropDown])];t.blockMenu=[[t.wrapBulletList,t.wrapOrderedList,t.tighten,t.wrapBlockQuote,t.blockDropDown=new Dropdown([t.wrapIndent,t.wrapCentered,t.wrapRightJustified,t.wrapEpigraph,t.wrapBoxed,t.wrapNote,t.wrapTip,t.wrapImportant,t.wrapWarning],{label:"",title:"Block format"}),joinUpItem,liftItem,selectParentNodeItem]];t.tableStyle=new Dropdown([t.grid,t.nogrid,t.oneRule,t.twoRules,t.threeRules,t.fourRules,t.rules,t.striped],{label:"Tbl Style"});t.tableMenu=[r([t.insertTable,t.addRowBefore,t.addColumnBefore,t.deleteTable,t.deleteRow,t.deleteColumn,t.toggleCellMerge,t.toggleTableCaption,t.alignColLeft,t.alignColCenter,t.alignColRight,t.tableStyle,t.toggleSpreadsheet])];t.copyAsMarkdown=copyAsMarkdown();t.copyAsMarkdownWithResults=copyAsMarkdownWithResults();t.copyAsGFM=copyAsGFM();t.pasteAsMarkdown=pasteAsMarkdown(false);t.convertAndPaste=pasteAsMarkdown(true);t.Markdown=new Dropdown([t.copyAsMarkdown,t.copyAsMarkdownWithResults,t.copyAsGFM,t.pasteAsMarkdown,t.convertAndPaste],{label:""});t.math=[[t.insertCalclation,t.insertTeX,t.letters,t.symbols,t.accents,t.display,t.rounding,t.functionsDropDown,t.hintDropDown]];t.fullMenu=t.fileMenu.concat([[undoItem,redoItem,t.Markdown]],t.inlineMenu,t.insertMenu,t.typeMenu,t.blockMenu,t.math,[[t.help]],t.tableMenu);return t}class InputRule{constructor(e,t,n={}){this.match=e;this.match=e;this.handler=typeof t=="string"?stringHandler(t):t;this.undoable=n.undoable!==false;this.inCode=n.inCode||false}}function stringHandler(e){return function(t,n,r,o){let i=e;if(n[1]){let e=n[0].lastIndexOf(n[1]);i+=n[0].slice(e+n[1].length);r+=e;let t=r-o;if(t>0){i=n[0].slice(e-t,e)+i;r=o}}return t.tr.insertText(i,r,o)}}const MAX_MATCH=500;function inputRules({rules:e}){let t=new Plugin({state:{init(){return null},apply(e,t){let n=e.getMeta(this);if(n)return n;return e.selectionSet||e.docChanged?null:t}},props:{handleTextInput(n,r,o,i){return run(n,r,o,i,e,t)},handleDOMEvents:{compositionend:n=>{setTimeout((()=>{let{$cursor:r}=n.state.selection;if(r)run(n,r.pos,r.pos,"",e,t)}))}}},isInputRules:true});return t}function run(e,t,n,r,o,i){if(e.composing)return false;let s=e.state,a=s.doc.resolve(t);let l=a.parent.textBetween(Math.max(0,a.parentOffset-MAX_MATCH),a.parentOffset,null,"")+r;for(let c=0;c<o.length;c++){let d=o[c];if(a.parent.type.spec.code){if(!d.inCode)continue}else if(d.inCode==="only"){continue}let u=d.match.exec(l);let p=u&&d.handler(s,u,t-(u[0].length-r.length),n);if(!p)continue;if(d.undoable)p.setMeta(i,{transform:p,from:t,to:n,text:r});e.dispatch(p);return true}return false}const undoInputRule=(e,t)=>{let n=e.plugins;for(let r=0;r<n.length;r++){let o=n[r],i;if(o.spec.isInputRules&&(i=o.getState(e))){if(t){let n=e.tr,r=i.transform;for(let e=r.steps.length-1;e>=0;e--)n.step(r.steps[e].invert(r.docs[e]));if(i.text){let t=n.doc.resolve(i.from).marks();n.replaceWith(i.from,i.to,e.schema.text(i.text,t))}else{n.delete(i.from,i.to)}t(n)}return true}}return false};const emDash=new InputRule(/--$/,"");const ellipsis=new InputRule(/\.\.\.$/,"");const openDoubleQuote=new InputRule(/(?:^|[\s\{\[\(\<'"\u2018\u201C])(")$/,"");const closeDoubleQuote=new InputRule(/"$/,"");const openSingleQuote=new InputRule(/(?:^|[\s\{\[\(\<'"\u2018\u201C])(')$/,"");const closeSingleQuote=new InputRule(/'$/,"");const smartQuotes=[openDoubleQuote,closeDoubleQuote,openSingleQuote,closeSingleQuote];function wrappingInputRule(e,t,n=null,r){return new InputRule(e,((e,o,i,s)=>{let a=n instanceof Function?n(o):n;let l=e.tr.delete(i,s);let c=l.doc.resolve(i),d=c.blockRange(),u=d&&findWrapping(d,t,a);if(!u)return null;l.wrap(d,u);let p=l.doc.resolve(i-1).nodeBefore;if(p&&p.type==t&&canJoin(l.doc,i-1)&&(!r||r(o,p)))l.join(i-1);return l}))}function textblockTypeInputRule(e,t,n=null){return new InputRule(e,((e,r,o,i)=>{let s=e.doc.resolve(o);let a=n instanceof Function?n(r):n;if(!s.node(-1).canReplaceWith(s.index(-1),s.indexAfter(-1),t))return null;return e.tr.delete(o,i).setBlockType(o,o,t,a)}))}const mac=typeof navigator!="undefined"?/Mac/.test(navigator.platform):false;function buildKeymap(e,t){let n={},r;function o(e,r){if(t){let n=t[e];if(n===false)return;if(n)e=n}n[e]=r}o("Ctrl-s",((e,t,n)=>{saveFileAsMarkdown(e,n);return true}));o("Ctrl-p",((e,t,n)=>{printHurmet(n);return true}));o("Alt-j",((t,n,r)=>{readFile(t,n,r,e,"hurmet");return true}));o("Mod-z",undo);o("Shift-Mod-z",redo);o("Backspace",undoInputRule);if(!mac)o("Mod-y",redo);o("Tab",goToNextCell(1));o("Shift-Tab",goToNextCell(-1));o("Alt-ArrowUp",joinUp);o("Alt-ArrowDown",joinDown);o("Mod-BracketLeft",lift);if(r=e.marks.strong)o("Mod-b",toggleMark(r));if(r=e.marks.em)o("Mod-i",toggleMark(r));if(r=e.marks.code)o("Mod-`",toggleMark(r));if(r=e.marks.subscript)o("Mod-,",toggleMark(r));if(r=e.marks.superscript)o("Mod-.",toggleMark(r));if(r=e.marks.underline)o("Mod-u",toggleMark(r));if(r=e.nodes.calculation){o("Alt-c",((e,t,n)=>{insertMath(e,n,"calculation");return true}))}o("Alt-e",((e,t,n)=>{expandHurmetMacro(e,n);return true}));if(r=e.nodes.bullet_list)o("Shift-Ctrl-8",wrapInList(r));if(r=e.nodes.ordered_list)o("Shift-Ctrl-9",wrapInList(r));if(r=e.nodes.blockquote)o("Ctrl->",wrapIn(r));if(r=e.nodes.indented)o("Alt-i",wrapIn(r));if(r=e.nodes.hard_break){let e=r,t=chainCommands(exitCode,((t,n)=>{n(t.tr.replaceSelectionWith(e.create()).scrollIntoView());return true}));o("Mod-Enter",t);o("Shift-Enter",t);if(mac)o("Ctrl-Enter",t)}if(r=e.nodes.list_item){o("Enter",splitListItem(r));o("Mod-[",liftListItem(r));o("Mod-]",sinkListItem(r))}if(r=e.nodes.paragraph)o("Shift-Ctrl-0",setBlockType(r));if(r=e.nodes.code_block)o("Shift-Ctrl-\\",setBlockType(r));if(r=e.nodes.heading)for(let e=1;e<=6;e++)o("Shift-Ctrl-"+e,setBlockType(r,{level:e}));if(r=e.nodes.horizontal_rule){let e=r;o("Mod-_",((t,n)=>{n(t.tr.replaceSelectionWith(e.create()).scrollIntoView());return true}))}return n}function blockQuoteRule(e){return wrappingInputRule(/^\s*>\s$/,e)}function orderedListRule(e){return wrappingInputRule(/^(?:(\d+)|([A-Z])|([a-z]))\.\s$/,e,(e=>({class:e[2]?"upper-alpha":e[3]?"lower-alpha":"decimal",order:e[1]?+e[1]:e[2]?e[2].codePointAt(0)-64:e[3].codePointAt(0)-96})),((e,t)=>e[1]?t.childCount+t.attrs.order===+e[1]:false))}function bulletListRule(e){return wrappingInputRule(/^\s*([-+*])\s$/,e)}function codeBlockRule(e){return textblockTypeInputRule(/^```$/,e)}function headingRule(e,t){return textblockTypeInputRule(new RegExp("^(#{1,"+t+"})\\s$"),e,(e=>({level:e[1].length})))}function buildInputRules(e){let t=smartQuotes.concat(ellipsis,emDash),n;if(n=e.nodes.blockquote){t.push(blockQuoteRule(n))}if(n=e.nodes.ordered_list){t.push(orderedListRule(n))}if(n=e.nodes.bullet_list){t.push(bulletListRule(n))}if(n=e.nodes.code_block){t.push(codeBlockRule(n))}if(n=e.nodes.heading){t.push(headingRule(n,6))}return inputRules({rules:t})}const autoCorrectRegEx=/([?:<>\-~/_!]=| \.| \*|~~|\+-|-\+|<-->|<->|<>|<--|<-|-->|->|=>|-:|\^\^|\\\||\/\/\/|\b(bar|hat|vec|tilde|dot|ddot|ul)|\b(bb|bbb|cc|ff|ss) [A-Za-z]|\\?[A-Za-z]{2,}|\\c|\\ |\\o|root [234]|<<|>>|\^-?[0-9]+|\|\|\||\/_|''|""|00)\s$/;const accents={acute:"",bar:"",breve:"",check:"",dot:"",ddot:"",grave:"",hat:"",harpoon:"",leftharpoon:"",leftrightvec:"",leftvec:"",ring:"",tilde:"",vec:"",ul:""};const autoCorrections={alpha:"",beta:"",chi:"",delta:"",Delta:"",epsilon:"",varepsilon:"",eta:"",gamma:"",Gamma:"",iota:"",kappa:"",lambda:"",Lambda:"",mu:"",nu:"",omega:"",Omega:"",phi:"",varphi:"",Phi:"",pi:"",Pi:"",psi:"",Psi:"",rho:"",sigma:"",Sigma:"",tau:"",theta:"",vartheta:"",Theta:"",upsilon:"",xi:"",Xi:"",zeta:"",prime:"",ee:"",ll:"",sqrt:"","root 2":"","root 3":"","root 4":"",AA:"",CC:"",EE:"",HH:"",NN:"",QQ:"",RR:"",ZZ:"",OO:"",ii:"(-1)",oo:"",ooo:"",not:"","-:":"","\\ ":"","\\c":"","\\cdots":"","\\vdots":"","\\ddots":"","\\floor":"","\\ceil":"",xx:"","\\int":"","\\iint":"","\\oint":"","\\sum":"",nn:"",nnn:"",uu:"",uuu:"","\\del":"","\\grad":"","\\hbar":"","\\ell":"","\\nabla":"","\\alef":"","\\subset":"","\\supset":"",contains:"",owns:"","\\subseteq":"","\\nsubset":"","\\nsubseteq":"","\\nsupset":"","\\nsupseteq":"","\\forall":"","\\therefore":"","\\mapsto":"","\\checkmark":"",bar:"",dot:"",ddot:"",hat:"",tilde:"",vec:"","\\land":"","\\lor":"","\\not":"","\\notin":"","\\euro":"","\\pound":"","\\yen":"","\\o":"","^^":"",vv:"",vvv:"","\\xor":"","\\in":"","<>":"","!=":"",":=":"","?=":"","<=":"",">=":"","-=":"","~=":"","_=":"","~~":"","+-":"","-+":"","<<":"",">>":"","///":"","<->":"","<-":"","<--":"","--\x3e":"","->":"","=>":"","<--\x3e":"\\xrightleftarrows","\\circ":"","\\otimes":"","|||":"","\\|":"","/_":""," .":""," *":"  ","''":"",'""':""};const supCharFromNum={"^":"","-":"",2:"",3:"",1:"",0:"",4:"",5:"",6:"",7:"",8:"",9:"","(":"",")":""};const superscript=e=>{let t="";for(const n of e){t+=supCharFromNum[n]}return t};const lowSurrogateDiff={bb:[56255,56249],bbb:[56567,56561],cc:[56411,56405],ff:[56671,56665]};const wideExceptions=[56634,56639,56645,56647,56648,56649,56657,56477,56480,56481,56483,56484,56487,56488,56493,56506,56508,56513,56516];const bbb={C:"",H:"",N:"",P:"",Q:"",R:"",Z:""};const calligraphic={B:"",E:"",F:"",H:"",I:"",L:"",M:"",R:"",e:"",g:"",l:"",o:""};const fontStr=e=>{const t=e.indexOf(" ");const n=e.substring(t+1);const r=e.substring(0,t);return fontedChar(n,r)};const fontedChar=(e,t)=>{switch(t){case"bb":case"bbb":case"cc":case"ff":{const n=e.charCodeAt(0);let r="";if(n<65||n>122){return null}const o=n<91?0:1;if(t==="cc"&&o&&n!==108){return null}if(n>90&&t==="bbb"){return null}const i=n+lowSurrogateDiff[t][o];if(wideExceptions.includes(i)){r=t==="bbb"?bbb[e]:calligraphic[e]}else{r="\ud835"+String.fromCharCode(i)}return r}default:return null}};const autoCorrect=(e,t,n)=>{if(t.length>0&&t.slice(-1)===" "){const r=autoCorrectRegEx.exec(t);if(r){const o=r[0].slice(0,-1);let i;const s=accents[o];if(s){const o=t.slice(0,-(r[0].length+1))+s;e.updateCode(o+n);const i=o.length;e.restore({start:i,end:i,dir:undefined})}else{i=autoCorrections[o];if(!i){if(o.charAt(0)==="^"){i=superscript(o)}else{if(o.indexOf(" ")>0){i=fontStr(o)}}}}if(i){const o=t.slice(0,-r[0].length)+i;e.updateCode(o+n);const s=o.length;e.restore({start:s,end:s,dir:undefined})}}}};const boldPrevChar=e=>{if(e.length===0){return null}const t=e.charAt(e.length-1);return fontedChar(t,"bb")};const highlight=e=>{const t=e.textContent.replace(/\t/gm,'<span style="background-color: lemonchiffon">\t</span>');e.innerHTML=t};const codeJar=(e,t)=>{const n={tab:"\t",indentOn:/{$/,catchTab:true,preserveIdent:true,addClosing:true};const r=window.document;const o=[];let i;let s;e.setAttribute("contenteditable","plaintext-only");e.setAttribute("spellcheck","false");e.style.outline="none";e.style.overflowWrap="break-word";e.style.overflowY="auto";e.style.whiteSpace="pre-wrap";const a=e=>{highlight(e)};let l=false;if(e.contentEditable!=="plaintext-only")l=true;if(l)e.setAttribute("contenteditable","true");const c=R((()=>{const t=u();a(e);p(t)}),30);const d=(t,n)=>{o.push([t,n]);e.addEventListener(t,n)};d("keydown",(t=>{if(t.keyCode===13&&!t.shiftKey)return;if(t.keyCode===66&&t.ctrlKey){const t=textBeforeCursor(e);const n=boldPrevChar(t);if(n){const r=t.length;e.textContent=t.slice(0,-1)+n+textAfterCursor(e);p({start:r,end:r,dir:undefined})}}if(t.keyCode===65&&t.ctrlKey){window.getSelection().selectAllChildren(e);t.preventDefault()}if(t.defaultPrevented)return;s=M();if(n.preserveIdent)m(t);else g(t);if(n.catchTab)b(t);if(n.addClosing)y(t);if(l)p(u())}));d("keyup",(e=>{if(e.defaultPrevented)return;if(e.isComposing)return;if(s!==M())c();if(i)i(M())}));d("paste",(e=>{x(e);if(i)i(M())}));function u(){const t=T();const n={start:0,end:0,dir:undefined};let{anchorNode:o,anchorOffset:i,focusNode:s,focusOffset:a}=t;if(!o||!s)throw"error1";if(o.nodeType===Node.ELEMENT_NODE){const e=r.createTextNode("");o.insertBefore(e,o.childNodes[i]);o=e;i=0}if(s.nodeType===Node.ELEMENT_NODE){const e=r.createTextNode("");s.insertBefore(e,s.childNodes[a]);s=e;a=0}w(e,(e=>{if(e===o&&e===s){n.start+=i;n.end+=a;n.dir=i<=a?"->":"<-";return"stop"}if(e===o){n.start+=i;if(!n.dir){n.dir="->"}else{return"stop"}}else if(e===s){n.end+=a;if(!n.dir){n.dir="<-"}else{return"stop"}}if(e.nodeType===Node.TEXT_NODE){if(n.dir!="->")n.start+=e.nodeValue.length;if(n.dir!="<-")n.end+=e.nodeValue.length}}));e.normalize();return n}function p(t){const n=T();let r,o=0;let i,s=0;if(!t.dir)t.dir="->";if(t.start<0)t.start=0;if(t.end<0)t.end=0;if(t.dir=="<-"){const{start:e,end:n}=t;t.start=n;t.end=e}let a=0;w(e,(e=>{if(e.nodeType!==Node.TEXT_NODE)return;const n=(e.nodeValue||"").length;if(a+n>t.start){if(!r){r=e;o=t.start-a}if(a+n>t.end){i=e;s=t.end-a;return"stop"}}a+=n}));if(!r)r=e,o=e.childNodes.length;if(!i)i=e,s=e.childNodes.length;if(t.dir=="<-"){[r,o,i,s]=[i,s,r,o]}n.setBaseAndExtent(r,o,i,s)}function f(){const t=T();const n=t.getRangeAt(0);const o=r.createRange();o.selectNodeContents(e);o.setEnd(n.startContainer,n.startOffset);return o.toString()}function h(){const t=T();const n=t.getRangeAt(0);const o=r.createRange();o.selectNodeContents(e);o.setStart(n.endContainer,n.endOffset);return o.toString()}function m(e){if(e.key==="Enter"){const t=f();const r=h();let[o]=v(t);let i=o;if(n.indentOn.test(t)){i+=n.tab}if(i.length>0){A(e);e.stopPropagation();S("\n"+i)}else{g(e)}if(i!==o&&r[0]==="}"){const e=u();S("\n"+o);p(e)}}}function g(e){if(l&&e.key==="Enter"){A(e);e.stopPropagation();if(h()==""){S("\n ");const e=u();e.start=--e.end;p(e)}else{S("\n")}}}function y(e){const t=`([{'"`;const n=`)]}'"`;const r=h();const o=f();const i=o.substr(o.length-1)==="\\";const s=r.substr(0,1);if(n.includes(e.key)&&!i&&s===e.key){const t=u();A(e);t.start=++t.end;p(t)}else if(t.includes(e.key)&&!i&&(`"'`.includes(e.key)||[""," ","\n"].includes(s))){A(e);const r=u();const o=r.start==r.end?"":T().toString();const i=e.key+o+n[t.indexOf(e.key)];S(i);r.start++;r.end++;p(r)}}function b(e){if(e.key==="Tab"){A(e);if(e.shiftKey){const e=f();let[t,o]=v(e);if(t.length>0){const e=u();const i=Math.min(n.tab.length,t.length);p({start:o,end:o+i});r.execCommand("delete");e.start-=i;e.end-=i;p(e)}}else{S(n.tab)}}}function x(t){A(t);const n=(t.originalEvent||t).clipboardData.getData("text/plain").replace(/\r/g,"");const r=u();S(n);a(e);p({start:r.start+n.length,end:r.start+n.length})}function w(e,t){const n=[];if(e.firstChild)n.push(e.firstChild);let r=n.pop();while(r){if(t(r)==="stop")break;if(r.nextSibling)n.push(r.nextSibling);if(r.firstChild)n.push(r.firstChild);r=n.pop()}}function S(e){e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");r.execCommand("insertHTML",false,e)}function R(e,t){let n=0;return(...r)=>{clearTimeout(n);n=window.setTimeout((()=>e(...r)),t)}}function v(e){let t=e.length-1;while(t>=0&&e[t]!=="\n")t--;t++;let n=t;while(n<e.length&&/[ \t]/.test(e[n]))n++;return[e.substring(t,n)||"",t,n]}function M(){return e.textContent||""}function A(e){e.preventDefault()}function T(){if(e.parentNode&&e.parentNode.nodeType==Node.DOCUMENT_FRAGMENT_NODE){return e.parentNode.getSelection()}return window.getSelection()}return{updateOptions(e){Object.assign(n,e)},updateCode(t){e.textContent=t;a(e)},onUpdate(e){i=e},toString:M,save:u,restore:p,destroy(){for(let[t,n]of o){e.removeEventListener(t,n)}}}};function selectedText(){const e=window.getSelection();if(e.rangeCount===0)return"";return e.getRangeAt(0).toString()}function textBeforeCursor(e){const t=window.getSelection();if(t.rangeCount===0)return"";const n=t.getRangeAt(0);const r=document.createRange();r.selectNodeContents(e);r.setEnd(n.startContainer,n.startOffset);return r.toString()}function textAfterCursor(e){const t=window.getSelection();if(t.rangeCount===0)return"";const n=t.getRangeAt(0);const r=document.createRange();r.selectNodeContents(e);r.setStart(n.endContainer,n.endOffset);return r.toString()}const commaRegEx=/"[^"]*"|[0-9]+,[0-9]+|[A-Za-z\u0391-\u03D5\uD835][A-Za-z0-9_\u0391-\u03D5\uD835\uDC00-\uDFFF]/g;const dotRegEx=/"[^"]*"|[0-9]+\.[0-9]+|[A-Za-z\u0391-\u03D5\uD835][A-Za-z0-9_\u0391-\u03D5\uD835\uDC00-\uDFFF]/g;const functionRegEx=/^(?:private +)?function (?:[A-Za-z\u0391-\u03C9\u03D5\u210B\u210F\u2110\u2112\u2113\u211B\u212C\u2130\u2131\u2133]|(?:\uD835[\uDC00-\udc33\udc9c-\udcb5]))[A-Za-z0-9_\u0391-\u03C9\u03D5\u0300-\u0308\u030A\u030C\u0332\u20d0\u20d1\u20d6\u20d7\u20e1]**\(/;const dotFromCommaForStorage=e=>{let t;while((t=commaRegEx.exec(e))!=null){if("0123456789".indexOf(t[0].charAt(0))>-1){const n=t.index+t[0].indexOf(",");e=e.slice(0,n)+"."+e.slice(n+1)}}return e};const commaFromDotForDisplay=e=>{let t;while((t=dotRegEx.exec(e))!==null){if("0123456789".indexOf(t[0].charAt(0))>-1){const n=t.index+t[0].indexOf(".");e=e.slice(0,n)+","+e.slice(n+1)}}return e};function openMathPrompt(e){const t=e.dom.appendChild(document.createElement("div"));t.className="math-code";t.parentNode.firstChild.style.display="none";const n=()=>{if(t.parentNode){t.parentNode.firstChild.removeAttribute("style");t.parentNode.removeChild(t)}};const r=e.encoding==="HurmetMath";const o=!r;const i=r?e.outerView.state.doc.attrs.decimalFormat.slice(-1):"";const s=t.appendChild(document.createElement("div"));const a=codeJar(s);if(e.attrs){if(r&&e.attrs.entry){let t=e.attrs.entry;if(i===","){t=commaFromDotForDisplay(t)}a.updateCode(t)}else if(e.attrs.tex){a.updateCode(e.attrs.tex)}}const l=a.toString().length;a.restore({start:l,end:l,dir:undefined});const c=e=>{if(document.getElementsByClassName("ProseMirror-prompt").length===0){n()}};s.addEventListener("blur",c);const d=t.appendChild(document.createElement("div"));d.setAttribute("class","math-display");const u=function(t){let n="";let o=false;if(r){const t=selectedText();if(t.length===0){autoCorrect(a,textBeforeCursor(s),textAfterCursor(s))}n=a.toString();if(i===","){n=dotFromCommaForStorage(n)}o=functionRegEx.test(n);if(!o){const t={decimalFormat:e.outerView.state.doc.attrs.decimalFormat,dateFormat:e.outerView.state.doc.attrs.dateFormat};n=hurmet.parse(n,t,false,true)}}else{n=t}if(!o){try{hurmet.render(n,d,{displayMode:e.attrs.displayMode,trust:e=>e.command==="\\class"&&e.class==="special-fraction",wrap:"=",errorColor:"#fff"})}catch(e){while(d.lastChild){d.removeChild(d.lastChild)}d.textContent=n}}};if(a.toString().length>0){u(a.toString())}s.addEventListener("input",(e=>{u(a.toString())}));const p=l=>{let c=a.toString();c=c.replace(/^[\s\u200b]+/,"");c=c.replace(/[\s\u200b]+$/,"");c=c.replace(/\r?\n/g,"\n");if(r&&i===","){c=dotFromCommaForStorage(c)}const d={decimalFormat:e.outerView.state.doc.attrs.decimalFormat,dateFormat:e.outerView.state.doc.attrs.dateFormat};const u=o?{tex:c}:hurmet.compile(c,d);u.displayMode=e.attrs.displayMode;if(t.parentNode){t.parentNode.firstChild.removeAttribute("style")}e.callback(u);s.removeEventListener("blur",n);if(t.parentNode){t.remove()}};s.addEventListener("submit",(e=>{e.preventDefault();p()}));s.addEventListener("keydown",(e=>{if(e.keyCode===27){e.preventDefault();n()}else if(e.keyCode===13&&!e.shiftKey){e.preventDefault();p()}}))}const isDisplayMode=(e,t)=>{const n=t.state.selection.$from;const r=n.node(n.depth);const o=e.parentNode.parentNode;return e.parentNode.nodeName==="P"&&r.childCount===1&&o.nodeName==="DIV"&&o.classList.contains("centered")};class CalcView{constructor(e,t){this.node=e;this.outerView=t;this.dom=schema.nodes.calculation.spec.toDOM(e)}selectNode(){if(this.dom.children.length>1){return}const e=isDisplayMode(this.dom,this.outerView);this.dom.classList.add("ProseMirror-selectednode");const t=this.node.attrs;t.displayMode=e;const n=this.outerView.state.selection.from;openMathPrompt({encoding:"HurmetMath",attrs:t,outerView:this.outerView,dom:this.dom,callback(e){hurmet.updateCalculations(this.outerView,false,e,n)}})}deselectNode(){this.dom.classList.remove("ProseMirror-selectednode")}stopEvent(){return true}}class TexView{constructor(e,t){this.node=e;this.outerView=t;this.dom=schema.nodes.tex.spec.toDOM(e)}selectNode(){const e=isDisplayMode(this.dom,this.outerView);this.dom.classList.add("ProseMirror-selectednode");const t=this.node.attrs;t.displayMode=e;openMathPrompt({encoding:"TeX",attrs:t,outerView:this.outerView,dom:this.dom,callback(e){const t=this.outerView;t.dispatch(t.state.tr.replaceSelectionWith(schema.nodes.tex.createAndFill(e)));t.focus()}})}deselectNode(){this.dom.classList.remove("ProseMirror-selectednode")}stopEvent(){return true}}class FootnoteView{constructor(e,t,n){this.node=e;this.outerView=t;this.getPos=n;this.dom=document.createElement("footnote");this.innerView=null}selectNode(){this.dom.classList.add("ProseMirror-selectednode");if(!this.innerView){this.open()}}deselectNode(){this.dom.classList.remove("ProseMirror-selectednode");if(this.innerView){this.close()}}open(){const e=this.dom.appendChild(document.createElement("div"));e.className="footnote-tooltip";this.innerView=new EditorView(e,{state:EditorState.create({doc:this.node,plugins:[keymap({"Mod-z":()=>undo(this.outerView.state,this.outerView.dispatch),"Mod-y":()=>redo(this.outerView.state,this.outerView.dispatch),"Mod-b":toggleMark(schema.marks.strong),"Mod-i":toggleMark(schema.marks.em),"Mod-`":toggleMark(schema.marks.code),"Mod-,":toggleMark(schema.marks.subscript),"Mod-.":toggleMark(schema.marks.superscript),"Mod-u":toggleMark(schema.marks.underline)})]}),dispatchTransaction:this.dispatchInner.bind(this),handleDOMEvents:{mousedown:()=>{if(this.outerView.hasFocus()){this.innerView.focus()}}}})}close(){this.innerView.destroy();this.innerView=null;this.dom.textContent=""}dispatchInner(e){const{state:t,transactions:n}=this.innerView.state.applyTransaction(e);this.innerView.updateState(t);if(!e.getMeta("fromOutside")){const e=this.outerView.state.tr;const t=StepMap.offset(this.getPos()+1);for(let r=0;r<n.length;r++){const o=n[r].steps;for(let n=0;n<o.length;n++){e.step(o[n].map(t))}}if(e.docChanged){this.outerView.dispatch(e)}}}update(e){if(!e.sameMarkup(this.node)){return false}this.node=e;if(this.innerView){const t=this.innerView.state;const n=e.content.findDiffStart(t.doc.content);if(n!=null){let{a:r,b:o}=e.content.findDiffEnd(t.doc.content);const i=n-Math.min(r,o);if(i>0){r+=i;o+=i}this.innerView.dispatch(t.tr.replace(n,o,e.slice(n,r)).setMeta("fromOutside",true))}}return true}destroy(){if(this.innerView){this.close()}}stopEvent(e){return this.innerView&&this.innerView.dom.contains(e.target)}ignoreMutation(){return true}}function pmSetup(e){return[buildInputRules(e.schema),keymap(buildKeymap(e.schema,e.mapKeys)),keymap(baseKeymap),gapCursor(),menuBar({floating:true,content:buildMenuItems(e.schema).fullMenu}),history(),columnResizing(),tableEditing(),new Plugin({props:{attributes:{class:"ProseMirror-setup pica",id:"editor-content"}}})]}window.view=new EditorView(document.querySelector("#editor"),{state:EditorState.create({doc:DOMParser.fromSchema(schema).parse(document.querySelector("#content")),plugins:pmSetup({schema:schema})}),nodeViews:{calculation(e,t){return new CalcView(e,t)},tex(e,t){return new TexView(e,t)},footnote(e,t,n){return new FootnoteView(e,t,n)}},clipboardTextSerializer:(e,t)=>{if(e.content&&e.content.content.length===1&&e.content.content[0].type.name==="paragraph"&&e.content.content[0].content&&e.content.content[0].content.content&&e.content.content[0].content.content.length===1&&e.content.content[0].content.content[0].type.name==="calculation"){const t=e.content.content[0].content.content[0].attrs;const n=t.value;if(n.plain&&hurmet.Rnl.isRational(n.plain)){return hurmet.Rnl.toNumber(n.plain)}else if(hurmet.Rnl.isRational(n)){return hurmet.Rnl.toNumber(n)}else if(t.dtype===dt.ROWVECTOR+dt.RATIONAL||t.dtype===dt.COLUMNVECTOR+dt.RATIONAL){const e=t.dtype&dt.ROWVECTOR?", ":"; ";return"["+n.map((e=>String(hurmet.Rnl.toNumber(e)))).join(e)+"]"}else if(t.dtype&dt.ROWVECTOR||t.dtype&dt.COLUMNVECTOR){const e=t.dtype&dt.ROWVECTOR?", ":"; ";return"["+n.map((e=>String(e))).join(e)+"]"}else if(t.dtype===dt.MATRIX+dt.RATIONAL){return"("+n.map((e=>e.map((e=>String(hurmet.Rnl.toNumber(e)))).join(", "))).join(";\n")+")"}else if(t.dtype&dt.MATRIX){return"("+n.map((e=>e.map((e=>String(e))).join(", "))).join(";\n")+")"}else if(t.dtype===dt.DATAFRAME){return DataFrame.displayAlt(n)}return n}else{return e.content.textBetween(0,e.content.size,"\n\n")}}});const userLanguageTag=navigator.language||navigator.userLanguage;const parts=userLanguageTag.match(/([A-Za-z]{1,2})(?:-(\w{1,3})(?:-(\w{2,3}))?)?/);const userLanguage=parts[1].toLowerCase();const userRegion=(parts[3]?parts[3]:parts[2]?parts[2]:"").toUpperCase();if(["BD","IN","LK","MV","MP","PK"].includes(userRegion)){window.view.state.doc.attrs.decimalFormat="1,00,000."}else if(userLanguage==="en"||userRegion.length>0&&["BN","BU","BW","DO","EG","ET","GH","GT","GY","HN","IE","IL","JO","JP","KE","KH","KP","KR","LB","LY","MM","MN","MT","MX","MY","NG","NI","PA","PH","PR","QA","PS","SG","SV","TH","TW","TZ","UG","ZW"].includes(userRegion)){window.view.state.doc.attrs.decimalFormat="1,000,000."}else if(userLanguage==="zh"){window.view.state.doc.attrs.decimalFormat="1,0000,0000."}else{window.view.state.doc.attrs.decimalFormat="1 000 000,"}const tidyUp=e=>{const t=fixTables(window.view.state);if(t){window.view.state=window.view.state.apply(t.setMeta("addToHistory",false))}hurmet.updateCalculations(window.view,true);document.execCommand("enableObjectResizing",false,false);document.execCommand("enableInlineTableEditing",false,false)};const hash=location.hash;if(hash&&hash.length>1){const e=decodeURIComponent(hash.slice(1));const t=hurmet.md2ast(e);const n={type:"fragment",content:t};window.view.dispatch(window.view.state.tr.replaceWith(0,window.view.state.doc.content.size,schema.nodeFromJSON(n)));hurmet.updateCalculations(window.view,true)}tidyUp();